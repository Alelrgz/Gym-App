{% extends "base.html" %}

{% block content %}

<!-- ===== MOBILE HEADER ===== -->
<header class="staff-mobile-header">
    <div class="staff-mobile-header-logo">
        <img src="/static/fitos-logo.svg" alt="FitOS" class="staff-logo-img">
        <span class="staff-role-label">{{ role | capitalize }}</span>
    </div>
    <div class="staff-mobile-header-actions">
        <button class="staff-mobile-msg-btn" onclick="openConversationsModal()">
            <i data-lucide="message-circle" class="w-5 h-5"></i>
        </button>
        <button class="staff-mobile-msg-btn" data-action="showModal" data-target="notification-modal">
            <i data-lucide="bell" class="w-5 h-5"></i>
        </button>
        <a href="/auth/logout" class="staff-mobile-msg-btn" style="color:#f87171;">
            <i data-lucide="log-out" class="w-5 h-5"></i>
        </a>
    </div>
</header>

<!-- Desktop Sidebar + Main Content Layout -->
<div class="trainer-layout">

    <!-- ===== LEFT SIDEBAR (desktop) ===== -->
    <aside class="staff-sidebar trainer-sidebar-new">
        <div class="staff-sidebar-logo">
            <img src="/static/fitos-logo.svg" alt="FitOS" class="staff-logo-img staff-logo-img--sidebar">
            <span class="staff-role-label">{{ role | capitalize }}</span>
        </div>

        <nav class="staff-sidebar-nav">
            <button onclick="switchSection('workouts')"
                    class="staff-nav-item sidebar-nav-item"
                    data-section="workouts">
                <i data-lucide="dumbbell" class="w-[18px] h-[18px]"></i>
                <span>Allenamenti</span>
            </button>
            <button onclick="switchSection('dashboard')"
                    class="staff-nav-item active sidebar-nav-item"
                    data-section="dashboard">
                <i data-lucide="users" class="w-[18px] h-[18px]"></i>
                <span>Utenti</span>
            </button>
            <button onclick="switchSection('courses')"
                    class="staff-nav-item sidebar-nav-item"
                    data-section="courses">
                <i data-lucide="book-open" class="w-[18px] h-[18px]"></i>
                <span>Corsi</span>
            </button>
            <button onclick="switchSection('settings')"
                    class="staff-nav-item sidebar-nav-item"
                    data-section="settings">
                <i data-lucide="settings" class="w-[18px] h-[18px]"></i>
                <span>Impostazioni</span>
            </button>
        </nav>

        <div style="flex:1"></div>

        <div style="display:flex;flex-direction:column;gap:0.25rem;">
            <a href="/auth/logout" class="staff-nav-item" style="color:#f87171;">
                <i data-lucide="log-out" class="w-[18px] h-[18px]"></i>
                <span>Esci</span>
            </a>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="staff-main trainer-main-new">

        <!-- ==================== SECTION: DASHBOARD (UTENTI) ==================== -->
        <section id="section-dashboard" class="trainer-section p-4 md:p-6 lg:p-8 max-w-[1400px] mx-auto">

            <!-- Hidden elements needed by other JS -->
            <span id="trainer-username" class="hidden">Loading...</span>
            <span id="unread-messages-badge" class="hidden">0</span>
            <select id="trainer-selector" class="hidden">
                <option value="trainer_default">Default Trainer</option>
            </select>

            <!-- Page Header -->
            <div class="staff-page-header">
                <h1>Utenti</h1>
                <p>Da qui puoi registrare, cercare o gestire i clienti e i loro dati</p>
            </div>

            <!-- Stats Bar -->
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem;">
                <div class="staff-stats-bar" style="margin-bottom:0;">
                    <div class="staff-stat-item">
                        <span class="staff-stat-value text-primary" id="total-clients-count">0</span>
                        <span class="staff-stat-label">Clienti</span>
                    </div>
                    <div class="staff-stat-item">
                        <span class="staff-stat-value" style="color:rgba(255,255,255,0.5);" id="inactive-clients-count">0</span>
                        <span class="staff-stat-label">Inattivi</span>
                    </div>
                    <div class="staff-stat-item">
                        <span class="staff-stat-value" style="color:#f87171;" id="at-risk-clients-count">0</span>
                        <span class="staff-stat-label">A rischio</span>
                    </div>
                </div>

                <!-- Desktop only: message & notification icons -->
                <div class="hidden lg:flex gap-3">
                    <div onclick="openConversationsModal()" class="relative w-11 h-11 rounded-xl glass-card-interactive flex items-center justify-center">
                        <i data-lucide="message-circle" class="w-5 h-5"></i>
                    </div>
                    <div data-action="showModal" data-target="notification-modal" class="w-11 h-11 rounded-xl glass-card-interactive flex items-center justify-center">
                        <i data-lucide="bell" class="w-5 h-5"></i>
                    </div>
                </div>
            </div>

            <!-- Dual Search Row -->
            <div class="trainer-dual-search">
                <div class="staff-search-bar" style="margin-bottom:0;">
                    <i data-lucide="search" class="w-4 h-4 search-icon"></i>
                    <input type="text" id="trainer-client-search" placeholder="Cerca clienti">
                </div>
                <div class="staff-search-bar" style="margin-bottom:0;">
                    <i data-lucide="search" class="w-4 h-4 search-icon"></i>
                    <input type="text" id="trainer-appointment-search" placeholder="Appuntamenti">
                </div>
            </div>

            <!-- Two Column Layout -->
            <div class="trainer-utenti-grid">
                <!-- LEFT: Client Table -->
                <div class="staff-table-card">
                    <table class="staff-table">
                        <thead>
                            <tr>
                                <th style="width:40px;"><input type="checkbox" style="opacity:0.3;"></th>
                                <th>Clienti</th>
                                <th>Scheda</th>
                                <th>Scadenza</th>
                            </tr>
                        </thead>
                        <tbody id="trainer-clients-table-body">
                            <tr class="staff-skeleton-row"><td></td><td><div class="staff-skeleton" style="width:160px;"></div></td><td><div class="staff-skeleton" style="width:100px;"></div></td><td><div class="staff-skeleton" style="width:80px;"></div></td></tr>
                            <tr class="staff-skeleton-row"><td></td><td><div class="staff-skeleton" style="width:130px;"></div></td><td><div class="staff-skeleton" style="width:110px;"></div></td><td><div class="staff-skeleton" style="width:90px;"></div></td></tr>
                            <tr class="staff-skeleton-row"><td></td><td><div class="staff-skeleton" style="width:150px;"></div></td><td><div class="staff-skeleton" style="width:90px;"></div></td><td><div class="staff-skeleton" style="width:70px;"></div></td></tr>
                            <tr class="staff-skeleton-row"><td></td><td><div class="staff-skeleton" style="width:140px;"></div></td><td><div class="staff-skeleton" style="width:100px;"></div></td><td><div class="staff-skeleton" style="width:85px;"></div></td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- RIGHT: Appointments + My Workout -->
                <div style="display:flex;flex-direction:column;gap:1.5rem;">
                    <!-- Appointments Widget -->
                    <div class="glass-card p-4 rounded-2xl">
                        <div style="display:flex;justify-content:center;align-items:center;gap:0.75rem;margin-bottom:1rem;">
                            <button onclick="changeWeek(-1)" class="w-7 h-7 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-white/50 text-sm">&lt;</button>
                            <span class="text-sm font-semibold text-white" id="d-week-range-label">...</span>
                            <button onclick="changeWeek(1)" class="w-7 h-7 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-white/50 text-sm">&gt;</button>
                        </div>
                        <!-- Day tabs -->
                        <div class="grid grid-cols-7 gap-1 mb-4" id="d-calendar-strip"></div>
                        <!-- Events for selected day -->
                        <div id="d-schedule-container" class="space-y-2 mb-3"></div>
                    </div>

                    <!-- My Workout Card -->
                    <div id="trainer-my-workout" style="flex:1;display:flex;flex-direction:column;">
                        <div class="glass-card rounded-2xl" style="flex:1;display:flex;flex-direction:column;position:relative;overflow:hidden;">
                            <!-- Content (always visible, blurred when empty) -->
                            <div id="my-workout-content" style="flex:1;display:flex;flex-direction:column;justify-content:center;padding:1.25rem;">
                                <p class="text-xs text-white/40 uppercase tracking-wider font-semibold mb-3">Il mio allenamento</p>
                                <div class="flex justify-between items-end">
                                    <div>
                                        <h3 class="text-xl font-black text-white mb-1" id="my-workout-title">Allenamento</h3>
                                    </div>
                                    <div class="text-right text-xs text-white/50 space-y-0.5">
                                        <p id="my-workout-duration">-- min</p>
                                        <p id="my-workout-exercises">-- esercizi</p>
                                        <p id="my-workout-difficulty">--</p>
                                    </div>
                                </div>
                                <button id="my-workout-cta" class="w-full mt-4 py-3 bg-primary hover:bg-primary-hover text-white font-bold rounded-xl transition text-sm">
                                    Avvia Allenamento
                                </button>
                            </div>
                            <!-- Empty overlay (blur + text) -->
                            <div id="my-workout-empty" style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0.4rem;background:rgba(20,20,20,0.5);border-radius:inherit;z-index:1;">
                                <p style="font-size:0.9rem;font-weight:600;color:rgba(255,255,255,0.5);">Nessun workout assegnato</p>
                                <p style="font-size:0.8rem;color:rgba(255,255,255,0.3);">
                                    <a onclick="switchSection('workouts')" style="cursor:pointer;color:rgba(255,255,255,0.3);">aggiungi un <span style="color:var(--primary);font-weight:600;">workout</span></a>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </section>

        <!-- ==================== SECTION: ALLENAMENTI (WORKOUTS) ==================== -->
        <section id="section-workouts" class="trainer-section hidden p-4 md:p-6 lg:p-8 max-w-[1400px] mx-auto">

            <!-- Page Header -->
            <div class="staff-page-header">
                <h1>Allenamenti</h1>
                <p>Da qui puoi creare e assegnare allenamenti ai tuoi clienti</p>
            </div>

            <!-- Stats + Actions row -->
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem;">
                <div class="staff-stats-bar" style="margin-bottom:0;">
                    <div class="staff-stat-item">
                        <span class="staff-stat-value text-primary" id="workouts-total-count">0</span>
                        <span class="staff-stat-label">Allenamenti</span>
                    </div>
                    <div class="staff-stat-item">
                        <span class="staff-stat-value" style="color:rgba(255,255,255,0.5);" id="workouts-expiring-count">0</span>
                        <span class="staff-stat-label">In scadenza</span>
                    </div>
                    <div class="staff-stat-item">
                        <span class="staff-stat-value" style="color:#f87171;" id="workouts-expired-count">0</span>
                        <span class="staff-stat-label">Scaduti</span>
                    </div>
                </div>
                <button onclick="openCreateWorkoutModal()" class="staff-btn-action staff-btn-primary" style="border-radius:9999px;padding:0.6rem 1.5rem;">
                    + Crea allenamento
                </button>
            </div>

            <!-- Dual Search Row -->
            <div class="trainer-workouts-dual-search">
                <div class="staff-search-bar" style="margin-bottom:0;">
                    <i data-lucide="search" class="w-4 h-4 search-icon"></i>
                    <input type="text" id="workouts-search" placeholder="Cerca allenamento">
                </div>
                <div class="staff-search-bar" style="margin-bottom:0;">
                    <i data-lucide="search" class="w-4 h-4 search-icon"></i>
                    <input type="text" id="workouts-client-search" placeholder="Cerca clienti">
                </div>
            </div>

            <!-- Two Column Grid -->
            <div class="trainer-workouts-grid">
                <!-- LEFT: Tabs + List -->
                <div>
                    <!-- Tab Bar -->
                    <div class="trainer-tab-bar">
                        <button class="trainer-tab active" data-tab="workouts-tab" onclick="switchWorkoutTab('workouts-tab')">Workout</button>
                        <button class="trainer-tab" data-tab="splits-tab" onclick="switchWorkoutTab('splits-tab')">Split</button>
                    </div>

                    <!-- Workout List (table with checkbox + name) -->
                    <div id="workouts-tab" class="trainer-tab-content">
                        <div class="staff-table-card">
                            <table class="staff-table">
                                <thead>
                                    <tr>
                                        <th style="width:40px;"><input type="checkbox" style="opacity:0.3;"></th>
                                        <th>Allenamento</th>
                                    </tr>
                                </thead>
                                <tbody id="workouts-drag-list">
                                    <tr class="staff-skeleton-row"><td></td><td><div class="staff-skeleton" style="width:180px;"></div></td></tr>
                                    <tr class="staff-skeleton-row"><td></td><td><div class="staff-skeleton" style="width:150px;"></div></td></tr>
                                    <tr class="staff-skeleton-row"><td></td><td><div class="staff-skeleton" style="width:170px;"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Split List (table with checkbox + name) -->
                    <div id="splits-tab" class="trainer-tab-content hidden">
                        <div class="staff-table-card">
                            <table class="staff-table">
                                <thead>
                                    <tr>
                                        <th style="width:40px;"><input type="checkbox" style="opacity:0.3;"></th>
                                        <th>Split</th>
                                    </tr>
                                </thead>
                                <tbody id="splits-drag-list">
                                    <tr class="staff-skeleton-row"><td></td><td><div class="staff-skeleton" style="width:180px;"></div></td></tr>
                                    <tr class="staff-skeleton-row"><td></td><td><div class="staff-skeleton" style="width:150px;"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- RIGHT: Client Drop Targets -->
                <div>
                    <div id="workouts-client-list" class="space-y-2"></div>
                </div>
            </div>
        </section>

        <!-- ===== ASSIGNMENT MODAL (triggered by drag-and-drop) ===== -->
        <div id="assign-modal-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;align-items:center;justify-content:center;">
            <div style="background:var(--bg-elevated);border:1px solid var(--glass-border-2);border-radius:var(--radius-xl);padding:2rem;width:100%;max-width:420px;box-shadow:var(--shadow-xl);">
                <h3 style="font-size:1.1rem;font-weight:700;color:white;margin-bottom:0.25rem;" id="assign-modal-title">Assegna allenamento</h3>
                <p style="font-size:0.8rem;color:rgba(255,255,255,0.4);margin-bottom:1.5rem;" id="assign-modal-subtitle"></p>

                <label style="font-size:0.75rem;font-weight:600;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:0.05em;display:block;margin-bottom:0.5rem;">
                    <span id="assign-modal-date-label">Data di inizio</span>
                </label>
                <input type="date" id="assign-modal-date" style="width:100%;padding:0.65rem 1rem;background:var(--glass-bg-1);border:1px solid var(--glass-border-1);border-radius:var(--radius-md);color:white;font-size:0.85rem;outline:none;margin-bottom:1.5rem;">

                <div style="display:flex;gap:0.75rem;">
                    <button onclick="closeAssignModal()" style="flex:1;padding:0.65rem;background:var(--glass-bg-2);border:1px solid var(--glass-border-2);border-radius:var(--radius-md);color:rgba(255,255,255,0.7);font-size:0.85rem;font-weight:600;cursor:pointer;">Annulla</button>
                    <button onclick="confirmAssignment()" style="flex:1;padding:0.65rem;background:var(--primary);border:none;border-radius:var(--radius-md);color:white;font-size:0.85rem;font-weight:600;cursor:pointer;">Assegna</button>
                </div>
            </div>
        </div>

        <!-- ==================== SECTION: SCHEDULE ==================== -->
        <section id="section-schedule" class="trainer-section hidden p-4 md:p-6 lg:p-8 max-w-[1400px] mx-auto">
            <!-- Header -->
            <div class="flex justify-between items-start mb-8">
                <div>
                    <p class="label-uppercase mb-1">Il Mio Profilo</p>
                    <h2 class="heading-page" id="personal-name">Caricamento...</h2>
                </div>
            </div>

            <!-- ZONE: Training (Green) -->
            <section class="mb-8">
                <div class="flex items-center gap-2 mb-4 border-l-4 border-green-400 pl-3">
                    <div class="w-8 h-8 rounded-lg bg-green-500/20 flex items-center justify-center">
                        <i data-lucide="flame" class="w-4 h-4 text-green-400"></i>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-green-400 uppercase tracking-wider">Allenamento</h3>
                        <p class="text-xs text-gray-500">Streak, piani e allenamenti</p>
                    </div>
                </div>

                <!-- Quick Actions Row -->
                <div class="grid grid-cols-2 gap-4 mb-5">
                    <div class="stat-card stat-card-success">
                        <p class="stat-value" id="personal-streak">0</p>
                        <p class="stat-label">Streak <i data-lucide="flame" class="w-4 h-4 inline-block align-middle"></i></p>
                    </div>
                    <button onclick="openAvailabilityModal()"
                        class="stat-card stat-card-success flex flex-col items-center justify-center group cursor-pointer hover:brightness-110 transition">
                        <p class="stat-value group-hover:scale-110 transition-transform"><i data-lucide="clock" class="w-7 h-7 stroke-current"></i></p>
                        <p class="stat-label">1-on-1</p>
                    </button>
                </div>

                <!-- My Workout Section (Hidden by default) -->
                <div id="my-workout-section" class="hidden transition-all duration-300 ease-in-out mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">I Miei Allenamenti</h3>
                        <button onclick="document.getElementById('my-workout-section').classList.add('hidden')"
                            class="text-white/40 hover:text-white text-sm">✕</button>
                    </div>
                    <div id="my-workout-card-container">
                        <div class="glass-card p-4 text-center">
                            <p class="text-gray-400 text-sm mb-2">Caricamento...</p>
                        </div>
                    </div>
                </div>

                <!-- My Splits Section (Hidden by default) -->
                <div id="my-split-section" class="hidden transition-all duration-300 ease-in-out mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">I Miei Split</h3>
                        <button onclick="document.getElementById('my-split-section').classList.add('hidden')"
                            class="text-white/40 hover:text-white text-sm">✕</button>
                    </div>
                    <div id="my-split-card-container">
                        <div class="glass-card p-4 text-center">
                            <p class="text-gray-400 text-sm mb-2">Caricamento...</p>
                        </div>
                    </div>
                </div>

                <!-- Today's Plan -->
                <div id="todays-plan-container">
                    <div class="glass-card p-5 relative overflow-hidden" id="default-plan-placeholder">
                        <div class="flex justify-between items-start mb-4">
                            <span class="bg-white/10 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider">Piano di Oggi</span>
                            <i data-lucide="clipboard" class="w-5 h-5"></i>
                        </div>
                        <h3 class="text-xl font-bold text-white/50 mb-2">Nessun Allenamento Assegnato</h3>
                        <p class="text-sm text-gray-400 mb-4">Seleziona un allenamento da "I Miei Allenamenti" e clicca "Assegna a Me" per impostare l'allenamento di oggi.</p>
                    </div>
                </div>
            </section>

            <!-- ZONE: Schedule (Blue) -->
            <section class="mb-8">
                <div class="flex items-center gap-2 mb-4 border-l-4 border-blue-400 pl-3">
                    <div class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center">
                        <i data-lucide="calendar" class="w-4 h-4 text-blue-400"></i>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-blue-400 uppercase tracking-wider">Agenda</h3>
                        <p class="text-xs text-gray-500">Calendario e appuntamenti</p>
                    </div>
                </div>
                <div class="glass-card p-4 rounded-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <span></span>
                        <div class="flex items-center space-x-2">
                            <button onclick="changeWeek(-1)"
                                class="w-6 h-6 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-white/70">←</button>
                            <span class="text-xs text-white/40 min-w-[3rem] text-center" id="month-label">...</span>
                            <button onclick="changeWeek(1)"
                                class="w-6 h-6 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-white/70">→</button>
                        </div>
                    </div>
                    <div class="text-xs text-center font-mono mb-2 text-white/50 uppercase tracking-widest" id="current-full-date"></div>
                    <div class="grid grid-cols-7 gap-1 mb-4 text-xs text-center font-mono" id="calendar-strip"></div>
                    <div class="space-y-3" id="schedule-container"></div>
                </div>
            </section>

            <!-- ZONE: Personal Notes (Slate) -->
            <section>
                <div class="flex items-center gap-2 mb-4 border-l-4 border-slate-500 pl-3">
                    <div class="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center">
                        <i data-lucide="file-text" class="w-4 h-4 text-slate-400"></i>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider">Note Personali</h3>
                        <p class="text-xs text-gray-500">Diario e appunti di allenamento</p>
                    </div>
                    <span class="text-[10px] text-green-400 opacity-0 transition-opacity duration-500 ml-auto" id="personal-notes-saved-indicator">Salvato</span>
                </div>
                <div class="glass-card p-4 rounded-2xl">
                    <textarea id="personal-notes"
                        class="w-full bg-black/20 text-white text-sm rounded-xl p-3 border border-white/5 focus:border-white/20 outline-none resize-none h-32 placeholder-white/20 transition"
                        placeholder="Annota i tuoi progressi, idee o registri di allenamento..."></textarea>
                </div>
            </section>
        </section>

        <!-- ==================== SECTION: COURSES ==================== -->
        <section id="section-courses" class="trainer-section hidden p-4 md:p-6 lg:p-8 max-w-[1400px] mx-auto">

            <!-- Page Header -->
            <div class="staff-page-header">
                <h1>Corsi</h1>
                <p>Da qui puoi registrare, cercare o gestire i clienti e i loro dati</p>
            </div>

            <!-- Stats + Actions row -->
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem;">
                <div class="staff-stats-bar" style="margin-bottom:0;">
                    <div class="staff-stat-item">
                        <span class="staff-stat-value text-primary" id="total-courses-count">0</span>
                        <span class="staff-stat-label">Corsi</span>
                    </div>
                    <div class="staff-stat-item">
                        <span class="staff-stat-value" style="color:rgba(255,255,255,0.5);" id="lessons-this-week">0</span>
                        <span class="staff-stat-label">Questa settimana</span>
                    </div>
                </div>
                <button data-action="openCreateCourse" class="staff-btn-action staff-btn-primary" style="border-radius:9999px;padding:0.6rem 1.5rem;">
                    Crea corso
                </button>
            </div>

            <!-- Hidden elements for backward compatibility -->
            <span id="avg-engagement" class="hidden">-</span>

            <!-- Three Column Grid -->
            <div class="trainer-courses-grid">

                <!-- LEFT: Courses (Tabs: I miei corsi / Corsi condivisi) -->
                <div>
                    <div class="trainer-tab-bar">
                        <button class="trainer-tab active" data-tab="own-courses-tab" onclick="switchCourseTab('own-courses-tab')">I miei corsi</button>
                        <button class="trainer-tab" data-tab="shared-courses-tab" onclick="switchCourseTab('shared-courses-tab')">Corsi condivisi</button>
                    </div>

                    <div id="own-courses-tab" class="trainer-tab-content">
                        <div id="courses-page-list" class="space-y-3" style="max-height:calc(100vh - 340px);overflow-y:auto;">
                            <div class="staff-skeleton" style="width:100%;height:60px;border-radius:var(--radius-md);margin-bottom:0.5rem;"></div>
                            <div class="staff-skeleton" style="width:100%;height:60px;border-radius:var(--radius-md);margin-bottom:0.5rem;"></div>
                            <div class="staff-skeleton" style="width:100%;height:60px;border-radius:var(--radius-md);"></div>
                        </div>
                    </div>

                    <div id="shared-courses-tab" class="trainer-tab-content hidden">
                        <div id="shared-courses-list" class="space-y-3" style="max-height:calc(100vh - 340px);overflow-y:auto;">
                            <div style="text-align:center;padding:2rem;color:rgba(255,255,255,0.3);font-size:0.85rem;">Nessun corso condiviso</div>
                        </div>
                    </div>
                </div>

                <!-- MIDDLE: Partecipanti -->
                <div>
                    <div style="padding:0.65rem 1rem;font-size:0.75rem;font-weight:600;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--glass-border-1);margin-bottom:1rem;">
                        Partecipanti
                    </div>
                    <div id="courses-participants-list" style="max-height:calc(100vh - 340px);overflow-y:auto;">
                        <div style="text-align:center;padding:3rem 1rem;color:rgba(255,255,255,0.25);font-size:0.8rem;">
                            <p style="margin-bottom:0.25rem;">Seleziona un corso</p>
                            <p style="font-size:0.75rem;">per vedere i partecipanti</p>
                        </div>
                    </div>
                </div>

                <!-- RIGHT: Exercise Library -->
                <div>
                    <div style="display:flex;align-items:center;justify-content:space-between;padding:0.65rem 1rem;border-bottom:1px solid var(--glass-border-1);margin-bottom:1rem;">
                        <span style="font-size:0.75rem;font-weight:600;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.05em;">Libreria Esercizi</span>
                        <button onclick="openCourseExerciseModal()" style="font-size:0.7rem;font-weight:600;color:var(--primary);background:none;border:none;cursor:pointer;">+ Nuovo</button>
                    </div>

                    <!-- Category filters -->
                    <div class="flex flex-wrap gap-1.5 mb-3" style="padding:0 0.25rem;">
                        <button onclick="filterCourseExercises('all')" data-filter="all"
                            class="course-ex-filter-btn active px-2.5 py-1 text-[10px] rounded-full bg-primary/20 text-primary border border-primary/30 transition">Tutti</button>
                        <button onclick="filterCourseExercises('yoga')" data-filter="yoga"
                            class="course-ex-filter-btn px-2.5 py-1 text-[10px] rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition">Yoga</button>
                        <button onclick="filterCourseExercises('pilates')" data-filter="pilates"
                            class="course-ex-filter-btn px-2.5 py-1 text-[10px] rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition">Pilates</button>
                        <button onclick="filterCourseExercises('stretch')" data-filter="stretch"
                            class="course-ex-filter-btn px-2.5 py-1 text-[10px] rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition">Stretch</button>
                        <button onclick="filterCourseExercises('cardio')" data-filter="cardio"
                            class="course-ex-filter-btn px-2.5 py-1 text-[10px] rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition">Cardio</button>
                    </div>

                    <!-- Search -->
                    <div style="position:relative;margin-bottom:0.75rem;padding:0 0.25rem;">
                        <span style="position:absolute;left:0.75rem;top:50%;transform:translateY(-50%);color:rgba(255,255,255,0.3);pointer-events:none;"><i data-lucide="search" class="w-3.5 h-3.5"></i></span>
                        <input type="text" id="course-exercise-search" placeholder="Cerca esercizi..."
                            style="width:100%;background:var(--glass-bg-1);border:1px solid var(--glass-border-1);border-radius:var(--radius-md);padding:0.5rem 0.75rem 0.5rem 2rem;font-size:0.8rem;color:white;outline:none;">
                    </div>

                    <!-- Exercise grid -->
                    <div id="course-exercise-library" class="space-y-2" style="max-height:calc(100vh - 440px);overflow-y:auto;">
                        <div style="text-align:center;padding:2rem;color:rgba(255,255,255,0.3);font-size:0.8rem;">Caricamento...</div>
                    </div>
                </div>
            </div>

            <!-- Hidden elements needed by toggle JS (no longer visible but keeps compatibility) -->
            <button id="toggle-course-exercises-btn" class="hidden"></button>
            <span id="course-exercises-chevron" class="hidden"></span>
            <div id="course-exercises-section" class="hidden" style="max-height:2000px;opacity:1;"></div>
        </section>

        <!-- ==================== SECTION: SETTINGS ==================== -->
        <section id="section-settings" class="trainer-section hidden p-4 md:p-6 lg:p-8 max-w-[1000px] mx-auto">
            <div class="mb-8">
                <p class="label-uppercase mb-1">Account</p>
                <h2 class="heading-page">Impostazioni</h2>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Profile Card -->
                <div class="lg:col-span-1">
                    <div class="glass-card-primary p-8 text-center">
                        <div id="settings-profile-pic" class="w-28 h-28 rounded-full bg-gradient-to-br from-primary to-orange-600 flex items-center justify-center mx-auto mb-5 text-4xl font-bold text-white shadow-lg">
                            T
                        </div>
                        <h3 class="text-xl font-bold text-white mb-1" id="settings-trainer-name">Trainer</h3>
                        <p class="text-sm text-muted">Trainer Personale</p>
                        <button onclick="document.getElementById('profile-picture-input').click()"
                            class="mt-5 btn-glass">
                            Cambia Foto
                        </button>
                        <input type="file" id="profile-picture-input" accept="image/*" class="hidden" onchange="uploadProfilePicture(this)">
                    </div>
                </div>

                <!-- Settings Options -->
                <div class="lg:col-span-2 space-y-4">
                    <!-- Bio -->
                    <div class="glass-card p-5">
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Bio</h3>
                        <textarea id="settings-bio" placeholder="Racconta ai clienti di te, la tua esperienza e il tuo stile di allenamento..."
                            class="w-full bg-black/20 text-white text-sm rounded-xl p-3 border border-white/10 focus:border-primary/50 outline-none resize-none h-24 transition"></textarea>
                        <button onclick="saveBio()" class="mt-2 text-xs bg-primary/20 hover:bg-primary/30 text-primary px-4 py-2 rounded-lg transition">Salva Bio</button>
                    </div>

                    <!-- Specialties -->
                    <div class="glass-card p-5">
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Specializzazioni</h3>
                        <div id="specialties-container" class="flex flex-wrap gap-2">
                            <label class="specialty-tag cursor-pointer">
                                <input type="checkbox" value="Weight Loss" class="hidden specialty-checkbox">
                                <span class="px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition inline-block">Dimagrimento</span>
                            </label>
                            <label class="specialty-tag cursor-pointer">
                                <input type="checkbox" value="Muscle Building" class="hidden specialty-checkbox">
                                <span class="px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition inline-block">Massa Muscolare</span>
                            </label>
                            <label class="specialty-tag cursor-pointer">
                                <input type="checkbox" value="Strength Training" class="hidden specialty-checkbox">
                                <span class="px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition inline-block">Allenamento Forza</span>
                            </label>
                            <label class="specialty-tag cursor-pointer">
                                <input type="checkbox" value="HIIT" class="hidden specialty-checkbox">
                                <span class="px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition inline-block">HIIT</span>
                            </label>
                            <label class="specialty-tag cursor-pointer">
                                <input type="checkbox" value="Yoga" class="hidden specialty-checkbox">
                                <span class="px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition inline-block">Yoga</span>
                            </label>
                            <label class="specialty-tag cursor-pointer">
                                <input type="checkbox" value="Nutrition" class="hidden specialty-checkbox">
                                <span class="px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition inline-block">Nutrizione</span>
                            </label>
                        </div>
                        <button onclick="saveSpecialties()" class="mt-3 text-xs bg-primary/20 hover:bg-primary/30 text-primary px-4 py-2 rounded-lg transition">Salva Specializzazioni</button>
                    </div>

                    <!-- Availability -->
                    <div class="glass-card p-5">
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Disponibilit&agrave; 1-on-1</h3>
                        <p class="text-xs text-gray-400 mb-3">Imposta i tuoi orari settimanali per le prenotazioni</p>
                        <button onclick="openAvailabilityModal()" class="text-xs bg-orange-500/20 hover:bg-orange-500/30 text-orange-400 px-4 py-2 rounded-lg transition">
                            Configura Disponibilit&agrave;
                        </button>
                    </div>

                    <!-- Account Actions -->
                    <div class="glass-card p-5">
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Account</h3>
                        <a href="/auth/logout" class="inline-flex items-center gap-2 text-xs bg-red-500/20 hover:bg-red-500/30 text-red-400 px-4 py-2 rounded-lg transition">
                            <i data-lucide="log-out" class="w-5 h-5 inline-block align-middle"></i> Esci
                        </a>
                    </div>
                </div>
            </div>
        </section>

    </main>
</div>

<!-- Bottom nav is in base.html for trainer role -->

<!-- Add Event Modal -->
<div id="add-event-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50 backdrop-blur-sm">
    <div class="glass-card w-full max-w-sm mx-4 p-6 rounded-2xl relative">
        <button onclick="document.getElementById('add-event-modal').classList.add('hidden')"
            class="absolute top-4 right-4 text-white/50 hover:text-white">✕</button>
        <h3 class="text-xl font-bold mb-4 text-center">Aggiungi Evento</h3>
        <form id="add-event-form" class="space-y-4">
            <div>
                <label class="text-xs text-gray-400 uppercase">Titolo</label>
                <input type="text" name="title" required
                    class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none"
                    placeholder="es. Consulenza Cliente">
            </div>
            <div>
                <label class="text-xs text-gray-400 uppercase">Sottotitolo / Dettagli</label>
                <input type="text" name="subtitle"
                    class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none"
                    placeholder="es. Mario Rossi - Gambe">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-xs text-gray-400 uppercase">Orario</label>
                    <input type="time" name="time" required
                        class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none">
                </div>
                <div>
                    <label class="text-xs text-gray-400 uppercase">Tipo</label>
                    <select name="type"
                        class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none">
                        <option value="personal">Personale</option>
                        <option value="consultation">Consulenza</option>
                        <option value="class">Corso</option>
                    </select>
                </div>
            </div>
            <div id="workout-selector-container" class="hidden">
                <label class="text-xs text-gray-400 uppercase">Seleziona Allenamento</label>
                <select name="workout_id" id="event-workout-select"
                    class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none">
                    <option value="">Nessuno</option>
                </select>
            </div>
            <div>
                <label class="text-xs text-gray-400 uppercase">Durata (minuti)</label>
                <input type="number" name="duration" value="60" min="15" step="15"
                    class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none">
            </div>
            <input type="hidden" name="date" id="event-date-input">
            <button type="submit"
                class="w-full py-3 bg-primary text-white font-bold rounded-xl hover:bg-primary/80 transition">
                Aggiungi all'Agenda
            </button>
        </form>
    </div>
</div>

<!-- Availability Settings Modal -->
<div id="availability-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50 backdrop-blur-sm">
    <div class="glass-card w-full max-w-md mx-4 p-6 rounded-2xl relative max-h-[90vh] overflow-y-auto">
        <button onclick="closeAvailabilityModal()" class="absolute top-4 right-4 text-white/50 hover:text-white">✕</button>
        <h3 class="text-xl font-bold mb-2 text-center">Disponibilit&agrave; 1-on-1</h3>
        <p class="text-xs text-gray-400 text-center mb-4">Imposta i tuoi orari settimanali per le prenotazioni</p>

        <div id="availability-days" class="space-y-3">
            <!-- Days will be generated by JS or hardcoded -->
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-day="0" class="day-toggle w-5 h-5 rounded accent-orange-500">
                    <span class="font-bold text-sm">Luned&igrave;</span>
                </label>
                <div class="day-times hidden grid grid-cols-2 gap-2 mt-2" data-day="0">
                    <div><label class="text-[10px] text-gray-400">Inizio</label><input type="time" class="start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="09:00"></div>
                    <div><label class="text-[10px] text-gray-400">Fine</label><input type="time" class="end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="17:00"></div>
                </div>
            </div>
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-day="1" class="day-toggle w-5 h-5 rounded accent-orange-500">
                    <span class="font-bold text-sm">Marted&igrave;</span>
                </label>
                <div class="day-times hidden grid grid-cols-2 gap-2 mt-2" data-day="1">
                    <div><label class="text-[10px] text-gray-400">Inizio</label><input type="time" class="start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="09:00"></div>
                    <div><label class="text-[10px] text-gray-400">Fine</label><input type="time" class="end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="17:00"></div>
                </div>
            </div>
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-day="2" class="day-toggle w-5 h-5 rounded accent-orange-500">
                    <span class="font-bold text-sm">Mercoled&igrave;</span>
                </label>
                <div class="day-times hidden grid grid-cols-2 gap-2 mt-2" data-day="2">
                    <div><label class="text-[10px] text-gray-400">Inizio</label><input type="time" class="start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="09:00"></div>
                    <div><label class="text-[10px] text-gray-400">Fine</label><input type="time" class="end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="17:00"></div>
                </div>
            </div>
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-day="3" class="day-toggle w-5 h-5 rounded accent-orange-500">
                    <span class="font-bold text-sm">Gioved&igrave;</span>
                </label>
                <div class="day-times hidden grid grid-cols-2 gap-2 mt-2" data-day="3">
                    <div><label class="text-[10px] text-gray-400">Inizio</label><input type="time" class="start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="09:00"></div>
                    <div><label class="text-[10px] text-gray-400">Fine</label><input type="time" class="end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="17:00"></div>
                </div>
            </div>
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-day="4" class="day-toggle w-5 h-5 rounded accent-orange-500">
                    <span class="font-bold text-sm">Venerd&igrave;</span>
                </label>
                <div class="day-times hidden grid grid-cols-2 gap-2 mt-2" data-day="4">
                    <div><label class="text-[10px] text-gray-400">Inizio</label><input type="time" class="start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="09:00"></div>
                    <div><label class="text-[10px] text-gray-400">Fine</label><input type="time" class="end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="17:00"></div>
                </div>
            </div>
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-day="5" class="day-toggle w-5 h-5 rounded accent-orange-500">
                    <span class="font-bold text-sm">Sabato</span>
                </label>
                <div class="day-times hidden grid grid-cols-2 gap-2 mt-2" data-day="5">
                    <div><label class="text-[10px] text-gray-400">Inizio</label><input type="time" class="start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="10:00"></div>
                    <div><label class="text-[10px] text-gray-400">Fine</label><input type="time" class="end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="14:00"></div>
                </div>
            </div>
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-day="6" class="day-toggle w-5 h-5 rounded accent-orange-500">
                    <span class="font-bold text-sm">Domenica</span>
                </label>
                <div class="day-times hidden grid grid-cols-2 gap-2 mt-2" data-day="6">
                    <div><label class="text-[10px] text-gray-400">Inizio</label><input type="time" class="start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="10:00"></div>
                    <div><label class="text-[10px] text-gray-400">Fine</label><input type="time" class="end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="14:00"></div>
                </div>
            </div>
        </div>

        <!-- Session Rate -->
        <div class="mt-4 bg-white/5 rounded-xl p-3">
            <label class="text-sm font-bold text-white mb-2 block">Tariffa Oraria Sessione (&euro;)</label>
            <p class="text-[10px] text-gray-400 mb-2">I clienti vedranno questo prezzo durante la prenotazione. Lascia vuoto per sessioni gratuite.</p>
            <input type="number" id="trainer-session-rate" min="0" step="0.01" placeholder="es. 50.00"
                class="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm">
        </div>

        <button onclick="saveAvailability()"
            class="w-full mt-4 py-3 bg-orange-500 text-white font-bold rounded-xl hover:bg-orange-600 transition">
            Salva Disponibilit&agrave;
        </button>
    </div>
</div>

<script>
// ============ NOTIFICATION FUNCTIONS ============
async function openNotificationsModal() {
    window.showModal('notification-modal');
    await loadNotifications();
}

async function loadNotifications() {
    const list = document.getElementById('notifications-list');
    if (!list) return;
    try {
        const res = await fetch('/api/notifications?limit=20');
        const notifications = await res.json();
        if (notifications.length === 0) {
            list.innerHTML = '<div class="text-center text-gray-400 py-8"><i data-lucide="bell" class="w-10 h-10 mb-2 block"></i><p class="text-sm">Nessuna notifica</p></div>';
            return;
        }
        list.innerHTML = notifications.map(n => {
            const icon = getNotifIcon(n.type);
            const unreadClass = n.read ? 'opacity-60' : 'border-l-2 border-orange-500';
            return `<div class="flex items-start space-x-3 p-3 bg-white/5 rounded-xl ${unreadClass}"><span class="text-xl">${icon}</span><div class="flex-1 min-w-0"><p class="text-sm font-bold text-white">${n.title}</p><p class="text-xs text-gray-400 truncate">${n.message}</p></div></div>`;
        }).join('');
    } catch (e) {
        console.error('Error loading notifications:', e);
    }
}

// ============ SECTION SWITCHING ============
let currentSection = 'dashboard';
let scheduleInitialized = false;
let workoutsInitialized = false;
let coursesInitialized = false;
let settingsInitialized = false;

function switchSection(sectionId) {
    // Close any open modals (e.g. course detail)
    const courseDetailModal = document.getElementById('course-detail-modal');
    if (courseDetailModal && !courseDetailModal.classList.contains('hidden')) {
        courseDetailModal.classList.add('hidden');
    }

    // Hide all sections
    document.querySelectorAll('.trainer-section').forEach(section => {
        section.classList.add('hidden');
    });

    // Show target section
    const targetSection = document.getElementById(`section-${sectionId}`);
    if (targetSection) {
        targetSection.classList.remove('hidden');
    }

    // Update sidebar nav state
    document.querySelectorAll('.sidebar-nav-item').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.section === sectionId) {
            btn.classList.add('active');
        }
    });

    // Update URL hash
    history.replaceState(null, '', `#${sectionId}`);

    // Update bottom nav state (legacy base.html nav)
    document.querySelectorAll('.bottom-nav-item').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.section === sectionId) {
            btn.classList.add('active');
        }
    });

    // Initialize section-specific content
    initSection(sectionId);

    currentSection = sectionId;
}

function initSection(sectionId) {
    switch(sectionId) {
        case 'workouts':
            if (!workoutsInitialized) {
                initWorkoutsSection();
                workoutsInitialized = true;
            }
            break;
        case 'schedule':
            if (!scheduleInitialized) {
                initScheduleSection();
                scheduleInitialized = true;
            }
            break;
        case 'courses':
            if (!coursesInitialized) {
                initCoursesSection();
                coursesInitialized = true;
            }
            break;
        case 'settings':
            if (!settingsInitialized) {
                initSettingsSection();
                settingsInitialized = true;
            }
            break;
    }
}

// ============ WORKOUTS (ALLENAMENTI) SECTION ============

// State for assignment modal
let pendingAssignment = null;

// State for click-to-assign (alternative to drag-and-drop)
let selectedWorkoutItem = null;

// Refresh the Allenamenti page lists by re-fetching trainer data
window.refreshWorkoutsPage = async function() {
    try {
        const apiBase = (window.APP_CONFIG || {}).apiBase || '';
        const res = await fetch(`${apiBase}/api/trainer/data?limit_cache=${Date.now()}`, { credentials: 'include' });
        if (res.ok) {
            const data = await res.json();
            window.trainerData = data;
            renderWorkoutDragList(data.workouts || []);
            renderSplitDragList(data.splits || []);
            renderClientDropTargets(data.clients || []);
            // Update stats
            const totalCount = (data.workouts || []).length + (data.splits || []).length;
            const el = document.getElementById('workouts-total-count');
            if (el) el.textContent = totalCount;
        }
    } catch(e) { console.error('Error refreshing workouts page:', e); }
};

function initWorkoutsSection() {
    const data = window.trainerData;
    if (!data) return;

    const workouts = data.workouts || [];
    const splits = data.splits || [];
    const clients = data.clients || [];

    // --- Stats ---
    const totalCount = workouts.length + splits.length;
    document.getElementById('workouts-total-count').textContent = totalCount;

    // In scadenza: clients with plan_expiry within next 7 days
    const now = new Date();
    const in7Days = new Date(now.getTime() + 7 * 86400000);
    let expiringCount = 0;
    let expiredCount = 0;
    clients.forEach(c => {
        if (c.plan_expiry) {
            const exp = new Date(c.plan_expiry);
            if (exp < now) expiredCount++;
            else if (exp <= in7Days) expiringCount++;
        }
    });
    document.getElementById('workouts-expiring-count').textContent = expiringCount;
    document.getElementById('workouts-expired-count').textContent = expiredCount;

    // --- Render Workouts (left column, Workout tab) ---
    renderWorkoutDragList(workouts);

    // --- Render Splits (left column, Split tab) ---
    renderSplitDragList(splits);

    // --- Render Client Drop Targets (right column) ---
    renderClientDropTargets(clients);

    // --- Search filtering ---
    const workoutSearch = document.getElementById('workouts-search');
    if (workoutSearch) {
        workoutSearch.addEventListener('input', () => {
            const q = workoutSearch.value.toLowerCase().trim();
            // Filter active tab
            const activeTab = document.querySelector('.trainer-tab.active');
            if (activeTab && activeTab.dataset.tab === 'splits-tab') {
                const filtered = splits.filter(s => (s.name || '').toLowerCase().includes(q) || (s.description || '').toLowerCase().includes(q));
                renderSplitDragList(filtered);
            } else {
                const filtered = workouts.filter(w => (w.title || '').toLowerCase().includes(q) || (w.difficulty || '').toLowerCase().includes(q));
                renderWorkoutDragList(filtered);
            }
        });
    }

    const clientSearch = document.getElementById('workouts-client-search');
    if (clientSearch) {
        clientSearch.addEventListener('input', () => {
            const q = clientSearch.value.toLowerCase().trim();
            const filtered = clients.filter(c => (c.name || '').toLowerCase().includes(q));
            renderClientDropTargets(filtered);
        });
    }

    // Refresh lucide icons
    if (window.lucide) lucide.createIcons();
}

function renderWorkoutDragList(workouts) {
    const tbody = document.getElementById('workouts-drag-list');
    if (!tbody) return;
    tbody.innerHTML = '';

    if (workouts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align:center;padding:2rem;color:rgba(255,255,255,0.3);font-size:0.85rem;">Nessun allenamento creato</td></tr>';
        return;
    }

    workouts.forEach(w => {
        const tr = document.createElement('tr');
        tr.className = 'workout-drag-card';
        tr.draggable = true;
        tr.dataset.type = 'workout';
        tr.dataset.itemId = w.id;
        tr.dataset.itemName = w.title || 'Workout';

        const exCount = Array.isArray(w.exercises) ? w.exercises.length : 0;
        const meta = [w.duration, w.difficulty, exCount > 0 ? `${exCount} es.` : null].filter(Boolean).join(' · ');

        tr.innerHTML = `
            <td style="width:40px;"><input type="checkbox" style="opacity:0.3;" onclick="event.stopPropagation();"></td>
            <td>
                <div style="display:flex;align-items:center;gap:0.75rem;">
                    <i data-lucide="grip-vertical" class="w-4 h-4" style="color:rgba(255,255,255,0.2);flex-shrink:0;"></i>
                    <div>
                        <div style="font-weight:600;color:white;font-size:0.85rem;">${w.title || 'Senza titolo'}</div>
                        <div style="font-size:0.75rem;color:rgba(255,255,255,0.4);">${meta}</div>
                    </div>
                </div>
            </td>
        `;

        // Drag handlers
        tr.addEventListener('dragstart', handleDragStart);
        tr.addEventListener('dragend', handleDragEnd);

        // Click-to-select handler (alternative to drag-and-drop)
        tr.addEventListener('click', function(e) {
            if (e.target.tagName === 'INPUT') return; // Ignore checkbox clicks
            selectWorkoutItem(this);
        });

        tbody.appendChild(tr);
    });

    if (window.lucide) lucide.createIcons();
}

function renderSplitDragList(splits) {
    const tbody = document.getElementById('splits-drag-list');
    if (!tbody) return;
    tbody.innerHTML = '';

    if (splits.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align:center;padding:2rem;color:rgba(255,255,255,0.3);font-size:0.85rem;">Nessun split creato</td></tr>';
        return;
    }

    splits.forEach(s => {
        const tr = document.createElement('tr');
        tr.className = 'workout-drag-card';
        tr.draggable = true;
        tr.dataset.type = 'split';
        tr.dataset.itemId = s.id;
        tr.dataset.itemName = s.name || 'Split';

        const dayCount = Array.isArray(s.days) ? s.days.length : 0;
        const meta = [s.description, dayCount > 0 ? `${dayCount} giorni` : null].filter(Boolean).join(' · ');

        tr.innerHTML = `
            <td style="width:40px;"><input type="checkbox" style="opacity:0.3;" onclick="event.stopPropagation();"></td>
            <td>
                <div style="display:flex;align-items:center;gap:0.75rem;">
                    <i data-lucide="grip-vertical" class="w-4 h-4" style="color:rgba(255,255,255,0.2);flex-shrink:0;"></i>
                    <div>
                        <div style="font-weight:600;color:white;font-size:0.85rem;">${s.name || 'Senza titolo'}</div>
                        <div style="font-size:0.75rem;color:rgba(255,255,255,0.4);">${meta || 'Split settimanale'}</div>
                    </div>
                </div>
            </td>
        `;

        tr.addEventListener('dragstart', handleDragStart);
        tr.addEventListener('dragend', handleDragEnd);

        // Click-to-select handler
        tr.addEventListener('click', function(e) {
            if (e.target.tagName === 'INPUT') return;
            selectWorkoutItem(this);
        });

        tbody.appendChild(tr);
    });

    if (window.lucide) lucide.createIcons();
}

// Click-to-select: highlight selected workout/split, then click client to assign
function selectWorkoutItem(el) {
    // Deselect previous
    document.querySelectorAll('.workout-drag-card.selected').forEach(r => r.classList.remove('selected'));
    // Select this one
    el.classList.add('selected');
    selectedWorkoutItem = {
        type: el.dataset.type,
        id: el.dataset.itemId,
        name: el.dataset.itemName
    };
    console.log('[Select]', selectedWorkoutItem);
}

function renderClientDropTargets(clients) {
    const container = document.getElementById('workouts-client-list');
    if (!container) return;
    container.innerHTML = '';

    if (clients.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:2rem;color:rgba(255,255,255,0.3);font-size:0.85rem;">Nessun cliente trovato</div>';
        return;
    }

    clients.forEach(c => {
        const div = document.createElement('div');
        div.className = 'client-drop-target';
        div.dataset.clientId = c.id;
        div.dataset.clientName = c.name;

        const avatarUrl = c.profile_picture || `https://api.dicebear.com/7.x/avataaars/svg?seed=${c.name}`;
        const initials = c.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);

        let expiryDisplay = '\u2014';
        if (c.plan_expiry) {
            try {
                const d = new Date(c.plan_expiry);
                expiryDisplay = d.toLocaleDateString('it-IT', { day: '2-digit', month: 'short' });
            } catch(e) { expiryDisplay = c.plan_expiry; }
        }

        div.innerHTML = `
            <div style="display:flex;align-items:center;gap:0.75rem;flex:1;">
                <div class="member-avatar" style="width:32px;height:32px;overflow:hidden;flex-shrink:0;">
                    <img src="${avatarUrl}" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none';this.parentElement.textContent='${initials}';">
                </div>
                <div style="min-width:0;">
                    <div style="font-weight:600;color:white;font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${c.name}</div>
                    <div style="font-size:0.7rem;color:rgba(255,255,255,0.4);">${c.assigned_split || '\u2014'} · Scade: ${expiryDisplay}</div>
                </div>
            </div>
        `;

        // Drop target handlers (drag-and-drop)
        div.addEventListener('dragover', handleDragOver);
        div.addEventListener('dragenter', handleDragEnter);
        div.addEventListener('dragleave', handleDragLeave);
        div.addEventListener('drop', handleDrop);

        // Click handler (click-to-assign alternative)
        div.addEventListener('click', function() {
            if (!selectedWorkoutItem) {
                window.showToast && window.showToast('Seleziona prima un allenamento o split dalla lista', 'info');
                return;
            }
            const cId = this.dataset.clientId;
            const cName = this.dataset.clientName;
            console.log('[ClickAssign]', selectedWorkoutItem, '→', cId, cName);
            openAssignModal(selectedWorkoutItem.type, selectedWorkoutItem.id, selectedWorkoutItem.name, cId, cName);
        });

        container.appendChild(div);
    });
}

// ============ TAB SWITCHING ============

function switchWorkoutTab(tabId) {
    document.querySelectorAll('.trainer-tab-content').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('.trainer-tab').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.remove('hidden');
    const tabBtn = document.querySelector(`.trainer-tab[data-tab="${tabId}"]`);
    if (tabBtn) tabBtn.classList.add('active');

    // Re-apply search filter for the new tab
    const workoutSearch = document.getElementById('workouts-search');
    if (workoutSearch && workoutSearch.value.trim()) {
        workoutSearch.dispatchEvent(new Event('input'));
    }
}
window.switchWorkoutTab = switchWorkoutTab;

// ============ DRAG AND DROP ============

// Store drag data in a variable as fallback (Safari sometimes loses dataTransfer)
let currentDragData = null;

function handleDragStart(e) {
    console.log('[DragStart]', this.dataset);
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    const data = {
        type: this.dataset.type,
        id: this.dataset.itemId,
        name: this.dataset.itemName
    };
    currentDragData = data;
    try {
        e.dataTransfer.setData('text/plain', JSON.stringify(data));
    } catch(err) {
        console.warn('[DragStart] setData failed:', err);
    }
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
    // Clean up any leftover highlights
    document.querySelectorAll('.client-drop-target.drag-over').forEach(el => el.classList.remove('drag-over'));
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
}

function handleDragEnter(e) {
    e.preventDefault();
    this.classList.add('drag-over');
}

function handleDragLeave(e) {
    // Only remove if truly leaving the element (not entering a child)
    if (!this.contains(e.relatedTarget)) {
        this.classList.remove('drag-over');
    }
}

function handleDrop(e) {
    e.preventDefault();
    this.classList.remove('drag-over');

    let dragData;
    try {
        const raw = e.dataTransfer.getData('text/plain');
        console.log('[Drop] raw data:', raw);
        dragData = JSON.parse(raw);
    } catch(err) {
        console.warn('[Drop] dataTransfer parse failed, using fallback:', err);
        // Fallback: use the variable stored during dragstart
        dragData = currentDragData;
    }

    if (!dragData || !dragData.id) {
        console.error('[Drop] No valid drag data');
        window.showToast && window.showToast('Errore nel trascinamento', 'error');
        return;
    }

    const clientId = this.dataset.clientId;
    const clientName = this.dataset.clientName;
    console.log('[Drop] Assigning', dragData, 'to client', clientId, clientName);

    openAssignModal(dragData.type, dragData.id, dragData.name, clientId, clientName);
    currentDragData = null;
}

// ============ ASSIGNMENT MODAL ============

function openAssignModal(type, itemId, itemName, clientId, clientName) {
    pendingAssignment = { type, itemId, itemName, clientId, clientName };

    const overlay = document.getElementById('assign-modal-overlay');
    const title = document.getElementById('assign-modal-title');
    const subtitle = document.getElementById('assign-modal-subtitle');
    const dateLabel = document.getElementById('assign-modal-date-label');
    const dateInput = document.getElementById('assign-modal-date');

    if (type === 'split') {
        title.textContent = 'Assegna split';
        subtitle.textContent = `${itemName} → ${clientName}`;
        dateLabel.textContent = 'Data di inizio';
        // Default to next Monday
        const today = new Date();
        const dayOfWeek = today.getDay() || 7;
        const nextMonday = new Date(today);
        nextMonday.setDate(today.getDate() + (8 - dayOfWeek));
        dateInput.value = nextMonday.toISOString().split('T')[0];
    } else {
        title.textContent = 'Assegna allenamento';
        subtitle.textContent = `${itemName} → ${clientName}`;
        dateLabel.textContent = 'Data';
        dateInput.value = new Date().toISOString().split('T')[0];
    }

    overlay.classList.remove('hidden');
    overlay.style.display = 'flex';
}

function closeAssignModal() {
    const overlay = document.getElementById('assign-modal-overlay');
    overlay.classList.add('hidden');
    overlay.style.display = 'none';
    pendingAssignment = null;
    // Clear click-to-assign selection
    selectedWorkoutItem = null;
    document.querySelectorAll('.workout-drag-card.selected').forEach(r => r.classList.remove('selected'));
}
window.closeAssignModal = closeAssignModal;

async function confirmAssignment() {
    if (!pendingAssignment) return;

    const { type, itemId, clientId } = pendingAssignment;
    const dateValue = document.getElementById('assign-modal-date').value;

    if (!dateValue) {
        window.showToast('Seleziona una data', 'error');
        return;
    }

    try {
        let res;
        const trainerSelector = document.getElementById('trainer-selector');
        const trainerId = trainerSelector ? trainerSelector.value : 'trainer_default';

        const apiBase = (window.APP_CONFIG || {}).apiBase || '';

        if (type === 'split') {
            console.log('[Assignment] Assigning split', itemId, 'to client', clientId, 'start:', dateValue);
            res = await fetch(`${apiBase}/api/trainer/assign_split`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-trainer-id': trainerId
                },
                credentials: 'include',
                body: JSON.stringify({
                    split_id: itemId,
                    client_id: clientId,
                    start_date: dateValue
                })
            });
        } else {
            console.log('[Assignment] Assigning workout', itemId, 'to client', clientId, 'date:', dateValue);
            res = await fetch(`${apiBase}/api/trainer/assign_workout`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    client_id: clientId,
                    date: dateValue,
                    workout_id: itemId
                })
            });
        }
        console.log('[Assignment] Response status:', res.status);

        if (res.ok) {
            const assignedClientId = clientId;
            const assignedItemName = pendingAssignment.itemName;
            window.showToast(`${type === 'split' ? 'Split' : 'Allenamento'} assegnato con successo!`, 'success');
            closeAssignModal();

            // Flash the client card green to confirm
            const clientCard = document.querySelector(`.client-drop-target[data-client-id="${assignedClientId}"]`);
            if (clientCard) {
                clientCard.style.borderColor = '#22c55e';
                clientCard.style.background = 'rgba(34, 197, 94, 0.1)';
                setTimeout(() => {
                    clientCard.style.borderColor = '';
                    clientCard.style.background = '';
                }, 1500);
            }

            // Refresh trainer data to update client cards
            const trainerRes = await fetch(`${apiBase}/api/trainer/data?limit_cache=${Date.now()}`, { credentials: 'include' });
            if (trainerRes.ok) {
                const newData = await trainerRes.json();
                window.trainerData = newData;
                // Re-render client drop targets with updated data
                renderClientDropTargets(newData.clients || []);
                // Also update the Utenti page client table
                if (typeof renderClientList === 'function') {
                    allClients = newData.clients || [];
                    renderClientList(allClients);
                }
            }
        } else {
            const errText = await res.text();
            console.error('[Assignment] Error response:', res.status, errText);
            window.showToast('Errore: ' + errText, 'error');
        }
    } catch(err) {
        window.showToast('Errore di rete', 'error');
        console.error('Assignment error:', err);
    }
}
window.confirmAssignment = confirmAssignment;

// ============ SCHEDULE SECTION ============
let currentSchedule = [];
let currentWeekMonday = new Date();
let selectedDateStr;

const toLocalISO = (d) => {
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
};

function initScheduleSection() {
    const username = localStorage.getItem('username') || 'Trainer';
    const nameEl = document.getElementById('personal-name');
    if (nameEl) nameEl.textContent = username;

    // Initialize calendar
    const day = currentWeekMonday.getDay() || 7;
    if (day !== 1) currentWeekMonday.setHours(-24 * (day - 1));
    currentWeekMonday.setHours(0, 0, 0, 0);
    selectedDateStr = toLocalISO(new Date());

    fetchScheduleData();

    // Notes auto-save
    const notesArea = document.getElementById('personal-notes');
    if (notesArea) {
        const savedNotes = localStorage.getItem(`personal_notes_${username}`);
        if (savedNotes) notesArea.value = savedNotes;
        let saveTimeout;
        notesArea.addEventListener('input', () => {
            const indicator = document.getElementById('personal-notes-saved-indicator');
            if (indicator) indicator.style.opacity = '0';
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                localStorage.setItem(`personal_notes_${username}`, notesArea.value);
                if (indicator) indicator.style.opacity = '1';
            }, 1000);
        });
    }

    // Toggle buttons
    document.getElementById('toggle-my-workout-btn')?.addEventListener('click', () => {
        document.getElementById('my-workout-section')?.classList.toggle('hidden');
    });
    document.getElementById('toggle-my-split-btn')?.addEventListener('click', () => {
        document.getElementById('my-split-section')?.classList.toggle('hidden');
    });

    // Setup day toggles for availability modal
    setupDayToggles();
}

async function fetchScheduleData() {
    try {
        const res = await fetch('/api/trainer/data');
        const data = await res.json();
        currentSchedule = data.schedule || [];

        // Update streak
        const streakEl = document.getElementById('personal-streak');
        if (streakEl && data.streak !== undefined) streakEl.textContent = data.streak;

        // Render Today's Plan (mobile + desktop)
        const { gymId } = window.APP_CONFIG || { gymId: 'default' };
        ['todays-plan-container', 'd-todays-plan-container'].forEach(cid => {
            const planContainer = document.getElementById(cid);
            if (planContainer && data.todays_workout) {
                const w = data.todays_workout;
                planContainer.innerHTML = `
                    <div class="glass-card p-5 relative overflow-hidden group tap-effect cursor-pointer" onclick="window.location.href='/?gym_id=${gymId}&role=trainer&mode=workout${w.completed ? '&view=completed' : ''}'">
                        <div class="absolute inset-0 bg-primary opacity-20 group-hover:opacity-30 transition"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-4">
                                <span class="bg-white/10 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider">Piano di Oggi</span>
                                <span class="text-xl">${w.completed ? icon('check-circle', 20) : icon('dumbbell', 20)}</span>
                            </div>
                            <h3 class="text-2xl font-black italic uppercase mb-1">${w.title}</h3>
                            <p class="text-sm text-gray-300 mb-4">${w.duration || 60} min • ${w.difficulty || 'Intermediate'}</p>
                            <button class="block w-full py-3 ${w.completed ? 'bg-green-500 text-white' : 'bg-white text-black hover:bg-gray-200'} text-center font-bold rounded-xl transition">${w.completed ? 'COMPLETATO ✓' : 'INIZIA SESSIONE'}</button>
                        </div>
                    </div>
                `;
            } else if (planContainer && !data.todays_workout) {
                planContainer.innerHTML = `
                    <div class="glass-card p-5 text-center text-gray-500">
                        <p class="text-sm">${icon('calendar-off', 20)} Nessun allenamento programmato per oggi</p>
                    </div>
                `;
            }
        });

        // Render workouts
        const workoutContainer = document.getElementById('my-workout-card-container');
        if (workoutContainer && data.workouts) {
            if (data.workouts.length === 0) {
                workoutContainer.innerHTML = '<p class="text-xs text-gray-500 italic text-center py-2">Nessun allenamento creato.</p>';
            } else {
                workoutContainer.innerHTML = data.workouts.map(w => `
                    <div class="glass-card p-3 mb-2">
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <h4 class="font-bold text-sm text-white">${w.title}</h4>
                                <p class="text-[10px] text-gray-400">${w.duration || 60} min • ${w.difficulty || 'Intermediate'}</p>
                            </div>
                        </div>
                        <button class="w-full py-1.5 bg-green-600/20 hover:bg-green-600 text-green-400 hover:text-white text-xs font-bold rounded-lg transition border border-green-500/30"
                            onclick="window.assignWorkoutToSelf && window.assignWorkoutToSelf('${w.id}', '${w.title}')"><i data-lucide="check-circle" class="w-4 h-4 inline-block align-middle"></i> Assegna a Me (Oggi)</button>
                    </div>
                `).join('');
            }
        }

        // Render splits
        const splitContainer = document.getElementById('my-split-card-container');
        if (splitContainer && data.splits) {
            if (data.splits.length === 0) {
                splitContainer.innerHTML = '<p class="text-xs text-gray-500 italic text-center py-2">Nessun split creato.</p>';
            } else {
                splitContainer.innerHTML = data.splits.map(s => `
                    <div class="glass-card p-3 mb-2">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-sm text-white">${s.name}</h4>
                                <p class="text-[10px] text-gray-400">${s.description || 'Nessuna descrizione'}</p>
                            </div>
                            <span class="text-[10px] bg-primary/20 text-primary px-2 py-0.5 rounded">${s.days_per_week} Giorni</span>
                        </div>
                    </div>
                `).join('');
            }
        }

        renderCalendarStrip();
        renderSchedule(selectedDateStr);
    } catch (e) {
        console.error("Error fetching schedule data:", e);
    }
}

window.changeWeek = function(offset) {
    currentWeekMonday.setDate(currentWeekMonday.getDate() + (offset * 7));
    selectedDateStr = toLocalISO(currentWeekMonday);
    renderCalendarStrip();
    renderSchedule(selectedDateStr);
};

function renderCalendarStripInto(containerId, monthLabelId) {
    const daysContainer = document.getElementById(containerId);
    if (!daysContainer) return;
    daysContainer.innerHTML = '';
    const monthLabel = document.getElementById(monthLabelId);
    if (monthLabel) monthLabel.innerText = currentWeekMonday.toLocaleDateString('it-IT', { month: 'short' });

    const itDays = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'];
    const isDashboard = containerId === 'd-calendar-strip';

    for (let i = 0; i < 7; i++) {
        const d = new Date(currentWeekMonday);
        d.setDate(currentWeekMonday.getDate() + i);
        const dateStr = toLocalISO(d);
        const isSelected = dateStr === selectedDateStr;
        const isToday = dateStr === toLocalISO(new Date());

        const div = document.createElement('div');
        div.className = `flex flex-col items-center p-2 rounded cursor-pointer transition ${isSelected ? 'bg-white/10 text-white' : 'text-white/40 hover:bg-white/5'}`;
        if (isToday && !isSelected) div.classList.add('border', 'border-white/10');

        const dayName = isDashboard ? itDays[(d.getDay() + 6) % 7] : d.toLocaleDateString('it-IT', { weekday: 'narrow' });
        const dayNum = d.getDate();
        const hasEvents = currentSchedule.some(e => e.date === dateStr);
        const dot = hasEvents ? `<div class="w-1 h-1 rounded-full bg-primary mt-1"></div>` : '';

        div.innerHTML = `<span class="opacity-50 text-[10px]">${dayName}</span><span>${dayNum}</span>${dot}`;
        div.onclick = () => {
            selectedDateStr = dateStr;
            renderCalendarStrip();
            renderSchedule(dateStr);
        };
        daysContainer.appendChild(div);
    }
}

function renderCalendarStrip() {
    renderCalendarStripInto('calendar-strip', 'month-label');
    renderCalendarStripInto('d-calendar-strip', 'd-month-label');

    // Update week range label for Utenti page
    const weekRangeEl = document.getElementById('d-week-range-label');
    if (weekRangeEl) {
        const startDay = currentWeekMonday.getDate().toString().padStart(2, '0');
        const endDate = new Date(currentWeekMonday);
        endDate.setDate(endDate.getDate() + 6);
        const endDay = endDate.getDate().toString().padStart(2, '0');
        const monthName = endDate.toLocaleDateString('it-IT', { month: 'short' });
        weekRangeEl.textContent = `${startDay} - ${endDay} ${monthName}`;
    }
}

function renderScheduleInto(dateStr, containerId, dateElId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const [y, m, d] = dateStr.split('-').map(Number);
    const dateObj = new Date(y, m - 1, d);
    const dateEl = document.getElementById(dateElId);
    if (dateEl) dateEl.innerText = dateObj.toLocaleDateString('it-IT', { weekday: 'long', month: 'long', day: 'numeric' });

    container.innerHTML = '';
    const dayEvents = currentSchedule.filter(e => e.date === dateStr).sort((a, b) => a.time.localeCompare(b.time));

    dayEvents.forEach(s => {
        const div = document.createElement('div');
        const opacityClass = s.completed ? 'opacity-50 grayscale' : '';
        div.className = `flex justify-between items-center bg-white/5 border border-white/5 rounded-xl p-3 group relative ${opacityClass}`;

        let colorClass = "text-blue-400 bg-blue-500/20";
        if (s.type === 'personal') colorClass = "text-green-400 bg-green-500/20";
        if (s.type === 'class') colorClass = "text-yellow-400 bg-yellow-500/20";
        if (s.type === '1on1_appointment') colorClass = "text-orange-400 bg-orange-500/20";

        let [h, min] = s.time.split(':');
        let ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12 || 12;

        div.innerHTML = `
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 rounded-lg ${colorClass} flex flex-col items-center justify-center">
                    <span class="font-bold text-lg leading-none">${h}</span>
                    <span class="text-[9px] uppercase">${ampm}</span>
                </div>
                <div>
                    <p class="text-[10px] text-white/30">${s.duration || 60} min</p>
                    <h4 class="font-bold text-sm text-white ${s.completed ? 'line-through text-white/50' : ''}">${s.title}</h4>
                    <p class="text-xs text-white/50">${s.subtitle || ''}</p>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <button onclick="toggleComplete('${s.id}')"
                    class="w-10 h-10 rounded-full flex items-center justify-center border-2 transition-all duration-300
                    ${s.completed ? 'bg-green-500 border-green-500 text-white' : 'border-white/20 text-transparent hover:border-white/50'}">
                    <span class="transform transition-transform duration-300 ${s.completed ? 'scale-100' : 'scale-0'}">✓</span>
                </button>
                <button onclick="deleteEvent('${s.id}')" class="text-red-500 opacity-0 group-hover:opacity-100 transition p-2 hover:bg-white/10 rounded-lg">✕</button>
            </div>
        `;
        container.appendChild(div);
    });

    // Add button
    const addDiv = document.createElement('div');
    addDiv.className = "flex items-center justify-center rounded-xl border border-white/20 border-dashed hover:bg-white/5 transition cursor-pointer";
    addDiv.style.padding = "0.75rem";
    addDiv.style.minHeight = "72px";
    addDiv.onclick = () => openAddModal(dateStr);
    addDiv.innerHTML = `<span class="text-sm text-white/40">+ Aggiungi appuntamento</span>`;
    container.appendChild(addDiv);
}

function renderSchedule(dateStr) {
    renderScheduleInto(dateStr, 'schedule-container', 'current-full-date');
    renderScheduleInto(dateStr, 'd-schedule-container', 'd-current-full-date');
}

async function openAddModal(dateStr) {
    document.getElementById('event-date-input').value = dateStr;
    document.getElementById('add-event-modal').classList.remove('hidden');
}

window.deleteEvent = async function(id) {
    if (!confirm("Eliminare questo evento?")) return;
    try {
        const res = await fetch(`/api/trainer/events/${id}`, { method: 'DELETE' });
        if (res.ok) fetchScheduleData();
    } catch (e) { console.error(e); }
};

window.toggleComplete = async function(id) {
    try {
        const res = await fetch(`/api/trainer/events/${id}/toggle_complete`, { method: 'POST' });
        if (res.ok) fetchScheduleData();
    } catch (e) { console.error(e); }
};

// Add event form
document.getElementById('add-event-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    data.duration = parseInt(data.duration) || 60;

    try {
        const res = await fetch('/api/trainer/events', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        if (res.ok) {
            await fetchScheduleData();
            document.getElementById('add-event-modal').classList.add('hidden');
            e.target.reset();
        }
    } catch (err) { console.error(err); }
});

// ============ AVAILABILITY ============
function setupDayToggles() {
    document.querySelectorAll('.day-toggle').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const day = this.dataset.day;
            const timesDiv = document.querySelector(`.day-times[data-day="${day}"]`);
            if (timesDiv) {
                timesDiv.classList.toggle('hidden', !this.checked);
            }
        });
    });
}

window.openAvailabilityModal = async function() {
    document.getElementById('availability-modal').classList.remove('hidden');
    await loadAvailability();
};

window.closeAvailabilityModal = function() {
    document.getElementById('availability-modal').classList.add('hidden');
};

async function loadAvailability() {
    try {
        const res = await fetch('/api/trainer/availability');
        const slots = await res.json();

        document.querySelectorAll('.day-toggle').forEach(cb => cb.checked = false);
        document.querySelectorAll('.day-times').forEach(div => div.classList.add('hidden'));

        slots.forEach(slot => {
            const checkbox = document.querySelector(`.day-toggle[data-day="${slot.day_of_week}"]`);
            const timesDiv = document.querySelector(`.day-times[data-day="${slot.day_of_week}"]`);
            if (checkbox && timesDiv) {
                checkbox.checked = true;
                timesDiv.classList.remove('hidden');
                timesDiv.querySelector('.start-time').value = slot.start_time;
                timesDiv.querySelector('.end-time').value = slot.end_time;
            }
        });
    } catch (e) { console.error('Error loading availability:', e); }

    // Load session rate
    try {
        const rateRes = await fetch('/api/trainer/session-rate');
        if (rateRes.ok) {
            const rateData = await rateRes.json();
            const rateInput = document.getElementById('trainer-session-rate');
            if (rateInput && rateData.session_rate != null) {
                rateInput.value = rateData.session_rate;
            }
        }
    } catch (e) { console.error('Error loading session rate:', e); }
}

window.saveAvailability = async function() {
    const availability = [];
    document.querySelectorAll('.day-toggle:checked').forEach(checkbox => {
        const day = parseInt(checkbox.dataset.day);
        const timesDiv = document.querySelector(`.day-times[data-day="${day}"]`);
        if (timesDiv) {
            availability.push({
                day_of_week: day,
                start_time: timesDiv.querySelector('.start-time').value,
                end_time: timesDiv.querySelector('.end-time').value
            });
        }
    });

    try {
        const res = await fetch('/api/trainer/availability', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ availability })
        });

        // Save session rate
        const rateInput = document.getElementById('trainer-session-rate');
        const rateValue = rateInput.value ? parseFloat(rateInput.value) : null;
        await fetch('/api/trainer/session-rate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_rate: rateValue })
        });

        if (res.ok) {
            closeAvailabilityModal();
            alert('Disponibilit\u00e0 e tariffa salvate!');
        }
    } catch (e) { console.error('Error saving availability:', e); }
};

// ============ COURSES SECTION ============
function initCoursesSection() {
    if (typeof window.loadCoursesPage === 'function') {
        window.loadCoursesPage();
    }

    // Load exercise library directly (always visible now)
    if (typeof window.loadCourseExercises === 'function') {
        window.loadCourseExercises();
    }

    // Search
    document.getElementById('course-exercise-search')?.addEventListener('input', (e) => {
        if (typeof window.filterCourseExercisesBySearch === 'function') {
            window.filterCourseExercisesBySearch(e.target.value);
        }
    });
}

// Course tab switching
function switchCourseTab(tabId) {
    document.querySelectorAll('#section-courses .trainer-tab-content').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('#section-courses .trainer-tab').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.remove('hidden');
    const tabBtn = document.querySelector(`#section-courses .trainer-tab[data-tab="${tabId}"]`);
    if (tabBtn) tabBtn.classList.add('active');
}
window.switchCourseTab = switchCourseTab;

// ============ SETTINGS SECTION ============
function initSettingsSection() {
    const username = localStorage.getItem('username') || 'Trainer';
    document.getElementById('settings-trainer-name').textContent = username;
    document.getElementById('settings-profile-pic').textContent = username.charAt(0).toUpperCase();

    // Load bio
    loadBio();
    loadSpecialties();

    // Specialty checkbox styling
    document.querySelectorAll('.specialty-checkbox').forEach(cb => {
        cb.addEventListener('change', function() {
            const span = this.nextElementSibling;
            if (this.checked) {
                span.classList.remove('bg-white/5', 'text-white/60');
                span.classList.add('bg-primary/20', 'text-primary', 'border-primary/30');
            } else {
                span.classList.add('bg-white/5', 'text-white/60');
                span.classList.remove('bg-primary/20', 'text-primary', 'border-primary/30');
            }
        });
    });
}

async function loadBio() {
    try {
        const res = await fetch('/api/profile/bio');
        if (res.ok) {
            const data = await res.json();
            document.getElementById('settings-bio').value = data.bio || '';
        }
    } catch (e) { console.error('Error loading bio:', e); }
}

window.saveBio = async function() {
    const bio = document.getElementById('settings-bio').value;
    try {
        const res = await fetch('/api/profile/bio', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ bio })
        });
        if (res.ok) alert('Bio salvata!');
    } catch (e) { console.error('Error saving bio:', e); }
};

async function loadSpecialties() {
    try {
        const res = await fetch('/api/profile/specialties');
        if (res.ok) {
            const data = await res.json();
            const specialties = data.specialties || [];
            document.querySelectorAll('.specialty-checkbox').forEach(cb => {
                cb.checked = specialties.includes(cb.value);
                cb.dispatchEvent(new Event('change'));
            });
        }
    } catch (e) { console.error('Error loading specialties:', e); }
}

window.saveSpecialties = async function() {
    const specialties = [];
    document.querySelectorAll('.specialty-checkbox:checked').forEach(cb => {
        specialties.push(cb.value);
    });
    try {
        const res = await fetch('/api/profile/specialties', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ specialties })
        });
        if (res.ok) alert('Specializzazioni salvate!');
    } catch (e) { console.error('Error saving specialties:', e); }
};

window.uploadProfilePicture = async function(input) {
    if (!input.files[0]) return;
    const formData = new FormData();
    formData.append('file', input.files[0]);
    try {
        const res = await fetch('/api/profile/picture', {
            method: 'POST',
            body: formData
        });
        if (res.ok) {
            const data = await res.json();
            if (data.url) {
                document.getElementById('settings-profile-pic').innerHTML = `<img src="${data.url}" class="w-full h-full object-cover rounded-full">`;
            }
        }
    } catch (e) { console.error('Error uploading picture:', e); }
};

// ============ INITIALIZATION ============
document.addEventListener('DOMContentLoaded', () => {
    // Update sidebar name
    const username = localStorage.getItem('username') || 'Trainer';
    const sidebarName = document.getElementById('sidebar-trainer-name');
    if (sidebarName) sidebarName.textContent = `Coach ${username}`;

    // Handle hash navigation
    const hash = window.location.hash.replace('#', '');
    if (hash && ['dashboard', 'workouts', 'schedule', 'courses', 'settings'].includes(hash)) {
        switchSection(hash);
    }

    // On desktop, load schedule data into the dashboard column
    if (window.innerWidth >= 1024 && (!hash || hash === 'dashboard')) {
        if (!scheduleInitialized) {
            const day = currentWeekMonday.getDay() || 7;
            if (day !== 1) currentWeekMonday.setHours(-24 * (day - 1));
            currentWeekMonday.setHours(0, 0, 0, 0);
            selectedDateStr = toLocalISO(new Date());
            fetchScheduleData();
            scheduleInitialized = true;
        }
    }

    // Show exercises on desktop
    if (window.innerWidth >= 1024) {
        const section = document.getElementById('exercises-section');
        if (section) {
            section.style.maxHeight = 'none';
            section.style.opacity = '1';
            section.style.overflow = 'visible';
        }
    }

    window.addEventListener('resize', () => {
        const section = document.getElementById('exercises-section');
        if (section && window.innerWidth >= 1024) {
            section.style.maxHeight = 'none';
            section.style.opacity = '1';
            section.style.overflow = 'visible';
        }
    });
});

// Expose functions globally
window.switchSection = switchSection;
</script>

{% endblock %}
