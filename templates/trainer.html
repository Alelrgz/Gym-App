{% extends "base.html" %}

{% block content %}

<!-- ===== MOBILE HEADER ===== -->
<header class="staff-mobile-header">
    <div class="staff-mobile-header-logo">
        <img src="/static/fitos-logo.svg" alt="FitOS" class="staff-logo-img">
        <span class="staff-role-label">{{ role | capitalize }}</span>
    </div>
    <div class="staff-mobile-header-actions">
        <button class="staff-mobile-msg-btn" onclick="switchSection('schedule')">
            <i data-lucide="calendar" class="w-5 h-5"></i>
        </button>
        <button class="staff-mobile-msg-btn" data-action="showModal" data-target="notification-modal">
            <i data-lucide="bell" class="w-5 h-5"></i>
        </button>
        <button class="staff-mobile-msg-btn" onclick="openConversationsModal()">
            <i data-lucide="send" class="w-5 h-5"></i>
        </button>
    </div>
</header>

<!-- Desktop Sidebar + Main Content Layout -->
<div class="trainer-layout">

    <!-- ===== LEFT SIDEBAR (desktop) ===== -->
    <aside class="staff-sidebar trainer-sidebar-new">
        <div class="staff-sidebar-logo">
            <img src="/static/fitos-logo.svg" alt="FitOS" class="staff-logo-img staff-logo-img--sidebar">
            <span class="staff-role-label">{{ role | capitalize }}</span>
        </div>

        <nav class="staff-sidebar-nav">
            <button onclick="switchSection('workouts')"
                    class="staff-nav-item sidebar-nav-item"
                    data-section="workouts">
                <i data-lucide="dumbbell" class="w-[18px] h-[18px]"></i>
                <span>Allenamenti</span>
            </button>
            <button onclick="switchSection('dashboard')"
                    class="staff-nav-item active sidebar-nav-item"
                    data-section="dashboard">
                <i data-lucide="users" class="w-[18px] h-[18px]"></i>
                <span>Utenti</span>
            </button>
            <button onclick="switchSection('courses')"
                    class="staff-nav-item sidebar-nav-item"
                    data-section="courses">
                <i data-lucide="book-open" class="w-[18px] h-[18px]"></i>
                <span>Corsi</span>
            </button>
            <button onclick="switchSection('settings')"
                    class="staff-nav-item sidebar-nav-item"
                    data-section="settings">
                <i data-lucide="settings" class="w-[18px] h-[18px]"></i>
                <span>Impostazioni</span>
            </button>
        </nav>

        <div style="flex:1"></div>

        <div style="display:flex;flex-direction:column;gap:0.25rem;">
            <a href="/auth/logout" class="staff-nav-item" style="color:#f87171;">
                <i data-lucide="log-out" class="w-[18px] h-[18px]"></i>
                <span>Esci</span>
            </a>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="staff-main trainer-main-new">

        <!-- ==================== SECTION: DASHBOARD (UTENTI) ==================== -->
        <section id="section-dashboard" class="trainer-section p-4 md:p-6 lg:p-8 max-w-[1400px] mx-auto">

            <!-- Hidden elements needed by other JS -->
            <span id="trainer-username" class="hidden">Loading...</span>
            <span id="unread-messages-badge" class="hidden">0</span>
            <select id="trainer-selector" class="hidden">
                <option value="trainer_default">Default Trainer</option>
            </select>

            <!-- Page Header (hidden on mobile) -->
            <div class="staff-page-header staff-desktop-only">
                <h1>Utenti</h1>
                <p>Da qui puoi registrare, cercare o gestire i clienti e i loro dati</p>
            </div>

            <!-- Stats Bar -->
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:1rem;">
                <div class="staff-stats-bar" style="margin-bottom:0;">
                    <div class="staff-stat-item">
                        <span class="staff-stat-value" id="total-clients-count">0</span>
                        <span class="staff-stat-label">clienti</span>
                    </div>
                    <div class="staff-stat-item">
                        <span class="staff-stat-value text-primary" id="expiring-clients-count">0</span>
                        <span class="staff-stat-label">in scad.</span>
                    </div>
                    <div class="staff-stat-item">
                        <span class="staff-stat-value" style="color:#f87171;" id="at-risk-clients-count">0</span>
                        <span class="staff-stat-label">A rischio</span>
                    </div>
                </div>

                <!-- Desktop only: message & notification icons -->
                <div class="hidden lg:flex gap-3">
                    <div onclick="openConversationsModal()" class="relative w-11 h-11 rounded-xl glass-card-interactive flex items-center justify-center">
                        <i data-lucide="message-circle" class="w-5 h-5"></i>
                    </div>
                    <div data-action="showModal" data-target="notification-modal" class="w-11 h-11 rounded-xl glass-card-interactive flex items-center justify-center">
                        <i data-lucide="bell" class="w-5 h-5"></i>
                    </div>
                </div>
            </div>

            <!-- Latest Message Card (mobile, populated by JS) -->
            <div id="trainer-latest-message" class="trainer-mobile-only" style="display:none;margin-bottom:1rem;"></div>

            <!-- Dual Search Row (desktop) -->
            <div class="trainer-dual-search">
                <div class="staff-search-bar" style="margin-bottom:0;">
                    <i data-lucide="search" class="w-4 h-4 search-icon"></i>
                    <input type="text" id="trainer-client-search" placeholder="Cerca clienti">
                </div>
                <div class="staff-search-bar" style="margin-bottom:0;">
                    <i data-lucide="search" class="w-4 h-4 search-icon"></i>
                    <input type="text" id="trainer-appointment-search" placeholder="Appuntamenti">
                </div>
            </div>

            <!-- Mobile Panel Tabs (hidden on desktop) -->
            <div class="trainer-panel-tabs" id="utenti-panel-tabs">
                <button class="trainer-panel-tab active" onclick="switchTrainerPanel('utenti-panel-tabs','utenti-panel-agenda')">AGENDA</button>
                <button class="trainer-panel-tab" onclick="switchTrainerPanel('utenti-panel-tabs','utenti-panel-clients')">UTENTI</button>
            </div>

            <!-- Two Column Layout -->
            <div class="trainer-utenti-grid">
                <!-- LEFT: Client Table (desktop) -->
                <div class="trainer-panel-content trainer-panel-hidden" id="utenti-panel-clients">
                    <!-- Mobile search bar (inside UTENTI tab) -->
                    <div class="staff-mobile-only" style="margin-bottom:0.75rem;">
                        <div style="display:flex;align-items:center;gap:0.5rem;">
                            <div class="staff-search-bar" style="margin-bottom:0;flex:1;">
                                <i data-lucide="search" class="w-4 h-4 search-icon"></i>
                                <input type="text" id="trainer-client-search-mobile" placeholder="Cerca clienti...">
                            </div>
                            <button style="width:40px;height:40px;background:var(--glass-bg-2);border:1px solid var(--glass-border-1);border-radius:var(--radius-md);color:rgba(255,255,255,0.4);display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;">
                                <i data-lucide="sliders-horizontal" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div class="staff-table-card staff-desktop-only">
                        <table class="staff-table">
                            <thead>
                                <tr>
                                    <th style="width:40px;"><input type="checkbox" style="opacity:0.3;"></th>
                                    <th>Clienti</th>
                                    <th>Scheda</th>
                                    <th>Scadenza</th>
                                </tr>
                            </thead>
                            <tbody id="trainer-clients-table-body">
                                <tr class="staff-skeleton-row"><td></td><td><div class="staff-skeleton" style="width:160px;"></div></td><td><div class="staff-skeleton" style="width:100px;"></div></td><td><div class="staff-skeleton" style="width:80px;"></div></td></tr>
                                <tr class="staff-skeleton-row"><td></td><td><div class="staff-skeleton" style="width:130px;"></div></td><td><div class="staff-skeleton" style="width:110px;"></div></td><td><div class="staff-skeleton" style="width:90px;"></div></td></tr>
                                <tr class="staff-skeleton-row"><td></td><td><div class="staff-skeleton" style="width:150px;"></div></td><td><div class="staff-skeleton" style="width:90px;"></div></td><td><div class="staff-skeleton" style="width:70px;"></div></td></tr>
                                <tr class="staff-skeleton-row"><td></td><td><div class="staff-skeleton" style="width:140px;"></div></td><td><div class="staff-skeleton" style="width:100px;"></div></td><td><div class="staff-skeleton" style="width:85px;"></div></td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Client Cards (mobile) -->
                    <div class="staff-mobile-only" id="trainer-clients-mobile-list">
                        <div class="staff-mobile-card" style="pointer-events:none;opacity:0.5;">
                            <div class="staff-skeleton" style="width:36px;height:36px;border-radius:50%;flex-shrink:0;"></div>
                            <div style="flex:1;">
                                <div class="staff-skeleton" style="width:120px;height:14px;border-radius:4px;margin-bottom:6px;"></div>
                                <div class="staff-skeleton" style="width:80px;height:10px;border-radius:4px;"></div>
                            </div>
                        </div>
                        <div class="staff-mobile-card" style="pointer-events:none;opacity:0.5;">
                            <div class="staff-skeleton" style="width:36px;height:36px;border-radius:50%;flex-shrink:0;"></div>
                            <div style="flex:1;">
                                <div class="staff-skeleton" style="width:140px;height:14px;border-radius:4px;margin-bottom:6px;"></div>
                                <div class="staff-skeleton" style="width:90px;height:10px;border-radius:4px;"></div>
                            </div>
                        </div>
                        <div class="staff-mobile-card" style="pointer-events:none;opacity:0.5;">
                            <div class="staff-skeleton" style="width:36px;height:36px;border-radius:50%;flex-shrink:0;"></div>
                            <div style="flex:1;">
                                <div class="staff-skeleton" style="width:100px;height:14px;border-radius:4px;margin-bottom:6px;"></div>
                                <div class="staff-skeleton" style="width:70px;height:10px;border-radius:4px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT: Appointments + My Workout -->
                <div class="trainer-panel-content" id="utenti-panel-agenda" style="display:flex;flex-direction:column;gap:1.5rem;">
                    <!-- Appointments Widget -->
                    <div class="glass-card" style="padding:1rem;border-radius:var(--radius-xl);">
                        <div style="display:flex;justify-content:center;align-items:center;gap:1rem;margin-bottom:1rem;">
                            <button onclick="changeWeek(-1)" style="width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);color:rgba(255,255,255,0.5);font-size:0.9rem;cursor:pointer;display:flex;align-items:center;justify-content:center;">
                                <i data-lucide="chevron-left" class="w-4 h-4"></i>
                            </button>
                            <div style="text-align:center;">
                                <div style="font-size:1.15rem;font-weight:800;color:white;text-transform:capitalize;" id="d-month-label">...</div>
                                <div style="font-size:0.75rem;color:rgba(255,255,255,0.4);font-weight:500;" id="d-week-range-label">...</div>
                            </div>
                            <button onclick="changeWeek(1)" style="width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);color:rgba(255,255,255,0.5);font-size:0.9rem;cursor:pointer;display:flex;align-items:center;justify-content:center;">
                                <i data-lucide="chevron-right" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <!-- Day tabs -->
                        <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:1rem;" id="d-calendar-strip"></div>
                        <!-- Events for selected day -->
                        <div id="d-schedule-container" style="display:flex;flex-direction:column;gap:0.5rem;margin-bottom:0.75rem;"></div>
                    </div>

                    <!-- My Workout Card -->
                    <div id="trainer-my-workout" style="display:flex;flex-direction:column;">
                        <div class="glass-card" style="display:flex;flex-direction:column;position:relative;overflow:hidden;border-radius:var(--radius-xl);">
                            <!-- Content (always visible, blurred when empty) -->
                            <div id="my-workout-content" style="display:flex;flex-direction:column;justify-content:center;padding:1.25rem;">
                                <p style="font-size:0.7rem;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.05em;font-weight:600;margin-bottom:0.75rem;">Il mio allenamento</p>
                                <div style="display:flex;justify-content:space-between;align-items:flex-end;">
                                    <div>
                                        <h3 style="font-size:1.15rem;font-weight:900;color:white;margin-bottom:0.25rem;" id="my-workout-title">Allenamento</h3>
                                    </div>
                                    <div style="text-align:right;font-size:0.75rem;color:rgba(255,255,255,0.5);line-height:1.6;">
                                        <p id="my-workout-duration">-- min</p>
                                        <p id="my-workout-exercises">-- esercizi</p>
                                        <p id="my-workout-difficulty">--</p>
                                    </div>
                                </div>
                                <button id="my-workout-cta" style="width:100%;margin-top:1rem;padding:0.75rem;background:var(--primary);border:none;border-radius:var(--radius-md);color:white;font-weight:700;font-size:0.85rem;cursor:pointer;transition:background 0.2s;">
                                    Avvia Allenamento
                                </button>
                            </div>
                            <!-- Empty overlay (blur + text) -->
                            <div id="my-workout-empty" style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0.4rem;background:rgba(20,20,20,0.5);border-radius:inherit;z-index:1;">
                                <p style="font-size:0.9rem;font-weight:600;color:rgba(255,255,255,0.5);">Nessun workout assegnato</p>
                                <p style="font-size:0.8rem;color:rgba(255,255,255,0.3);">
                                    <a onclick="switchSection('workouts')" style="cursor:pointer;color:rgba(255,255,255,0.3);">aggiungi un <span style="color:var(--primary);font-weight:600;">workout</span></a>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Nuovo PR / Achievement Card (populated by JS) -->
            <div id="trainer-pr-card" class="trainer-mobile-only" style="display:none;margin-top:1rem;"></div>

        </section>

        <!-- ==================== SECTION: ALLENAMENTI (WORKOUTS) ==================== -->
        <section id="section-workouts" class="trainer-section hidden p-4 md:p-6 lg:p-8 max-w-[1400px] mx-auto">

            <!-- Page Header -->
            <div class="staff-page-header">
                <h1>Allenamenti</h1>
                <p>Da qui puoi creare e assegnare allenamenti ai tuoi clienti</p>
            </div>

            <!-- Stats + Actions row -->
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem;">
                <div class="staff-stats-bar" style="margin-bottom:0;">
                    <div class="staff-stat-item">
                        <span class="staff-stat-value text-primary" id="workouts-total-count">0</span>
                        <span class="staff-stat-label">Allenamenti</span>
                    </div>
                    <div class="staff-stat-item">
                        <span class="staff-stat-value" style="color:rgba(255,255,255,0.5);" id="workouts-expiring-count">0</span>
                        <span class="staff-stat-label">In scadenza</span>
                    </div>
                    <div class="staff-stat-item">
                        <span class="staff-stat-value" style="color:#f87171;" id="workouts-expired-count">0</span>
                        <span class="staff-stat-label">Scaduti</span>
                    </div>
                </div>
                <!-- Create workout button moved inside Allenamenti column -->
            </div>

            <!-- Mobile Panel Tabs (hidden on desktop, flex on mobile) -->
            <div class="trainer-panel-tabs" id="workouts-panel-tabs">
                <button class="trainer-panel-tab active" onclick="switchTrainerPanel('workouts-panel-tabs','workouts-panel-exercises')">Esercizi</button>
                <button class="trainer-panel-tab" onclick="switchTrainerPanel('workouts-panel-tabs','workouts-panel-workouts')">Allenamenti</button>
                <button class="trainer-panel-tab" onclick="switchTrainerPanel('workouts-panel-tabs','workouts-panel-clients')">Clienti</button>
            </div>

            <!-- Three Column Grid -->
            <div class="trainer-workouts-grid">

                <!-- COL 1: Exercise Library (accordion rows) -->
                <div class="allenamenti-column trainer-panel-content" id="workouts-panel-exercises">
                    <div class="allenamenti-sticky-header">
                        <p class="allenamenti-col-header">Esercizi</p>
                        <div class="staff-search-bar" style="margin-bottom:0.75rem;">
                            <i data-lucide="search" class="w-4 h-4 search-icon"></i>
                            <input type="text" id="allenamenti-ex-search" placeholder="Cerca esercizi" oninput="filterAllenamentiExercises()">
                        </div>
                        <button onclick="showModal('create-exercise-modal')" style="width:100%;display:flex;align-items:center;justify-content:center;gap:0.4rem;padding:0.45rem 0;margin-bottom:0.65rem;background:rgba(255,255,255,0.05);border:1px dashed rgba(255,255,255,0.15);border-radius:8px;color:rgba(255,255,255,0.45);font-size:0.78rem;cursor:pointer;transition:all 0.18s;" onmouseover="this.style.background='rgba(255,255,255,0.09)';this.style.color='rgba(255,255,255,0.7)'" onmouseout="this.style.background='rgba(255,255,255,0.05)';this.style.color='rgba(255,255,255,0.45)'">
                            <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                            Aggiungi esercizio
                        </button>
                    </div>
                    <div id="allenamenti-exercise-list">
                        <div class="staff-skeleton" style="width:100%;height:32px;border-radius:6px;margin-bottom:0.4rem;"></div>
                        <div class="staff-skeleton" style="width:85%;height:32px;border-radius:6px;margin-bottom:0.4rem;"></div>
                        <div class="staff-skeleton" style="width:92%;height:32px;border-radius:6px;margin-bottom:0.4rem;"></div>
                        <div class="staff-skeleton" style="width:78%;height:32px;border-radius:6px;margin-bottom:0.4rem;"></div>
                        <div class="staff-skeleton" style="width:88%;height:32px;border-radius:6px;"></div>
                    </div>
                </div>

                <!-- COL 2: Workouts / Splits -->
                <div class="allenamenti-column trainer-panel-content" id="workouts-panel-workouts">
                    <p class="allenamenti-col-header">Allenamenti</p>
                    <div class="staff-search-bar" style="margin-bottom:0.75rem;">
                        <i data-lucide="search" class="w-4 h-4 search-icon"></i>
                        <input type="text" id="workouts-search" placeholder="Cerca allenamento">
                    </div>
                    <!-- Tab Bar -->
                    <div class="trainer-tab-bar" style="margin-bottom:0.75rem;">
                        <button class="trainer-tab active" data-tab="workouts-tab" onclick="switchWorkoutTab('workouts-tab')">Workout</button>
                        <button class="trainer-tab" data-tab="splits-tab" onclick="switchWorkoutTab('splits-tab')">Split</button>
                    </div>

                    <!-- Workout List -->
                    <div id="workouts-tab" class="trainer-tab-content">
                        <button onclick="openCreateWorkoutModal()" style="width:100%;display:flex;align-items:center;justify-content:center;gap:0.4rem;padding:0.45rem 0;margin-bottom:0.65rem;background:rgba(255,255,255,0.05);border:1px dashed rgba(255,255,255,0.15);border-radius:8px;color:rgba(255,255,255,0.45);font-size:0.78rem;cursor:pointer;transition:all 0.18s;" onmouseover="this.style.background='rgba(255,255,255,0.09)';this.style.color='rgba(255,255,255,0.7)'" onmouseout="this.style.background='rgba(255,255,255,0.05)';this.style.color='rgba(255,255,255,0.45)'">
                            <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                            Crea allenamento
                        </button>
                        <div class="staff-table-card" style="margin-bottom:0;">
                            <table class="staff-table">
                                <thead>
                                    <tr>
                                        <th style="width:40px;"><input type="checkbox" style="opacity:0.3;"></th>
                                        <th>Allenamento</th>
                                    </tr>
                                </thead>
                                <tbody id="workouts-drag-list">
                                    <tr class="staff-skeleton-row"><td></td><td><div class="staff-skeleton" style="width:180px;"></div></td></tr>
                                    <tr class="staff-skeleton-row"><td></td><td><div class="staff-skeleton" style="width:150px;"></div></td></tr>
                                    <tr class="staff-skeleton-row"><td></td><td><div class="staff-skeleton" style="width:170px;"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Split List -->
                    <div id="splits-tab" class="trainer-tab-content hidden">
                        <button id="create-split-btn" onclick="_toggleCreateSplitForm()" style="width:100%;display:flex;align-items:center;justify-content:center;gap:0.4rem;padding:0.45rem 0;margin-bottom:0.65rem;background:rgba(255,255,255,0.05);border:1px dashed rgba(255,255,255,0.15);border-radius:8px;color:rgba(255,255,255,0.45);font-size:0.78rem;cursor:pointer;transition:all 0.18s;" onmouseover="this.style.background='rgba(255,255,255,0.09)';this.style.color='rgba(255,255,255,0.7)'" onmouseout="this.style.background='rgba(255,255,255,0.05)';this.style.color='rgba(255,255,255,0.45)'">
                            <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                            Aggiungi split
                        </button>
                        <div id="create-split-form-container"></div>
                        <div class="staff-table-card" style="margin-bottom:0;">
                            <table class="staff-table">
                                <thead>
                                    <tr>
                                        <th style="width:40px;"><input type="checkbox" style="opacity:0.3;"></th>
                                        <th>Split</th>
                                    </tr>
                                </thead>
                                <tbody id="splits-drag-list">
                                    <tr class="staff-skeleton-row"><td></td><td><div class="staff-skeleton" style="width:180px;"></div></td></tr>
                                    <tr class="staff-skeleton-row"><td></td><td><div class="staff-skeleton" style="width:150px;"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- COL 3: Client Drop Targets -->
                <div class="allenamenti-column trainer-panel-content" id="workouts-panel-clients">
                    <p class="allenamenti-col-header">Clienti</p>
                    <div class="staff-search-bar" style="margin-bottom:0.75rem;">
                        <i data-lucide="search" class="w-4 h-4 search-icon"></i>
                        <input type="text" id="workouts-client-search" placeholder="Cerca clienti">
                    </div>
                    <div id="workouts-client-list" class="space-y-2"></div>
                </div>

            </div>
        </section>

        <!-- ===== ASSIGNMENT MODAL (triggered by drag-and-drop) ===== -->
        <div id="assign-modal-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;align-items:center;justify-content:center;">
            <div style="background:var(--bg-elevated);border:1px solid var(--glass-border-2);border-radius:var(--radius-xl);padding:2rem;width:100%;max-width:420px;box-shadow:var(--shadow-xl);">
                <h3 style="font-size:1.1rem;font-weight:700;color:white;margin-bottom:0.25rem;" id="assign-modal-title">Assegna allenamento</h3>
                <p style="font-size:0.8rem;color:rgba(255,255,255,0.4);margin-bottom:1.5rem;" id="assign-modal-subtitle"></p>

                <label style="font-size:0.75rem;font-weight:600;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:0.05em;display:block;margin-bottom:0.5rem;">
                    <span id="assign-modal-date-label">Data di inizio</span>
                </label>
                <input type="date" id="assign-modal-date" style="width:100%;padding:0.65rem 1rem;background:var(--glass-bg-1);border:1px solid var(--glass-border-1);border-radius:var(--radius-md);color:white;font-size:0.85rem;outline:none;margin-bottom:1.5rem;">

                <div style="display:flex;gap:0.75rem;">
                    <button onclick="closeAssignModal()" style="flex:1;padding:0.65rem;background:var(--glass-bg-2);border:1px solid var(--glass-border-2);border-radius:var(--radius-md);color:rgba(255,255,255,0.7);font-size:0.85rem;font-weight:600;cursor:pointer;">Annulla</button>
                    <button onclick="confirmAssignment()" style="flex:1;padding:0.65rem;background:var(--primary);border:none;border-radius:var(--radius-md);color:white;font-size:0.85rem;font-weight:600;cursor:pointer;">Assegna</button>
                </div>
            </div>
        </div>

        <!-- ==================== SECTION: SCHEDULE ==================== -->
        <section id="section-schedule" class="trainer-section hidden p-4 md:p-6 lg:p-8 max-w-[1400px] mx-auto">
            <!-- Header -->
            <div class="flex justify-between items-start mb-8">
                <div>
                    <p class="label-uppercase mb-1">Il Mio Profilo</p>
                    <h2 class="heading-page" id="personal-name">Caricamento...</h2>
                </div>
            </div>

            <!-- ZONE: Training (Green) -->
            <section class="mb-8">
                <div class="flex items-center gap-2 mb-4 border-l-4 border-green-400 pl-3">
                    <div class="w-8 h-8 rounded-lg bg-green-500/20 flex items-center justify-center">
                        <i data-lucide="flame" class="w-4 h-4 text-green-400"></i>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-green-400 uppercase tracking-wider">Allenamento</h3>
                        <p class="text-xs text-gray-500">Streak, piani e allenamenti</p>
                    </div>
                </div>

                <!-- Quick Actions Row -->
                <div class="grid grid-cols-2 gap-4 mb-5">
                    <div class="stat-card stat-card-success">
                        <p class="stat-value" id="personal-streak">0</p>
                        <p class="stat-label">Streak <i data-lucide="flame" class="w-4 h-4 inline-block align-middle"></i></p>
                    </div>
                    <button onclick="openAvailabilityModal()"
                        class="stat-card stat-card-success flex flex-col items-center justify-center group cursor-pointer hover:brightness-110 transition">
                        <p class="stat-value group-hover:scale-110 transition-transform"><i data-lucide="clock" class="w-7 h-7 stroke-current"></i></p>
                        <p class="stat-label">1-on-1</p>
                    </button>
                </div>

                <!-- My Workout Section (Hidden by default) -->
                <div id="my-workout-section" class="hidden transition-all duration-300 ease-in-out mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">I Miei Allenamenti</h3>
                        <button onclick="document.getElementById('my-workout-section').classList.add('hidden')"
                            class="text-white/40 hover:text-white text-sm">✕</button>
                    </div>
                    <div id="my-workout-card-container">
                        <div class="glass-card p-4 text-center">
                            <p class="text-gray-400 text-sm mb-2">Caricamento...</p>
                        </div>
                    </div>
                </div>

                <!-- My Splits Section (Hidden by default) -->
                <div id="my-split-section" class="hidden transition-all duration-300 ease-in-out mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">I Miei Split</h3>
                        <button onclick="document.getElementById('my-split-section').classList.add('hidden')"
                            class="text-white/40 hover:text-white text-sm">✕</button>
                    </div>
                    <div id="my-split-card-container">
                        <div class="glass-card p-4 text-center">
                            <p class="text-gray-400 text-sm mb-2">Caricamento...</p>
                        </div>
                    </div>
                </div>

                <!-- Today's Plan -->
                <div id="todays-plan-container">
                    <div class="glass-card p-5 relative overflow-hidden" id="default-plan-placeholder">
                        <div class="flex justify-between items-start mb-4">
                            <span class="bg-white/10 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider">Piano di Oggi</span>
                            <i data-lucide="clipboard" class="w-5 h-5"></i>
                        </div>
                        <h3 class="text-xl font-bold text-white/50 mb-2">Nessun Allenamento Assegnato</h3>
                        <p class="text-sm text-gray-400 mb-4">Seleziona un allenamento da "I Miei Allenamenti" e clicca "Assegna a Me" per impostare l'allenamento di oggi.</p>
                    </div>
                </div>
            </section>

            <!-- ZONE: Schedule (Blue) -->
            <section class="mb-8">
                <div class="flex items-center gap-2 mb-4 border-l-4 border-blue-400 pl-3">
                    <div class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center">
                        <i data-lucide="calendar" class="w-4 h-4 text-blue-400"></i>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-blue-400 uppercase tracking-wider">Agenda</h3>
                        <p class="text-xs text-gray-500">Calendario e appuntamenti</p>
                    </div>
                </div>
                <div class="glass-card p-4 rounded-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <span></span>
                        <div class="flex items-center space-x-2">
                            <button onclick="changeWeek(-1)"
                                class="w-6 h-6 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-white/70">←</button>
                            <span class="text-xs text-white/40 min-w-[3rem] text-center" id="month-label">...</span>
                            <button onclick="changeWeek(1)"
                                class="w-6 h-6 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-white/70">→</button>
                        </div>
                    </div>
                    <div class="text-xs text-center font-mono mb-2 text-white/50 uppercase tracking-widest" id="current-full-date"></div>
                    <div class="grid grid-cols-7 gap-1 mb-4 text-xs text-center font-mono" id="calendar-strip"></div>
                    <div class="space-y-3" id="schedule-container"></div>
                </div>
            </section>

            <!-- ZONE: Personal Notes (Slate) -->
            <section>
                <div class="flex items-center gap-2 mb-4 border-l-4 border-slate-500 pl-3">
                    <div class="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center">
                        <i data-lucide="file-text" class="w-4 h-4 text-slate-400"></i>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider">Note Personali</h3>
                        <p class="text-xs text-gray-500">Diario e appunti di allenamento</p>
                    </div>
                    <span class="text-[10px] text-green-400 opacity-0 transition-opacity duration-500 ml-auto" id="personal-notes-saved-indicator">Salvato</span>
                </div>
                <div class="glass-card p-4 rounded-2xl">
                    <textarea id="personal-notes"
                        class="w-full bg-black/20 text-white text-sm rounded-xl p-3 border border-white/5 focus:border-white/20 outline-none resize-none h-32 placeholder-white/20 transition"
                        placeholder="Annota i tuoi progressi, idee o registri di allenamento..."></textarea>
                </div>
            </section>
        </section>

        <!-- ==================== SECTION: COURSES ==================== -->
        <section id="section-courses" class="trainer-section hidden p-4 md:p-6 lg:p-8 max-w-[1400px] mx-auto">

            <!-- Page Header -->
            <div class="staff-page-header">
                <h1>Corsi</h1>
                <p>Da qui puoi registrare, cercare o gestire i clienti e i loro dati</p>
            </div>

            <!-- Stats + Actions row -->
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem;">
                <div class="staff-stats-bar" style="margin-bottom:0;">
                    <div class="staff-stat-item">
                        <span class="staff-stat-value text-primary" id="total-courses-count">0</span>
                        <span class="staff-stat-label">Corsi</span>
                    </div>
                    <div class="staff-stat-item">
                        <span class="staff-stat-value" style="color:rgba(255,255,255,0.5);" id="lessons-this-week">0</span>
                        <span class="staff-stat-label">Questa settimana</span>
                    </div>
                </div>
                <button data-action="openCreateCourse" class="staff-btn-action staff-btn-primary" style="border-radius:9999px;padding:0.6rem 1.5rem;">
                    Crea corso
                </button>
            </div>

            <!-- Hidden elements for backward compatibility -->
            <span id="avg-engagement" class="hidden">-</span>

            <!-- Mobile Panel Tabs (hidden on desktop, flex on mobile) -->
            <div class="trainer-panel-tabs" id="courses-panel-tabs">
                <button class="trainer-panel-tab active" onclick="switchTrainerPanel('courses-panel-tabs','courses-panel-list')">Corsi</button>
                <button class="trainer-panel-tab" onclick="switchTrainerPanel('courses-panel-tabs','courses-panel-participants')">Partecipanti</button>
                <button class="trainer-panel-tab" onclick="switchTrainerPanel('courses-panel-tabs','courses-panel-exercises')">Esercizi</button>
            </div>

            <!-- Three Column Grid -->
            <div class="trainer-courses-grid">

                <!-- LEFT: Courses (Tabs: I miei corsi / Corsi condivisi) -->
                <div class="trainer-panel-content" id="courses-panel-list">
                    <div class="trainer-tab-bar">
                        <button class="trainer-tab active" data-tab="own-courses-tab" onclick="switchCourseTab('own-courses-tab')">I miei corsi</button>
                        <button class="trainer-tab" data-tab="shared-courses-tab" onclick="switchCourseTab('shared-courses-tab')">Corsi condivisi</button>
                    </div>

                    <div id="own-courses-tab" class="trainer-tab-content">
                        <div id="courses-page-list" class="space-y-3" style="max-height:calc(100vh - 340px);overflow-y:auto;">
                            <div class="staff-skeleton" style="width:100%;height:60px;border-radius:var(--radius-md);margin-bottom:0.5rem;"></div>
                            <div class="staff-skeleton" style="width:100%;height:60px;border-radius:var(--radius-md);margin-bottom:0.5rem;"></div>
                            <div class="staff-skeleton" style="width:100%;height:60px;border-radius:var(--radius-md);"></div>
                        </div>
                    </div>

                    <div id="shared-courses-tab" class="trainer-tab-content hidden">
                        <div id="shared-courses-list" class="space-y-3" style="max-height:calc(100vh - 340px);overflow-y:auto;">
                            <div style="text-align:center;padding:2rem;color:rgba(255,255,255,0.3);font-size:0.85rem;">Nessun corso condiviso</div>
                        </div>
                    </div>
                </div>

                <!-- MIDDLE: Partecipanti -->
                <div class="trainer-panel-content" id="courses-panel-participants">
                    <div style="padding:0.65rem 1rem;font-size:0.75rem;font-weight:600;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--glass-border-1);margin-bottom:1rem;">
                        Partecipanti
                    </div>
                    <div id="courses-participants-list" style="max-height:calc(100vh - 340px);overflow-y:auto;">
                        <div style="text-align:center;padding:3rem 1rem;color:rgba(255,255,255,0.25);font-size:0.8rem;">
                            <p style="margin-bottom:0.25rem;">Seleziona un corso</p>
                            <p style="font-size:0.75rem;">per vedere i partecipanti</p>
                        </div>
                    </div>
                </div>

                <!-- RIGHT: Exercise Library -->
                <div class="trainer-panel-content" id="courses-panel-exercises">
                    <div style="display:flex;align-items:center;justify-content:space-between;padding:0.65rem 1rem;border-bottom:1px solid var(--glass-border-1);margin-bottom:1rem;">
                        <span style="font-size:0.75rem;font-weight:600;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.05em;">Libreria Esercizi</span>
                        <button onclick="openCourseExerciseModal()" style="font-size:0.7rem;font-weight:600;color:var(--primary);background:none;border:none;cursor:pointer;">+ Nuovo</button>
                    </div>

                    <!-- Category filters -->
                    <div class="flex flex-wrap gap-1.5 mb-3" style="padding:0 0.25rem;">
                        <button onclick="filterCourseExercises('all')" data-filter="all"
                            class="course-ex-filter-btn active px-2.5 py-1 text-[10px] rounded-full bg-primary/20 text-primary border border-primary/30 transition">Tutti</button>
                        <button onclick="filterCourseExercises('yoga')" data-filter="yoga"
                            class="course-ex-filter-btn px-2.5 py-1 text-[10px] rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition">Yoga</button>
                        <button onclick="filterCourseExercises('pilates')" data-filter="pilates"
                            class="course-ex-filter-btn px-2.5 py-1 text-[10px] rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition">Pilates</button>
                        <button onclick="filterCourseExercises('stretch')" data-filter="stretch"
                            class="course-ex-filter-btn px-2.5 py-1 text-[10px] rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition">Stretch</button>
                        <button onclick="filterCourseExercises('cardio')" data-filter="cardio"
                            class="course-ex-filter-btn px-2.5 py-1 text-[10px] rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition">Cardio</button>
                    </div>

                    <!-- Search -->
                    <div style="position:relative;margin-bottom:0.75rem;padding:0 0.25rem;">
                        <span style="position:absolute;left:0.75rem;top:50%;transform:translateY(-50%);color:rgba(255,255,255,0.3);pointer-events:none;"><i data-lucide="search" class="w-3.5 h-3.5"></i></span>
                        <input type="text" id="course-exercise-search" placeholder="Cerca esercizi..."
                            style="width:100%;background:var(--glass-bg-1);border:1px solid var(--glass-border-1);border-radius:var(--radius-md);padding:0.5rem 0.75rem 0.5rem 2rem;font-size:0.8rem;color:white;outline:none;">
                    </div>

                    <!-- Exercise grid -->
                    <div id="course-exercise-library" class="space-y-2" style="max-height:calc(100vh - 440px);overflow-y:auto;">
                        <div style="text-align:center;padding:2rem;color:rgba(255,255,255,0.3);font-size:0.8rem;">Caricamento...</div>
                    </div>
                </div>
            </div>

            <!-- Hidden elements needed by toggle JS (no longer visible but keeps compatibility) -->
            <button id="toggle-course-exercises-btn" class="hidden"></button>
            <span id="course-exercises-chevron" class="hidden"></span>
            <div id="course-exercises-section" class="hidden" style="max-height:2000px;opacity:1;"></div>
        </section>

        <!-- ==================== SECTION: SETTINGS ==================== -->
        <section id="section-settings" class="trainer-section hidden p-4 md:p-6 lg:p-8 max-w-[1000px] mx-auto">
            <div class="mb-8">
                <p class="label-uppercase mb-1">Account</p>
                <h2 class="heading-page">Impostazioni</h2>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Profile Card -->
                <div class="lg:col-span-1">
                    <div class="glass-card-primary p-8 text-center">
                        <div id="settings-profile-pic" class="w-28 h-28 rounded-full bg-gradient-to-br from-primary to-orange-600 flex items-center justify-center mx-auto mb-5 text-4xl font-bold text-white shadow-lg">
                            T
                        </div>
                        <h3 class="text-xl font-bold text-white mb-1" id="settings-trainer-name">Trainer</h3>
                        <p class="text-sm text-muted">Trainer Personale</p>
                        <button onclick="document.getElementById('profile-picture-input').click()"
                            class="mt-5 btn-glass">
                            Cambia Foto
                        </button>
                        <input type="file" id="profile-picture-input" accept="image/*" class="hidden" onchange="uploadProfilePicture(this)">
                    </div>
                </div>

                <!-- Settings Options -->
                <div class="lg:col-span-2 space-y-4">
                    <!-- Bio -->
                    <div class="glass-card p-5">
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Bio</h3>
                        <textarea id="settings-bio" placeholder="Racconta ai clienti di te, la tua esperienza e il tuo stile di allenamento..."
                            class="w-full bg-black/20 text-white text-sm rounded-xl p-3 border border-white/10 focus:border-primary/50 outline-none resize-none h-24 transition"></textarea>
                        <button onclick="saveBio()" class="mt-2 text-xs bg-primary/20 hover:bg-primary/30 text-primary px-4 py-2 rounded-lg transition">Salva Bio</button>
                    </div>

                    <!-- Specialties -->
                    <div class="glass-card p-5">
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Specializzazioni</h3>
                        <div id="specialties-container" class="flex flex-wrap gap-2">
                            <label class="specialty-tag cursor-pointer">
                                <input type="checkbox" value="Weight Loss" class="hidden specialty-checkbox">
                                <span class="px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition inline-block">Dimagrimento</span>
                            </label>
                            <label class="specialty-tag cursor-pointer">
                                <input type="checkbox" value="Muscle Building" class="hidden specialty-checkbox">
                                <span class="px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition inline-block">Massa Muscolare</span>
                            </label>
                            <label class="specialty-tag cursor-pointer">
                                <input type="checkbox" value="Strength Training" class="hidden specialty-checkbox">
                                <span class="px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition inline-block">Allenamento Forza</span>
                            </label>
                            <label class="specialty-tag cursor-pointer">
                                <input type="checkbox" value="HIIT" class="hidden specialty-checkbox">
                                <span class="px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition inline-block">HIIT</span>
                            </label>
                            <label class="specialty-tag cursor-pointer">
                                <input type="checkbox" value="Yoga" class="hidden specialty-checkbox">
                                <span class="px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition inline-block">Yoga</span>
                            </label>
                            <label class="specialty-tag cursor-pointer">
                                <input type="checkbox" value="Nutrition" class="hidden specialty-checkbox">
                                <span class="px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition inline-block">Nutrizione</span>
                            </label>
                        </div>
                        <button onclick="saveSpecialties()" class="mt-3 text-xs bg-primary/20 hover:bg-primary/30 text-primary px-4 py-2 rounded-lg transition">Salva Specializzazioni</button>
                    </div>

                    <!-- Availability -->
                    <div class="glass-card p-5">
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Disponibilit&agrave; 1-on-1</h3>
                        <p class="text-xs text-gray-400 mb-3">Imposta i tuoi orari settimanali per le prenotazioni</p>
                        <button onclick="openAvailabilityModal()" class="text-xs bg-orange-500/20 hover:bg-orange-500/30 text-orange-400 px-4 py-2 rounded-lg transition">
                            Configura Disponibilit&agrave;
                        </button>
                    </div>

                    <!-- Account Actions -->
                    <div class="glass-card p-5">
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Account</h3>
                        <a href="/auth/logout" class="inline-flex items-center gap-2 text-xs bg-red-500/20 hover:bg-red-500/30 text-red-400 px-4 py-2 rounded-lg transition">
                            <i data-lucide="log-out" class="w-5 h-5 inline-block align-middle"></i> Esci
                        </a>
                    </div>
                </div>
            </div>
        </section>

    </main>
</div>

<!-- Bottom nav is in base.html for trainer role -->

<!-- Add Event Modal -->
<div id="add-event-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50 backdrop-blur-sm">
    <div class="glass-card w-full max-w-sm mx-4 p-6 rounded-2xl relative">
        <button onclick="document.getElementById('add-event-modal').classList.add('hidden')"
            class="absolute top-4 right-4 text-white/50 hover:text-white">✕</button>
        <h3 class="text-xl font-bold mb-4 text-center">Aggiungi Evento</h3>
        <form id="add-event-form" class="space-y-4">
            <div>
                <label class="text-xs text-gray-400 uppercase">Titolo</label>
                <input type="text" name="title" required
                    class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none"
                    placeholder="es. Consulenza Cliente">
            </div>
            <div>
                <label class="text-xs text-gray-400 uppercase">Sottotitolo / Dettagli</label>
                <input type="text" name="subtitle"
                    class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none"
                    placeholder="es. Mario Rossi - Gambe">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-xs text-gray-400 uppercase">Orario</label>
                    <input type="time" name="time" required
                        class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none">
                </div>
                <div>
                    <label class="text-xs text-gray-400 uppercase">Tipo</label>
                    <select name="type"
                        class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none">
                        <option value="personal">Personale</option>
                        <option value="consultation">Consulenza</option>
                        <option value="class">Corso</option>
                    </select>
                </div>
            </div>
            <div id="workout-selector-container" class="hidden">
                <label class="text-xs text-gray-400 uppercase">Seleziona Allenamento</label>
                <select name="workout_id" id="event-workout-select"
                    class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none">
                    <option value="">Nessuno</option>
                </select>
            </div>
            <div>
                <label class="text-xs text-gray-400 uppercase">Durata (minuti)</label>
                <input type="number" name="duration" value="60" min="15" step="15"
                    class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none">
            </div>
            <input type="hidden" name="date" id="event-date-input">
            <button type="submit"
                class="w-full py-3 bg-primary text-white font-bold rounded-xl hover:bg-primary/80 transition">
                Aggiungi all'Agenda
            </button>
        </form>
    </div>
</div>

<!-- Availability Settings Modal -->
<div id="availability-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50 backdrop-blur-sm">
    <div class="glass-card w-full max-w-md mx-4 p-6 rounded-2xl relative max-h-[90vh] overflow-y-auto">
        <button onclick="closeAvailabilityModal()" class="absolute top-4 right-4 text-white/50 hover:text-white">✕</button>
        <h3 class="text-xl font-bold mb-2 text-center">Disponibilit&agrave; 1-on-1</h3>
        <p class="text-xs text-gray-400 text-center mb-4">Imposta i tuoi orari settimanali per le prenotazioni</p>

        <div id="availability-days" class="space-y-3">
            <!-- Days will be generated by JS or hardcoded -->
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-day="0" class="day-toggle w-5 h-5 rounded accent-orange-500">
                    <span class="font-bold text-sm">Luned&igrave;</span>
                </label>
                <div class="day-times hidden grid grid-cols-2 gap-2 mt-2" data-day="0">
                    <div><label class="text-[10px] text-gray-400">Inizio</label><input type="time" class="start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="09:00"></div>
                    <div><label class="text-[10px] text-gray-400">Fine</label><input type="time" class="end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="17:00"></div>
                </div>
            </div>
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-day="1" class="day-toggle w-5 h-5 rounded accent-orange-500">
                    <span class="font-bold text-sm">Marted&igrave;</span>
                </label>
                <div class="day-times hidden grid grid-cols-2 gap-2 mt-2" data-day="1">
                    <div><label class="text-[10px] text-gray-400">Inizio</label><input type="time" class="start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="09:00"></div>
                    <div><label class="text-[10px] text-gray-400">Fine</label><input type="time" class="end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="17:00"></div>
                </div>
            </div>
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-day="2" class="day-toggle w-5 h-5 rounded accent-orange-500">
                    <span class="font-bold text-sm">Mercoled&igrave;</span>
                </label>
                <div class="day-times hidden grid grid-cols-2 gap-2 mt-2" data-day="2">
                    <div><label class="text-[10px] text-gray-400">Inizio</label><input type="time" class="start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="09:00"></div>
                    <div><label class="text-[10px] text-gray-400">Fine</label><input type="time" class="end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="17:00"></div>
                </div>
            </div>
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-day="3" class="day-toggle w-5 h-5 rounded accent-orange-500">
                    <span class="font-bold text-sm">Gioved&igrave;</span>
                </label>
                <div class="day-times hidden grid grid-cols-2 gap-2 mt-2" data-day="3">
                    <div><label class="text-[10px] text-gray-400">Inizio</label><input type="time" class="start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="09:00"></div>
                    <div><label class="text-[10px] text-gray-400">Fine</label><input type="time" class="end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="17:00"></div>
                </div>
            </div>
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-day="4" class="day-toggle w-5 h-5 rounded accent-orange-500">
                    <span class="font-bold text-sm">Venerd&igrave;</span>
                </label>
                <div class="day-times hidden grid grid-cols-2 gap-2 mt-2" data-day="4">
                    <div><label class="text-[10px] text-gray-400">Inizio</label><input type="time" class="start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="09:00"></div>
                    <div><label class="text-[10px] text-gray-400">Fine</label><input type="time" class="end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="17:00"></div>
                </div>
            </div>
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-day="5" class="day-toggle w-5 h-5 rounded accent-orange-500">
                    <span class="font-bold text-sm">Sabato</span>
                </label>
                <div class="day-times hidden grid grid-cols-2 gap-2 mt-2" data-day="5">
                    <div><label class="text-[10px] text-gray-400">Inizio</label><input type="time" class="start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="10:00"></div>
                    <div><label class="text-[10px] text-gray-400">Fine</label><input type="time" class="end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="14:00"></div>
                </div>
            </div>
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-day="6" class="day-toggle w-5 h-5 rounded accent-orange-500">
                    <span class="font-bold text-sm">Domenica</span>
                </label>
                <div class="day-times hidden grid grid-cols-2 gap-2 mt-2" data-day="6">
                    <div><label class="text-[10px] text-gray-400">Inizio</label><input type="time" class="start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="10:00"></div>
                    <div><label class="text-[10px] text-gray-400">Fine</label><input type="time" class="end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="14:00"></div>
                </div>
            </div>
        </div>

        <!-- Session Rate -->
        <div class="mt-4 bg-white/5 rounded-xl p-3">
            <label class="text-sm font-bold text-white mb-2 block">Tariffa Oraria Sessione (&euro;)</label>
            <p class="text-[10px] text-gray-400 mb-2">I clienti vedranno questo prezzo durante la prenotazione. Lascia vuoto per sessioni gratuite.</p>
            <input type="number" id="trainer-session-rate" min="0" step="0.01" placeholder="es. 50.00"
                class="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm">
        </div>

        <button onclick="saveAvailability()"
            class="w-full mt-4 py-3 bg-orange-500 text-white font-bold rounded-xl hover:bg-orange-600 transition">
            Salva Disponibilit&agrave;
        </button>
    </div>
</div>

<script>
// ============ NOTIFICATION FUNCTIONS ============
async function openNotificationsModal() {
    window.showModal('notification-modal');
    await loadNotifications();
}

async function loadNotifications() {
    const list = document.getElementById('notifications-list');
    if (!list) return;
    try {
        const res = await fetch('/api/notifications?limit=20');
        const notifications = await res.json();
        if (notifications.length === 0) {
            list.innerHTML = '<div class="text-center text-gray-400 py-8"><i data-lucide="bell" class="w-10 h-10 mb-2 block"></i><p class="text-sm">Nessuna notifica</p></div>';
            return;
        }
        list.innerHTML = notifications.map(n => {
            const icon = getNotifIcon(n.type);
            const unreadClass = n.read ? 'opacity-60' : 'border-l-2 border-orange-500';
            return `<div class="flex items-start space-x-3 p-3 bg-white/5 rounded-xl ${unreadClass}"><span class="text-xl">${icon}</span><div class="flex-1 min-w-0"><p class="text-sm font-bold text-white">${n.title}</p><p class="text-xs text-gray-400 truncate">${n.message}</p></div></div>`;
        }).join('');
    } catch (e) {
        console.error('Error loading notifications:', e);
    }
}

// ============ MOBILE HOMEPAGE CARDS ============

// Load latest message for the mobile homepage card
async function loadTrainerLatestMessage() {
    const card = document.getElementById('trainer-latest-message');
    if (!card) return;
    try {
        const res = await fetch('/api/messages/conversations', { credentials: 'include' });
        if (!res.ok) return;
        const convos = await res.json();
        if (!convos || convos.length === 0) { card.style.display = 'none'; return; }
        const latest = convos[0];
        if (!latest || !latest.last_message_preview) { card.style.display = 'none'; return; }
        const name = latest.other_user_name || 'Utente';
        const preview = latest.last_message_preview || '';
        const hasAttachment = preview.toLowerCase().includes('allegato') || preview.toLowerCase().includes('[file]');
        card.innerHTML = `
            <div class="trainer-msg-card" onclick="openConversationsModal()">
                <div class="trainer-msg-card-content">
                    <div class="trainer-msg-card-name">${name}</div>
                    <div class="trainer-msg-card-preview">${preview}</div>
                    ${hasAttachment ? '<div class="trainer-msg-card-attachment"><i data-lucide="camera" style="width:12px;height:12px;"></i> Allegato</div>' : ''}
                </div>
            </div>
        `;
        card.style.display = '';
        if (window.lucide) lucide.createIcons();
    } catch(e) { card.style.display = 'none'; }
}

// Load latest PR/achievement for the mobile homepage card
async function loadTrainerPRCard() {
    const card = document.getElementById('trainer-pr-card');
    if (!card) return;
    try {
        const res = await fetch('/api/notifications?limit=20', { credentials: 'include' });
        if (!res.ok) return;
        const notifs = await res.json();
        const prNotif = notifs.find(n =>
            (n.type && (n.type === 'pr' || n.type === 'personal_record')) ||
            (n.title && n.title.toLowerCase().includes('pr'))
        );
        if (!prNotif) { card.style.display = 'none'; return; }
        card.innerHTML = `
            <div class="trainer-pr-banner">
                <div class="trainer-pr-icon">🏆</div>
                <div class="trainer-pr-content">
                    <div class="trainer-pr-title">Nuovo PR</div>
                    <div class="trainer-pr-desc">${prNotif.message || prNotif.title || ''}</div>
                </div>
            </div>
        `;
        card.style.display = '';
    } catch(e) { card.style.display = 'none'; }
}

// Mobile UTENTI search sync
document.addEventListener('DOMContentLoaded', () => {
    const mobileSearch = document.getElementById('trainer-client-search-mobile');
    if (mobileSearch) {
        mobileSearch.addEventListener('input', () => {
            const desktopSearch = document.getElementById('trainer-client-search');
            if (desktopSearch) {
                desktopSearch.value = mobileSearch.value;
                desktopSearch.dispatchEvent(new Event('input'));
            }
        });
    }
    // Load mobile homepage cards
    setTimeout(() => {
        loadTrainerLatestMessage();
        loadTrainerPRCard();
    }, 1000);
});

// ============ SECTION SWITCHING ============
let currentSection = 'dashboard';
let scheduleInitialized = false;
let workoutsInitialized = false;
let workoutsPendingInit = false;
let coursesInitialized = false;
let settingsInitialized = false;

function switchTrainerPanel(tabGroupId, panelId) {
    // Update tab active state
    const tabGroup = document.getElementById(tabGroupId);
    if (tabGroup) {
        tabGroup.querySelectorAll('.trainer-panel-tab').forEach(btn => btn.classList.remove('active'));
        // Find the button that targets this panel
        tabGroup.querySelectorAll('.trainer-panel-tab').forEach(btn => {
            if (btn.getAttribute('onclick').includes(panelId)) btn.classList.add('active');
        });
    }
    // Find the parent grid (next sibling of the tab bar)
    const grid = tabGroup ? tabGroup.nextElementSibling : null;
    if (grid) {
        grid.querySelectorAll('.trainer-panel-content').forEach(panel => {
            if (panel.id === panelId) {
                panel.classList.remove('trainer-panel-hidden');
            } else {
                panel.classList.add('trainer-panel-hidden');
            }
        });
    }
}

function switchSection(sectionId) {
    // Close any open modals (e.g. course detail)
    const courseDetailModal = document.getElementById('course-detail-modal');
    if (courseDetailModal && !courseDetailModal.classList.contains('hidden')) {
        courseDetailModal.classList.add('hidden');
    }

    // Hide all sections
    document.querySelectorAll('.trainer-section').forEach(section => {
        section.classList.add('hidden');
    });

    // Show target section
    const targetSection = document.getElementById(`section-${sectionId}`);
    if (targetSection) {
        targetSection.classList.remove('hidden');
    }

    // Update sidebar nav state
    document.querySelectorAll('.sidebar-nav-item').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.section === sectionId) {
            btn.classList.add('active');
        }
    });

    // Update URL hash
    history.replaceState(null, '', `#${sectionId}`);

    // Update bottom nav state (legacy base.html nav)
    document.querySelectorAll('.bottom-nav-item').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.section === sectionId) {
            btn.classList.add('active');
        }
    });

    // Initialize section-specific content
    initSection(sectionId);

    currentSection = sectionId;
}

function initSection(sectionId) {
    switch(sectionId) {
        case 'dashboard':
            // Dashboard shows calendar on mobile, so init schedule if not done
            if (!scheduleInitialized) {
                initScheduleSection();
                scheduleInitialized = true;
            }
            // Load mobile homepage cards (latest message, PR)
            if (typeof loadTrainerLatestMessage === 'function') loadTrainerLatestMessage();
            if (typeof loadTrainerPRCard === 'function') loadTrainerPRCard();
            break;
        case 'workouts':
            if (!workoutsInitialized && !workoutsPendingInit) {
                if (window.trainerData) {
                    initWorkoutsSection();
                    workoutsInitialized = true;
                } else {
                    // Data not yet loaded — poll until ready
                    workoutsPendingInit = true;
                    const waitForData = setInterval(() => {
                        if (window.trainerData) {
                            clearInterval(waitForData);
                            workoutsPendingInit = false;
                            initWorkoutsSection();
                            workoutsInitialized = true;
                        }
                    }, 100);
                    setTimeout(() => { clearInterval(waitForData); workoutsPendingInit = false; }, 10000);
                }
            }
            break;
        case 'schedule':
            if (!scheduleInitialized) {
                initScheduleSection();
                scheduleInitialized = true;
            }
            break;
        case 'courses':
            if (!coursesInitialized) {
                initCoursesSection();
                coursesInitialized = true;
            }
            break;
        case 'settings':
            if (!settingsInitialized) {
                initSettingsSection();
                settingsInitialized = true;
            }
            break;
    }
}

// ============ WORKOUTS (ALLENAMENTI) SECTION ============

// State for assignment modal
let pendingAssignment = null;

// State for click-to-assign (alternative to drag-and-drop)
let selectedWorkoutItem = null;

// Refresh the Allenamenti page lists by re-fetching trainer data
window.refreshWorkoutsPage = async function() {
    try {
        const apiBase = (window.APP_CONFIG || {}).apiBase || '';
        const res = await fetch(`${apiBase}/api/trainer/data?limit_cache=${Date.now()}`, { credentials: 'include' });
        if (res.ok) {
            const data = await res.json();
            window.trainerData = data;
            renderWorkoutDragList(data.workouts || []);
            renderSplitDragList(data.splits || []);
            renderClientDropTargets(data.clients || []);
            // Update stats
            const totalCount = (data.workouts || []).length + (data.splits || []).length;
            const el = document.getElementById('workouts-total-count');
            if (el) el.textContent = totalCount;
        }
    } catch(e) { console.error('Error refreshing workouts page:', e); }
};

function initWorkoutsSection() {
    const data = window.trainerData;
    if (!data) return;

    const workouts = data.workouts || [];
    const splits = data.splits || [];
    const clients = data.clients || [];

    // --- Stats ---
    const totalCount = workouts.length + splits.length;
    document.getElementById('workouts-total-count').textContent = totalCount;

    // In scadenza: clients with plan_expiry within next 7 days
    const now = new Date();
    const in7Days = new Date(now.getTime() + 7 * 86400000);
    let expiringCount = 0;
    let expiredCount = 0;
    clients.forEach(c => {
        if (c.plan_expiry) {
            const exp = new Date(c.plan_expiry);
            if (exp < now) expiredCount++;
            else if (exp <= in7Days) expiringCount++;
        }
    });
    document.getElementById('workouts-expiring-count').textContent = expiringCount;
    document.getElementById('workouts-expired-count').textContent = expiredCount;

    // --- Render Workouts (left column, Workout tab) ---
    renderWorkoutDragList(workouts);

    // --- Render Splits (left column, Split tab) ---
    renderSplitDragList(splits);

    // --- Render Client Drop Targets (right column) ---
    renderClientDropTargets(clients);

    // --- Search filtering ---
    const workoutSearch = document.getElementById('workouts-search');
    if (workoutSearch) {
        workoutSearch.addEventListener('input', () => {
            const q = workoutSearch.value.toLowerCase().trim();
            // Filter active tab
            const activeTab = document.querySelector('.trainer-tab.active');
            if (activeTab && activeTab.dataset.tab === 'splits-tab') {
                const filtered = splits.filter(s => (s.name || '').toLowerCase().includes(q) || (s.description || '').toLowerCase().includes(q));
                renderSplitDragList(filtered);
            } else {
                const filtered = workouts.filter(w => (w.title || '').toLowerCase().includes(q) || (w.difficulty || '').toLowerCase().includes(q));
                renderWorkoutDragList(filtered);
            }
        });
    }

    const clientSearch = document.getElementById('workouts-client-search');
    if (clientSearch) {
        clientSearch.addEventListener('input', () => {
            const q = clientSearch.value.toLowerCase().trim();
            const filtered = clients.filter(c => (c.name || '').toLowerCase().includes(q));
            renderClientDropTargets(filtered);
        });
    }

    // --- Load Exercise List (left column) ---
    initAllenamentiExercises();

    // Refresh lucide icons
    if (window.lucide) lucide.createIcons();
}

// ============ EXERCISE LIST (Allenamenti column) ============

async function initAllenamentiExercises() {
    const container = document.getElementById('allenamenti-exercise-list');
    if (!container) return;
    const apiBase = (window.APP_CONFIG || {}).apiBase || '';
    const trainerId = (typeof getCurrentTrainerId === 'function') ? getCurrentTrainerId() : 'trainer_default';
    try {
        const res = await fetch(`${apiBase}/api/exercises`, { credentials: 'include' });
        if (!res.ok) return;
        const exercises = await res.json();
        window._allenamentiExercises = exercises;
        renderAllenamentiExerciseList(exercises);
    } catch(e) { console.error('Error loading exercises for allenamenti:', e); }
}

// After createExercise() runs, also refresh the allenamenti exercise list
document.addEventListener('DOMContentLoaded', () => {
    const orig = window.createExercise;
    if (typeof orig === 'function') {
        window.createExercise = async function(...args) {
            await orig.apply(this, args);
            if (document.getElementById('allenamenti-exercise-list')) {
                await initAllenamentiExercises();
            }
        };
    }
});

const _exMuscleColors = {
    'Chest': '#ef4444', 'Back': '#3b82f6', 'Legs': '#22c55e', 'Shoulders': '#f59e0b',
    'Arms': '#8b5cf6', 'Core': '#06b6d4', 'Cardio': '#ec4899', 'Glutes': '#f97316',
    'Calves': '#84cc16', 'Warmup': '#fb923c', 'Stretch': '#a78bfa'
};

function renderAllenamentiExerciseList(exercises) {
    const container = document.getElementById('allenamenti-exercise-list');
    if (!container) return;
    container.innerHTML = '';
    if (!exercises || exercises.length === 0) {
        container.innerHTML = '<p style="font-size:0.8rem;color:rgba(255,255,255,0.3);text-align:center;padding:1rem 0;">Nessun esercizio</p>';
        return;
    }
    exercises.forEach(ex => {
        const mColor = _exMuscleColors[ex.muscle] || '#6366f1';
        const hasVideo = !!(ex.video_url || ex.video_id);

        const item = document.createElement('div');
        item.className = 'allenamenti-ex-item';
        item.dataset.exId = ex.id;

        const row = document.createElement('div');
        row.className = 'allenamenti-ex-row';
        row.innerHTML = `
            <div style="width:3px;height:34px;border-radius:2px;background:${mColor};flex-shrink:0;opacity:0.75;"></div>
            <div style="min-width:0;flex:1;">
                <div style="font-size:0.8rem;font-weight:600;color:rgba(255,255,255,0.9);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${ex.name}</div>
                <div class="allenamenti-ex-muscle"><span style="color:${mColor};opacity:0.85;">${ex.muscle || ''}</span>${ex.type ? ' · ' + ex.type : ''}</div>
            </div>
            ${hasVideo ? `<svg xmlns="http://www.w3.org/2000/svg" style="width:13px;height:13px;flex-shrink:0;color:rgba(255,255,255,0.2);" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>` : ''}
            <svg class="allenamenti-ex-chevron" xmlns="http://www.w3.org/2000/svg" width="11" height="11" fill="none" viewBox="0 0 24 24" stroke="rgba(255,255,255,0.25)" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
        `;

        const expand = document.createElement('div');
        expand.className = 'allenamenti-ex-expand';
        expand.innerHTML = '<div class="allenamenti-ex-expand-inner"></div>';

        row.addEventListener('click', () => {
            const isOpen = expand.classList.contains('open');
            // Close any other open expands
            document.querySelectorAll('.allenamenti-ex-expand.open').forEach(e => {
                if (e !== expand) {
                    e.classList.remove('open');
                    e.previousElementSibling?.classList.remove('selected-ex');
                    const vid = e.querySelector('video');
                    if (vid) vid.pause();
                }
            });
            if (isOpen) {
                expand.classList.remove('open');
                row.classList.remove('selected-ex');
                const vid = expand.querySelector('video');
                if (vid) vid.pause();
            } else {
                window._currentAllenamentiEx = ex;
                populateExerciseExpand(expand.querySelector('.allenamenti-ex-expand-inner'), ex);
                expand.classList.add('open');
                row.classList.add('selected-ex');
            }
        });

        // Drag exercise into a workout
        row.draggable = true;
        row.addEventListener('dragstart', (e) => {
            row.classList.add('ex-dragging');
            e.dataTransfer.effectAllowed = 'copy';
            const payload = { type: 'exercise', id: ex.id, name: ex.name, video_id: ex.video_id || null };
            currentDragData = payload;
            try { e.dataTransfer.setData('text/plain', JSON.stringify(payload)); } catch(_) {}
        });
        row.addEventListener('dragend', () => {
            row.classList.remove('ex-dragging');
            document.querySelectorAll('.workout-drag-card.ex-drop-hover').forEach(el => el.classList.remove('ex-drop-hover'));
            if (currentDragData?.type === 'exercise') currentDragData = null;
        });

        item.appendChild(row);
        item.appendChild(expand);
        container.appendChild(item);
    });
}

function filterAllenamentiExercises() {
    const q = document.getElementById('allenamenti-ex-search')?.value.toLowerCase().trim() || '';
    const all = window._allenamentiExercises || [];
    const filtered = q ? all.filter(ex => (ex.name || '').toLowerCase().includes(q) || (ex.muscle || '').toLowerCase().includes(q)) : all;
    renderAllenamentiExerciseList(filtered);
}
window.filterAllenamentiExercises = filterAllenamentiExercises;

function populateExerciseExpand(innerEl, ex) {
    const mColor = _exMuscleColors[ex.muscle] || '#6366f1';
    const videoSrc = ex.video_url || (ex.video_id ? `/static/videos/${ex.video_id}.mp4` : null);
    const muscleOpts = Object.keys(_exMuscleColors).map(m =>
        `<option value="${m}"${m === ex.muscle ? ' selected' : ''}>${m}</option>`
    ).join('');

    // Build HTML using classes only (no inline onclick, no IDs)
    innerEl.innerHTML = `
        <div class="ex-view-pane">
            ${videoSrc
                ? `<div style="height:140px;border-radius:var(--radius-md);overflow:hidden;margin-bottom:0.55rem;"><video src="${videoSrc}" style="width:100%;height:100%;object-fit:cover;" controls preload="metadata"></video></div>`
                : ex.thumbnail_url
                ? `<div style="height:110px;border-radius:var(--radius-md);overflow:hidden;margin-bottom:0.55rem;"><img src="${ex.thumbnail_url}" style="width:100%;height:100%;object-fit:cover;" alt=""></div>`
                : ''}
            <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:0.5rem;margin-bottom:0.35rem;">
                <span class="ex-v-name" style="font-size:0.85rem;font-weight:700;color:rgba(255,255,255,0.92);line-height:1.3;"></span>
                <button class="ex-edit-btn" title="Modifica" style="flex-shrink:0;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:3px 8px;cursor:pointer;color:rgba(255,255,255,0.55);font-size:0.72rem;">✏</button>
            </div>
            <div style="display:flex;flex-wrap:wrap;gap:0.3rem;margin-bottom:0.4rem;">
                <span class="ex-v-muscle" style="font-size:0.65rem;padding:2px 7px;border-radius:20px;border:1px solid;font-weight:600;"></span>
                <span class="ex-v-diff" style="font-size:0.65rem;padding:2px 7px;border-radius:20px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:rgba(255,255,255,0.5);"></span>
                <span class="ex-v-type" style="font-size:0.65rem;padding:2px 7px;border-radius:20px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:rgba(255,255,255,0.5);"></span>
            </div>
            <p class="ex-v-desc" style="font-size:0.72rem;line-height:1.5;margin:0;"></p>
        </div>
        <div class="ex-edit-pane" style="display:none;">
            <div style="display:flex;flex-direction:column;gap:0.4rem;">
                <input class="ex-i-name" placeholder="Nome esercizio" style="width:100%;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:var(--radius-md);padding:5px 9px;color:rgba(255,255,255,0.9);font-size:0.78rem;box-sizing:border-box;">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem;">
                    <select class="ex-i-muscle" style="background:rgba(30,30,40,0.9);border:1px solid rgba(255,255,255,0.12);border-radius:var(--radius-md);padding:5px 9px;color:rgba(255,255,255,0.9);font-size:0.78rem;">${muscleOpts}</select>
                    <input class="ex-i-type" placeholder="Tipo (es. Course)" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:var(--radius-md);padding:5px 9px;color:rgba(255,255,255,0.9);font-size:0.78rem;">
                </div>
                <select class="ex-i-diff" style="background:rgba(30,30,40,0.9);border:1px solid rgba(255,255,255,0.12);border-radius:var(--radius-md);padding:5px 9px;color:rgba(255,255,255,0.9);font-size:0.78rem;">
                    <option value="beginner">Principiante</option>
                    <option value="intermediate">Intermedio</option>
                    <option value="advanced">Avanzato</option>
                </select>
                <textarea class="ex-i-desc" rows="2" placeholder="Descrizione" style="width:100%;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:var(--radius-md);padding:5px 9px;color:rgba(255,255,255,0.9);font-size:0.78rem;resize:none;box-sizing:border-box;"></textarea>
                <div style="display:flex;align-items:center;gap:0.5rem;">
                    <label style="display:inline-flex;align-items:center;gap:0.3rem;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:var(--radius-md);padding:4px 10px;cursor:pointer;font-size:0.72rem;color:rgba(255,255,255,0.6);flex-shrink:0;white-space:nowrap;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                        Carica video
                        <input type="file" class="ex-video-file" accept="video/mp4,video/quicktime,video/webm,video/x-msvideo" style="display:none;">
                    </label>
                    <span class="ex-video-pick-name" style="font-size:0.65rem;color:rgba(255,255,255,0.4);min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;"></span>
                </div>
                <div style="font-size:0.6rem;color:rgba(255,255,255,0.2);">Attuale: <span class="ex-v-video-lbl"></span></div>
                <div style="display:flex;gap:0.4rem;justify-content:flex-end;">
                    <button class="ex-cancel-btn" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:var(--radius-md);padding:5px 12px;color:rgba(255,255,255,0.6);font-size:0.75rem;cursor:pointer;">Annulla</button>
                    <button class="ex-save-btn" style="background:rgba(var(--primary-rgb),0.2);border:1px solid rgba(var(--primary-rgb),0.35);border-radius:var(--radius-md);padding:5px 12px;color:rgba(255,255,255,0.9);font-size:0.75rem;cursor:pointer;font-weight:600;">Salva</button>
                </div>
            </div>
        </div>
    `;

    // --- Populate view fields ---
    const viewPane  = innerEl.querySelector('.ex-view-pane');
    const editPane  = innerEl.querySelector('.ex-edit-pane');
    const nameEl    = innerEl.querySelector('.ex-v-name');
    const muscleEl  = innerEl.querySelector('.ex-v-muscle');
    const diffEl    = innerEl.querySelector('.ex-v-diff');
    const typeEl    = innerEl.querySelector('.ex-v-type');
    const descEl    = innerEl.querySelector('.ex-v-desc');

    nameEl.textContent = ex.name || '';
    muscleEl.textContent = ex.muscle || '';
    muscleEl.style.background = mColor + '22';
    muscleEl.style.color = mColor;
    muscleEl.style.borderColor = mColor + '44';
    diffEl.textContent = ex.difficulty || '';
    diffEl.style.display = ex.difficulty ? '' : 'none';
    typeEl.textContent = ex.type || '';
    typeEl.style.display = ex.type ? '' : 'none';
    if (ex.description) {
        descEl.textContent = ex.description;
        descEl.style.color = 'rgba(255,255,255,0.5)';
        descEl.style.fontStyle = '';
    } else {
        descEl.textContent = 'Nessuna descrizione disponibile.';
        descEl.style.color = 'rgba(255,255,255,0.18)';
        descEl.style.fontStyle = 'italic';
    }

    // --- Form field refs ---
    const inputName      = innerEl.querySelector('.ex-i-name');
    const selMuscle      = innerEl.querySelector('.ex-i-muscle');
    const inputType      = innerEl.querySelector('.ex-i-type');
    const selDiff        = innerEl.querySelector('.ex-i-diff');
    const textDesc       = innerEl.querySelector('.ex-i-desc');
    const videoLbl       = innerEl.querySelector('.ex-v-video-lbl');
    const videoFileInput = innerEl.querySelector('.ex-video-file');
    const videoPickName  = innerEl.querySelector('.ex-video-pick-name');
    const cancelBtn      = innerEl.querySelector('.ex-cancel-btn');
    const saveBtn        = innerEl.querySelector('.ex-save-btn');

    // Show selected filename next to the upload button
    videoFileInput.addEventListener('change', () => {
        const f = videoFileInput.files[0];
        videoPickName.textContent = f ? f.name : '';
    });

    // --- Enter edit mode ---
    innerEl.querySelector('.ex-edit-btn').addEventListener('click', () => {
        inputName.value  = ex.name || '';
        selMuscle.value  = ex.muscle || 'Chest';
        inputType.value  = ex.type || '';
        selDiff.value    = ex.difficulty || 'intermediate';
        textDesc.value   = ex.description || '';
        videoLbl.textContent = ex.video_url ? ex.video_url : (ex.video_id ? `${ex.video_id}.mp4` : 'Nessun video');
        videoPickName.textContent = '';
        videoFileInput.value = '';
        viewPane.style.display = 'none';
        editPane.style.display = '';
    });

    // --- Cancel ---
    cancelBtn.addEventListener('click', () => {
        editPane.style.display = 'none';
        viewPane.style.display = '';
    });

    // --- Save ---
    saveBtn.addEventListener('click', async () => {
        saveBtn.textContent   = 'Salvataggio...';
        saveBtn.style.opacity = '0.5';
        const updates = {
            name:        inputName.value.trim(),
            muscle:      selMuscle.value,
            type:        inputType.value.trim() || null,
            difficulty:  selDiff.value,
            description: textDesc.value.trim() || null,
        };
        try {
            const apiBase = (window.APP_CONFIG || {}).apiBase || '';
            // 1. Save metadata (may fork a global exercise → new ID)
            const res = await fetch(`${apiBase}/api/exercises/${ex.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(updates),
            });
            if (!res.ok) throw new Error('Salvataggio fallito');
            let updated = await res.json();

            // 2. Upload video if one was selected
            const videoFile = videoFileInput.files[0];
            if (videoFile) {
                saveBtn.textContent = 'Caricamento video...';
                const fd = new FormData();
                fd.append('file', videoFile);
                const vRes = await fetch(`${apiBase}/api/exercises/${updated.id}/video`, {
                    method: 'POST',
                    credentials: 'include',
                    body: fd,
                });
                if (!vRes.ok) throw new Error('Caricamento video fallito');
                updated = await vRes.json();
            }

            if (window._allenamentiExercises) {
                const idx = window._allenamentiExercises.findIndex(e => e.id === ex.id || e.name === ex.name);
                if (idx >= 0) window._allenamentiExercises[idx] = updated;
            }
            window._currentAllenamentiEx = updated;
            populateExerciseExpand(innerEl, updated);
            if (typeof showToast === 'function') showToast('Esercizio aggiornato', 'success');
        } catch(err) {
            saveBtn.textContent   = 'Salva';
            saveBtn.style.opacity = '';
            if (typeof showToast === 'function') showToast(err.message || 'Errore nel salvataggio', 'error');
        }
    });
}
window.populateExerciseExpand = populateExerciseExpand;

function hideAllenamentiExDetail() {
    document.querySelectorAll('.allenamenti-ex-expand.open').forEach(e => {
        e.classList.remove('open');
        const vid = e.querySelector('video');
        if (vid) vid.pause();
    });
    document.querySelectorAll('.allenamenti-ex-row.selected-ex').forEach(r => r.classList.remove('selected-ex'));
}
window.hideAllenamentiExDetail = hideAllenamentiExDetail;

function _populateWorkoutExpand(el, w) {
    const exercises = (Array.isArray(w.exercises) ? w.exercises : []).filter(ex => ex && ex.name);
    el._addExercise = null; // Clear any edit-mode callback

    let html = `<div style="display:flex;align-items:center;justify-content:space-between;padding:0.3rem 0.65rem 0.1rem;">
        <span style="font-size:0.7rem;color:rgba(255,255,255,0.3);">${exercises.length === 0 ? 'Nessun esercizio' : exercises.length + ' esercizi'}</span>
        <button class="workout-edit-btn" style="font-size:0.7rem;padding:0.18rem 0.55rem;border-radius:4px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);color:rgba(255,255,255,0.6);cursor:pointer;">Modifica</button>
    </div>`;

    if (exercises.length === 0) {
        html += '<p style="margin:0;padding:0.25rem 0.65rem 0.5rem;font-size:0.72rem;color:rgba(255,255,255,0.25);font-style:italic;">Clicca Modifica per aggiungere esercizi</p>';
    } else {
        exercises.forEach(ex => {
            const setsReps = (ex.sets && ex.reps) ? `${ex.sets}×${ex.reps}` : '';
            const rest = ex.rest ? `${ex.rest}s` : '';
            const exLib = (window._allenamentiExercises || []).find(e => e.name === ex.name);
            const muscle = exLib?.muscle || exLib?.muscle_group || '';
            const mColor = (typeof _exMuscleColors !== 'undefined' && muscle) ? (_exMuscleColors[muscle] || 'var(--primary)') : 'var(--primary)';
            html += `<div style="display:flex;align-items:center;gap:0.5rem;padding:0.32rem 0.65rem;border-bottom:1px solid rgba(255,255,255,0.04);">
                <div style="width:3px;height:${muscle ? '36px' : '14px'};background:${mColor};border-radius:2px;flex-shrink:0;opacity:0.75;"></div>
                <div style="flex:1;min-width:0;">
                    <div style="font-size:0.82rem;font-weight:600;color:rgba(255,255,255,0.9);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${ex.name}</div>
                    ${muscle ? `<div style="font-size:0.68rem;color:rgba(255,255,255,0.3);">${muscle}</div>` : ''}
                </div>
                <div style="text-align:right;flex-shrink:0;">
                    ${setsReps ? `<div style="font-size:0.78rem;color:rgba(255,255,255,0.65);font-weight:500;">${setsReps}</div>` : ''}
                    ${rest ? `<div style="font-size:0.68rem;color:rgba(255,255,255,0.3);">${rest} riposo</div>` : ''}
                </div>
            </div>`;
        });
    }

    el.innerHTML = html;
    el.querySelector('.workout-edit-btn')?.addEventListener('click', (e) => {
        e.stopPropagation();
        _showWorkoutEditForm(el, w);
    });
}

function _showWorkoutEditForm(el, w) {
    const apiBase = (window.APP_CONFIG || {}).apiBase || '';
    let exercises = (Array.isArray(w.exercises) ? w.exercises : []).filter(ex => ex && ex.name).map(ex => ({ ...ex }));

    function syncInputs() {
        el.querySelectorAll('.w-ex-row').forEach((row, i) => {
            if (exercises[i]) {
                exercises[i].sets = parseInt(row.querySelector('.ex-sets')?.value) || 3;
                exercises[i].reps = row.querySelector('.ex-reps')?.value?.trim() || '10';
                exercises[i].rest = parseInt(row.querySelector('.ex-rest')?.value) || 60;
            }
        });
    }

    function renderList() {
        const listEl = el.querySelector('.w-edit-list');
        if (!listEl) return;
        if (exercises.length === 0) {
            listEl.innerHTML = '<p style="margin:0;padding:0.3rem 0.65rem;font-size:0.72rem;color:rgba(255,255,255,0.25);font-style:italic;">Nessun esercizio — trascina qui sotto</p>';
        } else {
            listEl.innerHTML = exercises.map((ex, i) => {
                const exLib = (window._allenamentiExercises || []).find(e => e.name === ex.name);
                const muscle = exLib?.muscle || '';
                const mColor = (typeof _exMuscleColors !== 'undefined' && muscle) ? (_exMuscleColors[muscle] || '#6366f1') : '#6366f1';
                return `<div class="w-ex-row" data-idx="${i}" style="display:flex;align-items:center;gap:0.4rem;padding:0.28rem 0.65rem;border-bottom:1px solid rgba(255,255,255,0.05);">
                    <div style="width:3px;height:32px;background:${mColor};border-radius:2px;flex-shrink:0;opacity:0.7;"></div>
                    <span style="flex:1;font-size:0.8rem;color:rgba(255,255,255,0.85);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0;">${ex.name}</span>
                    <input type="number" class="ex-sets" value="${ex.sets || 3}" min="1" max="99" style="width:34px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);border-radius:3px;color:white;font-size:0.72rem;text-align:center;padding:0.1rem 0;" title="Serie">
                    <span style="font-size:0.65rem;color:rgba(255,255,255,0.25);">×</span>
                    <input type="text" class="ex-reps" value="${ex.reps || '10'}" style="width:36px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);border-radius:3px;color:white;font-size:0.72rem;text-align:center;padding:0.1rem 0;" title="Ripetizioni">
                    <input type="number" class="ex-rest" value="${ex.rest || 60}" min="0" max="600" style="width:38px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);border-radius:3px;color:white;font-size:0.72rem;text-align:center;padding:0.1rem 0;" title="Riposo (s)">
                    <span style="font-size:0.62rem;color:rgba(255,255,255,0.25);">s</span>
                    <button class="ex-del-btn" data-idx="${i}" style="background:none;border:none;color:rgba(255,80,80,0.5);cursor:pointer;font-size:1.1rem;padding:0 0.15rem;line-height:1;" title="Rimuovi">×</button>
                </div>`;
            }).join('');
            listEl.querySelectorAll('.ex-del-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    syncInputs();
                    exercises.splice(parseInt(btn.dataset.idx), 1);
                    renderList();
                });
            });
        }
    }

    el.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;padding:0.3rem 0.65rem;border-bottom:1px solid rgba(255,255,255,0.07);">
            <span style="font-size:0.72rem;color:rgba(255,255,255,0.45);font-weight:600;">Modifica esercizi</span>
            <div style="display:flex;gap:0.35rem;">
                <button class="w-save-btn" style="font-size:0.7rem;padding:0.2rem 0.65rem;border-radius:4px;background:var(--primary);border:none;color:white;cursor:pointer;font-weight:600;">Salva</button>
                <button class="w-cancel-btn" style="font-size:0.7rem;padding:0.2rem 0.5rem;border-radius:4px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:rgba(255,255,255,0.5);cursor:pointer;">Annulla</button>
            </div>
        </div>
        <div class="w-edit-list"></div>
        <div class="w-drop-zone" style="margin:0.4rem 0.65rem 0.5rem;padding:0.55rem;border:1.5px dashed rgba(255,255,255,0.13);border-radius:6px;text-align:center;font-size:0.72rem;color:rgba(255,255,255,0.28);transition:all 0.18s;">
            ＋ &nbsp;Trascina un esercizio qui per aggiungerlo
        </div>`;

    renderList();

    // Edit-mode callback — external drop handlers call this
    el._addExercise = (dd) => {
        syncInputs();
        exercises.push({ name: dd.name, sets: 3, reps: '10', rest: 60, video_id: dd.video_id || null });
        renderList();
    };

    // Drop zone
    const dz = el.querySelector('.w-drop-zone');
    dz.addEventListener('dragover', (e) => {
        if (currentDragData?.type !== 'exercise') return;
        e.preventDefault(); e.stopPropagation();
        dz.style.borderColor = 'rgba(99,102,241,0.6)';
        dz.style.background = 'rgba(99,102,241,0.08)';
        dz.style.color = 'rgba(255,255,255,0.7)';
    });
    dz.addEventListener('dragleave', (e) => {
        if (!dz.contains(e.relatedTarget)) {
            dz.style.borderColor = 'rgba(255,255,255,0.13)';
            dz.style.background = '';
            dz.style.color = 'rgba(255,255,255,0.28)';
        }
    });
    dz.addEventListener('drop', (e) => {
        e.preventDefault(); e.stopPropagation();
        dz.style.borderColor = 'rgba(255,255,255,0.13)'; dz.style.background = ''; dz.style.color = 'rgba(255,255,255,0.28)';
        let dd = null;
        try { const p = JSON.parse(e.dataTransfer.getData('text/plain')); if (p?.type === 'exercise' && p.name) dd = p; } catch(_) {}
        if (!dd && currentDragData?.type === 'exercise' && currentDragData.name) dd = currentDragData;
        if (!dd) return;
        el._addExercise(dd);
        currentDragData = null;
    });

    // Save
    el.querySelector('.w-save-btn').addEventListener('click', async (e) => {
        e.stopPropagation();
        syncInputs();
        const btn = el.querySelector('.w-save-btn');
        btn.textContent = '...'; btn.disabled = true;
        try {
            const res = await fetch(`${apiBase}/api/trainer/workouts/${w.id}`, {
                method: 'PUT', headers: { 'Content-Type': 'application/json' }, credentials: 'include',
                body: JSON.stringify({ title: w.title || '', duration: w.duration || '', difficulty: w.difficulty || '', exercises })
            });
            if (!res.ok) { const err = await res.json().catch(() => ({})); throw new Error(err.detail || 'Errore'); }
            const updated = await res.json();
            w.exercises = updated.exercises;
            if (window.trainerData?.workouts) {
                const idx = window.trainerData.workouts.findIndex(ww => ww.id === w.id);
                if (idx >= 0) window.trainerData.workouts[idx] = updated;
            }
            if (el._cardTr) {
                const exCount = (updated.exercises || []).filter(ex => ex.name).length;
                const meta = [updated.duration, updated.difficulty, exCount > 0 ? `${exCount} es.` : null].filter(Boolean).join(' · ');
                const metaEl = el._cardTr.querySelector('.workout-card-meta');
                if (metaEl) metaEl.textContent = meta;
            }
            _populateWorkoutExpand(el, updated);
            if (typeof showToast === 'function') showToast('Allenamento salvato', 'success');
        } catch (err) {
            btn.textContent = 'Salva'; btn.disabled = false;
            if (typeof showToast === 'function') showToast(err.message || 'Errore', 'error');
        }
    });

    el.querySelector('.w-cancel-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        _populateWorkoutExpand(el, w);
    });
}

function renderWorkoutDragList(workouts) {
    const tbody = document.getElementById('workouts-drag-list');
    if (!tbody) return;
    tbody.innerHTML = '';

    if (workouts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align:center;padding:2rem;color:rgba(255,255,255,0.3);font-size:0.85rem;">Nessun allenamento creato</td></tr>';
        return;
    }

    workouts.forEach(w => {
        const tr = document.createElement('tr');
        tr.className = 'workout-drag-card';
        tr.draggable = true;
        tr.dataset.type = 'workout';
        tr.dataset.itemId = w.id;
        tr.dataset.itemName = w.title || 'Workout';

        const exCount = Array.isArray(w.exercises) ? w.exercises.length : 0;
        const meta = [w.duration, w.difficulty, exCount > 0 ? `${exCount} es.` : null].filter(Boolean).join(' · ');

        tr.innerHTML = `
            <td style="width:40px;"><input type="checkbox" style="opacity:0.3;" onclick="event.stopPropagation();"></td>
            <td>
                <div style="display:flex;align-items:center;gap:0.75rem;">
                    <i data-lucide="grip-vertical" class="w-4 h-4" style="color:rgba(255,255,255,0.2);flex-shrink:0;"></i>
                    <div style="flex:1;min-width:0;">
                        <div style="font-weight:600;color:white;font-size:0.85rem;">${w.title || 'Senza titolo'}</div>
                        <div class="workout-card-meta" style="font-size:0.75rem;color:rgba(255,255,255,0.4);">${meta}</div>
                    </div>
                    <svg class="workout-card-chevron" xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="rgba(255,255,255,0.2)" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
                </div>
            </td>
        `;

        // Expand row (inline exercise list)
        const expandTr = document.createElement('tr');
        expandTr.className = 'workout-expand-tr';
        const expandTd = document.createElement('td');
        expandTd.colSpan = 2;
        expandTd.style.padding = '0';
        const expandInner = document.createElement('div');
        expandInner.className = 'workout-expand-inner';
        expandInner._cardTr = tr;
        _populateWorkoutExpand(expandInner, w);
        expandTd.appendChild(expandInner);
        expandTr.appendChild(expandTd);

        // Click: toggle expand
        tr.addEventListener('click', (e) => {
            if (e.target.tagName === 'INPUT') return;
            const isOpen = expandInner.classList.contains('open');
            document.querySelectorAll('.workout-expand-inner.open').forEach(el => {
                if (el !== expandInner) {
                    el.classList.remove('open');
                    el.closest('tr')?.previousElementSibling?.querySelector('.workout-card-chevron')?.style.setProperty('transform', '');
                }
            });
            expandInner.classList.toggle('open', !isOpen);
            tr.querySelector('.workout-card-chevron').style.transform = isOpen ? '' : 'rotate(180deg)';
        });

        // Drag workout → client
        tr.addEventListener('dragstart', handleDragStart);
        tr.addEventListener('dragend', handleDragEnd);

        // Drop exercise → this workout
        tr.addEventListener('dragover', (e) => {
            if (currentDragData?.type !== 'exercise') return;
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        });
        tr.addEventListener('dragenter', (e) => {
            if (currentDragData?.type !== 'exercise') return;
            e.preventDefault();
            tr.classList.add('ex-drop-hover');
        });
        tr.addEventListener('dragleave', (e) => {
            if (!tr.contains(e.relatedTarget)) tr.classList.remove('ex-drop-hover');
        });
        tr.addEventListener('drop', (e) => {
            tr.classList.remove('ex-drop-hover');
            let dd = null;
            try { const p = JSON.parse(e.dataTransfer.getData('text/plain')); if (p?.type === 'exercise' && p.name) dd = p; } catch(_) {}
            if (!dd && currentDragData?.type === 'exercise' && currentDragData.name) dd = currentDragData;
            if (!dd) return;
            e.preventDefault();
            if (!expandInner.classList.contains('open')) {
                expandInner.classList.add('open');
                tr.querySelector('.workout-card-chevron').style.transform = 'rotate(180deg)';
            }
            if (expandInner._addExercise) {
                expandInner._addExercise(dd); // Edit mode — add to form, don't auto-save
            } else {
                addExerciseToWorkout(w, dd, expandInner, tr); // View mode — auto-save
            }
            currentDragData = null;
        });

        // Also make expandTr a drop target (user may drop onto the open exercise list)
        expandTr.addEventListener('dragover', (e) => {
            if (currentDragData?.type !== 'exercise') return;
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            tr.classList.add('ex-drop-hover');
        });
        expandTr.addEventListener('dragleave', (e) => {
            if (!tr.contains(e.relatedTarget) && !expandTr.contains(e.relatedTarget)) {
                tr.classList.remove('ex-drop-hover');
            }
        });
        expandTr.addEventListener('drop', (e) => {
            tr.classList.remove('ex-drop-hover');
            let dd = null;
            try { const p = JSON.parse(e.dataTransfer.getData('text/plain')); if (p?.type === 'exercise' && p.name) dd = p; } catch(_) {}
            if (!dd && currentDragData?.type === 'exercise' && currentDragData.name) dd = currentDragData;
            if (!dd) return;
            e.preventDefault();
            if (expandInner._addExercise) {
                expandInner._addExercise(dd);
            } else {
                addExerciseToWorkout(w, dd, expandInner, tr);
            }
            currentDragData = null;
        });

        tbody.appendChild(tr);
        tbody.appendChild(expandTr);
    });

    if (window.lucide) lucide.createIcons();
}

function _populateSplitExpand(el, s) {
    const schedule = (s.schedule && typeof s.schedule === 'object') ? s.schedule : {};
    const workoutMap = {};
    (window.trainerData?.workouts || []).forEach(ww => { workoutMap[ww.id] = ww.title; });
    const scheduleEntries = Object.entries(schedule).sort((a, b) => parseInt(a[0]) - parseInt(b[0]));

    let html = `<div style="display:flex;align-items:center;justify-content:space-between;padding:0.35rem 0.65rem 0.15rem;">
        <span style="font-size:0.72rem;color:rgba(255,255,255,0.4);">${s.description || ''}</span>
        <button class="split-edit-btn" style="font-size:0.7rem;padding:0.18rem 0.55rem;border-radius:4px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);color:rgba(255,255,255,0.6);cursor:pointer;">Modifica</button>
    </div>`;

    if (scheduleEntries.length > 0) {
        scheduleEntries.forEach(([dayNum, workoutId]) => {
            const workoutName = workoutMap[workoutId] || workoutId || 'Riposo';
            html += `<div style="display:flex;align-items:center;gap:0.5rem;padding:0.3rem 0.65rem;border-bottom:1px solid rgba(255,255,255,0.04);">
                <div style="width:3px;height:14px;background:var(--primary);border-radius:2px;flex-shrink:0;"></div>
                <span style="font-size:0.72rem;color:rgba(255,255,255,0.4);width:52px;flex-shrink:0;">Giorno ${dayNum}</span>
                <span style="flex:1;font-size:0.8rem;color:rgba(255,255,255,0.85);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${workoutName}</span>
            </div>`;
        });
    } else if (s.days_per_week) {
        for (let d = 1; d <= s.days_per_week; d++) {
            html += `<div style="display:flex;align-items:center;gap:0.5rem;padding:0.3rem 0.65rem;border-bottom:1px solid rgba(255,255,255,0.04);">
                <div style="width:3px;height:14px;background:rgba(255,255,255,0.1);border-radius:2px;flex-shrink:0;"></div>
                <span style="font-size:0.72rem;color:rgba(255,255,255,0.4);width:52px;flex-shrink:0;">Giorno ${d}</span>
                <span style="flex:1;font-size:0.8rem;color:rgba(255,255,255,0.3);font-style:italic;">Non assegnato</span>
            </div>`;
        }
    } else {
        html += '<p style="margin:0;padding:0.5rem 0.65rem;font-size:0.75rem;color:rgba(255,255,255,0.3);font-style:italic;">Nessun programma configurato</p>';
    }

    el.innerHTML = html;
    el.querySelector('.split-edit-btn').addEventListener('click', (evt) => {
        evt.stopPropagation();
        _showSplitEditForm(el, s);
    });
}

function _showSplitEditForm(el, s) {
    const workoutList = window.trainerData?.workouts || [];
    const schedule = (s.schedule && typeof s.schedule === 'object') ? s.schedule : {};
    const daysCount = s.days_per_week || Object.keys(schedule).length || 3;
    const apiBase = (window.APP_CONFIG || {}).apiBase || '';

    let dayRows = '';
    for (let d = 1; d <= daysCount; d++) {
        const assignedId = schedule[d] || schedule[String(d)] || '';
        const opts = workoutList.map(w =>
            `<option value="${w.id}" ${w.id === assignedId ? 'selected' : ''}>${w.title || 'Senza titolo'}</option>`
        ).join('');
        dayRows += `<div style="display:flex;align-items:center;gap:0.5rem;padding:0.25rem 0;border-bottom:1px solid rgba(255,255,255,0.05);">
            <span style="font-size:0.72rem;color:rgba(255,255,255,0.4);width:52px;flex-shrink:0;">Giorno ${d}</span>
            <select data-day="${d}" style="flex:1;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);border-radius:4px;color:rgba(255,255,255,0.8);font-size:0.78rem;padding:0.2rem 0.4rem;cursor:pointer;">
                <option value="">— Riposo —</option>${opts}
            </select>
        </div>`;
    }

    el.innerHTML = `<div style="padding:0.5rem 0.65rem;">
        <div style="display:flex;gap:0.5rem;margin-bottom:0.4rem;">
            <div style="flex:1;">
                <label style="font-size:0.68rem;color:rgba(255,255,255,0.4);display:block;margin-bottom:0.15rem;">Nome</label>
                <input class="s-name" value="${s.name || ''}" style="width:100%;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);border-radius:4px;color:white;font-size:0.8rem;padding:0.25rem 0.4rem;">
            </div>
            <div style="flex:1;">
                <label style="font-size:0.68rem;color:rgba(255,255,255,0.4);display:block;margin-bottom:0.15rem;">Descrizione</label>
                <input class="s-desc" value="${s.description || ''}" style="width:100%;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);border-radius:4px;color:white;font-size:0.8rem;padding:0.25rem 0.4rem;">
            </div>
        </div>
        <div style="margin-bottom:0.4rem;">${dayRows}</div>
        <div style="display:flex;gap:0.4rem;margin-top:0.3rem;">
            <button class="s-save-btn" style="flex:1;padding:0.3rem 0;border-radius:5px;background:var(--primary);border:none;color:white;font-size:0.78rem;font-weight:600;cursor:pointer;">Salva</button>
            <button class="s-cancel-btn" style="padding:0.3rem 0.7rem;border-radius:5px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);color:rgba(255,255,255,0.6);font-size:0.78rem;cursor:pointer;">Annulla</button>
        </div>
    </div>`;

    el.querySelector('.s-save-btn').addEventListener('click', async (evt) => {
        evt.stopPropagation();
        const name = el.querySelector('.s-name').value.trim();
        if (!name) { if (typeof showToast === 'function') showToast('Nome obbligatorio', 'error'); return; }
        const newSchedule = {};
        el.querySelectorAll('select[data-day]').forEach(sel => {
            if (sel.value) newSchedule[sel.dataset.day] = sel.value;
        });
        const body = { name, description: el.querySelector('.s-desc').value.trim(), days_per_week: daysCount, schedule: newSchedule };
        try {
            const res = await fetch(`${apiBase}/api/trainer/splits/${s.id}`, {
                method: 'PUT', headers: { 'Content-Type': 'application/json' }, credentials: 'include',
                body: JSON.stringify(body)
            });
            if (!res.ok) { const err = await res.json().catch(() => ({})); throw new Error(err.detail || 'Errore'); }
            const updated = await res.json();
            Object.assign(s, updated);
            if (window.trainerData?.splits) {
                const idx = window.trainerData.splits.findIndex(sp => sp.id === s.id);
                if (idx >= 0) Object.assign(window.trainerData.splits[idx], updated);
            }
            _populateSplitExpand(el, s);
            if (typeof showToast === 'function') showToast('Split aggiornato', 'success');
        } catch (err) {
            if (typeof showToast === 'function') showToast(err.message || 'Errore', 'error');
        }
    });

    el.querySelector('.s-cancel-btn').addEventListener('click', (evt) => {
        evt.stopPropagation();
        _populateSplitExpand(el, s);
    });
}

function renderSplitDragList(splits) {
    const tbody = document.getElementById('splits-drag-list');
    if (!tbody) return;
    tbody.innerHTML = '';

    if (splits.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align:center;padding:2rem;color:rgba(255,255,255,0.3);font-size:0.85rem;">Nessun split creato</td></tr>';
        return;
    }

    splits.forEach(s => {
        const tr = document.createElement('tr');
        tr.className = 'workout-drag-card';
        tr.draggable = true;
        tr.dataset.type = 'split';
        tr.dataset.itemId = s.id;
        tr.dataset.itemName = s.name || 'Split';

        const dayCount = Array.isArray(s.days) ? s.days.length : (s.days_per_week || 0);
        const meta = [s.description, dayCount > 0 ? `${dayCount} giorni` : null].filter(Boolean).join(' · ');

        tr.innerHTML = `
            <td style="width:40px;"><input type="checkbox" style="opacity:0.3;" onclick="event.stopPropagation();"></td>
            <td>
                <div style="display:flex;align-items:center;gap:0.75rem;">
                    <i data-lucide="grip-vertical" class="w-4 h-4" style="color:rgba(255,255,255,0.2);flex-shrink:0;"></i>
                    <div style="flex:1;min-width:0;">
                        <div style="font-weight:600;color:white;font-size:0.85rem;">${s.name || 'Senza titolo'}</div>
                        <div style="font-size:0.75rem;color:rgba(255,255,255,0.4);">${meta || 'Split settimanale'}</div>
                    </div>
                    <svg class="workout-card-chevron" xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="rgba(255,255,255,0.2)" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
                </div>
            </td>
        `;

        // Expand row (split detail)
        const expandTr = document.createElement('tr');
        expandTr.className = 'workout-expand-tr';
        const expandTd = document.createElement('td');
        expandTd.colSpan = 2;
        expandTd.style.padding = '0';
        const expandInner = document.createElement('div');
        expandInner.className = 'workout-expand-inner';
        _populateSplitExpand(expandInner, s);
        expandTd.appendChild(expandInner);
        expandTr.appendChild(expandTd);

        // Click: toggle expand
        tr.addEventListener('click', (e) => {
            if (e.target.tagName === 'INPUT') return;
            const isOpen = expandInner.classList.contains('open');
            // Close other open split expands
            document.querySelectorAll('#splits-drag-list .workout-expand-inner.open').forEach(el => {
                if (el !== expandInner) {
                    el.classList.remove('open');
                    el.closest('tr')?.previousElementSibling?.querySelector('.workout-card-chevron')?.style.setProperty('transform', '');
                }
            });
            expandInner.classList.toggle('open', !isOpen);
            tr.querySelector('.workout-card-chevron').style.transform = isOpen ? '' : 'rotate(180deg)';
            // Also handle click-to-select for assignment
            if (!isOpen) selectWorkoutItem(tr);
        });

        tr.addEventListener('dragstart', handleDragStart);
        tr.addEventListener('dragend', handleDragEnd);

        tbody.appendChild(tr);
        tbody.appendChild(expandTr);
    });

    if (window.lucide) lucide.createIcons();
}

// Click-to-select: highlight selected workout/split, then click client to assign
function selectWorkoutItem(el) {
    // Deselect previous
    document.querySelectorAll('.workout-drag-card.selected').forEach(r => r.classList.remove('selected'));
    // Select this one
    el.classList.add('selected');
    selectedWorkoutItem = {
        type: el.dataset.type,
        id: el.dataset.itemId,
        name: el.dataset.itemName
    };
    console.log('[Select]', selectedWorkoutItem);
}

function renderClientDropTargets(clients) {
    const container = document.getElementById('workouts-client-list');
    if (!container) return;
    container.innerHTML = '';

    if (clients.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:2rem;color:rgba(255,255,255,0.3);font-size:0.85rem;">Nessun cliente trovato</div>';
        return;
    }

    clients.forEach(c => {
        const div = document.createElement('div');
        div.className = 'client-drop-target';
        div.dataset.clientId = c.id;
        div.dataset.clientName = c.name;

        const avatarUrl = c.profile_picture || `https://api.dicebear.com/7.x/avataaars/svg?seed=${c.name}`;
        const initials = c.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);

        let expiryDisplay = null;
        if (c.plan_expiry) {
            try {
                const d = new Date(c.plan_expiry);
                expiryDisplay = d.toLocaleDateString('it-IT', { day: '2-digit', month: 'short' });
            } catch(e) { expiryDisplay = c.plan_expiry; }
        }

        // Assignment badge
        let assignBadge = '';
        if (c.assigned_split) {
            const expText = expiryDisplay ? ` · scade ${expiryDisplay}` : '';
            assignBadge = `<span style="display:inline-flex;align-items:center;gap:0.3rem;background:rgba(99,102,241,0.15);border:1px solid rgba(99,102,241,0.3);color:#a5b4fc;font-size:0.65rem;font-weight:600;padding:0.15rem 0.5rem;border-radius:9999px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px;" title="${c.assigned_split}${expText}">&#9632; ${c.assigned_split}${expText}</span>`;
        } else if (c.upcoming_workouts > 0) {
            assignBadge = `<span style="display:inline-flex;align-items:center;gap:0.3rem;background:rgba(34,197,94,0.12);border:1px solid rgba(34,197,94,0.25);color:#86efac;font-size:0.65rem;font-weight:600;padding:0.15rem 0.5rem;border-radius:9999px;">&#9632; ${c.upcoming_workouts} allenament${c.upcoming_workouts === 1 ? 'o' : 'i'}</span>`;
        } else {
            assignBadge = `<span style="font-size:0.7rem;color:rgba(255,255,255,0.25);font-style:italic;">Nessun programma</span>`;
        }

        div.innerHTML = `
            <div style="display:flex;align-items:center;gap:0.75rem;flex:1;min-width:0;">
                <div class="member-avatar" style="width:32px;height:32px;overflow:hidden;flex-shrink:0;">
                    <img src="${avatarUrl}" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none';this.parentElement.textContent='${initials}';">
                </div>
                <div style="min-width:0;flex:1;">
                    <div style="font-weight:600;color:white;font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${c.name}</div>
                    <div style="margin-top:0.2rem;">${assignBadge}</div>
                </div>
            </div>
        `;

        // Drop target handlers (drag-and-drop)
        div.addEventListener('dragover', handleDragOver);
        div.addEventListener('dragenter', handleDragEnter);
        div.addEventListener('dragleave', handleDragLeave);
        div.addEventListener('drop', handleDrop);

        // Click handler: open client modal if no workout selected, otherwise assign
        div.addEventListener('click', function() {
            if (selectedWorkoutItem) {
                const cId = this.dataset.clientId;
                const cName = this.dataset.clientName;
                openAssignModal(selectedWorkoutItem.type, selectedWorkoutItem.id, selectedWorkoutItem.name, cId, cName);
            } else {
                showClientModal(c.name, c.plan, c.status, c.id, c.is_premium);
            }
        });

        container.appendChild(div);
    });

    // Sync exercise column height to match clients column
    requestAnimationFrame(() => {
        const clientsCol = container.closest('.allenamenti-column');
        const exCol = document.getElementById('allenamenti-ex-column');
        if (!clientsCol || !exCol) return;
        const h = clientsCol.getBoundingClientRect().height;
        if (h > 0) exCol.style.height = h + 'px';
    });
}

// ============ TAB SWITCHING ============

function switchWorkoutTab(tabId) {
    document.querySelectorAll('.trainer-tab-content').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('.trainer-tab').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.remove('hidden');
    const tabBtn = document.querySelector(`.trainer-tab[data-tab="${tabId}"]`);
    if (tabBtn) tabBtn.classList.add('active');

    // Re-apply search filter for the new tab
    const workoutSearch = document.getElementById('workouts-search');
    if (workoutSearch && workoutSearch.value.trim()) {
        workoutSearch.dispatchEvent(new Event('input'));
    }
}
window.switchWorkoutTab = switchWorkoutTab;

// ============ CREATE SPLIT INLINE ============

function _toggleCreateSplitForm() {
    const container = document.getElementById('create-split-form-container');
    if (!container) return;
    if (container.hasChildNodes()) { container.innerHTML = ''; return; }
    _renderCreateSplitForm(container);
}

function _renderCreateSplitForm(container, daysCount) {
    daysCount = daysCount || 5;
    const workoutList = window.trainerData?.workouts || [];
    const apiBase = (window.APP_CONFIG || {}).apiBase || '';

    let dayRows = '';
    for (let d = 1; d <= daysCount; d++) {
        const opts = workoutList.map(w =>
            `<option value="${w.id}">${w.title || 'Senza titolo'}</option>`
        ).join('');
        dayRows += `<div style="display:flex;align-items:center;gap:0.5rem;padding:0.25rem 0;border-bottom:1px solid rgba(255,255,255,0.05);">
            <span style="font-size:0.72rem;color:rgba(255,255,255,0.4);width:52px;flex-shrink:0;">Giorno ${d}</span>
            <select data-day="${d}" style="flex:1;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);border-radius:4px;color:rgba(255,255,255,0.8);font-size:0.78rem;padding:0.2rem 0.4rem;cursor:pointer;">
                <option value="">— Riposo —</option>${opts}
            </select>
        </div>`;
    }

    container.innerHTML = `<div style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:0.65rem;margin-bottom:0.65rem;">
        <div style="display:flex;gap:0.5rem;margin-bottom:0.4rem;">
            <div style="flex:1;">
                <label style="font-size:0.68rem;color:rgba(255,255,255,0.4);display:block;margin-bottom:0.15rem;">Nome</label>
                <input id="cs-name" placeholder="Es. Push/Pull/Legs" style="width:100%;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);border-radius:4px;color:white;font-size:0.8rem;padding:0.25rem 0.4rem;">
            </div>
            <div style="flex:1;">
                <label style="font-size:0.68rem;color:rgba(255,255,255,0.4);display:block;margin-bottom:0.15rem;">Descrizione</label>
                <input id="cs-desc" placeholder="Opzionale" style="width:100%;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);border-radius:4px;color:white;font-size:0.8rem;padding:0.25rem 0.4rem;">
            </div>
        </div>
        <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;">
            <label style="font-size:0.68rem;color:rgba(255,255,255,0.4);">Giorni/settimana:</label>
            <input id="cs-days" type="number" min="1" max="7" value="${daysCount}" style="width:48px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);border-radius:4px;color:white;font-size:0.8rem;padding:0.2rem 0.4rem;text-align:center;">
        </div>
        <div id="cs-day-rows" style="margin-bottom:0.5rem;">${dayRows}</div>
        <div style="display:flex;gap:0.4rem;">
            <button id="cs-save-btn" style="flex:1;padding:0.3rem 0;border-radius:5px;background:var(--primary);border:none;color:white;font-size:0.78rem;font-weight:600;cursor:pointer;">Crea split</button>
            <button onclick="document.getElementById('create-split-form-container').innerHTML=''" style="padding:0.3rem 0.7rem;border-radius:5px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);color:rgba(255,255,255,0.6);font-size:0.78rem;cursor:pointer;">Annulla</button>
        </div>
    </div>`;

    // Re-render day rows when days count changes
    container.querySelector('#cs-days').addEventListener('change', function() {
        const newCount = Math.max(1, Math.min(7, parseInt(this.value) || 5));
        this.value = newCount;
        _renderCreateSplitForm(container, newCount);
    });

    container.querySelector('#cs-save-btn').addEventListener('click', async () => {
        const name = container.querySelector('#cs-name').value.trim();
        if (!name) { if (typeof showToast === 'function') showToast('Nome obbligatorio', 'error'); return; }
        const desc = container.querySelector('#cs-desc').value.trim();
        const days = parseInt(container.querySelector('#cs-days').value) || daysCount;
        const schedule = {};
        container.querySelectorAll('select[data-day]').forEach(sel => {
            if (sel.value) schedule[sel.dataset.day] = sel.value;
        });

        try {
            const res = await fetch(`${apiBase}/api/trainer/splits`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ name, description: desc, days_per_week: days, schedule })
            });
            if (!res.ok) { const err = await res.json().catch(() => ({})); throw new Error(err.detail || 'Errore'); }
            const created = await res.json();
            if (window.trainerData) {
                window.trainerData.splits = window.trainerData.splits || [];
                window.trainerData.splits.push(created);
                renderSplitDragList(window.trainerData.splits);
            }
            container.innerHTML = '';
            if (typeof showToast === 'function') showToast('Split creato!', 'success');
        } catch(err) {
            if (typeof showToast === 'function') showToast('Errore: ' + err.message, 'error');
        }
    });
}

// ============ DRAG AND DROP ============

// Store drag data in a variable as fallback (Safari sometimes loses dataTransfer)
let currentDragData = null;

function handleDragStart(e) {
    console.log('[DragStart]', this.dataset);
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    const data = {
        type: this.dataset.type,
        id: this.dataset.itemId,
        name: this.dataset.itemName
    };
    currentDragData = data;
    try {
        e.dataTransfer.setData('text/plain', JSON.stringify(data));
    } catch(err) {
        console.warn('[DragStart] setData failed:', err);
    }
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
    // Clean up any leftover highlights
    document.querySelectorAll('.client-drop-target.drag-over').forEach(el => el.classList.remove('drag-over'));
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
}

function handleDragEnter(e) {
    e.preventDefault();
    this.classList.add('drag-over');
}

function handleDragLeave(e) {
    // Only remove if truly leaving the element (not entering a child)
    if (!this.contains(e.relatedTarget)) {
        this.classList.remove('drag-over');
    }
}

function handleDrop(e) {
    e.preventDefault();
    this.classList.remove('drag-over');

    let dragData;
    try {
        const raw = e.dataTransfer.getData('text/plain');
        console.log('[Drop] raw data:', raw);
        dragData = JSON.parse(raw);
    } catch(err) {
        console.warn('[Drop] dataTransfer parse failed, using fallback:', err);
        // Fallback: use the variable stored during dragstart
        dragData = currentDragData;
    }

    if (!dragData || !dragData.id) {
        console.error('[Drop] No valid drag data');
        window.showToast && window.showToast('Errore nel trascinamento', 'error');
        return;
    }

    // Exercise drags go to workout cards, not client cards — ignore here
    if (dragData.type === 'exercise') return;

    const clientId = this.dataset.clientId;
    const clientName = this.dataset.clientName;
    console.log('[Drop] Assigning', dragData, 'to client', clientId, clientName);

    openAssignModal(dragData.type, dragData.id, dragData.name, clientId, clientName);
    currentDragData = null;
}

// ============ ADD EXERCISE TO WORKOUT ============

async function addExerciseToWorkout(workout, exerciseData, expandInner, cardTr) {
    if (!exerciseData?.name) {
        if (typeof showToast === 'function') showToast('Errore: dati esercizio non validi', 'error');
        return;
    }
    // Strip any nameless exercises from previous saves, then add the new one
    const exercises = (workout.exercises || []).filter(ex => ex && ex.name);
    exercises.push({
        name: exerciseData.name,
        sets: 3,
        reps: '10',
        rest: 60,
        video_id: exerciseData.video_id || null,
    });

    try {
        const apiBase = (window.APP_CONFIG || {}).apiBase || '';
        const res = await fetch(`${apiBase}/api/trainer/workouts/${workout.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                title: workout.title || '',
                duration: workout.duration || '',
                difficulty: workout.difficulty || '',
                exercises,
            }),
        });
        if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.detail || 'Errore nel salvataggio');
        }
        const updated = await res.json();
        // Update workout object in place
        workout.exercises = updated.exercises || exercises;
        // Update cache
        if (window.trainerData?.workouts) {
            const idx = window.trainerData.workouts.findIndex(w => w.id === workout.id);
            if (idx >= 0) window.trainerData.workouts[idx] = updated;
        }
        // Refresh expand panel in place (no full re-render)
        if (expandInner) _populateWorkoutExpand(expandInner, updated);
        // Update meta text on card
        if (cardTr) {
            const exCount = Array.isArray(updated.exercises) ? updated.exercises.length : 0;
            const meta = [updated.duration, updated.difficulty, exCount > 0 ? `${exCount} es.` : null].filter(Boolean).join(' · ');
            const metaEl = cardTr.querySelector('.workout-card-meta');
            if (metaEl) metaEl.textContent = meta;
        }
        if (typeof showToast === 'function') showToast(`"${exerciseData.name}" aggiunto a "${workout.title}"`, 'success');
    } catch(err) {
        if (typeof showToast === 'function') showToast(err.message || 'Errore', 'error');
    }
}
window.addExerciseToWorkout = addExerciseToWorkout;

// ============ ASSIGNMENT MODAL ============

function openAssignModal(type, itemId, itemName, clientId, clientName) {
    pendingAssignment = { type, itemId, itemName, clientId, clientName };

    const overlay = document.getElementById('assign-modal-overlay');
    const title = document.getElementById('assign-modal-title');
    const subtitle = document.getElementById('assign-modal-subtitle');
    const dateLabel = document.getElementById('assign-modal-date-label');
    const dateInput = document.getElementById('assign-modal-date');

    if (type === 'split') {
        title.textContent = 'Assegna split';
        subtitle.textContent = `${itemName} → ${clientName}`;
        dateLabel.textContent = 'Data di inizio';
        // Default to next Monday
        const today = new Date();
        const dayOfWeek = today.getDay() || 7;
        const nextMonday = new Date(today);
        nextMonday.setDate(today.getDate() + (8 - dayOfWeek));
        dateInput.value = nextMonday.toISOString().split('T')[0];
    } else {
        title.textContent = 'Assegna allenamento';
        subtitle.textContent = `${itemName} → ${clientName}`;
        dateLabel.textContent = 'Data';
        dateInput.value = new Date().toISOString().split('T')[0];
    }

    overlay.classList.remove('hidden');
    overlay.style.display = 'flex';
}

function closeAssignModal() {
    const overlay = document.getElementById('assign-modal-overlay');
    overlay.classList.add('hidden');
    overlay.style.display = 'none';
    pendingAssignment = null;
    // Clear click-to-assign selection
    selectedWorkoutItem = null;
    document.querySelectorAll('.workout-drag-card.selected').forEach(r => r.classList.remove('selected'));
}
window.closeAssignModal = closeAssignModal;

async function confirmAssignment() {
    if (!pendingAssignment) return;

    const { type, itemId, clientId } = pendingAssignment;
    const dateValue = document.getElementById('assign-modal-date').value;

    if (!dateValue) {
        window.showToast('Seleziona una data', 'error');
        return;
    }

    try {
        let res;
        const trainerSelector = document.getElementById('trainer-selector');
        const trainerId = trainerSelector ? trainerSelector.value : 'trainer_default';

        const apiBase = (window.APP_CONFIG || {}).apiBase || '';

        if (type === 'split') {
            console.log('[Assignment] Assigning split', itemId, 'to client', clientId, 'start:', dateValue);
            res = await fetch(`${apiBase}/api/trainer/assign_split`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-trainer-id': trainerId
                },
                credentials: 'include',
                body: JSON.stringify({
                    split_id: itemId,
                    client_id: clientId,
                    start_date: dateValue
                })
            });
        } else {
            console.log('[Assignment] Assigning workout', itemId, 'to client', clientId, 'date:', dateValue);
            res = await fetch(`${apiBase}/api/trainer/assign_workout`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    client_id: clientId,
                    date: dateValue,
                    workout_id: itemId
                })
            });
        }
        console.log('[Assignment] Response status:', res.status);

        if (res.ok) {
            const assignedClientId = clientId;
            window.showToast(`${type === 'split' ? 'Split' : 'Allenamento'} assegnato con successo!`, 'success');
            closeAssignModal();

            // Refresh trainer data to update client cards
            const trainerRes = await fetch(`${apiBase}/api/trainer/data?limit_cache=${Date.now()}`, { credentials: 'include' });
            if (trainerRes.ok) {
                const newData = await trainerRes.json();
                window.trainerData = newData;
                renderClientDropTargets(newData.clients || []);
                // Flash the newly rendered card green
                const updatedCard = document.querySelector(`.client-drop-target[data-client-id="${assignedClientId}"]`);
                if (updatedCard) {
                    updatedCard.style.borderColor = '#22c55e';
                    updatedCard.style.background = 'rgba(34, 197, 94, 0.1)';
                    setTimeout(() => {
                        updatedCard.style.borderColor = '';
                        updatedCard.style.background = '';
                    }, 1500);
                }
                // Also update the Utenti page client table
                if (typeof renderClientList === 'function') {
                    allClients = newData.clients || [];
                    renderClientList(allClients);
                }
            }
        } else {
            const errText = await res.text();
            console.error('[Assignment] Error response:', res.status, errText);
            window.showToast('Errore: ' + errText, 'error');
        }
    } catch(err) {
        window.showToast('Errore di rete', 'error');
        console.error('Assignment error:', err);
    }
}
window.confirmAssignment = confirmAssignment;

// ============ SCHEDULE SECTION ============
let currentSchedule = [];
let currentWeekMonday = new Date();
let selectedDateStr;

const toLocalISO = (d) => {
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
};

function initScheduleSection() {
    const username = localStorage.getItem('username') || 'Trainer';
    const nameEl = document.getElementById('personal-name');
    if (nameEl) nameEl.textContent = username;

    // Initialize calendar
    const day = currentWeekMonday.getDay() || 7;
    if (day !== 1) currentWeekMonday.setHours(-24 * (day - 1));
    currentWeekMonday.setHours(0, 0, 0, 0);
    selectedDateStr = toLocalISO(new Date());

    fetchScheduleData();

    // Notes auto-save
    const notesArea = document.getElementById('personal-notes');
    if (notesArea) {
        const savedNotes = localStorage.getItem(`personal_notes_${username}`);
        if (savedNotes) notesArea.value = savedNotes;
        let saveTimeout;
        notesArea.addEventListener('input', () => {
            const indicator = document.getElementById('personal-notes-saved-indicator');
            if (indicator) indicator.style.opacity = '0';
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                localStorage.setItem(`personal_notes_${username}`, notesArea.value);
                if (indicator) indicator.style.opacity = '1';
            }, 1000);
        });
    }

    // Toggle buttons
    document.getElementById('toggle-my-workout-btn')?.addEventListener('click', () => {
        document.getElementById('my-workout-section')?.classList.toggle('hidden');
    });
    document.getElementById('toggle-my-split-btn')?.addEventListener('click', () => {
        document.getElementById('my-split-section')?.classList.toggle('hidden');
    });

    // Setup day toggles for availability modal
    setupDayToggles();
}

async function fetchScheduleData() {
    try {
        const res = await fetch('/api/trainer/data');
        const data = await res.json();
        currentSchedule = data.schedule || [];

        // Update streak
        const streakEl = document.getElementById('personal-streak');
        if (streakEl && data.streak !== undefined) streakEl.textContent = data.streak;

        // Render Today's Plan (mobile + desktop)
        const { gymId } = window.APP_CONFIG || { gymId: 'default' };
        ['todays-plan-container', 'd-todays-plan-container'].forEach(cid => {
            const planContainer = document.getElementById(cid);
            if (planContainer && data.todays_workout) {
                const w = data.todays_workout;
                planContainer.innerHTML = `
                    <div class="glass-card p-5 relative overflow-hidden group tap-effect cursor-pointer" onclick="window.location.href='/?gym_id=${gymId}&role=trainer&mode=workout${w.completed ? '&view=completed' : ''}'">
                        <div class="absolute inset-0 bg-primary opacity-20 group-hover:opacity-30 transition"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-4">
                                <span class="bg-white/10 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider">Piano di Oggi</span>
                                <span class="text-xl">${w.completed ? icon('check-circle', 20) : icon('dumbbell', 20)}</span>
                            </div>
                            <h3 class="text-2xl font-black italic uppercase mb-1">${w.title}</h3>
                            <p class="text-sm text-gray-300 mb-4">${w.duration || 60} min • ${w.difficulty || 'Intermediate'}</p>
                            <button class="block w-full py-3 ${w.completed ? 'bg-green-500 text-white' : 'bg-white text-black hover:bg-gray-200'} text-center font-bold rounded-xl transition">${w.completed ? 'COMPLETATO ✓' : 'INIZIA SESSIONE'}</button>
                        </div>
                    </div>
                `;
            } else if (planContainer && !data.todays_workout) {
                planContainer.innerHTML = `
                    <div class="glass-card p-5 text-center text-gray-500">
                        <p class="text-sm">${icon('calendar-off', 20)} Nessun allenamento programmato per oggi</p>
                    </div>
                `;
            }
        });

        // Render workouts
        const workoutContainer = document.getElementById('my-workout-card-container');
        if (workoutContainer && data.workouts) {
            if (data.workouts.length === 0) {
                workoutContainer.innerHTML = '<p class="text-xs text-gray-500 italic text-center py-2">Nessun allenamento creato.</p>';
            } else {
                workoutContainer.innerHTML = data.workouts.map(w => `
                    <div class="glass-card p-3 mb-2">
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <h4 class="font-bold text-sm text-white">${w.title}</h4>
                                <p class="text-[10px] text-gray-400">${w.duration || 60} min • ${w.difficulty || 'Intermediate'}</p>
                            </div>
                        </div>
                        <button class="w-full py-1.5 bg-green-600/20 hover:bg-green-600 text-green-400 hover:text-white text-xs font-bold rounded-lg transition border border-green-500/30"
                            onclick="window.assignWorkoutToSelf && window.assignWorkoutToSelf('${w.id}', '${w.title}')"><i data-lucide="check-circle" class="w-4 h-4 inline-block align-middle"></i> Assegna a Me (Oggi)</button>
                    </div>
                `).join('');
            }
        }

        // Render splits
        const splitContainer = document.getElementById('my-split-card-container');
        if (splitContainer && data.splits) {
            if (data.splits.length === 0) {
                splitContainer.innerHTML = '<p class="text-xs text-gray-500 italic text-center py-2">Nessun split creato.</p>';
            } else {
                splitContainer.innerHTML = data.splits.map(s => `
                    <div class="glass-card p-3 mb-2">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-sm text-white">${s.name}</h4>
                                <p class="text-[10px] text-gray-400">${s.description || 'Nessuna descrizione'}</p>
                            </div>
                            <span class="text-[10px] bg-primary/20 text-primary px-2 py-0.5 rounded">${s.days_per_week} Giorni</span>
                        </div>
                    </div>
                `).join('');
            }
        }

        renderCalendarStrip();
        renderSchedule(selectedDateStr);
    } catch (e) {
        console.error("Error fetching schedule data:", e);
    }
}

window.changeWeek = function(offset) {
    currentWeekMonday.setDate(currentWeekMonday.getDate() + (offset * 7));
    selectedDateStr = toLocalISO(currentWeekMonday);
    renderCalendarStrip();
    renderSchedule(selectedDateStr);
};

function renderCalendarStripInto(containerId, monthLabelId) {
    const daysContainer = document.getElementById(containerId);
    if (!daysContainer) return;
    daysContainer.innerHTML = '';
    const monthLabel = document.getElementById(monthLabelId);
    const isDashboard = containerId === 'd-calendar-strip';

    if (monthLabel) {
        if (isDashboard) {
            monthLabel.innerText = currentWeekMonday.toLocaleDateString('it-IT', { month: 'long' });
        } else {
            monthLabel.innerText = currentWeekMonday.toLocaleDateString('it-IT', { month: 'short' });
        }
    }

    const itDays = ['LUN', 'MAR', 'MER', 'GIO', 'VEN', 'SAB', 'DOM'];

    for (let i = 0; i < 7; i++) {
        const d = new Date(currentWeekMonday);
        d.setDate(currentWeekMonday.getDate() + i);
        const dateStr = toLocalISO(d);
        const isSelected = dateStr === selectedDateStr;
        const isToday = dateStr === toLocalISO(new Date());
        const hasEvents = currentSchedule.some(e => e.date === dateStr);

        const div = document.createElement('div');
        const dayName = isDashboard ? itDays[(d.getDay() + 6) % 7] : d.toLocaleDateString('it-IT', { weekday: 'narrow' });
        const dayNum = d.getDate();

        if (isDashboard) {
            // Figma-style calendar strip
            div.className = 'trainer-cal-day';
            const isHighlighted = isSelected || isToday;
            div.innerHTML = `
                <span class="trainer-cal-dayname">${dayName}</span>
                <span class="trainer-cal-daynum${isHighlighted ? ' trainer-cal-daynum--active' : ''}">${dayNum}</span>
                ${hasEvents ? '<span class="trainer-cal-dot"></span>' : ''}
            `;
        } else {
            div.className = `flex flex-col items-center p-2 rounded cursor-pointer transition ${isSelected ? 'bg-white/10 text-white' : 'text-white/40 hover:bg-white/5'}`;
            if (isToday && !isSelected) div.classList.add('border', 'border-white/10');
            const dot = hasEvents ? '<div class="w-1 h-1 rounded-full bg-primary mt-1"></div>' : '';
            div.innerHTML = `<span class="opacity-50 text-[10px]">${dayName}</span><span>${dayNum}</span>${dot}`;
        }

        div.onclick = () => {
            selectedDateStr = dateStr;
            renderCalendarStrip();
            renderSchedule(dateStr);
        };
        daysContainer.appendChild(div);
    }
}

function renderCalendarStrip() {
    renderCalendarStripInto('calendar-strip', 'month-label');
    renderCalendarStripInto('d-calendar-strip', 'd-month-label');

    // Update week range label for Utenti page
    const weekRangeEl = document.getElementById('d-week-range-label');
    if (weekRangeEl) {
        const startDay = currentWeekMonday.getDate().toString().padStart(2, '0');
        const endDate = new Date(currentWeekMonday);
        endDate.setDate(endDate.getDate() + 6);
        const endDay = endDate.getDate().toString().padStart(2, '0');
        weekRangeEl.textContent = `${startDay} - ${endDay}`;
    }
}

function renderScheduleInto(dateStr, containerId, dateElId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const [y, m, d] = dateStr.split('-').map(Number);
    const dateObj = new Date(y, m - 1, d);
    const dateEl = document.getElementById(dateElId);
    if (dateEl) dateEl.innerText = dateObj.toLocaleDateString('it-IT', { weekday: 'long', month: 'long', day: 'numeric' });

    const isDashboard = containerId === 'd-schedule-container';
    container.innerHTML = '';
    const dayEvents = currentSchedule.filter(e => e.date === dateStr).sort((a, b) => a.time.localeCompare(b.time));

    dayEvents.forEach(s => {
        const div = document.createElement('div');
        const opacityClass = s.completed ? 'opacity-50 grayscale' : '';

        if (isDashboard) {
            // Simplified mobile-style schedule items
            const timeStr = s.time.substring(0, 5);
            div.className = `trainer-schedule-item ${opacityClass}`;
            div.innerHTML = `
                <span class="trainer-schedule-time">${timeStr}</span>
                <span class="trainer-schedule-title ${s.completed ? 'line-through' : ''}">${s.title}${s.subtitle ? ' ' + s.subtitle : ''}</span>
            `;
        } else {
            div.className = `flex justify-between items-center bg-white/5 border border-white/5 rounded-xl p-3 group relative ${opacityClass}`;

            let colorClass = "text-blue-400 bg-blue-500/20";
            if (s.type === 'personal') colorClass = "text-green-400 bg-green-500/20";
            if (s.type === 'class') colorClass = "text-yellow-400 bg-yellow-500/20";
            if (s.type === '1on1_appointment') colorClass = "text-orange-400 bg-orange-500/20";

            let [h, min] = s.time.split(':');
            let ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12 || 12;

            div.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 rounded-lg ${colorClass} flex flex-col items-center justify-center">
                        <span class="font-bold text-lg leading-none">${h}</span>
                        <span class="text-[9px] uppercase">${ampm}</span>
                    </div>
                    <div>
                        <p class="text-[10px] text-white/30">${s.duration || 60} min</p>
                        <h4 class="font-bold text-sm text-white ${s.completed ? 'line-through text-white/50' : ''}">${s.title}</h4>
                        <p class="text-xs text-white/50">${s.subtitle || ''}</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="toggleComplete('${s.id}')"
                        class="w-10 h-10 rounded-full flex items-center justify-center border-2 transition-all duration-300
                        ${s.completed ? 'bg-green-500 border-green-500 text-white' : 'border-white/20 text-transparent hover:border-white/50'}">
                        <span class="transform transition-transform duration-300 ${s.completed ? 'scale-100' : 'scale-0'}">✓</span>
                    </button>
                    <button onclick="deleteEvent('${s.id}')" class="text-red-500 opacity-0 group-hover:opacity-100 transition p-2 hover:bg-white/10 rounded-lg">✕</button>
                </div>
            `;
        }
        container.appendChild(div);
    });

    // Add button
    const addDiv = document.createElement('div');
    if (isDashboard) {
        addDiv.className = "trainer-schedule-item";
        addDiv.style.cursor = 'pointer';
        addDiv.style.opacity = '0.5';
        addDiv.onclick = () => openAddModal(dateStr);
        addDiv.innerHTML = `<span class="trainer-schedule-time" style="background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.4);">+</span><span style="font-size:0.85rem;color:rgba(255,255,255,0.3);">Aggiungi appuntamento</span>`;
    } else {
        addDiv.className = "flex items-center justify-center rounded-xl border border-white/20 border-dashed hover:bg-white/5 transition cursor-pointer";
        addDiv.style.padding = "0.75rem";
        addDiv.style.minHeight = "72px";
        addDiv.onclick = () => openAddModal(dateStr);
        addDiv.innerHTML = `<span class="text-sm text-white/40">+ Aggiungi appuntamento</span>`;
    }
    container.appendChild(addDiv);
}

function renderSchedule(dateStr) {
    renderScheduleInto(dateStr, 'schedule-container', 'current-full-date');
    renderScheduleInto(dateStr, 'd-schedule-container', 'd-current-full-date');
}

async function openAddModal(dateStr) {
    document.getElementById('event-date-input').value = dateStr;
    document.getElementById('add-event-modal').classList.remove('hidden');
}

window.deleteEvent = async function(id) {
    if (!confirm("Eliminare questo evento?")) return;
    try {
        const res = await fetch(`/api/trainer/events/${id}`, { method: 'DELETE' });
        if (res.ok) fetchScheduleData();
    } catch (e) { console.error(e); }
};

window.toggleComplete = async function(id) {
    try {
        const res = await fetch(`/api/trainer/events/${id}/toggle_complete`, { method: 'POST' });
        if (res.ok) fetchScheduleData();
    } catch (e) { console.error(e); }
};

// Add event form
document.getElementById('add-event-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    data.duration = parseInt(data.duration) || 60;

    try {
        const res = await fetch('/api/trainer/events', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        if (res.ok) {
            await fetchScheduleData();
            document.getElementById('add-event-modal').classList.add('hidden');
            e.target.reset();
        }
    } catch (err) { console.error(err); }
});

// ============ AVAILABILITY ============
function setupDayToggles() {
    document.querySelectorAll('.day-toggle').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const day = this.dataset.day;
            const timesDiv = document.querySelector(`.day-times[data-day="${day}"]`);
            if (timesDiv) {
                timesDiv.classList.toggle('hidden', !this.checked);
            }
        });
    });
}

window.openAvailabilityModal = async function() {
    document.getElementById('availability-modal').classList.remove('hidden');
    await loadAvailability();
};

window.closeAvailabilityModal = function() {
    document.getElementById('availability-modal').classList.add('hidden');
};

async function loadAvailability() {
    try {
        const res = await fetch('/api/trainer/availability');
        const slots = await res.json();

        document.querySelectorAll('.day-toggle').forEach(cb => cb.checked = false);
        document.querySelectorAll('.day-times').forEach(div => div.classList.add('hidden'));

        slots.forEach(slot => {
            const checkbox = document.querySelector(`.day-toggle[data-day="${slot.day_of_week}"]`);
            const timesDiv = document.querySelector(`.day-times[data-day="${slot.day_of_week}"]`);
            if (checkbox && timesDiv) {
                checkbox.checked = true;
                timesDiv.classList.remove('hidden');
                timesDiv.querySelector('.start-time').value = slot.start_time;
                timesDiv.querySelector('.end-time').value = slot.end_time;
            }
        });
    } catch (e) { console.error('Error loading availability:', e); }

    // Load session rate
    try {
        const rateRes = await fetch('/api/trainer/session-rate');
        if (rateRes.ok) {
            const rateData = await rateRes.json();
            const rateInput = document.getElementById('trainer-session-rate');
            if (rateInput && rateData.session_rate != null) {
                rateInput.value = rateData.session_rate;
            }
        }
    } catch (e) { console.error('Error loading session rate:', e); }
}

window.saveAvailability = async function() {
    const availability = [];
    document.querySelectorAll('.day-toggle:checked').forEach(checkbox => {
        const day = parseInt(checkbox.dataset.day);
        const timesDiv = document.querySelector(`.day-times[data-day="${day}"]`);
        if (timesDiv) {
            availability.push({
                day_of_week: day,
                start_time: timesDiv.querySelector('.start-time').value,
                end_time: timesDiv.querySelector('.end-time').value
            });
        }
    });

    try {
        const res = await fetch('/api/trainer/availability', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ availability })
        });

        // Save session rate
        const rateInput = document.getElementById('trainer-session-rate');
        const rateValue = rateInput.value ? parseFloat(rateInput.value) : null;
        await fetch('/api/trainer/session-rate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_rate: rateValue })
        });

        if (res.ok) {
            closeAvailabilityModal();
            alert('Disponibilit\u00e0 e tariffa salvate!');
        }
    } catch (e) { console.error('Error saving availability:', e); }
};

// ============ COURSES SECTION ============
function initCoursesSection() {
    if (typeof window.loadCoursesPage === 'function') {
        window.loadCoursesPage();
    }

    // Load exercise library directly (always visible now)
    if (typeof window.loadCourseExercises === 'function') {
        window.loadCourseExercises();
    }

    // Search
    document.getElementById('course-exercise-search')?.addEventListener('input', (e) => {
        if (typeof window.filterCourseExercisesBySearch === 'function') {
            window.filterCourseExercisesBySearch(e.target.value);
        }
    });
}

// Course tab switching
function switchCourseTab(tabId) {
    document.querySelectorAll('#section-courses .trainer-tab-content').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('#section-courses .trainer-tab').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.remove('hidden');
    const tabBtn = document.querySelector(`#section-courses .trainer-tab[data-tab="${tabId}"]`);
    if (tabBtn) tabBtn.classList.add('active');
}
window.switchCourseTab = switchCourseTab;

// ============ SETTINGS SECTION ============
function initSettingsSection() {
    const username = localStorage.getItem('username') || 'Trainer';
    document.getElementById('settings-trainer-name').textContent = username;
    document.getElementById('settings-profile-pic').textContent = username.charAt(0).toUpperCase();

    // Load bio
    loadBio();
    loadSpecialties();

    // Specialty checkbox styling
    document.querySelectorAll('.specialty-checkbox').forEach(cb => {
        cb.addEventListener('change', function() {
            const span = this.nextElementSibling;
            if (this.checked) {
                span.classList.remove('bg-white/5', 'text-white/60');
                span.classList.add('bg-primary/20', 'text-primary', 'border-primary/30');
            } else {
                span.classList.add('bg-white/5', 'text-white/60');
                span.classList.remove('bg-primary/20', 'text-primary', 'border-primary/30');
            }
        });
    });
}

async function loadBio() {
    try {
        const res = await fetch('/api/profile/bio');
        if (res.ok) {
            const data = await res.json();
            document.getElementById('settings-bio').value = data.bio || '';
        }
    } catch (e) { console.error('Error loading bio:', e); }
}

window.saveBio = async function() {
    const bio = document.getElementById('settings-bio').value;
    try {
        const res = await fetch('/api/profile/bio', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ bio })
        });
        if (res.ok) alert('Bio salvata!');
    } catch (e) { console.error('Error saving bio:', e); }
};

async function loadSpecialties() {
    try {
        const res = await fetch('/api/profile/specialties');
        if (res.ok) {
            const data = await res.json();
            const specialties = data.specialties || [];
            document.querySelectorAll('.specialty-checkbox').forEach(cb => {
                cb.checked = specialties.includes(cb.value);
                cb.dispatchEvent(new Event('change'));
            });
        }
    } catch (e) { console.error('Error loading specialties:', e); }
}

window.saveSpecialties = async function() {
    const specialties = [];
    document.querySelectorAll('.specialty-checkbox:checked').forEach(cb => {
        specialties.push(cb.value);
    });
    try {
        const res = await fetch('/api/profile/specialties', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ specialties })
        });
        if (res.ok) alert('Specializzazioni salvate!');
    } catch (e) { console.error('Error saving specialties:', e); }
};

window.uploadProfilePicture = async function(input) {
    if (!input.files[0]) return;
    const formData = new FormData();
    formData.append('file', input.files[0]);
    try {
        const res = await fetch('/api/profile/picture', {
            method: 'POST',
            body: formData
        });
        if (res.ok) {
            const data = await res.json();
            if (data.url) {
                document.getElementById('settings-profile-pic').innerHTML = `<img src="${data.url}" class="w-full h-full object-cover rounded-full">`;
            }
        }
    } catch (e) { console.error('Error uploading picture:', e); }
};

// ============ INITIALIZATION ============
document.addEventListener('DOMContentLoaded', () => {
    // Update sidebar name
    const username = localStorage.getItem('username') || 'Trainer';
    const sidebarName = document.getElementById('sidebar-trainer-name');
    if (sidebarName) sidebarName.textContent = `Coach ${username}`;

    // Handle hash navigation
    const hash = window.location.hash.replace('#', '');
    if (hash && ['dashboard', 'workouts', 'schedule', 'courses', 'settings'].includes(hash)) {
        switchSection(hash);
    }

    // Load schedule data into the dashboard calendar (both desktop and mobile)
    if (!hash || hash === 'dashboard') {
        if (!scheduleInitialized) {
            const day = currentWeekMonday.getDay() || 7;
            if (day !== 1) currentWeekMonday.setHours(-24 * (day - 1));
            currentWeekMonday.setHours(0, 0, 0, 0);
            selectedDateStr = toLocalISO(new Date());
            fetchScheduleData();
            scheduleInitialized = true;
        }
    }

    // Show exercises on desktop
    if (window.innerWidth >= 1024) {
        const section = document.getElementById('exercises-section');
        if (section) {
            section.style.maxHeight = 'none';
            section.style.opacity = '1';
            section.style.overflow = 'visible';
        }
    }

    window.addEventListener('resize', () => {
        const section = document.getElementById('exercises-section');
        if (section && window.innerWidth >= 1024) {
            section.style.maxHeight = 'none';
            section.style.opacity = '1';
            section.style.overflow = 'visible';
        }
    });
});

// Expose functions globally
window.switchSection = switchSection;
</script>


{% endblock %}
