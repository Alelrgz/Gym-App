{% extends "base.html" %}

{% block content %}
<!-- Desktop Sidebar + Main Content Layout -->
<div class="lg:flex lg:min-h-screen">

    <!-- Desktop Sidebar - Hidden on mobile -->
    <aside id="trainer-sidebar" class="hidden lg:flex lg:flex-col lg:w-64 lg:fixed lg:left-0 lg:top-0 lg:h-screen trainer-sidebar lg:z-40">
        <!-- Sidebar Header -->
        <div class="trainer-sidebar-header">
            <p class="sidebar-label">Trainer</p>
            <h2 class="sidebar-title" id="sidebar-trainer-name">Coach Loading...</h2>
        </div>

        <!-- Navigation Items -->
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="switchSection('dashboard')"
                    class="sidebar-nav-item active"
                    data-section="dashboard">
                <span class="nav-icon">üè†</span>
                <span class="nav-label">Dashboard</span>
            </button>
            <button onclick="switchSection('schedule')"
                    class="sidebar-nav-item"
                    data-section="schedule">
                <span class="nav-icon">üìÖ</span>
                <span class="nav-label">Schedule</span>
            </button>
            <button onclick="switchSection('courses')"
                    class="sidebar-nav-item"
                    data-section="courses">
                <span class="nav-icon">üìö</span>
                <span class="nav-label">Courses</span>
            </button>
            <button onclick="switchSection('settings')"
                    class="sidebar-nav-item"
                    data-section="settings">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-label">Settings</span>
            </button>
        </nav>

        <!-- Sidebar Footer -->
        <div class="trainer-sidebar-footer">
            <a href="/auth/logout" class="sidebar-logout">
                <span class="nav-icon">üö™</span>
                <span class="nav-label">Logout</span>
            </a>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 lg:ml-64 min-h-screen">

        <!-- ==================== SECTION: DASHBOARD ==================== -->
        <section id="section-dashboard" class="trainer-section p-4 md:p-6 lg:p-8 max-w-[1400px] mx-auto">
            <!-- Header Row -->
            <div class="flex justify-between items-start mb-8">
                <div>
                    <p class="label-uppercase mb-1">Trainer Dashboard</p>
                    <h2 class="heading-page" id="trainer-name">Coach <span id="trainer-username">Loading...</span></h2>
                    <select id="trainer-selector" class="hidden">
                        <option value="trainer_default">Default Trainer</option>
                    </select>
                </div>
                <div class="flex gap-3">
                    <div onclick="openConversationsModal()" class="relative w-11 h-11 rounded-xl glass-card-interactive flex items-center justify-center">
                        <span class="text-lg">üí¨</span>
                        <span id="unread-messages-badge" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center hidden">0</span>
                    </div>
                    <div data-action="showModal" data-target="notification-modal" class="w-11 h-11 rounded-xl glass-card-interactive flex items-center justify-center">
                        <span class="text-lg">üîî</span>
                    </div>
                    <div class="lg:hidden" data-action="showModal" data-target="profile-modal">
                        <div class="w-11 h-11 rounded-xl glass-card-interactive flex items-center justify-center">
                            <span class="text-lg">‚öôÔ∏è</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Row -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="stat-card stat-card-primary">
                    <p class="stat-value" id="active-clients-count">0</p>
                    <p class="stat-label">Active Clients</p>
                </div>
                <div class="stat-card stat-card-danger">
                    <p class="stat-value" id="at-risk-clients-count">0</p>
                    <p class="stat-label">At Risk</p>
                </div>
                <div class="hidden lg:block stat-card stat-card-success">
                    <p class="stat-value" id="workouts-count">0</p>
                    <p class="stat-label">Workouts</p>
                </div>
                <div class="hidden lg:block stat-card stat-card-purple">
                    <p class="stat-value" id="splits-count">0</p>
                    <p class="stat-label">Splits</p>
                </div>
            </div>

            <!-- Main 2x2 Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- TOP LEFT: Clients -->
                <div class="glass-card-primary p-6 rounded-2xl lg:h-[420px] flex flex-col">
                    <div class="flex justify-between items-center mb-5">
                        <h3 class="heading-card flex items-center gap-2">
                            <span>üë•</span> Clients
                        </h3>
                        <span class="text-xs text-muted" id="client-count-badge">0 total</span>
                    </div>
                    <div class="input-search-wrapper mb-4">
                        <span class="search-icon">üîç</span>
                        <input type="text" id="client-search" placeholder="Search clients..."
                            class="input-glass">
                    </div>
                    <div id="client-list" class="card-scroll-content space-y-2 pr-2 max-h-[280px] lg:max-h-none"></div>
                </div>

                <!-- TOP RIGHT: Workouts & Splits -->
                <div class="glass-card-primary p-6 rounded-2xl lg:h-[420px] flex flex-col">
                    <h3 class="heading-card flex items-center gap-2 mb-5">
                        <span>üìã</span> Programs
                    </h3>
                    <!-- Workouts -->
                    <div class="mb-5">
                        <div class="flex justify-between items-center mb-3">
                            <span class="label-uppercase">Workouts</span>
                            <button data-action="openCreateWorkout" class="btn-glass" style="background: rgba(74, 222, 128, 0.15); border-color: rgba(74, 222, 128, 0.3); color: #4ade80;">+ New</button>
                        </div>
                        <div id="workout-library" class="space-y-2 max-h-[140px] overflow-y-auto pr-1"></div>
                    </div>
                    <!-- Splits -->
                    <div class="flex-1 min-h-0 flex flex-col">
                        <div class="flex justify-between items-center mb-3">
                            <span class="label-uppercase">Weekly Splits</span>
                            <button data-action="openCreateSplit" class="btn-glass" style="background: rgba(168, 139, 250, 0.15); border-color: rgba(168, 139, 250, 0.3); color: #a78bfa;">+ New</button>
                        </div>
                        <div id="split-library" class="card-scroll-content space-y-2 pr-1"></div>
                    </div>
                </div>

                <!-- BOTTOM LEFT: Quick Notes -->
                <div class="glass-card p-6 rounded-2xl lg:h-[320px] flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="heading-card flex items-center gap-2">
                            <span>üìù</span> Quick Notes
                        </h3>
                        <span class="text-[10px] text-green-400 opacity-0 transition-opacity duration-500" id="notes-saved-indicator">Saved ‚úì</span>
                    </div>
                    <textarea id="trainer-notes"
                        class="flex-1 w-full input-glass resize-none"
                        placeholder="Write your thoughts, reminders, or todolist here..."></textarea>
                </div>

                <!-- BOTTOM RIGHT: Exercises -->
                <div class="glass-card p-6 rounded-2xl lg:h-[320px] flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="heading-card flex items-center gap-2">
                            <span>üèãÔ∏è</span> Exercises
                        </h3>
                        <button data-action="showModal" data-target="create-exercise-modal" class="btn-glass-accent">+ New</button>
                    </div>
                    <!-- Mobile toggle -->
                    <button id="toggle-exercises-btn" class="lg:hidden w-full flex items-center justify-center gap-2 bg-white/5 hover:bg-white/10 transition p-3 rounded-xl mb-3">
                        <span class="text-xs text-white/70 uppercase tracking-wider font-bold">Show Exercises</span>
                        <span id="exercises-chevron" class="text-white/40 text-xs transition-transform duration-300">‚ñº</span>
                    </button>
                    <div id="exercises-section" class="flex-1 flex flex-col min-h-0 lg:!flex" style="display: none;">
                        <div class="flex gap-2 mb-3">
                            <div class="input-search-wrapper flex-1">
                                <span class="search-icon text-xs">üîç</span>
                                <input type="text" id="main-ex-search" placeholder="Search..."
                                    class="input-glass text-xs py-2">
                            </div>
                            <select id="main-ex-filter-muscle" class="input-glass text-xs py-2 px-2 w-auto">
                                <option value="">All Muscles</option>
                                <option value="Chest">Chest</option>
                                <option value="Back">Back</option>
                                <option value="Legs">Legs</option>
                                <option value="Shoulders">Shoulders</option>
                                <option value="Arms">Arms</option>
                                <option value="Abs">Abs</option>
                            </select>
                            <select id="main-ex-filter-type" class="input-glass text-xs py-2 px-2 w-auto">
                                <option value="">All Types</option>
                                <option value="Compound">Compound</option>
                                <option value="Isolation">Isolation</option>
                                <option value="Bodyweight">Bodyweight</option>
                            </select>
                        </div>
                        <div id="main-exercise-library" class="card-scroll-content space-y-2 pr-1 max-h-[360px] lg:max-h-none"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ==================== SECTION: SCHEDULE ==================== -->
        <section id="section-schedule" class="trainer-section hidden p-4 md:p-6 lg:p-8 max-w-[1400px] mx-auto">
            <!-- Header -->
            <div class="flex justify-between items-start mb-8">
                <div>
                    <p class="label-uppercase mb-1">My Profile</p>
                    <h2 class="heading-page" id="personal-name">Loading...</h2>
                </div>
                <div class="flex gap-3 lg:hidden">
                    <div id="notification-bell-schedule" onclick="openNotificationsModal()"
                        class="w-11 h-11 rounded-xl glass-card-interactive flex items-center justify-center">
                        üîî
                    </div>
                </div>
            </div>

            <!-- Quick Actions Row -->
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="stat-card stat-card-success">
                    <p class="stat-value" id="personal-streak">0</p>
                    <p class="stat-label">Streak üî•</p>
                </div>
                <button onclick="openAvailabilityModal()"
                    class="glass-card-interactive p-5 flex flex-col items-center justify-center group">
                    <span class="text-2xl mb-2 group-hover:scale-110 transition-transform">üïê</span>
                    <span class="label-uppercase">1-on-1</span>
                </button>
            </div>

            <!-- My Workout Section (Hidden by default) -->
            <div id="my-workout-section" class="hidden transition-all duration-300 ease-in-out mb-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">My Workouts</h3>
                    <button onclick="document.getElementById('my-workout-section').classList.add('hidden')"
                        class="text-white/40 hover:text-white text-sm">‚úï</button>
                </div>
                <div id="my-workout-card-container">
                    <div class="glass-card p-4 text-center">
                        <p class="text-gray-400 text-sm mb-2">Loading...</p>
                    </div>
                </div>
            </div>

            <!-- My Splits Section (Hidden by default) -->
            <div id="my-split-section" class="hidden transition-all duration-300 ease-in-out mb-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">My Splits</h3>
                    <button onclick="document.getElementById('my-split-section').classList.add('hidden')"
                        class="text-white/40 hover:text-white text-sm">‚úï</button>
                </div>
                <div id="my-split-card-container">
                    <div class="glass-card p-4 text-center">
                        <p class="text-gray-400 text-sm mb-2">Loading...</p>
                    </div>
                </div>
            </div>

            <!-- Today's Plan Section -->
            <div id="todays-plan-container" class="mb-6">
                <div class="glass-card p-5 relative overflow-hidden" id="default-plan-placeholder">
                    <div class="flex justify-between items-start mb-4">
                        <span class="bg-white/10 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider">Today's Plan</span>
                        <span class="text-xl">üìã</span>
                    </div>
                    <h3 class="text-xl font-bold text-white/50 mb-2">No Workout Assigned</h3>
                    <p class="text-sm text-gray-400 mb-4">Select a workout from "My Workouts" and click "Assign to Me" to set today's workout.</p>
                </div>
            </div>

            <!-- Calendar / Schedule Section -->
            <div class="glass-card p-4 rounded-2xl mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Schedule</h3>
                    <div class="flex items-center space-x-2">
                        <button onclick="changeWeek(-1)"
                            class="w-6 h-6 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-white/70">‚Üê</button>
                        <span class="text-xs text-white/40 min-w-[3rem] text-center" id="month-label">...</span>
                        <button onclick="changeWeek(1)"
                            class="w-6 h-6 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-white/70">‚Üí</button>
                    </div>
                </div>
                <div class="text-xs text-center font-mono mb-2 text-white/50 uppercase tracking-widest" id="current-full-date"></div>
                <div class="grid grid-cols-7 gap-1 mb-4 text-xs text-center font-mono" id="calendar-strip"></div>
                <div class="space-y-3" id="schedule-container"></div>
            </div>

            <!-- Personal Notes -->
            <div class="glass-card p-4 rounded-2xl">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Personal Notes</h3>
                    <span class="text-[10px] text-green-400 opacity-0 transition-opacity duration-500" id="personal-notes-saved-indicator">Saved</span>
                </div>
                <textarea id="personal-notes"
                    class="w-full bg-black/20 text-white text-sm rounded-xl p-3 border border-white/5 focus:border-white/20 outline-none resize-none h-32 placeholder-white/20 transition"
                    placeholder="Journal your progress, ideas, or training logs..."></textarea>
            </div>
        </section>

        <!-- ==================== SECTION: COURSES ==================== -->
        <section id="section-courses" class="trainer-section hidden p-4 md:p-6 lg:p-8 max-w-[1400px] mx-auto">
            <!-- Header -->
            <div class="flex justify-between items-start mb-8">
                <div>
                    <p class="label-uppercase mb-1">Trainer Dashboard</p>
                    <h2 class="heading-page">Group Courses</h2>
                </div>
            </div>

            <!-- Stats Row -->
            <div class="grid grid-cols-3 gap-4 mb-8">
                <div class="stat-card stat-card-primary">
                    <p class="stat-value text-2xl" id="total-courses-count">0</p>
                    <p class="stat-label">Courses</p>
                </div>
                <div class="stat-card stat-card-success">
                    <p class="stat-value text-2xl" id="lessons-this-week">0</p>
                    <p class="stat-label">This Week</p>
                </div>
                <div class="stat-card" style="--stat-color: #facc15;">
                    <p class="stat-value text-2xl text-yellow-400" id="avg-engagement">-</p>
                    <p class="stat-label">Avg Rating</p>
                </div>
            </div>

            <!-- Create Course Button -->
            <button data-action="openCreateCourse"
                class="w-full glass-card-interactive p-5 mb-8 flex items-center justify-center gap-3 border-2 border-dashed border-white/20 hover:border-primary/50">
                <span class="text-2xl">+</span>
                <span class="heading-card">Create New Course</span>
            </button>

            <!-- Courses List -->
            <div class="space-y-4">
                <h3 class="label-uppercase mb-4">Your Courses</h3>
                <div id="courses-page-list" class="space-y-3">
                    <div class="glass-card p-6 text-center">
                        <p class="text-gray-400 text-sm">Loading courses...</p>
                    </div>
                </div>
            </div>

            <!-- Shared Courses Section -->
            <div class="mt-8 space-y-4">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Shared by Gym</h3>
                <div id="shared-courses-list" class="space-y-3">
                    <div class="glass-card p-4 text-center">
                        <p class="text-gray-400/50 text-xs">No shared courses from other trainers</p>
                    </div>
                </div>
            </div>

            <!-- Course Exercise Library Section -->
            <div class="mt-8">
                <button id="toggle-course-exercises-btn"
                    class="w-full glass-card p-4 flex items-center justify-between hover:bg-white/10 transition tap-effect">
                    <div class="flex items-center space-x-3">
                        <span class="text-xl">üèÉ</span>
                        <div class="text-left">
                            <span class="text-sm font-bold uppercase tracking-wider">Exercise Library</span>
                            <p class="text-[10px] text-white/50">Create & manage exercises for your courses</p>
                        </div>
                    </div>
                    <span id="course-exercises-chevron" class="text-white/40 text-sm transition-transform duration-300">‚ñº</span>
                </button>

                <div id="course-exercises-section" class="overflow-hidden transition-all duration-300 ease-out mt-3" style="max-height: 0; opacity: 0;">
                    <button onclick="openCourseExerciseModal()"
                        class="w-full glass-card p-3 mb-4 flex items-center justify-center space-x-2 hover:bg-white/10 transition tap-effect border-2 border-dashed border-white/20 hover:border-green-500/50">
                        <span class="text-lg">+</span>
                        <span class="text-xs font-bold uppercase tracking-wider">Create New Exercise</span>
                    </button>

                    <div class="flex flex-wrap gap-2 mb-4">
                        <button onclick="filterCourseExercises('all')" data-filter="all"
                            class="course-ex-filter-btn active px-3 py-1.5 text-xs rounded-full bg-primary/20 text-primary border border-primary/30 transition">All</button>
                        <button onclick="filterCourseExercises('yoga')" data-filter="yoga"
                            class="course-ex-filter-btn px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition">üßò Yoga</button>
                        <button onclick="filterCourseExercises('pilates')" data-filter="pilates"
                            class="course-ex-filter-btn px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition">ü§∏ Pilates</button>
                        <button onclick="filterCourseExercises('stretch')" data-filter="stretch"
                            class="course-ex-filter-btn px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition">üôÜ Stretch</button>
                        <button onclick="filterCourseExercises('cardio')" data-filter="cardio"
                            class="course-ex-filter-btn px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition">üèÉ Cardio</button>
                    </div>

                    <div class="relative mb-4">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-white/30 text-sm">üîç</span>
                        <input type="text" id="course-exercise-search" placeholder="Search exercises..."
                            class="w-full bg-white/5 border border-white/10 rounded-xl pl-9 pr-3 py-2.5 text-sm text-white outline-none focus:border-white/25 focus:bg-white/10 transition placeholder-white/30">
                    </div>

                    <div id="course-exercise-library" class="grid grid-cols-2 gap-3 max-h-96 overflow-y-auto pr-1">
                        <div class="col-span-2 glass-card p-6 text-center">
                            <p class="text-gray-400/50 text-xs">Loading exercises...</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ==================== SECTION: SETTINGS ==================== -->
        <section id="section-settings" class="trainer-section hidden p-4 md:p-6 lg:p-8 max-w-[1000px] mx-auto">
            <div class="mb-8">
                <p class="label-uppercase mb-1">Account</p>
                <h2 class="heading-page">Settings</h2>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Profile Card -->
                <div class="lg:col-span-1">
                    <div class="glass-card-primary p-8 text-center">
                        <div id="settings-profile-pic" class="w-28 h-28 rounded-full bg-gradient-to-br from-primary to-orange-600 flex items-center justify-center mx-auto mb-5 text-4xl font-bold text-white shadow-lg">
                            T
                        </div>
                        <h3 class="text-xl font-bold text-white mb-1" id="settings-trainer-name">Trainer</h3>
                        <p class="text-sm text-muted">Personal Trainer</p>
                        <button onclick="document.getElementById('profile-picture-input').click()"
                            class="mt-5 btn-glass">
                            Change Photo
                        </button>
                        <input type="file" id="profile-picture-input" accept="image/*" class="hidden" onchange="uploadProfilePicture(this)">
                    </div>
                </div>

                <!-- Settings Options -->
                <div class="lg:col-span-2 space-y-4">
                    <!-- Bio -->
                    <div class="glass-card p-5">
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Bio</h3>
                        <textarea id="settings-bio" placeholder="Tell clients about yourself, your experience, and training style..."
                            class="w-full bg-black/20 text-white text-sm rounded-xl p-3 border border-white/10 focus:border-primary/50 outline-none resize-none h-24 transition"></textarea>
                        <button onclick="saveBio()" class="mt-2 text-xs bg-primary/20 hover:bg-primary/30 text-primary px-4 py-2 rounded-lg transition">Save Bio</button>
                    </div>

                    <!-- Specialties -->
                    <div class="glass-card p-5">
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Specialties</h3>
                        <div id="specialties-container" class="flex flex-wrap gap-2">
                            <label class="specialty-tag cursor-pointer">
                                <input type="checkbox" value="Weight Loss" class="hidden specialty-checkbox">
                                <span class="px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition inline-block">Weight Loss</span>
                            </label>
                            <label class="specialty-tag cursor-pointer">
                                <input type="checkbox" value="Muscle Building" class="hidden specialty-checkbox">
                                <span class="px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition inline-block">Muscle Building</span>
                            </label>
                            <label class="specialty-tag cursor-pointer">
                                <input type="checkbox" value="Strength Training" class="hidden specialty-checkbox">
                                <span class="px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition inline-block">Strength Training</span>
                            </label>
                            <label class="specialty-tag cursor-pointer">
                                <input type="checkbox" value="HIIT" class="hidden specialty-checkbox">
                                <span class="px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition inline-block">HIIT</span>
                            </label>
                            <label class="specialty-tag cursor-pointer">
                                <input type="checkbox" value="Yoga" class="hidden specialty-checkbox">
                                <span class="px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition inline-block">Yoga</span>
                            </label>
                            <label class="specialty-tag cursor-pointer">
                                <input type="checkbox" value="Nutrition" class="hidden specialty-checkbox">
                                <span class="px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition inline-block">Nutrition</span>
                            </label>
                        </div>
                        <button onclick="saveSpecialties()" class="mt-3 text-xs bg-primary/20 hover:bg-primary/30 text-primary px-4 py-2 rounded-lg transition">Save Specialties</button>
                    </div>

                    <!-- Availability -->
                    <div class="glass-card p-5">
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">1-on-1 Availability</h3>
                        <p class="text-xs text-gray-400 mb-3">Set your weekly hours for client bookings</p>
                        <button onclick="openAvailabilityModal()" class="text-xs bg-orange-500/20 hover:bg-orange-500/30 text-orange-400 px-4 py-2 rounded-lg transition">
                            Configure Availability
                        </button>
                    </div>

                    <!-- Account Actions -->
                    <div class="glass-card p-5">
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Account</h3>
                        <a href="/auth/logout" class="inline-flex items-center gap-2 text-xs bg-red-500/20 hover:bg-red-500/30 text-red-400 px-4 py-2 rounded-lg transition">
                            üö™ Logout
                        </a>
                    </div>
                </div>
            </div>
        </section>

    </main>
</div>

<!-- Add Event Modal -->
<div id="add-event-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50 backdrop-blur-sm">
    <div class="glass-card w-full max-w-sm mx-4 p-6 rounded-2xl relative">
        <button onclick="document.getElementById('add-event-modal').classList.add('hidden')"
            class="absolute top-4 right-4 text-white/50 hover:text-white">‚úï</button>
        <h3 class="text-xl font-bold mb-4 text-center">Add Event</h3>
        <form id="add-event-form" class="space-y-4">
            <div>
                <label class="text-xs text-gray-400 uppercase">Title</label>
                <input type="text" name="title" required
                    class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none"
                    placeholder="e.g. Client Consultation">
            </div>
            <div>
                <label class="text-xs text-gray-400 uppercase">Subtitle / Details</label>
                <input type="text" name="subtitle"
                    class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none"
                    placeholder="e.g. John Doe - Leg Day">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-xs text-gray-400 uppercase">Time</label>
                    <input type="time" name="time" required
                        class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none">
                </div>
                <div>
                    <label class="text-xs text-gray-400 uppercase">Type</label>
                    <select name="type"
                        class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none">
                        <option value="personal">Personal</option>
                        <option value="consultation">Consultation</option>
                        <option value="class">Class</option>
                    </select>
                </div>
            </div>
            <div id="workout-selector-container" class="hidden">
                <label class="text-xs text-gray-400 uppercase">Select Workout</label>
                <select name="workout_id" id="event-workout-select"
                    class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none">
                    <option value="">None</option>
                </select>
            </div>
            <div>
                <label class="text-xs text-gray-400 uppercase">Duration (minutes)</label>
                <input type="number" name="duration" value="60" min="15" step="15"
                    class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none">
            </div>
            <input type="hidden" name="date" id="event-date-input">
            <button type="submit"
                class="w-full py-3 bg-primary text-white font-bold rounded-xl hover:bg-primary/80 transition">
                Add to Schedule
            </button>
        </form>
    </div>
</div>

<!-- Availability Settings Modal -->
<div id="availability-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50 backdrop-blur-sm">
    <div class="glass-card w-full max-w-md mx-4 p-6 rounded-2xl relative max-h-[90vh] overflow-y-auto">
        <button onclick="closeAvailabilityModal()" class="absolute top-4 right-4 text-white/50 hover:text-white">‚úï</button>
        <h3 class="text-xl font-bold mb-2 text-center">1-on-1 Availability</h3>
        <p class="text-xs text-gray-400 text-center mb-4">Set your weekly hours for client bookings</p>

        <div id="availability-days" class="space-y-3">
            <!-- Days will be generated by JS or hardcoded -->
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-day="0" class="day-toggle w-5 h-5 rounded accent-orange-500">
                    <span class="font-bold text-sm">Monday</span>
                </label>
                <div class="day-times hidden grid grid-cols-2 gap-2 mt-2" data-day="0">
                    <div><label class="text-[10px] text-gray-400">Start</label><input type="time" class="start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="09:00"></div>
                    <div><label class="text-[10px] text-gray-400">End</label><input type="time" class="end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="17:00"></div>
                </div>
            </div>
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-day="1" class="day-toggle w-5 h-5 rounded accent-orange-500">
                    <span class="font-bold text-sm">Tuesday</span>
                </label>
                <div class="day-times hidden grid grid-cols-2 gap-2 mt-2" data-day="1">
                    <div><label class="text-[10px] text-gray-400">Start</label><input type="time" class="start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="09:00"></div>
                    <div><label class="text-[10px] text-gray-400">End</label><input type="time" class="end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="17:00"></div>
                </div>
            </div>
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-day="2" class="day-toggle w-5 h-5 rounded accent-orange-500">
                    <span class="font-bold text-sm">Wednesday</span>
                </label>
                <div class="day-times hidden grid grid-cols-2 gap-2 mt-2" data-day="2">
                    <div><label class="text-[10px] text-gray-400">Start</label><input type="time" class="start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="09:00"></div>
                    <div><label class="text-[10px] text-gray-400">End</label><input type="time" class="end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="17:00"></div>
                </div>
            </div>
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-day="3" class="day-toggle w-5 h-5 rounded accent-orange-500">
                    <span class="font-bold text-sm">Thursday</span>
                </label>
                <div class="day-times hidden grid grid-cols-2 gap-2 mt-2" data-day="3">
                    <div><label class="text-[10px] text-gray-400">Start</label><input type="time" class="start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="09:00"></div>
                    <div><label class="text-[10px] text-gray-400">End</label><input type="time" class="end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="17:00"></div>
                </div>
            </div>
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-day="4" class="day-toggle w-5 h-5 rounded accent-orange-500">
                    <span class="font-bold text-sm">Friday</span>
                </label>
                <div class="day-times hidden grid grid-cols-2 gap-2 mt-2" data-day="4">
                    <div><label class="text-[10px] text-gray-400">Start</label><input type="time" class="start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="09:00"></div>
                    <div><label class="text-[10px] text-gray-400">End</label><input type="time" class="end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="17:00"></div>
                </div>
            </div>
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-day="5" class="day-toggle w-5 h-5 rounded accent-orange-500">
                    <span class="font-bold text-sm">Saturday</span>
                </label>
                <div class="day-times hidden grid grid-cols-2 gap-2 mt-2" data-day="5">
                    <div><label class="text-[10px] text-gray-400">Start</label><input type="time" class="start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="10:00"></div>
                    <div><label class="text-[10px] text-gray-400">End</label><input type="time" class="end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="14:00"></div>
                </div>
            </div>
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-day="6" class="day-toggle w-5 h-5 rounded accent-orange-500">
                    <span class="font-bold text-sm">Sunday</span>
                </label>
                <div class="day-times hidden grid grid-cols-2 gap-2 mt-2" data-day="6">
                    <div><label class="text-[10px] text-gray-400">Start</label><input type="time" class="start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="10:00"></div>
                    <div><label class="text-[10px] text-gray-400">End</label><input type="time" class="end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="14:00"></div>
                </div>
            </div>
        </div>

        <button onclick="saveAvailability()"
            class="w-full mt-4 py-3 bg-orange-500 text-white font-bold rounded-xl hover:bg-orange-600 transition">
            Save Availability
        </button>
    </div>
</div>

<script>
// ============ SECTION SWITCHING ============
let currentSection = 'dashboard';
let scheduleInitialized = false;
let coursesInitialized = false;
let settingsInitialized = false;

function switchSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('.trainer-section').forEach(section => {
        section.classList.add('hidden');
    });

    // Show target section
    const targetSection = document.getElementById(`section-${sectionId}`);
    if (targetSection) {
        targetSection.classList.remove('hidden');
    }

    // Update sidebar nav state
    document.querySelectorAll('.sidebar-nav-item').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.section === sectionId) {
            btn.classList.add('active');
        }
    });

    // Update URL hash
    history.replaceState(null, '', `#${sectionId}`);

    // Initialize section-specific content
    initSection(sectionId);

    currentSection = sectionId;
}

function initSection(sectionId) {
    switch(sectionId) {
        case 'schedule':
            if (!scheduleInitialized) {
                initScheduleSection();
                scheduleInitialized = true;
            }
            break;
        case 'courses':
            if (!coursesInitialized) {
                initCoursesSection();
                coursesInitialized = true;
            }
            break;
        case 'settings':
            if (!settingsInitialized) {
                initSettingsSection();
                settingsInitialized = true;
            }
            break;
    }
}

// ============ SCHEDULE SECTION ============
let currentSchedule = [];
let currentWeekMonday = new Date();
let selectedDateStr;

const toLocalISO = (d) => {
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
};

function initScheduleSection() {
    const username = localStorage.getItem('username') || 'Trainer';
    const nameEl = document.getElementById('personal-name');
    if (nameEl) nameEl.textContent = username;

    // Initialize calendar
    const day = currentWeekMonday.getDay() || 7;
    if (day !== 1) currentWeekMonday.setHours(-24 * (day - 1));
    currentWeekMonday.setHours(0, 0, 0, 0);
    selectedDateStr = toLocalISO(new Date());

    fetchScheduleData();

    // Notes auto-save
    const notesArea = document.getElementById('personal-notes');
    if (notesArea) {
        const savedNotes = localStorage.getItem(`personal_notes_${username}`);
        if (savedNotes) notesArea.value = savedNotes;
        let saveTimeout;
        notesArea.addEventListener('input', () => {
            const indicator = document.getElementById('personal-notes-saved-indicator');
            if (indicator) indicator.style.opacity = '0';
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                localStorage.setItem(`personal_notes_${username}`, notesArea.value);
                if (indicator) indicator.style.opacity = '1';
            }, 1000);
        });
    }

    // Toggle buttons
    document.getElementById('toggle-my-workout-btn')?.addEventListener('click', () => {
        document.getElementById('my-workout-section')?.classList.toggle('hidden');
    });
    document.getElementById('toggle-my-split-btn')?.addEventListener('click', () => {
        document.getElementById('my-split-section')?.classList.toggle('hidden');
    });

    // Setup day toggles for availability modal
    setupDayToggles();
}

async function fetchScheduleData() {
    try {
        const res = await fetch('/api/trainer/data');
        const data = await res.json();
        currentSchedule = data.schedule || [];

        // Update streak
        const streakEl = document.getElementById('personal-streak');
        if (streakEl && data.streak !== undefined) streakEl.textContent = data.streak;

        // Render Today's Plan
        const planContainer = document.getElementById('todays-plan-container');
        const { gymId } = window.APP_CONFIG || { gymId: 'default' };
        if (planContainer && data.todays_workout) {
            const w = data.todays_workout;
            planContainer.innerHTML = `
                <div class="glass-card p-5 relative overflow-hidden group tap-effect cursor-pointer" onclick="window.location.href='/?gym_id=${gymId}&role=trainer&mode=workout${w.completed ? '&view=completed' : ''}'">
                    <div class="absolute inset-0 bg-primary opacity-20 group-hover:opacity-30 transition"></div>
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-4">
                            <span class="bg-white/10 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider">Today's Plan</span>
                            <span class="text-xl">${w.completed ? '‚úÖ' : 'üí™'}</span>
                        </div>
                        <h3 class="text-2xl font-black italic uppercase mb-1">${w.title}</h3>
                        <p class="text-sm text-gray-300 mb-4">${w.duration || 60} min ‚Ä¢ ${w.difficulty || 'Intermediate'}</p>
                        <button class="block w-full py-3 ${w.completed ? 'bg-green-500 text-white' : 'bg-white text-black hover:bg-gray-200'} text-center font-bold rounded-xl transition">${w.completed ? 'COMPLETED ‚úì' : 'START SESSION'}</button>
                    </div>
                </div>
            `;
        }

        // Render workouts
        const workoutContainer = document.getElementById('my-workout-card-container');
        if (workoutContainer && data.workouts) {
            if (data.workouts.length === 0) {
                workoutContainer.innerHTML = '<p class="text-xs text-gray-500 italic text-center py-2">No workouts created yet.</p>';
            } else {
                workoutContainer.innerHTML = data.workouts.map(w => `
                    <div class="glass-card p-3 mb-2">
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <h4 class="font-bold text-sm text-white">${w.title}</h4>
                                <p class="text-[10px] text-gray-400">${w.duration || 60} min ‚Ä¢ ${w.difficulty || 'Intermediate'}</p>
                            </div>
                        </div>
                        <button class="w-full py-1.5 bg-green-600/20 hover:bg-green-600 text-green-400 hover:text-white text-xs font-bold rounded-lg transition border border-green-500/30"
                            onclick="window.assignWorkoutToSelf && window.assignWorkoutToSelf('${w.id}', '${w.title}')">‚úÖ Assign to Me (Today)</button>
                    </div>
                `).join('');
            }
        }

        // Render splits
        const splitContainer = document.getElementById('my-split-card-container');
        if (splitContainer && data.splits) {
            if (data.splits.length === 0) {
                splitContainer.innerHTML = '<p class="text-xs text-gray-500 italic text-center py-2">No splits created yet.</p>';
            } else {
                splitContainer.innerHTML = data.splits.map(s => `
                    <div class="glass-card p-3 mb-2">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-sm text-white">${s.name}</h4>
                                <p class="text-[10px] text-gray-400">${s.description || 'No description'}</p>
                            </div>
                            <span class="text-[10px] bg-primary/20 text-primary px-2 py-0.5 rounded">${s.days_per_week} Days</span>
                        </div>
                    </div>
                `).join('');
            }
        }

        renderCalendarStrip();
        renderSchedule(selectedDateStr);
    } catch (e) {
        console.error("Error fetching schedule data:", e);
    }
}

window.changeWeek = function(offset) {
    currentWeekMonday.setDate(currentWeekMonday.getDate() + (offset * 7));
    selectedDateStr = toLocalISO(currentWeekMonday);
    renderCalendarStrip();
    renderSchedule(selectedDateStr);
};

function renderCalendarStrip() {
    const daysContainer = document.getElementById('calendar-strip');
    if (!daysContainer) return;
    daysContainer.innerHTML = '';
    const monthLabel = document.getElementById('month-label');
    if (monthLabel) monthLabel.innerText = currentWeekMonday.toLocaleDateString('en-US', { month: 'short' });

    for (let i = 0; i < 7; i++) {
        const d = new Date(currentWeekMonday);
        d.setDate(currentWeekMonday.getDate() + i);
        const dateStr = toLocalISO(d);
        const isSelected = dateStr === selectedDateStr;
        const isToday = dateStr === toLocalISO(new Date());

        const div = document.createElement('div');
        div.className = `flex flex-col items-center p-2 rounded cursor-pointer transition ${isSelected ? 'bg-white/10 text-white' : 'text-white/40 hover:bg-white/5'}`;
        if (isToday && !isSelected) div.classList.add('border', 'border-white/10');

        const dayName = d.toLocaleDateString('en-US', { weekday: 'narrow' });
        const dayNum = d.getDate();
        const hasEvents = currentSchedule.some(e => e.date === dateStr);
        const dot = hasEvents ? `<div class="w-1 h-1 rounded-full bg-primary mt-1"></div>` : '';

        div.innerHTML = `<span class="opacity-50">${dayName}</span><span>${dayNum}</span>${dot}`;
        div.onclick = () => {
            selectedDateStr = dateStr;
            renderCalendarStrip();
            renderSchedule(dateStr);
        };
        daysContainer.appendChild(div);
    }
}

function renderSchedule(dateStr) {
    const container = document.getElementById('schedule-container');
    if (!container) return;

    const [y, m, d] = dateStr.split('-').map(Number);
    const dateObj = new Date(y, m - 1, d);
    const dateEl = document.getElementById('current-full-date');
    if (dateEl) dateEl.innerText = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

    container.innerHTML = '';
    const dayEvents = currentSchedule.filter(e => e.date === dateStr).sort((a, b) => a.time.localeCompare(b.time));

    dayEvents.forEach(s => {
        const div = document.createElement('div');
        const opacityClass = s.completed ? 'opacity-50 grayscale' : '';
        div.className = `flex justify-between items-center bg-white/5 border border-white/5 rounded-xl p-3 group relative ${opacityClass}`;

        let colorClass = "text-blue-400 bg-blue-500/20";
        if (s.type === 'personal') colorClass = "text-green-400 bg-green-500/20";
        if (s.type === 'class') colorClass = "text-yellow-400 bg-yellow-500/20";
        if (s.type === '1on1_appointment') colorClass = "text-orange-400 bg-orange-500/20";

        let [h, min] = s.time.split(':');
        let ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12 || 12;

        div.innerHTML = `
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 rounded-lg ${colorClass} flex flex-col items-center justify-center">
                    <span class="font-bold text-lg leading-none">${h}</span>
                    <span class="text-[9px] uppercase">${ampm}</span>
                </div>
                <div>
                    <p class="text-[10px] text-white/30">${s.duration || 60} min</p>
                    <h4 class="font-bold text-sm text-white ${s.completed ? 'line-through text-white/50' : ''}">${s.title}</h4>
                    <p class="text-xs text-white/50">${s.subtitle || ''}</p>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <button onclick="toggleComplete('${s.id}')"
                    class="w-10 h-10 rounded-full flex items-center justify-center border-2 transition-all duration-300
                    ${s.completed ? 'bg-green-500 border-green-500 text-white' : 'border-white/20 text-transparent hover:border-white/50'}">
                    <span class="transform transition-transform duration-300 ${s.completed ? 'scale-100' : 'scale-0'}">‚úì</span>
                </button>
                <button onclick="deleteEvent('${s.id}')" class="text-red-500 opacity-0 group-hover:opacity-100 transition p-2 hover:bg-white/10 rounded-lg">‚úï</button>
            </div>
        `;
        container.appendChild(div);
    });

    // Add button
    const addDiv = document.createElement('div');
    addDiv.className = "flex items-center justify-center space-x-3 p-3 rounded-xl border border-white/20 border-dashed hover:bg-white/5 transition cursor-pointer py-4";
    addDiv.onclick = () => openAddModal(dateStr);
    addDiv.innerHTML = `<span class="text-2xl font-light mr-2">+</span><span class="font-bold text-sm text-white/60">Free Slot</span>`;
    container.appendChild(addDiv);
}

async function openAddModal(dateStr) {
    document.getElementById('event-date-input').value = dateStr;
    document.getElementById('add-event-modal').classList.remove('hidden');
}

window.deleteEvent = async function(id) {
    if (!confirm("Delete this event?")) return;
    try {
        const res = await fetch(`/api/trainer/events/${id}`, { method: 'DELETE' });
        if (res.ok) fetchScheduleData();
    } catch (e) { console.error(e); }
};

window.toggleComplete = async function(id) {
    try {
        const res = await fetch(`/api/trainer/events/${id}/toggle_complete`, { method: 'POST' });
        if (res.ok) fetchScheduleData();
    } catch (e) { console.error(e); }
};

// Add event form
document.getElementById('add-event-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    data.duration = parseInt(data.duration) || 60;

    try {
        const res = await fetch('/api/trainer/events', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        if (res.ok) {
            await fetchScheduleData();
            document.getElementById('add-event-modal').classList.add('hidden');
            e.target.reset();
        }
    } catch (err) { console.error(err); }
});

// ============ AVAILABILITY ============
function setupDayToggles() {
    document.querySelectorAll('.day-toggle').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const day = this.dataset.day;
            const timesDiv = document.querySelector(`.day-times[data-day="${day}"]`);
            if (timesDiv) {
                timesDiv.classList.toggle('hidden', !this.checked);
            }
        });
    });
}

window.openAvailabilityModal = async function() {
    document.getElementById('availability-modal').classList.remove('hidden');
    await loadAvailability();
};

window.closeAvailabilityModal = function() {
    document.getElementById('availability-modal').classList.add('hidden');
};

async function loadAvailability() {
    try {
        const res = await fetch('/api/trainer/availability');
        const slots = await res.json();

        document.querySelectorAll('.day-toggle').forEach(cb => cb.checked = false);
        document.querySelectorAll('.day-times').forEach(div => div.classList.add('hidden'));

        slots.forEach(slot => {
            const checkbox = document.querySelector(`.day-toggle[data-day="${slot.day_of_week}"]`);
            const timesDiv = document.querySelector(`.day-times[data-day="${slot.day_of_week}"]`);
            if (checkbox && timesDiv) {
                checkbox.checked = true;
                timesDiv.classList.remove('hidden');
                timesDiv.querySelector('.start-time').value = slot.start_time;
                timesDiv.querySelector('.end-time').value = slot.end_time;
            }
        });
    } catch (e) { console.error('Error loading availability:', e); }
}

window.saveAvailability = async function() {
    const availability = [];
    document.querySelectorAll('.day-toggle:checked').forEach(checkbox => {
        const day = parseInt(checkbox.dataset.day);
        const timesDiv = document.querySelector(`.day-times[data-day="${day}"]`);
        if (timesDiv) {
            availability.push({
                day_of_week: day,
                start_time: timesDiv.querySelector('.start-time').value,
                end_time: timesDiv.querySelector('.end-time').value
            });
        }
    });

    try {
        const res = await fetch('/api/trainer/availability', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ availability })
        });
        if (res.ok) {
            closeAvailabilityModal();
            alert('Availability saved!');
        }
    } catch (e) { console.error('Error saving availability:', e); }
};

// ============ COURSES SECTION ============
function initCoursesSection() {
    if (typeof window.loadCoursesPage === 'function') {
        window.loadCoursesPage();
    }

    // Toggle exercise library
    const toggleBtn = document.getElementById('toggle-course-exercises-btn');
    const exercisesSection = document.getElementById('course-exercises-section');
    const chevron = document.getElementById('course-exercises-chevron');

    if (toggleBtn && exercisesSection) {
        toggleBtn.addEventListener('click', () => {
            const isOpen = exercisesSection.style.maxHeight !== '0px';
            if (isOpen) {
                exercisesSection.style.maxHeight = '0';
                exercisesSection.style.opacity = '0';
                chevron.style.transform = 'rotate(0deg)';
            } else {
                exercisesSection.style.maxHeight = '2000px';
                exercisesSection.style.opacity = '1';
                chevron.style.transform = 'rotate(180deg)';
                if (typeof window.loadCourseExercises === 'function') {
                    window.loadCourseExercises();
                }
            }
        });
    }

    // Search
    document.getElementById('course-exercise-search')?.addEventListener('input', (e) => {
        if (typeof window.filterCourseExercisesBySearch === 'function') {
            window.filterCourseExercisesBySearch(e.target.value);
        }
    });
}

// ============ SETTINGS SECTION ============
function initSettingsSection() {
    const username = localStorage.getItem('username') || 'Trainer';
    document.getElementById('settings-trainer-name').textContent = username;
    document.getElementById('settings-profile-pic').textContent = username.charAt(0).toUpperCase();

    // Load bio
    loadBio();
    loadSpecialties();

    // Specialty checkbox styling
    document.querySelectorAll('.specialty-checkbox').forEach(cb => {
        cb.addEventListener('change', function() {
            const span = this.nextElementSibling;
            if (this.checked) {
                span.classList.remove('bg-white/5', 'text-white/60');
                span.classList.add('bg-primary/20', 'text-primary', 'border-primary/30');
            } else {
                span.classList.add('bg-white/5', 'text-white/60');
                span.classList.remove('bg-primary/20', 'text-primary', 'border-primary/30');
            }
        });
    });
}

async function loadBio() {
    try {
        const res = await fetch('/api/profile/bio');
        if (res.ok) {
            const data = await res.json();
            document.getElementById('settings-bio').value = data.bio || '';
        }
    } catch (e) { console.error('Error loading bio:', e); }
}

window.saveBio = async function() {
    const bio = document.getElementById('settings-bio').value;
    try {
        const res = await fetch('/api/profile/bio', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ bio })
        });
        if (res.ok) alert('Bio saved!');
    } catch (e) { console.error('Error saving bio:', e); }
};

async function loadSpecialties() {
    try {
        const res = await fetch('/api/profile/specialties');
        if (res.ok) {
            const data = await res.json();
            const specialties = data.specialties || [];
            document.querySelectorAll('.specialty-checkbox').forEach(cb => {
                cb.checked = specialties.includes(cb.value);
                cb.dispatchEvent(new Event('change'));
            });
        }
    } catch (e) { console.error('Error loading specialties:', e); }
}

window.saveSpecialties = async function() {
    const specialties = [];
    document.querySelectorAll('.specialty-checkbox:checked').forEach(cb => {
        specialties.push(cb.value);
    });
    try {
        const res = await fetch('/api/profile/specialties', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ specialties })
        });
        if (res.ok) alert('Specialties saved!');
    } catch (e) { console.error('Error saving specialties:', e); }
};

window.uploadProfilePicture = async function(input) {
    if (!input.files[0]) return;
    const formData = new FormData();
    formData.append('file', input.files[0]);
    try {
        const res = await fetch('/api/profile/picture', {
            method: 'POST',
            body: formData
        });
        if (res.ok) {
            const data = await res.json();
            if (data.url) {
                document.getElementById('settings-profile-pic').innerHTML = `<img src="${data.url}" class="w-full h-full object-cover rounded-full">`;
            }
        }
    } catch (e) { console.error('Error uploading picture:', e); }
};

// ============ INITIALIZATION ============
document.addEventListener('DOMContentLoaded', () => {
    // Update sidebar name
    const username = localStorage.getItem('username') || 'Trainer';
    const sidebarName = document.getElementById('sidebar-trainer-name');
    if (sidebarName) sidebarName.textContent = `Coach ${username}`;

    // Handle hash navigation
    const hash = window.location.hash.replace('#', '');
    if (hash && ['dashboard', 'schedule', 'courses', 'settings'].includes(hash)) {
        switchSection(hash);
    }

    // Show exercises on desktop
    if (window.innerWidth >= 1024) {
        const section = document.getElementById('exercises-section');
        if (section) section.style.display = 'flex';
    }

    window.addEventListener('resize', () => {
        const section = document.getElementById('exercises-section');
        if (section && window.innerWidth >= 1024) {
            section.style.display = 'flex';
        }
    });
});

// Expose functions globally
window.switchSection = switchSection;
</script>

{% endblock %}
