<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <title>{{ course_name }} - Workout Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
    </style>
</head>
<body class="bg-gray-900 overflow-y-auto">

<!-- Course Workout Player - Music + Exercises Integration -->
<div class="min-h-screen bg-gradient-to-b from-gray-900 via-gray-900 to-black text-white">

    <!-- Header -->
    <div class="sticky top-0 z-50 bg-black/80 backdrop-blur-xl border-b border-white/10 px-4 py-3">
        <div class="flex items-center justify-between max-w-4xl mx-auto">
            <button onclick="exitWorkout()" class="flex items-center gap-2 text-white/70 hover:text-white transition">
                <i data-lucide="chevron-left" class="w-5 h-5"></i>
                <span class="text-sm font-medium">Exit</span>
            </button>
            <h1 id="course-title" class="text-lg font-bold">Course Workout</h1>
            <div class="w-16"></div> <!-- Spacer for centering -->
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto px-4 py-6 pb-32 space-y-6">

        <!-- Music Player Section -->
        <div id="music-player-section" class="bg-gradient-to-br from-purple-500/20 to-pink-500/20 rounded-3xl p-6 border border-purple-500/30">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center">
                    <i data-lucide="music" class="w-5 h-5"></i>
                </div>
                <div>
                    <h2 class="text-lg font-bold">Workout Playlist</h2>
                    <p class="text-xs text-white/60" id="playlist-name">Loading...</p>
                </div>
            </div>

            <!-- Embedded Music Player -->
            <div id="music-player-container" class="rounded-2xl overflow-hidden bg-black/30">
                <p class="text-center text-white/50 py-8 text-sm">No playlist selected</p>
            </div>

            <!-- Playlist Selector (if multiple playlists) -->
            <div id="playlist-selector" class="mt-4 hidden"></div>
        </div>

        <!-- Workout Controls -->
        <div class="bg-white/5 rounded-3xl p-6 border border-white/10">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <p class="text-xs text-white/50 uppercase tracking-wider mb-1">Current Exercise</p>
                    <h3 id="current-exercise-name" class="text-2xl font-bold">Ready to Start</h3>
                </div>
                <div class="text-right">
                    <p class="text-xs text-white/50 uppercase tracking-wider mb-1">Time</p>
                    <div id="exercise-timer" class="text-3xl font-bold text-orange-400">--:--</div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="w-full bg-white/10 rounded-full h-2 mb-6 overflow-hidden">
                <div id="workout-progress" class="bg-gradient-to-r from-orange-500 to-pink-500 h-full transition-all duration-300" style="width: 0%"></div>
            </div>

            <!-- Control Buttons -->
            <div class="grid grid-cols-3 gap-3">
                <button onclick="previousExercise()" id="btn-previous"
                    class="bg-white/10 hover:bg-white/20 rounded-xl py-4 flex flex-col items-center gap-2 transition disabled:opacity-30 disabled:cursor-not-allowed">
                    <i data-lucide="skip-back" class="w-6 h-6"></i>
                    <span class="text-xs">Previous</span>
                </button>

                <button onclick="togglePlayPause()" id="btn-play-pause"
                    class="bg-gradient-to-br from-orange-500 to-pink-500 hover:opacity-90 rounded-xl py-4 flex flex-col items-center gap-2 transition shadow-lg shadow-orange-500/30">
                    <i data-lucide="play" class="w-8 h-8"></i>
                    <span class="text-sm font-bold">Start</span>
                </button>

                <button onclick="nextExercise()" id="btn-next"
                    class="bg-white/10 hover:bg-white/20 rounded-xl py-4 flex flex-col items-center gap-2 transition disabled:opacity-30 disabled:cursor-not-allowed">
                    <i data-lucide="skip-forward" class="w-6 h-6"></i>
                    <span class="text-xs">Next</span>
                </button>
            </div>
        </div>

        <!-- Exercise List -->
        <div class="bg-white/5 rounded-3xl p-6 border border-white/10">
            <h3 class="text-sm font-bold text-white/70 uppercase tracking-wider mb-4 flex items-center gap-2">
                <i data-lucide="list" class="w-4 h-4"></i>
                Exercise Sequence
            </h3>
            <div id="exercise-list" class="space-y-2">
                <p class="text-center text-white/50 py-4 text-sm">Loading exercises...</p>
            </div>
        </div>

    </div>

</div>

<script>
// Course Workout Player - Music + Exercise Integration
const courseId = "{{ course_id }}";
let courseData = null;
let exercises = [];
let currentExerciseIndex = 0;
let isPlaying = false;
let exerciseTimer = null;
let remainingSeconds = 0;
let selectedPlaylist = null;

// Initialize
async function initWorkout() {
    try {
        // Fetch course data
        const res = await fetch(`/api/client/courses/${courseId}/lessons`, { credentials: 'include' });
        courseData = await res.json();

        if (!courseData || !courseData.exercises || courseData.exercises.length === 0) {
            alert('No exercises found for this course');
            return;
        }

        exercises = courseData.exercises;

        // Set course title
        document.getElementById('course-title').innerText = courseData.name || 'Course Workout';

        // Load music player
        loadMusicPlayer();

        // Render exercise list
        renderExerciseList();

        // Set first exercise
        setCurrentExercise(0);

    } catch (error) {
        console.error('Failed to load workout:', error);
        alert('Failed to load workout. Please try again.');
    }
}

function loadMusicPlayer() {
    const playlists = courseData.music_links || [];

    if (playlists.length === 0) {
        document.getElementById('music-player-container').innerHTML =
            '<p class="text-center text-white/50 py-8 text-sm">No playlists added to this course</p>';
        return;
    }

    // Select first playlist by default
    selectedPlaylist = playlists[0];
    loadPlaylist(selectedPlaylist);

    // Show playlist selector if multiple playlists
    if (playlists.length > 1) {
        const selector = document.getElementById('playlist-selector');
        selector.classList.remove('hidden');
        selector.innerHTML = `
            <p class="text-xs text-white/50 mb-2">Choose Playlist:</p>
            <div class="grid grid-cols-2 gap-2">
                ${playlists.map((playlist, i) => `
                    <button onclick="selectPlaylist(${i})"
                        class="playlist-btn bg-white/10 hover:bg-white/20 rounded-xl p-3 text-left transition ${i === 0 ? 'ring-2 ring-purple-500' : ''}"
                        data-playlist="${i}">
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full ${playlist.type === 'spotify' ? 'bg-green-500' : 'bg-red-500'}"></span>
                            <span class="text-sm font-medium truncate">${playlist.title || 'Playlist ' + (i + 1)}</span>
                        </div>
                    </button>
                `).join('')}
            </div>
        `;
    }
}

function selectPlaylist(index) {
    const playlists = courseData.music_links;
    selectedPlaylist = playlists[index];
    loadPlaylist(selectedPlaylist);

    // Update button styles
    document.querySelectorAll('.playlist-btn').forEach((btn, i) => {
        if (i === index) {
            btn.classList.add('ring-2', 'ring-purple-500');
        } else {
            btn.classList.remove('ring-2', 'ring-purple-500');
        }
    });
}

function loadPlaylist(playlist) {
    const container = document.getElementById('music-player-container');
    document.getElementById('playlist-name').innerText = playlist.title || 'Workout Mix';

    const embedUrl = getMusicEmbedUrl(playlist.url, playlist.type);

    if (!embedUrl) {
        container.innerHTML = '<p class="text-center text-white/50 py-8 text-sm">Invalid playlist URL</p>';
        return;
    }

    // Embed music player
    if (playlist.type === 'spotify') {
        container.innerHTML = `
            <iframe style="border-radius:12px" src="${embedUrl}"
                width="100%" height="352" frameBorder="0"
                allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                loading="lazy"></iframe>
        `;
    } else if (playlist.type === 'youtube') {
        container.innerHTML = `
            <iframe width="100%" height="315" src="${embedUrl}"
                frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen></iframe>
        `;
    }
}

function getMusicEmbedUrl(url, type) {
    if (!url) return null;

    if (type === 'spotify') {
        const match = url.match(/spotify\.com\/(playlist|album|track)\/([a-zA-Z0-9]+)/);
        if (match) {
            return `https://open.spotify.com/embed/${match[1]}/${match[2]}?utm_source=generator&theme=0`;
        }
    } else if (type === 'youtube') {
        let playlistId = null;

        if (url.includes('list=')) {
            const match = url.match(/list=([a-zA-Z0-9_-]+)/);
            if (match) playlistId = match[1];
        }

        if (playlistId) {
            return `https://www.youtube.com/embed/videoseries?list=${playlistId}&autoplay=1`;
        }
    }

    return null;
}

function renderExerciseList() {
    const container = document.getElementById('exercise-list');
    container.innerHTML = exercises.map((ex, i) => `
        <div class="exercise-item flex items-center gap-3 p-3 rounded-xl transition ${i === currentExerciseIndex ? 'bg-orange-500/20 border-2 border-orange-500' : 'bg-white/5 border-2 border-transparent'}"
            data-index="${i}">
            <div class="w-8 h-8 rounded-full ${i === currentExerciseIndex ? 'bg-orange-500' : 'bg-white/10'} flex items-center justify-center flex-shrink-0">
                <span class="text-sm font-bold">${i + 1}</span>
            </div>
            <div class="flex-1 min-w-0">
                <p class="font-medium truncate">${ex.name}</p>
                <p class="text-xs text-white/50">${ex.duration || 30}s â€¢ ${ex.type || 'Exercise'}</p>
            </div>
            ${i < currentExerciseIndex ? '<i data-lucide="check-circle" class="w-5 h-5 text-green-400 flex-shrink-0"></i>' : ''}
        </div>
    `).join('');

    // Re-init icons
    if (typeof lucide !== 'undefined') lucide.createIcons();
}

function setCurrentExercise(index) {
    if (index < 0 || index >= exercises.length) return;

    currentExerciseIndex = index;
    const exercise = exercises[index];

    document.getElementById('current-exercise-name').innerText = exercise.name;
    remainingSeconds = exercise.duration || 30;
    updateTimerDisplay();
    renderExerciseList();

    // Update progress
    const progress = ((index + 1) / exercises.length) * 100;
    document.getElementById('workout-progress').style.width = progress + '%';

    // Enable/disable navigation buttons
    document.getElementById('btn-previous').disabled = index === 0;
    document.getElementById('btn-next').disabled = index === exercises.length - 1;
}

function togglePlayPause() {
    if (isPlaying) {
        pauseWorkout();
    } else {
        startWorkout();
    }
}

function startWorkout() {
    isPlaying = true;
    const btn = document.getElementById('btn-play-pause');
    btn.querySelector('i').setAttribute('data-lucide', 'pause');
    btn.querySelector('span').innerText = 'Pause';
    lucide.createIcons();

    // Start timer
    exerciseTimer = setInterval(() => {
        remainingSeconds--;
        updateTimerDisplay();

        if (remainingSeconds <= 0) {
            // Auto-advance to next exercise
            if (currentExerciseIndex < exercises.length - 1) {
                nextExercise();
            } else {
                // Workout complete!
                completeWorkout();
            }
        }
    }, 1000);
}

function pauseWorkout() {
    isPlaying = false;
    const btn = document.getElementById('btn-play-pause');
    btn.querySelector('i').setAttribute('data-lucide', 'play');
    btn.querySelector('span').innerText = 'Resume';
    lucide.createIcons();

    clearInterval(exerciseTimer);
}

function previousExercise() {
    if (currentExerciseIndex > 0) {
        pauseWorkout();
        setCurrentExercise(currentExerciseIndex - 1);
    }
}

function nextExercise() {
    if (currentExerciseIndex < exercises.length - 1) {
        pauseWorkout();
        setCurrentExercise(currentExerciseIndex + 1);
    }
}

function updateTimerDisplay() {
    const minutes = Math.floor(remainingSeconds / 60);
    const seconds = remainingSeconds % 60;
    document.getElementById('exercise-timer').innerText =
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function completeWorkout() {
    pauseWorkout();
    alert('Workout Complete! Great job! ðŸŽ‰');
    exitWorkout();
}

function exitWorkout() {
    if (isPlaying) {
        if (!confirm('Are you sure you want to exit? Your progress will not be saved.')) {
            return;
        }
    }
    window.history.back();
}

// Initialize on load
document.addEventListener('DOMContentLoaded', () => {
    initWorkout();
    lucide.createIcons();
});
</script>

</body>
</html>
