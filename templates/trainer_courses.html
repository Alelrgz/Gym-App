{% extends "base.html" %}

{% block content %}
<div class="p-4 pb-24">
    <!-- Header -->
    <div class="flex justify-between items-start mb-6">
        <div>
            <p class="text-xs text-white/60 uppercase tracking-wider">Trainer Dashboard</p>
            <h2 class="text-2xl font-bold">Group Courses</h2>
        </div>
        <div class="flex space-x-2">
            <div id="notification-bell" onclick="openNotificationsModal()"
                class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center tap-effect cursor-pointer relative">
                <i data-lucide="bell" class="w-5 h-5"></i>
                <span id="notification-badge" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">0</span>
            </div>
            <!-- Back Button -->
            <a href="{{ 'trainer.html' if static_build else '/?gym_id=' + gym_id + '&role=trainer' }}"
                class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center tap-effect cursor-pointer">
                ←
            </a>
        </div>
    </div>

    <!-- Stats Row -->
    <div class="grid grid-cols-3 gap-3 mb-6">
        <div class="glass-card p-4 flex flex-col items-center justify-center">
            <span class="text-2xl font-bold text-primary" id="total-courses-count">0</span>
            <span class="text-[10px] text-white/50 uppercase tracking-wider mt-1">Courses</span>
        </div>
        <div class="glass-card p-4 flex flex-col items-center justify-center">
            <span class="text-2xl font-bold text-green-400" id="lessons-this-week">0</span>
            <span class="text-[10px] text-white/50 uppercase tracking-wider mt-1">This Week</span>
        </div>
        <div class="glass-card p-4 flex flex-col items-center justify-center">
            <span class="text-2xl font-bold text-yellow-400" id="avg-engagement">-</span>
            <span class="text-[10px] text-white/50 uppercase tracking-wider mt-1">Avg Rating</span>
        </div>
    </div>

    <!-- Create Course Button -->
    <button data-action="openCreateCourse"
        class="w-full glass-card p-4 mb-6 flex items-center justify-center space-x-2 hover:bg-white/10 transition tap-effect border-2 border-dashed border-white/20 hover:border-primary/50">
        <span class="text-2xl">+</span>
        <span class="text-sm font-bold uppercase tracking-wider">Create New Course</span>
    </button>

    <!-- Courses List -->
    <div class="space-y-4">
        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Your Courses</h3>
        <div id="courses-page-list" class="space-y-3">
            <!-- Courses will be populated here -->
            <div class="glass-card p-6 text-center">
                <p class="text-gray-400 text-sm">Loading courses...</p>
            </div>
        </div>
    </div>

    <!-- Shared Courses Section -->
    <div class="mt-8 space-y-4">
        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Shared by Gym</h3>
        <div id="shared-courses-list" class="space-y-3">
            <!-- Shared courses will be populated here -->
            <div class="glass-card p-4 text-center">
                <p class="text-gray-400/50 text-xs">No shared courses from other trainers</p>
            </div>
        </div>
    </div>

    <!-- Course Exercise Library Section -->
    <div class="mt-8">
        <button id="toggle-course-exercises-btn"
            class="w-full glass-card p-4 flex items-center justify-between hover:bg-white/10 transition tap-effect">
            <div class="flex items-center space-x-3">
                <i data-lucide="footprints" class="w-5 h-5"></i>
                <div class="text-left">
                    <span class="text-sm font-bold uppercase tracking-wider">Exercise Library</span>
                    <p class="text-[10px] text-white/50">Create & manage exercises for your courses</p>
                </div>
            </div>
            <span id="course-exercises-chevron" class="text-white/40 text-sm transition-transform duration-300">▼</span>
        </button>

        <div id="course-exercises-section" class="overflow-hidden transition-all duration-300 ease-out mt-3" style="max-height: 0; opacity: 0;">
            <!-- Create Exercise Button -->
            <button onclick="openCourseExerciseModal()"
                class="w-full glass-card p-3 mb-4 flex items-center justify-center space-x-2 hover:bg-white/10 transition tap-effect border-2 border-dashed border-white/20 hover:border-green-500/50">
                <span class="text-lg">+</span>
                <span class="text-xs font-bold uppercase tracking-wider">Create New Exercise</span>
            </button>

            <!-- Category Filter -->
            <div class="flex flex-wrap gap-2 mb-4">
                <button onclick="filterCourseExercises('all')" data-filter="all"
                    class="course-ex-filter-btn active px-3 py-1.5 text-xs rounded-full bg-primary/20 text-primary border border-primary/30 transition">
                    All
                </button>
                <button onclick="filterCourseExercises('yoga')" data-filter="yoga"
                    class="course-ex-filter-btn px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition">
                    <i data-lucide="heart" class="w-3.5 h-3.5 inline-block align-middle stroke-current"></i> Yoga
                </button>
                <button onclick="filterCourseExercises('pilates')" data-filter="pilates"
                    class="course-ex-filter-btn px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition">
                    <i data-lucide="person-standing" class="w-3.5 h-3.5 inline-block align-middle stroke-current"></i> Pilates
                </button>
                <button onclick="filterCourseExercises('stretch')" data-filter="stretch"
                    class="course-ex-filter-btn px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition">
                    <i data-lucide="move" class="w-3.5 h-3.5 inline-block align-middle stroke-current"></i> Stretch
                </button>
                <button onclick="filterCourseExercises('cardio')" data-filter="cardio"
                    class="course-ex-filter-btn px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition">
                    <i data-lucide="footprints" class="w-3.5 h-3.5 inline-block align-middle stroke-current"></i> Cardio
                </button>
                <button onclick="filterCourseExercises('warmup')" data-filter="warmup"
                    class="course-ex-filter-btn px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition">
                    <i data-lucide="flame" class="w-3.5 h-3.5 inline-block align-middle stroke-current"></i> Warmup
                </button>
                <button onclick="filterCourseExercises('cooldown')" data-filter="cooldown"
                    class="course-ex-filter-btn px-3 py-1.5 text-xs rounded-full bg-white/5 text-white/60 border border-white/10 hover:bg-white/10 transition">
                    <i data-lucide="snowflake" class="w-3.5 h-3.5 inline-block align-middle stroke-current"></i> Cooldown
                </button>
            </div>

            <!-- Search -->
            <div class="relative mb-4">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-white/30 text-sm"><i data-lucide="search" class="w-4 h-4"></i></span>
                <input type="text" id="course-exercise-search" placeholder="Search exercises..."
                    class="w-full bg-white/5 border border-white/10 rounded-xl pl-9 pr-3 py-2.5 text-sm text-white outline-none focus:border-white/25 focus:bg-white/10 transition placeholder-white/30">
            </div>

            <!-- Exercise Grid -->
            <div id="course-exercise-library" class="grid grid-cols-2 gap-3 max-h-96 overflow-y-auto pr-1">
                <!-- Exercises will be populated here -->
                <div class="col-span-2 glass-card p-6 text-center">
                    <p class="text-gray-400/50 text-xs">Loading exercises...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Notification functions
async function openNotificationsModal() {
    window.showModal('notification-modal');
    await loadNotifications();
}

async function loadNotifications() {
    const list = document.getElementById('notifications-list');
    if (!list) return;
    try {
        const res = await fetch('/api/notifications?limit=20');
        const notifications = await res.json();
        if (notifications.length === 0) {
            list.innerHTML = '<div class="text-center text-gray-400 py-8"><i data-lucide="bell" class="w-10 h-10 mb-2 block"></i><p class="text-sm">No notifications yet</p></div>';
            return;
        }
        list.innerHTML = notifications.map(n => {
            const icon = getNotifIcon(n.type);
            const unreadClass = n.read ? 'opacity-60' : 'border-l-2 border-orange-500';
            return `<div class="flex items-start space-x-3 p-3 bg-white/5 rounded-xl ${unreadClass}"><span class="text-xl">${icon}</span><div class="flex-1 min-w-0"><p class="text-sm font-bold text-white">${n.title}</p><p class="text-xs text-gray-400 truncate">${n.message}</p></div></div>`;
        }).join('');
    } catch (e) {
        console.error('Error loading notifications:', e);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    // Load courses when page loads
    if (typeof window.loadCoursesPage === 'function') {
        window.loadCoursesPage();
    } else {
        // Fallback: wait for app.js to load
        setTimeout(() => {
            if (typeof window.loadCoursesPage === 'function') {
                window.loadCoursesPage();
            }
        }, 500);
    }

    // Toggle exercise library section
    const toggleBtn = document.getElementById('toggle-course-exercises-btn');
    const exercisesSection = document.getElementById('course-exercises-section');
    const chevron = document.getElementById('course-exercises-chevron');

    if (toggleBtn && exercisesSection) {
        toggleBtn.addEventListener('click', () => {
            const isOpen = exercisesSection.style.maxHeight !== '0px';
            if (isOpen) {
                exercisesSection.style.maxHeight = '0';
                exercisesSection.style.opacity = '0';
                chevron.style.transform = 'rotate(0deg)';
            } else {
                exercisesSection.style.maxHeight = '2000px';
                exercisesSection.style.opacity = '1';
                chevron.style.transform = 'rotate(180deg)';
                // Load exercises when opened
                if (typeof window.loadCourseExercises === 'function') {
                    window.loadCourseExercises();
                }
            }
        });
    }

    // Exercise search
    const searchInput = document.getElementById('course-exercise-search');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            if (typeof window.filterCourseExercisesBySearch === 'function') {
                window.filterCourseExercisesBySearch(e.target.value);
            }
        });
    }
});
</script>
{% endblock %}
