{% extends "base.html" %}
{% from 'macros.html' import card %}

{% block content %}
<!-- Desktop Navigation Bar (hidden on mobile) -->
<nav class="hidden lg:flex items-center justify-between px-8 py-4 border-b border-white/10 mb-6">
    <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
            </svg>
        </div>
        <div>
            <p class="label-uppercase text-[10px]">Staff</p>
            <h1 class="text-lg font-bold">Reception</h1>
        </div>
    </div>
    <div class="flex items-center gap-2">
        <a href="{{ 'staff.html' if static_build else '/?gym_id=' + gym_id + '&role=staff' }}"
           class="px-4 py-2 rounded-xl text-sm font-semibold transition {{ 'bg-primary/20 text-primary border border-primary/30' if mode != 'settings' else 'text-white/60 hover:bg-white/5' }}">
            üè† Dashboard
        </a>
        <a href="{{ 'staff.html' if static_build else '/?gym_id=' + gym_id + '&role=staff&mode=settings' }}"
           class="px-4 py-2 rounded-xl text-sm font-semibold transition {{ 'bg-primary/20 text-primary border border-primary/30' if mode == 'settings' else 'text-white/60 hover:bg-white/5' }}">
            ‚öôÔ∏è Settings
        </a>
        <div class="w-px h-6 bg-white/10 mx-2"></div>
        <a href="/auth/logout" class="px-4 py-2 rounded-xl text-sm font-semibold text-red-400 hover:bg-red-500/10 transition">
            üö™ Logout
        </a>
    </div>
</nav>

<div class="p-4 md:p-6 lg:p-8 lg:pt-0 pt-8 md:pt-10 max-w-7xl mx-auto">
    <h2 class="text-xl md:text-2xl lg:text-3xl font-bold text-center lg:text-left mb-6 lg:mb-8" id="page-title">{{ 'Settings' if mode == 'settings' else 'Reception Dashboard' }}</h2>

    {% if mode == 'settings' %}
    <!-- ==================== SETTINGS MODE ==================== -->
    <div class="max-w-4xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left: Profile Card (larger on desktop) -->
            <div class="lg:col-span-1">
                {% call card(classes="p-6 lg:p-8") %}
                <div class="text-center">
                    <div class="w-24 h-24 lg:w-32 lg:h-32 rounded-full bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center mx-auto mb-4">
                        <svg class="w-12 h-12 lg:w-16 lg:h-16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                    </div>
                    <h3 class="text-xl lg:text-2xl font-bold text-white mb-1" id="staff-name">Staff Member</h3>
                    <p class="text-sm lg:text-base text-gray-400">Reception / Staff</p>
                </div>
                {% endcall %}
            </div>

            <!-- Right: Account Info & Actions -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Account Info -->
                {% call card(classes="p-5 lg:p-6") %}
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Account Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex justify-between items-center p-3 bg-white/5 rounded-xl">
                        <span class="text-gray-400">Role</span>
                        <span class="text-white font-semibold">Staff / Reception</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-white/5 rounded-xl">
                        <span class="text-gray-400">Gym</span>
                        <span class="text-white font-semibold" id="gym-name-display">Loading...</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-white/5 rounded-xl">
                        <span class="text-gray-400">Status</span>
                        <span class="text-green-400 font-semibold flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-green-400"></span>
                            Active
                        </span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-white/5 rounded-xl">
                        <span class="text-gray-400">Access Level</span>
                        <span class="text-white font-semibold">Full Access</span>
                    </div>
                </div>
                {% endcall %}

                <!-- Quick Actions -->
                {% call card(classes="p-5 lg:p-6") %}
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Quick Actions</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <a href="/staff" class="flex items-center gap-3 p-4 bg-primary/10 hover:bg-primary/20 rounded-xl transition">
                        <div class="w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-primary">
                                <rect x="3" y="3" width="7" height="7"/>
                                <rect x="14" y="3" width="7" height="7"/>
                                <rect x="14" y="14" width="7" height="7"/>
                                <rect x="3" y="14" width="7" height="7"/>
                            </svg>
                        </div>
                        <div>
                            <p class="text-white font-semibold">Dashboard</p>
                            <p class="text-xs text-gray-400">Go to reception</p>
                        </div>
                    </a>
                    <a href="/auth/logout" class="flex items-center gap-3 p-4 bg-red-500/10 hover:bg-red-500/20 rounded-xl transition">
                        <div class="w-10 h-10 rounded-lg bg-red-500/20 flex items-center justify-center">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-red-400">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                <polyline points="16 17 21 12 16 7"/>
                                <line x1="21" y1="12" x2="9" y2="12"/>
                            </svg>
                        </div>
                        <div>
                            <p class="text-red-400 font-semibold">Logout</p>
                            <p class="text-xs text-gray-400">Sign out of account</p>
                        </div>
                    </a>
                </div>
                {% endcall %}
            </div>
        </div>
    </div>

    {% else %}
    <!-- ==================== RECEPTION MODE (default) ==================== -->

    <!-- Top Row: Stats Cards -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 lg:gap-4 mb-6">
        {% call card(classes="p-4 lg:p-5 text-center") %}
        <p class="text-3xl lg:text-4xl font-bold text-primary" id="members-today">0</p>
        <p class="text-xs text-gray-400 uppercase mt-1">Checked In Today</p>
        {% endcall %}

        {% call card(classes="p-4 lg:p-5 text-center") %}
        <p class="text-3xl lg:text-4xl font-bold text-blue-400" id="total-members">0</p>
        <p class="text-xs text-gray-400 uppercase mt-1">Total Members</p>
        {% endcall %}

        {% call card(classes="p-4 lg:p-5 text-center") %}
        <p class="text-3xl lg:text-4xl font-bold text-green-400" id="trainers-count">0</p>
        <p class="text-xs text-gray-400 uppercase mt-1">Trainers</p>
        {% endcall %}

        {% call card(classes="p-4 lg:p-5 text-center") %}
        <p class="text-3xl lg:text-4xl font-bold text-purple-400" id="appointments-count">0</p>
        <p class="text-xs text-gray-400 uppercase mt-1">Appointments Today</p>
        {% endcall %}
    </div>

    <!-- Quick Check-In Bar -->
    {% call card(classes="p-4 mb-6") %}
    <div class="flex flex-col lg:flex-row lg:items-center gap-3">
        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider lg:whitespace-nowrap">Quick Check-In</h3>
        <div class="flex gap-2 flex-1 lg:max-w-md">
            <input type="text" id="checkin-search"
                class="flex-1 bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-500 outline-none focus:border-primary/50 transition"
                placeholder="Search member name...">
            <button onclick="searchMember()" class="bg-primary hover:bg-primary/80 px-4 py-3 rounded-xl transition">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="M21 21l-4.35-4.35"/>
                </svg>
            </button>
        </div>
        <div id="search-results" class="flex-1 space-y-2 hidden"></div>
    </div>
    {% endcall %}

    <!-- Main Grid: 4 columns on desktop -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 lg:gap-6">

        <!-- Column 1: Recent Check-ins -->
        <div class="lg:col-span-1">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Recent Check-ins</h3>
            </div>
            <div id="recent-checkins-list" class="space-y-2 lg:max-h-[400px] lg:overflow-y-auto pr-1">
                {% call card(classes="p-3 text-center") %}
                <p class="text-gray-400 text-sm">No check-ins yet today</p>
                {% endcall %}
            </div>
        </div>

        <!-- Column 2: Today's Appointments -->
        <div class="lg:col-span-1">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Today's Appointments</h3>
            </div>
            <div id="todays-appointments-list" class="space-y-2 lg:max-h-[400px] lg:overflow-y-auto pr-1">
                {% call card(classes="p-3 text-center") %}
                <p class="text-gray-400 text-sm">Loading...</p>
                {% endcall %}
            </div>
        </div>

        <!-- Column 3: Members -->
        <div class="lg:col-span-1">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Members</h3>
                <span class="text-xs text-gray-500" id="members-count">0</span>
            </div>
            <input type="text" id="member-search"
                class="w-full bg-black/30 border border-white/10 rounded-xl px-3 py-2 text-sm text-white placeholder-gray-500 outline-none focus:border-primary/50 transition mb-3"
                placeholder="Filter members...">
            <div id="members-list" class="space-y-2 lg:max-h-[350px] lg:overflow-y-auto pr-1">
                {% call card(classes="p-3 text-center") %}
                <p class="text-gray-400 text-sm">Loading...</p>
                {% endcall %}
            </div>
        </div>

        <!-- Column 4: Trainers -->
        <div class="lg:col-span-1">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Trainers</h3>
            </div>
            <div id="trainers-list" class="space-y-2 lg:max-h-[400px] lg:overflow-y-auto pr-1">
                {% call card(classes="p-3 text-center") %}
                <p class="text-gray-400 text-sm">Loading...</p>
                {% endcall %}
            </div>
        </div>

    </div>

    {% endif %}
</div>

<!-- Trainer Schedule Modal -->
<div id="trainer-schedule-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-white" id="trainer-modal-title">Trainer Schedule</h3>
            <button onclick="closeTrainerModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>

        <!-- Availability -->
        <div class="mb-4">
            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-2">Weekly Availability</h4>
            <div id="trainer-availability" class="space-y-2">
                <p class="text-gray-400 text-sm">Loading...</p>
            </div>
        </div>

        <!-- Today's Schedule -->
        <div>
            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-2">Today's Appointments</h4>
            <div id="trainer-today-schedule" class="space-y-2">
                <p class="text-gray-400 text-sm">Loading...</p>
            </div>
        </div>
    </div>
</div>

<!-- Message Modal -->
<div id="message-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-white">Send Message</h3>
            <button onclick="closeMessageModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>

        <p class="text-sm text-gray-400 mb-4">To: <span id="message-recipient" class="text-white font-semibold"></span></p>

        <textarea id="message-content" rows="4"
            class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-500 outline-none focus:border-primary/50 transition resize-none mb-4"
            placeholder="Type your message..."></textarea>

        <button onclick="sendMessage()" class="w-full bg-primary hover:bg-primary/80 text-white py-3 rounded-xl font-bold transition">
            Send Message
        </button>
    </div>
</div>

<!-- Member Profile Modal -->
<div id="member-profile-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 rounded-2xl max-w-lg w-full max-h-[85vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-white">Member Profile</h3>
            <button onclick="closeMemberModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>

        <!-- Member Header -->
        <div class="flex items-center gap-4 mb-6">
            <div id="member-avatar" class="w-16 h-16 rounded-full bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-white font-bold text-2xl">
                ?
            </div>
            <div>
                <h4 class="text-xl font-bold text-white" id="member-name">Loading...</h4>
                <p class="text-sm text-gray-400" id="member-email">-</p>
            </div>
        </div>

        <!-- Status Badge -->
        <div class="mb-6">
            <div id="member-status-badge" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-500/20 text-green-400 text-sm font-semibold">
                <span class="w-2 h-2 rounded-full bg-green-400"></span>
                Active
            </div>
        </div>

        <!-- Member Info -->
        <div class="glass-card p-4 mb-4">
            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Member Info</h4>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-400">Member Since</span>
                    <span class="text-white" id="member-since">-</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Assigned Trainer</span>
                    <span class="text-white" id="member-trainer">None</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Last Check-in</span>
                    <span class="text-white" id="member-last-checkin">Never</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Total Check-ins</span>
                    <span class="text-white" id="member-total-checkins">0</span>
                </div>
            </div>
        </div>

        <!-- Subscription Info -->
        <div class="glass-card p-4 mb-4">
            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Subscription</h4>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-400">Plan</span>
                    <span class="text-white" id="member-plan">-</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Status</span>
                    <span id="member-sub-status" class="text-green-400">-</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Expires</span>
                    <span class="text-white" id="member-sub-expires">-</span>
                </div>
            </div>
        </div>

        <!-- Documents -->
        <div class="glass-card p-4 mb-4">
            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Documents</h4>
            <div id="member-documents" class="space-y-2">
                <p class="text-gray-500 text-sm">No documents uploaded</p>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex gap-3">
            <button onclick="checkInMemberFromModal()" id="modal-checkin-btn"
                class="flex-1 bg-green-500/20 hover:bg-green-500/30 text-green-400 py-3 rounded-xl font-semibold transition flex items-center justify-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
                Check In
            </button>
            <button onclick="messageFromModal()"
                class="flex-1 bg-primary/20 hover:bg-primary/30 text-primary py-3 rounded-xl font-semibold transition flex items-center justify-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                Message
            </button>
        </div>
    </div>
</div>

<script>
let allMembers = [];
let allTrainers = [];
let currentMessageRecipient = null;

document.addEventListener('DOMContentLoaded', async () => {
    await loadStaffData();
});

async function loadStaffData() {
    try {
        // Load gym info
        const gymRes = await fetch('/api/staff/gym-info', { credentials: 'include' });
        if (gymRes.ok) {
            const gymInfo = await gymRes.json();
            const gymNameEl = document.getElementById('gym-name-display');
            if (gymNameEl) gymNameEl.textContent = gymInfo.gym_name || 'Your Gym';

            const staffNameEl = document.getElementById('staff-name');
            if (staffNameEl) staffNameEl.textContent = gymInfo.staff_name || 'Staff Member';
        }

        // Load members
        const membersRes = await fetch('/api/staff/members', { credentials: 'include' });
        if (membersRes.ok) {
            allMembers = await membersRes.json();
            renderMembers(allMembers);

            const totalEl = document.getElementById('total-members');
            if (totalEl) totalEl.textContent = allMembers.length;

            const countEl = document.getElementById('members-count');
            if (countEl) countEl.textContent = allMembers.length;
        }

        // Load trainers immediately
        await loadTrainers();

        // Load today's appointments
        await loadTodaysAppointments();

        // Load check-in stats
        await loadCheckinStats();

    } catch (error) {
        console.error('Error loading staff data:', error);
    }
}

async function loadTrainers() {
    try {
        const res = await fetch('/api/staff/trainers', { credentials: 'include' });
        const listEl = document.getElementById('trainers-list');

        if (res.ok) {
            allTrainers = await res.json();

            // Update trainers count stat
            const trainersCountEl = document.getElementById('trainers-count');
            if (trainersCountEl) trainersCountEl.textContent = allTrainers.length;

            if (allTrainers.length === 0) {
                listEl.innerHTML = `
                    <div class="glass-card p-3 text-center">
                        <p class="text-gray-400 text-sm">No trainers yet</p>
                    </div>
                `;
                return;
            }

            listEl.innerHTML = allTrainers.map(trainer => `
                <div class="glass-card p-3 hover:bg-white/10 transition cursor-pointer" onclick="viewTrainerSchedule('${trainer.id}', '${trainer.username}')">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center text-white font-bold">
                            ${trainer.username.charAt(0).toUpperCase()}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold text-white text-sm flex items-center gap-1.5">
                                ${trainer.username}
                                ${trainer.is_available_today ? '<svg class="w-4 h-4 text-green-400 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
                            </p>
                            <p class="text-xs text-gray-400">${getRoleLabel(trainer)}</p>
                        </div>
                        <button onclick="event.stopPropagation(); openMessageModal('${trainer.id}', '${trainer.username}')"
                            class="p-2 bg-primary/20 hover:bg-primary/30 text-primary rounded-lg transition" title="Message">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error('Error loading trainers:', error);
    }
}

function getRoleLabel(trainer) {
    if (trainer.sub_role === 'nutritionist') return 'Nutritionist';
    if (trainer.sub_role === 'both') return 'Trainer & Nutritionist';
    return 'Personal Trainer';
}

function renderMembers(members) {
    const list = document.getElementById('members-list');
    if (!list) return;

    if (members.length === 0) {
        list.innerHTML = `
            <div class="glass-card p-3 text-center">
                <p class="text-gray-400 text-sm">No members found</p>
            </div>
        `;
        return;
    }

    list.innerHTML = members.map(member => `
        <div class="glass-card p-3 hover:bg-white/10 transition cursor-pointer" onclick="openMemberProfile('${member.id}')">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-full bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
                    ${member.name ? member.name.charAt(0).toUpperCase() : '?'}
                </div>
                <div class="flex-1 min-w-0">
                    <p class="font-semibold text-white text-sm truncate">${member.name || member.username}</p>
                    <p class="text-xs text-gray-500 truncate">${member.email || ''}</p>
                </div>
                <div class="flex gap-1.5 flex-shrink-0">
                    <button onclick="event.stopPropagation(); openMessageModal('${member.id}', '${member.name || member.username}')"
                        class="p-2 bg-primary/20 hover:bg-primary/30 text-primary rounded-lg transition" title="Message">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                    </button>
                    <button onclick="event.stopPropagation(); checkInMember('${member.id}')"
                        class="p-2 bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded-lg transition" title="Check In">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

async function searchMember() {
    const query = document.getElementById('checkin-search').value.trim().toLowerCase();
    const resultsDiv = document.getElementById('search-results');

    if (!query) {
        resultsDiv.classList.add('hidden');
        return;
    }

    const filtered = allMembers.filter(m =>
        (m.name && m.name.toLowerCase().includes(query)) ||
        (m.username && m.username.toLowerCase().includes(query)) ||
        (m.email && m.email.toLowerCase().includes(query))
    );

    if (filtered.length === 0) {
        resultsDiv.innerHTML = '<p class="text-gray-400 text-sm text-center py-2">No members found</p>';
    } else {
        resultsDiv.innerHTML = filtered.slice(0, 5).map(member => `
            <div class="glass-card p-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-white font-bold text-sm">
                        ${member.name ? member.name.charAt(0).toUpperCase() : '?'}
                    </div>
                    <span class="text-white font-medium">${member.name || member.username}</span>
                </div>
                <button onclick="checkInMember('${member.id}')"
                    class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded-lg text-xs font-semibold transition">
                    Check In
                </button>
            </div>
        `).join('');
    }

    resultsDiv.classList.remove('hidden');
}

// Member search filter
document.getElementById('member-search')?.addEventListener('input', (e) => {
    const query = e.target.value.trim().toLowerCase();
    if (!query) {
        renderMembers(allMembers);
        return;
    }
    const filtered = allMembers.filter(m =>
        (m.name && m.name.toLowerCase().includes(query)) ||
        (m.username && m.username.toLowerCase().includes(query)) ||
        (m.email && m.email.toLowerCase().includes(query))
    );
    renderMembers(filtered);
});

async function checkInMember(memberId) {
    try {
        const res = await fetch('/api/staff/checkin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ member_id: memberId })
        });

        if (res.ok) {
            showToast('Member checked in successfully!', 'success');
            await loadCheckinStats();
            document.getElementById('checkin-search').value = '';
            document.getElementById('search-results').classList.add('hidden');
        } else {
            const err = await res.json();
            showToast(err.detail || 'Check-in failed', 'error');
        }
    } catch (error) {
        console.error('Check-in error:', error);
        showToast('Check-in failed', 'error');
    }
}

async function loadCheckinStats() {
    try {
        const res = await fetch('/api/staff/checkins/today', { credentials: 'include' });
        if (res.ok) {
            const data = await res.json();
            const todayEl = document.getElementById('members-today');
            if (todayEl) todayEl.textContent = data.count || 0;

            const listEl = document.getElementById('recent-checkins-list');
            if (listEl) {
                if (data.recent && data.recent.length > 0) {
                    listEl.innerHTML = data.recent.map(checkin => `
                        <div class="glass-card p-3 flex items-center justify-between">
                            <div class="flex items-center gap-2 min-w-0">
                                <div class="w-7 h-7 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                </div>
                                <span class="text-white text-sm font-medium truncate">${checkin.member_name}</span>
                            </div>
                            <span class="text-xs text-gray-500 flex-shrink-0 ml-2">${checkin.time}</span>
                        </div>
                    `).join('');
                } else {
                    listEl.innerHTML = `
                        <div class="glass-card p-3 text-center">
                            <p class="text-gray-400 text-sm">No check-ins yet today</p>
                        </div>
                    `;
                }
            }
        }
    } catch (error) {
        console.error('Error loading check-in stats:', error);
    }
}

async function loadTodaysAppointments() {
    try {
        const res = await fetch('/api/staff/appointments/today', { credentials: 'include' });
        const listEl = document.getElementById('todays-appointments-list');

        if (res.ok) {
            const appointments = await res.json();

            // Update appointments count stat
            const apptCountEl = document.getElementById('appointments-count');
            if (apptCountEl) apptCountEl.textContent = appointments.length;

            if (appointments.length === 0) {
                listEl.innerHTML = `
                    <div class="glass-card p-3 text-center">
                        <p class="text-gray-400 text-sm">No appointments today</p>
                    </div>
                `;
            } else {
                listEl.innerHTML = appointments.map(appt => `
                    <div class="glass-card p-3">
                        <div class="flex items-center justify-between">
                            <div class="min-w-0 flex-1">
                                <p class="text-white font-medium text-sm truncate">${appt.client_name}</p>
                                <p class="text-xs text-gray-400 truncate">with ${appt.trainer_name}</p>
                            </div>
                            <div class="text-right flex-shrink-0 ml-2">
                                <p class="text-primary font-semibold text-sm">${appt.time}</p>
                                <p class="text-xs text-gray-500">${appt.duration}min</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        } else {
            const apptCountEl = document.getElementById('appointments-count');
            if (apptCountEl) apptCountEl.textContent = '0';

            listEl.innerHTML = `
                <div class="glass-card p-3 text-center">
                    <p class="text-gray-400 text-sm">No appointments today</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading appointments:', error);
    }
}

// Trainer Schedule Modal
async function viewTrainerSchedule(trainerId, trainerName) {
    document.getElementById('trainer-modal-title').textContent = `${trainerName}'s Schedule`;
    document.getElementById('trainer-schedule-modal').classList.remove('hidden');

    // Load availability
    const availEl = document.getElementById('trainer-availability');
    const schedEl = document.getElementById('trainer-today-schedule');

    try {
        const res = await fetch(`/api/staff/trainer/${trainerId}/schedule`, { credentials: 'include' });
        if (res.ok) {
            const data = await res.json();

            // Display availability
            if (data.availability && data.availability.length > 0) {
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                availEl.innerHTML = data.availability.map(a => `
                    <div class="flex justify-between items-center py-1">
                        <span class="text-gray-400">${days[a.day_of_week]}</span>
                        <span class="text-white">${a.start_time} - ${a.end_time}</span>
                    </div>
                `).join('');
            } else {
                availEl.innerHTML = '<p class="text-gray-500 text-sm">No availability set</p>';
            }

            // Display today's appointments
            if (data.today_appointments && data.today_appointments.length > 0) {
                schedEl.innerHTML = data.today_appointments.map(appt => `
                    <div class="glass-card p-3 flex justify-between items-center">
                        <div>
                            <p class="text-white font-medium">${appt.client_name}</p>
                            <p class="text-xs text-gray-400">${appt.session_type || 'General'}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-primary font-semibold">${appt.time}</p>
                            <p class="text-xs text-gray-400">${appt.duration} min</p>
                        </div>
                    </div>
                `).join('');
            } else {
                schedEl.innerHTML = '<p class="text-gray-500 text-sm">No appointments today</p>';
            }
        }
    } catch (error) {
        console.error('Error loading trainer schedule:', error);
        availEl.innerHTML = '<p class="text-red-400 text-sm">Error loading availability</p>';
    }
}

function closeTrainerModal() {
    document.getElementById('trainer-schedule-modal').classList.add('hidden');
}

// Message Modal
function openMessageModal(userId, userName) {
    currentMessageRecipient = userId;
    document.getElementById('message-recipient').textContent = userName;
    document.getElementById('message-content').value = '';
    document.getElementById('message-modal').classList.remove('hidden');
}

function closeMessageModal() {
    document.getElementById('message-modal').classList.add('hidden');
    currentMessageRecipient = null;
}

async function sendMessage() {
    const content = document.getElementById('message-content').value.trim();
    if (!content || !currentMessageRecipient) {
        showToast('Please enter a message', 'error');
        return;
    }

    try {
        const res = await fetch('/api/messages/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                recipient_id: currentMessageRecipient,
                content: content
            })
        });

        if (res.ok) {
            showToast('Message sent!', 'success');
            closeMessageModal();
        } else {
            const err = await res.json();
            showToast(err.detail || 'Failed to send message', 'error');
        }
    } catch (error) {
        console.error('Error sending message:', error);
        showToast('Failed to send message', 'error');
    }
}

// ========== MEMBER PROFILE MODAL ==========
let currentMemberData = null;

async function openMemberProfile(memberId) {
    document.getElementById('member-profile-modal').classList.remove('hidden');

    // Reset modal content to loading state
    document.getElementById('member-name').textContent = 'Loading...';
    document.getElementById('member-email').textContent = '-';
    document.getElementById('member-avatar').textContent = '?';

    try {
        const res = await fetch(`/api/staff/member/${memberId}`, { credentials: 'include' });
        if (res.ok) {
            const data = await res.json();
            currentMemberData = data;
            renderMemberProfile(data);
        } else {
            showToast('Failed to load member profile', 'error');
            closeMemberModal();
        }
    } catch (error) {
        console.error('Error loading member profile:', error);
        showToast('Failed to load member profile', 'error');
        closeMemberModal();
    }
}

function renderMemberProfile(data) {
    // Avatar
    const avatar = document.getElementById('member-avatar');
    const initial = (data.name || data.username || '?').charAt(0).toUpperCase();
    avatar.textContent = initial;

    // Basic info
    document.getElementById('member-name').textContent = data.name || data.username;
    document.getElementById('member-email').textContent = data.email || 'No email';

    // Status badge
    const statusBadge = document.getElementById('member-status-badge');
    if (data.checked_in_today) {
        statusBadge.className = 'inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-500/20 text-green-400 text-sm font-semibold';
        statusBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-400"></span> Checked In Today';
    } else if (data.status === 'active') {
        statusBadge.className = 'inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-blue-500/20 text-blue-400 text-sm font-semibold';
        statusBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-blue-400"></span> Active Member';
    } else {
        statusBadge.className = 'inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-500/20 text-gray-400 text-sm font-semibold';
        statusBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-gray-400"></span> Inactive';
    }

    // Member info
    document.getElementById('member-since').textContent = data.member_since || 'Unknown';
    document.getElementById('member-trainer').textContent = data.trainer_name || 'None assigned';
    document.getElementById('member-total-checkins').textContent = data.total_checkins || 0;

    // Format last check-in
    if (data.last_checkin) {
        const lastCheckin = data.last_checkin;
        if (lastCheckin.includes('T')) {
            const [date, time] = lastCheckin.split('T');
            document.getElementById('member-last-checkin').textContent = `${date} at ${time.slice(0,5)}`;
        } else {
            document.getElementById('member-last-checkin').textContent = lastCheckin;
        }
    } else {
        document.getElementById('member-last-checkin').textContent = 'Never';
    }

    // Subscription info
    const sub = data.subscription || {};
    document.getElementById('member-plan').textContent = sub.plan || 'No active plan';

    const subStatusEl = document.getElementById('member-sub-status');
    if (sub.status === 'active') {
        subStatusEl.className = 'text-green-400';
        subStatusEl.textContent = 'Active';
    } else if (sub.status === 'trialing') {
        subStatusEl.className = 'text-yellow-400';
        subStatusEl.textContent = 'Trial';
    } else {
        subStatusEl.className = 'text-gray-400';
        subStatusEl.textContent = sub.status || 'Inactive';
    }

    document.getElementById('member-sub-expires').textContent = sub.expires || '-';

    // Check-in button state
    const checkinBtn = document.getElementById('modal-checkin-btn');
    if (data.checked_in_today) {
        checkinBtn.disabled = true;
        checkinBtn.className = 'flex-1 bg-gray-500/20 text-gray-500 py-3 rounded-xl font-semibold cursor-not-allowed flex items-center justify-center gap-2';
        checkinBtn.innerHTML = `
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
            </svg>
            Already Checked In
        `;
    } else {
        checkinBtn.disabled = false;
        checkinBtn.className = 'flex-1 bg-green-500/20 hover:bg-green-500/30 text-green-400 py-3 rounded-xl font-semibold transition flex items-center justify-center gap-2';
        checkinBtn.innerHTML = `
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
            </svg>
            Check In
        `;
    }

    // Documents (placeholder for now)
    const docsEl = document.getElementById('member-documents');
    if (data.documents && data.documents.length > 0) {
        docsEl.innerHTML = data.documents.map(doc => `
            <div class="flex items-center justify-between p-2 bg-white/5 rounded-lg">
                <span class="text-white text-sm">${doc.name}</span>
                <button class="text-primary text-sm">View</button>
            </div>
        `).join('');
    } else {
        docsEl.innerHTML = '<p class="text-gray-500 text-sm">No documents uploaded</p>';
    }
}

function closeMemberModal() {
    document.getElementById('member-profile-modal').classList.add('hidden');
    currentMemberData = null;
}

async function checkInMemberFromModal() {
    if (!currentMemberData) return;

    try {
        const res = await fetch('/api/staff/checkin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ member_id: currentMemberData.id })
        });

        if (res.ok) {
            showToast(`${currentMemberData.name || currentMemberData.username} checked in!`, 'success');
            currentMemberData.checked_in_today = true;
            renderMemberProfile(currentMemberData);
            await loadCheckinStats();
        } else {
            const err = await res.json();
            showToast(err.detail || 'Check-in failed', 'error');
        }
    } catch (error) {
        console.error('Check-in error:', error);
        showToast('Check-in failed', 'error');
    }
}

function messageFromModal() {
    if (!currentMemberData) return;
    const memberId = currentMemberData.id;
    const memberName = currentMemberData.name || currentMemberData.username;
    closeMemberModal();
    openMessageModal(memberId, memberName);
}

// Close modal on background click
document.getElementById('member-profile-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'member-profile-modal') {
        closeMemberModal();
    }
});

// Search on Enter key
document.getElementById('checkin-search')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') searchMember();
});

// Search on input
document.getElementById('checkin-search')?.addEventListener('input', (e) => {
    if (e.target.value.length >= 2) {
        searchMember();
    } else {
        document.getElementById('search-results').classList.add('hidden');
    }
});
</script>
{% endblock %}
