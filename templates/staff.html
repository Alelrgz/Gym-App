{% extends "base.html" %}
{% from 'macros.html' import card %}

{% block content %}
<!-- Desktop Navigation Bar (hidden on mobile) -->
<nav class="hidden lg:flex items-center justify-between px-8 py-4 border-b border-white/10 mb-6">
    <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
            </svg>
        </div>
        <div>
            <p class="label-uppercase text-[10px]">Staff</p>
            <h1 class="text-lg font-bold">Reception</h1>
        </div>
    </div>
    <div class="flex items-center gap-2">
        <a href="{{ 'staff.html' if static_build else '/?gym_id=' + gym_id + '&role=staff' }}"
           class="px-4 py-2 rounded-xl text-sm font-semibold transition {{ 'bg-primary/20 text-primary border border-primary/30' if mode != 'settings' else 'text-white/60 hover:bg-white/5' }}">
            <i data-lucide="home" class="w-5 h-5 inline-block align-middle"></i> Dashboard
        </a>
        <button onclick="openConversationsModal()"
           class="px-4 py-2 rounded-xl text-sm font-semibold transition text-white/60 hover:bg-white/5 relative">
            <i data-lucide="message-circle" class="w-5 h-5 inline-block align-middle"></i> Messages
            <span id="unread-messages-badge" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-[10px] font-bold rounded-full text-center leading-5">0</span>
        </button>
        <a href="{{ 'staff.html' if static_build else '/?gym_id=' + gym_id + '&role=staff&mode=settings' }}"
           class="px-4 py-2 rounded-xl text-sm font-semibold transition {{ 'bg-primary/20 text-primary border border-primary/30' if mode == 'settings' else 'text-white/60 hover:bg-white/5' }}">
            <i data-lucide="settings" class="w-5 h-5 inline-block align-middle"></i> Settings
        </a>
        <div class="w-px h-6 bg-white/10 mx-2"></div>
        <a href="/auth/logout" class="px-4 py-2 rounded-xl text-sm font-semibold text-red-400 hover:bg-red-500/10 transition">
            <i data-lucide="log-out" class="w-5 h-5 inline-block align-middle"></i> Logout
        </a>
    </div>
</nav>

<div class="p-4 md:p-6 lg:p-8 lg:pt-0 pt-8 md:pt-10 max-w-7xl mx-auto">
    <h2 class="text-xl md:text-2xl lg:text-3xl font-bold text-center lg:text-left mb-6 lg:mb-8" id="page-title">{{ 'Settings' if mode == 'settings' else 'Reception Dashboard' }}</h2>

    {% if mode == 'settings' %}
    <!-- ==================== SETTINGS MODE ==================== -->
    <div class="max-w-4xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left: Profile Card (larger on desktop) -->
            <div class="lg:col-span-1">
                {% call card(classes="p-6 lg:p-8") %}
                <div class="text-center">
                    <div class="w-24 h-24 lg:w-32 lg:h-32 rounded-full bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center mx-auto mb-4">
                        <svg class="w-12 h-12 lg:w-16 lg:h-16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                    </div>
                    <h3 class="text-xl lg:text-2xl font-bold text-white mb-1" id="staff-name">Staff Member</h3>
                    <p class="text-sm lg:text-base text-gray-400">Reception / Staff</p>
                </div>
                {% endcall %}
            </div>

            <!-- Right: Account Info & Actions -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Account Info -->
                {% call card(classes="p-5 lg:p-6") %}
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Account Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex justify-between items-center p-3 bg-white/5 rounded-xl">
                        <span class="text-gray-400">Role</span>
                        <span class="text-white font-semibold">Staff / Reception</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-white/5 rounded-xl">
                        <span class="text-gray-400">Gym</span>
                        <span class="text-white font-semibold" id="gym-name-display">Loading...</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-white/5 rounded-xl">
                        <span class="text-gray-400">Status</span>
                        <span class="text-green-400 font-semibold flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-green-400"></span>
                            Active
                        </span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-white/5 rounded-xl">
                        <span class="text-gray-400">Access Level</span>
                        <span class="text-white font-semibold">Full Access</span>
                    </div>
                </div>
                {% endcall %}

                <!-- Quick Actions -->
                {% call card(classes="p-5 lg:p-6") %}
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Quick Actions</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <a href="/staff" class="flex items-center gap-3 p-4 bg-primary/10 hover:bg-primary/20 rounded-xl transition">
                        <div class="w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-primary">
                                <rect x="3" y="3" width="7" height="7"/>
                                <rect x="14" y="3" width="7" height="7"/>
                                <rect x="14" y="14" width="7" height="7"/>
                                <rect x="3" y="14" width="7" height="7"/>
                            </svg>
                        </div>
                        <div>
                            <p class="text-white font-semibold">Dashboard</p>
                            <p class="text-xs text-gray-400">Go to reception</p>
                        </div>
                    </a>
                    <a href="/auth/logout" class="flex items-center gap-3 p-4 bg-red-500/10 hover:bg-red-500/20 rounded-xl transition">
                        <div class="w-10 h-10 rounded-lg bg-red-500/20 flex items-center justify-center">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-red-400">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                <polyline points="16 17 21 12 16 7"/>
                                <line x1="21" y1="12" x2="9" y2="12"/>
                            </svg>
                        </div>
                        <div>
                            <p class="text-red-400 font-semibold">Logout</p>
                            <p class="text-xs text-gray-400">Sign out of account</p>
                        </div>
                    </a>
                </div>
                {% endcall %}
            </div>
        </div>
    </div>

    {% else %}
    <!-- ==================== RECEPTION MODE (default) ==================== -->

    <!-- Top Row: Stats Cards -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 lg:gap-4 mb-6">
        {% call card(classes="p-4 lg:p-5 text-center") %}
        <p class="text-3xl lg:text-4xl font-bold text-primary" id="members-today">0</p>
        <p class="text-xs text-gray-400 uppercase mt-1">Checked In Today</p>
        {% endcall %}

        {% call card(classes="p-4 lg:p-5 text-center") %}
        <p class="text-3xl lg:text-4xl font-bold text-blue-400" id="total-members">0</p>
        <p class="text-xs text-gray-400 uppercase mt-1">Total Members</p>
        {% endcall %}

        {% call card(classes="p-4 lg:p-5 text-center") %}
        <p class="text-3xl lg:text-4xl font-bold text-green-400" id="trainers-count">0</p>
        <p class="text-xs text-gray-400 uppercase mt-1">Trainers</p>
        {% endcall %}

        {% call card(classes="p-4 lg:p-5 text-center") %}
        <p class="text-3xl lg:text-4xl font-bold text-purple-400" id="appointments-count">0</p>
        <p class="text-xs text-gray-400 uppercase mt-1">Appointments Today</p>
        {% endcall %}
    </div>

    <!-- Quick Check-In Bar -->
    {% call card(classes="p-4 mb-6") %}
    <div class="flex flex-col lg:flex-row lg:items-center gap-3">
        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider lg:whitespace-nowrap">Quick Check-In</h3>
        <div class="flex gap-2 flex-1 lg:max-w-md">
            <input type="text" id="checkin-search"
                class="flex-1 bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-500 outline-none focus:border-primary/50 transition"
                placeholder="Search member name...">
            <button onclick="searchMember()" class="bg-primary hover:bg-primary/80 px-4 py-3 rounded-xl transition">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="M21 21l-4.35-4.35"/>
                </svg>
            </button>
            <button onclick="openQrScanner()" class="bg-purple-500 hover:bg-purple-600 px-4 py-3 rounded-xl transition" title="Scan QR Code">
                <i data-lucide="scan" class="w-5 h-5 text-white"></i>
            </button>
        </div>
        <button onclick="openOnboardingWizard()" class="bg-green-500 hover:bg-green-600 px-4 py-3 rounded-xl transition flex items-center gap-2 text-white font-semibold">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="8.5" cy="7" r="4"/>
                <line x1="20" y1="8" x2="20" y2="14"/>
                <line x1="23" y1="11" x2="17" y2="11"/>
            </svg>
            <span class="hidden lg:inline">New Client</span>
        </button>
        <div id="search-results" class="flex-1 space-y-2 hidden"></div>
    </div>
    {% endcall %}

    <!-- QR Scanner Modal -->
    <div id="qr-scanner-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
        onclick="if(event.target === this) closeQrScanner()">
        <div class="bg-[#1a1a1a] p-6 rounded-2xl max-w-sm w-full border border-white/10 text-center">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-white">Scan Member QR</h3>
                <button onclick="closeQrScanner()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
            </div>
            <div class="mb-6">
                <div id="qr-scan-icon" class="w-24 h-24 mx-auto rounded-2xl bg-purple-500/20 border-2 border-purple-500/50 flex items-center justify-center mb-4 animate-pulse">
                    <i data-lucide="scan" class="w-12 h-12 text-purple-400"></i>
                </div>
                <p id="qr-scan-status" class="text-white font-semibold text-lg">Ready to scan</p>
                <p class="text-gray-400 text-sm mt-1">Point the QR reader at the member's code</p>
            </div>
            <input type="text" id="qr-scanner-input" class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white text-center placeholder-gray-500 outline-none focus:border-purple-500/50 transition"
                placeholder="Waiting for scan..." autocomplete="off">
        </div>
    </div>

    <!-- NFC Shower System -->
    {% call card(classes="p-4 mb-6") %}
    <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
            <i data-lucide="radio" class="w-5 h-5 text-cyan-400"></i>
            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">NFC Shower System</h3>
        </div>
        <button onclick="toggleNfcSection()" id="nfc-toggle-btn" class="text-xs bg-cyan-500/20 text-cyan-400 px-3 py-1.5 rounded-lg hover:bg-cyan-500/30 transition font-semibold">
            Show
        </button>
    </div>
    <div id="nfc-section" class="hidden">
        <!-- NFC Registration -->
        <div class="mb-4 p-3 bg-white/5 rounded-xl">
            <h4 class="text-sm font-semibold text-white mb-3">Register NFC Tag</h4>
            <div class="flex flex-col lg:flex-row gap-2">
                <input type="text" id="nfc-uid-input"
                    class="flex-1 bg-black/30 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-gray-500 outline-none focus:border-cyan-500/50 transition text-sm uppercase font-mono"
                    placeholder="Scan NFC tag or enter UID...">
                <select id="nfc-member-select"
                    class="flex-1 bg-black/30 border border-white/10 rounded-xl px-4 py-2.5 text-white outline-none focus:border-cyan-500/50 transition text-sm">
                    <option value="">Select member...</option>
                </select>
                <input type="text" id="nfc-label-input"
                    class="lg:w-40 bg-black/30 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-gray-500 outline-none focus:border-cyan-500/50 transition text-sm"
                    placeholder="Label (optional)">
                <button onclick="registerNfcTag()"
                    class="bg-cyan-500 hover:bg-cyan-600 text-white px-4 py-2.5 rounded-xl transition font-semibold text-sm whitespace-nowrap">
                    Register
                </button>
            </div>
        </div>

        <!-- Two column: Registered Tags + Today's Shower Usage -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- Registered Tags -->
            <div>
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-sm font-semibold text-white">Registered Tags</h4>
                    <span class="text-xs text-gray-500" id="nfc-tags-count">0</span>
                </div>
                <div id="nfc-tags-list" class="space-y-2 max-h-64 overflow-y-auto">
                    <p class="text-gray-400 text-sm text-center py-2">Loading...</p>
                </div>
            </div>

            <!-- Today's Shower Usage -->
            <div>
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-sm font-semibold text-white">Today's Showers</h4>
                    <span class="text-xs text-gray-500" id="shower-usage-count">0</span>
                </div>
                <div id="shower-usage-list" class="space-y-2 max-h-64 overflow-y-auto">
                    <p class="text-gray-400 text-sm text-center py-2">Loading...</p>
                </div>
            </div>
        </div>
    </div>
    {% endcall %}

    <!-- Main Grid: 4 columns on desktop -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 lg:gap-6">

        <!-- Column 1: Recent Check-ins -->
        <div class="lg:col-span-1">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Recent Check-ins</h3>
            </div>
            <div id="recent-checkins-list" class="space-y-2 lg:max-h-[400px] lg:overflow-y-auto pr-1">
                {% call card(classes="p-3 text-center") %}
                <p class="text-gray-400 text-sm">No check-ins yet today</p>
                {% endcall %}
            </div>
        </div>

        <!-- Column 2: Today's Appointments -->
        <div class="lg:col-span-1">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Today's Appointments</h3>
            </div>
            <div id="todays-appointments-list" class="space-y-2 lg:max-h-[400px] lg:overflow-y-auto pr-1">
                {% call card(classes="p-3 text-center") %}
                <p class="text-gray-400 text-sm">Loading...</p>
                {% endcall %}
            </div>
        </div>

        <!-- Column 3: Members -->
        <div class="lg:col-span-1">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Members</h3>
                <span class="text-xs text-gray-500" id="members-count">0</span>
            </div>
            <input type="text" id="member-search"
                class="w-full bg-black/30 border border-white/10 rounded-xl px-3 py-2 text-sm text-white placeholder-gray-500 outline-none focus:border-primary/50 transition mb-3"
                placeholder="Filter members...">
            <div id="members-list" class="space-y-2 lg:max-h-[350px] lg:overflow-y-auto pr-1">
                {% call card(classes="p-3 text-center") %}
                <p class="text-gray-400 text-sm">Loading...</p>
                {% endcall %}
            </div>
        </div>

        <!-- Column 4: Trainers -->
        <div class="lg:col-span-1">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Trainers</h3>
            </div>
            <div id="trainers-list" class="space-y-2 lg:max-h-[400px] lg:overflow-y-auto pr-1">
                {% call card(classes="p-3 text-center") %}
                <p class="text-gray-400 text-sm">Loading...</p>
                {% endcall %}
            </div>
        </div>

    </div>

    {% endif %}
</div>

<!-- Trainer Schedule Modal -->
<div id="trainer-schedule-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-white" id="trainer-modal-title">Trainer Schedule</h3>
            <button onclick="closeTrainerModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>

        <!-- Availability -->
        <div class="mb-4">
            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-2">Weekly Availability</h4>
            <div id="trainer-availability" class="space-y-2">
                <p class="text-gray-400 text-sm">Loading...</p>
            </div>
        </div>

        <!-- Today's Schedule -->
        <div>
            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-2">Today's Appointments</h4>
            <div id="trainer-today-schedule" class="space-y-2">
                <p class="text-gray-400 text-sm">Loading...</p>
            </div>
        </div>
    </div>
</div>


<!-- Member Profile Modal -->
<div id="member-profile-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 rounded-2xl max-w-lg w-full max-h-[85vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-white">Member Profile</h3>
            <button onclick="closeMemberModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>

        <!-- Member Header -->
        <div class="flex items-center gap-4 mb-6">
            <div id="member-avatar" class="w-16 h-16 rounded-full bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-white font-bold text-2xl">
                ?
            </div>
            <div>
                <h4 class="text-xl font-bold text-white" id="member-name">Loading...</h4>
                <p class="text-sm text-gray-400" id="member-email">-</p>
            </div>
        </div>

        <!-- Status Badge -->
        <div class="mb-6">
            <div id="member-status-badge" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-500/20 text-green-400 text-sm font-semibold">
                <span class="w-2 h-2 rounded-full bg-green-400"></span>
                Active
            </div>
        </div>

        <!-- Member Info -->
        <div class="glass-card p-4 mb-4">
            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Member Info</h4>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-400">Member Since</span>
                    <span class="text-white" id="member-since">-</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Assigned Trainer</span>
                    <span class="text-white" id="member-trainer">None</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Last Check-in</span>
                    <span class="text-white" id="member-last-checkin">Never</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Total Check-ins</span>
                    <span class="text-white" id="member-total-checkins">0</span>
                </div>
            </div>
        </div>

        <!-- Subscription Info -->
        <div class="glass-card p-4 mb-4">
            <div class="flex justify-between items-center mb-3">
                <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Subscription</h4>
                <button onclick="openSubscriptionManager()" class="text-xs text-primary hover:text-primary/80 font-semibold">
                    Manage →
                </button>
            </div>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-400">Plan</span>
                    <span class="text-white" id="member-plan">-</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Status</span>
                    <span id="member-sub-status" class="text-green-400">-</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Expires</span>
                    <span class="text-white" id="member-sub-expires">-</span>
                </div>
            </div>
            <!-- Quick subscription actions -->
            <div id="subscription-actions" class="mt-3 pt-3 border-t border-white/10 hidden">
                <div class="flex gap-2">
                    <button onclick="openPlanSelector()" id="assign-plan-btn"
                        class="flex-1 bg-primary/20 hover:bg-primary/30 text-primary py-2 rounded-lg text-xs font-semibold transition">
                        Assign Plan
                    </button>
                    <button onclick="cancelMemberSubscription()" id="cancel-sub-btn"
                        class="flex-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 py-2 rounded-lg text-xs font-semibold transition hidden">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Medical Certificate -->
        <div class="glass-card p-4 mb-4">
            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Medical Certificate</h4>
            <div id="member-certificate" class="space-y-2">
                <p class="text-gray-500 text-sm">No certificate uploaded</p>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex gap-3">
            <button onclick="checkInMemberFromModal()" id="modal-checkin-btn"
                class="flex-1 bg-green-500/20 hover:bg-green-500/30 text-green-400 py-3 rounded-xl font-semibold transition flex items-center justify-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
                Check In
            </button>
            <button onclick="messageFromModal()"
                class="flex-1 bg-primary/20 hover:bg-primary/30 text-primary py-3 rounded-xl font-semibold transition flex items-center justify-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                Message
            </button>
        </div>
    </div>
</div>

<!-- Subscription Plan Selector Modal -->
<div id="plan-selector-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-white">Select Subscription Plan</h3>
            <button onclick="closePlanSelector()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>

        <p class="text-sm text-gray-400 mb-4">
            For: <span id="plan-for-member" class="text-white font-semibold"></span>
        </p>

        <!-- Plans List -->
        <div id="plans-list" class="space-y-3">
            <div class="text-center py-6">
                <p class="text-gray-400 text-sm">Loading plans...</p>
            </div>
        </div>

        <!-- Manual Entry Option -->
        <div class="mt-4 pt-4 border-t border-white/10">
            <p class="text-xs text-gray-500 text-center">
                Plans are created by the gym owner in Settings → Subscriptions
            </p>
        </div>
    </div>
</div>

<!-- Client Onboarding Wizard Modal -->
<!-- Temporary Password Modal -->
<div id="temp-password-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[80] hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full text-center">
        <div class="text-4xl mb-4">&#10003;</div>
        <h3 class="text-lg font-bold text-white mb-2">Client Registered Successfully!</h3>
        <p class="text-gray-400 text-sm mb-4">Share these credentials with the client:</p>
        <div class="bg-white/5 border border-white/10 rounded-xl p-4 mb-4 text-left">
            <div class="mb-3">
                <span class="text-gray-400 text-xs uppercase">Name</span>
                <p id="temp-pw-name" class="text-white font-medium"></p>
            </div>
            <div class="mb-3">
                <span class="text-gray-400 text-xs uppercase">Username</span>
                <p id="temp-pw-username" class="text-white font-mono font-medium"></p>
            </div>
            <div>
                <span class="text-gray-400 text-xs uppercase">Temporary Password</span>
                <div class="flex items-center gap-2 mt-1">
                    <p id="temp-pw-password" class="text-green-400 font-mono font-bold text-lg"></p>
                    <button onclick="copyTempPassword()" class="text-gray-400 hover:text-white p-1" title="Copy password">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                    </button>
                </div>
            </div>
        </div>
        <p class="text-yellow-400 text-xs mb-4">The client must change this password on first login.</p>
        <button onclick="closeTempPasswordModal()" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-medium transition-colors">Done</button>
    </div>
</div>

<div id="onboarding-wizard-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[70] hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-bold text-white">New Client Registration</h3>
            <button onclick="closeOnboardingWizard()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>

        <!-- Step Indicator -->
        <div class="flex items-center justify-center gap-2 mb-6">
            <div class="onboard-step-dot active" data-step="1">
                <span class="w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white text-sm font-bold">1</span>
                <span class="text-xs text-gray-400 mt-1">Info</span>
            </div>
            <div class="w-8 h-0.5 bg-white/20"></div>
            <div class="onboard-step-dot" data-step="2">
                <span class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-white/60 text-sm font-bold">2</span>
                <span class="text-xs text-gray-400 mt-1">Docs</span>
            </div>
            <div class="w-8 h-0.5 bg-white/20"></div>
            <div class="onboard-step-dot" data-step="3">
                <span class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-white/60 text-sm font-bold">3</span>
                <span class="text-xs text-gray-400 mt-1">Plan</span>
            </div>
            <div class="w-8 h-0.5 bg-white/20"></div>
            <div class="onboard-step-dot" data-step="4">
                <span class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-white/60 text-sm font-bold">4</span>
                <span class="text-xs text-gray-400 mt-1">Photo</span>
            </div>
            <div class="w-8 h-0.5 bg-white/20"></div>
            <div class="onboard-step-dot" data-step="5">
                <span class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-white/60 text-sm font-bold">5</span>
                <span class="text-xs text-gray-400 mt-1">Pay</span>
            </div>
        </div>

        <!-- Step 1: Basic Info -->
        <div id="onboard-step-1" class="onboard-step-content">
            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Client Information</h4>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Full Name *</label>
                    <input type="text" id="onboard-name" placeholder="Enter full name"
                        class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-500 outline-none focus:border-primary/50 transition">
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Phone Number *</label>
                    <input type="tel" id="onboard-phone" placeholder="+1 234 567 8900"
                        class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-500 outline-none focus:border-primary/50 transition">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Email (optional)</label>
                        <input type="email" id="onboard-email" placeholder="email@example.com"
                            class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-500 outline-none focus:border-primary/50 transition">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Date of Birth *</label>
                        <input type="date" id="onboard-dob"
                            class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-500 outline-none focus:border-primary/50 transition">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Username *</label>
                        <input type="text" id="onboard-username" placeholder="johndoe"
                            class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-500 outline-none focus:border-primary/50 transition">
                    </div>
                </div>
                <p class="text-xs text-gray-500">* A temporary password will be auto-generated. Client must change it on first login.</p>
            </div>
        </div>

        <!-- Step 2: Documents -->
        <div id="onboard-step-2" class="onboard-step-content hidden">
            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Documentation</h4>

            <!-- Document Type Selector -->
            <div class="flex gap-2 mb-4">
                <button onclick="selectDocType('waiver')" id="doc-type-waiver"
                    class="flex-1 py-3 rounded-xl text-sm font-semibold transition bg-primary/20 text-primary border border-primary/30">
                    Sign Waiver
                </button>
                <button onclick="selectDocType('medical')" id="doc-type-medical"
                    class="flex-1 py-3 rounded-xl text-sm font-semibold transition bg-white/5 text-white/60 border border-white/10 hover:bg-white/10">
                    Upload Medical Certificate
                </button>
            </div>

            <!-- Waiver Section -->
            <div id="waiver-section">
                <div class="bg-white/5 rounded-xl p-4 mb-4 max-h-40 overflow-y-auto">
                    <p id="waiver-text-display" class="text-xs text-gray-300 whitespace-pre-line">Loading waiver...</p>
                </div>
                <p class="text-xs text-gray-400 mb-2">Client signature (use finger, stylus, or mouse):</p>
                <div class="bg-white rounded-xl p-2 mb-2 relative">
                    <canvas id="signature-canvas" width="400" height="180" class="w-full cursor-crosshair rounded-lg" style="touch-action: none; min-height: 160px;"></canvas>
                    <div id="signature-placeholder" class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <span class="text-gray-300 text-sm">Sign here</span>
                    </div>
                </div>
                <button onclick="clearSignature()" class="text-xs text-red-400 hover:text-red-300 transition flex items-center gap-1">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                    </svg>
                    Clear Signature
                </button>
            </div>

            <!-- Medical Certificate Section -->
            <div id="medical-section" class="hidden">
                <p class="text-xs text-gray-400 mb-2">Upload medical certificate (photo or PDF):</p>
                <label class="block w-full cursor-pointer">
                    <div class="border-2 border-dashed border-white/20 rounded-xl p-6 text-center hover:border-primary/50 transition">
                        <svg class="w-10 h-10 mx-auto text-gray-400 mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        <p class="text-sm text-gray-400">Click to upload or drag & drop</p>
                        <p class="text-xs text-gray-500 mt-1">JPG, PNG, PDF (max 10MB)</p>
                    </div>
                    <input type="file" id="medical-file" accept="image/*,.pdf" class="hidden" onchange="previewMedicalFile(this)">
                </label>
                <div id="medical-preview" class="mt-3 hidden">
                    <div class="flex items-center gap-3 p-3 bg-white/5 rounded-xl">
                        <i data-lucide="file-text" class="w-6 h-6 stroke-current"></i>
                        <span id="medical-filename" class="text-sm text-white flex-1 truncate">document.pdf</span>
                        <button onclick="removeMedicalFile()" class="text-red-400 hover:text-red-300">&times;</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Select Plan -->
        <div id="onboard-step-3" class="onboard-step-content hidden">
            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Select Subscription Plan</h4>
            <div id="onboard-plans-list" class="space-y-3 max-h-64 overflow-y-auto">
                <p class="text-gray-400 text-sm text-center py-4">Loading plans...</p>
            </div>
            <div class="mt-4 pt-4 border-t border-white/10">
                <button onclick="skipPlanSelection()" class="text-xs text-gray-400 hover:text-white transition">
                    Skip - register without subscription
                </button>
            </div>
        </div>

        <!-- Step 4: Profile Photo -->
        <div id="onboard-step-4" class="onboard-step-content hidden">
            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Profile Photo</h4>
            <div class="flex flex-col items-center">
                <!-- Photo Preview -->
                <div id="onboard-photo-preview" class="w-32 h-32 rounded-full bg-white/10 border-2 border-dashed border-white/20 flex items-center justify-center mb-4 overflow-hidden relative">
                    <div id="onboard-photo-placeholder" class="text-center">
                        <svg class="w-10 h-10 text-gray-500 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        <span class="text-xs text-gray-500">No photo</span>
                    </div>
                    <img id="onboard-photo-img" src="" alt="Profile" class="w-full h-full object-cover hidden">
                </div>

                <!-- Upload Button -->
                <label class="cursor-pointer mb-3">
                    <div class="bg-primary/20 hover:bg-primary/30 text-primary px-6 py-2.5 rounded-xl text-sm font-semibold transition flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        Take or Upload Photo
                    </div>
                    <input type="file" id="onboard-photo-input" accept="image/*" capture="user" class="hidden" onchange="previewOnboardPhoto(this)">
                </label>

                <!-- Remove Button -->
                <button id="onboard-photo-remove-btn" onclick="removeOnboardPhoto()" class="text-xs text-red-400 hover:text-red-300 transition hidden">
                    Remove photo
                </button>

                <p class="text-xs text-gray-500 mt-3 text-center">Optional - client can also set their photo later from the app</p>
            </div>
        </div>

        <!-- Step 5: Payment -->
        <div id="onboard-step-5" class="onboard-step-content hidden">
            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Payment & Summary</h4>

            <!-- Summary -->
            <div class="bg-white/5 rounded-xl p-4 mb-4">
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Client</span>
                        <span class="text-white font-semibold" id="summary-client-name">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Username</span>
                        <span class="text-white" id="summary-username">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Plan</span>
                        <span class="text-white" id="summary-plan">No plan selected</span>
                    </div>
                    <div class="flex justify-between pt-2 border-t border-white/10">
                        <span class="text-gray-400">Amount Due</span>
                        <span class="text-primary font-bold text-lg" id="summary-amount">-</span>
                    </div>
                </div>
            </div>

            <!-- Payment Method -->
            <div id="payment-method-section">
                <p class="text-xs text-gray-400 mb-3">Select payment method:</p>
                <div class="grid grid-cols-3 gap-3 mb-4">
                    <button onclick="selectPaymentMethod('cash')" id="pay-cash-btn"
                        class="p-4 rounded-xl border-2 border-white/20 hover:border-green-500/50 transition text-center">
                        <i data-lucide="banknote" class="w-6 h-6 block mb-1 mx-auto stroke-current"></i>
                        <span class="text-sm font-semibold text-white">Cash</span>
                    </button>
                    <button onclick="selectPaymentMethod('card')" id="pay-card-btn"
                        class="p-4 rounded-xl border-2 border-white/20 hover:border-blue-500/50 transition text-center">
                        <i data-lucide="credit-card" class="w-6 h-6 block mb-1"></i>
                        <span class="text-sm font-semibold text-white">Card</span>
                    </button>
                    <button onclick="selectPaymentMethod('qr')" id="pay-qr-btn"
                        class="p-4 rounded-xl border-2 border-white/20 hover:border-purple-500/50 transition text-center">
                        <span class="block mb-1"><i data-lucide="camera" class="w-6 h-6"></i></span>
                        <span class="text-sm font-semibold text-white">QR Code</span>
                    </button>
                </div>

                <!-- Stripe Card Form (shown when card selected) -->
                <div id="card-payment-form" class="hidden">
                    <p class="text-sm text-gray-400 mb-3">Enter card details:</p>
                    <div class="mb-3 rounded-xl border-2 border-gray-400" style="background: #ffffff; padding: 24px 20px; min-height: 80px;">
                        <div id="stripe-card-element" style="min-height: 32px; line-height: 32px;"></div>
                    </div>
                    <div id="onboard-card-errors" class="text-red-400 text-xs mb-2 hidden"></div>
                    <p class="text-xs text-gray-500">Test card: 4242 4242 4242 4242, any future date, any CVC</p>
                </div>

                <!-- QR Code Payment (shown when QR selected) -->
                <div id="qr-payment-form" class="hidden">
                    <div class="bg-purple-500/10 border border-purple-500/30 rounded-xl p-4 text-center">
                        <div id="qr-initial" class="py-2">
                            <span class="block mb-2"><i data-lucide="camera" class="w-8 h-8"></i></span>
                            <p class="text-purple-400 font-semibold mb-1">QR Code Payment</p>
                            <p class="text-xs text-gray-400">A QR code will be generated when you click Complete Registration.</p>
                            <p class="text-xs text-gray-400 mt-1">The client scans it with their phone to pay.</p>
                        </div>
                        <div id="qr-loading" class="hidden py-4">
                            <i data-lucide="loader-2" class="w-6 h-6 inline-block animate-spin stroke-current"></i>
                            <p class="text-xs text-gray-400 mt-2">Generating QR code...</p>
                        </div>
                        <div id="qr-display" class="hidden py-2">
                            <p class="text-purple-400 font-semibold mb-3">Scan to Pay</p>
                            <div id="qr-code-container" class="bg-white rounded-xl p-4 inline-block mx-auto mb-3"></div>
                            <p class="text-xs text-gray-400 mt-2">Waiting for payment...</p>
                            <div class="animate-pulse text-purple-400 text-sm mt-1" id="qr-polling-indicator">Checking payment status...</div>
                        </div>
                        <div id="qr-paid" class="hidden py-4">
                            <span class="text-4xl block mb-2 text-green-400">&#10003;</span>
                            <p class="text-green-400 font-semibold">Payment Received!</p>
                            <p class="text-xs text-gray-400 mt-1">Completing registration...</p>
                        </div>
                        <div id="qr-error" class="hidden py-2">
                            <p class="text-xs text-red-400" id="qr-error-msg">Payment setup failed</p>
                            <button onclick="retryQrPayment()" class="text-xs text-purple-400 underline mt-2">Try Again</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- No Payment Needed -->
            <div id="no-payment-section" class="hidden">
                <div class="bg-green-500/10 border border-green-500/30 rounded-xl p-4 text-center">
                    <span class="text-2xl block mb-2">✓</span>
                    <p class="text-green-400 font-semibold">No payment required</p>
                    <p class="text-xs text-gray-400 mt-1">Client will be registered without subscription</p>
                </div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="flex gap-3 mt-6">
            <button onclick="onboardPrevStep()" id="onboard-prev-btn"
                class="flex-1 bg-white/10 hover:bg-white/20 text-white py-3 rounded-xl font-semibold transition hidden">
                Back
            </button>
            <button onclick="onboardNextStep()" id="onboard-next-btn"
                class="flex-1 bg-primary hover:bg-primary/80 text-white py-3 rounded-xl font-semibold transition">
                Next
            </button>
            <button onclick="completeOnboarding()" id="onboard-complete-btn"
                class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-semibold transition hidden">
                Complete Registration
            </button>
        </div>
    </div>
</div>

<script>
let allMembers = [];
let allTrainers = [];

document.addEventListener('DOMContentLoaded', async () => {
    await loadStaffData();
});

async function loadStaffData() {
    try {
        // Load gym info
        const gymRes = await fetch('/api/staff/gym-info', { credentials: 'include' });
        if (gymRes.ok) {
            const gymInfo = await gymRes.json();
            const gymNameEl = document.getElementById('gym-name-display');
            if (gymNameEl) gymNameEl.textContent = gymInfo.gym_name || 'Your Gym';

            const staffNameEl = document.getElementById('staff-name');
            if (staffNameEl) staffNameEl.textContent = gymInfo.staff_name || 'Staff Member';
        }

        // Load members
        const membersRes = await fetch('/api/staff/members', { credentials: 'include' });
        if (membersRes.ok) {
            allMembers = await membersRes.json();
            renderMembers(allMembers);

            const totalEl = document.getElementById('total-members');
            if (totalEl) totalEl.textContent = allMembers.length;

            const countEl = document.getElementById('members-count');
            if (countEl) countEl.textContent = allMembers.length;

            // Populate NFC member dropdown
            const nfcSelect = document.getElementById('nfc-member-select');
            if (nfcSelect && allMembers.length > 0) {
                nfcSelect.innerHTML = '<option value="">Select member...</option>' +
                    allMembers.map(m => `<option value="${m.id}">${escapeHtml(m.name || m.username)}</option>`).join('');
            }
        }

        // Load trainers immediately
        await loadTrainers();

        // Load today's appointments
        await loadTodaysAppointments();

        // Load check-in stats
        await loadCheckinStats();

    } catch (error) {
        console.error('Error loading staff data:', error);
    }
}

async function loadTrainers() {
    try {
        const res = await fetch('/api/staff/trainers', { credentials: 'include' });
        const listEl = document.getElementById('trainers-list');

        if (res.ok) {
            allTrainers = await res.json();

            // Update trainers count stat
            const trainersCountEl = document.getElementById('trainers-count');
            if (trainersCountEl) trainersCountEl.textContent = allTrainers.length;

            if (allTrainers.length === 0) {
                listEl.innerHTML = `
                    <div class="glass-card p-3 text-center">
                        <p class="text-gray-400 text-sm">No trainers yet</p>
                    </div>
                `;
                return;
            }

            listEl.innerHTML = allTrainers.map(trainer => `
                <div class="glass-card p-3 hover:bg-white/10 transition cursor-pointer" onclick="viewTrainerSchedule('${trainer.id}', '${trainer.username}')">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center text-white font-bold">
                            ${trainer.username.charAt(0).toUpperCase()}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold text-white text-sm flex items-center gap-1.5">
                                ${trainer.username}
                                ${trainer.is_available_today ? '<svg class="w-4 h-4 text-green-400 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
                            </p>
                            <p class="text-xs text-gray-400">${getRoleLabel(trainer)}</p>
                        </div>
                        <button onclick="event.stopPropagation(); openChatModal('${trainer.id}', '${trainer.username}')"
                            class="p-2 bg-primary/20 hover:bg-primary/30 text-primary rounded-lg transition" title="Message">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error('Error loading trainers:', error);
    }
}

function getRoleLabel(trainer) {
    if (trainer.sub_role === 'nutritionist') return 'Nutritionist';
    if (trainer.sub_role === 'both') return 'Trainer & Nutritionist';
    return 'Personal Trainer';
}

function renderMembers(members) {
    const list = document.getElementById('members-list');
    if (!list) return;

    if (members.length === 0) {
        list.innerHTML = `
            <div class="glass-card p-3 text-center">
                <p class="text-gray-400 text-sm">No members found</p>
            </div>
        `;
        return;
    }

    list.innerHTML = members.map(member => `
        <div class="glass-card p-3 hover:bg-white/10 transition cursor-pointer" onclick="openMemberProfile('${member.id}')">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-full bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
                    ${member.name ? member.name.charAt(0).toUpperCase() : '?'}
                </div>
                <div class="flex-1 min-w-0">
                    <p class="font-semibold text-white text-sm truncate">${member.name || member.username}</p>
                    <p class="text-xs text-gray-500 truncate">${member.email || ''}</p>
                </div>
                <div class="flex gap-1.5 flex-shrink-0">
                    <button onclick="event.stopPropagation(); openChatModal('${member.id}', '${member.name || member.username}')"
                        class="p-2 bg-primary/20 hover:bg-primary/30 text-primary rounded-lg transition" title="Message">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                    </button>
                    <button onclick="event.stopPropagation(); checkInMember('${member.id}')"
                        class="p-2 bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded-lg transition" title="Check In">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

// Convert 32 hex chars back to UUID format (8-4-4-4-12)
function hexToUuid(hex) {
    return hex.slice(0,8) + '-' + hex.slice(8,12) + '-' + hex.slice(12,16) + '-' + hex.slice(16,20) + '-' + hex.slice(20);
}

// Show scanned member card with Check In button
function showScannedMember(memberId, label) {
    const resultsDiv = document.getElementById('search-results');
    const member = allMembers.find(m => m.id === memberId);
    if (member) {
        const initial = member.name ? member.name.charAt(0).toUpperCase() : '?';
        const profileImg = member.profile_picture_url
            ? `<img src="${member.profile_picture_url}" class="w-10 h-10 rounded-full object-cover">`
            : `<div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-white font-bold">${initial}</div>`;
        resultsDiv.innerHTML = `
            <div class="glass-card p-4 flex items-center justify-between border border-green-500/30">
                <div class="flex items-center gap-3">
                    ${profileImg}
                    <div>
                        <span class="text-white font-semibold">${member.name || member.username}</span>
                        <p class="text-green-400 text-xs flex items-center gap-1">
                            <i data-lucide="shield-check" class="w-3 h-3"></i> ${label || 'QR Verified'}
                        </p>
                    </div>
                </div>
                <button onclick="checkInMember('${member.id}')"
                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-xl font-semibold transition flex items-center gap-2">
                    <i data-lucide="user-check" class="w-4 h-4"></i> Check In
                </button>
            </div>
        `;
        if (typeof lucide !== 'undefined') lucide.createIcons();
    } else {
        resultsDiv.innerHTML = '<p class="text-red-400 text-sm text-center py-2">Member not found in system</p>';
    }
    resultsDiv.classList.remove('hidden');
}

async function searchMember() {
    const input = document.getElementById('checkin-search');
    const rawValue = input.value.trim();
    const resultsDiv = document.getElementById('search-results');

    // QR scanner detection: permanent check-in code (alphanumeric, no colons)
    // Format: GYMCHECKIN + 32 hex chars (UUID without hyphens)
    if (rawValue.startsWith('GYMCHECKIN')) {
        const hex = rawValue.replace('GYMCHECKIN', '');
        input.value = '';
        if (hex.length >= 32) {
            const memberId = hexToUuid(hex.slice(0, 32));
            showScannedMember(memberId, 'Member QR');
        }
        return;
    }

    // QR scanner detection: temporary access code (alphanumeric, no colons)
    // Format: GYMACCESS + 32 hex chars (UUID) + 12 hex chars (token)
    if (rawValue.startsWith('GYMACCESS')) {
        const payload = rawValue.replace('GYMACCESS', '');
        input.value = '';
        if (payload.length >= 44) {
            const userId = hexToUuid(payload.slice(0, 32));
            const token = payload.slice(32, 44);
            try {
                const res = await fetch('/api/staff/verify-access', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ user_id: userId, token: token })
                });
                if (res.ok) {
                    showScannedMember(userId, 'Access Verified');
                } else {
                    const err = await res.json();
                    showToast(err.detail || 'Access code expired', 'error');
                    resultsDiv.classList.add('hidden');
                }
            } catch (e) {
                showToast('Failed to verify access code', 'error');
            }
        }
        return;
    }

    const query = rawValue.toLowerCase();

    if (!query) {
        resultsDiv.classList.add('hidden');
        return;
    }

    const filtered = allMembers.filter(m =>
        (m.name && m.name.toLowerCase().includes(query)) ||
        (m.username && m.username.toLowerCase().includes(query)) ||
        (m.email && m.email.toLowerCase().includes(query))
    );

    if (filtered.length === 0) {
        resultsDiv.innerHTML = '<p class="text-gray-400 text-sm text-center py-2">No members found</p>';
    } else {
        resultsDiv.innerHTML = filtered.slice(0, 5).map(member => `
            <div class="glass-card p-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-white font-bold text-sm">
                        ${member.name ? member.name.charAt(0).toUpperCase() : '?'}
                    </div>
                    <span class="text-white font-medium">${member.name || member.username}</span>
                </div>
                <button onclick="checkInMember('${member.id}')"
                    class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded-lg text-xs font-semibold transition">
                    Check In
                </button>
            </div>
        `).join('');
    }

    resultsDiv.classList.remove('hidden');
}

// Member search filter
document.getElementById('member-search')?.addEventListener('input', (e) => {
    const query = e.target.value.trim().toLowerCase();
    if (!query) {
        renderMembers(allMembers);
        return;
    }
    const filtered = allMembers.filter(m =>
        (m.name && m.name.toLowerCase().includes(query)) ||
        (m.username && m.username.toLowerCase().includes(query)) ||
        (m.email && m.email.toLowerCase().includes(query))
    );
    renderMembers(filtered);
});

async function checkInMember(memberId) {
    try {
        const res = await fetch('/api/staff/checkin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ member_id: memberId })
        });

        if (res.ok) {
            showToast('Member checked in successfully!', 'success');
            await loadCheckinStats();
            document.getElementById('checkin-search').value = '';
            document.getElementById('search-results').classList.add('hidden');
        } else {
            const err = await res.json();
            showToast(err.detail || 'Check-in failed', 'error');
        }
    } catch (error) {
        console.error('Check-in error:', error);
        showToast('Check-in failed', 'error');
    }
}

async function loadCheckinStats() {
    try {
        const res = await fetch('/api/staff/checkins/today', { credentials: 'include' });
        if (res.ok) {
            const data = await res.json();
            const todayEl = document.getElementById('members-today');
            if (todayEl) todayEl.textContent = data.count || 0;

            const listEl = document.getElementById('recent-checkins-list');
            if (listEl) {
                if (data.recent && data.recent.length > 0) {
                    listEl.innerHTML = data.recent.map(checkin => `
                        <div class="glass-card p-3 flex items-center justify-between">
                            <div class="flex items-center gap-2 min-w-0">
                                <div class="w-7 h-7 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                </div>
                                <span class="text-white text-sm font-medium truncate">${checkin.member_name}</span>
                            </div>
                            <span class="text-xs text-gray-500 flex-shrink-0 ml-2">${checkin.time}</span>
                        </div>
                    `).join('');
                } else {
                    listEl.innerHTML = `
                        <div class="glass-card p-3 text-center">
                            <p class="text-gray-400 text-sm">No check-ins yet today</p>
                        </div>
                    `;
                }
            }
        }
    } catch (error) {
        console.error('Error loading check-in stats:', error);
    }
}

async function loadTodaysAppointments() {
    try {
        const res = await fetch('/api/staff/appointments/today', { credentials: 'include' });
        const listEl = document.getElementById('todays-appointments-list');

        if (res.ok) {
            const appointments = await res.json();

            // Update appointments count stat
            const apptCountEl = document.getElementById('appointments-count');
            if (apptCountEl) apptCountEl.textContent = appointments.length;

            if (appointments.length === 0) {
                listEl.innerHTML = `
                    <div class="glass-card p-3 text-center">
                        <p class="text-gray-400 text-sm">No appointments today</p>
                    </div>
                `;
            } else {
                listEl.innerHTML = appointments.map(appt => `
                    <div class="glass-card p-3">
                        <div class="flex items-center justify-between">
                            <div class="min-w-0 flex-1">
                                <p class="text-white font-medium text-sm truncate">${appt.client_name}</p>
                                <p class="text-xs text-gray-400 truncate">with ${appt.trainer_name}</p>
                            </div>
                            <div class="text-right flex-shrink-0 ml-2">
                                <p class="text-primary font-semibold text-sm">${appt.time}</p>
                                <p class="text-xs text-gray-500">${appt.duration}min</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        } else {
            const apptCountEl = document.getElementById('appointments-count');
            if (apptCountEl) apptCountEl.textContent = '0';

            listEl.innerHTML = `
                <div class="glass-card p-3 text-center">
                    <p class="text-gray-400 text-sm">No appointments today</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading appointments:', error);
    }
}

// Trainer Schedule Modal
async function viewTrainerSchedule(trainerId, trainerName) {
    document.getElementById('trainer-modal-title').textContent = `${trainerName}'s Schedule`;
    document.getElementById('trainer-schedule-modal').classList.remove('hidden');

    // Load availability
    const availEl = document.getElementById('trainer-availability');
    const schedEl = document.getElementById('trainer-today-schedule');

    try {
        const res = await fetch(`/api/staff/trainer/${trainerId}/schedule`, { credentials: 'include' });
        if (res.ok) {
            const data = await res.json();

            // Display availability
            if (data.availability && data.availability.length > 0) {
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                availEl.innerHTML = data.availability.map(a => `
                    <div class="flex justify-between items-center py-1">
                        <span class="text-gray-400">${days[a.day_of_week]}</span>
                        <span class="text-white">${a.start_time} - ${a.end_time}</span>
                    </div>
                `).join('');
            } else {
                availEl.innerHTML = '<p class="text-gray-500 text-sm">No availability set</p>';
            }

            // Display today's appointments
            if (data.today_appointments && data.today_appointments.length > 0) {
                schedEl.innerHTML = data.today_appointments.map(appt => `
                    <div class="glass-card p-3 flex justify-between items-center">
                        <div>
                            <p class="text-white font-medium">${appt.client_name}</p>
                            <p class="text-xs text-gray-400">${appt.session_type || 'General'}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-primary font-semibold">${appt.time}</p>
                            <p class="text-xs text-gray-400">${appt.duration} min</p>
                        </div>
                    </div>
                `).join('');
            } else {
                schedEl.innerHTML = '<p class="text-gray-500 text-sm">No appointments today</p>';
            }
        }
    } catch (error) {
        console.error('Error loading trainer schedule:', error);
        availEl.innerHTML = '<p class="text-red-400 text-sm">Error loading availability</p>';
    }
}

function closeTrainerModal() {
    document.getElementById('trainer-schedule-modal').classList.add('hidden');
}

// ========== MEMBER PROFILE MODAL ==========
let currentMemberData = null;

async function openMemberProfile(memberId) {
    document.getElementById('member-profile-modal').classList.remove('hidden');

    // Reset modal content to loading state
    document.getElementById('member-name').textContent = 'Loading...';
    document.getElementById('member-email').textContent = '-';
    document.getElementById('member-avatar').textContent = '?';

    try {
        const res = await fetch(`/api/staff/member/${memberId}`, { credentials: 'include' });
        if (res.ok) {
            const data = await res.json();
            currentMemberData = data;
            renderMemberProfile(data);
        } else {
            showToast('Failed to load member profile', 'error');
            closeMemberModal();
        }
    } catch (error) {
        console.error('Error loading member profile:', error);
        showToast('Failed to load member profile', 'error');
        closeMemberModal();
    }
}

function renderMemberProfile(data) {
    // Avatar
    const avatar = document.getElementById('member-avatar');
    const initial = (data.name || data.username || '?').charAt(0).toUpperCase();
    avatar.textContent = initial;

    // Basic info
    document.getElementById('member-name').textContent = data.name || data.username;
    document.getElementById('member-email').textContent = data.email || 'No email';

    // Status badge
    const statusBadge = document.getElementById('member-status-badge');
    if (data.checked_in_today) {
        statusBadge.className = 'inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-500/20 text-green-400 text-sm font-semibold';
        statusBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-400"></span> Checked In Today';
    } else if (data.status === 'active') {
        statusBadge.className = 'inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-blue-500/20 text-blue-400 text-sm font-semibold';
        statusBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-blue-400"></span> Active Member';
    } else {
        statusBadge.className = 'inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-500/20 text-gray-400 text-sm font-semibold';
        statusBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-gray-400"></span> Inactive';
    }

    // Member info
    document.getElementById('member-since').textContent = data.member_since || 'Unknown';
    document.getElementById('member-trainer').textContent = data.trainer_name || 'None assigned';
    document.getElementById('member-total-checkins').textContent = data.total_checkins || 0;

    // Format last check-in
    if (data.last_checkin) {
        const lastCheckin = data.last_checkin;
        if (lastCheckin.includes('T')) {
            const [date, time] = lastCheckin.split('T');
            document.getElementById('member-last-checkin').textContent = `${date} at ${time.slice(0,5)}`;
        } else {
            document.getElementById('member-last-checkin').textContent = lastCheckin;
        }
    } else {
        document.getElementById('member-last-checkin').textContent = 'Never';
    }

    // Subscription info
    const sub = data.subscription || {};
    document.getElementById('member-plan').textContent = sub.plan || 'No active plan';

    const subStatusEl = document.getElementById('member-sub-status');
    if (sub.status === 'active') {
        subStatusEl.className = 'text-green-400';
        subStatusEl.textContent = 'Active';
    } else if (sub.status === 'trialing') {
        subStatusEl.className = 'text-yellow-400';
        subStatusEl.textContent = 'Trial';
    } else {
        subStatusEl.className = 'text-gray-400';
        subStatusEl.textContent = sub.status || 'Inactive';
    }

    document.getElementById('member-sub-expires').textContent = sub.expires || '-';

    // Subscription actions - show automatically for easy access
    const actionsEl = document.getElementById('subscription-actions');
    const assignBtn = document.getElementById('assign-plan-btn');
    const cancelBtn = document.getElementById('cancel-sub-btn');

    actionsEl.classList.remove('hidden');
    if (sub.status === 'active' || sub.status === 'trialing') {
        assignBtn.textContent = 'Change Plan';
        cancelBtn.classList.remove('hidden');
    } else {
        assignBtn.textContent = 'Assign Plan';
        cancelBtn.classList.add('hidden');
    }

    // Check-in button state
    const checkinBtn = document.getElementById('modal-checkin-btn');
    if (data.checked_in_today) {
        checkinBtn.disabled = true;
        checkinBtn.className = 'flex-1 bg-gray-500/20 text-gray-500 py-3 rounded-xl font-semibold cursor-not-allowed flex items-center justify-center gap-2';
        checkinBtn.innerHTML = `
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
            </svg>
            Already Checked In
        `;
    } else {
        checkinBtn.disabled = false;
        checkinBtn.className = 'flex-1 bg-green-500/20 hover:bg-green-500/30 text-green-400 py-3 rounded-xl font-semibold transition flex items-center justify-center gap-2';
        checkinBtn.innerHTML = `
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
            </svg>
            Check In
        `;
    }

    // Medical Certificate
    const certEl = document.getElementById('member-certificate');
    const cert = data.medical_certificate;
    if (cert) {
        const statusConfig = {
            valid: { bg: 'bg-green-500/20', border: 'border-green-500/30', text: 'text-green-400', label: 'Valid', icon: '✓' },
            expiring: { bg: 'bg-yellow-500/20', border: 'border-yellow-500/30', text: 'text-yellow-400', label: 'Expiring Soon', icon: 'alert-triangle' },
            expired: { bg: 'bg-red-500/20', border: 'border-red-500/30', text: 'text-red-400', label: 'Expired', icon: '✗' }
        };
        const cfg = statusConfig[cert.status] || statusConfig.valid;
        const expiryText = cert.expiration_date ? `Expires: ${new Date(cert.expiration_date).toLocaleDateString()}` : '';

        certEl.innerHTML = `
            <div class="flex items-center gap-3 p-3 rounded-xl ${cfg.bg} border ${cfg.border}">
                <div class="w-8 h-8 rounded-full ${cfg.bg} flex items-center justify-center flex-shrink-0">
                    <span class="font-bold ${cfg.text}">${cfg.icon}</span>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-white text-sm font-semibold truncate">${cert.filename}</p>
                    <p class="text-xs ${cfg.text}">${expiryText}</p>
                </div>
                <div class="flex items-center gap-2">
                    <a href="${cert.file_url}" target="_blank" class="text-xs ${cfg.text} hover:underline">View</a>
                    <span class="text-xs px-2 py-1 rounded-full ${cfg.bg} ${cfg.text}">${cfg.label}</span>
                </div>
            </div>
        `;
    } else {
        certEl.innerHTML = '<p class="text-gray-500 text-sm">No certificate uploaded</p>';
    }
}

function closeMemberModal() {
    document.getElementById('member-profile-modal').classList.add('hidden');
    currentMemberData = null;
}

async function checkInMemberFromModal() {
    if (!currentMemberData) return;

    try {
        const res = await fetch('/api/staff/checkin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ member_id: currentMemberData.id })
        });

        if (res.ok) {
            showToast(`${currentMemberData.name || currentMemberData.username} checked in!`, 'success');
            currentMemberData.checked_in_today = true;
            renderMemberProfile(currentMemberData);
            await loadCheckinStats();
        } else {
            const err = await res.json();
            showToast(err.detail || 'Check-in failed', 'error');
        }
    } catch (error) {
        console.error('Check-in error:', error);
        showToast('Check-in failed', 'error');
    }
}

function messageFromModal() {
    if (!currentMemberData) return;
    const memberId = currentMemberData.id;
    const memberName = currentMemberData.name || currentMemberData.username;
    closeMemberModal();
    openChatModal(memberId, memberName);
}

// Close modal on background click
document.getElementById('member-profile-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'member-profile-modal') {
        closeMemberModal();
    }
});

// ========== SUBSCRIPTION MANAGEMENT ==========
let availablePlans = [];

async function loadSubscriptionPlans() {
    try {
        const res = await fetch('/api/staff/subscription-plans', { credentials: 'include' });
        if (res.ok) {
            availablePlans = await res.json();
        }
    } catch (error) {
        console.error('Error loading plans:', error);
    }
}

function openSubscriptionManager() {
    const actionsEl = document.getElementById('subscription-actions');
    const assignBtn = document.getElementById('assign-plan-btn');
    const cancelBtn = document.getElementById('cancel-sub-btn');

    actionsEl.classList.remove('hidden');

    // Show appropriate buttons based on subscription status
    const sub = currentMemberData?.subscription || {};
    if (sub.status === 'active' || sub.status === 'trialing') {
        assignBtn.textContent = 'Change Plan';
        cancelBtn.classList.remove('hidden');
    } else {
        assignBtn.textContent = 'Assign Plan';
        cancelBtn.classList.add('hidden');
    }
}

function openPlanSelector() {
    // Load plans first if not loaded
    if (availablePlans.length === 0) {
        loadSubscriptionPlans().then(() => showPlanSelectorModal());
    } else {
        showPlanSelectorModal();
    }
}

function showPlanSelectorModal() {
    const modal = document.getElementById('plan-selector-modal');
    const listEl = document.getElementById('plans-list');
    const memberNameEl = document.getElementById('plan-for-member');

    // Show member name
    if (currentMemberData && memberNameEl) {
        memberNameEl.textContent = currentMemberData.name || currentMemberData.username;
    }

    if (availablePlans.length === 0) {
        listEl.innerHTML = `
            <div class="text-center py-8">
                <p class="text-gray-400">No subscription plans available.</p>
                <p class="text-xs text-gray-500 mt-2">Ask the gym owner to create plans first.</p>
            </div>
        `;
    } else {
        listEl.innerHTML = availablePlans.map(plan => `
            <div class="glass-card p-4 hover:bg-white/10 transition cursor-pointer border border-transparent hover:border-primary/30"
                onclick="selectPlan('${plan.id}', '${plan.name}')">
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-bold text-white">${plan.name}</h4>
                    <span class="text-primary font-bold">${plan.currency || '€'}${plan.price}/${plan.billing_interval === 'year' ? 'yr' : 'mo'}</span>
                </div>
                <p class="text-sm text-gray-400 mb-2">${plan.description || 'Standard membership plan'}</p>
                ${plan.features && plan.features.length > 0 ? `
                    <div class="flex flex-wrap gap-1">
                        ${plan.features.slice(0, 3).map(f => `
                            <span class="text-xs bg-white/10 text-gray-300 px-2 py-0.5 rounded">${f}</span>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        `).join('');
    }

    modal.classList.remove('hidden');
}

function closePlanSelector() {
    document.getElementById('plan-selector-modal').classList.add('hidden');
}

async function selectPlan(planId, planName) {
    if (!currentMemberData) return;

    const sub = currentMemberData.subscription || {};
    const endpoint = (sub.status === 'active' || sub.status === 'trialing')
        ? '/api/staff/change-subscription'
        : '/api/staff/subscribe-client';

    try {
        const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                client_id: currentMemberData.id,
                plan_id: planId
            })
        });

        if (res.ok) {
            const data = await res.json();
            showToast(data.message || `Subscribed to ${planName}!`, 'success');
            closePlanSelector();

            // Refresh member profile
            await openMemberProfile(currentMemberData.id);
        } else {
            const err = await res.json();
            showToast(err.detail || 'Failed to update subscription', 'error');
        }
    } catch (error) {
        console.error('Subscription error:', error);
        showToast('Failed to update subscription', 'error');
    }
}

async function cancelMemberSubscription() {
    if (!currentMemberData) return;

    if (!confirm(`Cancel subscription for ${currentMemberData.name || currentMemberData.username}?`)) {
        return;
    }

    try {
        const res = await fetch('/api/staff/cancel-subscription', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ client_id: currentMemberData.id })
        });

        if (res.ok) {
            const data = await res.json();
            showToast(data.message || 'Subscription canceled', 'success');

            // Refresh member profile
            await openMemberProfile(currentMemberData.id);
        } else {
            const err = await res.json();
            showToast(err.detail || 'Failed to cancel subscription', 'error');
        }
    } catch (error) {
        console.error('Cancel error:', error);
        showToast('Failed to cancel subscription', 'error');
    }
}

// Load plans when page loads
document.addEventListener('DOMContentLoaded', loadSubscriptionPlans);

// Close plan selector on background click
document.getElementById('plan-selector-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'plan-selector-modal') {
        closePlanSelector();
    }
});

// Auto-focus check-in input for QR scanner
document.getElementById('checkin-search')?.focus();

// Search on Enter key
document.getElementById('checkin-search')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') searchMember();
});

// Search on input
document.getElementById('checkin-search')?.addEventListener('input', (e) => {
    if (e.target.value.length >= 2) {
        searchMember();
    } else {
        document.getElementById('search-results').classList.add('hidden');
    }
});

// ========== QR SCANNER (USB Reader) ==========
function openQrScanner() {
    const modal = document.getElementById('qr-scanner-modal');
    const input = document.getElementById('qr-scanner-input');
    const icon = document.getElementById('qr-scan-icon');
    const status = document.getElementById('qr-scan-status');

    // Reset state
    input.value = '';
    icon.classList.remove('bg-green-500/20', 'border-green-500/50');
    icon.classList.add('bg-purple-500/20', 'border-purple-500/50', 'animate-pulse');
    status.textContent = 'Ready to scan';
    status.classList.remove('text-green-400');
    status.classList.add('text-white');

    modal.classList.remove('hidden');

    // Focus the input so the USB scanner types into it
    setTimeout(() => input.focus(), 100);

    // Re-init lucide icons in modal
    if (typeof lucide !== 'undefined') lucide.createIcons();
}

function closeQrScanner() {
    document.getElementById('qr-scanner-modal').classList.add('hidden');
    // Refocus the main check-in input
    document.getElementById('checkin-search')?.focus();
}

// Handle scanner input (Enter key triggers check-in)
document.getElementById('qr-scanner-input')?.addEventListener('keypress', async (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        const input = document.getElementById('qr-scanner-input');
        const value = input.value.trim();
        if (!value) return;

        // Feed into the main check-in flow
        document.getElementById('checkin-search').value = value;
        input.value = '';

        // Show success animation briefly
        const icon = document.getElementById('qr-scan-icon');
        const status = document.getElementById('qr-scan-status');
        icon.classList.remove('bg-purple-500/20', 'border-purple-500/50', 'animate-pulse');
        icon.classList.add('bg-green-500/20', 'border-green-500/50');
        status.textContent = 'Scanned!';
        status.classList.remove('text-white');
        status.classList.add('text-green-400');

        // Close scanner and process
        closeQrScanner();
        await searchMember();
    }
});

// ========== NFC SHOWER SYSTEM ==========

function toggleNfcSection() {
    const section = document.getElementById('nfc-section');
    const btn = document.getElementById('nfc-toggle-btn');
    if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        btn.textContent = 'Hide';
        loadNfcTags();
        loadShowerUsage();
    } else {
        section.classList.add('hidden');
        btn.textContent = 'Show';
    }
}

async function loadNfcTags() {
    try {
        const res = await fetch('/api/staff/nfc-tags', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load NFC tags');
        const tags = await res.json();

        document.getElementById('nfc-tags-count').textContent = tags.length;
        const container = document.getElementById('nfc-tags-list');

        if (tags.length === 0) {
            container.innerHTML = '<p class="text-gray-400 text-sm text-center py-2">No NFC tags registered</p>';
            return;
        }

        container.innerHTML = tags.map(tag => `
            <div class="flex items-center justify-between p-2 bg-white/5 rounded-lg">
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-semibold text-white truncate">${escapeHtml(tag.member_name)}</p>
                    <p class="text-xs text-gray-400">
                        <span class="font-mono">${escapeHtml(tag.nfc_uid)}</span>
                        ${tag.label ? ' · ' + escapeHtml(tag.label) : ''}
                    </p>
                </div>
                <button onclick="unregisterNfc(${tag.id})" class="text-red-400 hover:text-red-300 p-1 ml-2" title="Unregister">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
        `).join('');

        if (typeof lucide !== 'undefined') lucide.createIcons();
    } catch (err) {
        console.error('Error loading NFC tags:', err);
    }
}

async function registerNfcTag() {
    const nfcUid = document.getElementById('nfc-uid-input').value.trim();
    const memberId = document.getElementById('nfc-member-select').value;
    const label = document.getElementById('nfc-label-input').value.trim();

    if (!nfcUid) { alert('Please scan or enter an NFC tag UID'); return; }
    if (!memberId) { alert('Please select a member'); return; }

    try {
        const res = await fetch('/api/staff/register-nfc', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ nfc_uid: nfcUid, member_id: memberId, label: label || undefined })
        });

        const result = await res.json();
        if (!res.ok) throw new Error(result.detail || 'Registration failed');

        document.getElementById('nfc-uid-input').value = '';
        document.getElementById('nfc-label-input').value = '';
        document.getElementById('nfc-member-select').value = '';

        showToast(result.message, 'success');
        loadNfcTags();
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}

async function unregisterNfc(tagId) {
    if (!confirm('Unregister this NFC tag?')) return;

    try {
        const res = await fetch(`/api/staff/unregister-nfc/${tagId}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        if (!res.ok) throw new Error('Failed to unregister');
        showToast('NFC tag unregistered', 'success');
        loadNfcTags();
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}

async function loadShowerUsage() {
    try {
        const res = await fetch('/api/staff/shower-usage', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load shower usage');
        const data = await res.json();

        document.getElementById('shower-usage-count').textContent = data.count;
        const container = document.getElementById('shower-usage-list');

        if (data.count === 0) {
            container.innerHTML = '<p class="text-gray-400 text-sm text-center py-2">No showers used today</p>';
            return;
        }

        container.innerHTML = data.usages.map(u => {
            const mins = u.duration_seconds ? Math.floor(u.duration_seconds / 60) : Math.floor(u.timer_seconds / 60);
            const secs = u.duration_seconds ? (u.duration_seconds % 60).toString().padStart(2, '0') : '00';
            const statusColor = u.completed ? 'text-green-400' : 'text-yellow-400';
            const statusText = u.completed ? `${mins}:${secs}` : 'Active';

            return `
                <div class="flex items-center justify-between p-2 bg-white/5 rounded-lg">
                    <div>
                        <p class="text-sm font-semibold text-white">${escapeHtml(u.member_name)}</p>
                        <p class="text-xs text-gray-400">${u.time}${u.shower_id && u.shower_id !== 'default' ? ' · ' + escapeHtml(u.shower_id) : ''}</p>
                    </div>
                    <span class="text-xs ${statusColor} font-semibold">${statusText}</span>
                </div>
            `;
        }).join('');
    } catch (err) {
        console.error('Error loading shower usage:', err);
    }
}

// NFC UID input listener — USB NFC readers type UID + Enter
document.getElementById('nfc-uid-input')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        const memberId = document.getElementById('nfc-member-select').value;
        if (memberId) {
            registerNfcTag();
        }
    }
});

// ========== CLIENT ONBOARDING WIZARD ==========
const onboardingState = {
    currentStep: 1,
    totalSteps: 5,
    data: {
        name: '',
        phone: '',
        email: '',
        dateOfBirth: '',
        username: '',
        password: '',
        documentType: 'waiver',
        documentData: null,
        waiverText: '',
        planId: null,
        planName: '',
        planPrice: 0,
        planCurrency: '€',
        profilePhoto: null,
        paymentMethod: null
    }
};

let signatureCanvas, signatureCtx;
let isDrawing = false;

function openOnboardingWizard() {
    // Reset state
    onboardingState.currentStep = 1;
    onboardingState.data = {
        name: '', phone: '', email: '', dateOfBirth: '',
        username: '',
        documentType: 'waiver', documentData: null, waiverText: '',
        planId: null, planName: '', planPrice: 0, planCurrency: '€',
        profilePhoto: null, paymentMethod: null
    };

    // Clear form fields
    document.getElementById('onboard-name').value = '';
    document.getElementById('onboard-phone').value = '';
    document.getElementById('onboard-email').value = '';
    document.getElementById('onboard-dob').value = '';
    document.getElementById('onboard-username').value = '';
    removeOnboardPhoto();

    // Reset UI
    showOnboardStep(1);
    document.getElementById('onboarding-wizard-modal').classList.remove('hidden');

    // Load waiver and plans
    loadWaiverTemplate();
    loadOnboardingPlans();
    // Note: signature canvas is initialized when step 2 becomes visible
}

function closeOnboardingWizard() {
    stopPollingPayment();
    document.getElementById('onboarding-wizard-modal').classList.add('hidden');
}

function showOnboardStep(step) {
    onboardingState.currentStep = step;

    // Hide all steps
    document.querySelectorAll('.onboard-step-content').forEach(el => el.classList.add('hidden'));

    // Show current step
    document.getElementById(`onboard-step-${step}`).classList.remove('hidden');

    // Initialize signature canvas when step 2 becomes visible
    if (step === 2) {
        setTimeout(initSignatureCanvas, 50);
    }

    // Update step indicators
    document.querySelectorAll('.onboard-step-dot').forEach((dot, i) => {
        const stepNum = i + 1;
        const circle = dot.querySelector('span:first-child');
        if (stepNum <= step) {
            circle.className = 'w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white text-sm font-bold';
        } else {
            circle.className = 'w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-white/60 text-sm font-bold';
        }
    });

    // Update navigation buttons
    const prevBtn = document.getElementById('onboard-prev-btn');
    const nextBtn = document.getElementById('onboard-next-btn');
    const completeBtn = document.getElementById('onboard-complete-btn');

    prevBtn.classList.toggle('hidden', step === 1);
    nextBtn.classList.toggle('hidden', step === 5);
    completeBtn.classList.toggle('hidden', step !== 5);

    // Update step 5 summary if on last step
    if (step === 5) {
        updateOnboardingSummary();
    }
}

function onboardNextStep() {
    if (!validateOnboardStep(onboardingState.currentStep)) return;
    saveOnboardStepData(onboardingState.currentStep);

    if (onboardingState.currentStep < onboardingState.totalSteps) {
        showOnboardStep(onboardingState.currentStep + 1);
    }
}

function onboardPrevStep() {
    if (onboardingState.currentStep > 1) {
        showOnboardStep(onboardingState.currentStep - 1);
    }
}

function validateOnboardStep(step) {
    if (step === 1) {
        const name = document.getElementById('onboard-name').value.trim();
        const phone = document.getElementById('onboard-phone').value.trim();
        const username = document.getElementById('onboard-username').value.trim();

        if (!name) { showToast('Name is required', 'error'); return false; }
        if (!phone) { showToast('Phone is required', 'error'); return false; }
        if (!username) { showToast('Username is required', 'error'); return false; }
        return true;
    }

    if (step === 2) {
        if (onboardingState.data.documentType === 'waiver') {
            // Check if signature exists
            if (!hasSignature()) {
                showToast('Please have the client sign the waiver', 'error');
                return false;
            }
        } else {
            // Check if file uploaded
            const fileInput = document.getElementById('medical-file');
            if (!fileInput.files || !fileInput.files[0]) {
                showToast('Please upload the medical certificate', 'error');
                return false;
            }
        }
        return true;
    }

    return true; // Steps 3 and 4 have no required validation
}

function saveOnboardStepData(step) {
    if (step === 1) {
        onboardingState.data.name = document.getElementById('onboard-name').value.trim();
        onboardingState.data.phone = document.getElementById('onboard-phone').value.trim();
        onboardingState.data.email = document.getElementById('onboard-email').value.trim();
        onboardingState.data.dateOfBirth = document.getElementById('onboard-dob').value;
        onboardingState.data.username = document.getElementById('onboard-username').value.trim();
    }

    if (step === 2) {
        if (onboardingState.data.documentType === 'waiver') {
            onboardingState.data.documentData = signatureCanvas.toDataURL('image/png');
            onboardingState.data.waiverText = document.getElementById('waiver-text-display').textContent;
        } else {
            // File will be read on submit
        }
    }
}

async function loadWaiverTemplate() {
    try {
        const res = await fetch('/api/staff/waiver-template', { credentials: 'include' });
        if (res.ok) {
            const data = await res.json();
            document.getElementById('waiver-text-display').textContent = data.waiver_text;
        }
    } catch (e) {
        console.error('Error loading waiver:', e);
    }
}

function loadOnboardingPlans() {
    const listEl = document.getElementById('onboard-plans-list');

    if (availablePlans.length === 0) {
        listEl.innerHTML = `
            <div class="text-center py-6">
                <p class="text-gray-400">No subscription plans available.</p>
                <p class="text-xs text-gray-500 mt-2">Client can be registered without a plan.</p>
            </div>
        `;
        return;
    }

    listEl.innerHTML = availablePlans.map(plan => `
        <div class="glass-card p-4 cursor-pointer border-2 transition ${onboardingState.data.planId === plan.id ? 'border-primary bg-primary/10' : 'border-transparent hover:border-white/20'}"
            onclick="selectOnboardPlan('${plan.id}', '${plan.name}', ${plan.price}, '${plan.currency || '€'}')">
            <div class="flex justify-between items-start">
                <div>
                    <h4 class="font-bold text-white">${plan.name}</h4>
                    <p class="text-xs text-gray-400">${plan.description || 'Membership plan'}</p>
                </div>
                <span class="text-primary font-bold">${plan.currency || '€'}${plan.price}/${plan.billing_interval === 'year' ? 'yr' : 'mo'}</span>
            </div>
        </div>
    `).join('');
}

function selectOnboardPlan(planId, planName, price, currency) {
    onboardingState.data.planId = planId;
    onboardingState.data.planName = planName;
    onboardingState.data.planPrice = price;
    onboardingState.data.planCurrency = currency;

    // Update UI to show selected
    loadOnboardingPlans();
}

function skipPlanSelection() {
    onboardingState.data.planId = null;
    onboardingState.data.planName = '';
    onboardingState.data.planPrice = 0;
    showOnboardStep(4);
}

function updateOnboardingSummary() {
    document.getElementById('summary-client-name').textContent = onboardingState.data.name;
    document.getElementById('summary-username').textContent = onboardingState.data.username;

    if (onboardingState.data.planId) {
        document.getElementById('summary-plan').textContent = onboardingState.data.planName;
        document.getElementById('summary-amount').textContent = `${onboardingState.data.planCurrency}${onboardingState.data.planPrice}`;
        document.getElementById('payment-method-section').classList.remove('hidden');
        document.getElementById('no-payment-section').classList.add('hidden');
    } else {
        document.getElementById('summary-plan').textContent = 'No plan selected';
        document.getElementById('summary-amount').textContent = '-';
        document.getElementById('payment-method-section').classList.add('hidden');
        document.getElementById('no-payment-section').classList.remove('hidden');
    }
}

function selectPaymentMethod(method) {
    onboardingState.data.paymentMethod = method;

    const cashBtn = document.getElementById('pay-cash-btn');
    const cardBtn = document.getElementById('pay-card-btn');
    const qrBtn = document.getElementById('pay-qr-btn');
    const cardForm = document.getElementById('card-payment-form');
    const qrForm = document.getElementById('qr-payment-form');

    // Reset all button styles
    cashBtn.classList.remove('border-green-500', 'bg-green-500/10');
    cardBtn.classList.remove('border-blue-500', 'bg-blue-500/10');
    qrBtn.classList.remove('border-purple-500', 'bg-purple-500/10');

    // Update selected button style
    if (method === 'cash') {
        cashBtn.classList.add('border-green-500', 'bg-green-500/10');
    } else if (method === 'card') {
        cardBtn.classList.add('border-blue-500', 'bg-blue-500/10');
    } else if (method === 'qr') {
        qrBtn.classList.add('border-purple-500', 'bg-purple-500/10');
    }

    // Show/hide payment forms
    cardForm.classList.add('hidden');
    qrForm.classList.add('hidden');

    if (method === 'card') {
        cardForm.classList.remove('hidden');
        initStripeElements();
    } else if (method === 'qr') {
        qrForm.classList.remove('hidden');
        // Reset QR form to initial state
        document.getElementById('qr-initial').classList.remove('hidden');
        document.getElementById('qr-loading').classList.add('hidden');
        document.getElementById('qr-display').classList.add('hidden');
        document.getElementById('qr-paid').classList.add('hidden');
        document.getElementById('qr-error').classList.add('hidden');
    }
}

// --- QR CODE PAYMENT ---
let qrCheckoutSessionId = null;
let qrPollingInterval = null;

async function startQrPayment() {
    const initialEl = document.getElementById('qr-initial');
    const loadingEl = document.getElementById('qr-loading');
    const displayEl = document.getElementById('qr-display');
    const paidEl = document.getElementById('qr-paid');
    const errorEl = document.getElementById('qr-error');
    const errorMsg = document.getElementById('qr-error-msg');

    initialEl.classList.add('hidden');
    loadingEl.classList.remove('hidden');
    displayEl.classList.add('hidden');
    paidEl.classList.add('hidden');
    errorEl.classList.add('hidden');

    try {
        const res = await fetch('/api/staff/onboarding-checkout-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                plan_id: onboardingState.data.planId,
                client_name: onboardingState.data.name
            })
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || 'Failed to create checkout session');
        }

        const data = await res.json();
        qrCheckoutSessionId = data.session_id;

        // Generate QR code
        const container = document.getElementById('qr-code-container');
        container.innerHTML = '';
        new QRCode(container, {
            text: data.checkout_url,
            width: 200,
            height: 200,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.M
        });

        loadingEl.classList.add('hidden');
        displayEl.classList.remove('hidden');

        startPollingPayment();
    } catch (e) {
        console.error('QR payment error:', e);
        loadingEl.classList.add('hidden');
        errorEl.classList.remove('hidden');
        errorMsg.textContent = e.message || 'Payment setup failed';
    }
}

function startPollingPayment() {
    if (qrPollingInterval) clearInterval(qrPollingInterval);

    qrPollingInterval = setInterval(async () => {
        if (!qrCheckoutSessionId) {
            clearInterval(qrPollingInterval);
            return;
        }

        try {
            const res = await fetch(`/api/staff/checkout-session-status/${qrCheckoutSessionId}`, {
                credentials: 'include'
            });
            if (!res.ok) return;

            const data = await res.json();
            if (data.status === 'paid') {
                clearInterval(qrPollingInterval);
                qrPollingInterval = null;

                document.getElementById('qr-display').classList.add('hidden');
                document.getElementById('qr-paid').classList.remove('hidden');

                await finalizeQrOnboarding(data.payment_intent_id);
            }
        } catch (e) {
            console.error('Polling error:', e);
        }
    }, 3000);
}

function stopPollingPayment() {
    if (qrPollingInterval) {
        clearInterval(qrPollingInterval);
        qrPollingInterval = null;
    }
    qrCheckoutSessionId = null;
}

async function finalizeQrOnboarding(paymentIntentId) {
    const completeBtn = document.getElementById('onboard-complete-btn');
    completeBtn.disabled = true;
    completeBtn.textContent = 'Registering...';

    try {
        const payload = {
            name: onboardingState.data.name,
            phone: onboardingState.data.phone,
            email: onboardingState.data.email || null,
            date_of_birth: onboardingState.data.dateOfBirth || null,
            username: onboardingState.data.username,
            document_type: onboardingState.data.documentType,
            plan_id: onboardingState.data.planId,
            payment_method: 'qr',
            profile_photo: onboardingState.data.profilePhoto || null,
            stripe_payment_intent_id: paymentIntentId
        };

        if (onboardingState.data.documentType === 'waiver') {
            payload.document_data = signatureCanvas.toDataURL('image/png');
            payload.waiver_text = document.getElementById('waiver-text-display').textContent;
        } else {
            const fileInput = document.getElementById('medical-file');
            if (fileInput.files && fileInput.files[0]) {
                payload.document_data = await fileToBase64(fileInput.files[0]);
            }
        }

        const res = await fetch('/api/staff/onboard-client', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            const data = await res.json();
            closeOnboardingWizard();
            showTemporaryPasswordModal(data.name, data.username, data.temporary_password);
            await loadStaffData();
        } else {
            const err = await res.json();
            showToast(err.detail || 'Registration failed', 'error');
        }
    } catch (error) {
        console.error('QR onboarding error:', error);
        showToast(error.message || 'Registration failed', 'error');
    } finally {
        completeBtn.disabled = false;
        completeBtn.textContent = 'Complete Registration';
    }
}

function retryQrPayment() {
    stopPollingPayment();
    startQrPayment();
}

// Document type selection
function selectDocType(type) {
    onboardingState.data.documentType = type;

    const waiverBtn = document.getElementById('doc-type-waiver');
    const medicalBtn = document.getElementById('doc-type-medical');
    const waiverSection = document.getElementById('waiver-section');
    const medicalSection = document.getElementById('medical-section');

    if (type === 'waiver') {
        waiverBtn.className = 'flex-1 py-3 rounded-xl text-sm font-semibold transition bg-primary/20 text-primary border border-primary/30';
        medicalBtn.className = 'flex-1 py-3 rounded-xl text-sm font-semibold transition bg-white/5 text-white/60 border border-white/10 hover:bg-white/10';
        waiverSection.classList.remove('hidden');
        medicalSection.classList.add('hidden');
    } else {
        medicalBtn.className = 'flex-1 py-3 rounded-xl text-sm font-semibold transition bg-primary/20 text-primary border border-primary/30';
        waiverBtn.className = 'flex-1 py-3 rounded-xl text-sm font-semibold transition bg-white/5 text-white/60 border border-white/10 hover:bg-white/10';
        medicalSection.classList.remove('hidden');
        waiverSection.classList.add('hidden');
    }
}

// Signature canvas - supports mouse, touch, and pen tablets (XP-Pen, Wacom, etc.)
let lastX = 0, lastY = 0;
let canvasInitialized = false;

function initSignatureCanvas() {
    signatureCanvas = document.getElementById('signature-canvas');
    if (!signatureCanvas) {
        console.error('Signature canvas not found');
        return;
    }

    // Get actual displayed size
    const rect = signatureCanvas.getBoundingClientRect();
    console.log('Canvas rect:', rect.width, rect.height);

    // If canvas has no size, it's probably still hidden - retry
    if (rect.width === 0 || rect.height === 0) {
        console.log('Canvas has no size, retrying...');
        setTimeout(initSignatureCanvas, 100);
        return;
    }

    // Remove old event listeners if re-initializing
    if (canvasInitialized) {
        signatureCanvas.removeEventListener('mousedown', handleMouseDown);
        signatureCanvas.removeEventListener('mousemove', handleMouseMove);
        signatureCanvas.removeEventListener('mouseup', handleMouseUp);
        signatureCanvas.removeEventListener('mouseleave', handleMouseUp);
    }

    signatureCtx = signatureCanvas.getContext('2d');

    // Set canvas internal size to match displayed size (1:1 for simplicity)
    signatureCanvas.width = rect.width;
    signatureCanvas.height = rect.height;

    // Set drawing styles
    signatureCtx.lineCap = 'round';
    signatureCtx.lineJoin = 'round';
    signatureCtx.strokeStyle = '#000';
    signatureCtx.lineWidth = 2;

    // Clear with white background
    signatureCtx.fillStyle = '#fff';
    signatureCtx.fillRect(0, 0, rect.width, rect.height);

    // Mouse events - most pen tablets (XP-Pen, Wacom) work as mouse emulation
    signatureCanvas.addEventListener('mousedown', handleMouseDown);
    signatureCanvas.addEventListener('mousemove', handleMouseMove);
    signatureCanvas.addEventListener('mouseup', handleMouseUp);
    signatureCanvas.addEventListener('mouseleave', handleMouseUp);

    // Touch events for mobile/tablets
    signatureCanvas.addEventListener('touchstart', handleTouchStart, { passive: false });
    signatureCanvas.addEventListener('touchmove', handleTouchMove, { passive: false });
    signatureCanvas.addEventListener('touchend', handleMouseUp);
    signatureCanvas.addEventListener('touchcancel', handleMouseUp);

    canvasInitialized = true;
    console.log('Signature canvas initialized successfully:', rect.width, 'x', rect.height);
}

function getCanvasCoords(e, isTouch = false) {
    const rect = signatureCanvas.getBoundingClientRect();
    if (isTouch && e.touches && e.touches.length > 0) {
        return {
            x: e.touches[0].clientX - rect.left,
            y: e.touches[0].clientY - rect.top
        };
    }
    return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
    };
}

function hidePlaceholder() {
    const placeholder = document.getElementById('signature-placeholder');
    if (placeholder) placeholder.classList.add('hidden');
}

// Mouse handlers (works with XP-Pen and other pen tablets)
function handleMouseDown(e) {
    e.preventDefault();
    isDrawing = true;
    hidePlaceholder();

    const coords = getCanvasCoords(e);
    lastX = coords.x;
    lastY = coords.y;

    // Draw initial dot
    signatureCtx.fillStyle = '#000';
    signatureCtx.beginPath();
    signatureCtx.arc(lastX, lastY, 1, 0, Math.PI * 2);
    signatureCtx.fill();
}

function handleMouseMove(e) {
    if (!isDrawing) return;
    e.preventDefault();

    const coords = getCanvasCoords(e);

    signatureCtx.beginPath();
    signatureCtx.moveTo(lastX, lastY);
    signatureCtx.lineTo(coords.x, coords.y);
    signatureCtx.stroke();

    lastX = coords.x;
    lastY = coords.y;
}

function handleMouseUp(e) {
    isDrawing = false;
}

// Touch handlers
function handleTouchStart(e) {
    e.preventDefault();
    if (e.touches.length === 0) return;

    isDrawing = true;
    hidePlaceholder();

    const coords = getCanvasCoords(e, true);
    lastX = coords.x;
    lastY = coords.y;

    // Draw initial dot
    signatureCtx.fillStyle = '#000';
    signatureCtx.beginPath();
    signatureCtx.arc(lastX, lastY, 1, 0, Math.PI * 2);
    signatureCtx.fill();
}

function handleTouchMove(e) {
    e.preventDefault();
    if (!isDrawing || e.touches.length === 0) return;

    const coords = getCanvasCoords(e, true);

    signatureCtx.beginPath();
    signatureCtx.moveTo(lastX, lastY);
    signatureCtx.lineTo(coords.x, coords.y);
    signatureCtx.stroke();

    lastX = coords.x;
    lastY = coords.y;
}

function clearSignature() {
    if (!signatureCanvas || !signatureCtx) return;
    const rect = signatureCanvas.getBoundingClientRect();
    signatureCtx.fillStyle = '#fff';
    signatureCtx.fillRect(0, 0, rect.width, rect.height);

    // Show placeholder text again
    const placeholder = document.getElementById('signature-placeholder');
    if (placeholder) placeholder.classList.remove('hidden');
}

function hasSignature() {
    if (!signatureCanvas) return false;
    const ctx = signatureCanvas.getContext('2d');
    const pixelData = ctx.getImageData(0, 0, signatureCanvas.width, signatureCanvas.height).data;

    // Check if any pixel is not white
    for (let i = 0; i < pixelData.length; i += 4) {
        if (pixelData[i] < 250 || pixelData[i + 1] < 250 || pixelData[i + 2] < 250) {
            return true;
        }
    }
    return false;
}

// Medical file preview
function previewMedicalFile(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        document.getElementById('medical-filename').textContent = file.name;
        document.getElementById('medical-preview').classList.remove('hidden');
    }
}

function removeMedicalFile() {
    document.getElementById('medical-file').value = '';
    document.getElementById('medical-preview').classList.add('hidden');
}

// ========== STRIPE INTEGRATION FOR ONBOARDING ==========
let onboardStripe = null;
let onboardCardElement = null;
let onboardSecret = null;

async function initStripeElements() {
    // Only initialize once
    if (onboardStripe && onboardCardElement) return;

    // Load Stripe.js if not loaded
    if (!window.Stripe) {
        console.log('Loading Stripe.js...');
        await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://js.stripe.com/v3/';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }

    // Get publishable key from server
    try {
        const res = await fetch('/api/stripe/publishable-key', { credentials: 'include' });
        if (!res.ok) {
            console.error('Could not get Stripe publishable key');
            showToast('Card payments not available', 'error');
            return;
        }
        const { publishable_key } = await res.json();

        if (!publishable_key || publishable_key.startsWith('your_')) {
            console.error('Stripe not configured');
            showToast('Card payments not configured', 'error');
            return;
        }

        onboardStripe = Stripe(publishable_key);

        // Create Elements instance
        const elements = onboardStripe.elements();

        // Create card element with explicit styling
        onboardCardElement = elements.create('card', {
            style: {
                base: {
                    color: '#1a1a1a',
                    fontFamily: 'system-ui, -apple-system, sans-serif',
                    fontSmoothing: 'antialiased',
                    fontSize: '18px',
                    lineHeight: '24px',
                    '::placeholder': {
                        color: '#6b7280'
                    }
                },
                invalid: {
                    color: '#ef4444',
                    iconColor: '#ef4444'
                }
            }
        });

        // Mount to the container
        onboardCardElement.mount('#stripe-card-element');

        // Handle validation errors
        onboardCardElement.on('change', (event) => {
            const errorsEl = document.getElementById('onboard-card-errors');
            if (event.error) {
                errorsEl.textContent = event.error.message;
                errorsEl.classList.remove('hidden');
            } else {
                errorsEl.textContent = '';
                errorsEl.classList.add('hidden');
            }
        });

        console.log('Stripe card element mounted successfully');
    } catch (e) {
        console.error('Error initializing Stripe:', e);
        showToast('Failed to initialize card payment', 'error');
    }
}

async function createPaymentIntent() {
    try {
        const res = await fetch('/api/staff/create-payment-intent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                plan_id: onboardingState.data.planId,
                client_name: onboardingState.data.name
            })
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || 'Failed to create payment');
        }

        const data = await res.json();
        onboardSecret = data.client_secret;
        return data;
    } catch (e) {
        console.error('Error creating payment intent:', e);
        throw e;
    }
}

async function processCardPayment() {
    if (!onboardStripe || !onboardCardElement || !onboardSecret) {
        throw new Error('Card payment not initialized');
    }

    const billingDetails = { name: onboardingState.data.name };
    if (onboardingState.data.email && onboardingState.data.email.includes('@')) {
        billingDetails.email = onboardingState.data.email;
    }

    const { error, paymentIntent } = await onboardStripe.confirmCardPayment(onboardSecret, {
        payment_method: {
            card: onboardCardElement,
            billing_details: billingDetails
        }
    });

    if (error) {
        throw new Error(error.message);
    }

    return paymentIntent;
}

// Complete onboarding
async function completeOnboarding() {
    // Validate payment method if plan selected
    if (onboardingState.data.planId && !onboardingState.data.paymentMethod) {
        showToast('Please select a payment method', 'error');
        return;
    }

    const completeBtn = document.getElementById('onboard-complete-btn');
    completeBtn.disabled = true;
    let stripePaymentIntentId = null;

    try {
        // If card payment, process payment first
        if (onboardingState.data.paymentMethod === 'card') {
            completeBtn.textContent = 'Processing payment...';

            // Create payment intent
            await createPaymentIntent();

            // Process the card payment
            const paymentIntent = await processCardPayment();
            stripePaymentIntentId = paymentIntent.id;
            console.log('Payment successful:', paymentIntent.id);
        }

        // If QR payment, start QR flow and return (auto-completes after payment)
        if (onboardingState.data.paymentMethod === 'qr') {
            completeBtn.textContent = 'Generating QR Code...';
            await startQrPayment();
            completeBtn.textContent = 'Waiting for QR Payment...';
            return;
        }

        completeBtn.textContent = 'Registering...';

        // Prepare data
        const payload = {
            name: onboardingState.data.name,
            phone: onboardingState.data.phone,
            email: onboardingState.data.email || null,
            date_of_birth: onboardingState.data.dateOfBirth || null,
            username: onboardingState.data.username,
            document_type: onboardingState.data.documentType,
            plan_id: onboardingState.data.planId,
            payment_method: onboardingState.data.paymentMethod || 'none',
            profile_photo: onboardingState.data.profilePhoto || null,
            stripe_payment_intent_id: stripePaymentIntentId
        };

        // Add document data
        if (onboardingState.data.documentType === 'waiver') {
            payload.document_data = signatureCanvas.toDataURL('image/png');
            payload.waiver_text = document.getElementById('waiver-text-display').textContent;
        } else {
            // Read file as base64
            const fileInput = document.getElementById('medical-file');
            if (fileInput.files && fileInput.files[0]) {
                payload.document_data = await fileToBase64(fileInput.files[0]);
            }
        }

        const res = await fetch('/api/staff/onboard-client', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            const data = await res.json();
            closeOnboardingWizard();
            showTemporaryPasswordModal(data.name, data.username, data.temporary_password);
            await loadStaffData();
        } else {
            const err = await res.json();
            showToast(err.detail || 'Registration failed', 'error');
        }
    } catch (error) {
        console.error('Onboarding error:', error);
        showToast(error.message || 'Registration failed', 'error');
    } finally {
        completeBtn.disabled = false;
        completeBtn.textContent = 'Complete Registration';
    }
}

function showTemporaryPasswordModal(name, username, password) {
    document.getElementById('temp-pw-name').textContent = name;
    document.getElementById('temp-pw-username').textContent = username;
    document.getElementById('temp-pw-password').textContent = password;
    document.getElementById('temp-password-modal').classList.remove('hidden');
}

function closeTempPasswordModal() {
    document.getElementById('temp-password-modal').classList.add('hidden');
}

function copyTempPassword() {
    const pw = document.getElementById('temp-pw-password').textContent;
    navigator.clipboard.writeText(pw).then(() => {
        showToast('Password copied to clipboard', 'success');
    }).catch(() => {
        showToast('Failed to copy', 'error');
    });
}

function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

function previewOnboardPhoto(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        if (file.size > 5 * 1024 * 1024) {
            showToast('Photo must be under 5MB', 'error');
            input.value = '';
            return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
            onboardingState.data.profilePhoto = e.target.result;
            document.getElementById('onboard-photo-img').src = e.target.result;
            document.getElementById('onboard-photo-img').classList.remove('hidden');
            document.getElementById('onboard-photo-placeholder').classList.add('hidden');
            document.getElementById('onboard-photo-preview').classList.remove('border-dashed', 'border-white/20');
            document.getElementById('onboard-photo-preview').classList.add('border-solid', 'border-primary/50');
            document.getElementById('onboard-photo-remove-btn').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }
}

function removeOnboardPhoto() {
    onboardingState.data.profilePhoto = null;
    const input = document.getElementById('onboard-photo-input');
    if (input) input.value = '';
    const img = document.getElementById('onboard-photo-img');
    if (img) { img.src = ''; img.classList.add('hidden'); }
    const placeholder = document.getElementById('onboard-photo-placeholder');
    if (placeholder) placeholder.classList.remove('hidden');
    const preview = document.getElementById('onboard-photo-preview');
    if (preview) {
        preview.classList.add('border-dashed', 'border-white/20');
        preview.classList.remove('border-solid', 'border-primary/50');
    }
    const removeBtn = document.getElementById('onboard-photo-remove-btn');
    if (removeBtn) removeBtn.classList.add('hidden');
}

// Close onboarding wizard on background click
document.getElementById('onboarding-wizard-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'onboarding-wizard-modal') {
        closeOnboardingWizard();
    }
});

// ========== NEW CHAT - GYM MEMBERS PICKER ==========
// Used by conversations modal "New" button to start a new chat
window.openGymMembersModal = function() {
    // Build a quick member picker from allMembers + allTrainers
    const people = [
        ...allTrainers.map(t => ({ id: t.id, name: t.username, type: 'Trainer' })),
        ...allMembers.map(m => ({ id: m.id, name: m.name || m.username, type: 'Member' }))
    ];

    if (people.length === 0) {
        showToast('No gym members found', 'error');
        return;
    }

    // Create a temporary modal for member selection
    let modal = document.getElementById('member-picker-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'member-picker-modal';
        modal.className = 'fixed inset-0 bg-black/95 backdrop-blur-xl z-[85] flex flex-col';
        document.body.appendChild(modal);
    }
    modal.classList.remove('hidden');

    modal.innerHTML = `
        <div class="flex items-center justify-between p-4 border-b border-white/10">
            <h3 class="font-bold text-white text-lg">New Message</h3>
            <button onclick="document.getElementById('member-picker-modal').classList.add('hidden')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
        </div>
        <div class="p-4">
            <input type="text" id="member-picker-search" placeholder="Search..."
                class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-primary outline-none mb-3"
                oninput="filterMemberPicker()">
        </div>
        <div id="member-picker-list" class="flex-1 overflow-y-auto px-4 pb-4 space-y-2">
            ${people.map(p => `
                <div class="member-picker-item bg-white/5 hover:bg-white/10 p-3 rounded-xl cursor-pointer transition" data-name="${(p.name || '').toLowerCase()}"
                    onclick="document.getElementById('member-picker-modal').classList.add('hidden'); openChatModal('${p.id}', '${(p.name || '').replace(/'/g, "\\'")}')">
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-full bg-gradient-to-br ${p.type === 'Trainer' ? 'from-orange-500 to-red-500' : 'from-green-500 to-emerald-600'} flex items-center justify-center text-white font-bold text-sm">
                            ${(p.name || '?').charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <p class="font-semibold text-white text-sm">${p.name}</p>
                            <p class="text-[10px] text-gray-500">${p.type}</p>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
};

window.filterMemberPicker = function() {
    const query = (document.getElementById('member-picker-search')?.value || '').toLowerCase();
    document.querySelectorAll('.member-picker-item').forEach(item => {
        const name = item.dataset.name || '';
        item.style.display = name.includes(query) ? '' : 'none';
    });
};
</script>
{% endblock %}
