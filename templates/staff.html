{% extends "base.html" %}
{% from 'macros.html' import card %}

{% block content %}
<!-- ==================== STAFF 3-COLUMN LAYOUT ==================== -->

<!-- ===== MOBILE HEADER ===== -->
<header class="staff-mobile-header">
    <div class="staff-mobile-header-logo">
        <img src="/static/fitos-logo.svg" alt="FitOS" class="staff-logo-img">
        <span class="staff-role-label">{{ role | capitalize }}</span>
    </div>
    <div class="staff-mobile-header-actions">
        <button class="staff-mobile-msg-btn" onclick="toggleMobileMessages()">
            <i data-lucide="message-circle" class="w-5 h-5"></i>
            <span class="staff-mobile-msg-dot" id="mobile-msg-dot" style="display:none;"></span>
        </button>
        <a href="/auth/logout" class="staff-mobile-msg-btn" style="color:#f87171;">
            <i data-lucide="log-out" class="w-5 h-5"></i>
        </a>
    </div>
</header>

<div class="staff-layout">

    <!-- ===== LEFT SIDEBAR ===== -->
    <aside class="staff-sidebar">
        <div class="staff-sidebar-logo">
            <img src="/static/fitos-logo.svg" alt="FitOS" class="staff-logo-img staff-logo-img--sidebar">
            <span class="staff-role-label">{{ role | capitalize }}</span>
        </div>

        <nav class="staff-sidebar-nav">
            <a href="/?gym_id={{ gym_id }}&role=staff&mode=prenotazioni"
               class="staff-nav-item {{ 'active' if mode == 'prenotazioni' else '' }}">
                <i data-lucide="calendar-check" class="w-[18px] h-[18px]"></i>
                <span>Prenotazioni</span>
            </a>
            <a href="/?gym_id={{ gym_id }}&role=staff&mode=dashboard"
               class="staff-nav-item {{ 'active' if mode in ['dashboard', 'settings'] or mode not in ['prenotazioni', 'documenti'] else '' }}">
                <i data-lucide="users" class="w-[18px] h-[18px]"></i>
                <span>Utenti</span>
            </a>
            <a href="/?gym_id={{ gym_id }}&role=staff&mode=documenti"
               class="staff-nav-item {{ 'active' if mode == 'documenti' else '' }}">
                <i data-lucide="file-text" class="w-[18px] h-[18px]"></i>
                <span>Documenti</span>
            </a>
        </nav>

        <div style="flex:1"></div>

        <!-- Sidebar footer -->
        <div style="display:flex;flex-direction:column;gap:0.25rem;">
            <a href="/?gym_id={{ gym_id }}&role=staff&mode=settings"
               class="staff-nav-item {{ 'active' if mode == 'settings' else '' }}">
                <i data-lucide="settings" class="w-[18px] h-[18px]"></i>
                <span>Impostazioni</span>
            </a>
            <a href="/auth/logout" class="staff-nav-item" style="color:#f87171;">
                <i data-lucide="log-out" class="w-[18px] h-[18px]"></i>
                <span>Esci</span>
            </a>
        </div>
    </aside>

    <!-- ===== MAIN CONTENT ===== -->
    <main class="staff-main">

        {% if mode == 'settings' %}
        <!-- ==================== SETTINGS PAGE ==================== -->
        <div class="staff-page-header">
            <h1>Impostazioni</h1>
            <p>Gestisci il tuo account e le preferenze</p>
        </div>

        <div style="max-width:800px;">
            <div class="staff-table-card" style="padding:1.5rem;margin-bottom:1.5rem;">
                <div style="display:flex;align-items:center;gap:1.25rem;margin-bottom:1.5rem;">
                    <div style="width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#06b6d4);display:flex;align-items:center;justify-content:center;">
                        <i data-lucide="user" class="w-7 h-7 text-white"></i>
                    </div>
                    <div>
                        <h3 style="font-size:1.25rem;font-weight:700;color:white;" id="staff-name">Staff Member</h3>
                        <p style="font-size:0.85rem;color:rgba(255,255,255,0.4);">Reception / Staff</p>
                    </div>
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;">
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:0.75rem;background:rgba(255,255,255,0.03);border-radius:10px;">
                        <span style="color:rgba(255,255,255,0.45);font-size:0.85rem;">Ruolo</span>
                        <span style="color:white;font-weight:600;font-size:0.85rem;">Staff / Reception</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:0.75rem;background:rgba(255,255,255,0.03);border-radius:10px;">
                        <span style="color:rgba(255,255,255,0.45);font-size:0.85rem;">Palestra</span>
                        <span style="color:white;font-weight:600;font-size:0.85rem;" id="gym-name-display">Loading...</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:0.75rem;background:rgba(255,255,255,0.03);border-radius:10px;">
                        <span style="color:rgba(255,255,255,0.45);font-size:0.85rem;">Stato</span>
                        <span style="color:#4ade80;font-weight:600;font-size:0.85rem;display:flex;align-items:center;gap:6px;">
                            <span style="width:6px;height:6px;border-radius:50%;background:#4ade80;"></span> Attivo
                        </span>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:0.75rem;background:rgba(255,255,255,0.03);border-radius:10px;">
                        <span style="color:rgba(255,255,255,0.45);font-size:0.85rem;">Accesso</span>
                        <span style="color:white;font-weight:600;font-size:0.85rem;">Completo</span>
                    </div>
                </div>
            </div>
        </div>

        {% elif mode == 'prenotazioni' %}
        <!-- ==================== PRENOTAZIONI (APPOINTMENTS) PAGE ==================== -->
        <div class="staff-page-header">
            <h1>Prenotazioni</h1>
            <p>Gestisci gli appuntamenti e i check-in dei clienti</p>
        </div>

        <!-- Stats -->
        <div class="staff-stats-bar" style="display:inline-flex;margin-bottom:1.5rem;">
            <div class="staff-stat-item">
                <span class="staff-stat-value text-primary" id="members-today">0</span>
                <span class="staff-stat-label">Check-in oggi</span>
            </div>
            <div class="staff-stat-item">
                <span class="staff-stat-value" style="color:#a78bfa;" id="appointments-count">0</span>
                <span class="staff-stat-label">Appuntamenti</span>
            </div>
            <div class="staff-stat-item">
                <span class="staff-stat-value" style="color:#4ade80;" id="trainers-count">0</span>
                <span class="staff-stat-label">Trainer</span>
            </div>
        </div>

        <!-- Quick Check-In -->
        <div class="staff-search-bar" style="max-width:480px;margin-bottom:1.5rem;">
            <i data-lucide="search" class="w-4 h-4 search-icon"></i>
            <input type="text" id="checkin-search" placeholder="Cerca cliente per check-in...">
        </div>
        <div id="search-results" class="hidden" style="max-width:480px;margin-bottom:1rem;"></div>

        <!-- Appointments + Check-ins grid -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;">
            <!-- Today's Appointments -->
            <div>
                <h3 style="font-size:0.8rem;font-weight:700;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.75rem;">Appuntamenti di oggi</h3>
                <div class="staff-table-card">
                    <div id="todays-appointments-list" style="padding:0.5rem;">
                        <p style="text-align:center;color:rgba(255,255,255,0.35);font-size:0.85rem;padding:2rem 0;">Caricamento...</p>
                    </div>
                </div>
            </div>

            <!-- Recent Check-ins -->
            <div>
                <h3 style="font-size:0.8rem;font-weight:700;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.75rem;">Check-in recenti</h3>
                <div class="staff-table-card">
                    <div id="recent-checkins-list" style="padding:0.5rem;">
                        <p style="text-align:center;color:rgba(255,255,255,0.35);font-size:0.85rem;padding:2rem 0;">Nessun check-in oggi</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trainers section -->
        <div style="margin-top:1.5rem;">
            <h3 style="font-size:0.8rem;font-weight:700;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.75rem;">Trainer</h3>
            <div id="trainers-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:0.75rem;">
                <p style="color:rgba(255,255,255,0.35);font-size:0.85rem;padding:1rem 0;">Caricamento...</p>
            </div>
        </div>

        {% elif mode == 'documenti' %}
        <!-- ==================== DOCUMENTI (DOCUMENTS) PAGE ==================== -->
        <div class="staff-page-header">
            <h1>Documenti</h1>
            <p>Certificati medici e documentazione dei clienti</p>
        </div>

        <!-- Search -->
        <div class="staff-search-bar" style="max-width:400px;margin-bottom:1.25rem;">
            <i data-lucide="search" class="w-4 h-4 search-icon"></i>
            <input type="text" id="doc-search" placeholder="Cerca clienti...">
        </div>

        <!-- Documents Table (desktop) -->
        <div class="staff-table-card staff-desktop-only">
            <table class="staff-table">
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Certificato Medico</th>
                        <th>Scadenza</th>
                        <th>Stato</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="documents-table-body">
                    <tr class="staff-skeleton-row"><td><div class="staff-skeleton" style="width:140px;"></div></td><td><div class="staff-skeleton" style="width:100px;"></div></td><td><div class="staff-skeleton" style="width:80px;"></div></td><td><div class="staff-skeleton" style="width:60px;"></div></td><td><div class="staff-skeleton" style="width:50px;"></div></td></tr>
                    <tr class="staff-skeleton-row"><td><div class="staff-skeleton" style="width:120px;"></div></td><td><div class="staff-skeleton" style="width:90px;"></div></td><td><div class="staff-skeleton" style="width:80px;"></div></td><td><div class="staff-skeleton" style="width:60px;"></div></td><td><div class="staff-skeleton" style="width:50px;"></div></td></tr>
                </tbody>
            </table>
        </div>

        <!-- Documents List (mobile) -->
        <div class="staff-mobile-cards staff-mobile-only" id="documents-mobile-list">
            <div class="staff-mobile-card staff-skeleton-card"><div class="staff-skeleton" style="width:36px;height:36px;border-radius:50%;"></div><div style="flex:1;"><div class="staff-skeleton" style="width:120px;margin-bottom:6px;"></div><div class="staff-skeleton" style="width:80px;height:10px;"></div></div></div>
            <div class="staff-mobile-card staff-skeleton-card"><div class="staff-skeleton" style="width:36px;height:36px;border-radius:50%;"></div><div style="flex:1;"><div class="staff-skeleton" style="width:100px;margin-bottom:6px;"></div><div class="staff-skeleton" style="width:70px;height:10px;"></div></div></div>
        </div>

        {% else %}
        <!-- ==================== UTENTI (USERS) PAGE - DEFAULT ==================== -->
        <div class="staff-page-header">
            <h1>Utenti</h1>
            <p>Da qui puoi registrare, cercare o gestire i clienti e i loro dati</p>
        </div>

        <!-- Stats bar + Actions -->
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem;">
            <div class="staff-stats-bar" style="margin-bottom:0;">
                <div class="staff-stat-item">
                    <span class="staff-stat-value text-primary" id="total-members">0</span>
                    <span class="staff-stat-label">Clienti</span>
                </div>
                <div class="staff-stat-item">
                    <span class="staff-stat-value" style="color:rgba(255,255,255,0.5);" id="inactive-members">0</span>
                    <span class="staff-stat-label">Inattivi</span>
                </div>
                <div class="staff-stat-item">
                    <span class="staff-stat-value" style="color:#f87171;" id="at-risk-members">0</span>
                    <span class="staff-stat-label">A rischio</span>
                </div>
            </div>

            <div class="staff-actions-right">
                <button onclick="openQrScanner()" class="staff-btn-action" title="Scan QR">
                    <i data-lucide="scan" class="w-4 h-4"></i>
                    Scan QR
                </button>
                <button onclick="openOnboardingWizard()" class="staff-btn-action staff-btn-primary">
                    <i data-lucide="user-plus" class="w-4 h-4"></i>
                    Registra Cliente
                </button>
            </div>
        </div>

        <!-- Search -->
        <div class="staff-search-bar" style="max-width:400px;">
            <i data-lucide="search" class="w-4 h-4 search-icon"></i>
            <input type="text" id="member-search" placeholder="Cerca clienti">
        </div>

        <!-- Hidden search results for QR check-in flow -->
        <div id="search-results" class="hidden" style="max-width:480px;margin-bottom:1rem;"></div>
        <!-- Hidden input for QR check-in (used by searchMember) -->
        <input type="hidden" id="checkin-search">

        <!-- Members Table (desktop) -->
        <div class="staff-table-card staff-desktop-only">
            <table class="staff-table">
                <thead>
                    <tr>
                        <th style="width:40px;"><input type="checkbox" style="opacity:0.3;"></th>
                        <th>Clienti</th>
                        <th>Abbonamento</th>
                        <th>Certificato Medico</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="members-table-body">
                    <tr class="staff-skeleton-row"><td></td><td><div class="staff-skeleton" style="width:160px;"></div></td><td><div class="staff-skeleton" style="width:100px;"></div></td><td><div class="staff-skeleton" style="width:90px;"></div></td><td><div class="staff-skeleton" style="width:70px;"></div></td></tr>
                    <tr class="staff-skeleton-row"><td></td><td><div class="staff-skeleton" style="width:130px;"></div></td><td><div class="staff-skeleton" style="width:110px;"></div></td><td><div class="staff-skeleton" style="width:80px;"></div></td><td><div class="staff-skeleton" style="width:70px;"></div></td></tr>
                    <tr class="staff-skeleton-row"><td></td><td><div class="staff-skeleton" style="width:150px;"></div></td><td><div class="staff-skeleton" style="width:90px;"></div></td><td><div class="staff-skeleton" style="width:100px;"></div></td><td><div class="staff-skeleton" style="width:70px;"></div></td></tr>
                    <tr class="staff-skeleton-row"><td></td><td><div class="staff-skeleton" style="width:140px;"></div></td><td><div class="staff-skeleton" style="width:100px;"></div></td><td><div class="staff-skeleton" style="width:85px;"></div></td><td><div class="staff-skeleton" style="width:70px;"></div></td></tr>
                </tbody>
            </table>
        </div>

        <!-- Members List (mobile) -->
        <div class="staff-mobile-cards staff-mobile-only" id="members-mobile-list">
            <div class="staff-mobile-card staff-skeleton-card"><div class="staff-skeleton" style="width:36px;height:36px;border-radius:50%;"></div><div style="flex:1;"><div class="staff-skeleton" style="width:120px;margin-bottom:6px;"></div><div class="staff-skeleton" style="width:80px;height:10px;"></div></div></div>
            <div class="staff-mobile-card staff-skeleton-card"><div class="staff-skeleton" style="width:36px;height:36px;border-radius:50%;"></div><div style="flex:1;"><div class="staff-skeleton" style="width:100px;margin-bottom:6px;"></div><div class="staff-skeleton" style="width:60px;height:10px;"></div></div></div>
            <div class="staff-mobile-card staff-skeleton-card"><div class="staff-skeleton" style="width:36px;height:36px;border-radius:50%;"></div><div style="flex:1;"><div class="staff-skeleton" style="width:140px;margin-bottom:6px;"></div><div class="staff-skeleton" style="width:90px;height:10px;"></div></div></div>
        </div>

        <!-- NFC Shower System (collapsible) -->
        <div style="margin-top:1.5rem;">
            <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;">
                <i data-lucide="radio" class="w-4 h-4" style="color:#22d3ee;"></i>
                <span style="font-size:0.8rem;font-weight:700;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.05em;">NFC Shower System</span>
                <button onclick="toggleNfcSection()" id="nfc-toggle-btn" style="font-size:0.7rem;background:rgba(34,211,238,0.15);color:#22d3ee;padding:0.25rem 0.6rem;border-radius:6px;cursor:pointer;font-weight:600;border:none;">Show</button>
            </div>
            <div id="nfc-section" class="hidden">
                <div class="staff-table-card" style="padding:1rem;margin-bottom:0.75rem;">
                    <h4 style="font-size:0.85rem;font-weight:600;color:white;margin-bottom:0.75rem;">Registra Tag NFC</h4>
                    <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                        <input type="text" id="nfc-uid-input" placeholder="UID del tag NFC..." style="flex:1;min-width:150px;padding:0.5rem 0.75rem;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:white;font-size:0.8rem;font-family:monospace;text-transform:uppercase;outline:none;">
                        <select id="nfc-member-select" style="flex:1;min-width:150px;padding:0.5rem 0.75rem;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:white;font-size:0.8rem;outline:none;">
                            <option value="">Seleziona membro...</option>
                        </select>
                        <input type="text" id="nfc-label-input" placeholder="Etichetta (opzionale)" style="width:120px;padding:0.5rem 0.75rem;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:white;font-size:0.8rem;outline:none;">
                        <button onclick="registerNfcTag()" style="padding:0.5rem 1rem;background:#22d3ee;border:none;border-radius:8px;color:white;font-size:0.8rem;font-weight:600;cursor:pointer;">Registra</button>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;">
                    <div class="staff-table-card" style="padding:1rem;">
                        <h4 style="font-size:0.8rem;font-weight:600;color:white;margin-bottom:0.5rem;">Tag registrati <span id="nfc-tags-count" style="color:rgba(255,255,255,0.3);">0</span></h4>
                        <div id="nfc-tags-list" style="max-height:200px;overflow-y:auto;"></div>
                    </div>
                    <div class="staff-table-card" style="padding:1rem;">
                        <h4 style="font-size:0.8rem;font-weight:600;color:white;margin-bottom:0.5rem;">Docce oggi <span id="shower-usage-count" style="color:rgba(255,255,255,0.3);">0</span></h4>
                        <div id="shower-usage-list" style="max-height:200px;overflow-y:auto;"></div>
                    </div>
                </div>
            </div>
        </div>

        {% endif %}
    </main>

    <!-- ===== RIGHT PANEL - MESSAGES ===== -->
    <aside class="staff-right-panel">
        <div class="staff-messages-header">
            <div style="display:flex;align-items:center;justify-content:space-between;">
                <h3 style="font-size:1rem;font-weight:700;color:white;">Messaggi</h3>
                <button onclick="openConversationsModal()" style="font-size:0.75rem;color:var(--primary);font-weight:600;background:none;border:none;cursor:pointer;">Vedi tutti</button>
            </div>
        </div>

        <div class="staff-messages-search">
            <div class="staff-search-bar" style="margin-bottom:0;">
                <i data-lucide="search" class="w-4 h-4 search-icon"></i>
                <input type="text" id="messages-search" placeholder="Cerca clienti">
            </div>
        </div>

        <div class="staff-messages-list" id="staff-conversations-list">
            <!-- Populated by JS -->
            <div style="text-align:center;padding:3rem 1rem;color:rgba(255,255,255,0.3);font-size:0.85rem;">
                Caricamento messaggi...
            </div>
        </div>
    </aside>

</div>

<!-- ===== MOBILE MESSAGES OVERLAY ===== -->
<div class="staff-mobile-messages-overlay" id="mobile-messages-overlay">
    <div class="staff-mobile-messages-panel">
        <div class="staff-messages-header">
            <div style="display:flex;align-items:center;justify-content:space-between;">
                <h3 style="font-size:1rem;font-weight:700;color:white;">Messaggi</h3>
                <button onclick="toggleMobileMessages()" style="font-size:1.5rem;color:rgba(255,255,255,0.5);background:none;border:none;cursor:pointer;">&times;</button>
            </div>
        </div>
        <div class="staff-messages-search">
            <div class="staff-search-bar" style="margin-bottom:0;">
                <i data-lucide="search" class="w-4 h-4 search-icon"></i>
                <input type="text" id="mobile-messages-search" placeholder="Cerca clienti">
            </div>
        </div>
        <div class="staff-messages-list" id="mobile-conversations-list">
            <div style="text-align:center;padding:3rem 1rem;color:rgba(255,255,255,0.3);font-size:0.85rem;">
                Caricamento messaggi...
            </div>
        </div>
    </div>
</div>

<!-- ===== MOBILE BOTTOM NAV ===== -->
<nav class="staff-mobile-nav">
    <a href="/?gym_id={{ gym_id }}&role=staff&mode=prenotazioni"
       class="staff-mobile-nav-item {{ 'active' if mode == 'prenotazioni' else '' }}">
        <i data-lucide="calendar-check" class="w-5 h-5"></i>
        <span>Prenotazioni</span>
    </a>
    <a href="/?gym_id={{ gym_id }}&role=staff&mode=dashboard"
       class="staff-mobile-nav-item {{ 'active' if mode in ['dashboard', 'settings'] or mode not in ['prenotazioni', 'documenti'] else '' }}">
        <i data-lucide="users" class="w-5 h-5"></i>
        <span>Utenti</span>
    </a>
    <a href="/?gym_id={{ gym_id }}&role=staff&mode=documenti"
       class="staff-mobile-nav-item {{ 'active' if mode == 'documenti' else '' }}">
        <i data-lucide="file-text" class="w-5 h-5"></i>
        <span>Documenti</span>
    </a>
    <a href="/?gym_id={{ gym_id }}&role=staff&mode=settings"
       class="staff-mobile-nav-item {{ 'active' if mode == 'settings' else '' }}">
        <i data-lucide="settings" class="w-5 h-5"></i>
        <span>Impostazioni</span>
    </a>
</nav>

<!-- Hidden elements for backward compat (old stat IDs) -->
<span id="members-count" class="hidden">0</span>
<span id="members-today-compat" class="hidden">0</span>

<!-- Trainer Schedule Modal -->
<div id="trainer-schedule-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-white" id="trainer-modal-title">Orario Trainer</h3>
            <button onclick="closeTrainerModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>

        <!-- Availability -->
        <div class="mb-4">
            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-2">Disponibilità Settimanale</h4>
            <div id="trainer-availability" class="space-y-2">
                <p class="text-gray-400 text-sm">Loading...</p>
            </div>
        </div>

        <!-- Today's Schedule -->
        <div>
            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-2">Appuntamenti di Oggi</h4>
            <div id="trainer-today-schedule" class="space-y-2">
                <p class="text-gray-400 text-sm">Loading...</p>
            </div>
        </div>
    </div>
</div>


<!-- Member Profile Modal -->
<div id="member-profile-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 rounded-2xl max-w-lg w-full max-h-[85vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-white">Profilo Membro</h3>
            <button onclick="closeMemberModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>

        <!-- Member Header -->
        <div class="flex items-center gap-4 mb-6">
            <div id="member-avatar" class="w-16 h-16 rounded-full bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-white font-bold text-2xl">
                ?
            </div>
            <div>
                <h4 class="text-xl font-bold text-white" id="member-name">Loading...</h4>
                <p class="text-sm text-gray-400" id="member-email">-</p>
            </div>
        </div>

        <!-- Status Badge -->
        <div class="mb-6">
            <div id="member-status-badge" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-500/20 text-green-400 text-sm font-semibold">
                <span class="w-2 h-2 rounded-full bg-green-400"></span>
                Active
            </div>
        </div>

        <!-- Member Info -->
        <div class="glass-card p-4 mb-4">
            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Info Membro</h4>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-400">Membro dal</span>
                    <span class="text-white" id="member-since">-</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Trainer Assegnato</span>
                    <span class="text-white" id="member-trainer">Nessuno</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Ultimo Check-in</span>
                    <span class="text-white" id="member-last-checkin">Mai</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Check-in Totali</span>
                    <span class="text-white" id="member-total-checkins">0</span>
                </div>
            </div>
        </div>

        <!-- Subscription Info -->
        <div class="glass-card p-4 mb-4">
            <div class="flex justify-between items-center mb-3">
                <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Abbonamento</h4>
                <button onclick="openSubscriptionManager()" class="text-xs text-primary hover:text-primary/80 font-semibold">
                    Gestisci →
                </button>
            </div>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-400">Piano</span>
                    <span class="text-white" id="member-plan">-</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Stato</span>
                    <span id="member-sub-status" class="text-green-400">-</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Scadenza</span>
                    <span class="text-white" id="member-sub-expires">-</span>
                </div>
            </div>
            <!-- Quick subscription actions -->
            <div id="subscription-actions" class="mt-3 pt-3 border-t border-white/10 hidden">
                <div class="flex gap-2">
                    <button onclick="openPlanSelector()" id="assign-plan-btn"
                        class="flex-1 bg-primary/20 hover:bg-primary/30 text-primary py-2 rounded-lg text-xs font-semibold transition">
                        Assegna Piano
                    </button>
                    <button onclick="cancelMemberSubscription()" id="cancel-sub-btn"
                        class="flex-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 py-2 rounded-lg text-xs font-semibold transition hidden">
                        Annulla
                    </button>
                </div>
            </div>
        </div>

        <!-- Medical Certificate -->
        <div class="glass-card p-4 mb-4">
            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Certificato Medico</h4>
            <div id="member-certificate" class="space-y-2">
                <p class="text-gray-500 text-sm">Nessun certificato caricato</p>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex gap-3">
            <button onclick="checkInMemberFromModal()" id="modal-checkin-btn"
                class="flex-1 bg-green-500/20 hover:bg-green-500/30 text-green-400 py-3 rounded-xl font-semibold transition flex items-center justify-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
                Check In
            </button>
            <button onclick="messageFromModal()"
                class="flex-1 bg-primary/20 hover:bg-primary/30 text-primary py-3 rounded-xl font-semibold transition flex items-center justify-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                Messaggio
            </button>
        </div>

        <!-- Account Management Actions -->
        <div class="flex gap-3 mt-3">
            <button onclick="resetMemberPassword()"
                class="flex-1 bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-400 py-3 rounded-xl font-semibold transition flex items-center justify-center gap-2 text-sm">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                </svg>
                Reimposta Password
            </button>
            <button onclick="openChangeUsername()"
                class="flex-1 bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 py-3 rounded-xl font-semibold transition flex items-center justify-center gap-2 text-sm">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                Cambia Username
            </button>
        </div>
    </div>
</div>

<!-- Subscription Plan Selector Modal -->
<div id="plan-selector-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-white">Seleziona Piano di Abbonamento</h3>
            <button onclick="closePlanSelector()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>

        <p class="text-sm text-gray-400 mb-4">
            For: <span id="plan-for-member" class="text-white font-semibold"></span>
        </p>

        <!-- Plans List -->
        <div id="plans-list" class="space-y-3">
            <div class="text-center py-6">
                <p class="text-gray-400 text-sm">Caricamento piani...</p>
            </div>
        </div>

        <!-- Manual Entry Option -->
        <div class="mt-4 pt-4 border-t border-white/10">
            <p class="text-xs text-gray-500 text-center">
                I piani vengono creati dal proprietario in Impostazioni → Abbonamenti
            </p>
        </div>
    </div>
</div>

<!-- Client Onboarding Wizard Modal -->
<!-- Temporary Password Modal -->
<div id="temp-password-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[80] hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full text-center">
        <div class="text-4xl mb-4">&#10003;</div>
        <h3 class="text-lg font-bold text-white mb-2">Cliente Registrato con Successo!</h3>
        <p class="text-gray-400 text-sm mb-4">Condividi queste credenziali con il cliente:</p>
        <div class="bg-white/5 border border-white/10 rounded-xl p-4 mb-4 text-left">
            <div class="mb-3">
                <span class="text-gray-400 text-xs uppercase">Nome</span>
                <p id="temp-pw-name" class="text-white font-medium"></p>
            </div>
            <div class="mb-3">
                <span class="text-gray-400 text-xs uppercase">Username</span>
                <p id="temp-pw-username" class="text-white font-mono font-medium"></p>
            </div>
            <div>
                <span class="text-gray-400 text-xs uppercase">Password Temporanea</span>
                <div class="flex items-center gap-2 mt-1">
                    <p id="temp-pw-password" class="text-green-400 font-mono font-bold text-lg"></p>
                    <button onclick="copyTempPassword()" class="text-gray-400 hover:text-white p-1" title="Copy password">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                    </button>
                </div>
            </div>
        </div>
        <p class="text-yellow-400 text-xs mb-4">Il cliente deve cambiare questa password al primo accesso.</p>
        <div class="flex gap-2 mb-3">
            <a id="temp-pw-whatsapp" target="_blank" rel="noopener"
                class="flex-1 flex items-center justify-center gap-2 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-xl font-medium transition-colors text-sm">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 0C5.373 0 0 5.373 0 12c0 2.121.553 4.114 1.519 5.845L.525 23.473l5.779-.99A11.93 11.93 0 0012 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm0 21.82c-1.978 0-3.856-.53-5.508-1.49l-.395-.234-3.43.588.613-3.35-.257-.41A9.78 9.78 0 012.18 12c0-5.422 4.398-9.82 9.82-9.82 5.422 0 9.82 4.398 9.82 9.82 0 5.422-4.398 9.82-9.82 9.82z"/></svg>
                Invia su WhatsApp
            </a>
            <a id="temp-pw-sms" target="_blank" rel="noopener"
                class="flex-1 flex items-center justify-center gap-2 py-2.5 bg-blue-500 hover:bg-blue-600 text-white rounded-xl font-medium transition-colors text-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                Invia SMS
            </a>
        </div>
        <button onclick="closeTempPasswordModal()" class="w-full py-3 bg-white/10 hover:bg-white/20 text-white rounded-xl font-medium transition-colors">Fatto</button>
    </div>
</div>

<div id="onboarding-wizard-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[70] hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-bold text-white">Registrazione Nuovo Cliente</h3>
            <button onclick="closeOnboardingWizard()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>

        <!-- Step Indicator -->
        <div class="flex items-center justify-center gap-2 mb-6">
            <div class="onboard-step-dot active" data-step="1">
                <span class="w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white text-sm font-bold">1</span>
                <span class="text-xs text-gray-400 mt-1">Info</span>
            </div>
            <div class="w-8 h-0.5 bg-white/20"></div>
            <div class="onboard-step-dot" data-step="2">
                <span class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-white/60 text-sm font-bold">2</span>
                <span class="text-xs text-gray-400 mt-1">Docs</span>
            </div>
            <div class="w-8 h-0.5 bg-white/20"></div>
            <div class="onboard-step-dot" data-step="3">
                <span class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-white/60 text-sm font-bold">3</span>
                <span class="text-xs text-gray-400 mt-1">Plan</span>
            </div>
            <div class="w-8 h-0.5 bg-white/20"></div>
            <div class="onboard-step-dot" data-step="4">
                <span class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-white/60 text-sm font-bold">4</span>
                <span class="text-xs text-gray-400 mt-1">Photo</span>
            </div>
            <div class="w-8 h-0.5 bg-white/20"></div>
            <div class="onboard-step-dot" data-step="5">
                <span class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-white/60 text-sm font-bold">5</span>
                <span class="text-xs text-gray-400 mt-1">Pay</span>
            </div>
        </div>

        <!-- Step 1: Basic Info -->
        <div id="onboard-step-1" class="onboard-step-content">
            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Informazioni Cliente</h4>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Nome Completo *</label>
                    <input type="text" id="onboard-name" placeholder="Inserisci nome completo"
                        class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-500 outline-none focus:border-primary/50 transition">
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Numero di Telefono *</label>
                    <input type="tel" id="onboard-phone" placeholder="+1 234 567 8900"
                        class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-500 outline-none focus:border-primary/50 transition">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Email (opzionale)</label>
                        <input type="email" id="onboard-email" placeholder="email@example.com"
                            class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-500 outline-none focus:border-primary/50 transition">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Data di Nascita *</label>
                        <input type="date" id="onboard-dob"
                            class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-500 outline-none focus:border-primary/50 transition">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Username *</label>
                        <input type="text" id="onboard-username" placeholder="johndoe"
                            class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-500 outline-none focus:border-primary/50 transition">
                    </div>
                </div>
                <p class="text-xs text-gray-500">* Una password temporanea verrà generata automaticamente. Il cliente dovrà cambiarla al primo accesso.</p>
            </div>
        </div>

        <!-- Step 2: Documents -->
        <div id="onboard-step-2" class="onboard-step-content hidden">
            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Documentazione</h4>

            <!-- Document Type Selector -->
            <div class="flex gap-2 mb-4">
                <button onclick="selectDocType('waiver')" id="doc-type-waiver"
                    class="flex-1 py-3 rounded-xl text-sm font-semibold transition bg-primary/20 text-primary border border-primary/30">
                    Firma Liberatoria
                </button>
                <button onclick="selectDocType('medical')" id="doc-type-medical"
                    class="flex-1 py-3 rounded-xl text-sm font-semibold transition bg-white/5 text-white/60 border border-white/10 hover:bg-white/10">
                    Carica Certificato Medico
                </button>
            </div>

            <!-- Waiver Section -->
            <div id="waiver-section">
                <div class="bg-white/5 rounded-xl p-4 mb-4 max-h-40 overflow-y-auto">
                    <p id="waiver-text-display" class="text-xs text-gray-300 whitespace-pre-line">Loading waiver...</p>
                </div>
                <p class="text-xs text-gray-400 mb-2">Firma del cliente (usa dito, penna o mouse):</p>
                <div class="bg-white rounded-xl p-2 mb-2 relative">
                    <canvas id="signature-canvas" width="400" height="180" class="w-full cursor-crosshair rounded-lg" style="touch-action: none; min-height: 160px;"></canvas>
                    <div id="signature-placeholder" class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <span class="text-gray-300 text-sm">Firma qui</span>
                    </div>
                </div>
                <button onclick="clearSignature()" class="text-xs text-red-400 hover:text-red-300 transition flex items-center gap-1">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                    </svg>
                    Cancella Firma
                </button>
            </div>

            <!-- Medical Certificate Section -->
            <div id="medical-section" class="hidden">
                <p class="text-xs text-gray-400 mb-2">Carica certificato medico (foto o PDF):</p>
                <label class="block w-full cursor-pointer">
                    <div class="border-2 border-dashed border-white/20 rounded-xl p-6 text-center hover:border-primary/50 transition">
                        <svg class="w-10 h-10 mx-auto text-gray-400 mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        <p class="text-sm text-gray-400">Clicca per caricare o trascina</p>
                        <p class="text-xs text-gray-500 mt-1">JPG, PNG, PDF (max 10MB)</p>
                    </div>
                    <input type="file" id="medical-file" accept="image/*,.pdf" class="hidden" onchange="previewMedicalFile(this)">
                </label>
                <div id="medical-preview" class="mt-3 hidden">
                    <div class="flex items-center gap-3 p-3 bg-white/5 rounded-xl">
                        <i data-lucide="file-text" class="w-6 h-6 stroke-current"></i>
                        <span id="medical-filename" class="text-sm text-white flex-1 truncate">document.pdf</span>
                        <button onclick="removeMedicalFile()" class="text-red-400 hover:text-red-300">&times;</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Select Plan -->
        <div id="onboard-step-3" class="onboard-step-content hidden">
            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Seleziona Piano di Abbonamento</h4>
            <div id="onboard-plans-list" class="space-y-3 max-h-64 overflow-y-auto">
                <p class="text-gray-400 text-sm text-center py-4">Caricamento piani...</p>
            </div>
            <div class="mt-4 pt-4 border-t border-white/10">
                <button onclick="skipPlanSelection()" class="text-xs text-gray-400 hover:text-white transition">
                    Salta - registra senza abbonamento
                </button>
            </div>
        </div>

        <!-- Step 4: Profile Photo -->
        <div id="onboard-step-4" class="onboard-step-content hidden">
            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Foto Profilo</h4>
            <div class="flex flex-col items-center">
                <!-- Photo Preview -->
                <div id="onboard-photo-preview" class="w-32 h-32 rounded-full bg-white/10 border-2 border-dashed border-white/20 flex items-center justify-center mb-4 overflow-hidden relative">
                    <div id="onboard-photo-placeholder" class="text-center">
                        <svg class="w-10 h-10 text-gray-500 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        <span class="text-xs text-gray-500">Nessuna foto</span>
                    </div>
                    <img id="onboard-photo-img" src="" alt="Profile" class="w-full h-full object-cover hidden">
                </div>

                <!-- Upload Button -->
                <label class="cursor-pointer mb-3">
                    <div class="bg-primary/20 hover:bg-primary/30 text-primary px-6 py-2.5 rounded-xl text-sm font-semibold transition flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        Scatta o Carica Foto
                    </div>
                    <input type="file" id="onboard-photo-input" accept="image/*" capture="user" class="hidden" onchange="previewOnboardPhoto(this)">
                </label>

                <!-- Remove Button -->
                <button id="onboard-photo-remove-btn" onclick="removeOnboardPhoto()" class="text-xs text-red-400 hover:text-red-300 transition hidden">
                    Rimuovi foto
                </button>

                <p class="text-xs text-gray-500 mt-3 text-center">Opzionale - il cliente può anche impostare la foto successivamente dall'app</p>
            </div>
        </div>

        <!-- Step 5: Payment -->
        <div id="onboard-step-5" class="onboard-step-content hidden">
            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Pagamento e Riepilogo</h4>

            <!-- Summary -->
            <div class="bg-white/5 rounded-xl p-4 mb-4">
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Cliente</span>
                        <span class="text-white font-semibold" id="summary-client-name">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Username</span>
                        <span class="text-white" id="summary-username">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Piano</span>
                        <span class="text-white" id="summary-plan">Nessun piano selezionato</span>
                    </div>
                    <div class="flex justify-between pt-2 border-t border-white/10">
                        <span class="text-gray-400">Importo Dovuto</span>
                        <span class="text-primary font-bold text-lg" id="summary-amount">-</span>
                    </div>
                </div>
            </div>

            <!-- Payment Method -->
            <div id="payment-method-section">
                <p class="text-xs text-gray-400 mb-3">Seleziona metodo di pagamento:</p>
                <div id="payment-grid" class="grid grid-cols-2 gap-3 mb-4">
                    <button onclick="selectPaymentMethod('cash')" id="pay-cash-btn"
                        class="p-4 rounded-xl border-2 border-white/20 hover:border-green-500/50 transition text-center">
                        <i data-lucide="banknote" class="w-6 h-6 block mb-1 mx-auto stroke-current"></i>
                        <span class="text-sm font-semibold text-white">Contanti</span>
                    </button>
                    <button onclick="selectPaymentMethod('terminal')" id="pay-terminal-btn"
                        class="p-4 rounded-xl border-2 border-white/20 hover:border-orange-500/50 transition text-center">
                        <i data-lucide="smartphone-nfc" class="w-6 h-6 block mb-1 mx-auto stroke-current"></i>
                        <span class="text-sm font-semibold text-white">POS</span>
                    </button>
                </div>

                <!-- Stripe Card Form (shown when card selected) -->
                <div id="card-payment-form" class="hidden">
                    <p class="text-sm text-gray-400 mb-3">Inserisci i dati della carta:</p>
                    <div class="mb-3 rounded-xl border-2 border-gray-400" style="background: #ffffff; padding: 24px 20px; min-height: 80px;">
                        <div id="stripe-card-element" style="min-height: 32px; line-height: 32px;"></div>
                    </div>
                    <div id="onboard-card-errors" class="text-red-400 text-xs mb-2 hidden"></div>
                    <p class="text-xs text-gray-500">Carta di test: 4242 4242 4242 4242, qualsiasi data futura, qualsiasi CVC</p>
                </div>

                <!-- Terminal/POS Payment (shown when terminal selected) -->
                <div id="terminal-payment-form" class="hidden">
                    <div class="bg-orange-500/10 border border-orange-500/30 rounded-xl p-4 text-center">
                        <div id="pos-initial" class="py-2">
                            <i data-lucide="smartphone-nfc" class="w-8 h-8 mx-auto mb-2 text-orange-400 stroke-current"></i>
                            <p class="text-orange-400 font-semibold mb-1">Pagamento Terminale POS</p>
                            <p class="text-xs text-gray-400">Il pagamento verrà elaborato sul lettore POS quando clicchi Completa Registrazione.</p>
                        </div>
                        <div id="pos-processing" class="hidden py-4">
                            <i data-lucide="loader-2" class="w-6 h-6 inline-block animate-spin text-orange-400 stroke-current"></i>
                            <p class="text-orange-400 font-semibold mt-2">Elaborazione sul terminale...</p>
                            <p class="text-xs text-gray-400 mt-1">Chiedi al cliente di avvicinare o inserire la carta</p>
                            <div class="animate-pulse text-orange-400 text-sm mt-2">In attesa del pagamento...</div>
                            <!-- Sandbox only: simulate a card tap without physical hardware -->
                            <button id="pos-simulate-btn" onclick="simulateCardTap()" class="hidden mt-3 bg-yellow-500/10 hover:bg-yellow-500/20 text-yellow-400 border border-yellow-500/30 px-4 py-1.5 rounded-lg text-xs font-semibold transition">
                                Simula Carta (Sandbox)
                            </button>
                            <button onclick="cancelTerminalPayment()" class="mt-2 text-xs text-red-400 underline">Annulla Pagamento</button>
                        </div>
                        <div id="pos-success" class="hidden py-4">
                            <span class="text-4xl block mb-2 text-green-400">&#10003;</span>
                            <p class="text-green-400 font-semibold">Pagamento Ricevuto!</p>
                            <p class="text-xs text-gray-400 mt-1">Completamento registrazione...</p>
                        </div>
                        <div id="pos-error" class="hidden py-3">
                            <span class="text-2xl block mb-1 text-red-400">&#10007;</span>
                            <p class="text-red-400 font-semibold text-sm" id="pos-error-msg">Pagamento terminale fallito</p>
                            <p class="text-xs text-gray-400 mt-1">Usa "Indietro" per correggere i dati e riprovare.</p>
                            <button onclick="retryTerminalPayment()" class="text-xs text-orange-400 underline mt-2">Riprova Pagamento</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- No Payment Needed -->
            <div id="no-payment-section" class="hidden">
                <div class="bg-green-500/10 border border-green-500/30 rounded-xl p-4 text-center">
                    <span class="text-2xl block mb-2">✓</span>
                    <p class="text-green-400 font-semibold">Nessun pagamento necessario</p>
                    <p class="text-xs text-gray-400 mt-1">Il cliente verrà registrato senza abbonamento</p>
                </div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="flex gap-3 mt-6">
            <button onclick="onboardPrevStep()" id="onboard-prev-btn"
                class="flex-1 bg-white/10 hover:bg-white/20 text-white py-3 rounded-xl font-semibold transition hidden">
                Indietro
            </button>
            <button onclick="onboardNextStep()" id="onboard-next-btn"
                class="flex-1 bg-primary hover:bg-primary/80 text-white py-3 rounded-xl font-semibold transition">
                Avanti
            </button>
            <button onclick="completeOnboarding()" id="onboard-complete-btn"
                class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-semibold transition hidden">
                Completa Registrazione
            </button>
        </div>
    </div>
</div>

<script>
let allMembers = [];
let allTrainers = [];

document.addEventListener('DOMContentLoaded', async () => {
    await loadStaffData();
});

async function loadStaffData() {
    try {
        // Load gym info
        const gymRes = await fetch('/api/staff/gym-info', { credentials: 'include' });
        if (gymRes.ok) {
            const gymInfo = await gymRes.json();
            const gymNameEl = document.getElementById('gym-name-display');
            if (gymNameEl) gymNameEl.textContent = gymInfo.gym_name || 'Your Gym';

            const staffNameEl = document.getElementById('staff-name');
            if (staffNameEl) staffNameEl.textContent = gymInfo.staff_name || 'Staff Member';
        }

        // Load members
        const membersRes = await fetch('/api/staff/members', { credentials: 'include' });
        if (membersRes.ok) {
            allMembers = await membersRes.json();
            renderMembers(allMembers);
            renderDocumentsTable(allMembers);

            const totalEl = document.getElementById('total-members');
            if (totalEl) totalEl.textContent = allMembers.length;

            const countEl = document.getElementById('members-count');
            if (countEl) countEl.textContent = allMembers.length;

            // Compute inactive / at-risk counts
            const inactiveCount = allMembers.filter(m => !m.subscription_status || m.subscription_status === 'inactive').length;
            const atRiskCount = allMembers.filter(m => m.certificate_status === 'expired' || m.certificate_status === 'expiring').length;
            const inactiveEl = document.getElementById('inactive-members');
            if (inactiveEl) inactiveEl.textContent = inactiveCount;
            const atRiskEl = document.getElementById('at-risk-members');
            if (atRiskEl) atRiskEl.textContent = atRiskCount;

            // Populate NFC member dropdown
            const nfcSelect = document.getElementById('nfc-member-select');
            if (nfcSelect && allMembers.length > 0) {
                nfcSelect.innerHTML = '<option value="">Seleziona membro...</option>' +
                    allMembers.map(m => `<option value="${m.id}">${escapeHtml(m.name || m.username)}</option>`).join('');
            }
        }

        // Load trainers immediately
        await loadTrainers();

        // Load today's appointments
        await loadTodaysAppointments();

        // Load check-in stats
        await loadCheckinStats();

    } catch (error) {
        console.error('Error loading staff data:', error);
    }
}

async function loadTrainers() {
    try {
        const res = await fetch('/api/staff/trainers', { credentials: 'include' });
        const listEl = document.getElementById('trainers-list');

        if (res.ok) {
            allTrainers = await res.json();

            // Update trainers count stat
            const trainersCountEl = document.getElementById('trainers-count');
            if (trainersCountEl) trainersCountEl.textContent = allTrainers.length;

            if (allTrainers.length === 0) {
                listEl.innerHTML = `
                    <div class="glass-card p-3 text-center">
                        <p class="text-gray-400 text-sm">Nessun trainer</p>
                    </div>
                `;
                return;
            }

            listEl.innerHTML = allTrainers.map(trainer => `
                <div class="glass-card p-3 hover:bg-white/10 transition cursor-pointer" onclick="viewTrainerSchedule('${trainer.id}', '${trainer.username}')">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center text-white font-bold">
                            ${trainer.username.charAt(0).toUpperCase()}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold text-white text-sm flex items-center gap-1.5">
                                ${trainer.username}
                                ${trainer.is_available_today ? '<svg class="w-4 h-4 text-green-400 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
                            </p>
                            <p class="text-xs text-gray-400">${getRoleLabel(trainer)}</p>
                        </div>
                        <button onclick="event.stopPropagation(); openChatModal('${trainer.id}', '${trainer.username}')"
                            class="p-2 bg-primary/20 hover:bg-primary/30 text-primary rounded-lg transition" title="Message">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error('Error loading trainers:', error);
    }
}

function getRoleLabel(trainer) {
    if (trainer.sub_role === 'nutritionist') return 'Nutrizionista';
    if (trainer.sub_role === 'both') return 'Trainer & Nutrizionista';
    return 'Personal Trainer';
}

function renderMembers(members) {
    // Helper to get badge info
    function getMemberBadges(member) {
        const subStatus = member.subscription_status || 'inactive';
        const subBadgeClass = subStatus === 'active' ? 'staff-badge-active' : (subStatus === 'trialing' ? 'staff-badge-warning' : 'staff-badge-inactive');
        const subLabel = subStatus === 'active' ? 'Attivo' : (subStatus === 'trialing' ? 'Prova' : 'Inattivo');
        const certStatus = member.certificate_status || 'none';
        const certBadgeClass = certStatus === 'valid' ? 'staff-badge-valid' : (certStatus === 'expired' ? 'staff-badge-expired' : (certStatus === 'expiring' ? 'staff-badge-warning' : 'staff-badge-none'));
        const certLabel = certStatus === 'valid' ? 'Valido' : (certStatus === 'expired' ? 'Scaduto' : (certStatus === 'expiring' ? 'In scadenza' : 'Nessuno'));
        return { subBadgeClass, subLabel, certBadgeClass, certLabel };
    }

    // Desktop table rendering
    const tableBody = document.getElementById('members-table-body');
    if (tableBody) {
        if (members.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:2rem;color:rgba(255,255,255,0.35);font-size:0.85rem;">Nessun cliente trovato</td></tr>`;
        } else {
            tableBody.innerHTML = members.map(member => {
                const initial = member.name ? member.name.charAt(0).toUpperCase() : '?';
                const { subBadgeClass, subLabel, certBadgeClass, certLabel } = getMemberBadges(member);
                const safeName = escapeHtml(member.name || member.username);
                return `
                    <tr onclick="openMemberProfile('${member.id}')">
                        <td><input type="checkbox" style="opacity:0.3;" onclick="event.stopPropagation();"></td>
                        <td>
                            <div class="member-cell">
                                <div class="member-avatar">${initial}</div>
                                <div>
                                    <div class="member-name">${safeName}</div>
                                    <div class="member-email">${escapeHtml(member.email || '')}</div>
                                </div>
                            </div>
                        </td>
                        <td><span class="staff-badge ${subBadgeClass}">${subLabel}</span></td>
                        <td><span class="staff-badge ${certBadgeClass}">${certLabel}</span></td>
                        <td>
                            <div style="display:flex;gap:0.35rem;">
                                <button onclick="event.stopPropagation(); openChatModal('${member.id}', '${safeName.replace(/'/g, "\\'")}')" class="staff-btn-action" style="padding:0.3rem 0.5rem;" title="Messaggio">
                                    <i data-lucide="message-circle" class="w-3.5 h-3.5"></i>
                                </button>
                                <button onclick="event.stopPropagation(); checkInMember('${member.id}')" class="staff-btn-action" style="padding:0.3rem 0.5rem;color:#4ade80;" title="Check In">
                                    <i data-lucide="check" class="w-3.5 h-3.5"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
    }

    // Mobile card rendering
    const mobileList = document.getElementById('members-mobile-list');
    if (mobileList) {
        if (members.length === 0) {
            mobileList.innerHTML = `<div style="text-align:center;padding:2rem;color:rgba(255,255,255,0.35);font-size:0.85rem;">Nessun cliente trovato</div>`;
        } else {
            mobileList.innerHTML = members.map(member => {
                const initial = member.name ? member.name.charAt(0).toUpperCase() : '?';
                const { subBadgeClass, subLabel, certBadgeClass, certLabel } = getMemberBadges(member);
                const safeName = escapeHtml(member.name || member.username);
                return `
                    <div class="staff-mobile-card" onclick="openMemberProfile('${member.id}')">
                        <div class="staff-mobile-card-avatar">${initial}</div>
                        <div class="staff-mobile-card-info">
                            <div class="staff-mobile-card-name">${safeName}</div>
                            <div class="staff-mobile-card-badges">
                                <span class="staff-badge ${subBadgeClass}">${subLabel}</span>
                                <span class="staff-badge ${certBadgeClass}">${certLabel}</span>
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4" style="color:rgba(255,255,255,0.2);flex-shrink:0;"></i>
                    </div>
                `;
            }).join('');
        }
    }

    if (typeof lucide !== 'undefined') lucide.createIcons();
}

// Convert 32 hex chars back to UUID format (8-4-4-4-12)
function hexToUuid(hex) {
    return hex.slice(0,8) + '-' + hex.slice(8,12) + '-' + hex.slice(12,16) + '-' + hex.slice(16,20) + '-' + hex.slice(20);
}

// Show scanned member card with Check In button
function showScannedMember(memberId, label) {
    const resultsDiv = document.getElementById('search-results');
    const member = allMembers.find(m => m.id === memberId);
    if (member) {
        const initial = member.name ? member.name.charAt(0).toUpperCase() : '?';
        const profileImg = member.profile_picture_url
            ? `<img src="${member.profile_picture_url}" class="w-10 h-10 rounded-full object-cover">`
            : `<div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-white font-bold">${initial}</div>`;
        resultsDiv.innerHTML = `
            <div class="glass-card p-4 flex items-center justify-between border border-green-500/30">
                <div class="flex items-center gap-3">
                    ${profileImg}
                    <div>
                        <span class="text-white font-semibold">${member.name || member.username}</span>
                        <p class="text-green-400 text-xs flex items-center gap-1">
                            <i data-lucide="shield-check" class="w-3 h-3"></i> ${label || 'QR Verified'}
                        </p>
                    </div>
                </div>
                <button onclick="checkInMember('${member.id}')"
                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-xl font-semibold transition flex items-center gap-2">
                    <i data-lucide="user-check" class="w-4 h-4"></i> Check In
                </button>
            </div>
        `;
        if (typeof lucide !== 'undefined') lucide.createIcons();
    } else {
        resultsDiv.innerHTML = '<p class="text-red-400 text-sm text-center py-2">Membro non trovato nel sistema</p>';
    }
    resultsDiv.classList.remove('hidden');
}

async function searchMember() {
    const input = document.getElementById('checkin-search');
    const rawValue = input.value.trim();
    const resultsDiv = document.getElementById('search-results');

    // QR scanner detection: permanent check-in code (alphanumeric, no colons)
    // Format: GYMCHECKIN + 32 hex chars (UUID without hyphens)
    if (rawValue.startsWith('GYMCHECKIN')) {
        const hex = rawValue.replace('GYMCHECKIN', '');
        input.value = '';
        if (hex.length >= 32) {
            const memberId = hexToUuid(hex.slice(0, 32));
            showScannedMember(memberId, 'Member QR');
        }
        return;
    }

    // QR scanner detection: temporary access code (alphanumeric, no colons)
    // Format: GYMACCESS + 32 hex chars (UUID) + 12 hex chars (token)
    if (rawValue.startsWith('GYMACCESS')) {
        const payload = rawValue.replace('GYMACCESS', '');
        input.value = '';
        if (payload.length >= 44) {
            const userId = hexToUuid(payload.slice(0, 32));
            const token = payload.slice(32, 44);
            try {
                const res = await fetch('/api/staff/verify-access', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ user_id: userId, token: token })
                });
                if (res.ok) {
                    showScannedMember(userId, 'Access Verified');
                } else {
                    const err = await res.json();
                    showToast(err.detail || 'Codice di accesso scaduto', 'error');
                    resultsDiv.classList.add('hidden');
                }
            } catch (e) {
                showToast('Impossibile verificare il codice di accesso', 'error');
            }
        }
        return;
    }

    const query = rawValue.toLowerCase();

    if (!query) {
        resultsDiv.classList.add('hidden');
        return;
    }

    const filtered = allMembers.filter(m =>
        (m.name && m.name.toLowerCase().includes(query)) ||
        (m.username && m.username.toLowerCase().includes(query)) ||
        (m.email && m.email.toLowerCase().includes(query))
    );

    if (filtered.length === 0) {
        resultsDiv.innerHTML = '<p class="text-gray-400 text-sm text-center py-2">Nessun membro trovato</p>';
    } else {
        resultsDiv.innerHTML = filtered.slice(0, 5).map(member => `
            <div class="glass-card p-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-white font-bold text-sm">
                        ${member.name ? member.name.charAt(0).toUpperCase() : '?'}
                    </div>
                    <span class="text-white font-medium">${member.name || member.username}</span>
                </div>
                <button onclick="checkInMember('${member.id}')"
                    class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded-lg text-xs font-semibold transition">
                    Check In
                </button>
            </div>
        `).join('');
    }

    resultsDiv.classList.remove('hidden');
}

async function checkInMember(memberId) {
    try {
        const res = await fetch('/api/staff/checkin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ member_id: memberId })
        });

        if (res.ok) {
            showToast('Check-in del membro effettuato!', 'success');
            await loadCheckinStats();
            document.getElementById('checkin-search').value = '';
            document.getElementById('search-results').classList.add('hidden');
        } else {
            const err = await res.json();
            showToast(err.detail || 'Check-in fallito', 'error');
        }
    } catch (error) {
        console.error('Check-in error:', error);
        showToast('Check-in fallito', 'error');
    }
}

async function loadCheckinStats() {
    try {
        const res = await fetch('/api/staff/checkins/today', { credentials: 'include' });
        if (res.ok) {
            const data = await res.json();
            const todayEl = document.getElementById('members-today');
            if (todayEl) todayEl.textContent = data.count || 0;

            const listEl = document.getElementById('recent-checkins-list');
            if (listEl) {
                if (data.recent && data.recent.length > 0) {
                    listEl.innerHTML = data.recent.map(checkin => `
                        <div class="glass-card p-3 flex items-center justify-between">
                            <div class="flex items-center gap-2 min-w-0">
                                <div class="w-7 h-7 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                </div>
                                <span class="text-white text-sm font-medium truncate">${checkin.member_name}</span>
                            </div>
                            <span class="text-xs text-gray-500 flex-shrink-0 ml-2">${checkin.time}</span>
                        </div>
                    `).join('');
                } else {
                    listEl.innerHTML = `
                        <div class="glass-card p-3 text-center">
                            <p class="text-gray-400 text-sm">Nessun check-in oggi</p>
                        </div>
                    `;
                }
            }
        }
    } catch (error) {
        console.error('Error loading check-in stats:', error);
    }
}

async function loadTodaysAppointments() {
    try {
        const res = await fetch('/api/staff/appointments/today', { credentials: 'include' });
        const listEl = document.getElementById('todays-appointments-list');

        if (res.ok) {
            const appointments = await res.json();

            // Update appointments count stat
            const apptCountEl = document.getElementById('appointments-count');
            if (apptCountEl) apptCountEl.textContent = appointments.length;

            if (appointments.length === 0) {
                listEl.innerHTML = `
                    <div class="glass-card p-3 text-center">
                        <p class="text-gray-400 text-sm">Nessun appuntamento oggi</p>
                    </div>
                `;
            } else {
                listEl.innerHTML = appointments.map(appt => `
                    <div class="glass-card p-3">
                        <div class="flex items-center justify-between">
                            <div class="min-w-0 flex-1">
                                <p class="text-white font-medium text-sm truncate">${appt.client_name}</p>
                                <p class="text-xs text-gray-400 truncate">con ${appt.trainer_name}</p>
                            </div>
                            <div class="text-right flex-shrink-0 ml-2">
                                <p class="text-primary font-semibold text-sm">${appt.time}</p>
                                <p class="text-xs text-gray-500">${appt.duration}min</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        } else {
            const apptCountEl = document.getElementById('appointments-count');
            if (apptCountEl) apptCountEl.textContent = '0';

            listEl.innerHTML = `
                <div class="glass-card p-3 text-center">
                    <p class="text-gray-400 text-sm">No appointments today</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading appointments:', error);
    }
}

// Trainer Schedule Modal
async function viewTrainerSchedule(trainerId, trainerName) {
    document.getElementById('trainer-modal-title').textContent = `${trainerName}'s Schedule`;
    document.getElementById('trainer-schedule-modal').classList.remove('hidden');

    // Load availability
    const availEl = document.getElementById('trainer-availability');
    const schedEl = document.getElementById('trainer-today-schedule');

    try {
        const res = await fetch(`/api/staff/trainer/${trainerId}/schedule`, { credentials: 'include' });
        if (res.ok) {
            const data = await res.json();

            // Display availability
            if (data.availability && data.availability.length > 0) {
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                availEl.innerHTML = data.availability.map(a => `
                    <div class="flex justify-between items-center py-1">
                        <span class="text-gray-400">${days[a.day_of_week]}</span>
                        <span class="text-white">${a.start_time} - ${a.end_time}</span>
                    </div>
                `).join('');
            } else {
                availEl.innerHTML = '<p class="text-gray-500 text-sm">Nessuna disponibilità impostata</p>';
            }

            // Display today's appointments
            if (data.today_appointments && data.today_appointments.length > 0) {
                schedEl.innerHTML = data.today_appointments.map(appt => `
                    <div class="glass-card p-3 flex justify-between items-center">
                        <div>
                            <p class="text-white font-medium">${appt.client_name}</p>
                            <p class="text-xs text-gray-400">${appt.session_type || 'General'}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-primary font-semibold">${appt.time}</p>
                            <p class="text-xs text-gray-400">${appt.duration} min</p>
                        </div>
                    </div>
                `).join('');
            } else {
                schedEl.innerHTML = '<p class="text-gray-500 text-sm">Nessun appuntamento oggi</p>';
            }
        }
    } catch (error) {
        console.error('Error loading trainer schedule:', error);
        availEl.innerHTML = '<p class="text-red-400 text-sm">Errore nel caricamento disponibilità</p>';
    }
}

function closeTrainerModal() {
    document.getElementById('trainer-schedule-modal').classList.add('hidden');
}

// ========== MEMBER PROFILE MODAL ==========
let currentMemberData = null;

async function openMemberProfile(memberId) {
    document.getElementById('member-profile-modal').classList.remove('hidden');

    // Reset modal content to loading state
    document.getElementById('member-name').textContent = 'Loading...';
    document.getElementById('member-email').textContent = '-';
    document.getElementById('member-avatar').textContent = '?';

    try {
        const res = await fetch(`/api/staff/member/${memberId}`, { credentials: 'include' });
        if (res.ok) {
            const data = await res.json();
            currentMemberData = data;
            renderMemberProfile(data);
        } else {
            showToast('Impossibile caricare il profilo membro', 'error');
            closeMemberModal();
        }
    } catch (error) {
        console.error('Error loading member profile:', error);
        showToast('Failed to load member profile', 'error');
        closeMemberModal();
    }
}

function renderMemberProfile(data) {
    // Avatar
    const avatar = document.getElementById('member-avatar');
    const initial = (data.name || data.username || '?').charAt(0).toUpperCase();
    avatar.textContent = initial;

    // Basic info
    document.getElementById('member-name').textContent = data.name || data.username;
    document.getElementById('member-email').textContent = data.email || 'Nessuna email';

    // Status badge
    const statusBadge = document.getElementById('member-status-badge');
    if (data.checked_in_today) {
        statusBadge.className = 'inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-500/20 text-green-400 text-sm font-semibold';
        statusBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-400"></span> Check-in effettuato oggi';
    } else if (data.status === 'active') {
        statusBadge.className = 'inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-blue-500/20 text-blue-400 text-sm font-semibold';
        statusBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-blue-400"></span> Membro Attivo';
    } else {
        statusBadge.className = 'inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-500/20 text-gray-400 text-sm font-semibold';
        statusBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-gray-400"></span> Inattivo';
    }

    // Member info
    document.getElementById('member-since').textContent = data.member_since || 'Sconosciuto';
    document.getElementById('member-trainer').textContent = data.trainer_name || 'Nessuno assegnato';
    document.getElementById('member-total-checkins').textContent = data.total_checkins || 0;

    // Format last check-in
    if (data.last_checkin) {
        const lastCheckin = data.last_checkin;
        if (lastCheckin.includes('T')) {
            const [date, time] = lastCheckin.split('T');
            document.getElementById('member-last-checkin').textContent = `${date} at ${time.slice(0,5)}`;
        } else {
            document.getElementById('member-last-checkin').textContent = lastCheckin;
        }
    } else {
        document.getElementById('member-last-checkin').textContent = 'Mai';
    }

    // Subscription info
    const sub = data.subscription || {};
    document.getElementById('member-plan').textContent = sub.plan || 'Nessun piano attivo';

    const subStatusEl = document.getElementById('member-sub-status');
    if (sub.status === 'active') {
        subStatusEl.className = 'text-green-400';
        subStatusEl.textContent = 'Attivo';
    } else if (sub.status === 'trialing') {
        subStatusEl.className = 'text-yellow-400';
        subStatusEl.textContent = 'Prova';
    } else {
        subStatusEl.className = 'text-gray-400';
        subStatusEl.textContent = sub.status || 'Inattivo';
    }

    document.getElementById('member-sub-expires').textContent = sub.expires || '-';

    // Subscription actions - show automatically for easy access
    const actionsEl = document.getElementById('subscription-actions');
    const assignBtn = document.getElementById('assign-plan-btn');
    const cancelBtn = document.getElementById('cancel-sub-btn');

    actionsEl.classList.remove('hidden');
    if (sub.status === 'active' || sub.status === 'trialing') {
        assignBtn.textContent = 'Cambia Piano';
        cancelBtn.classList.remove('hidden');
    } else {
        assignBtn.textContent = 'Assegna Piano';
        cancelBtn.classList.add('hidden');
    }

    // Check-in button state
    const checkinBtn = document.getElementById('modal-checkin-btn');
    if (data.checked_in_today) {
        checkinBtn.disabled = true;
        checkinBtn.className = 'flex-1 bg-gray-500/20 text-gray-500 py-3 rounded-xl font-semibold cursor-not-allowed flex items-center justify-center gap-2';
        checkinBtn.innerHTML = `
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
            </svg>
            Check-in Effettuato
        `;
    } else {
        checkinBtn.disabled = false;
        checkinBtn.className = 'flex-1 bg-green-500/20 hover:bg-green-500/30 text-green-400 py-3 rounded-xl font-semibold transition flex items-center justify-center gap-2';
        checkinBtn.innerHTML = `
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
            </svg>
            Check In
        `;
    }

    // Medical Certificate
    const certEl = document.getElementById('member-certificate');
    const cert = data.medical_certificate;
    if (cert) {
        const statusConfig = {
            valid: { bg: 'bg-green-500/20', border: 'border-green-500/30', text: 'text-green-400', label: 'Valid', icon: '✓' },
            expiring: { bg: 'bg-yellow-500/20', border: 'border-yellow-500/30', text: 'text-yellow-400', label: 'Expiring Soon', icon: 'alert-triangle' },
            expired: { bg: 'bg-red-500/20', border: 'border-red-500/30', text: 'text-red-400', label: 'Expired', icon: '✗' }
        };
        const cfg = statusConfig[cert.status] || statusConfig.valid;
        const expiryText = cert.expiration_date ? `Expires: ${new Date(cert.expiration_date).toLocaleDateString()}` : '';

        certEl.innerHTML = `
            <div class="flex items-center gap-3 p-3 rounded-xl ${cfg.bg} border ${cfg.border}">
                <div class="w-8 h-8 rounded-full ${cfg.bg} flex items-center justify-center flex-shrink-0">
                    <span class="font-bold ${cfg.text}">${cfg.icon}</span>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-white text-sm font-semibold truncate">${cert.filename}</p>
                    <p class="text-xs ${cfg.text}">${expiryText}</p>
                </div>
                <div class="flex items-center gap-2">
                    <a href="${cert.file_url}" target="_blank" class="text-xs ${cfg.text} hover:underline">View</a>
                    <span class="text-xs px-2 py-1 rounded-full ${cfg.bg} ${cfg.text}">${cfg.label}</span>
                </div>
            </div>
        `;
    } else {
        certEl.innerHTML = '<p class="text-gray-500 text-sm">Nessun certificato caricato</p>';
    }
}

function closeMemberModal() {
    document.getElementById('member-profile-modal').classList.add('hidden');
    currentMemberData = null;
}

async function checkInMemberFromModal() {
    if (!currentMemberData) return;

    try {
        const res = await fetch('/api/staff/checkin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ member_id: currentMemberData.id })
        });

        if (res.ok) {
            showToast(`${currentMemberData.name || currentMemberData.username} - check-in effettuato!`, 'success');
            currentMemberData.checked_in_today = true;
            renderMemberProfile(currentMemberData);
            await loadCheckinStats();
        } else {
            const err = await res.json();
            showToast(err.detail || 'Check-in fallito', 'error');
        }
    } catch (error) {
        console.error('Check-in error:', error);
        showToast('Check-in fallito', 'error');
    }
}

function messageFromModal() {
    if (!currentMemberData) return;
    const memberId = currentMemberData.id;
    const memberName = currentMemberData.name || currentMemberData.username;
    closeMemberModal();
    openChatModal(memberId, memberName);
}

// Close modal on background click
document.getElementById('member-profile-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'member-profile-modal') {
        closeMemberModal();
    }
});

// ========== ACCOUNT MANAGEMENT (Reset Password / Change Username) ==========
async function resetMemberPassword() {
    if (!currentMemberData) return;
    const name = currentMemberData.name || currentMemberData.username;
    if (!confirm(`Reimposta password per ${name}? Verrà generata una password temporanea.`)) return;

    try {
        const res = await fetch('/api/staff/reset-member-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ member_id: currentMemberData.id })
        });

        if (res.ok) {
            const data = await res.json();
            // Show temporary password in a clear alert (staff needs to share it with the member)
            const tempPw = data.temporary_password;
            closeMemberModal();
            // Create a styled modal with the temp password
            const overlay = document.createElement('div');
            overlay.id = 'temp-password-overlay';
            overlay.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-[70] flex items-center justify-center p-4';
            overlay.innerHTML = `
                <div class="glass-card p-6 rounded-2xl max-w-sm w-full text-center">
                    <div class="w-12 h-12 rounded-full bg-yellow-500/20 flex items-center justify-center mx-auto mb-4">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#eab308" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-2">Reimposta Password</h3>
                    <p class="text-gray-400 text-sm mb-4">Password temporanea per <strong class="text-white">${name}</strong></p>
                    <div class="bg-black/40 border border-yellow-500/30 rounded-xl p-4 mb-4">
                        <p class="text-yellow-400 font-mono text-lg select-all" id="temp-pw-display">${tempPw}</p>
                    </div>
                    <button onclick="navigator.clipboard.writeText('${tempPw}'); this.textContent='Copied!'; setTimeout(()=>this.textContent='Copy Password',1500)"
                        class="w-full bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-400 py-2 rounded-xl font-semibold transition mb-3 text-sm">
                        Copia Password
                    </button>
                    <p class="text-gray-500 text-xs mb-4">Il membro dovrà cambiarla al primo accesso.</p>
                    <button onclick="document.getElementById('temp-password-overlay')?.remove()"
                        class="w-full bg-white/10 hover:bg-white/20 text-white py-2 rounded-xl font-semibold transition text-sm">
                        Chiudi
                    </button>
                </div>
            `;
            document.body.appendChild(overlay);
            overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
        } else {
            const err = await res.json();
            showToast(err.detail || 'Impossibile reimpostare la password');
        }
    } catch (error) {
        console.error('Error resetting password:', error);
        showToast('Impossibile reimpostare la password');
    }
}

async function openChangeUsername() {
    if (!currentMemberData) return;
    const currentUsername = currentMemberData.username;
    const newUsername = prompt(`Inserisci nuovo username per ${currentMemberData.name || currentUsername}:`, currentUsername);
    if (!newUsername || newUsername === currentUsername) return;

    if (newUsername.length < 3) {
        showToast('L\'username deve avere almeno 3 caratteri');
        return;
    }

    try {
        const res = await fetch('/api/staff/change-member-username', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ member_id: currentMemberData.id, new_username: newUsername })
        });

        if (res.ok) {
            showToast('Username cambiato con successo');
            currentMemberData.username = newUsername;
            openMemberProfile(currentMemberData.id);
        } else {
            const err = await res.json();
            showToast(err.detail || 'Impossibile cambiare username');
        }
    } catch (error) {
        console.error('Error changing username:', error);
        showToast('Impossibile cambiare username');
    }
}

// ========== SUBSCRIPTION MANAGEMENT ==========
let availablePlans = [];

async function loadSubscriptionPlans() {
    try {
        const res = await fetch('/api/staff/subscription-plans', { credentials: 'include' });
        if (res.ok) {
            availablePlans = await res.json();
        }
    } catch (error) {
        console.error('Error loading plans:', error);
    }
}

function openSubscriptionManager() {
    const actionsEl = document.getElementById('subscription-actions');
    const assignBtn = document.getElementById('assign-plan-btn');
    const cancelBtn = document.getElementById('cancel-sub-btn');

    actionsEl.classList.remove('hidden');

    // Show appropriate buttons based on subscription status
    const sub = currentMemberData?.subscription || {};
    if (sub.status === 'active' || sub.status === 'trialing') {
        assignBtn.textContent = 'Cambia Piano';
        cancelBtn.classList.remove('hidden');
    } else {
        assignBtn.textContent = 'Assegna Piano';
        cancelBtn.classList.add('hidden');
    }
}

function openPlanSelector() {
    // Load plans first if not loaded
    if (availablePlans.length === 0) {
        loadSubscriptionPlans().then(() => showPlanSelectorModal());
    } else {
        showPlanSelectorModal();
    }
}

function showPlanSelectorModal() {
    const modal = document.getElementById('plan-selector-modal');
    const listEl = document.getElementById('plans-list');
    const memberNameEl = document.getElementById('plan-for-member');

    // Show member name
    if (currentMemberData && memberNameEl) {
        memberNameEl.textContent = currentMemberData.name || currentMemberData.username;
    }

    if (availablePlans.length === 0) {
        listEl.innerHTML = `
            <div class="text-center py-8">
                <p class="text-gray-400">Nessun piano di abbonamento disponibile.</p>
                <p class="text-xs text-gray-500 mt-2">Chiedi al proprietario di creare i piani prima.</p>
            </div>
        `;
    } else {
        listEl.innerHTML = availablePlans.map(plan => `
            <div class="glass-card p-4 hover:bg-white/10 transition cursor-pointer border border-transparent hover:border-primary/30"
                onclick="selectPlan('${plan.id}', '${plan.name}')">
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-bold text-white">${plan.name}</h4>
                    <span class="text-primary font-bold">${plan.currency || '€'}${plan.price}/${plan.billing_interval === 'year' ? 'yr' : 'mo'}</span>
                </div>
                <p class="text-sm text-gray-400 mb-2">${plan.description || 'Standard membership plan'}</p>
                ${plan.features && plan.features.length > 0 ? `
                    <div class="flex flex-wrap gap-1">
                        ${plan.features.slice(0, 3).map(f => `
                            <span class="text-xs bg-white/10 text-gray-300 px-2 py-0.5 rounded">${f}</span>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        `).join('');
    }

    modal.classList.remove('hidden');
}

function closePlanSelector() {
    document.getElementById('plan-selector-modal').classList.add('hidden');
}

async function selectPlan(planId, planName) {
    if (!currentMemberData) return;

    const sub = currentMemberData.subscription || {};
    const endpoint = (sub.status === 'active' || sub.status === 'trialing')
        ? '/api/staff/change-subscription'
        : '/api/staff/subscribe-client';

    try {
        const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                client_id: currentMemberData.id,
                plan_id: planId
            })
        });

        if (res.ok) {
            const data = await res.json();
            showToast(data.message || `Subscribed to ${planName}!`, 'success');
            closePlanSelector();

            // Refresh member profile
            await openMemberProfile(currentMemberData.id);
        } else {
            const err = await res.json();
            showToast(err.detail || 'Impossibile aggiornare l\'abbonamento', 'error');
        }
    } catch (error) {
        console.error('Subscription error:', error);
        showToast('Impossibile aggiornare l\'abbonamento', 'error');
    }
}

async function cancelMemberSubscription() {
    if (!currentMemberData) return;

    if (!confirm(`Annullare l'abbonamento per ${currentMemberData.name || currentMemberData.username}?`)) {
        return;
    }

    try {
        const res = await fetch('/api/staff/cancel-subscription', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ client_id: currentMemberData.id })
        });

        if (res.ok) {
            const data = await res.json();
            showToast(data.message || 'Abbonamento annullato', 'success');

            // Refresh member profile
            await openMemberProfile(currentMemberData.id);
        } else {
            const err = await res.json();
            showToast(err.detail || 'Impossibile annullare l\'abbonamento', 'error');
        }
    } catch (error) {
        console.error('Cancel error:', error);
        showToast('Impossibile annullare l\'abbonamento', 'error');
    }
}

// Load plans when page loads
document.addEventListener('DOMContentLoaded', loadSubscriptionPlans);

// Close plan selector on background click
document.getElementById('plan-selector-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'plan-selector-modal') {
        closePlanSelector();
    }
});

// Auto-focus check-in input for QR scanner
document.getElementById('checkin-search')?.focus();

// Search on Enter key
document.getElementById('checkin-search')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') searchMember();
});

// Search on input
document.getElementById('checkin-search')?.addEventListener('input', (e) => {
    if (e.target.value.length >= 2) {
        searchMember();
    } else {
        document.getElementById('search-results').classList.add('hidden');
    }
});

// ========== QR SCANNER (USB Reader) ==========
function openQrScanner() {
    const modal = document.getElementById('qr-scanner-modal');
    const input = document.getElementById('qr-scanner-input');
    const icon = document.getElementById('qr-scan-icon');
    const status = document.getElementById('qr-scan-status');

    // Reset state
    input.value = '';
    icon.classList.remove('bg-green-500/20', 'border-green-500/50');
    icon.classList.add('bg-purple-500/20', 'border-purple-500/50', 'animate-pulse');
    status.textContent = 'Ready to scan';
    status.classList.remove('text-green-400');
    status.classList.add('text-white');

    modal.classList.remove('hidden');

    // Focus the input so the USB scanner types into it
    setTimeout(() => input.focus(), 100);

    // Re-init lucide icons in modal
    if (typeof lucide !== 'undefined') lucide.createIcons();
}

function closeQrScanner() {
    document.getElementById('qr-scanner-modal').classList.add('hidden');
    // Refocus the main check-in input
    document.getElementById('checkin-search')?.focus();
}

// Handle scanner input (Enter key triggers check-in)
document.getElementById('qr-scanner-input')?.addEventListener('keypress', async (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        const input = document.getElementById('qr-scanner-input');
        const value = input.value.trim();
        if (!value) return;

        // Feed into the main check-in flow
        document.getElementById('checkin-search').value = value;
        input.value = '';

        // Show success animation briefly
        const icon = document.getElementById('qr-scan-icon');
        const status = document.getElementById('qr-scan-status');
        icon.classList.remove('bg-purple-500/20', 'border-purple-500/50', 'animate-pulse');
        icon.classList.add('bg-green-500/20', 'border-green-500/50');
        status.textContent = 'Scanned!';
        status.classList.remove('text-white');
        status.classList.add('text-green-400');

        // Close scanner and process
        closeQrScanner();
        await searchMember();
    }
});

// ========== NFC SHOWER SYSTEM ==========

function toggleNfcSection() {
    const section = document.getElementById('nfc-section');
    const btn = document.getElementById('nfc-toggle-btn');
    if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        btn.textContent = 'Hide';
        loadNfcTags();
        loadShowerUsage();
    } else {
        section.classList.add('hidden');
        btn.textContent = 'Show';
    }
}

async function loadNfcTags() {
    try {
        const res = await fetch('/api/staff/nfc-tags', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load NFC tags');
        const tags = await res.json();

        document.getElementById('nfc-tags-count').textContent = tags.length;
        const container = document.getElementById('nfc-tags-list');

        if (tags.length === 0) {
            container.innerHTML = '<p class="text-gray-400 text-sm text-center py-2">No NFC tags registered</p>';
            return;
        }

        container.innerHTML = tags.map(tag => `
            <div class="flex items-center justify-between p-2 bg-white/5 rounded-lg">
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-semibold text-white truncate">${escapeHtml(tag.member_name)}</p>
                    <p class="text-xs text-gray-400">
                        <span class="font-mono">${escapeHtml(tag.nfc_uid)}</span>
                        ${tag.label ? ' · ' + escapeHtml(tag.label) : ''}
                    </p>
                </div>
                <button onclick="unregisterNfc(${tag.id})" class="text-red-400 hover:text-red-300 p-1 ml-2" title="Unregister">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
        `).join('');

        if (typeof lucide !== 'undefined') lucide.createIcons();
    } catch (err) {
        console.error('Error loading NFC tags:', err);
    }
}

async function registerNfcTag() {
    const nfcUid = document.getElementById('nfc-uid-input').value.trim();
    const memberId = document.getElementById('nfc-member-select').value;
    const label = document.getElementById('nfc-label-input').value.trim();

    if (!nfcUid) { alert('Please scan or enter an NFC tag UID'); return; }
    if (!memberId) { alert('Please select a member'); return; }

    try {
        const res = await fetch('/api/staff/register-nfc', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ nfc_uid: nfcUid, member_id: memberId, label: label || undefined })
        });

        const result = await res.json();
        if (!res.ok) throw new Error(result.detail || 'Registration failed');

        document.getElementById('nfc-uid-input').value = '';
        document.getElementById('nfc-label-input').value = '';
        document.getElementById('nfc-member-select').value = '';

        showToast(result.message, 'success');
        loadNfcTags();
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}

async function unregisterNfc(tagId) {
    if (!confirm('Unregister this NFC tag?')) return;

    try {
        const res = await fetch(`/api/staff/unregister-nfc/${tagId}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        if (!res.ok) throw new Error('Failed to unregister');
        showToast('NFC tag unregistered', 'success');
        loadNfcTags();
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}

async function loadShowerUsage() {
    try {
        const res = await fetch('/api/staff/shower-usage', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load shower usage');
        const data = await res.json();

        document.getElementById('shower-usage-count').textContent = data.count;
        const container = document.getElementById('shower-usage-list');

        if (data.count === 0) {
            container.innerHTML = '<p class="text-gray-400 text-sm text-center py-2">No showers used today</p>';
            return;
        }

        container.innerHTML = data.usages.map(u => {
            const mins = u.duration_seconds ? Math.floor(u.duration_seconds / 60) : Math.floor(u.timer_seconds / 60);
            const secs = u.duration_seconds ? (u.duration_seconds % 60).toString().padStart(2, '0') : '00';
            const statusColor = u.completed ? 'text-green-400' : 'text-yellow-400';
            const statusText = u.completed ? `${mins}:${secs}` : 'Active';

            return `
                <div class="flex items-center justify-between p-2 bg-white/5 rounded-lg">
                    <div>
                        <p class="text-sm font-semibold text-white">${escapeHtml(u.member_name)}</p>
                        <p class="text-xs text-gray-400">${u.time}${u.shower_id && u.shower_id !== 'default' ? ' · ' + escapeHtml(u.shower_id) : ''}</p>
                    </div>
                    <span class="text-xs ${statusColor} font-semibold">${statusText}</span>
                </div>
            `;
        }).join('');
    } catch (err) {
        console.error('Error loading shower usage:', err);
    }
}

// NFC UID input listener — USB NFC readers type UID + Enter
document.getElementById('nfc-uid-input')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        const memberId = document.getElementById('nfc-member-select').value;
        if (memberId) {
            registerNfcTag();
        }
    }
});

// ========== CLIENT ONBOARDING WIZARD ==========
const onboardingState = {
    currentStep: 1,
    totalSteps: 5,
    data: {
        name: '',
        phone: '',
        email: '',
        dateOfBirth: '',
        username: '',
        password: '',
        documentType: 'waiver',
        documentData: null,
        waiverText: '',
        planId: null,
        planName: '',
        planPrice: 0,
        planCurrency: '€',
        profilePhoto: null,
        paymentMethod: null
    }
};

let signatureCanvas, signatureCtx;
let isDrawing = false;

function openOnboardingWizard() {
    // Reset state
    onboardingState.currentStep = 1;
    onboardingState.data = {
        name: '', phone: '', email: '', dateOfBirth: '',
        username: '',
        documentType: 'waiver', documentData: null, waiverText: '',
        planId: null, planName: '', planPrice: 0, planCurrency: '€',
        profilePhoto: null, paymentMethod: null
    };

    // Clear form fields
    document.getElementById('onboard-name').value = '';
    document.getElementById('onboard-phone').value = '';
    document.getElementById('onboard-email').value = '';
    document.getElementById('onboard-dob').value = '';
    document.getElementById('onboard-username').value = '';
    removeOnboardPhoto();

    // Reset UI
    showOnboardStep(1);
    document.getElementById('onboarding-wizard-modal').classList.remove('hidden');

    // Load waiver and plans
    loadWaiverTemplate();
    loadOnboardingPlans();
    // Note: signature canvas is initialized when step 2 becomes visible
}

function closeOnboardingWizard() {
    stopTerminalPolling();
    document.getElementById('onboarding-wizard-modal').classList.add('hidden');
}

function showOnboardStep(step) {
    onboardingState.currentStep = step;

    // Hide all steps
    document.querySelectorAll('.onboard-step-content').forEach(el => el.classList.add('hidden'));

    // Show current step
    document.getElementById(`onboard-step-${step}`).classList.remove('hidden');

    // Initialize signature canvas when step 2 becomes visible
    if (step === 2) {
        setTimeout(initSignatureCanvas, 50);
    }

    // Update step indicators
    document.querySelectorAll('.onboard-step-dot').forEach((dot, i) => {
        const stepNum = i + 1;
        const circle = dot.querySelector('span:first-child');
        if (stepNum <= step) {
            circle.className = 'w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white text-sm font-bold';
        } else {
            circle.className = 'w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-white/60 text-sm font-bold';
        }
    });

    // Update navigation buttons
    const prevBtn = document.getElementById('onboard-prev-btn');
    const nextBtn = document.getElementById('onboard-next-btn');
    const completeBtn = document.getElementById('onboard-complete-btn');

    prevBtn.classList.toggle('hidden', step === 1);
    nextBtn.classList.toggle('hidden', step === 5);
    completeBtn.classList.toggle('hidden', step !== 5);

    // Update step 5 summary if on last step
    if (step === 5) {
        updateOnboardingSummary();
    }
}

function onboardNextStep() {
    if (!validateOnboardStep(onboardingState.currentStep)) return;
    saveOnboardStepData(onboardingState.currentStep);

    if (onboardingState.currentStep < onboardingState.totalSteps) {
        showOnboardStep(onboardingState.currentStep + 1);
    }
}

function onboardPrevStep() {
    if (onboardingState.currentStep > 1) {
        showOnboardStep(onboardingState.currentStep - 1);
    }
}

function validateOnboardStep(step) {
    if (step === 1) {
        const name = document.getElementById('onboard-name').value.trim();
        const phone = document.getElementById('onboard-phone').value.trim();
        const username = document.getElementById('onboard-username').value.trim();

        if (!name) { showToast('Il nome è obbligatorio', 'error'); return false; }
        if (!phone) { showToast('Il telefono è obbligatorio', 'error'); return false; }
        if (!username) { showToast('L\'username è obbligatorio', 'error'); return false; }
        return true;
    }

    if (step === 2) {
        if (onboardingState.data.documentType === 'waiver') {
            // Check if signature exists
            if (!hasSignature()) {
                showToast('Fai firmare la liberatoria al cliente', 'error');
                return false;
            }
        } else {
            // Check if file uploaded
            const fileInput = document.getElementById('medical-file');
            if (!fileInput.files || !fileInput.files[0]) {
                showToast('Carica il certificato medico', 'error');
                return false;
            }
        }
        return true;
    }

    return true; // Steps 3 and 4 have no required validation
}

function saveOnboardStepData(step) {
    if (step === 1) {
        onboardingState.data.name = document.getElementById('onboard-name').value.trim();
        onboardingState.data.phone = document.getElementById('onboard-phone').value.trim();
        onboardingState.data.email = document.getElementById('onboard-email').value.trim();
        onboardingState.data.dateOfBirth = document.getElementById('onboard-dob').value;
        onboardingState.data.username = document.getElementById('onboard-username').value.trim();
    }

    if (step === 2) {
        if (onboardingState.data.documentType === 'waiver') {
            onboardingState.data.documentData = signatureCanvas.toDataURL('image/png');
            onboardingState.data.waiverText = document.getElementById('waiver-text-display').textContent;
        } else {
            // File will be read on submit
        }
    }
}

async function loadWaiverTemplate() {
    try {
        const res = await fetch('/api/staff/waiver-template', { credentials: 'include' });
        if (res.ok) {
            const data = await res.json();
            document.getElementById('waiver-text-display').textContent = data.waiver_text;
        }
    } catch (e) {
        console.error('Error loading waiver:', e);
    }
}

function formatCurrencySymbol(code) {
    if (!code) return '€';
    const symbols = { eur: '€', usd: '$', gbp: '£' };
    return symbols[code.toLowerCase()] || code.toUpperCase() + ' ';
}

async function loadOnboardingPlans() {
    const listEl = document.getElementById('onboard-plans-list');

    // Fetch plans if not loaded yet
    if (availablePlans.length === 0) {
        await loadSubscriptionPlans();
    }

    if (availablePlans.length === 0) {
        listEl.innerHTML = `
            <div class="text-center py-6">
                <p class="text-gray-400">Nessun piano di abbonamento disponibile.</p>
                <p class="text-xs text-gray-500 mt-2">Il cliente può essere registrato senza un piano.</p>
            </div>
        `;
        return;
    }

    listEl.innerHTML = availablePlans.map(plan => `
        <div class="glass-card p-4 cursor-pointer border-2 transition ${onboardingState.data.planId === plan.id ? 'border-primary bg-primary/10' : 'border-transparent hover:border-white/20'}"
            onclick="selectOnboardPlan('${plan.id}', '${plan.name}', ${plan.price}, '${formatCurrencySymbol(plan.currency)}')">
            <div class="flex justify-between items-start">
                <div>
                    <h4 class="font-bold text-white">${plan.name}</h4>
                    <p class="text-xs text-gray-400">${plan.description || 'Membership plan'}</p>
                </div>
                <span class="text-primary font-bold">${formatCurrencySymbol(plan.currency)}${plan.price}/${plan.billing_interval === 'year' ? 'yr' : 'mo'}</span>
            </div>
        </div>
    `).join('');
}

function selectOnboardPlan(planId, planName, price, currency) {
    onboardingState.data.planId = planId;
    onboardingState.data.planName = planName;
    onboardingState.data.planPrice = price;
    onboardingState.data.planCurrency = currency;

    // Update UI to show selected
    loadOnboardingPlans();
}

function skipPlanSelection() {
    onboardingState.data.planId = null;
    onboardingState.data.planName = '';
    onboardingState.data.planPrice = 0;
    showOnboardStep(4);
}

function updateOnboardingSummary() {
    document.getElementById('summary-client-name').textContent = onboardingState.data.name;
    document.getElementById('summary-username').textContent = onboardingState.data.username;

    if (onboardingState.data.planId) {
        document.getElementById('summary-plan').textContent = onboardingState.data.planName;
        document.getElementById('summary-amount').textContent = `${onboardingState.data.planCurrency}${onboardingState.data.planPrice}`;
        document.getElementById('payment-method-section').classList.remove('hidden');
        document.getElementById('no-payment-section').classList.add('hidden');
    } else {
        document.getElementById('summary-plan').textContent = 'Nessun piano selezionato';
        document.getElementById('summary-amount').textContent = '-';
        document.getElementById('payment-method-section').classList.add('hidden');
        document.getElementById('no-payment-section').classList.remove('hidden');
    }
}

function selectPaymentMethod(method) {
    onboardingState.data.paymentMethod = method;

    const cashBtn = document.getElementById('pay-cash-btn');
    const terminalBtn = document.getElementById('pay-terminal-btn');
    const terminalForm = document.getElementById('terminal-payment-form');

    // Reset all button styles
    cashBtn.classList.remove('border-green-500', 'bg-green-500/10');
    terminalBtn?.classList.remove('border-orange-500', 'bg-orange-500/10');

    // Update selected button style
    if (method === 'cash') {
        cashBtn.classList.add('border-green-500', 'bg-green-500/10');
    } else if (method === 'terminal') {
        terminalBtn?.classList.add('border-orange-500', 'bg-orange-500/10');
    }

    // Show/hide payment forms
    terminalForm?.classList.add('hidden');

    if (method === 'terminal') {
        terminalForm?.classList.remove('hidden');
        // Reset terminal form to initial state
        document.getElementById('pos-initial').classList.remove('hidden');
        document.getElementById('pos-processing').classList.add('hidden');
        document.getElementById('pos-success').classList.add('hidden');
        document.getElementById('pos-error').classList.add('hidden');
        document.getElementById('pos-simulate-btn')?.classList.add('hidden');
    }
}

// --- POS TERMINAL PAYMENT ---
let terminalPaymentIntentId = null;
let terminalPollingInterval = null;

async function startTerminalPayment() {
    document.getElementById('pos-initial').classList.add('hidden');
    document.getElementById('pos-processing').classList.remove('hidden');
    document.getElementById('pos-success').classList.add('hidden');
    document.getElementById('pos-error').classList.add('hidden');
    // Reset simulate button for new payment
    const simBtn = document.getElementById('pos-simulate-btn');
    if (simBtn) { simBtn.disabled = false; simBtn.textContent = 'Simula Carta (Sandbox)'; simBtn.classList.add('hidden'); }

    try {
        const res = await fetch('/api/terminal/process-payment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                plan_id: onboardingState.data.planId,
                client_name: onboardingState.data.name,
                coupon_code: onboardingState.data.couponCode || null
            })
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || 'Failed to start terminal payment');
        }

        const data = await res.json();
        terminalPaymentIntentId = data.payment_intent_id;

        // Show sandbox simulate button if in test mode
        if (data.is_test_mode) {
            document.getElementById('pos-simulate-btn')?.classList.remove('hidden');
        }

        startTerminalPolling();
    } catch (e) {
        console.error('Terminal payment error:', e);
        document.getElementById('pos-processing').classList.add('hidden');
        document.getElementById('pos-error').classList.remove('hidden');
        document.getElementById('pos-error-msg').textContent = e.message || 'Terminal payment failed';
        // Re-enable complete button
        const btn = document.getElementById('onboard-complete-btn');
        btn.disabled = false;
        btn.textContent = 'Completa Registrazione';
    }
}

function startTerminalPolling() {
    if (terminalPollingInterval) clearInterval(terminalPollingInterval);

    terminalPollingInterval = setInterval(async () => {
        if (!terminalPaymentIntentId) {
            clearInterval(terminalPollingInterval);
            return;
        }

        try {
            const res = await fetch(`/api/terminal/payment-status/${terminalPaymentIntentId}`, {
                credentials: 'include'
            });
            if (!res.ok) return;

            const data = await res.json();
            if (data.status === 'succeeded') {
                clearInterval(terminalPollingInterval);
                terminalPollingInterval = null;

                document.getElementById('pos-processing').classList.add('hidden');
                document.getElementById('pos-success').classList.remove('hidden');

                // Brief delay so user sees "Pagamento Ricevuto!" before modal closes
                await new Promise(r => setTimeout(r, 1000));
                await finalizeTerminalOnboarding(terminalPaymentIntentId);
            } else if (data.status === 'requires_payment_method' || data.status === 'requires_confirmation') {
                // Normal — reader is waiting for card tap, keep polling
            } else if (data.status === 'canceled') {
                clearInterval(terminalPollingInterval);
                terminalPollingInterval = null;
                document.getElementById('pos-processing').classList.add('hidden');
                document.getElementById('pos-error').classList.remove('hidden');
                document.getElementById('pos-error-msg').textContent = 'Pagamento annullato';
                const btn = document.getElementById('onboard-complete-btn');
                btn.disabled = false;
                btn.textContent = 'Completa Registrazione';
            }
        } catch (e) {
            console.error('Terminal polling error:', e);
        }
    }, 2000);
}

function stopTerminalPolling() {
    if (terminalPollingInterval) {
        clearInterval(terminalPollingInterval);
        terminalPollingInterval = null;
    }
    terminalPaymentIntentId = null;
}

async function simulateCardTap() {
    const btn = document.getElementById('pos-simulate-btn');
    if (btn) { btn.disabled = true; btn.textContent = 'Invio simulazione...'; }
    try {
        const res = await fetch('/api/terminal/simulate-payment', {
            method: 'POST',
            credentials: 'include'
        });
        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || 'Errore simulazione');
        }
        // Polling will pick up the succeeded status automatically
        if (btn) btn.textContent = 'Simulazione inviata!';
    } catch (e) {
        console.error('Simulate card error:', e);
        showToast(e.message || 'Errore simulazione carta', 'error');
        if (btn) { btn.disabled = false; btn.textContent = 'Simula Carta (Sandbox)'; }
    }
}

async function finalizeTerminalOnboarding(paymentIntentId) {
    const completeBtn = document.getElementById('onboard-complete-btn');
    completeBtn.disabled = true;
    completeBtn.textContent = 'Registrazione...';

    try {
        const payload = {
            name: onboardingState.data.name,
            phone: onboardingState.data.phone,
            email: onboardingState.data.email || null,
            date_of_birth: onboardingState.data.dateOfBirth || null,
            username: onboardingState.data.username,
            document_type: onboardingState.data.documentType,
            plan_id: onboardingState.data.planId,
            payment_method: 'terminal',
            profile_photo: onboardingState.data.profilePhoto || null,
            stripe_payment_intent_id: paymentIntentId
        };

        if (onboardingState.data.documentType === 'waiver') {
            payload.document_data = signatureCanvas.toDataURL('image/png');
            payload.waiver_text = document.getElementById('waiver-text-display').textContent;
        } else {
            const fileInput = document.getElementById('medical-file');
            if (fileInput.files && fileInput.files[0]) {
                payload.document_data = await fileToBase64(fileInput.files[0]);
            }
        }

        const res = await fetch('/api/staff/onboard-client', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            const data = await res.json();
            closeOnboardingWizard();
            showTemporaryPasswordModal(data.name, data.username, data.temporary_password, onboardingState.data.phone);
            await loadStaffData();
        } else {
            const err = await res.json();
            const errorMsg = err.detail || 'Registrazione fallita';
            document.getElementById('pos-success')?.classList.add('hidden');
            document.getElementById('pos-error')?.classList.remove('hidden');
            document.getElementById('pos-error-msg').textContent = errorMsg;
        }
    } catch (error) {
        console.error('Terminal onboarding error:', error);
        const errorMsg = error.message || 'Registrazione fallita';
        document.getElementById('pos-success')?.classList.add('hidden');
        document.getElementById('pos-error')?.classList.remove('hidden');
        document.getElementById('pos-error-msg').textContent = errorMsg;
    } finally {
        completeBtn.disabled = false;
        completeBtn.textContent = 'Completa Registrazione';
    }
}

async function cancelTerminalPayment() {
    if (!terminalPaymentIntentId) return;
    try {
        await fetch('/api/terminal/cancel-payment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ payment_intent_id: terminalPaymentIntentId })
        });
    } catch (e) { console.error('Cancel error:', e); }
    stopTerminalPolling();
    document.getElementById('pos-processing').classList.add('hidden');
    document.getElementById('pos-initial').classList.remove('hidden');
    const btn = document.getElementById('onboard-complete-btn');
    btn.disabled = false;
    btn.textContent = 'Completa Registrazione';
}

function retryTerminalPayment() {
    stopTerminalPolling();
    document.getElementById('pos-error').classList.add('hidden');
    document.getElementById('pos-initial').classList.remove('hidden');
    const btn = document.getElementById('onboard-complete-btn');
    btn.disabled = false;
    btn.textContent = 'Completa Registrazione';
}

// Document type selection
function selectDocType(type) {
    onboardingState.data.documentType = type;

    const waiverBtn = document.getElementById('doc-type-waiver');
    const medicalBtn = document.getElementById('doc-type-medical');
    const waiverSection = document.getElementById('waiver-section');
    const medicalSection = document.getElementById('medical-section');

    if (type === 'waiver') {
        waiverBtn.className = 'flex-1 py-3 rounded-xl text-sm font-semibold transition bg-primary/20 text-primary border border-primary/30';
        medicalBtn.className = 'flex-1 py-3 rounded-xl text-sm font-semibold transition bg-white/5 text-white/60 border border-white/10 hover:bg-white/10';
        waiverSection.classList.remove('hidden');
        medicalSection.classList.add('hidden');
    } else {
        medicalBtn.className = 'flex-1 py-3 rounded-xl text-sm font-semibold transition bg-primary/20 text-primary border border-primary/30';
        waiverBtn.className = 'flex-1 py-3 rounded-xl text-sm font-semibold transition bg-white/5 text-white/60 border border-white/10 hover:bg-white/10';
        medicalSection.classList.remove('hidden');
        waiverSection.classList.add('hidden');
    }
}

// Signature canvas - supports mouse, touch, and pen tablets (XP-Pen, Wacom, etc.)
let lastX = 0, lastY = 0;
let canvasInitialized = false;

function initSignatureCanvas() {
    signatureCanvas = document.getElementById('signature-canvas');
    if (!signatureCanvas) {
        console.error('Signature canvas not found');
        return;
    }

    // Get actual displayed size
    const rect = signatureCanvas.getBoundingClientRect();
    console.log('Canvas rect:', rect.width, rect.height);

    // If canvas has no size, it's probably still hidden - retry
    if (rect.width === 0 || rect.height === 0) {
        console.log('Canvas has no size, retrying...');
        setTimeout(initSignatureCanvas, 100);
        return;
    }

    // Remove old event listeners if re-initializing
    if (canvasInitialized) {
        signatureCanvas.removeEventListener('mousedown', handleMouseDown);
        signatureCanvas.removeEventListener('mousemove', handleMouseMove);
        signatureCanvas.removeEventListener('mouseup', handleMouseUp);
        signatureCanvas.removeEventListener('mouseleave', handleMouseUp);
    }

    signatureCtx = signatureCanvas.getContext('2d');

    // Set canvas internal size to match displayed size (1:1 for simplicity)
    signatureCanvas.width = rect.width;
    signatureCanvas.height = rect.height;

    // Set drawing styles
    signatureCtx.lineCap = 'round';
    signatureCtx.lineJoin = 'round';
    signatureCtx.strokeStyle = '#000';
    signatureCtx.lineWidth = 2;

    // Clear with white background
    signatureCtx.fillStyle = '#fff';
    signatureCtx.fillRect(0, 0, rect.width, rect.height);

    // Mouse events - most pen tablets (XP-Pen, Wacom) work as mouse emulation
    signatureCanvas.addEventListener('mousedown', handleMouseDown);
    signatureCanvas.addEventListener('mousemove', handleMouseMove);
    signatureCanvas.addEventListener('mouseup', handleMouseUp);
    signatureCanvas.addEventListener('mouseleave', handleMouseUp);

    // Touch events for mobile/tablets
    signatureCanvas.addEventListener('touchstart', handleTouchStart, { passive: false });
    signatureCanvas.addEventListener('touchmove', handleTouchMove, { passive: false });
    signatureCanvas.addEventListener('touchend', handleMouseUp);
    signatureCanvas.addEventListener('touchcancel', handleMouseUp);

    canvasInitialized = true;
    console.log('Signature canvas initialized successfully:', rect.width, 'x', rect.height);
}

function getCanvasCoords(e, isTouch = false) {
    const rect = signatureCanvas.getBoundingClientRect();
    if (isTouch && e.touches && e.touches.length > 0) {
        return {
            x: e.touches[0].clientX - rect.left,
            y: e.touches[0].clientY - rect.top
        };
    }
    return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
    };
}

function hidePlaceholder() {
    const placeholder = document.getElementById('signature-placeholder');
    if (placeholder) placeholder.classList.add('hidden');
}

// Mouse handlers (works with XP-Pen and other pen tablets)
function handleMouseDown(e) {
    e.preventDefault();
    isDrawing = true;
    hidePlaceholder();

    const coords = getCanvasCoords(e);
    lastX = coords.x;
    lastY = coords.y;

    // Draw initial dot
    signatureCtx.fillStyle = '#000';
    signatureCtx.beginPath();
    signatureCtx.arc(lastX, lastY, 1, 0, Math.PI * 2);
    signatureCtx.fill();
}

function handleMouseMove(e) {
    if (!isDrawing) return;
    e.preventDefault();

    const coords = getCanvasCoords(e);

    signatureCtx.beginPath();
    signatureCtx.moveTo(lastX, lastY);
    signatureCtx.lineTo(coords.x, coords.y);
    signatureCtx.stroke();

    lastX = coords.x;
    lastY = coords.y;
}

function handleMouseUp(e) {
    isDrawing = false;
}

// Touch handlers
function handleTouchStart(e) {
    e.preventDefault();
    if (e.touches.length === 0) return;

    isDrawing = true;
    hidePlaceholder();

    const coords = getCanvasCoords(e, true);
    lastX = coords.x;
    lastY = coords.y;

    // Draw initial dot
    signatureCtx.fillStyle = '#000';
    signatureCtx.beginPath();
    signatureCtx.arc(lastX, lastY, 1, 0, Math.PI * 2);
    signatureCtx.fill();
}

function handleTouchMove(e) {
    e.preventDefault();
    if (!isDrawing || e.touches.length === 0) return;

    const coords = getCanvasCoords(e, true);

    signatureCtx.beginPath();
    signatureCtx.moveTo(lastX, lastY);
    signatureCtx.lineTo(coords.x, coords.y);
    signatureCtx.stroke();

    lastX = coords.x;
    lastY = coords.y;
}

function clearSignature() {
    if (!signatureCanvas || !signatureCtx) return;
    const rect = signatureCanvas.getBoundingClientRect();
    signatureCtx.fillStyle = '#fff';
    signatureCtx.fillRect(0, 0, rect.width, rect.height);

    // Show placeholder text again
    const placeholder = document.getElementById('signature-placeholder');
    if (placeholder) placeholder.classList.remove('hidden');
}

function hasSignature() {
    if (!signatureCanvas) return false;
    const ctx = signatureCanvas.getContext('2d');
    const pixelData = ctx.getImageData(0, 0, signatureCanvas.width, signatureCanvas.height).data;

    // Check if any pixel is not white
    for (let i = 0; i < pixelData.length; i += 4) {
        if (pixelData[i] < 250 || pixelData[i + 1] < 250 || pixelData[i + 2] < 250) {
            return true;
        }
    }
    return false;
}

// Medical file preview
function previewMedicalFile(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        document.getElementById('medical-filename').textContent = file.name;
        document.getElementById('medical-preview').classList.remove('hidden');
    }
}

function removeMedicalFile() {
    document.getElementById('medical-file').value = '';
    document.getElementById('medical-preview').classList.add('hidden');
}

// ========== STRIPE INTEGRATION FOR ONBOARDING ==========
let onboardStripe = null;
let onboardCardElement = null;
let onboardSecret = null;

async function initStripeElements() {
    // Only initialize once
    if (onboardStripe && onboardCardElement) return;

    // Load Stripe.js if not loaded
    if (!window.Stripe) {
        console.log('Loading Stripe.js...');
        await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://js.stripe.com/v3/';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }

    // Get publishable key from server
    try {
        const res = await fetch('/api/stripe/publishable-key', { credentials: 'include' });
        if (!res.ok) {
            console.error('Could not get Stripe publishable key');
            showToast('Pagamenti con carta non disponibili', 'error');
            return;
        }
        const { publishable_key } = await res.json();

        if (!publishable_key || publishable_key.startsWith('your_')) {
            console.error('Stripe not configured');
            showToast('Pagamenti con carta non configurati', 'error');
            return;
        }

        onboardStripe = Stripe(publishable_key);

        // Create Elements instance
        const elements = onboardStripe.elements();

        // Create card element with explicit styling
        onboardCardElement = elements.create('card', {
            style: {
                base: {
                    color: '#1a1a1a',
                    fontFamily: 'system-ui, -apple-system, sans-serif',
                    fontSmoothing: 'antialiased',
                    fontSize: '18px',
                    lineHeight: '24px',
                    '::placeholder': {
                        color: '#6b7280'
                    }
                },
                invalid: {
                    color: '#ef4444',
                    iconColor: '#ef4444'
                }
            }
        });

        // Mount to the container
        onboardCardElement.mount('#stripe-card-element');

        // Handle validation errors
        onboardCardElement.on('change', (event) => {
            const errorsEl = document.getElementById('onboard-card-errors');
            if (event.error) {
                errorsEl.textContent = event.error.message;
                errorsEl.classList.remove('hidden');
            } else {
                errorsEl.textContent = '';
                errorsEl.classList.add('hidden');
            }
        });

        console.log('Stripe card element mounted successfully');
    } catch (e) {
        console.error('Error initializing Stripe:', e);
        showToast('Impossibile inizializzare il pagamento con carta', 'error');
    }
}

async function createPaymentIntent() {
    try {
        const res = await fetch('/api/staff/create-payment-intent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                plan_id: onboardingState.data.planId,
                client_name: onboardingState.data.name
            })
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || 'Failed to create payment');
        }

        const data = await res.json();
        onboardSecret = data.client_secret;
        return data;
    } catch (e) {
        console.error('Error creating payment intent:', e);
        throw e;
    }
}

async function processCardPayment() {
    if (!onboardStripe || !onboardCardElement || !onboardSecret) {
        throw new Error('Card payment not initialized');
    }

    const billingDetails = { name: onboardingState.data.name };
    if (onboardingState.data.email && onboardingState.data.email.includes('@')) {
        billingDetails.email = onboardingState.data.email;
    }

    const { error, paymentIntent } = await onboardStripe.confirmCardPayment(onboardSecret, {
        payment_method: {
            card: onboardCardElement,
            billing_details: billingDetails
        }
    });

    if (error) {
        throw new Error(error.message);
    }

    return paymentIntent;
}

// Complete onboarding
async function completeOnboarding() {
    // Validate payment method if plan selected
    if (onboardingState.data.planId && !onboardingState.data.paymentMethod) {
        showToast('Seleziona un metodo di pagamento', 'error');
        return;
    }

    const completeBtn = document.getElementById('onboard-complete-btn');
    completeBtn.disabled = true;
    let stripePaymentIntentId = null;

    try {
        // If card payment, process payment first
        if (onboardingState.data.paymentMethod === 'card') {
            completeBtn.textContent = 'Elaborazione pagamento...';

            // Create payment intent
            await createPaymentIntent();

            // Process the card payment
            const paymentIntent = await processCardPayment();
            stripePaymentIntentId = paymentIntent.id;
            console.log('Payment successful:', paymentIntent.id);
        }

        // If terminal payment, start terminal flow and return (auto-completes after payment)
        if (onboardingState.data.paymentMethod === 'terminal') {
            completeBtn.textContent = 'Elaborazione sul terminale...';
            await startTerminalPayment();
            completeBtn.textContent = 'In attesa del pagamento terminale...';
            return;
        }

        completeBtn.textContent = 'Registrazione...';

        // Prepare data
        const payload = {
            name: onboardingState.data.name,
            phone: onboardingState.data.phone,
            email: onboardingState.data.email || null,
            date_of_birth: onboardingState.data.dateOfBirth || null,
            username: onboardingState.data.username,
            document_type: onboardingState.data.documentType,
            plan_id: onboardingState.data.planId,
            payment_method: onboardingState.data.paymentMethod || 'none',
            profile_photo: onboardingState.data.profilePhoto || null,
            stripe_payment_intent_id: stripePaymentIntentId
        };

        // Add document data
        if (onboardingState.data.documentType === 'waiver') {
            payload.document_data = signatureCanvas.toDataURL('image/png');
            payload.waiver_text = document.getElementById('waiver-text-display').textContent;
        } else {
            // Read file as base64
            const fileInput = document.getElementById('medical-file');
            if (fileInput.files && fileInput.files[0]) {
                payload.document_data = await fileToBase64(fileInput.files[0]);
            }
        }

        const res = await fetch('/api/staff/onboard-client', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            const data = await res.json();
            closeOnboardingWizard();
            showTemporaryPasswordModal(data.name, data.username, data.temporary_password, onboardingState.data.phone);
            await loadStaffData();
        } else {
            const err = await res.json();
            showToast(err.detail || 'Registrazione fallita', 'error');
        }
    } catch (error) {
        console.error('Onboarding error:', error);
        showToast(error.message || 'Registrazione fallita', 'error');
    } finally {
        completeBtn.disabled = false;
        completeBtn.textContent = 'Completa Registrazione';
    }
}

function showTemporaryPasswordModal(name, username, password, phone) {
    document.getElementById('temp-pw-name').textContent = name;
    document.getElementById('temp-pw-username').textContent = username;
    document.getElementById('temp-pw-password').textContent = password;

    const msg = `Ciao ${name}! Ecco le tue credenziali per l'app della palestra:\n\nUsername: ${username}\nPassword: ${password}\n\nRicorda di cambiare la password al primo accesso.`;

    const waBtn = document.getElementById('temp-pw-whatsapp');
    const smsBtn = document.getElementById('temp-pw-sms');

    if (phone) {
        // Clean phone: digits only, prepend 39 (Italy) if no country code
        let cleanPhone = phone.replace(/[^0-9+]/g, '');
        if (cleanPhone.startsWith('+')) {
            cleanPhone = cleanPhone.substring(1);
        } else if (cleanPhone.startsWith('0')) {
            cleanPhone = '39' + cleanPhone.substring(1);
        } else if (!cleanPhone.startsWith('39')) {
            cleanPhone = '39' + cleanPhone;
        }
        waBtn.href = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(msg)}`;
        smsBtn.href = `sms:${phone}?body=${encodeURIComponent(msg)}`;
        waBtn.classList.remove('hidden');
        smsBtn.classList.remove('hidden');
    } else {
        waBtn.classList.add('hidden');
        smsBtn.classList.add('hidden');
    }

    document.getElementById('temp-password-modal').classList.remove('hidden');
}

function closeTempPasswordModal() {
    document.getElementById('temp-password-modal').classList.add('hidden');
}

function copyTempPassword() {
    const pw = document.getElementById('temp-pw-password').textContent;
    navigator.clipboard.writeText(pw).then(() => {
        showToast('Password copiata negli appunti', 'success');
    }).catch(() => {
        showToast('Impossibile copiare', 'error');
    });
}

function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

function previewOnboardPhoto(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        if (file.size > 5 * 1024 * 1024) {
            showToast('La foto deve essere sotto 5MB', 'error');
            input.value = '';
            return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
            onboardingState.data.profilePhoto = e.target.result;
            document.getElementById('onboard-photo-img').src = e.target.result;
            document.getElementById('onboard-photo-img').classList.remove('hidden');
            document.getElementById('onboard-photo-placeholder').classList.add('hidden');
            document.getElementById('onboard-photo-preview').classList.remove('border-dashed', 'border-white/20');
            document.getElementById('onboard-photo-preview').classList.add('border-solid', 'border-primary/50');
            document.getElementById('onboard-photo-remove-btn').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }
}

function removeOnboardPhoto() {
    onboardingState.data.profilePhoto = null;
    const input = document.getElementById('onboard-photo-input');
    if (input) input.value = '';
    const img = document.getElementById('onboard-photo-img');
    if (img) { img.src = ''; img.classList.add('hidden'); }
    const placeholder = document.getElementById('onboard-photo-placeholder');
    if (placeholder) placeholder.classList.remove('hidden');
    const preview = document.getElementById('onboard-photo-preview');
    if (preview) {
        preview.classList.add('border-dashed', 'border-white/20');
        preview.classList.remove('border-solid', 'border-primary/50');
    }
    const removeBtn = document.getElementById('onboard-photo-remove-btn');
    if (removeBtn) removeBtn.classList.add('hidden');
}

// Close onboarding wizard on background click
document.getElementById('onboarding-wizard-modal')?.addEventListener('click', (e) => {
    if (e.target.id === 'onboarding-wizard-modal') {
        closeOnboardingWizard();
    }
});

// ========== NEW CHAT - GYM MEMBERS PICKER ==========
// Used by conversations modal "New" button to start a new chat
window.openGymMembersModal = function() {
    // Build a quick member picker from allMembers + allTrainers
    const people = [
        ...allTrainers.map(t => ({ id: t.id, name: t.username, type: 'Trainer' })),
        ...allMembers.map(m => ({ id: m.id, name: m.name || m.username, type: 'Member' }))
    ];

    if (people.length === 0) {
        showToast('Nessun membro della palestra trovato', 'error');
        return;
    }

    // Create a temporary modal for member selection
    let modal = document.getElementById('member-picker-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'member-picker-modal';
        modal.className = 'fixed inset-0 bg-black/95 backdrop-blur-xl z-[85] flex flex-col';
        document.body.appendChild(modal);
    }
    modal.classList.remove('hidden');

    modal.innerHTML = `
        <div class="flex items-center justify-between p-4 border-b border-white/10">
            <h3 class="font-bold text-white text-lg">Nuovo Messaggio</h3>
            <button onclick="document.getElementById('member-picker-modal').classList.add('hidden')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
        </div>
        <div class="p-4">
            <input type="text" id="member-picker-search" placeholder="Cerca..."
                class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-primary outline-none mb-3"
                oninput="filterMemberPicker()">
        </div>
        <div id="member-picker-list" class="flex-1 overflow-y-auto px-4 pb-4 space-y-2">
            ${people.map(p => `
                <div class="member-picker-item bg-white/5 hover:bg-white/10 p-3 rounded-xl cursor-pointer transition" data-name="${(p.name || '').toLowerCase()}"
                    onclick="document.getElementById('member-picker-modal').classList.add('hidden'); openChatModal('${p.id}', '${(p.name || '').replace(/'/g, "\\'")}')">
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-full bg-gradient-to-br ${p.type === 'Trainer' ? 'from-orange-500 to-red-500' : 'from-green-500 to-emerald-600'} flex items-center justify-center text-white font-bold text-sm">
                            ${(p.name || '?').charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <p class="font-semibold text-white text-sm">${p.name}</p>
                            <p class="text-[10px] text-gray-500">${p.type}</p>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
};

window.filterMemberPicker = function() {
    const query = (document.getElementById('member-picker-search')?.value || '').toLowerCase();
    document.querySelectorAll('.member-picker-item').forEach(item => {
        const name = item.dataset.name || '';
        item.style.display = name.includes(query) ? '' : 'none';
    });
};

// ========== DOCUMENTS TABLE ==========
function renderDocumentsTable(members) {
    function getCertInfo(member) {
        const certStatus = member.certificate_status || 'none';
        const certBadgeClass = certStatus === 'valid' ? 'staff-badge-valid' : (certStatus === 'expired' ? 'staff-badge-expired' : (certStatus === 'expiring' ? 'staff-badge-warning' : 'staff-badge-none'));
        const certLabel = certStatus === 'valid' ? 'Valido' : (certStatus === 'expired' ? 'Scaduto' : (certStatus === 'expiring' ? 'In scadenza' : 'Nessuno'));
        return { certBadgeClass, certLabel };
    }

    // Desktop table
    const tbody = document.getElementById('documents-table-body');
    if (tbody) {
        if (!members || members.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:2rem;color:rgba(255,255,255,0.35);font-size:0.85rem;">Nessun cliente</td></tr>`;
        } else {
            tbody.innerHTML = members.map(member => {
                const initial = member.name ? member.name.charAt(0).toUpperCase() : '?';
                const { certBadgeClass, certLabel } = getCertInfo(member);
                const certFile = member.certificate_filename || '-';
                const certExpiry = member.certificate_expiry || '-';
                const safeName = escapeHtml(member.name || member.username);
                return `
                    <tr onclick="openMemberProfile('${member.id}')" style="cursor:pointer;">
                        <td>
                            <div class="member-cell">
                                <div class="member-avatar">${initial}</div>
                                <div class="member-name">${safeName}</div>
                            </div>
                        </td>
                        <td style="font-size:0.8rem;">${escapeHtml(certFile)}</td>
                        <td style="font-size:0.8rem;">${certExpiry}</td>
                        <td><span class="staff-badge ${certBadgeClass}">${certLabel}</span></td>
                        <td>
                            <button onclick="event.stopPropagation(); openMemberProfile('${member.id}')" class="staff-btn-action" style="padding:0.3rem 0.5rem;" title="Dettagli">
                                <i data-lucide="eye" class="w-3.5 h-3.5"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
    }

    // Mobile cards
    const mobileList = document.getElementById('documents-mobile-list');
    if (mobileList) {
        if (!members || members.length === 0) {
            mobileList.innerHTML = `<div style="text-align:center;padding:2rem;color:rgba(255,255,255,0.35);font-size:0.85rem;">Nessun cliente</div>`;
        } else {
            mobileList.innerHTML = members.map(member => {
                const initial = member.name ? member.name.charAt(0).toUpperCase() : '?';
                const { certBadgeClass, certLabel } = getCertInfo(member);
                const certExpiry = member.certificate_expiry || '';
                const safeName = escapeHtml(member.name || member.username);
                return `
                    <div class="staff-mobile-card" onclick="openMemberProfile('${member.id}')">
                        <div class="staff-mobile-card-avatar">${initial}</div>
                        <div class="staff-mobile-card-info">
                            <div class="staff-mobile-card-name">${safeName}</div>
                            <div class="staff-mobile-card-meta">${certExpiry ? 'Scade: ' + certExpiry : 'Nessun certificato'}</div>
                        </div>
                        <span class="staff-badge ${certBadgeClass}">${certLabel}</span>
                    </div>
                `;
            }).join('');
        }
    }

    if (typeof lucide !== 'undefined') lucide.createIcons();
}

// Document search filter
document.getElementById('doc-search')?.addEventListener('input', (e) => {
    const query = e.target.value.trim().toLowerCase();
    if (!query) {
        renderDocumentsTable(allMembers);
        return;
    }
    const filtered = allMembers.filter(m =>
        (m.name && m.name.toLowerCase().includes(query)) ||
        (m.username && m.username.toLowerCase().includes(query))
    );
    renderDocumentsTable(filtered);
});

// ========== RIGHT PANEL MESSAGES ==========
async function loadStaffConversations() {
    const container = document.getElementById('staff-conversations-list');
    if (!container) return;

    try {
        const res = await fetch('/api/messages/conversations', { credentials: 'include' });
        if (!res.ok) {
            container.innerHTML = '<div style="text-align:center;padding:2rem;color:rgba(255,255,255,0.3);font-size:0.85rem;">Nessun messaggio</div>';
            return;
        }

        const conversations = await res.json();
        if (!conversations || conversations.length === 0) {
            container.innerHTML = '<div style="text-align:center;padding:2rem;color:rgba(255,255,255,0.3);font-size:0.85rem;">Nessuna conversazione</div>';
            return;
        }

        container.innerHTML = conversations.slice(0, 20).map(conv => {
            const name = conv.other_user_name || conv.other_username || 'Unknown';
            const initial = name.charAt(0).toUpperCase();
            const preview = conv.last_message || '';
            const time = conv.last_message_time ? formatMessageTime(conv.last_message_time) : '';
            const unread = conv.unread_count > 0;

            return `
                <div class="staff-message-item" onclick="openChatModal('${conv.other_user_id}', '${escapeHtml(name).replace(/'/g, "\\'")}')">
                    <div class="staff-message-avatar">${initial}</div>
                    <div class="staff-message-content">
                        <div class="staff-message-name">${escapeHtml(name)}</div>
                        <div class="staff-message-preview">${escapeHtml(preview)}</div>
                    </div>
                    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
                        <span class="staff-message-time">${time}</span>
                        ${unread ? '<div class="staff-message-unread"></div>' : ''}
                    </div>
                </div>
            `;
        }).join('');
    } catch (err) {
        console.error('Error loading conversations:', err);
        container.innerHTML = '<div style="text-align:center;padding:2rem;color:rgba(255,255,255,0.3);font-size:0.85rem;">Errore caricamento messaggi</div>';
    }
}

function formatMessageTime(isoString) {
    try {
        const d = new Date(isoString);
        const now = new Date();
        const diffMs = now - d;
        const diffMins = Math.floor(diffMs / 60000);

        if (diffMins < 1) return 'ora';
        if (diffMins < 60) return diffMins + 'm';
        if (diffMins < 1440) return Math.floor(diffMins / 60) + 'h';
        return d.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
    } catch { return ''; }
}

// Messages search filter
document.getElementById('messages-search')?.addEventListener('input', (e) => {
    const query = e.target.value.trim().toLowerCase();
    document.querySelectorAll('.staff-message-item').forEach(item => {
        const name = item.querySelector('.staff-message-name')?.textContent?.toLowerCase() || '';
        item.style.display = name.includes(query) ? '' : 'none';
    });
});

// Mobile messages search filter
document.getElementById('mobile-messages-search')?.addEventListener('input', (e) => {
    const query = e.target.value.trim().toLowerCase();
    document.querySelectorAll('#mobile-conversations-list .staff-message-item').forEach(item => {
        const name = item.querySelector('.staff-message-name')?.textContent?.toLowerCase() || '';
        item.style.display = name.includes(query) ? '' : 'none';
    });
});

// Mobile messages toggle
function toggleMobileMessages() {
    const overlay = document.getElementById('mobile-messages-overlay');
    if (!overlay) return;
    const isOpen = overlay.classList.contains('open');
    overlay.classList.toggle('open');
    document.body.style.overflow = isOpen ? '' : 'hidden';
    // Copy desktop conversations to mobile panel if needed
    if (!isOpen) {
        const desktopList = document.getElementById('staff-conversations-list');
        const mobileList = document.getElementById('mobile-conversations-list');
        if (desktopList && mobileList) {
            mobileList.innerHTML = desktopList.innerHTML;
        }
    }
}

// Load conversations on page load
document.addEventListener('DOMContentLoaded', loadStaffConversations);

// ========== MEMBER SEARCH (new table layout) ==========
document.getElementById('member-search')?.addEventListener('input', (e) => {
    const query = e.target.value.trim().toLowerCase();
    if (!query) {
        renderMembers(allMembers);
        return;
    }
    const filtered = allMembers.filter(m =>
        (m.name && m.name.toLowerCase().includes(query)) ||
        (m.username && m.username.toLowerCase().includes(query)) ||
        (m.email && m.email.toLowerCase().includes(query))
    );
    renderMembers(filtered);
});
</script>
{% endblock %}
