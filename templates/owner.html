{% extends "base.html" %}
{% from 'macros.html' import card %}

{% block content %}
<!-- Desktop Navigation Bar (hidden on mobile) -->
<nav class="hidden lg:flex items-center justify-between px-8 py-4 border-b border-white/10 mb-6">
    <div class="flex items-center gap-3">
        <span class="text-2xl">üè¢</span>
        <div>
            <p class="label-uppercase text-[10px]">Gym Owner</p>
            <h1 class="text-lg font-bold" id="desktop-gym-name">My Gym</h1>
        </div>
    </div>
    <div class="flex items-center gap-2">
        <a href="{{ 'owner.html' if static_build else '/?gym_id=' + gym_id + '&role=owner' }}"
           class="px-4 py-2 rounded-xl text-sm font-semibold transition {{ 'bg-primary/20 text-primary border border-primary/30' if mode != 'settings' and mode != 'automation' and mode != 'crm' else 'text-white/60 hover:bg-white/5' }}">
            üè† Dashboard
        </a>
        <a href="{{ 'owner.html' if static_build else '/?gym_id=' + gym_id + '&role=owner&mode=automation' }}"
           class="px-4 py-2 rounded-xl text-sm font-semibold transition {{ 'bg-primary/20 text-primary border border-primary/30' if mode == 'automation' else 'text-white/60 hover:bg-white/5' }}">
            üì¨ Automation
        </a>
        <a href="{{ 'owner.html' if static_build else '/?gym_id=' + gym_id + '&role=owner&mode=crm' }}"
           class="px-4 py-2 rounded-xl text-sm font-semibold transition {{ 'bg-primary/20 text-primary border border-primary/30' if mode == 'crm' else 'text-white/60 hover:bg-white/5' }}">
            üìä CRM
        </a>
        <a href="{{ 'owner.html' if static_build else '/?gym_id=' + gym_id + '&role=owner&mode=settings' }}"
           class="px-4 py-2 rounded-xl text-sm font-semibold transition {{ 'bg-primary/20 text-primary border border-primary/30' if mode == 'settings' else 'text-white/60 hover:bg-white/5' }}">
            ‚öôÔ∏è Settings
        </a>
        <div class="w-px h-6 bg-white/10 mx-2"></div>
        <a href="/auth/logout" class="px-4 py-2 rounded-xl text-sm font-semibold text-red-400 hover:bg-red-500/10 transition">
            üö™ Logout
        </a>
    </div>
</nav>

<div class="px-5 py-5 lg:pt-0 pt-8 max-w-6xl mx-auto">
    <!-- Mobile header -->
    <div class="lg:hidden text-center mb-5">
        <h1 class="text-2xl font-black tracking-tight bg-gradient-to-r from-primary to-orange-400 bg-clip-text text-transparent" id="gym-name-owner">My Gym</h1>
        <p class="text-xs text-gray-500 uppercase tracking-widest mt-1">{{ 'Settings' if mode == 'settings' else ('Automation' if mode == 'automation' else ('CRM' if mode == 'crm' else 'Dashboard')) }}</p>
    </div>
    <!-- Desktop header -->
    <h2 class="hidden lg:block text-2xl font-bold text-left mb-6">{{ 'Settings' if mode == 'settings' else ('Automation' if mode == 'automation' else ('CRM' if mode == 'crm' else 'Dashboard')) }}</h2>

    {% if mode == 'settings' %}
    <!-- ==================== SETTINGS MODE ==================== -->

    <!-- Gym Code Card - Prominent -->
    {% call card(classes="p-5 mb-5") %}
    <div class="text-center">
        <p class="text-xs text-gray-400 uppercase tracking-wider mb-2">Your Gym Code</p>
        <p class="text-4xl font-mono font-black text-primary tracking-widest mb-2" id="gym-code-display">------</p>
        <p class="text-sm text-gray-500 mb-4">Share this code with trainers and clients</p>
        <button onclick="copyGymCode()" id="copy-gym-code-btn"
            class="bg-primary hover:bg-primary/80 text-white px-6 py-3 rounded-xl transition flex items-center gap-2 mx-auto font-bold">
            <span id="copy-icon">üìã</span>
            <span id="copy-text">Copy Code</span>
        </button>
    </div>
    {% endcall %}

    <!-- Account Info -->
    {% call card(classes="p-4 mb-5") %}
    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Account</h3>
    <div class="space-y-3">
        <div class="flex justify-between items-center">
            <span class="text-gray-400">Role</span>
            <span class="text-white font-semibold">Gym Owner</span>
        </div>
        <div class="flex justify-between items-center">
            <span class="text-gray-400">Status</span>
            <span class="text-green-400 font-semibold">Active</span>
        </div>
    </div>
    {% endcall %}

    <!-- Stripe Connect - Payment Setup -->
    {% call card(classes="p-4 mb-5") %}
    <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Payment Setup</h3>
        <span id="stripe-status-badge" class="text-xs px-2 py-1 rounded-full bg-yellow-500/20 text-yellow-400">
            Checking...
        </span>
    </div>
    <div id="stripe-connect-content">
        <!-- Not Connected State -->
        <div id="stripe-not-connected" class="hidden">
            <p class="text-sm text-gray-400 mb-4">
                Connect your Stripe account to receive payments directly.
            </p>
            <button onclick="startStripeConnect()"
                class="w-full bg-[#635BFF] hover:bg-[#5851DB] text-white py-3 rounded-xl font-bold transition flex items-center justify-center gap-2">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M13.976 9.15c-2.172-.806-3.356-1.426-3.356-2.409 0-.831.683-1.305 1.901-1.305 2.227 0 4.515.858 6.09 1.631l.89-5.494C18.252.975 15.697 0 12.165 0 9.667 0 7.589.654 6.104 1.872 4.56 3.147 3.757 4.992 3.757 7.218c0 4.039 2.467 5.76 6.476 7.219 2.585.92 3.445 1.574 3.445 2.583 0 .98-.84 1.545-2.354 1.545-1.875 0-4.965-.921-6.99-2.109l-.9 5.555C5.175 22.99 8.385 24 11.714 24c2.641 0 4.843-.624 6.328-1.813 1.664-1.305 2.525-3.236 2.525-5.732 0-4.128-2.524-5.851-6.591-7.305z"/>
                </svg>
                Connect with Stripe
            </button>
        </div>

        <!-- Pending State -->
        <div id="stripe-pending" class="hidden">
            <p class="text-sm text-yellow-400 mb-3">
                ‚è≥ Setup incomplete. Complete the onboarding.
            </p>
            <button onclick="startStripeConnect()"
                class="w-full bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-400 py-3 rounded-xl font-bold transition">
                Continue Setup ‚Üí
            </button>
        </div>

        <!-- Connected State -->
        <div id="stripe-connected" class="hidden">
            <div class="flex items-center gap-3 mb-3">
                <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center">
                    <span class="text-green-400 text-xl">‚úì</span>
                </div>
                <div>
                    <p class="text-sm font-semibold text-green-400">Payments Enabled</p>
                    <p class="text-xs text-gray-400">Subscriptions paid to your account</p>
                </div>
            </div>
            <button onclick="openStripeDashboard()"
                class="w-full bg-white/10 hover:bg-white/20 text-white py-3 rounded-xl font-semibold transition flex items-center justify-center gap-2">
                <span>üí∞</span> View Dashboard
            </button>
        </div>
    </div>
    {% endcall %}

    <!-- Logout Button -->
    <a href="/auth/logout" class="block w-full bg-red-500/20 hover:bg-red-500/30 text-red-400 text-center py-3 rounded-xl font-bold transition">
        Logout
    </a>

    {% elif mode == 'automation' %}
    <!-- ==================== AUTOMATION MODE ==================== -->

    <!-- Info Card -->
    {% call card(classes="p-4 mb-5") %}
    <div class="flex items-center gap-3 mb-3">
        <div class="w-10 h-10 rounded-xl bg-blue-500/20 flex items-center justify-center">
            <span class="text-xl">üì¨</span>
        </div>
        <div>
            <h3 class="font-bold">Automated Messages</h3>
            <p class="text-xs text-gray-400">Automatically reach out to inactive clients</p>
        </div>
    </div>
    <p class="text-sm text-gray-400">
        Create message templates that are automatically sent when clients miss workouts, become inactive, or skip appointments.
    </p>
    {% endcall %}

    <!-- Templates List -->
    <div class="mb-5">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-bold text-white uppercase tracking-wider">Message Templates</h3>
            <button onclick="openCreateTemplateModal()" class="text-xs bg-primary px-3 py-2 rounded-lg hover:bg-primary/80 transition font-semibold">
                + Create Template
            </button>
        </div>
        <div id="templates-list" class="space-y-3">
            <div class="glass-card p-3 text-center text-gray-400 text-sm">
                Loading templates...
            </div>
        </div>
    </div>

    <!-- Recent Activity Log -->
    <div class="mb-5">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-bold text-white uppercase tracking-wider">Recent Activity</h3>
            <button onclick="manualTriggerCheck()" class="text-xs bg-white/10 px-3 py-2 rounded-lg hover:bg-white/20 transition font-semibold">
                Run Check Now
            </button>
        </div>
        <div id="message-log" class="space-y-2 max-h-64 overflow-y-auto">
            <div class="glass-card p-3 text-center text-gray-400 text-sm">
                Loading activity...
            </div>
        </div>
    </div>

    {% elif mode == 'crm' %}
    <!-- ==================== CRM MODE ==================== -->

    <!-- Retention Analytics Summary -->
    {% call card(classes="p-5 mb-5 relative overflow-hidden") %}
    <div class="absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent"></div>
    <div class="relative z-10">
        <div class="flex items-center justify-between mb-4">
            <div>
                <p class="text-xs text-gray-400 uppercase tracking-wider">Retention Overview</p>
                <h2 class="text-2xl font-bold mt-1">Client Health</h2>
            </div>
            <select id="analytics-period" onchange="loadRetentionAnalytics()"
                class="bg-black/20 border border-white/10 rounded-lg px-3 py-1.5 text-sm text-white outline-none">
                <option value="week">Last 7 days</option>
                <option value="month" selected>Last 30 days</option>
            </select>
        </div>
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="text-center p-3 bg-white/5 rounded-xl">
                <p class="text-3xl font-bold text-green-400" id="engagement-rate">--%</p>
                <p class="text-xs text-gray-400 mt-1">Engagement Rate</p>
            </div>
            <div class="text-center p-3 bg-white/5 rounded-xl">
                <p class="text-3xl font-bold text-yellow-400" id="at-risk-count">--</p>
                <p class="text-xs text-gray-400 mt-1">At Risk</p>
            </div>
            <div class="text-center p-3 bg-white/5 rounded-xl">
                <p class="text-3xl font-bold text-red-400" id="churn-rate">--%</p>
                <p class="text-xs text-gray-400 mt-1">Churn Rate</p>
            </div>
            <div class="text-center p-3 bg-white/5 rounded-xl">
                <p class="text-3xl font-bold text-blue-400" id="avg-health">--</p>
                <p class="text-xs text-gray-400 mt-1">Avg Health Score</p>
            </div>
        </div>
    </div>
    {% endcall %}

    <!-- Client Pipeline / Funnel -->
    <div class="mb-5">
        <h3 class="text-sm font-bold text-white uppercase tracking-wider mb-3">Client Pipeline</h3>
        <div class="grid grid-cols-4 gap-3">
            <div class="glass-card p-4 text-center border-t-4 border-green-400">
                <p class="text-2xl font-bold text-green-400" id="pipeline-new">--</p>
                <p class="text-xs text-gray-400 mt-1">New</p>
                <p class="text-[10px] text-gray-500">&lt; 14 days</p>
            </div>
            <div class="glass-card p-4 text-center border-t-4 border-blue-400">
                <p class="text-2xl font-bold text-blue-400" id="pipeline-active">--</p>
                <p class="text-xs text-gray-400 mt-1">Active</p>
                <p class="text-[10px] text-gray-500">Engaged</p>
            </div>
            <div class="glass-card p-4 text-center border-t-4 border-yellow-400">
                <p class="text-2xl font-bold text-yellow-400" id="pipeline-at-risk">--</p>
                <p class="text-xs text-gray-400 mt-1">At Risk</p>
                <p class="text-[10px] text-gray-500">5-14 days</p>
            </div>
            <div class="glass-card p-4 text-center border-t-4 border-red-400">
                <p class="text-2xl font-bold text-red-400" id="pipeline-churning">--</p>
                <p class="text-xs text-gray-400 mt-1">Churning</p>
                <p class="text-[10px] text-gray-500">&gt; 14 days</p>
            </div>
        </div>
    </div>

    <!-- At-Risk Clients List -->
    <div class="mb-5">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-bold text-white uppercase tracking-wider">At-Risk Clients</h3>
            <span class="text-xs text-yellow-400">‚ö†Ô∏è Needs attention</span>
        </div>
        <div id="at-risk-list" class="space-y-2 max-h-96 overflow-y-auto">
            <div class="glass-card p-3 text-center text-gray-400 text-sm">
                Loading...
            </div>
        </div>
    </div>

    <!-- Recent Interactions -->
    <div class="mb-5">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-bold text-white uppercase tracking-wider">Recent Activity</h3>
            <button onclick="loadInteractions()" class="text-xs bg-white/10 px-3 py-1.5 rounded-lg hover:bg-white/20 transition font-semibold">
                ‚Üª Refresh
            </button>
        </div>
        <div id="interactions-list" class="space-y-2 max-h-64 overflow-y-auto">
            <div class="glass-card p-3 text-center text-gray-400 text-sm">
                Loading activity...
            </div>
        </div>
    </div>

    {% else %}
    <!-- ==================== DASHBOARD MODE (default) ==================== -->

    <!-- Pending Staff Approvals - Only show if there are pending -->
    <div id="pending-trainers-section" class="mb-5 hidden">
        <h3 class="text-sm font-bold text-white uppercase tracking-wider mb-3">Pending Staff Approvals</h3>
        <div id="pending-trainers-list" class="space-y-3">
            <!-- Pending trainers will be loaded here -->
        </div>
    </div>

    <!-- Desktop Grid Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-5 mb-5">
        <!-- Revenue Card - Spans full width on mobile, 1 col on desktop -->
        <div class="lg:col-span-1">
            {% call card(classes="p-5 h-full relative overflow-hidden") %}
            <div class="absolute inset-0 bg-gradient-to-br from-green-500/10 to-transparent"></div>
            <div class="relative z-10">
                <p class="text-xs text-gray-400 uppercase tracking-wider mb-1">Monthly Revenue</p>
                <h1 class="text-4xl font-black text-green-400 mb-4" id="revenue-display">$0</h1>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Subscriptions</span>
                        <span class="font-bold" id="active-subscriptions">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Active Clients</span>
                        <span class="font-bold" id="active-members">...</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Staff</span>
                        <span class="font-bold" id="staff-active">...</span>
                    </div>
                </div>
            </div>
            {% endcall %}
        </div>

        <!-- Subscription Plans - 1 col -->
        <div class="lg:col-span-1">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-sm font-bold text-white uppercase tracking-wider">Plans</h3>
                <button onclick="openCreatePlanModal()" class="text-xs bg-primary px-3 py-1.5 rounded-lg hover:bg-primary/80 transition font-semibold">
                    + New
                </button>
            </div>
            <div id="subscription-plans-list" class="space-y-2 max-h-64 overflow-y-auto">
                <div class="glass-card p-3 text-center text-gray-400 text-sm">
                    No plans yet
                </div>
            </div>
        </div>

        <!-- Team Overview - 1 col -->
        <div class="lg:col-span-1">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-sm font-bold text-white uppercase tracking-wider">Team</h3>
                <button onclick="openTrainersModal()" class="text-xs text-primary hover:text-primary/80 transition font-semibold">
                    View All ‚Üí
                </button>
            </div>
            <div id="dashboard-trainers-list" class="space-y-2 max-h-64 overflow-y-auto">
                <div class="glass-card p-3 text-center text-gray-400 text-sm">
                    Loading team...
                </div>
            </div>
        </div>
    </div>

    <!-- Promotional Offers Section - Full width with grid for offers -->
    <div class="mb-5">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-bold text-white uppercase tracking-wider">üéÅ Promotional Offers</h3>
            <button onclick="openCreateOfferModal()" class="text-xs bg-green-500 px-3 py-1.5 rounded-lg hover:bg-green-500/80 transition font-semibold">
                + Create Offer
            </button>
        </div>
        <div id="offers-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            <div class="glass-card p-3 text-center text-gray-400 text-sm">
                No offers yet. Create offers to attract clients!
            </div>
        </div>
    </div>

    <!-- Live Feed Section -->
    <div>
        <h3 class="text-sm font-bold text-white uppercase tracking-wider mb-3">Live Feed</h3>
        <div id="activity-feed" class="glass-card divide-y divide-white/5 max-h-64 overflow-y-auto"></div>
    </div>
    {% endif %}
</div>

<!-- Create/Edit Plan Modal -->
<div id="plan-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full">
        <h3 class="text-xl font-bold mb-4" id="plan-modal-title">Create Subscription Plan</h3>

        <form id="plan-form" class="space-y-4">
            <input type="hidden" id="plan-id">

            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Plan Name</label>
                <input type="text" id="plan-name" required
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-primary/50 transition"
                    placeholder="e.g., Basic, Premium, VIP">
            </div>

            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Description</label>
                <textarea id="plan-description" rows="2"
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-primary/50 transition"
                    placeholder="Brief description of this plan"></textarea>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Price ($)</label>
                    <input type="number" id="plan-price" required step="0.01" min="0"
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-primary/50 transition"
                        placeholder="29.99">
                </div>
                <div>
                    <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Billing</label>
                    <select id="plan-interval"
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-primary/50 transition">
                        <option value="month">Monthly</option>
                        <option value="year">Yearly</option>
                    </select>
                </div>
            </div>

            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Free Trial (days)</label>
                <input type="number" id="plan-trial" min="0" value="0"
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-primary/50 transition"
                    placeholder="0">
            </div>

            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Features (one per line)</label>
                <textarea id="plan-features" rows="3"
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-primary/50 transition"
                    placeholder="Unlimited workouts&#10;Meal plans&#10;1-on-1 coaching"></textarea>
            </div>

            <div class="flex space-x-3 pt-2">
                <button type="button" onclick="closePlanModal()"
                    class="flex-1 bg-white/10 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-white/20 transition">
                    Cancel
                </button>
                <button type="submit"
                    class="flex-1 bg-primary px-4 py-2 rounded-lg text-sm font-semibold hover:bg-primary/80 transition">
                    <span id="plan-submit-btn">Create Plan</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Create/Edit Offer Modal -->
<div id="offer-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
        <h3 class="text-xl font-bold mb-4" id="offer-modal-title">Create Promotional Offer</h3>

        <form id="offer-form" class="space-y-4">
            <input type="hidden" id="offer-id">

            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Offer Title</label>
                <div class="relative">
                    <input type="text" id="offer-title" required
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 pr-10 text-sm text-white outline-none focus:border-green-500/50 transition"
                        placeholder="e.g., New Year Special, Summer Sale">
                    <button type="button" onclick="toggleEmojiPicker('offer-title')"
                        class="absolute right-2 top-1/2 -translate-y-1/2 text-lg hover:scale-110 transition" title="Add emoji">
                        üòÄ
                    </button>
                </div>
            </div>

            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Description</label>
                <div class="relative">
                    <textarea id="offer-description" rows="2"
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 pr-10 text-sm text-white outline-none focus:border-green-500/50 transition"
                        placeholder="Describe the offer to attract clients"></textarea>
                    <button type="button" onclick="toggleEmojiPicker('offer-description')"
                        class="absolute right-2 top-2 text-lg hover:scale-110 transition" title="Add emoji">
                        üòÄ
                    </button>
                </div>
            </div>

            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Apply to Plan (optional)</label>
                <select id="offer-plan-id"
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-green-500/50 transition">
                    <option value="">All Plans</option>
                    <!-- Plans will be loaded dynamically -->
                </select>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Discount Type</label>
                    <select id="offer-discount-type" required
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-green-500/50 transition">
                        <option value="percent">Percentage (%)</option>
                        <option value="fixed">Fixed Amount (‚Ç¨)</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Discount Value</label>
                    <input type="number" id="offer-discount-value" required step="0.01" min="0"
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-green-500/50 transition"
                        placeholder="e.g., 20">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Duration (months)</label>
                    <input type="number" id="offer-duration" min="1" value="1"
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-green-500/50 transition"
                        placeholder="1">
                </div>
                <div>
                    <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Coupon Code (optional)</label>
                    <input type="text" id="offer-coupon"
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-green-500/50 transition uppercase"
                        placeholder="e.g., SUMMER50">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Expires On (optional)</label>
                    <input type="date" id="offer-expires"
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-green-500/50 transition">
                </div>
                <div>
                    <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Max Uses (optional)</label>
                    <input type="number" id="offer-max-uses" min="1"
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-green-500/50 transition"
                        placeholder="Unlimited">
                </div>
            </div>

            <div class="flex gap-2 mt-6">
                <button type="button" onclick="closeOfferModal()"
                    class="flex-1 bg-white/10 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-white/20 transition">
                    Cancel
                </button>
                <button type="submit"
                    class="flex-1 bg-green-500 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-green-500/80 transition">
                    <span id="offer-submit-btn">Create Offer</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Trainers Modal -->
<div id="trainers-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="glass-card rounded-2xl max-w-lg w-full max-h-[80vh] flex flex-col">
        <!-- Header -->
        <div class="p-5 border-b border-white/10 flex justify-between items-center">
            <h3 class="text-xl font-bold">Team Management</h3>
            <button onclick="closeTrainersModal()" class="w-8 h-8 rounded-lg bg-white/10 hover:bg-white/20 transition flex items-center justify-center">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Content -->
        <div class="p-5 overflow-y-auto flex-1">
            <!-- Pending Approvals Section -->
            <div id="modal-pending-section" class="mb-5 hidden">
                <h4 class="text-sm font-bold text-yellow-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></span>
                    Pending Approvals
                </h4>
                <div id="modal-pending-trainers" class="space-y-2">
                    <!-- Pending trainers loaded here -->
                </div>
            </div>

            <!-- Active Trainers Section -->
            <div>
                <h4 class="text-sm font-bold text-white uppercase tracking-wider mb-3">Active Trainers</h4>
                <div id="modal-approved-trainers" class="space-y-2">
                    <div class="p-3 text-center text-gray-400 text-sm">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Footer with gym code -->
        <div class="p-4 border-t border-white/10 bg-white/5">
            <p class="text-xs text-gray-400 text-center">Share your gym code to invite trainers</p>
            <div class="flex items-center justify-center gap-2 mt-2">
                <code class="bg-black/30 px-3 py-1.5 rounded-lg text-primary font-mono text-sm" id="modal-gym-code">{{ gym_id[:8] if gym_id else '...' }}</code>
                <button onclick="copyGymCode()" class="text-xs bg-primary/20 text-primary px-3 py-1.5 rounded-lg hover:bg-primary/30 transition">
                    Copy
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Emoji Picker Popup -->
<div id="emoji-picker" class="fixed z-[60] hidden bg-[#1a1a1a] border border-white/20 rounded-xl shadow-2xl p-3 w-72">
    <div class="text-xs text-gray-400 uppercase tracking-wider mb-2">Popular</div>
    <div class="grid grid-cols-8 gap-1 mb-3" id="emoji-popular">
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üéâ</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üéÅ</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">‚≠ê</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üî•</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üí™</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üèÜ</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üí∞</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">‚ú®</button>
    </div>
    <div class="text-xs text-gray-400 uppercase tracking-wider mb-2">Fitness</div>
    <div class="grid grid-cols-8 gap-1 mb-3">
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üèãÔ∏è</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üèÉ</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üö¥</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üßò</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üíØ</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">ü•á</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üéØ</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">‚ù§Ô∏è</button>
    </div>
    <div class="text-xs text-gray-400 uppercase tracking-wider mb-2">Seasonal</div>
    <div class="grid grid-cols-8 gap-1 mb-3">
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üéÑ</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üéÜ</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">‚òÄÔ∏è</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üå∏</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üçÇ</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">‚ùÑÔ∏è</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üéÉ</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üíù</button>
    </div>
    <div class="text-xs text-gray-400 uppercase tracking-wider mb-2">Other</div>
    <div class="grid grid-cols-8 gap-1">
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üëç</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üöÄ</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üíé</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üåü</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">‚ö°</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üéä</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üì¢</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üÜì</button>
    </div>
</div>

<!-- Create/Edit Template Modal -->
<div id="template-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
        <h3 class="text-xl font-bold mb-4" id="template-modal-title">Create Automated Message</h3>

        <form id="template-form" class="space-y-4" onsubmit="saveTemplate(event)">
            <input type="hidden" id="template-id">

            <!-- Template Name -->
            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Template Name</label>
                <input type="text" id="template-name" required
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-primary/50 transition"
                    placeholder="e.g., Inactive Client Reminder">
            </div>

            <!-- Trigger Type -->
            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Trigger</label>
                <select id="template-trigger" required onchange="updateTriggerConfig()"
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-primary/50 transition">
                    <option value="missed_workout">Missed Workout (scheduled but not completed)</option>
                    <option value="days_inactive">Days Inactive (no workouts in X days)</option>
                    <option value="no_show_appointment">No-Show Appointment</option>
                </select>
            </div>

            <!-- Trigger Config (dynamic) -->
            <div id="trigger-config-section" class="hidden">
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Days Threshold</label>
                <input type="number" id="trigger-days-threshold" min="1" value="5"
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-primary/50 transition"
                    placeholder="5">
                <p class="text-xs text-gray-500 mt-1">Send message when client hasn't worked out for this many days</p>
            </div>

            <!-- Delivery Methods -->
            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Delivery Methods</label>
                <div class="space-y-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="delivery-in-app" checked class="rounded bg-black/20 border-white/20 text-primary focus:ring-primary/50">
                        <span class="text-sm">In-App Notification</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer opacity-50">
                        <input type="checkbox" id="delivery-email" disabled class="rounded bg-black/20 border-white/20">
                        <span class="text-sm">Email (Coming Soon)</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer opacity-50">
                        <input type="checkbox" id="delivery-whatsapp" disabled class="rounded bg-black/20 border-white/20">
                        <span class="text-sm">WhatsApp (Coming Soon)</span>
                    </label>
                </div>
            </div>

            <!-- Message Template -->
            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Message</label>
                <textarea id="template-message" rows="4" required
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-primary/50 transition"
                    placeholder="Hey {client_name}, we noticed you missed your workout..."></textarea>
                <p class="text-xs text-gray-500 mt-1">
                    Variables: <span class="text-primary">{client_name}</span>, <span class="text-primary">{days_inactive}</span>, <span class="text-primary">{workout_title}</span>, <span class="text-primary">{trainer_name}</span>
                </p>
            </div>

            <!-- Preview Button -->
            <button type="button" onclick="previewTemplate()"
                class="w-full bg-white/10 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-white/20 transition">
                Preview Message
            </button>

            <!-- Preview Output -->
            <div id="template-preview" class="hidden bg-black/30 rounded-lg p-3 border border-white/10">
                <p class="text-xs text-gray-400 uppercase mb-2">Preview</p>
                <p id="preview-output" class="text-sm text-white"></p>
            </div>

            <!-- Enable Toggle -->
            <div class="flex items-center justify-between pt-2">
                <span class="text-sm">Enable this template</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="template-enabled" checked class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-700 peer-focus:ring-2 peer-focus:ring-primary/50 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                </label>
            </div>

            <!-- Submit Buttons -->
            <div class="flex space-x-3 pt-2">
                <button type="button" onclick="closeTemplateModal()"
                    class="flex-1 bg-white/10 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-white/20 transition">
                    Cancel
                </button>
                <button type="submit"
                    class="flex-1 bg-primary px-4 py-2 rounded-lg text-sm font-semibold hover:bg-primary/80 transition">
                    <span id="template-submit-btn">Create Template</span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Current mode from server
const currentMode = "{{ mode }}";

// --- EMOJI PICKER ---
let currentEmojiTarget = null;

function toggleEmojiPicker(targetId) {
    const picker = document.getElementById('emoji-picker');
    const targetEl = document.getElementById(targetId);

    if (!picker || !targetEl) return;

    // If already open for same target, close it
    if (!picker.classList.contains('hidden') && currentEmojiTarget === targetId) {
        picker.classList.add('hidden');
        currentEmojiTarget = null;
        return;
    }

    currentEmojiTarget = targetId;

    // Position the picker near the input
    const rect = targetEl.getBoundingClientRect();
    picker.style.top = `${rect.bottom + 8}px`;
    picker.style.left = `${Math.min(rect.left, window.innerWidth - 300)}px`;

    picker.classList.remove('hidden');
}

// Handle emoji button clicks
document.addEventListener('click', (e) => {
    const picker = document.getElementById('emoji-picker');

    // If clicked on emoji button
    if (e.target.classList.contains('emoji-btn')) {
        const emoji = e.target.textContent;
        if (currentEmojiTarget) {
            const targetEl = document.getElementById(currentEmojiTarget);
            if (targetEl) {
                // Insert emoji at cursor position or append
                const start = targetEl.selectionStart || targetEl.value.length;
                const end = targetEl.selectionEnd || targetEl.value.length;
                const text = targetEl.value;
                targetEl.value = text.substring(0, start) + emoji + text.substring(end);
                targetEl.focus();
                // Move cursor after emoji
                targetEl.selectionStart = targetEl.selectionEnd = start + emoji.length;
            }
        }
        picker.classList.add('hidden');
        currentEmojiTarget = null;
        return;
    }

    // Close picker if clicked outside
    if (picker && !picker.classList.contains('hidden')) {
        if (!picker.contains(e.target) && !e.target.closest('[onclick*="toggleEmojiPicker"]')) {
            picker.classList.add('hidden');
            currentEmojiTarget = null;
        }
    }
});

// Subscription Plan Management
let currentPlanId = null;

// Load subscription plans
async function loadSubscriptionPlans() {
    console.log('loadSubscriptionPlans called');
    try {
        const response = await fetch('/api/owner/subscription-plans?include_inactive=true', {
            credentials: 'include'
        });

        console.log('Plans response status:', response.status);
        if (!response.ok) throw new Error('Failed to load plans');

        const plans = await response.json();
        console.log('Plans loaded:', plans);
        displayPlans(plans);
        updateRevenue(plans);
    } catch (error) {
        console.error('Error loading plans:', error);
    }
}

// Display plans in the UI - compact style for dashboard
function displayPlans(plans) {
    const container = document.getElementById('subscription-plans-list');
    if (!container) return;

    if (!plans || plans.length === 0) {
        container.innerHTML = `
            <div class="glass-card p-3 text-center text-gray-400 text-sm">
                No plans yet
            </div>
        `;
        return;
    }

    container.innerHTML = plans.map(plan => `
        <div class="glass-card p-3 rounded-xl ${plan.is_active ? '' : 'opacity-50'} hover:bg-white/5 transition">
            <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2">
                        <h4 class="font-bold text-sm truncate">${escapeHtml(plan.name)}</h4>
                        ${!plan.is_active ? '<span class="text-[10px] bg-red-500/20 text-red-400 px-1.5 py-0.5 rounded">Off</span>' : ''}
                    </div>
                    <p class="text-xs text-gray-400 mt-0.5">$${plan.price}/${plan.billing_interval === 'year' ? 'yr' : 'mo'} ¬∑ ${plan.active_subscriptions || 0} subs</p>
                </div>
                <div class="flex gap-1 flex-shrink-0">
                    <button onclick="editPlan('${plan.id}')" class="p-1.5 rounded hover:bg-white/10 transition text-gray-400 hover:text-white">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                        </svg>
                    </button>
                    <button onclick="deletePlan('${plan.id}', '${escapeHtml(plan.name)}')" class="p-1.5 rounded hover:bg-red-500/20 transition text-gray-400 hover:text-red-400">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

// Update revenue display
function updateRevenue(plans) {
    const revenueEl = document.getElementById('revenue-display');
    const subsEl = document.getElementById('active-subscriptions');
    if (!revenueEl || !subsEl) return;

    const totalMRR = plans.reduce((sum, plan) => sum + (plan.monthly_revenue || 0), 0);
    const totalSubs = plans.reduce((sum, plan) => sum + (plan.active_subscriptions || 0), 0);

    revenueEl.textContent = `$${totalMRR.toFixed(0)}`;
    subsEl.textContent = totalSubs;
}

// Modal functions
function openCreatePlanModal() {
    currentPlanId = null;
    document.getElementById('plan-modal-title').textContent = 'Create Subscription Plan';
    document.getElementById('plan-submit-btn').textContent = 'Create Plan';
    document.getElementById('plan-form').reset();
    document.getElementById('plan-id').value = '';
    document.getElementById('plan-modal').classList.remove('hidden');
}

function closePlanModal() {
    document.getElementById('plan-modal').classList.add('hidden');
    currentPlanId = null;
}

async function editPlan(planId) {
    try {
        const response = await fetch('/api/owner/subscription-plans', {
            credentials: 'include'
        });
        const plans = await response.json();
        const plan = plans.find(p => p.id === planId);

        if (!plan) throw new Error('Plan not found');

        currentPlanId = planId;
        document.getElementById('plan-id').value = planId;
        document.getElementById('plan-modal-title').textContent = 'Edit Subscription Plan';
        document.getElementById('plan-submit-btn').textContent = 'Update Plan';
        document.getElementById('plan-name').value = plan.name;
        document.getElementById('plan-description').value = plan.description || '';
        document.getElementById('plan-price').value = plan.price;
        document.getElementById('plan-interval').value = plan.billing_interval;
        document.getElementById('plan-trial').value = plan.trial_period_days || 0;
        document.getElementById('plan-features').value = plan.features ? plan.features.join('\n') : '';
        document.getElementById('plan-modal').classList.remove('hidden');
    } catch (error) {
        console.error('Error loading plan:', error);
        showToast('Failed to load plan details', 'error');
    }
}

async function deletePlan(planId, planName) {
    if (!confirm(`Are you sure you want to delete the "${planName}" plan? This action cannot be undone.`)) {
        return;
    }

    try {
        const response = await fetch(`/api/owner/subscription-plans/${planId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to delete plan');
        }

        showToast('Plan deleted successfully', 'success');
        loadSubscriptionPlans();
    } catch (error) {
        console.error('Error deleting plan:', error);
        showToast(error.message, 'error');
    }
}

// Handle form submission
const planForm = document.getElementById('plan-form');
if (planForm) {
    planForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const features = document.getElementById('plan-features').value
            .split('\n')
            .map(f => f.trim())
            .filter(f => f.length > 0);

        const planData = {
            name: document.getElementById('plan-name').value,
            description: document.getElementById('plan-description').value,
            price: parseFloat(document.getElementById('plan-price').value),
            features: features,
            trial_period_days: parseInt(document.getElementById('plan-trial').value) || 0,
            billing_interval: document.getElementById('plan-interval').value
        };

        try {
            const url = currentPlanId
                ? `/api/owner/subscription-plans/${currentPlanId}`
                : '/api/owner/subscription-plans';

            const method = currentPlanId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(planData)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to save plan');
            }

            showToast(currentPlanId ? 'Plan updated successfully' : 'Plan created successfully', 'success');
            closePlanModal();
            loadSubscriptionPlans();
        } catch (error) {
            console.error('Error saving plan:', error);
            showToast(error.message, 'error');
        }
    });
}

// Close modal on background click
const planModal = document.getElementById('plan-modal');
if (planModal) {
    planModal.addEventListener('click', (e) => {
        if (e.target.id === 'plan-modal') {
            closePlanModal();
        }
    });
}

// --- PROMOTIONAL OFFERS FUNCTIONS ---

let currentOfferId = null;
let availablePlansForOffer = [];

async function loadOffers() {
    try {
        const response = await fetch('/api/owner/offers', {
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Failed to load offers');

        const offers = await response.json();
        displayOffers(offers);
    } catch (error) {
        console.error('Error loading offers:', error);
    }
}

function displayOffers(offers) {
    const container = document.getElementById('offers-list');
    if (!container) return;

    if (!offers || offers.length === 0) {
        container.innerHTML = `
            <div class="glass-card p-3 text-center text-gray-400 text-sm">
                No offers yet. Create offers to attract clients!
            </div>
        `;
        return;
    }

    container.innerHTML = offers.map(offer => {
        const discountText = offer.discount_type === 'percent'
            ? `${offer.discount_value}%`
            : `‚Ç¨${offer.discount_value}`;
        const statusColor = offer.is_active ? 'green' : 'yellow';
        const statusText = offer.is_active ? 'Active' : 'Draft';
        const expiryDate = offer.expires_at ? new Date(offer.expires_at).toLocaleDateString() : null;

        return `
            <div class="glass-card overflow-hidden ${!offer.is_active ? 'border border-yellow-500/20' : ''}">
                <div class="p-4">
                    <div class="flex gap-4">
                        <!-- Discount badge -->
                        <div class="flex-shrink-0 w-16 h-16 rounded-xl bg-gradient-to-br from-green-500/20 to-emerald-500/10 border border-green-500/20 flex flex-col items-center justify-center">
                            <span class="text-xl font-bold text-green-400">${discountText}</span>
                            <span class="text-[10px] uppercase tracking-wider text-green-400/70">off</span>
                        </div>

                        <!-- Title and info -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <h4 class="font-bold text-white leading-tight truncate">${offer.title}</h4>
                                <span class="text-[10px] px-1.5 py-0.5 rounded-full bg-${statusColor}-500/20 text-${statusColor}-400">${statusText}</span>
                            </div>
                            ${offer.description ? `<p class="text-xs text-gray-400 line-clamp-1 mb-1">${offer.description}</p>` : ''}
                            <div class="flex items-center gap-3 text-xs text-gray-500">
                                <span>${offer.discount_duration_months} month${offer.discount_duration_months > 1 ? 's' : ''}</span>
                                ${expiryDate ? `<span>¬∑ Until ${expiryDate}</span>` : ''}
                                ${offer.coupon_code ? `<span class="text-primary font-mono">${offer.coupon_code}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="px-4 py-3 bg-white/[0.02] border-t border-white/5 flex items-center justify-between">
                    ${!offer.is_active ? `
                        <span class="text-[10px] text-yellow-400/70">üì¢ Activating will notify all clients</span>
                    ` : `
                        <span></span>
                    `}
                    <div class="flex items-center gap-2">
                        ${offer.is_active ? `
                            <button onclick="toggleOffer('${offer.id}', false)" class="p-2 rounded-lg hover:bg-yellow-500/10 text-yellow-400 hover:text-yellow-300 transition" title="Pause">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </button>
                        ` : `
                            <button onclick="toggleOffer('${offer.id}', true)" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-green-500/20 hover:bg-green-500/30 text-green-400 text-xs font-semibold transition" title="Activate & Notify Clients">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                                </svg>
                                Activate
                            </button>
                        `}
                        <button onclick="deleteOffer('${offer.id}', '${offer.title.replace(/'/g, "\\'")}')" class="p-2 rounded-lg hover:bg-red-500/10 text-red-400 hover:text-red-300 transition" title="Delete">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

async function openCreateOfferModal() {
    currentOfferId = null;
    document.getElementById('offer-id').value = '';
    document.getElementById('offer-modal-title').textContent = 'Create Promotional Offer';
    document.getElementById('offer-submit-btn').textContent = 'Create Offer';

    // Reset form
    document.getElementById('offer-form').reset();

    // Load plans for dropdown
    await loadPlansForOfferDropdown();

    document.getElementById('offer-modal').classList.remove('hidden');
}

async function loadPlansForOfferDropdown() {
    const select = document.getElementById('offer-plan-id');
    if (!select) return;

    try {
        const response = await fetch('/api/owner/subscription-plans', {
            credentials: 'include'
        });

        if (response.ok) {
            availablePlansForOffer = await response.json();
            select.innerHTML = '<option value="">All Plans</option>' +
                availablePlansForOffer.map(p => `<option value="${p.id}">${p.name} - ‚Ç¨${p.price}/${p.billing_interval}</option>`).join('');
        }
    } catch (e) {
        console.error('Error loading plans for offer:', e);
    }
}

function closeOfferModal() {
    document.getElementById('offer-modal').classList.add('hidden');
    currentOfferId = null;
}

async function toggleOffer(offerId, isActive) {
    // Confirm activation (since it notifies all clients)
    if (isActive) {
        if (!confirm('Activate this offer?\n\nAll gym clients will receive a notification about this offer.')) {
            return;
        }
    }

    try {
        const response = await fetch(`/api/owner/offers/${offerId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ is_active: isActive })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to update offer');
        }

        const result = await response.json();
        if (isActive && result.notifications_sent) {
            showToast('Offer activated! Clients have been notified üéâ', 'success');
        } else {
            showToast(isActive ? 'Offer activated' : 'Offer paused', 'success');
        }
        loadOffers();
    } catch (error) {
        console.error('Error toggling offer:', error);
        showToast(error.message, 'error');
    }
}

async function deleteOffer(offerId, offerTitle) {
    if (!confirm(`Are you sure you want to delete the "${offerTitle}" offer?`)) {
        return;
    }

    try {
        const response = await fetch(`/api/owner/offers/${offerId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to delete offer');
        }

        showToast('Offer deleted successfully', 'success');
        loadOffers();
    } catch (error) {
        console.error('Error deleting offer:', error);
        showToast(error.message, 'error');
    }
}

// Offer form submission
const offerForm = document.getElementById('offer-form');
if (offerForm) {
    offerForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const offerData = {
            title: document.getElementById('offer-title').value,
            description: document.getElementById('offer-description').value,
            plan_id: document.getElementById('offer-plan-id').value || null,
            discount_type: document.getElementById('offer-discount-type').value,
            discount_value: parseFloat(document.getElementById('offer-discount-value').value),
            discount_duration_months: parseInt(document.getElementById('offer-duration').value) || 1,
            coupon_code: document.getElementById('offer-coupon').value.toUpperCase() || null,
            expires_at: document.getElementById('offer-expires').value ? new Date(document.getElementById('offer-expires').value).toISOString() : null,
            max_redemptions: document.getElementById('offer-max-uses').value ? parseInt(document.getElementById('offer-max-uses').value) : null
        };

        try {
            const response = await fetch('/api/owner/offers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(offerData)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to create offer');
            }

            showToast('Offer created as draft. Activate to notify clients.', 'success');
            closeOfferModal();
            loadOffers();
        } catch (error) {
            console.error('Error creating offer:', error);
            showToast(error.message, 'error');
        }
    });
}

// Close offer modal on background click
const offerModal = document.getElementById('offer-modal');
if (offerModal) {
    offerModal.addEventListener('click', (e) => {
        if (e.target.id === 'offer-modal') {
            closeOfferModal();
        }
    });
}

// --- STRIPE CONNECT FUNCTIONS ---

async function loadStripeConnectStatus() {
    const badge = document.getElementById('stripe-status-badge');
    const notConnected = document.getElementById('stripe-not-connected');
    const pending = document.getElementById('stripe-pending');
    const connected = document.getElementById('stripe-connected');

    if (!badge) return; // Not on settings page

    try {
        const response = await fetch('/api/owner/stripe-connect/status', {
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Failed to check status');

        const data = await response.json();

        // Hide all states first
        notConnected?.classList.add('hidden');
        pending?.classList.add('hidden');
        connected?.classList.add('hidden');

        if (!data.connected) {
            // Not connected
            badge.textContent = 'Not Set Up';
            badge.className = 'text-xs px-2 py-1 rounded-full bg-red-500/20 text-red-400';
            notConnected?.classList.remove('hidden');
        } else if (data.can_receive_payments) {
            // Fully connected
            badge.textContent = 'Active';
            badge.className = 'text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-400';
            connected?.classList.remove('hidden');
        } else {
            // Pending verification
            badge.textContent = 'Pending';
            badge.className = 'text-xs px-2 py-1 rounded-full bg-yellow-500/20 text-yellow-400';
            pending?.classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error loading Stripe status:', error);
        badge.textContent = 'Error';
        badge.className = 'text-xs px-2 py-1 rounded-full bg-red-500/20 text-red-400';
        notConnected?.classList.remove('hidden');
    }
}

async function startStripeConnect() {
    try {
        const response = await fetch('/api/owner/stripe-connect/onboard', {
            method: 'POST',
            credentials: 'include'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to start onboarding');
        }

        const data = await response.json();

        if (data.onboarding_url) {
            // Redirect to Stripe onboarding
            window.location.href = data.onboarding_url;
        } else {
            alert('Failed to get onboarding link');
        }
    } catch (error) {
        console.error('Error starting Stripe Connect:', error);
        alert('Error: ' + error.message);
    }
}

async function openStripeDashboard() {
    try {
        const response = await fetch('/api/owner/stripe-connect/dashboard', {
            credentials: 'include'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to get dashboard link');
        }

        const data = await response.json();

        if (data.url) {
            window.open(data.url, '_blank');
        } else {
            alert('Failed to get dashboard link');
        }
    } catch (error) {
        console.error('Error opening Stripe dashboard:', error);
        alert('Error: ' + error.message);
    }
}

// --- GYM CODE FUNCTIONS ---

async function loadGymCode() {
    try {
        const response = await fetch('/api/owner/gym-code', {
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Failed to load gym code');

        const data = await response.json();
        const gymCodeEl = document.getElementById('gym-code-display');
        if (gymCodeEl) {
            gymCodeEl.textContent = data.gym_code || '------';
        }
    } catch (error) {
        console.error('Error loading gym code:', error);
    }
}

function copyGymCode() {
    const codeEl = document.getElementById('gym-code-display');
    if (!codeEl) return;

    const code = codeEl.textContent;
    if (code === '------') return;

    navigator.clipboard.writeText(code).then(() => {
        // Show success feedback
        const copyIcon = document.getElementById('copy-icon');
        const copyText = document.getElementById('copy-text');
        if (!copyIcon || !copyText) return;

        const originalIcon = copyIcon.textContent;
        const originalText = copyText.textContent;

        copyIcon.textContent = '‚úì';
        copyText.textContent = 'Copied!';

        setTimeout(() => {
            copyIcon.textContent = originalIcon;
            copyText.textContent = originalText;
        }, 2000);

        if (typeof showToast === 'function') {
            showToast('Gym code copied to clipboard!', 'success');
        }
    }).catch(err => {
        console.error('Failed to copy:', err);
        if (typeof showToast === 'function') {
            showToast('Failed to copy code', 'error');
        }
    });
}

// --- TRAINER APPROVAL FUNCTIONS ---

async function loadPendingTrainers() {
    try {
        const response = await fetch('/api/owner/pending-trainers', {
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Failed to load pending trainers');

        const trainers = await response.json();
        displayPendingTrainers(trainers);
    } catch (error) {
        console.error('Error loading pending trainers:', error);
    }
}

function displayPendingTrainers(trainers) {
    const section = document.getElementById('pending-trainers-section');
    const list = document.getElementById('pending-trainers-list');
    if (!list) return;

    if (!trainers || trainers.length === 0) {
        // In dashboard mode, hide the section if empty
        if (section) {
            section.classList.add('hidden');
        }
        return;
    }

    if (section) {
        section.classList.remove('hidden');
    }

    // Helper to get role display label
    function getRoleLabel(user) {
        if (user.role === 'staff') return 'Staff';
        if (user.sub_role === 'nutritionist') return 'Nutritionist';
        if (user.sub_role === 'both') return 'Trainer & Nutritionist';
        return 'Trainer';
    }

    // Helper to get role badge color
    function getRoleBadgeClass(user) {
        if (user.role === 'staff') return 'bg-blue-500/20 text-blue-400';
        if (user.sub_role === 'nutritionist') return 'bg-green-500/20 text-green-400';
        if (user.sub_role === 'both') return 'bg-purple-500/20 text-purple-400';
        return 'bg-orange-500/20 text-orange-400';
    }

    list.innerHTML = trainers.map(trainer => {
        const initials = trainer.username.substring(0, 2).toUpperCase();
        return `
        <div class="glass-card overflow-hidden border border-yellow-500/20">
            <div class="p-4">
                <div class="flex items-center gap-3">
                    <!-- Avatar -->
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-yellow-500/30 to-orange-500/20 border border-yellow-500/30 flex items-center justify-center flex-shrink-0">
                        <span class="text-base font-bold text-yellow-400">${initials}</span>
                    </div>

                    <!-- Info -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-0.5">
                            <h4 class="font-bold text-white">${trainer.username}</h4>
                            <span class="text-xs px-2 py-0.5 rounded-full ${getRoleBadgeClass(trainer)}">${getRoleLabel(trainer)}</span>
                        </div>
                        <p class="text-sm text-gray-400 truncate">${trainer.email || 'No email'}</p>
                    </div>

                    <!-- Pending badge -->
                    <div class="flex items-center gap-1.5">
                        <span class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></span>
                        <span class="text-xs text-yellow-400">Pending</span>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex gap-2 mt-4">
                    <button onclick="approveTrainer('${trainer.id}')"
                        class="flex-1 bg-green-500/20 hover:bg-green-500/30 text-green-400 py-2.5 rounded-xl text-sm font-bold transition flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Approve
                    </button>
                    <button onclick="rejectTrainer('${trainer.id}', '${trainer.username}')"
                        class="flex-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 py-2.5 rounded-xl text-sm font-bold transition flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        Reject
                    </button>
                </div>
            </div>
        </div>
    `}).join('');
}

async function loadApprovedTrainers() {
    try {
        const response = await fetch('/api/owner/approved-trainers', {
            credentials: 'include'
        });

        if (!response.ok) {
            const list = document.getElementById('approved-trainers-list');
            if (list) {
                list.innerHTML = `
                    <div class="glass-card p-8 text-center">
                        <div class="w-16 h-16 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                        </div>
                        <p class="text-gray-400 text-sm">No active trainers yet</p>
                        <p class="text-gray-500 text-xs mt-1">Share your gym code to invite trainers</p>
                    </div>
                `;
            }
            return;
        }

        const trainers = await response.json();
        displayApprovedTrainers(trainers);
        displayDashboardTrainers(trainers);
    } catch (error) {
        console.error('Error loading approved trainers:', error);
        const list = document.getElementById('approved-trainers-list');
        if (list) {
            list.innerHTML = `
                <div class="glass-card p-3 text-center text-gray-400 text-sm">
                    No active trainers yet
                </div>
            `;
        }
        // Also update dashboard list on error
        const dashList = document.getElementById('dashboard-trainers-list');
        if (dashList) {
            dashList.innerHTML = `
                <div class="glass-card p-3 text-center text-gray-400 text-sm">
                    No trainers yet
                </div>
            `;
        }
    }
}

function displayApprovedTrainers(trainers) {
    const list = document.getElementById('approved-trainers-list');
    if (!list) return;

    if (!trainers || trainers.length === 0) {
        list.innerHTML = `
            <div class="glass-card p-3 text-center text-gray-400 text-sm">
                No active trainers yet
            </div>
        `;
        return;
    }

    list.innerHTML = trainers.map(trainer => {
        const initials = trainer.username.substring(0, 2).toUpperCase();
        const clientCount = trainer.client_count || 0;
        return `
        <div class="glass-card overflow-hidden">
            <div class="p-4">
                <div class="flex items-center gap-3">
                    <!-- Avatar -->
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary/30 to-orange-500/20 border border-primary/30 flex items-center justify-center flex-shrink-0">
                        <span class="text-base font-bold text-primary">${initials}</span>
                    </div>

                    <!-- Info -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between mb-0.5">
                            <h4 class="font-bold text-white">${trainer.username}</h4>
                            <div class="flex items-center gap-1.5">
                                <span class="w-2 h-2 rounded-full bg-green-400"></span>
                                <span class="text-xs text-green-400">Active</span>
                            </div>
                        </div>
                        <p class="text-sm text-gray-400 truncate">${trainer.email || 'No email'}</p>
                    </div>

                    <!-- Client count -->
                    <div class="text-right pl-2">
                        <p class="text-xl font-bold text-primary">${clientCount}</p>
                        <p class="text-xs text-gray-500">clients</p>
                    </div>
                </div>
            </div>
        </div>
    `}).join('');
}

function displayDashboardTrainers(trainers) {
    const list = document.getElementById('dashboard-trainers-list');
    if (!list) return;

    if (!trainers || trainers.length === 0) {
        list.innerHTML = `
            <div class="glass-card p-3 text-center text-gray-400 text-sm">
                <p>No trainers yet</p>
                <p class="text-xs mt-1">Share your gym code to invite trainers</p>
            </div>
        `;
        return;
    }

    // Show up to 5 trainers in compact format
    const displayTrainers = trainers.slice(0, 5);
    const totalClients = trainers.reduce((sum, t) => sum + (t.client_count || 0), 0);

    list.innerHTML = `
        <div class="glass-card p-3 mb-2">
            <div class="flex justify-between items-center text-sm">
                <span class="text-gray-400">Total Staff</span>
                <span class="font-bold text-white">${trainers.length}</span>
            </div>
            <div class="flex justify-between items-center text-sm mt-1">
                <span class="text-gray-400">Managing</span>
                <span class="font-bold text-primary">${totalClients} clients</span>
            </div>
        </div>
        ${displayTrainers.map(trainer => {
            const initials = trainer.username.substring(0, 2).toUpperCase();
            const clientCount = trainer.client_count || 0;
            return `
            <div class="flex items-center gap-2 p-2 rounded-lg bg-white/5 hover:bg-white/10 transition">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-primary/30 to-orange-500/20 border border-primary/30 flex items-center justify-center flex-shrink-0">
                    <span class="text-xs font-bold text-primary">${initials}</span>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-white truncate">${trainer.username}</p>
                </div>
                <div class="flex items-center gap-1">
                    <span class="text-sm font-bold text-primary">${clientCount}</span>
                    <span class="text-xs text-gray-500">üë•</span>
                </div>
            </div>
        `}).join('')}
        ${trainers.length > 5 ? `
            <button onclick="openTrainersModal()" class="block w-full text-center text-xs text-primary hover:text-primary/80 transition mt-2">
                +${trainers.length - 5} more trainers
            </button>
        ` : ''}
    `;
}

// --- TRAINERS MODAL FUNCTIONS ---

let cachedTrainers = [];
let cachedPendingTrainers = [];

function openTrainersModal() {
    document.getElementById('trainers-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    loadTrainersForModal();
}

function closeTrainersModal() {
    document.getElementById('trainers-modal').classList.add('hidden');
    document.body.style.overflow = '';
}

async function loadTrainersForModal() {
    // Load both pending and approved trainers
    try {
        const [pendingRes, approvedRes] = await Promise.all([
            fetch('/api/owner/pending-trainers', { credentials: 'include' }),
            fetch('/api/owner/approved-trainers', { credentials: 'include' })
        ]);

        if (pendingRes.ok) {
            cachedPendingTrainers = await pendingRes.json();
            displayModalPendingTrainers(cachedPendingTrainers);
        }

        if (approvedRes.ok) {
            cachedTrainers = await approvedRes.json();
            displayModalApprovedTrainers(cachedTrainers);
        }
    } catch (error) {
        console.error('Error loading trainers for modal:', error);
    }
}

function displayModalPendingTrainers(trainers) {
    const section = document.getElementById('modal-pending-section');
    const container = document.getElementById('modal-pending-trainers');
    if (!section || !container) return;

    if (!trainers || trainers.length === 0) {
        section.classList.add('hidden');
        return;
    }

    section.classList.remove('hidden');

    function getRoleLabel(user) {
        if (user.role === 'staff') return 'Staff';
        if (user.sub_role === 'nutritionist') return 'Nutritionist';
        if (user.sub_role === 'both') return 'Trainer & Nutritionist';
        return 'Trainer';
    }

    function getRoleBadgeClass(user) {
        if (user.role === 'staff') return 'bg-blue-500/20 text-blue-400';
        if (user.sub_role === 'nutritionist') return 'bg-green-500/20 text-green-400';
        if (user.sub_role === 'both') return 'bg-purple-500/20 text-purple-400';
        return 'bg-orange-500/20 text-orange-400';
    }

    container.innerHTML = trainers.map(trainer => {
        const initials = trainer.username.substring(0, 2).toUpperCase();
        return `
        <div class="glass-card p-3 border border-yellow-500/20">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-yellow-500/30 to-orange-500/20 border border-yellow-500/30 flex items-center justify-center flex-shrink-0">
                    <span class="text-sm font-bold text-yellow-400">${initials}</span>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2">
                        <h4 class="font-semibold text-white text-sm">${trainer.username}</h4>
                        <span class="text-[10px] px-1.5 py-0.5 rounded-full ${getRoleBadgeClass(trainer)}">${getRoleLabel(trainer)}</span>
                    </div>
                    <p class="text-xs text-gray-400 truncate">${trainer.email || 'No email'}</p>
                </div>
                <div class="flex gap-1.5">
                    <button onclick="approveTrainerFromModal('${trainer.id}')"
                        class="w-8 h-8 rounded-lg bg-green-500/20 hover:bg-green-500/30 text-green-400 flex items-center justify-center transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    </button>
                    <button onclick="rejectTrainerFromModal('${trainer.id}', '${trainer.username}')"
                        class="w-8 h-8 rounded-lg bg-red-500/20 hover:bg-red-500/30 text-red-400 flex items-center justify-center transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    `}).join('');
}

function displayModalApprovedTrainers(trainers) {
    const container = document.getElementById('modal-approved-trainers');
    if (!container) return;

    if (!trainers || trainers.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-400 text-sm py-4">
                <p>No active trainers yet</p>
                <p class="text-xs mt-1">Share your gym code to invite trainers</p>
            </div>
        `;
        return;
    }

    container.innerHTML = trainers.map(trainer => {
        const initials = trainer.username.substring(0, 2).toUpperCase();
        const clientCount = trainer.client_count || 0;
        return `
        <div class="flex items-center gap-3 p-3 rounded-xl bg-white/5 hover:bg-white/10 transition">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary/30 to-orange-500/20 border border-primary/30 flex items-center justify-center flex-shrink-0">
                <span class="text-sm font-bold text-primary">${initials}</span>
            </div>
            <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2">
                    <h4 class="font-semibold text-white text-sm">${trainer.username}</h4>
                    <span class="w-1.5 h-1.5 rounded-full bg-green-400"></span>
                </div>
                <p class="text-xs text-gray-400 truncate">${trainer.email || 'No email'}</p>
            </div>
            <div class="text-right">
                <p class="text-lg font-bold text-primary">${clientCount}</p>
                <p class="text-[10px] text-gray-500">clients</p>
            </div>
        </div>
    `}).join('');
}

async function approveTrainerFromModal(trainerId) {
    try {
        const response = await fetch(`/api/owner/approve-trainer/${trainerId}`, {
            method: 'POST',
            credentials: 'include'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to approve trainer');
        }

        if (typeof showToast === 'function') {
            showToast('Trainer approved!', 'success');
        }
        loadTrainersForModal();
        loadApprovedTrainers(); // Update dashboard
        loadPendingTrainers(); // Update dashboard pending section
    } catch (error) {
        console.error('Error approving trainer:', error);
        if (typeof showToast === 'function') {
            showToast(error.message, 'error');
        }
    }
}

async function rejectTrainerFromModal(trainerId, username) {
    if (!confirm(`Are you sure you want to reject ${username}?`)) {
        return;
    }

    try {
        const response = await fetch(`/api/owner/reject-trainer/${trainerId}`, {
            method: 'POST',
            credentials: 'include'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to reject trainer');
        }

        if (typeof showToast === 'function') {
            showToast('Trainer rejected', 'success');
        }
        loadTrainersForModal();
        loadPendingTrainers(); // Update dashboard pending section
    } catch (error) {
        console.error('Error rejecting trainer:', error);
        if (typeof showToast === 'function') {
            showToast(error.message, 'error');
        }
    }
}

function copyGymCode() {
    const code = document.getElementById('modal-gym-code')?.textContent || '{{ gym_id }}';
    navigator.clipboard.writeText(code).then(() => {
        if (typeof showToast === 'function') {
            showToast('Gym code copied!', 'success');
        }
    });
}

// Close modal on backdrop click
document.getElementById('trainers-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeTrainersModal();
    }
});

async function approveTrainer(trainerId) {
    try {
        const response = await fetch(`/api/owner/approve-trainer/${trainerId}`, {
            method: 'POST',
            credentials: 'include'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to approve trainer');
        }

        if (typeof showToast === 'function') {
            showToast('Trainer approved successfully!', 'success');
        }
        loadPendingTrainers();
        loadApprovedTrainers(); // Update dashboard team overview
    } catch (error) {
        console.error('Error approving trainer:', error);
        if (typeof showToast === 'function') {
            showToast(error.message, 'error');
        }
    }
}

async function rejectTrainer(trainerId, username) {
    if (!confirm(`Are you sure you want to reject ${username}? They will need to register again.`)) {
        return;
    }

    try {
        const response = await fetch(`/api/owner/reject-trainer/${trainerId}`, {
            method: 'POST',
            credentials: 'include'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to reject trainer');
        }

        if (typeof showToast === 'function') {
            showToast('Trainer rejected', 'success');
        }
        loadPendingTrainers();
    } catch (error) {
        console.error('Error rejecting trainer:', error);
        if (typeof showToast === 'function') {
            showToast(error.message, 'error');
        }
    }
}

// --- AUTOMATED MESSAGES FUNCTIONS ---

let currentTemplateId = null;

async function loadTemplates() {
    try {
        const response = await fetch('/api/owner/automated-messages', {
            credentials: 'include'
        });
        if (!response.ok) throw new Error('Failed to load templates');
        const templates = await response.json();
        displayTemplates(templates);
    } catch (error) {
        console.error('Error loading templates:', error);
        const container = document.getElementById('templates-list');
        if (container) {
            container.innerHTML = `<div class="glass-card p-3 text-center text-red-400 text-sm">Failed to load templates</div>`;
        }
    }
}

function displayTemplates(templates) {
    const container = document.getElementById('templates-list');
    if (!container) return;

    if (!templates || templates.length === 0) {
        container.innerHTML = `
            <div class="glass-card p-4 text-center text-gray-400 text-sm">
                No automated messages configured. Create your first template to start engaging inactive clients.
            </div>
        `;
        return;
    }

    const triggerLabels = {
        'missed_workout': 'Missed Workout',
        'days_inactive': 'Days Inactive',
        'no_show_appointment': 'No-Show Appointment'
    };

    container.innerHTML = templates.map(t => `
        <div class="glass-card p-4 ${t.is_enabled ? '' : 'opacity-50'}">
            <div class="flex justify-between items-start mb-2">
                <div class="flex-1">
                    <div class="flex items-center gap-2 flex-wrap">
                        <h4 class="font-bold">${escapeHtml(t.name)}</h4>
                        <span class="text-xs px-2 py-0.5 rounded-full ${t.is_enabled ? 'bg-green-500/20 text-green-400' : 'bg-gray-500/20 text-gray-400'}">
                            ${t.is_enabled ? 'Active' : 'Disabled'}
                        </span>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Trigger: ${triggerLabels[t.trigger_type] || t.trigger_type}${t.trigger_type === 'days_inactive' && t.trigger_config ? ` (${t.trigger_config.days_threshold} days)` : ''}</p>
                </div>
                <div class="flex gap-2 flex-shrink-0">
                    <button onclick="toggleTemplate('${t.id}')" class="text-xs bg-white/10 px-2 py-1 rounded hover:bg-white/20 transition">
                        ${t.is_enabled ? 'Disable' : 'Enable'}
                    </button>
                    <button onclick="editTemplate('${t.id}')" class="text-xs bg-white/10 px-2 py-1 rounded hover:bg-white/20 transition">
                        Edit
                    </button>
                    <button onclick="deleteTemplate('${t.id}', '${escapeHtml(t.name)}')" class="text-xs bg-red-500/20 text-red-400 px-2 py-1 rounded hover:bg-red-500/30 transition">
                        Delete
                    </button>
                </div>
            </div>
            <div class="mt-3 pt-3 border-t border-white/10">
                <p class="text-xs text-gray-400 line-clamp-2">${escapeHtml(t.message_template)}</p>
            </div>
            <div class="mt-2 flex gap-2">
                ${t.delivery_methods.includes('in_app') ? '<span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-0.5 rounded">In-App</span>' : ''}
                ${t.delivery_methods.includes('email') ? '<span class="text-xs bg-purple-500/20 text-purple-400 px-2 py-0.5 rounded">Email</span>' : ''}
                ${t.delivery_methods.includes('whatsapp') ? '<span class="text-xs bg-green-500/20 text-green-400 px-2 py-0.5 rounded">WhatsApp</span>' : ''}
            </div>
        </div>
    `).join('');
}

function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function openCreateTemplateModal() {
    currentTemplateId = null;
    document.getElementById('template-modal-title').textContent = 'Create Automated Message';
    document.getElementById('template-submit-btn').textContent = 'Create Template';
    document.getElementById('template-form').reset();
    document.getElementById('template-id').value = '';
    document.getElementById('template-preview').classList.add('hidden');
    document.getElementById('delivery-in-app').checked = true;
    document.getElementById('template-enabled').checked = true;
    updateTriggerConfig();
    document.getElementById('template-modal').classList.remove('hidden');
}

function closeTemplateModal() {
    document.getElementById('template-modal').classList.add('hidden');
    currentTemplateId = null;
}

function updateTriggerConfig() {
    const trigger = document.getElementById('template-trigger').value;
    const configSection = document.getElementById('trigger-config-section');

    if (trigger === 'days_inactive') {
        configSection.classList.remove('hidden');
    } else {
        configSection.classList.add('hidden');
    }
}

function previewTemplate() {
    const message = document.getElementById('template-message').value;
    // Simple client-side preview with sample data
    const preview = message
        .replace(/{client_name}/g, 'John Doe')
        .replace(/{days_inactive}/g, '7')
        .replace(/{workout_title}/g, 'Push Day')
        .replace(/{trainer_name}/g, 'Mike');

    document.getElementById('preview-output').textContent = preview;
    document.getElementById('template-preview').classList.remove('hidden');
}

async function saveTemplate(event) {
    event.preventDefault();

    const templateId = document.getElementById('template-id').value;
    const isEdit = !!templateId;

    const deliveryMethods = [];
    if (document.getElementById('delivery-in-app').checked) deliveryMethods.push('in_app');
    if (document.getElementById('delivery-email').checked) deliveryMethods.push('email');
    if (document.getElementById('delivery-whatsapp').checked) deliveryMethods.push('whatsapp');

    const triggerType = document.getElementById('template-trigger').value;
    let triggerConfig = null;
    if (triggerType === 'days_inactive') {
        triggerConfig = {
            days_threshold: parseInt(document.getElementById('trigger-days-threshold').value) || 5
        };
    }

    const data = {
        name: document.getElementById('template-name').value,
        trigger_type: triggerType,
        trigger_config: triggerConfig,
        message_template: document.getElementById('template-message').value,
        delivery_methods: deliveryMethods,
        is_enabled: document.getElementById('template-enabled').checked
    };

    try {
        const url = isEdit
            ? `/api/owner/automated-messages/${templateId}`
            : '/api/owner/automated-messages';
        const method = isEdit ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to save template');
        }

        showToast(isEdit ? 'Template updated!' : 'Template created!', 'success');
        closeTemplateModal();
        loadTemplates();
    } catch (error) {
        showToast(error.message, 'error');
    }
}

async function editTemplate(templateId) {
    try {
        const response = await fetch(`/api/owner/automated-messages/${templateId}`, {
            credentials: 'include'
        });
        if (!response.ok) throw new Error('Failed to load template');
        const template = await response.json();

        currentTemplateId = templateId;
        document.getElementById('template-id').value = templateId;
        document.getElementById('template-modal-title').textContent = 'Edit Automated Message';
        document.getElementById('template-submit-btn').textContent = 'Save Changes';

        document.getElementById('template-name').value = template.name;
        document.getElementById('template-trigger').value = template.trigger_type;
        document.getElementById('template-message').value = template.message_template;
        document.getElementById('template-enabled').checked = template.is_enabled;

        if (template.trigger_config && template.trigger_config.days_threshold) {
            document.getElementById('trigger-days-threshold').value = template.trigger_config.days_threshold;
        }

        document.getElementById('delivery-in-app').checked = template.delivery_methods.includes('in_app');

        updateTriggerConfig();
        document.getElementById('template-preview').classList.add('hidden');
        document.getElementById('template-modal').classList.remove('hidden');
    } catch (error) {
        showToast('Failed to load template', 'error');
    }
}

async function toggleTemplate(templateId) {
    try {
        const response = await fetch(`/api/owner/automated-messages/${templateId}/toggle`, {
            method: 'POST',
            credentials: 'include'
        });
        if (!response.ok) throw new Error('Failed to toggle template');
        const template = await response.json();
        showToast(`Template ${template.is_enabled ? 'enabled' : 'disabled'}`, 'success');
        loadTemplates();
    } catch (error) {
        showToast('Failed to toggle template', 'error');
    }
}

async function deleteTemplate(templateId, templateName) {
    if (!confirm(`Delete template "${templateName}"? This cannot be undone.`)) return;

    try {
        const response = await fetch(`/api/owner/automated-messages/${templateId}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        if (!response.ok) throw new Error('Failed to delete template');
        showToast('Template deleted', 'success');
        loadTemplates();
    } catch (error) {
        showToast('Failed to delete template', 'error');
    }
}

async function loadMessageLog() {
    try {
        const response = await fetch('/api/owner/automated-messages/log?limit=20', {
            credentials: 'include'
        });
        if (!response.ok) throw new Error('Failed to load message log');
        const logs = await response.json();
        displayMessageLog(logs);
    } catch (error) {
        console.error('Error loading message log:', error);
        const container = document.getElementById('message-log');
        if (container) {
            container.innerHTML = `<div class="glass-card p-3 text-center text-gray-400 text-sm">No recent activity</div>`;
        }
    }
}

function displayMessageLog(logs) {
    const container = document.getElementById('message-log');
    if (!container) return;

    if (!logs || logs.length === 0) {
        container.innerHTML = `
            <div class="glass-card p-3 text-center text-gray-400 text-sm">
                No automated messages sent yet.
            </div>
        `;
        return;
    }

    const triggerLabels = {
        'missed_workout': 'Missed Workout',
        'days_inactive': 'Inactive',
        'no_show_appointment': 'No-Show'
    };

    container.innerHTML = logs.map(log => `
        <div class="glass-card p-3 flex items-center gap-3">
            <div class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0">
                <span class="text-xs">${log.status === 'sent' ? '‚úì' : '‚úó'}</span>
            </div>
            <div class="flex-1 min-w-0">
                <p class="text-sm font-semibold truncate">${escapeHtml(log.client_name)}</p>
                <p class="text-xs text-gray-400">${triggerLabels[log.trigger_type] || log.trigger_type} ¬∑ ${escapeHtml(log.template_name)}</p>
            </div>
            <div class="text-right flex-shrink-0">
                <span class="text-xs px-2 py-0.5 rounded-full ${log.status === 'sent' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">
                    ${log.status}
                </span>
                <p class="text-xs text-gray-500 mt-1">${formatRelativeTime(log.triggered_at)}</p>
            </div>
        </div>
    `).join('');
}

function formatRelativeTime(isoString) {
    if (!isoString) return '';
    const date = new Date(isoString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return date.toLocaleDateString();
}

async function manualTriggerCheck() {
    try {
        showToast('Running trigger check...', 'info');
        const response = await fetch('/api/owner/automated-messages/trigger-check', {
            method: 'POST',
            credentials: 'include'
        });
        if (!response.ok) throw new Error('Failed to run trigger check');
        const result = await response.json();
        showToast(`Check complete: ${result.messages_sent} messages sent`, 'success');
        loadMessageLog();
    } catch (error) {
        showToast('Failed to run trigger check', 'error');
    }
}

// --- CRM FUNCTIONS ---

async function loadPipeline() {
    try {
        const response = await fetch('/api/owner/crm/pipeline', {
            credentials: 'include'
        });
        if (!response.ok) throw new Error('Failed to load pipeline');
        const data = await response.json();
        displayPipeline(data);
    } catch (error) {
        console.error('Error loading pipeline:', error);
    }
}

function displayPipeline(data) {
    const newEl = document.getElementById('pipeline-new');
    const activeEl = document.getElementById('pipeline-active');
    const atRiskEl = document.getElementById('pipeline-at-risk');
    const churningEl = document.getElementById('pipeline-churning');

    if (newEl) newEl.textContent = data.new || 0;
    if (activeEl) activeEl.textContent = data.active || 0;
    if (atRiskEl) atRiskEl.textContent = data.at_risk || 0;
    if (churningEl) churningEl.textContent = data.churning || 0;
}

async function loadRetentionAnalytics() {
    const periodSelect = document.getElementById('analytics-period');
    const period = periodSelect?.value || 'month';
    try {
        const response = await fetch(`/api/owner/crm/analytics?period=${period}`, {
            credentials: 'include'
        });
        if (!response.ok) throw new Error('Failed to load analytics');
        const data = await response.json();
        displayAnalytics(data);
    } catch (error) {
        console.error('Error loading analytics:', error);
    }
}

function displayAnalytics(data) {
    const engagementEl = document.getElementById('engagement-rate');
    const atRiskEl = document.getElementById('at-risk-count');
    const churnEl = document.getElementById('churn-rate');
    const healthEl = document.getElementById('avg-health');

    if (engagementEl) engagementEl.textContent = `${data.engagement_rate || 0}%`;
    if (atRiskEl) atRiskEl.textContent = data.at_risk_count || 0;
    if (churnEl) churnEl.textContent = `${data.churn_rate || 0}%`;
    if (healthEl) healthEl.textContent = data.avg_health_score || 0;
}

async function loadAtRiskClients() {
    try {
        const response = await fetch('/api/owner/crm/at-risk?limit=20', {
            credentials: 'include'
        });
        if (!response.ok) throw new Error('Failed to load at-risk clients');
        const clients = await response.json();
        displayAtRiskClients(clients);
    } catch (error) {
        console.error('Error loading at-risk clients:', error);
    }
}

function displayAtRiskClients(clients) {
    const container = document.getElementById('at-risk-list');
    if (!container) return;

    if (!clients || clients.length === 0) {
        container.innerHTML = `
            <div class="glass-card p-4 text-center text-green-400 text-sm flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                No at-risk clients! Great retention.
            </div>
        `;
        return;
    }

    container.innerHTML = clients.map(client => `
        <div class="glass-card p-3 flex items-center gap-3 hover:bg-white/5 transition">
            <div class="w-10 h-10 rounded-full bg-yellow-500/20 border border-yellow-500/30 flex items-center justify-center flex-shrink-0">
                <span class="text-sm font-bold text-yellow-400">${(client.name || 'U').substring(0, 2).toUpperCase()}</span>
            </div>
            <div class="flex-1 min-w-0">
                <p class="font-semibold text-sm truncate">${escapeHtml(client.name)}</p>
                <p class="text-xs text-gray-400">
                    ${client.days_inactive} days inactive ¬∑
                    ${client.trainer_name ? `Trainer: ${client.trainer_name}` : 'No trainer'}
                </p>
            </div>
            <div class="text-right flex-shrink-0">
                <span class="text-xs px-2 py-1 rounded-full ${
                    client.days_inactive > 10 ? 'bg-red-500/20 text-red-400' : 'bg-yellow-500/20 text-yellow-400'
                }">
                    ${client.days_inactive > 10 ? 'Critical' : 'At Risk'}
                </span>
                <p class="text-xs text-gray-500 mt-1">Health: ${client.health_score || 0}</p>
            </div>
        </div>
    `).join('');
}

async function loadInteractions(clientId = null) {
    try {
        let url = '/api/owner/crm/interactions?limit=30';
        if (clientId) url += `&client_id=${clientId}`;

        const response = await fetch(url, { credentials: 'include' });
        if (!response.ok) throw new Error('Failed to load interactions');
        const interactions = await response.json();
        displayInteractions(interactions);
    } catch (error) {
        console.error('Error loading interactions:', error);
    }
}

function displayInteractions(interactions) {
    const container = document.getElementById('interactions-list');
    if (!container) return;

    if (!interactions || interactions.length === 0) {
        container.innerHTML = `
            <div class="glass-card p-3 text-center text-gray-400 text-sm">
                No recent activity
            </div>
        `;
        return;
    }

    const typeIcons = {
        'workout': 'üèãÔ∏è',
        'appointment': 'üìÖ',
        'message': 'üí¨',
        'automated_message': 'ü§ñ',
        'subscription': 'üí≥'
    };

    const typeColors = {
        'workout': 'bg-green-500/20 text-green-400',
        'appointment': 'bg-blue-500/20 text-blue-400',
        'message': 'bg-purple-500/20 text-purple-400',
        'automated_message': 'bg-orange-500/20 text-orange-400',
        'subscription': 'bg-yellow-500/20 text-yellow-400'
    };

    container.innerHTML = interactions.map(i => `
        <div class="glass-card p-3 flex items-center gap-3">
            <div class="w-8 h-8 rounded-full ${typeColors[i.type] || 'bg-gray-500/20'} flex items-center justify-center flex-shrink-0">
                <span class="text-sm">${typeIcons[i.type] || 'üìå'}</span>
            </div>
            <div class="flex-1 min-w-0">
                <p class="text-sm font-semibold truncate">${escapeHtml(i.client_name)}</p>
                <p class="text-xs text-gray-400 truncate">${escapeHtml(i.description)}</p>
            </div>
            <div class="text-xs text-gray-500 flex-shrink-0">
                ${i.timestamp ? i.timestamp.split('T')[0] : ''}
            </div>
        </div>
    `).join('');
}

// --- ACTIVITY FEED FUNCTIONS ---

async function loadActivityFeed() {
    try {
        const response = await fetch('/api/owner/activity-feed?limit=15', {
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error('Failed to load activity feed');
        }

        const activities = await response.json();
        displayActivityFeed(activities);
    } catch (error) {
        console.error('Error loading activity feed:', error);
        const container = document.getElementById('activity-feed');
        if (container) {
            container.innerHTML = `
                <div class="p-4 text-center text-gray-400 text-sm">
                    No recent activity
                </div>
            `;
        }
    }
}

function displayActivityFeed(activities) {
    const container = document.getElementById('activity-feed');
    if (!container) return;

    if (!activities || activities.length === 0) {
        container.innerHTML = `
            <div class="p-4 text-center text-gray-400 text-sm">
                <p>No recent activity</p>
                <p class="text-xs mt-1">Activity will appear here as clients use the gym</p>
            </div>
        `;
        return;
    }

    container.innerHTML = activities.map(activity => {
        // Format timestamp
        let timeDisplay = '';
        if (activity.timestamp) {
            try {
                const date = new Date(activity.timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 60) {
                    timeDisplay = diffMins <= 1 ? 'Just now' : `${diffMins}m ago`;
                } else if (diffHours < 24) {
                    timeDisplay = `${diffHours}h ago`;
                } else if (diffDays < 7) {
                    timeDisplay = `${diffDays}d ago`;
                } else {
                    timeDisplay = date.toLocaleDateString();
                }
            } catch {
                timeDisplay = activity.timestamp.split('T')[0];
            }
        }

        // Type-based colors
        const typeColors = {
            'workout': 'bg-green-500/20 text-green-400',
            'appointment': 'bg-blue-500/20 text-blue-400',
            'signup': 'bg-yellow-500/20 text-yellow-400',
            'subscription': 'bg-purple-500/20 text-purple-400'
        };

        return `
        <div class="flex items-center gap-3 p-3 border-b border-white/5 last:border-b-0 hover:bg-white/5 transition">
            <div class="w-9 h-9 rounded-xl ${typeColors[activity.type] || 'bg-gray-500/20'} flex items-center justify-center flex-shrink-0">
                <span class="text-base">${activity.icon || 'üìå'}</span>
            </div>
            <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-white truncate">${escapeHtml(activity.title)}</p>
                <p class="text-xs text-gray-400 truncate">${escapeHtml(activity.description || '')}</p>
            </div>
            <div class="text-xs text-gray-500 flex-shrink-0">
                ${timeDisplay}
            </div>
        </div>
    `}).join('');
}

// Initialize based on mode
if (currentMode === 'settings') {
    loadGymCode();
    loadStripeConnectStatus();
} else if (currentMode === 'automation') {
    loadTemplates();
    loadMessageLog();
} else if (currentMode === 'crm') {
    loadPipeline();
    loadRetentionAnalytics();
    loadAtRiskClients();
    loadInteractions();
} else {
    // Dashboard mode (default)
    loadPendingTrainers();
    loadApprovedTrainers();  // For team overview
    loadSubscriptionPlans();
    loadOffers();
    loadActivityFeed();  // Load activity feed
}
</script>
{% endblock %}
