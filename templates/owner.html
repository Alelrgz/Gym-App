{% extends "base.html" %}
{% from 'macros.html' import card %}

{% block content %}
<!-- ===== MOBILE HEADER ===== -->
<header class="owner-mobile-header">
    <div class="staff-mobile-header-logo">
        <img src="/static/fitos-logo.svg" alt="FitOS" class="staff-logo-img">
        <span class="staff-role-label">Owner</span>
    </div>
    <div class="staff-mobile-header-actions">
        <button class="staff-mobile-msg-btn" data-action="showModal" data-target="notification-modal">
            <i data-lucide="bell" class="w-5 h-5"></i>
        </button>
        <a href="/auth/logout" class="staff-mobile-msg-btn" style="color:#f87171;">
            <i data-lucide="log-out" class="w-5 h-5"></i>
        </a>
    </div>
</header>

<!-- Desktop Sidebar + Main Content Layout -->
<div class="owner-layout">

    <!-- ===== LEFT SIDEBAR (desktop) ===== -->
    <aside class="staff-sidebar owner-sidebar">
        <div class="staff-sidebar-logo">
            <img src="/static/fitos-logo.svg" alt="FitOS" class="staff-logo-img staff-logo-img--sidebar">
            <span class="staff-role-label">Owner</span>
        </div>

        <nav class="staff-sidebar-nav">
            <a href="{{ 'owner.html' if static_build else '/?gym_id=' + gym_id + '&role=owner' }}"
               class="staff-nav-item owner-sidebar-item {{ 'active' if mode not in ['settings', 'crm', 'facilities'] }}">
                <i data-lucide="home" class="w-[18px] h-[18px]"></i>
                <span>Dashboard</span>
            </a>
            <a href="{{ 'owner.html' if static_build else '/?gym_id=' + gym_id + '&role=owner&mode=crm' }}"
               class="staff-nav-item owner-sidebar-item {{ 'active' if mode == 'crm' }}">
                <i data-lucide="bar-chart-3" class="w-[18px] h-[18px]"></i>
                <span>CRM</span>
            </a>
            <a href="{{ 'owner.html' if static_build else '/?gym_id=' + gym_id + '&role=owner&mode=facilities' }}"
               class="staff-nav-item owner-sidebar-item {{ 'active' if mode == 'facilities' }}">
                <i data-lucide="map-pin" class="w-[18px] h-[18px]"></i>
                <span>Strutture</span>
            </a>
            <a href="{{ 'owner.html' if static_build else '/?gym_id=' + gym_id + '&role=owner&mode=settings' }}"
               class="staff-nav-item owner-sidebar-item {{ 'active' if mode == 'settings' }}">
                <i data-lucide="settings" class="w-[18px] h-[18px]"></i>
                <span>Impostazioni</span>
            </a>
        </nav>

        <div style="flex:1"></div>

        <div style="display:flex;flex-direction:column;gap:0.25rem;">
            <a href="/auth/logout" class="staff-nav-item" style="color:#f87171;">
                <i data-lucide="log-out" class="w-[18px] h-[18px]"></i>
                <span>Esci</span>
            </a>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="owner-main">

<div class="p-4 md:p-6 lg:p-8 max-w-[1400px] mx-auto">
    <!-- Mobile header -->
    <div class="lg:hidden text-center mb-5">
        <h1 class="text-2xl font-black tracking-tight bg-gradient-to-r from-primary to-orange-400 bg-clip-text text-transparent" id="gym-name-owner">La Mia Palestra</h1>
        <p class="text-xs text-gray-500 uppercase tracking-widest mt-1">{{ 'Impostazioni' if mode == 'settings' else ('CRM' if mode == 'crm' else ('Strutture' if mode == 'facilities' else 'Dashboard')) }}</p>
    </div>
    <!-- Desktop header -->
    <div class="hidden lg:flex justify-between items-start mb-6">
        <div>
            <p class="label-uppercase mb-1">{{ 'Impostazioni' if mode == 'settings' else ('CRM' if mode == 'crm' else ('Strutture' if mode == 'facilities' else 'Dashboard')) }}</p>
            <h2 class="heading-page" id="desktop-gym-name">La Mia Palestra</h2>
        </div>
        <div class="flex gap-3">
            <div data-action="showModal" data-target="notification-modal" class="w-11 h-11 rounded-xl glass-card-interactive flex items-center justify-center cursor-pointer">
                <i data-lucide="bell" class="w-5 h-5"></i>
            </div>
        </div>
    </div>

    {% if mode == 'settings' %}
    <!-- ==================== SETTINGS MODE ==================== -->

    <!-- Gym Branding Card -->
    {% call card(classes="p-5 mb-5") %}
    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Branding Palestra</h3>

    <!-- Gym Logo -->
    <div class="flex items-center gap-4 mb-5">
        <div id="gym-logo-preview" class="w-20 h-20 rounded-2xl bg-gradient-to-br from-primary to-orange-600 flex items-center justify-center text-3xl font-bold text-white shadow-lg overflow-hidden flex-shrink-0">
            <span id="gym-logo-placeholder">G</span>
        </div>
        <div class="flex-1">
            <p class="text-sm text-white font-semibold mb-2">Logo Palestra</p>
            <div class="flex gap-2">
                <button onclick="document.getElementById('gym-logo-input').click()"
                    class="text-xs bg-primary/20 hover:bg-primary/30 text-primary px-3 py-2 rounded-lg transition">
                    Carica Logo
                </button>
                <button onclick="deleteGymLogo()" id="delete-logo-btn" class="hidden text-xs bg-red-500/20 hover:bg-red-500/30 text-red-400 px-3 py-2 rounded-lg transition">
                    Elimina
                </button>
            </div>
            <input type="file" id="gym-logo-input" accept="image/*" class="hidden" onchange="uploadGymLogo(this)">
        </div>
    </div>

    <!-- Gym Name (read-only display, edit via modal) -->
    <div>
        <label class="text-xs text-gray-400 uppercase tracking-wider block mb-2">Nome Palestra</label>
        <div class="flex gap-2 items-center">
            <div id="gym-name-display" class="flex-1 bg-white/5 border border-white/10 rounded-xl p-3 text-white text-sm opacity-60">‚Äî</div>
            <button onclick="openGymNameModal()"
                class="w-10 h-10 flex items-center justify-center rounded-xl bg-white/5 hover:bg-white/10 transition">
                <i data-lucide="pencil" class="w-4 h-4 text-gray-400"></i>
            </button>
        </div>
    </div>

    {% endcall %}

    <!-- Gym Code Card - Prominent -->
    {% call card(classes="p-5 mb-5") %}
    <div class="text-center">
        <p class="text-xs text-gray-400 uppercase tracking-wider mb-2">Il tuo Codice Palestra</p>
        <p class="text-4xl font-mono font-black text-primary tracking-widest mb-2" id="gym-code-display">------</p>
        <p class="text-sm text-gray-500 mb-4">Condividi questo codice con trainer e clienti</p>
        <button onclick="copyGymCode()" id="copy-gym-code-btn"
            class="bg-primary hover:bg-primary/80 text-white px-6 py-3 rounded-xl transition flex items-center gap-2 mx-auto font-bold">
            <span id="copy-icon"><i data-lucide="clipboard" class="w-4 h-4"></i></span>
            <span id="copy-text">Copia Codice</span>
        </button>
    </div>
    {% endcall %}

    <!-- Account Info -->
    {% call card(classes="p-4 mb-5") %}
    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Account</h3>
    <div class="space-y-3">
        <div class="flex justify-between items-center">
            <span class="text-gray-400">Ruolo</span>
            <span class="text-white font-semibold">Proprietario Palestra</span>
        </div>
        <div class="flex justify-between items-center">
            <span class="text-gray-400">Stato</span>
            <span class="text-green-400 font-semibold">Attivo</span>
        </div>
    </div>
    {% endcall %}

    <!-- Stripe Connect - Payment Setup -->
    {% call card(classes="p-4 mb-5") %}
    <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Configurazione Pagamenti</h3>
        <span id="stripe-status-badge" class="text-xs px-2 py-1 rounded-full bg-yellow-500/20 text-yellow-400">
            Verifica...
        </span>
    </div>
    <div id="stripe-connect-content">
        <!-- Not Connected State -->
        <div id="stripe-not-connected" class="hidden">
            <p class="text-sm text-gray-400 mb-4">
                Connetti il tuo account Stripe per ricevere pagamenti direttamente.
            </p>
            <button onclick="startStripeConnect()"
                class="w-full bg-[#635BFF] hover:bg-[#5851DB] text-white py-3 rounded-xl font-bold transition flex items-center justify-center gap-2">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M13.976 9.15c-2.172-.806-3.356-1.426-3.356-2.409 0-.831.683-1.305 1.901-1.305 2.227 0 4.515.858 6.09 1.631l.89-5.494C18.252.975 15.697 0 12.165 0 9.667 0 7.589.654 6.104 1.872 4.56 3.147 3.757 4.992 3.757 7.218c0 4.039 2.467 5.76 6.476 7.219 2.585.92 3.445 1.574 3.445 2.583 0 .98-.84 1.545-2.354 1.545-1.875 0-4.965-.921-6.99-2.109l-.9 5.555C5.175 22.99 8.385 24 11.714 24c2.641 0 4.843-.624 6.328-1.813 1.664-1.305 2.525-3.236 2.525-5.732 0-4.128-2.524-5.851-6.591-7.305z"/>
                </svg>
                Connetti con Stripe
            </button>
        </div>

        <!-- Pending State -->
        <div id="stripe-pending" class="hidden">
            <p class="text-sm text-yellow-400 mb-3">
                <i data-lucide="loader" class="w-4 h-4 inline-block align-middle stroke-current"></i> Configurazione incompleta. Completa la registrazione.
            </p>
            <button onclick="startStripeConnect()"
                class="w-full bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-400 py-3 rounded-xl font-bold transition">
                Continua Configurazione ‚Üí
            </button>
        </div>

        <!-- Connected State -->
        <div id="stripe-connected" class="hidden">
            <div class="flex items-center gap-3 mb-3">
                <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center">
                    <span class="text-green-400 text-xl">‚úì</span>
                </div>
                <div>
                    <p class="text-sm font-semibold text-green-400">Pagamenti Attivi</p>
                    <p class="text-xs text-gray-400">I pagamenti degli abbonamenti arrivano sul tuo conto</p>
                </div>
            </div>
            <button onclick="openStripeDashboard()"
                class="w-full bg-white/10 hover:bg-white/20 text-white py-3 rounded-xl font-semibold transition flex items-center justify-center gap-2">
                <i data-lucide="dollar-sign" class="w-4 h-4 inline-block align-middle"></i> Vedi Dashboard
            </button>
        </div>
    </div>
    {% endcall %}

    <!-- POS Terminal Setup -->
    {% call card(classes="p-4 mb-5") %}
    <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Terminale POS</h3>
        <div class="flex items-center gap-2">
            <span id="terminal-sandbox-badge" class="hidden text-xs px-2 py-1 rounded-full bg-yellow-500/20 text-yellow-400">Sandbox</span>
            <span id="terminal-status-badge" class="text-xs px-2 py-1 rounded-full bg-gray-500/20 text-gray-400">
                Verifica...
            </span>
        </div>
    </div>
    <div id="terminal-setup-content">
        <!-- Requires Connect -->
        <div id="terminal-needs-connect" class="hidden">
            <p class="text-sm text-gray-500">Configura prima i pagamenti Stripe per abilitare il terminale POS.</p>
        </div>

        <!-- Step 1: Create Location -->
        <div id="terminal-no-location" class="hidden">
            <p class="text-sm text-gray-400 mb-3">Inserisci l'indirizzo della palestra per registrare un lettore POS.</p>
            <div class="space-y-2 mb-3">
                <input id="terminal-address-line1" type="text" placeholder="Indirizzo"
                    class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500">
                <div class="grid grid-cols-2 gap-2">
                    <input id="terminal-address-city" type="text" placeholder="Citt√†"
                        class="bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500">
                    <input id="terminal-address-postal" type="text" placeholder="CAP"
                        class="bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <select id="terminal-address-country"
                        class="bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm text-white">
                        <option value="IT">Italia</option>
                        <option value="US">Stati Uniti</option>
                        <option value="GB">Regno Unito</option>
                        <option value="DE">Germania</option>
                        <option value="FR">Francia</option>
                        <option value="ES">Spagna</option>
                    </select>
                    <input id="terminal-address-state" type="text" placeholder="Provincia (es. MI)"
                        class="bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500">
                </div>
            </div>
            <button onclick="setupTerminalLocation()"
                class="w-full bg-orange-500/20 hover:bg-orange-500/30 text-orange-400 py-2.5 rounded-xl font-semibold transition text-sm">
                Crea Posizione Terminale
            </button>
        </div>

        <!-- Step 2: Register Reader -->
        <div id="terminal-no-reader" class="hidden">
            <!-- Tab switcher -->
            <div class="flex gap-1 mb-3 bg-white/5 rounded-lg p-1">
                <button onclick="setReaderTab('code')" id="tab-code"
                    class="flex-1 text-xs py-1.5 rounded-md font-semibold transition bg-white/10 text-white">
                    Codice Lettore
                </button>
                <button onclick="setReaderTab('id')" id="tab-id"
                    class="flex-1 text-xs py-1.5 rounded-md font-semibold transition text-gray-400">
                    ID Esistente
                </button>
            </div>

            <!-- Code tab (default) -->
            <div id="reader-tab-code">
                <p class="text-xs text-gray-500 mb-2">Codice mostrato sullo schermo del lettore alla prima accensione.</p>
                <div class="space-y-2 mb-3">
                    <input id="terminal-reg-code" type="text" placeholder="es. blue-fox-red"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500">
                    <input id="terminal-label" type="text" placeholder="Etichetta (es. Reception)" value="Reception"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500">
                </div>
                <button onclick="registerTerminalReader()"
                    class="w-full bg-orange-500/20 hover:bg-orange-500/30 text-orange-400 py-2.5 rounded-xl font-semibold transition text-sm mb-2">
                    Registra Lettore
                </button>
                <!-- Sandbox only: create a simulated reader with one click -->
                <button id="terminal-simulated-btn" onclick="registerSimulatedReader()" class="hidden
                    w-full bg-yellow-500/10 hover:bg-yellow-500/20 text-yellow-400 border border-yellow-500/30
                    py-2 rounded-xl font-semibold transition text-xs">
                    Usa Lettore Simulato (Sandbox)
                </button>
            </div>

            <!-- ID tab: for readers already registered on Stripe dashboard -->
            <div id="reader-tab-id" class="hidden">
                <p class="text-xs text-gray-500 mb-2">Hai gi√† un lettore su Stripe? Incolla l'ID dalla dashboard Stripe ‚Üí Terminal ‚Üí Readers.</p>
                <div class="space-y-2 mb-3">
                    <input id="terminal-reader-id" type="text" placeholder="tmr_Fxxxxxxxxxxxxxxxxx"
                        class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 font-mono">
                </div>
                <button onclick="importExistingReader()"
                    class="w-full bg-orange-500/20 hover:bg-orange-500/30 text-orange-400 py-2.5 rounded-xl font-semibold transition text-sm">
                    Collega Lettore Esistente
                </button>
            </div>
        </div>

        <!-- Step 3: Reader Registered -->
        <div id="terminal-registered" class="hidden">
            <div class="flex items-center gap-3 mb-3">
                <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center">
                    <i data-lucide="smartphone-nfc" class="w-5 h-5 text-green-400"></i>
                </div>
                <div>
                    <p class="text-sm font-semibold text-green-400" id="terminal-reader-label">Lettore</p>
                    <p class="text-xs text-gray-400" id="terminal-reader-status">Online</p>
                </div>
            </div>
            <p class="text-xs text-gray-500">Il terminale POS √® pronto. Lo staff pu√≤ ora accettare pagamenti con carta durante la registrazione dei clienti.</p>
        </div>
    </div>
    {% endcall %}

    <!-- Shower System Settings -->
    {% call card(classes="p-4 mb-5") %}
    <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Sistema Docce</h3>
        <i data-lucide="droplets" class="w-4 h-4 text-cyan-400"></i>
    </div>

    <div class="space-y-4">
        <div>
            <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Durata Timer (minuti)</label>
            <input type="number" id="shower-timer-input" min="1" max="30" value="8"
                class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-cyan-500/50 transition">
        </div>

        <div>
            <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Limite Giornaliero per Membro</label>
            <input type="number" id="shower-limit-input" min="1" max="20" value="3"
                class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-cyan-500/50 transition">
        </div>

        <button onclick="saveShowerSettings()"
            class="w-full bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 py-2.5 rounded-xl font-bold transition text-sm">
            Salva Impostazioni Docce
        </button>
    </div>

    {% endcall %}

    <!-- Tornello / Kiosk Setup -->
    {% call card(classes="p-4 mb-5") %}
    <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Tornello / Kiosk</h3>
        <i data-lucide="scan-line" class="w-4 h-4 text-emerald-400"></i>
    </div>

    <p class="text-xs text-gray-500 mb-4">Configura il Raspberry Pi all'ingresso della palestra per la scansione QR e l'apertura del tornello.</p>

    <div class="space-y-4">
        <!-- Device API Key -->
        <div>
            <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Chiave API Dispositivo</label>
            <div class="flex gap-2">
                <input type="text" id="device-api-key-display" readonly
                    class="flex-1 bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-sm text-white font-mono opacity-60"
                    value="Non ancora generata">
                <button onclick="copyDeviceKey()" title="Copia chiave" class="px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition">
                    <i data-lucide="clipboard" class="w-4 h-4 text-gray-400"></i>
                </button>
            </div>
        </div>

        <!-- Gate Duration -->
        <div>
            <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Durata Apertura Cancello (secondi)</label>
            <input type="number" id="turnstile-gate-input" min="2" max="15" value="5"
                class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-emerald-500/50 transition">
        </div>

        <div class="flex gap-2">
            <button onclick="generateDeviceKey()"
                class="flex-1 bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-400 py-2.5 rounded-xl font-bold transition text-sm">
                Genera Nuova Chiave
            </button>
            <button onclick="saveTurnstileSettings()"
                class="flex-1 bg-white/10 hover:bg-white/20 text-white py-2.5 rounded-xl font-bold transition text-sm">
                Salva Impostazioni
            </button>
        </div>
        <p class="text-xs text-gray-500">Rigenerare la chiave disconnetter√† tutti i dispositivi attualmente configurati.</p>
    </div>

    <!-- Pi Setup Command -->
    <div class="mt-5 pt-4 border-t border-white/10">
        <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Comando Setup Raspberry Pi</label>
        <p class="text-xs text-gray-500 mb-2">L'elettricista esegue questo comando sul Raspberry Pi via SSH.</p>
        <div class="relative">
            <textarea id="pi-setup-command" readonly rows="3"
                class="w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-xs text-emerald-300 font-mono opacity-80 resize-none"
                >Genera prima una chiave API dispositivo</textarea>
            <button onclick="copyPiSetupCommand()" title="Copia"
                class="absolute top-2 right-2 px-2 py-1 bg-white/10 hover:bg-white/20 rounded-lg transition">
                <i data-lucide="clipboard" class="w-3.5 h-3.5 text-gray-400"></i>
            </button>
        </div>
    </div>
    {% endcall %}

    <!-- Client Import Card -->
    {% call card(classes="p-4 mb-5") %}
    <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Client Import</h3>
        <i data-lucide="upload" class="w-4 h-4 text-orange-400"></i>
    </div>

    <p class="text-sm text-gray-400 mb-4">
        Bulk import clients from a CSV file. Each client will receive a temporary password and must change it on first login.
    </p>

    <div class="space-y-4">
        <!-- CSV Format Info -->
        <div class="bg-black/20 border border-white/10 rounded-lg p-3">
            <p class="text-xs text-gray-400 mb-1 font-semibold">Required columns (at least one):</p>
            <p class="text-xs text-gray-500 font-mono">name, email</p>
            <p class="text-xs text-gray-400 mt-2 mb-1 font-semibold">Optional columns:</p>
            <p class="text-xs text-gray-500 font-mono">phone, weight, body_fat, height, gender, date_of_birth, plan</p>
        </div>

        <!-- DPA Consent Checkbox -->
        <label class="flex items-start gap-3 cursor-pointer">
            <input type="checkbox" id="import-dpa-consent"
                class="mt-1 w-4 h-4 rounded accent-orange-500">
            <span class="text-xs text-gray-400 leading-relaxed">
                I confirm I have the right to upload this data and have obtained necessary consent from clients
                in accordance with applicable data protection regulations (GDPR).
            </span>
        </label>

        <!-- Upload Button -->
        <button type="button" onclick="triggerClientImport()" id="import-clients-btn"
            class="w-full bg-orange-500/20 hover:bg-orange-500/30 text-orange-400 py-2.5 rounded-xl font-bold transition text-sm">
            Upload CSV File
        </button>
        <input type="file" id="client-csv-input" accept=".csv" class="hidden" onchange="handleClientCsvUpload(this)">
    </div>

    <!-- Import Results (hidden by default) -->
    <div id="import-results" class="hidden mt-4 bg-black/20 border border-white/10 rounded-lg p-4">
        <h4 class="text-sm font-bold text-white mb-3">Import Results</h4>
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div class="text-center p-2 bg-green-500/10 rounded-lg">
                <p class="text-2xl font-bold text-green-400" id="import-created-count">0</p>
                <p class="text-xs text-gray-400">Created</p>
            </div>
            <div class="text-center p-2 bg-yellow-500/10 rounded-lg">
                <p class="text-2xl font-bold text-yellow-400" id="import-skipped-count">0</p>
                <p class="text-xs text-gray-400">Skipped</p>
            </div>
        </div>

        <!-- Error Details -->
        <div id="import-errors-section" class="hidden">
            <p class="text-xs text-red-400 font-semibold mb-1">Issues:</p>
            <div id="import-errors-list" class="max-h-40 overflow-y-auto space-y-1"></div>
        </div>

        <!-- Created Clients Table -->
        <div id="import-clients-section" class="hidden mt-3">
            <div class="flex items-center justify-between mb-2">
                <p class="text-xs text-green-400 font-semibold">Created Accounts:</p>
                <button type="button" onclick="copyImportCredentials()" class="text-xs bg-white/10 hover:bg-white/20 px-2 py-1 rounded transition text-gray-300">
                    Copy All Credentials
                </button>
            </div>
            <div id="import-clients-list" class="max-h-60 overflow-y-auto space-y-1 text-xs"></div>
        </div>
    </div>
    {% endcall %}

    <!-- Logout Button -->
    <a href="/auth/logout" class="block w-full bg-red-500/20 hover:bg-red-500/30 text-red-400 text-center py-3 rounded-xl font-bold transition">
        Esci
    </a>

    {% elif mode == 'crm' %}
    <!-- ==================== CRM MODE ==================== -->

    <!-- Retention Analytics Summary -->
    {% call card(classes="p-5 mb-5 relative overflow-hidden") %}
    <div class="absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent"></div>
    <div class="relative z-10">
        <div class="flex items-center justify-between mb-4">
            <div>
                <p class="text-xs text-gray-400 uppercase tracking-wider">Panoramica Fidelizzazione</p>
                <h2 class="text-2xl font-bold mt-1">Salute Clienti</h2>
            </div>
            <select id="analytics-period" onchange="loadRetentionAnalytics()"
                class="bg-black/20 border border-white/10 rounded-lg px-3 py-1.5 text-sm text-white outline-none">
                <option value="week">Ultimi 7 giorni</option>
                <option value="month" selected>Ultimi 30 giorni</option>
            </select>
        </div>
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="text-center p-3 bg-white/5 rounded-xl">
                <p class="text-3xl font-bold text-green-400" id="engagement-rate">--%</p>
                <p class="text-xs text-gray-400 mt-1">Tasso di Coinvolgimento</p>
            </div>
            <div class="text-center p-3 bg-white/5 rounded-xl">
                <p class="text-3xl font-bold text-yellow-400" id="at-risk-count">--</p>
                <p class="text-xs text-gray-400 mt-1">A Rischio</p>
            </div>
            <div class="text-center p-3 bg-white/5 rounded-xl">
                <p class="text-3xl font-bold text-red-400" id="churn-rate">--%</p>
                <p class="text-xs text-gray-400 mt-1">Tasso Abbandono</p>
            </div>
            <div class="text-center p-3 bg-white/5 rounded-xl">
                <p class="text-3xl font-bold text-blue-400" id="avg-health">--</p>
                <p class="text-xs text-gray-400 mt-1">Punteggio Salute Medio</p>
            </div>
        </div>
    </div>
    {% endcall %}

    <!-- Client Pipeline / Funnel -->
    <div class="mb-5">
        <h3 class="text-sm font-bold text-white uppercase tracking-wider mb-3">Pipeline Clienti</h3>
        <div class="grid grid-cols-4 gap-3">
            <div class="glass-card p-4 text-center border-t-4 border-green-400">
                <p class="text-2xl font-bold text-green-400" id="pipeline-new">--</p>
                <p class="text-xs text-gray-400 mt-1">Nuovi</p>
                <p class="text-[10px] text-gray-500">&lt; 14 giorni</p>
            </div>
            <div class="glass-card p-4 text-center border-t-4 border-blue-400">
                <p class="text-2xl font-bold text-blue-400" id="pipeline-active">--</p>
                <p class="text-xs text-gray-400 mt-1">Attivi</p>
                <p class="text-[10px] text-gray-500">Coinvolti</p>
            </div>
            <div class="glass-card p-4 text-center border-t-4 border-yellow-400">
                <p class="text-2xl font-bold text-yellow-400" id="pipeline-at-risk">--</p>
                <p class="text-xs text-gray-400 mt-1">A Rischio</p>
                <p class="text-[10px] text-gray-500">5-14 giorni</p>
            </div>
            <div class="glass-card p-4 text-center border-t-4 border-red-400">
                <p class="text-2xl font-bold text-red-400" id="pipeline-churning">--</p>
                <p class="text-xs text-gray-400 mt-1">In Abbandono</p>
                <p class="text-[10px] text-gray-500">&gt; 14 giorni</p>
            </div>
        </div>
    </div>

    <!-- At-Risk Clients List -->
    <div class="mb-5">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-bold text-white uppercase tracking-wider">Clienti a Rischio</h3>
            <span class="text-xs text-yellow-400"><i data-lucide="alert-triangle" class="w-3 h-3 inline-block align-middle"></i> Richiede attenzione</span>
        </div>
        <div id="at-risk-list" class="space-y-2 max-h-96 overflow-y-auto">
            <div class="glass-card p-3 text-center text-gray-400 text-sm">
                Caricamento...
            </div>
        </div>
    </div>

    <!-- Recent Interactions -->
    <div class="mb-5">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-bold text-white uppercase tracking-wider">Attivit√† Recenti</h3>
            <button onclick="loadInteractions()" class="text-xs bg-white/10 px-3 py-1.5 rounded-lg hover:bg-white/20 transition font-semibold">
                ‚Üª Aggiorna
            </button>
        </div>
        <div id="interactions-list" class="space-y-2 max-h-64 overflow-y-auto">
            <div class="glass-card p-3 text-center text-gray-400 text-sm">
                Caricamento attivit√†...
            </div>
        </div>
    </div>

    <!-- Medical Certificates Overview -->
    <div class="mb-5">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-bold text-white uppercase tracking-wider">Certificati Medici</h3>
            <button onclick="loadCertificatesOverview()" class="text-xs bg-white/10 px-3 py-1.5 rounded-lg hover:bg-white/20 transition font-semibold">
                ‚Üª Aggiorna
            </button>
        </div>
        <div id="certificates-overview" class="space-y-2 max-h-64 overflow-y-auto">
            <div class="glass-card p-3 text-center text-gray-400 text-sm">Caricamento...</div>
        </div>
    </div>

    {% elif mode == 'facilities' %}
    <!-- ==================== FACILITIES MODE ==================== -->

    <!-- ZONE: Activity Types (Teal) -->
    <section id="activity-types-section" class="mb-6">
        <div class="flex items-center gap-2 mb-4 border-l-4 border-teal-400 pl-3">
            <div class="w-8 h-8 rounded-lg bg-teal-500/20 flex items-center justify-center">
                <i data-lucide="layers" class="w-4 h-4 text-teal-400"></i>
            </div>
            <div class="flex-1">
                <h3 class="text-sm font-bold text-teal-400 uppercase tracking-wider">Tipi di Attivit√†</h3>
                <p class="text-xs text-gray-500">Tennis, padel, calcio, yoga e altro</p>
            </div>
            <button onclick="openCreateActivityTypeModal()"
                class="text-xs bg-teal-500/20 text-teal-400 px-3 py-1.5 rounded-lg hover:bg-teal-500/30 transition font-semibold">
                + Nuovo
            </button>
        </div>
        <div id="activity-types-grid" class="grid grid-cols-2 md:grid-cols-3 gap-3">
            <div class="glass-card p-4 text-center text-gray-500 text-sm col-span-full">
                <i data-lucide="plus-circle" class="w-8 h-8 mx-auto mb-2 text-gray-600"></i>
                <p>Nessun tipo di attivit√†</p>
                <p class="text-xs text-gray-600 mt-1">Clicca "+ Nuovo" per iniziare</p>
            </div>
        </div>
    </section>

    <!-- ZONE: Facilities for Selected Activity Type (Orange) -->
    <section id="facilities-section" class="hidden mb-6">
        <div class="flex items-center gap-2 mb-4 border-l-4 border-orange-400 pl-3">
            <button onclick="closeFacilitiesSection()" class="w-8 h-8 rounded-lg bg-orange-500/20 flex items-center justify-center hover:bg-orange-500/30 transition">
                <i data-lucide="chevron-left" class="w-4 h-4 text-orange-400"></i>
            </button>
            <div class="flex-1">
                <h3 class="text-sm font-bold text-orange-400 uppercase tracking-wider" id="facilities-section-title">Strutture</h3>
                <p class="text-xs text-gray-500">Campi, sale e strutture</p>
            </div>
            <button onclick="openCreateFacilityModal()"
                class="text-xs bg-orange-500/20 text-orange-400 px-3 py-1.5 rounded-lg hover:bg-orange-500/30 transition font-semibold">
                + Nuovo
            </button>
        </div>
        <div id="facilities-list" class="space-y-3">
            <div class="glass-card p-4 text-center text-gray-500 text-sm">Nessuna struttura</div>
        </div>
    </section>

    <!-- ZONE: Facility Availability (Purple) -->
    <section id="facility-availability-section" class="hidden mb-6">
        <div class="flex items-center gap-2 mb-4 border-l-4 border-purple-400 pl-3">
            <button onclick="closeFacilityAvailability()" class="w-8 h-8 rounded-lg bg-purple-500/20 flex items-center justify-center hover:bg-purple-500/30 transition">
                <i data-lucide="chevron-left" class="w-4 h-4 text-purple-400"></i>
            </button>
            <div class="flex-1">
                <h3 class="text-sm font-bold text-purple-400 uppercase tracking-wider" id="facility-avail-title">Imposta Disponibilit√†</h3>
                <p class="text-xs text-gray-500">Orario settimanale</p>
            </div>
        </div>
        {% call card(classes="p-5 relative overflow-hidden") %}
        <div class="absolute inset-0 bg-gradient-to-br from-purple-500/10 to-transparent"></div>
        <div class="relative z-10">
            <div id="facility-days-grid" class="space-y-3">
            </div>
            <button onclick="saveFacilityAvailability()"
                class="w-full mt-5 bg-primary text-white font-bold py-3 rounded-xl hover:bg-primary/80 transition">
                Salva Disponibilit√†
            </button>
        </div>
        {% endcall %}
    </section>

    <!-- ZONE: Upcoming Bookings (Blue) -->
    <section class="mb-6">
        <div class="flex items-center gap-2 mb-4 border-l-4 border-blue-400 pl-3">
            <div class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center">
                <i data-lucide="calendar-check" class="w-4 h-4 text-blue-400"></i>
            </div>
            <div>
                <h3 class="text-sm font-bold text-blue-400 uppercase tracking-wider">Prenotazioni Imminenti</h3>
                <p class="text-xs text-gray-500">Prenotazioni clienti</p>
            </div>
        </div>
        <div id="facility-bookings-list" class="space-y-2 max-h-96 overflow-y-auto">
            <div class="glass-card p-3 text-center text-gray-400 text-sm">
                Nessuna prenotazione imminente
            </div>
        </div>
    </section>

    <!-- Facility Modals -->

    <!-- Create/Edit Activity Type Modal -->
    <div id="activity-type-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
        onclick="if(event.target === this) hideModal('activity-type-modal')">
        <div class="glass-card p-6 rounded-2xl max-w-md w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" id="activity-type-modal-title">Nuovo Tipo di Attivit√†</h3>
                <button onclick="hideModal('activity-type-modal')" class="text-2xl text-gray-400 hover:text-white">&times;</button>
            </div>
            <form id="activity-type-form" class="space-y-4" onsubmit="event.preventDefault(); saveActivityType()">
                <input type="hidden" id="activity-type-id">
                <div>
                    <label class="text-xs text-gray-500 uppercase font-bold ml-1">Nome</label>
                    <input type="text" id="activity-type-name" required
                        class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white focus:border-primary outline-none"
                        placeholder="es. Tennis, Padel, Calcio">
                </div>
                <div>
                    <label class="text-xs text-gray-500 uppercase font-bold ml-1">Emoji (opzionale)</label>
                    <input type="text" id="activity-type-emoji" maxlength="4"
                        class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white focus:border-primary outline-none text-2xl"
                        placeholder="üéæ">
                </div>
                <div>
                    <label class="text-xs text-gray-500 uppercase font-bold ml-1">Descrizione (opzionale)</label>
                    <input type="text" id="activity-type-description"
                        class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white focus:border-primary outline-none"
                        placeholder="Breve descrizione">
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-primary text-white font-bold py-3 rounded-xl hover:bg-primary/80 transition">Salva</button>
                    <button type="button" onclick="hideModal('activity-type-modal')" class="flex-1 bg-white/10 text-white font-bold py-3 rounded-xl hover:bg-white/20 transition">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create/Edit Facility Modal -->
    <div id="facility-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
        onclick="if(event.target === this) hideModal('facility-modal')">
        <div class="glass-card p-6 rounded-2xl max-w-md w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" id="facility-modal-title">Nuova Struttura</h3>
                <button onclick="hideModal('facility-modal')" class="text-2xl text-gray-400 hover:text-white">&times;</button>
            </div>
            <form id="facility-form" class="space-y-4" onsubmit="event.preventDefault(); saveFacility()">
                <input type="hidden" id="facility-id">
                <input type="hidden" id="facility-activity-type-id">
                <div>
                    <label class="text-xs text-gray-500 uppercase font-bold ml-1">Nome</label>
                    <input type="text" id="facility-name" required
                        class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white focus:border-primary outline-none"
                        placeholder="es. Campo 1, Sala A">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-gray-500 uppercase font-bold ml-1">Durata Slot (min)</label>
                        <input type="number" id="facility-slot-duration" value="60" min="15" step="15"
                            class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white focus:border-primary outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 uppercase font-bold ml-1">Prezzo per Slot</label>
                        <input type="number" id="facility-price" step="0.01" min="0"
                            class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white focus:border-primary outline-none"
                            placeholder="0 = gratuito">
                    </div>
                </div>
                <div>
                    <label class="text-xs text-gray-500 uppercase font-bold ml-1">Max Partecipanti (opzionale)</label>
                    <input type="number" id="facility-max-participants" min="1"
                        class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white focus:border-primary outline-none"
                        placeholder="Lascia vuoto per prenotazione singola">
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-primary text-white font-bold py-3 rounded-xl hover:bg-primary/80 transition">Salva</button>
                    <button type="button" onclick="hideModal('facility-modal')" class="flex-1 bg-white/10 text-white font-bold py-3 rounded-xl hover:bg-white/20 transition">Annulla</button>
                </div>
            </form>
        </div>
    </div>

    {% else %}
    <!-- ==================== DASHBOARD MODE (default) ‚Äî merged with Automation ==================== -->

    <!-- Pending Staff Approvals - Full width banner (conditional) -->
    <div id="pending-trainers-section" class="mb-5 hidden">
        <div class="flex items-center gap-2 mb-3">
            <div class="w-7 h-7 rounded-lg bg-yellow-500/20 flex items-center justify-center">
                <i data-lucide="alert-circle" class="w-4 h-4 text-yellow-400"></i>
            </div>
            <h3 class="text-sm font-bold text-yellow-400 uppercase tracking-wider">Approvazioni Staff in Attesa</h3>
        </div>
        <div id="pending-trainers-list" class="space-y-3"></div>
    </div>

    <!-- Main Grid: 2/3 + 1/3 on desktop, single column on mobile -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- ===== LEFT COLUMN (2/3 width) ===== -->
        <div class="lg:col-span-2 space-y-6">

            <!-- ZONE: Operations (Green) -->
            <section>
                <div class="flex items-center gap-2 mb-4 border-l-4 border-green-400 pl-3">
                    <div class="w-8 h-8 rounded-lg bg-green-500/20 flex items-center justify-center">
                        <i data-lucide="dollar-sign" class="w-4 h-4 text-green-400"></i>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-green-400 uppercase tracking-wider">Operazioni</h3>
                        <p class="text-xs text-gray-500">Ricavi e metriche aziendali</p>
                    </div>
                </div>
                {% call card(classes="p-5 relative overflow-hidden") %}
                <div class="absolute inset-0 bg-gradient-to-br from-green-500/10 to-transparent"></div>
                <div class="relative z-10">
                    <p class="text-xs text-gray-400 uppercase tracking-wider mb-1">Ricavi Mensili</p>
                    <h1 class="text-4xl font-black text-green-400 mb-4" id="revenue-display">‚Ç¨0</h1>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Abbonamenti Attivi</span>
                            <span class="font-bold" id="active-subscriptions">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Clienti Attivi</span>
                            <span class="font-bold" id="active-members">...</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Staff</span>
                            <span class="font-bold" id="staff-active">...</span>
                        </div>
                    </div>
                </div>
                {% endcall %}
            </section>

            <!-- ZONE: Products (Purple) -->
            <section>
                <div class="flex items-center gap-2 mb-4 border-l-4 border-purple-400 pl-3">
                    <div class="w-8 h-8 rounded-lg bg-purple-500/20 flex items-center justify-center">
                        <i data-lucide="package" class="w-4 h-4 text-purple-400"></i>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-purple-400 uppercase tracking-wider">Prodotti</h3>
                        <p class="text-xs text-gray-500">Piani e offerte promozionali</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Plans -->
                    <div class="glass-card p-4 rounded-2xl">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-sm font-bold text-white">Piani</h4>
                            <button onclick="openCreatePlanModal()" class="text-xs bg-purple-500/20 text-purple-400 px-3 py-1.5 rounded-lg hover:bg-purple-500/30 transition font-semibold">
                                + Nuovo
                            </button>
                        </div>
                        <div id="subscription-plans-list" class="space-y-2 max-h-72 overflow-y-auto">
                            <div class="text-center text-gray-400 text-sm py-4">Nessun piano</div>
                        </div>
                    </div>
                    <!-- Offers -->
                    <div class="glass-card p-4 rounded-2xl">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-sm font-bold text-white"><i data-lucide="gift" class="w-4 h-4 inline-block align-middle text-purple-400"></i> Offerte</h4>
                            <button onclick="openCreateOfferModal()" class="text-xs bg-purple-500/20 text-purple-400 px-3 py-1.5 rounded-lg hover:bg-purple-500/30 transition font-semibold">
                                + Crea
                            </button>
                        </div>
                        <div id="offers-list" class="space-y-2 max-h-72 overflow-y-auto">
                            <div class="text-center text-gray-400 text-sm py-4">Nessuna offerta</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ZONE: Automation (Blue) -->
            <section>
                <div class="flex items-center gap-2 mb-4 border-l-4 border-blue-400 pl-3">
                    <div class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center">
                        <i data-lucide="zap" class="w-4 h-4 text-blue-400"></i>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-blue-400 uppercase tracking-wider">Automazione</h3>
                        <p class="text-xs text-gray-500">Comunicazione automatica ai clienti</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Message Templates -->
                    <div class="glass-card p-4 rounded-2xl">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-sm font-bold text-white">Modelli Messaggi</h4>
                            <button onclick="openCreateTemplateModal()" class="text-xs bg-blue-500/20 text-blue-400 px-3 py-1.5 rounded-lg hover:bg-blue-500/30 transition font-semibold">
                                + Crea
                            </button>
                        </div>
                        <div id="templates-list" class="space-y-3 max-h-72 overflow-y-auto">
                            <div class="text-center text-gray-400 text-sm py-4">Caricamento modelli...</div>
                        </div>
                    </div>
                    <!-- Automation Activity Log -->
                    <div class="glass-card p-4 rounded-2xl">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-sm font-bold text-white">Attivit√† Recenti</h4>
                            <button onclick="manualTriggerCheck()" class="text-xs bg-blue-500/20 text-blue-400 px-3 py-1.5 rounded-lg hover:bg-blue-500/30 transition font-semibold">
                                Esegui Controllo
                            </button>
                        </div>
                        <div id="message-log" class="space-y-2 max-h-72 overflow-y-auto">
                            <div class="text-center text-gray-400 text-sm py-4">Caricamento attivit√†...</div>
                        </div>
                    </div>
                </div>
            </section>

        </div>

        <!-- ===== RIGHT COLUMN (1/3 width) ===== -->
        <div class="lg:col-span-1 flex flex-col gap-6 min-h-0 overflow-hidden">

            <!-- ZONE: Team (Orange) -->
            <section>
                <div class="flex items-center gap-2 mb-4 border-l-4 border-orange-400 pl-3">
                    <div class="w-8 h-8 rounded-lg bg-orange-500/20 flex items-center justify-center">
                        <i data-lucide="users" class="w-4 h-4 text-orange-400"></i>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-orange-400 uppercase tracking-wider">Team</h3>
                        <p class="text-xs text-gray-500">I tuoi trainer e staff</p>
                    </div>
                </div>
                <div class="glass-card p-4 rounded-2xl">
                    <div class="flex justify-end mb-3">
                        <button onclick="openTrainersModal()" class="text-xs text-orange-400 hover:text-orange-300 transition font-semibold">
                            Vedi Tutti &rarr;
                        </button>
                    </div>
                    <div id="dashboard-trainers-list" class="space-y-2 max-h-80 overflow-y-auto">
                        <div class="text-center text-gray-400 text-sm py-4">Caricamento team...</div>
                    </div>
                </div>
            </section>

            <!-- ZONE: Live Feed (Slate) ‚Äî stretches to fill remaining height -->
            <section class="flex-1 flex flex-col min-h-0">
                <div class="flex items-center gap-2 mb-4 border-l-4 border-slate-500 pl-3">
                    <div class="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center">
                        <i data-lucide="activity" class="w-4 h-4 text-slate-400"></i>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider">Feed Live</h3>
                        <p class="text-xs text-gray-500">Attivit√† recenti della palestra</p>
                    </div>
                </div>
                <div id="activity-feed" class="glass-card divide-y divide-white/5 flex-1 overflow-y-auto min-h-[200px]"></div>
            </section>

        </div>
    </div>
    {% endif %}
</div>

    </main>
</div><!-- /owner-layout -->

<!-- Create/Edit Plan Modal -->
<div id="plan-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full">
        <h3 class="text-xl font-bold mb-4" id="plan-modal-title">Crea Piano di Abbonamento</h3>

        <form id="plan-form" class="space-y-4">
            <input type="hidden" id="plan-id">

            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Nome Piano</label>
                <input type="text" id="plan-name" required
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-primary/50 transition"
                    placeholder="es. Base, Premium, VIP">
            </div>

            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Descrizione</label>
                <textarea id="plan-description" rows="2"
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-primary/50 transition"
                    placeholder="Breve descrizione del piano"></textarea>
            </div>

            <!-- Billing type toggle -->
            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Tipo di Fatturazione</label>
                <div class="grid grid-cols-2 gap-2">
                    <button type="button" id="btn-billing-monthly"
                        onclick="setBillingType('monthly')"
                        class="px-3 py-2 rounded-lg text-sm font-semibold border transition text-center
                               bg-black/20 border-white/10 text-gray-400 hover:border-white/30">
                        Mensile
                    </button>
                    <button type="button" id="btn-billing-annual"
                        onclick="setBillingType('annual')"
                        class="px-3 py-2 rounded-lg text-sm font-semibold border transition text-center
                               bg-primary/20 border-primary/50 text-primary">
                        Annuale
                    </button>
                </div>
                <input type="hidden" id="plan-billing-type" value="annual">
            </div>

            <!-- Monthly price (shown for monthly) -->
            <div id="monthly-price-section" class="hidden">
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Prezzo Mensile (‚Ç¨)</label>
                <input type="number" id="plan-monthly-price" step="0.01" min="0"
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-primary/50 transition"
                    placeholder="49.90">
            </div>

            <!-- Annual price + installments (shown for annual) -->
            <div id="annual-price-section">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Prezzo Annuale (‚Ç¨)</label>
                        <input type="number" id="plan-annual-price" step="0.01" min="0"
                            class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-primary/50 transition"
                            placeholder="600.00" oninput="updateInstallmentPreview()">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Rate</label>
                        <select id="plan-installments"
                            class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-primary/50 transition"
                            onchange="updateInstallmentPreview()">
                            <option value="1">1 (pagamento unico)</option>
                            <option value="2">2 rate</option>
                            <option value="3">3 rate</option>
                            <option value="4">4 rate</option>
                            <option value="6">6 rate</option>
                            <option value="12" selected>12 rate (mensile)</option>
                        </select>
                    </div>
                </div>

                <!-- Installment preview -->
                <div id="installment-preview" class="bg-purple-500/10 border border-purple-500/20 rounded-lg p-3 text-sm hidden mt-3">
                    <div class="flex justify-between text-gray-300">
                        <span>Importo per rata:</span>
                        <span class="font-bold text-white" id="per-installment-amount">--</span>
                    </div>
                    <div class="flex justify-between text-gray-400 text-xs mt-1">
                        <span>Frequenza pagamento:</span>
                        <span id="payment-frequency">--</span>
                    </div>
                </div>
            </div>

            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Periodo di Prova (giorni)</label>
                <input type="number" id="plan-trial" min="0" value="0"
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-primary/50 transition"
                    placeholder="0">
            </div>

            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Caratteristiche (una per riga)</label>
                <textarea id="plan-features" rows="3"
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-primary/50 transition"
                    placeholder="Allenamenti illimitati&#10;Piani alimentari&#10;Coaching 1-a-1"></textarea>
            </div>

            <div class="flex space-x-3 pt-2">
                <button type="button" onclick="closePlanModal()"
                    class="flex-1 bg-white/10 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-white/20 transition">
                    Annulla
                </button>
                <button type="submit"
                    class="flex-1 bg-primary px-4 py-2 rounded-lg text-sm font-semibold hover:bg-primary/80 transition">
                    <span id="plan-submit-btn">Crea Piano</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Create/Edit Offer Modal -->
<div id="offer-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
        <h3 class="text-xl font-bold mb-4" id="offer-modal-title">Crea Offerta Promozionale</h3>

        <form id="offer-form" class="space-y-4">
            <input type="hidden" id="offer-id">

            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Titolo Offerta</label>
                <div class="relative">
                    <input type="text" id="offer-title" required
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 pr-10 text-sm text-white outline-none focus:border-green-500/50 transition"
                        placeholder="es. Offerta Capodanno, Saldi Estivi">
                    <button type="button" onclick="toggleEmojiPicker('offer-title')"
                        class="absolute right-2 top-1/2 -translate-y-1/2 hover:scale-110 transition" title="Add emoji">
                        <i data-lucide="smile-plus" class="w-5 h-5 stroke-current text-gray-400"></i>
                    </button>
                </div>
            </div>

            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Descrizione</label>
                <div class="relative">
                    <textarea id="offer-description" rows="2"
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 pr-10 text-sm text-white outline-none focus:border-green-500/50 transition"
                        placeholder="Descrivi l'offerta per attirare clienti"></textarea>
                    <button type="button" onclick="toggleEmojiPicker('offer-description')"
                        class="absolute right-2 top-2 hover:scale-110 transition" title="Add emoji">
                        <i data-lucide="smile-plus" class="w-5 h-5 stroke-current text-gray-400"></i>
                    </button>
                </div>
            </div>

            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Applica al Piano (opzionale)</label>
                <select id="offer-plan-id"
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-green-500/50 transition">
                    <option value="">Tutti i Piani</option>
                    <!-- Plans will be loaded dynamically -->
                </select>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Tipo Sconto</label>
                    <select id="offer-discount-type" required
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-green-500/50 transition">
                        <option value="percent">Percentuale (%)</option>
                        <option value="fixed">Importo Fisso (‚Ç¨)</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Valore Sconto</label>
                    <input type="number" id="offer-discount-value" required step="0.01" min="0"
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-green-500/50 transition"
                        placeholder="e.g., 20">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Durata (mesi)</label>
                    <input type="number" id="offer-duration" min="1" value="1"
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-green-500/50 transition"
                        placeholder="1">
                </div>
                <div>
                    <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Codice Coupon (opzionale)</label>
                    <input type="text" id="offer-coupon"
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-green-500/50 transition uppercase"
                        placeholder="e.g., SUMMER50">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Scade il (opzionale)</label>
                    <input type="date" id="offer-expires"
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-green-500/50 transition">
                </div>
                <div>
                    <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Limite Utilizzo (opzionale)</label>
                    <input type="number" id="offer-max-uses" min="1"
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-green-500/50 transition"
                        placeholder="Illimitato">
                </div>
            </div>

            <div class="flex gap-2 mt-6">
                <button type="button" onclick="closeOfferModal()"
                    class="flex-1 bg-white/10 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-white/20 transition">
                    Annulla
                </button>
                <button type="submit"
                    class="flex-1 bg-green-500 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-green-500/80 transition">
                    <span id="offer-submit-btn">Crea Offerta</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Trainers Modal -->
<div id="trainers-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="glass-card rounded-2xl max-w-lg w-full max-h-[80vh] flex flex-col">
        <!-- Header -->
        <div class="p-5 border-b border-white/10 flex justify-between items-center">
            <h3 class="text-xl font-bold">Gestione Team</h3>
            <button onclick="closeTrainersModal()" class="w-8 h-8 rounded-lg bg-white/10 hover:bg-white/20 transition flex items-center justify-center">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Content -->
        <div class="p-5 overflow-y-auto flex-1">
            <!-- Pending Approvals Section -->
            <div id="modal-pending-section" class="mb-5 hidden">
                <h4 class="text-sm font-bold text-yellow-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></span>
                    Approvazioni in Attesa
                </h4>
                <div id="modal-pending-trainers" class="space-y-2">
                    <!-- Pending trainers loaded here -->
                </div>
            </div>

            <!-- Active Trainers Section -->
            <div>
                <h4 class="text-sm font-bold text-white uppercase tracking-wider mb-3">Trainer Attivi</h4>
                <div id="modal-approved-trainers" class="space-y-2">
                    <div class="p-3 text-center text-gray-400 text-sm">Caricamento...</div>
                </div>
            </div>
        </div>

        <!-- Footer with gym code -->
        <div class="p-4 border-t border-white/10 bg-white/5">
            <p class="text-xs text-gray-400 text-center">Condividi il codice palestra per invitare trainer</p>
            <div class="flex items-center justify-center gap-2 mt-2">
                <code class="bg-black/30 px-3 py-1.5 rounded-lg text-primary font-mono text-sm" id="modal-gym-code">{{ gym_id[:8] if gym_id else '...' }}</code>
                <button onclick="copyGymCode()" class="text-xs bg-primary/20 text-primary px-3 py-1.5 rounded-lg hover:bg-primary/30 transition">
                    Copia
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Emoji Picker Popup -->
<div id="emoji-picker" class="fixed z-[60] hidden bg-[#1a1a1a] border border-white/20 rounded-xl shadow-2xl p-3 w-72">
    <div class="text-xs text-gray-400 uppercase tracking-wider mb-2">Popolari</div>
    <div class="grid grid-cols-8 gap-1 mb-3" id="emoji-popular">
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üéâ</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üéÅ</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">‚≠ê</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üî•</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üí™</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üèÜ</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üí∞</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">‚ú®</button>
    </div>
    <div class="text-xs text-gray-400 uppercase tracking-wider mb-2">Fitness</div>
    <div class="grid grid-cols-8 gap-1 mb-3">
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üèãÔ∏è</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üèÉ</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üö¥</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üßò</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üíØ</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">ü•á</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üéØ</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">‚ù§Ô∏è</button>
    </div>
    <div class="text-xs text-gray-400 uppercase tracking-wider mb-2">Stagionali</div>
    <div class="grid grid-cols-8 gap-1 mb-3">
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üéÑ</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üéÜ</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">‚òÄÔ∏è</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üå∏</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üçÇ</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">‚ùÑÔ∏è</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üéÉ</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üíù</button>
    </div>
    <div class="text-xs text-gray-400 uppercase tracking-wider mb-2">Altro</div>
    <div class="grid grid-cols-8 gap-1">
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üëç</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üöÄ</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üíé</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üåü</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">‚ö°</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üéä</button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition"><i data-lucide="megaphone" class="w-5 h-5"></i></button>
        <button type="button" class="emoji-btn text-xl p-1 hover:bg-white/10 rounded transition">üÜì</button>
    </div>
</div>

<!-- Create/Edit Template Modal -->
<div id="template-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
        <h3 class="text-xl font-bold mb-4" id="template-modal-title">Crea Messaggio Automatico</h3>

        <form id="template-form" class="space-y-4" onsubmit="saveTemplate(event)">
            <input type="hidden" id="template-id">

            <!-- Template Name -->
            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Nome Modello</label>
                <input type="text" id="template-name" required
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-primary/50 transition"
                    placeholder="es. Promemoria Cliente Inattivo">
            </div>

            <!-- Trigger Type -->
            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Trigger</label>
                <select id="template-trigger" required onchange="updateTriggerConfig()"
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-primary/50 transition">
                    <option value="missed_workout">Allenamento Mancato (programmato ma non completato)</option>
                    <option value="days_inactive">Giorni Inattivo (nessun allenamento in X giorni)</option>
                    <option value="no_show_appointment">Appuntamento Non Presentato</option>
                </select>
            </div>

            <!-- Trigger Config (dynamic) -->
            <div id="trigger-config-section" class="hidden">
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Soglia Giorni</label>
                <input type="number" id="trigger-days-threshold" min="1" value="5"
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-primary/50 transition"
                    placeholder="5">
                <p class="text-xs text-gray-500 mt-1">Invia messaggio quando il cliente non si allena da questo numero di giorni</p>
            </div>

            <!-- Delivery Methods -->
            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Metodi di Consegna</label>
                <div class="space-y-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="delivery-in-app" checked class="rounded bg-black/20 border-white/20 text-primary focus:ring-primary/50">
                        <span class="text-sm">Notifica In-App</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer opacity-50">
                        <input type="checkbox" id="delivery-email" disabled class="rounded bg-black/20 border-white/20">
                        <span class="text-sm">Email (Prossimamente)</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer opacity-50">
                        <input type="checkbox" id="delivery-whatsapp" disabled class="rounded bg-black/20 border-white/20">
                        <span class="text-sm">WhatsApp (Prossimamente)</span>
                    </label>
                </div>
            </div>

            <!-- Message Template -->
            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-1 block">Messaggio</label>
                <textarea id="template-message" rows="4" required
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none focus:border-primary/50 transition"
                    placeholder="Ciao {client_name}, abbiamo notato che hai saltato il tuo allenamento..."></textarea>
                <p class="text-xs text-gray-500 mt-1">
                    Variabili: <span class="text-primary">{client_name}</span>, <span class="text-primary">{days_inactive}</span>, <span class="text-primary">{workout_title}</span>, <span class="text-primary">{trainer_name}</span>
                </p>
            </div>

            <!-- Preview Button -->
            <button type="button" onclick="previewTemplate()"
                class="w-full bg-white/10 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-white/20 transition">
                Anteprima Messaggio
            </button>

            <!-- Preview Output -->
            <div id="template-preview" class="hidden bg-black/30 rounded-lg p-3 border border-white/10">
                <p class="text-xs text-gray-400 uppercase mb-2">Anteprima</p>
                <p id="preview-output" class="text-sm text-white"></p>
            </div>

            <!-- Enable Toggle -->
            <div class="flex items-center justify-between pt-2">
                <span class="text-sm">Attiva questo modello</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="template-enabled" checked class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-700 peer-focus:ring-2 peer-focus:ring-primary/50 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                </label>
            </div>

            <!-- Submit Buttons -->
            <div class="flex space-x-3 pt-2">
                <button type="button" onclick="closeTemplateModal()"
                    class="flex-1 bg-white/10 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-white/20 transition">
                    Annulla
                </button>
                <button type="submit"
                    class="flex-1 bg-primary px-4 py-2 rounded-lg text-sm font-semibold hover:bg-primary/80 transition">
                    <span id="template-submit-btn">Crea Modello</span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Current mode from server
const currentMode = "{{ mode }}";

// --- EMOJI PICKER ---
let currentEmojiTarget = null;

function toggleEmojiPicker(targetId) {
    const picker = document.getElementById('emoji-picker');
    const targetEl = document.getElementById(targetId);

    if (!picker || !targetEl) return;

    // If already open for same target, close it
    if (!picker.classList.contains('hidden') && currentEmojiTarget === targetId) {
        picker.classList.add('hidden');
        currentEmojiTarget = null;
        return;
    }

    currentEmojiTarget = targetId;

    // Position the picker near the input
    const rect = targetEl.getBoundingClientRect();
    picker.style.top = `${rect.bottom + 8}px`;
    picker.style.left = `${Math.min(rect.left, window.innerWidth - 300)}px`;

    picker.classList.remove('hidden');
}

// Handle emoji button clicks
document.addEventListener('click', (e) => {
    const picker = document.getElementById('emoji-picker');

    // If clicked on emoji button
    if (e.target.classList.contains('emoji-btn')) {
        const emoji = e.target.textContent;
        if (currentEmojiTarget) {
            const targetEl = document.getElementById(currentEmojiTarget);
            if (targetEl) {
                // Insert emoji at cursor position or append
                const start = targetEl.selectionStart || targetEl.value.length;
                const end = targetEl.selectionEnd || targetEl.value.length;
                const text = targetEl.value;
                targetEl.value = text.substring(0, start) + emoji + text.substring(end);
                targetEl.focus();
                // Move cursor after emoji
                targetEl.selectionStart = targetEl.selectionEnd = start + emoji.length;
            }
        }
        picker.classList.add('hidden');
        currentEmojiTarget = null;
        return;
    }

    // Close picker if clicked outside
    if (picker && !picker.classList.contains('hidden')) {
        if (!picker.contains(e.target) && !e.target.closest('[onclick*="toggleEmojiPicker"]')) {
            picker.classList.add('hidden');
            currentEmojiTarget = null;
        }
    }
});

// Subscription Plan Management
let currentPlanId = null;

// Load subscription plans
async function loadSubscriptionPlans() {
    console.log('loadSubscriptionPlans called');
    try {
        const response = await fetch('/api/owner/subscription-plans?include_inactive=true', {
            credentials: 'include'
        });

        console.log('Plans response status:', response.status);
        if (!response.ok) throw new Error('Impossibile caricare i piani');

        const plans = await response.json();
        console.log('Plans loaded:', plans);
        displayPlans(plans);
        updateRevenue(plans);
    } catch (error) {
        console.error('Error loading plans:', error);
    }
}

// Display plans in the UI - compact style for dashboard
function displayPlans(plans) {
    const container = document.getElementById('subscription-plans-list');
    if (!container) return;

    if (!plans || plans.length === 0) {
        container.innerHTML = `
            <div class="glass-card p-3 text-center text-gray-400 text-sm">
                Nessun piano
            </div>
        `;
        return;
    }

    container.innerHTML = plans.map(plan => `
        <div class="glass-card p-3 rounded-xl ${plan.is_active ? '' : 'opacity-50'} hover:bg-white/5 transition">
            <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2">
                        <h4 class="font-bold text-sm truncate">${escapeHtml(plan.name)}</h4>
                        ${!plan.is_active ? '<span class="text-[10px] bg-red-500/20 text-red-400 px-1.5 py-0.5 rounded">Disattivo</span>' : ''}
                    </div>
                    <p class="text-xs text-gray-400 mt-0.5">${plan.billing_type === 'monthly' ? `‚Ç¨${plan.price}/mese` : `‚Ç¨${plan.annual_price || plan.price}/anno${plan.installment_count > 1 ? ` (${plan.installment_count} rate da ‚Ç¨${plan.price})` : ''}`} ¬∑ ${plan.active_subscriptions || 0} abb.</p>
                </div>
                <div class="flex gap-1 flex-shrink-0">
                    <button onclick="editPlan('${plan.id}')" class="p-1.5 rounded hover:bg-white/10 transition text-gray-400 hover:text-white">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                        </svg>
                    </button>
                    <button onclick="deletePlan('${plan.id}', '${escapeHtml(plan.name)}')" class="p-1.5 rounded hover:bg-red-500/20 transition text-gray-400 hover:text-red-400">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

// Update revenue display from subscription plans data
function updateRevenue(plans) {
    const revenueEl = document.getElementById('revenue-display');
    const subsEl = document.getElementById('active-subscriptions');
    if (!revenueEl || !subsEl) return;

    const totalMRR = plans.reduce((sum, plan) => sum + (plan.monthly_revenue || 0), 0);
    const totalSubs = plans.reduce((sum, plan) => sum + (plan.active_subscriptions || 0), 0);

    revenueEl.textContent = `‚Ç¨${totalMRR.toLocaleString('it-IT', {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
    subsEl.textContent = totalSubs;
}

// Billing type toggle
function setBillingType(type) {
    document.getElementById('plan-billing-type').value = type;
    const btnMonthly = document.getElementById('btn-billing-monthly');
    const btnAnnual = document.getElementById('btn-billing-annual');
    const monthlySection = document.getElementById('monthly-price-section');
    const annualSection = document.getElementById('annual-price-section');
    const monthlyInput = document.getElementById('plan-monthly-price');
    const annualInput = document.getElementById('plan-annual-price');

    // Reset both button styles first
    const activeClass = 'bg-primary/20 border-primary/50 text-primary';
    const inactiveClass = 'bg-black/20 border-white/10 text-gray-400 hover:border-white/30';

    if (type === 'monthly') {
        btnMonthly.className = `px-3 py-2 rounded-lg text-sm font-semibold border transition text-center ${activeClass}`;
        btnAnnual.className = `px-3 py-2 rounded-lg text-sm font-semibold border transition text-center ${inactiveClass}`;
        monthlySection.classList.remove('hidden');
        annualSection.classList.add('hidden');
        monthlyInput.required = true;
        annualInput.required = false;
    } else {
        btnAnnual.className = `px-3 py-2 rounded-lg text-sm font-semibold border transition text-center ${activeClass}`;
        btnMonthly.className = `px-3 py-2 rounded-lg text-sm font-semibold border transition text-center ${inactiveClass}`;
        annualSection.classList.remove('hidden');
        monthlySection.classList.add('hidden');
        annualInput.required = true;
        monthlyInput.required = false;
    }
}

// Modal functions
function openCreatePlanModal() {
    currentPlanId = null;
    document.getElementById('plan-modal-title').textContent = 'Crea Piano di Abbonamento';
    document.getElementById('plan-submit-btn').textContent = 'Crea Piano';
    document.getElementById('plan-form').reset();
    document.getElementById('plan-id').value = '';
    setBillingType('annual');
    document.getElementById('plan-modal').classList.remove('hidden');
}

function closePlanModal() {
    document.getElementById('plan-modal').classList.add('hidden');
    currentPlanId = null;
}

function updateInstallmentPreview() {
    const annualPrice = parseFloat(document.getElementById('plan-annual-price').value);
    const installments = parseInt(document.getElementById('plan-installments').value);
    const preview = document.getElementById('installment-preview');

    if (!annualPrice || !installments) {
        preview.classList.add('hidden');
        return;
    }

    const perInstallment = (annualPrice / installments).toFixed(2);
    const frequencyMap = {
        1: 'Annuale (pagamento unico)',
        2: 'Ogni 6 mesi',
        3: 'Ogni 4 mesi',
        4: 'Trimestrale',
        6: 'Bimestrale',
        12: 'Mensile'
    };

    document.getElementById('per-installment-amount').textContent = `‚Ç¨${perInstallment}`;
    document.getElementById('payment-frequency').textContent = frequencyMap[installments];
    preview.classList.remove('hidden');
}

async function editPlan(planId) {
    try {
        const response = await fetch('/api/owner/subscription-plans', {
            credentials: 'include'
        });
        const plans = await response.json();
        const plan = plans.find(p => p.id === planId);

        if (!plan) throw new Error('Piano non trovato');

        currentPlanId = planId;
        document.getElementById('plan-id').value = planId;
        document.getElementById('plan-modal-title').textContent = 'Modifica Piano di Abbonamento';
        document.getElementById('plan-submit-btn').textContent = 'Aggiorna Piano';
        document.getElementById('plan-name').value = plan.name;
        document.getElementById('plan-description').value = plan.description || '';

        const bt = plan.billing_type || 'annual';
        setBillingType(bt);
        if (bt === 'monthly') {
            document.getElementById('plan-monthly-price').value = plan.price;
        } else {
            document.getElementById('plan-annual-price').value = plan.annual_price || plan.price;
            document.getElementById('plan-installments').value = plan.installment_count || 1;
            updateInstallmentPreview();
        }

        document.getElementById('plan-trial').value = plan.trial_period_days || 0;
        document.getElementById('plan-features').value = plan.features ? plan.features.join('\n') : '';
        document.getElementById('plan-modal').classList.remove('hidden');
    } catch (error) {
        console.error('Error loading plan:', error);
        showToast('Impossibile caricare i dettagli del piano', 'error');
    }
}

async function deletePlan(planId, planName) {
    if (!confirm(`Sei sicuro di voler eliminare il piano "${planName}"? Questa azione non pu√≤ essere annullata.`)) {
        return;
    }

    try {
        const response = await fetch(`/api/owner/subscription-plans/${planId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Impossibile eliminare il piano');
        }

        showToast('Piano eliminato con successo', 'success');
        loadSubscriptionPlans();
    } catch (error) {
        console.error('Error deleting plan:', error);
        showToast(error.message, 'error');
    }
}

// Handle form submission
let planFormSubmitting = false;
const planForm = document.getElementById('plan-form');
if (planForm) {
    planForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (planFormSubmitting) return;
        planFormSubmitting = true;
        const submitBtn = document.getElementById('plan-submit-btn');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Salvando...';

        const features = document.getElementById('plan-features').value
            .split('\n')
            .map(f => f.trim())
            .filter(f => f.length > 0);

        const billingType = document.getElementById('plan-billing-type').value;
        const planData = {
            name: document.getElementById('plan-name').value,
            description: document.getElementById('plan-description').value,
            billing_type: billingType,
            features: features,
            trial_period_days: parseInt(document.getElementById('plan-trial').value) || 0
        };

        if (billingType === 'monthly') {
            const mp = parseFloat(document.getElementById('plan-monthly-price').value);
            if (!mp || mp <= 0) {
                showToast('Inserisci un prezzo mensile valido', 'error');
                return;
            }
            planData.monthly_price = mp;
        } else {
            const ap = parseFloat(document.getElementById('plan-annual-price').value);
            if (!ap || ap <= 0) {
                showToast('Inserisci un prezzo annuale valido', 'error');
                return;
            }
            planData.annual_price = ap;
            planData.installment_count = parseInt(document.getElementById('plan-installments').value);
        }

        console.log('Submitting plan:', JSON.stringify(planData));

        try {
            const url = currentPlanId
                ? `/api/owner/subscription-plans/${currentPlanId}`
                : '/api/owner/subscription-plans';

            const method = currentPlanId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(planData)
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Plan save error:', response.status, errorText);
                try {
                    const error = JSON.parse(errorText);
                    throw new Error(error.detail || 'Impossibile salvare il piano');
                } catch(e) {
                    if (e.message.includes('Impossibile')) throw e;
                    throw new Error(`Errore server (${response.status})`);
                }
            }

            showToast(currentPlanId ? 'Piano aggiornato con successo' : 'Piano creato con successo', 'success');
            closePlanModal();
            loadSubscriptionPlans();
        } catch (error) {
            console.error('Error saving plan:', error);
            showToast(error.message, 'error');
        } finally {
            planFormSubmitting = false;
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    });
}

// Close modal on background click
const planModal = document.getElementById('plan-modal');
if (planModal) {
    planModal.addEventListener('click', (e) => {
        if (e.target.id === 'plan-modal') {
            closePlanModal();
        }
    });
}

// --- PROMOTIONAL OFFERS FUNCTIONS ---

let currentOfferId = null;
let availablePlansForOffer = [];

async function loadOffers() {
    try {
        const response = await fetch('/api/owner/offers', {
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Impossibile caricare le offerte');

        const offers = await response.json();
        displayOffers(offers);
    } catch (error) {
        console.error('Error loading offers:', error);
    }
}

function displayOffers(offers) {
    const container = document.getElementById('offers-list');
    if (!container) return;

    if (!offers || offers.length === 0) {
        container.innerHTML = `
            <div class="glass-card p-3 text-center text-gray-400 text-sm">
                Nessuna offerta. Crea offerte per attirare clienti!
            </div>
        `;
        return;
    }

    container.innerHTML = offers.map(offer => {
        const discountText = offer.discount_type === 'percent'
            ? `${offer.discount_value}%`
            : `‚Ç¨${offer.discount_value}`;
        const statusColor = offer.is_active ? 'green' : 'yellow';
        const statusText = offer.is_active ? 'Attivo' : 'Bozza';
        const expiryDate = offer.expires_at ? new Date(offer.expires_at).toLocaleDateString() : null;

        return `
            <div class="glass-card overflow-hidden ${!offer.is_active ? 'border border-yellow-500/20' : ''}">
                <div class="p-4">
                    <div class="flex gap-4">
                        <!-- Discount badge -->
                        <div class="flex-shrink-0 w-16 h-16 rounded-xl bg-gradient-to-br from-green-500/20 to-emerald-500/10 border border-green-500/20 flex flex-col items-center justify-center">
                            <span class="text-xl font-bold text-green-400">${discountText}</span>
                            <span class="text-[10px] uppercase tracking-wider text-green-400/70">sconto</span>
                        </div>

                        <!-- Title and info -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <h4 class="font-bold text-white leading-tight truncate">${offer.title}</h4>
                                <span class="text-[10px] px-1.5 py-0.5 rounded-full bg-${statusColor}-500/20 text-${statusColor}-400">${statusText}</span>
                            </div>
                            ${offer.description ? `<p class="text-xs text-gray-400 line-clamp-1 mb-1">${offer.description}</p>` : ''}
                            <div class="flex items-center gap-3 text-xs text-gray-500">
                                <span>${offer.discount_duration_months} mes${offer.discount_duration_months > 1 ? 'i' : 'e'}</span>
                                ${expiryDate ? `<span>¬∑ Fino al ${expiryDate}</span>` : ''}
                                ${offer.coupon_code ? `<span class="text-primary font-mono">${offer.coupon_code}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="px-4 py-3 bg-white/[0.02] border-t border-white/5 flex items-center justify-between">
                    ${!offer.is_active ? `
                        <span class="text-[10px] text-yellow-400/70"><i data-lucide="megaphone" class="w-3 h-3 inline-block align-middle"></i> L'attivazione notificher√† tutti i clienti</span>
                    ` : `
                        <span></span>
                    `}
                    <div class="flex items-center gap-2">
                        ${offer.is_active ? `
                            <button onclick="toggleOffer('${offer.id}', false)" class="p-2 rounded-lg hover:bg-yellow-500/10 text-yellow-400 hover:text-yellow-300 transition" title="Pausa">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </button>
                        ` : `
                            <button onclick="toggleOffer('${offer.id}', true)" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-green-500/20 hover:bg-green-500/30 text-green-400 text-xs font-semibold transition" title="Attiva e Notifica Clienti">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                                </svg>
                                Attiva
                            </button>
                        `}
                        <button onclick="deleteOffer('${offer.id}', '${offer.title.replace(/'/g, "\\'")}')" class="p-2 rounded-lg hover:bg-red-500/10 text-red-400 hover:text-red-300 transition" title="Elimina">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

async function openCreateOfferModal() {
    currentOfferId = null;
    document.getElementById('offer-id').value = '';
    document.getElementById('offer-modal-title').textContent = 'Crea Offerta Promozionale';
    document.getElementById('offer-submit-btn').textContent = 'Crea Offerta';

    // Reset form
    document.getElementById('offer-form').reset();

    // Load plans for dropdown
    await loadPlansForOfferDropdown();

    document.getElementById('offer-modal').classList.remove('hidden');
}

async function loadPlansForOfferDropdown() {
    const select = document.getElementById('offer-plan-id');
    if (!select) return;

    try {
        const response = await fetch('/api/owner/subscription-plans', {
            credentials: 'include'
        });

        if (response.ok) {
            availablePlansForOffer = await response.json();
            select.innerHTML = '<option value="">Tutti i Piani</option>' +
                availablePlansForOffer.map(p => `<option value="${p.id}">${p.name} - ‚Ç¨${p.price}/${p.billing_interval}</option>`).join('');
        }
    } catch (e) {
        console.error('Error loading plans for offer:', e);
    }
}

function closeOfferModal() {
    document.getElementById('offer-modal').classList.add('hidden');
    currentOfferId = null;
}

async function toggleOffer(offerId, isActive) {
    // Confirm activation (since it notifies all clients)
    if (isActive) {
        if (!confirm('Attivare questa offerta?\n\nTutti i clienti della palestra riceveranno una notifica su questa offerta.')) {
            return;
        }
    }

    try {
        const response = await fetch(`/api/owner/offers/${offerId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ is_active: isActive })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Impossibile aggiornare l\'offerta');
        }

        const result = await response.json();
        if (isActive && result.notifications_sent) {
            showToast('Offerta attivata! I clienti sono stati notificati', 'success');
        } else {
            showToast(isActive ? 'Offerta attivata' : 'Offerta in pausa', 'success');
        }
        loadOffers();
    } catch (error) {
        console.error('Error toggling offer:', error);
        showToast(error.message, 'error');
    }
}

async function deleteOffer(offerId, offerTitle) {
    if (!confirm(`Sei sicuro di voler eliminare l'offerta "${offerTitle}"?`)) {
        return;
    }

    try {
        const response = await fetch(`/api/owner/offers/${offerId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Impossibile eliminare l\'offerta');
        }

        showToast('Offerta eliminata con successo', 'success');
        loadOffers();
    } catch (error) {
        console.error('Error deleting offer:', error);
        showToast(error.message, 'error');
    }
}

// Offer form submission
const offerForm = document.getElementById('offer-form');
if (offerForm) {
    offerForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const offerData = {
            title: document.getElementById('offer-title').value,
            description: document.getElementById('offer-description').value,
            plan_id: document.getElementById('offer-plan-id').value || null,
            discount_type: document.getElementById('offer-discount-type').value,
            discount_value: parseFloat(document.getElementById('offer-discount-value').value),
            discount_duration_months: parseInt(document.getElementById('offer-duration').value) || 1,
            coupon_code: document.getElementById('offer-coupon').value.toUpperCase() || null,
            expires_at: document.getElementById('offer-expires').value ? new Date(document.getElementById('offer-expires').value).toISOString() : null,
            max_redemptions: document.getElementById('offer-max-uses').value ? parseInt(document.getElementById('offer-max-uses').value) : null
        };

        try {
            const response = await fetch('/api/owner/offers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(offerData)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Impossibile creare l\'offerta');
            }

            showToast('Offerta creata come bozza. Attiva per notificare i clienti.', 'success');
            closeOfferModal();
            loadOffers();
        } catch (error) {
            console.error('Error creating offer:', error);
            showToast(error.message, 'error');
        }
    });
}

// Close offer modal on background click
const offerModal = document.getElementById('offer-modal');
if (offerModal) {
    offerModal.addEventListener('click', (e) => {
        if (e.target.id === 'offer-modal') {
            closeOfferModal();
        }
    });
}

// --- STRIPE CONNECT FUNCTIONS ---

async function loadStripeConnectStatus() {
    const badge = document.getElementById('stripe-status-badge');
    const notConnected = document.getElementById('stripe-not-connected');
    const pending = document.getElementById('stripe-pending');
    const connected = document.getElementById('stripe-connected');

    if (!badge) return; // Not on settings page

    try {
        const response = await fetch('/api/owner/stripe-connect/status', {
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Impossibile verificare lo stato');

        const data = await response.json();

        // Hide all states first
        notConnected?.classList.add('hidden');
        pending?.classList.add('hidden');
        connected?.classList.add('hidden');

        if (!data.connected) {
            // Not connected
            badge.textContent = 'Non Configurato';
            badge.className = 'text-xs px-2 py-1 rounded-full bg-red-500/20 text-red-400';
            notConnected?.classList.remove('hidden');
        } else if (data.can_receive_payments) {
            // Fully connected
            badge.textContent = 'Attivo';
            badge.className = 'text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-400';
            connected?.classList.remove('hidden');
        } else {
            // Pending verification
            badge.textContent = 'In Attesa';
            badge.className = 'text-xs px-2 py-1 rounded-full bg-yellow-500/20 text-yellow-400';
            pending?.classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error loading Stripe status:', error);
        badge.textContent = 'Errore';
        badge.className = 'text-xs px-2 py-1 rounded-full bg-red-500/20 text-red-400';
        notConnected?.classList.remove('hidden');
    }
}

async function startStripeConnect() {
    try {
        const response = await fetch('/api/owner/stripe-connect/onboard', {
            method: 'POST',
            credentials: 'include'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Impossibile avviare la configurazione');
        }

        const data = await response.json();

        if (data.onboarding_url) {
            // Redirect to Stripe onboarding
            window.location.href = data.onboarding_url;
        } else {
            alert('Impossibile ottenere il link di registrazione');
        }
    } catch (error) {
        console.error('Error starting Stripe Connect:', error);
        alert('Errore: ' + error.message);
    }
}

async function openStripeDashboard() {
    try {
        const response = await fetch('/api/owner/stripe-connect/dashboard', {
            credentials: 'include'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Impossibile ottenere il link alla dashboard');
        }

        const data = await response.json();

        if (data.url) {
            window.open(data.url, '_blank');
        } else {
            alert('Impossibile ottenere il link della dashboard');
        }
    } catch (error) {
        console.error('Error opening Stripe dashboard:', error);
        alert('Errore: ' + error.message);
    }
}

// --- POS TERMINAL FUNCTIONS ---

async function loadTerminalStatus() {
    const badge = document.getElementById('terminal-status-badge');
    const sandboxBadge = document.getElementById('terminal-sandbox-badge');
    const needsConnect = document.getElementById('terminal-needs-connect');
    const noLocation = document.getElementById('terminal-no-location');
    const noReader = document.getElementById('terminal-no-reader');
    const registered = document.getElementById('terminal-registered');

    if (!badge) return;

    // Hide all states
    [needsConnect, noLocation, noReader, registered].forEach(el => el?.classList.add('hidden'));

    // Check test mode first
    let isTestMode = false;
    try {
        const tmRes = await fetch('/api/terminal/test-mode', { credentials: 'include' });
        if (tmRes.ok) {
            const tmData = await tmRes.json();
            isTestMode = tmData.is_test_mode;
        }
    } catch (_) {}

    if (isTestMode) {
        sandboxBadge?.classList.remove('hidden');
        // In test mode, skip the Connect check
    } else {
        sandboxBadge?.classList.add('hidden');
        // Check if Stripe Connect is active first
        const connectBadge = document.getElementById('stripe-status-badge');
        if (connectBadge && connectBadge.textContent.trim() !== 'Attivo') {
            badge.textContent = 'Richiede Pagamenti';
            badge.className = 'text-xs px-2 py-1 rounded-full bg-gray-500/20 text-gray-400';
            needsConnect?.classList.remove('hidden');
            return;
        }
    }

    try {
        const res = await fetch('/api/terminal/readers', { credentials: 'include' });
        if (!res.ok) throw new Error('Impossibile verificare il terminale');

        const data = await res.json();

        if (data.readers && data.readers.length > 0) {
            const reader = data.readers[0];
            badge.textContent = reader.status === 'online' ? 'Online' : 'Registrato';
            badge.className = reader.status === 'online'
                ? 'text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-400'
                : 'text-xs px-2 py-1 rounded-full bg-yellow-500/20 text-yellow-400';
            document.getElementById('terminal-reader-label').textContent = reader.label || 'Lettore';
            document.getElementById('terminal-reader-status').textContent =
                isTestMode
                    ? `Simulato ‚Äî ${reader.status}`
                    : `${reader.device_type || 'Reader'} ‚Äî ${reader.status}`;
            registered?.classList.remove('hidden');
        } else {
            badge.textContent = 'Non Configurato';
            badge.className = 'text-xs px-2 py-1 rounded-full bg-gray-500/20 text-gray-400';
            noLocation?.classList.remove('hidden');
        }
        // Show sandbox simulated reader button if applicable
        if (isTestMode) {
            document.getElementById('terminal-simulated-btn')?.classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error loading terminal status:', error);
        badge.textContent = 'Non Configurato';
        badge.className = 'text-xs px-2 py-1 rounded-full bg-gray-500/20 text-gray-400';
        noLocation?.classList.remove('hidden');
    }
}

async function setupTerminalLocation() {
    const line1 = document.getElementById('terminal-address-line1')?.value.trim();
    const city = document.getElementById('terminal-address-city')?.value.trim();
    const postal = document.getElementById('terminal-address-postal')?.value.trim();
    const country = document.getElementById('terminal-address-country')?.value;
    const state = document.getElementById('terminal-address-state')?.value.trim();

    if (!line1 || !city || !postal) {
        showToast('Compila indirizzo, citt√† e CAP', 'error');
        return;
    }

    const addrPayload = { line1, city, postal_code: postal, country };
    if (state) addrPayload.state = state;

    try {
        const res = await fetch('/api/terminal/create-location', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ address: addrPayload })
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || 'Impossibile creare la sede');
        }

        showToast('Posizione terminale creata!', 'success');
        // Show register reader step
        document.getElementById('terminal-no-location')?.classList.add('hidden');
        document.getElementById('terminal-no-reader')?.classList.remove('hidden');
        _showSimulatedReaderBtnIfTestMode();
    } catch (error) {
        console.error('Error creating terminal location:', error);
        showToast('Errore: ' + error.message, 'error');
    }
}

async function _showSimulatedReaderBtnIfTestMode() {
    try {
        const res = await fetch('/api/terminal/test-mode', { credentials: 'include' });
        if (res.ok) {
            const d = await res.json();
            document.getElementById('terminal-simulated-btn')?.classList.toggle('hidden', !d.is_test_mode);
        }
    } catch (_) {}
}

async function registerTerminalReader() {
    const code = document.getElementById('terminal-reg-code')?.value.trim();
    const label = document.getElementById('terminal-label')?.value.trim() || 'Reception';

    if (!code) {
        showToast('Inserisci il codice di registrazione dallo schermo del lettore', 'error');
        return;
    }

    try {
        const res = await fetch('/api/terminal/register-reader', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ registration_code: code, label })
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || 'Impossibile registrare il lettore');
        }

        showToast('Lettore POS registrato!', 'success');
        loadTerminalStatus();
    } catch (error) {
        console.error('Error registering reader:', error);
        showToast('Errore: ' + error.message, 'error');
    }
}

function setReaderTab(tab) {
    const codeTab = document.getElementById('reader-tab-code');
    const idTab = document.getElementById('reader-tab-id');
    const btnCode = document.getElementById('tab-code');
    const btnId = document.getElementById('tab-id');
    if (tab === 'code') {
        codeTab?.classList.remove('hidden');
        idTab?.classList.add('hidden');
        btnCode?.classList.add('bg-white/10', 'text-white');
        btnCode?.classList.remove('text-gray-400');
        btnId?.classList.remove('bg-white/10', 'text-white');
        btnId?.classList.add('text-gray-400');
    } else {
        idTab?.classList.remove('hidden');
        codeTab?.classList.add('hidden');
        btnId?.classList.add('bg-white/10', 'text-white');
        btnId?.classList.remove('text-gray-400');
        btnCode?.classList.remove('bg-white/10', 'text-white');
        btnCode?.classList.add('text-gray-400');
    }
}

async function importExistingReader() {
    const readerId = document.getElementById('terminal-reader-id')?.value.trim();
    if (!readerId || !readerId.startsWith('tmr_')) {
        showToast('Inserisci un ID lettore valido (inizia con tmr_)', 'error');
        return;
    }
    try {
        const res = await fetch('/api/terminal/import-reader', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ reader_id: readerId })
        });
        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || 'Impossibile collegare il lettore');
        }
        showToast('Lettore collegato!', 'success');
        loadTerminalStatus();
    } catch (error) {
        console.error('Error importing reader:', error);
        showToast('Errore: ' + error.message, 'error');
    }
}

async function registerSimulatedReader() {
    const label = document.getElementById('terminal-label')?.value.trim() || 'Reception (Simulato)';
    try {
        const res = await fetch('/api/terminal/register-reader', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ registration_code: 'simulated', label })
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || 'Impossibile creare il lettore simulato');
        }

        showToast('Lettore simulato creato!', 'success');
        loadTerminalStatus();
    } catch (error) {
        console.error('Error creating simulated reader:', error);
        showToast('Errore: ' + error.message, 'error');
    }
}

// --- GYM CODE FUNCTIONS ---

async function loadGymCode() {
    try {
        const response = await fetch('/api/owner/gym-code', {
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Impossibile caricare il codice palestra');

        const data = await response.json();
        const gymCodeEl = document.getElementById('gym-code-display');
        if (gymCodeEl) {
            gymCodeEl.textContent = data.gym_code || '------';
        }
    } catch (error) {
        console.error('Error loading gym code:', error);
    }
}

// --- GYM SETTINGS FUNCTIONS ---

async function loadGymSettings() {
    try {
        const response = await fetch('/api/owner/gym-settings', { credentials: 'include' });
        if (!response.ok) return;
        const data = await response.json();

        // Gym name
        const nameDisplay = document.getElementById('gym-name-display');
        if (nameDisplay && data.gym_name) {
            nameDisplay.textContent = data.gym_name;
            const h1 = document.getElementById('gym-name-owner');
            const desktopName = document.getElementById('desktop-gym-name');
            if (h1) h1.textContent = data.gym_name;
            if (desktopName) desktopName.textContent = data.gym_name;
        }

        // Gym logo
        if (data.gym_logo) {
            const preview = document.getElementById('gym-logo-preview');
            const placeholder = document.getElementById('gym-logo-placeholder');
            if (preview && placeholder) {
                placeholder.style.display = 'none';
                // Remove old img if any
                const oldImg = preview.querySelector('img');
                if (oldImg) oldImg.remove();
                const img = document.createElement('img');
                img.src = data.gym_logo + '?t=' + Date.now();
                img.className = 'w-full h-full object-cover';
                preview.appendChild(img);
            }
            const deleteBtn = document.getElementById('delete-logo-btn');
            if (deleteBtn) deleteBtn.classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error loading gym settings:', error);
    }
}

function openGymNameModal() {
    const current = document.getElementById('gym-name-display').textContent;
    document.getElementById('gym-name-new').value = current === '‚Äî' ? '' : current;
    document.getElementById('gym-name-password').value = '';
    document.getElementById('gym-name-modal').classList.remove('hidden');
    setTimeout(() => document.getElementById('gym-name-new').focus(), 100);
}

function closeGymNameModal() {
    document.getElementById('gym-name-modal').classList.add('hidden');
}

async function confirmGymNameEdit() {
    const newName = document.getElementById('gym-name-new').value.trim();
    const password = document.getElementById('gym-name-password').value;
    if (!newName) { if (typeof showToast === 'function') showToast('Inserisci un nome per la palestra', 'error'); return; }
    if (!password) { if (typeof showToast === 'function') showToast('Inserisci la tua password', 'error'); return; }

    try {
        const response = await fetch('/api/owner/gym-settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ gym_name: newName, password: password })
        });
        if (response.ok) {
            if (typeof showToast === 'function') showToast('Nome palestra salvato!', 'success');
            document.getElementById('gym-name-display').textContent = newName;
            const h1 = document.getElementById('gym-name-owner');
            const desktopName = document.getElementById('desktop-gym-name');
            if (h1) h1.textContent = newName;
            if (desktopName) desktopName.textContent = newName;
            closeGymNameModal();
        } else {
            const data = await response.json();
            if (typeof showToast === 'function') showToast(data.detail || 'Impossibile salvare', 'error');
        }
    } catch (error) {
        console.error('Error saving gym name:', error);
        if (typeof showToast === 'function') showToast('Impossibile salvare il nome della palestra', 'error');
    }
}

async function uploadGymLogo(input) {
    if (!input.files[0]) return;
    const formData = new FormData();
    formData.append('file', input.files[0]);

    try {
        const response = await fetch('/api/owner/gym-logo', {
            method: 'POST',
            credentials: 'include',
            body: formData
        });
        if (response.ok) {
            const data = await response.json();
            if (data.gym_logo) {
                const preview = document.getElementById('gym-logo-preview');
                const placeholder = document.getElementById('gym-logo-placeholder');
                if (preview && placeholder) {
                    placeholder.style.display = 'none';
                    const oldImg = preview.querySelector('img');
                    if (oldImg) oldImg.remove();
                    const img = document.createElement('img');
                    img.src = data.gym_logo;
                    img.className = 'w-full h-full object-cover';
                    preview.appendChild(img);
                }
                const deleteBtn = document.getElementById('delete-logo-btn');
                if (deleteBtn) deleteBtn.classList.remove('hidden');
            }
            if (typeof showToast === 'function') showToast('Logo aggiornato!', 'success');
        }
    } catch (error) {
        console.error('Error uploading logo:', error);
        if (typeof showToast === 'function') showToast('Impossibile caricare il logo', 'error');
    }
    input.value = '';
}

async function deleteGymLogo() {
    try {
        const response = await fetch('/api/owner/gym-logo', {
            method: 'DELETE',
            credentials: 'include'
        });
        if (response.ok) {
            const preview = document.getElementById('gym-logo-preview');
            const placeholder = document.getElementById('gym-logo-placeholder');
            if (preview && placeholder) {
                const oldImg = preview.querySelector('img');
                if (oldImg) oldImg.remove();
                placeholder.style.display = '';
            }
            const deleteBtn = document.getElementById('delete-logo-btn');
            if (deleteBtn) deleteBtn.classList.add('hidden');
            if (typeof showToast === 'function') showToast('Logo rimosso', 'success');
        }
    } catch (error) {
        console.error('Error deleting logo:', error);
    }
}

function copyGymCode() {
    const codeEl = document.getElementById('gym-code-display');
    if (!codeEl) return;

    const code = codeEl.textContent;
    if (code === '------') return;

    function onCopySuccess() {
        const copyIcon = document.getElementById('copy-icon');
        const copyText = document.getElementById('copy-text');
        if (copyIcon && copyText) {
            const origIcon = copyIcon.innerHTML;
            const origText = copyText.textContent;
            copyIcon.textContent = '‚úì';
            copyText.textContent = 'Copiato!';
            setTimeout(() => { copyIcon.innerHTML = origIcon; copyText.textContent = origText; }, 2000);
        }
        if (typeof showToast === 'function') showToast('Codice palestra copiato negli appunti!', 'success');
    }

    // navigator.clipboard requires HTTPS; fallback for HTTP/LAN
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(code).then(onCopySuccess).catch(() => fallbackCopy(code));
    } else {
        fallbackCopy(code);
    }

    function fallbackCopy(text) {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.cssText = 'position:fixed;left:-9999px';
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand('copy'); onCopySuccess(); }
        catch(e) { if (typeof showToast === 'function') showToast('Impossibile copiare il codice', 'error'); }
        document.body.removeChild(ta);
    }
}

// --- TRAINER APPROVAL FUNCTIONS ---

async function loadPendingTrainers() {
    try {
        const response = await fetch('/api/owner/pending-trainers', {
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Impossibile caricare i trainer in attesa');

        const trainers = await response.json();
        displayPendingTrainers(trainers);
    } catch (error) {
        console.error('Error loading pending trainers:', error);
    }
}

function displayPendingTrainers(trainers) {
    const section = document.getElementById('pending-trainers-section');
    const list = document.getElementById('pending-trainers-list');
    if (!list) return;

    if (!trainers || trainers.length === 0) {
        // In dashboard mode, hide the section if empty
        if (section) {
            section.classList.add('hidden');
        }
        return;
    }

    if (section) {
        section.classList.remove('hidden');
    }

    // Helper to get role display label
    function getRoleLabel(user) {
        if (user.role === 'staff') return 'Staff';
        if (user.sub_role === 'nutritionist') return 'Nutritionist';
        if (user.sub_role === 'both') return 'Trainer & Nutritionist';
        return 'Trainer';
    }

    // Helper to get role badge color
    function getRoleBadgeClass(user) {
        if (user.role === 'staff') return 'bg-blue-500/20 text-blue-400';
        if (user.sub_role === 'nutritionist') return 'bg-green-500/20 text-green-400';
        if (user.sub_role === 'both') return 'bg-purple-500/20 text-purple-400';
        return 'bg-orange-500/20 text-orange-400';
    }

    list.innerHTML = trainers.map(trainer => {
        const initials = trainer.username.substring(0, 2).toUpperCase();
        return `
        <div class="glass-card overflow-hidden border border-yellow-500/20">
            <div class="p-4">
                <div class="flex items-center gap-3">
                    <!-- Avatar -->
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-yellow-500/30 to-orange-500/20 border border-yellow-500/30 flex items-center justify-center flex-shrink-0">
                        <span class="text-base font-bold text-yellow-400">${initials}</span>
                    </div>

                    <!-- Info -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-0.5">
                            <h4 class="font-bold text-white">${trainer.username}</h4>
                            <span class="text-xs px-2 py-0.5 rounded-full ${getRoleBadgeClass(trainer)}">${getRoleLabel(trainer)}</span>
                        </div>
                        <p class="text-sm text-gray-400 truncate">${trainer.email || 'Nessuna email'}</p>
                    </div>

                    <!-- Pending badge -->
                    <div class="flex items-center gap-1.5">
                        <span class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></span>
                        <span class="text-xs text-yellow-400">In Attesa</span>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex gap-2 mt-4">
                    <button onclick="approveTrainer('${trainer.id}')"
                        class="flex-1 bg-green-500/20 hover:bg-green-500/30 text-green-400 py-2.5 rounded-xl text-sm font-bold transition flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Approva
                    </button>
                    <button onclick="rejectTrainer('${trainer.id}', '${trainer.username}')"
                        class="flex-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 py-2.5 rounded-xl text-sm font-bold transition flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        Rifiuta
                    </button>
                </div>
            </div>
        </div>
    `}).join('');
}

async function loadApprovedTrainers() {
    try {
        const response = await fetch('/api/owner/approved-trainers', {
            credentials: 'include'
        });

        if (!response.ok) {
            const list = document.getElementById('approved-trainers-list');
            if (list) {
                list.innerHTML = `
                    <div class="glass-card p-8 text-center">
                        <div class="w-16 h-16 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                        </div>
                        <p class="text-gray-400 text-sm">Nessun trainer attivo</p>
                        <p class="text-gray-500 text-xs mt-1">Condividi il codice palestra per invitare trainer</p>
                    </div>
                `;
            }
            return;
        }

        const trainers = await response.json();
        displayApprovedTrainers(trainers);
        displayDashboardTrainers(trainers);
    } catch (error) {
        console.error('Error loading approved trainers:', error);
        const list = document.getElementById('approved-trainers-list');
        if (list) {
            list.innerHTML = `
                <div class="glass-card p-3 text-center text-gray-400 text-sm">
                    Nessun trainer attivo
                </div>
            `;
        }
        // Also update dashboard list on error
        const dashList = document.getElementById('dashboard-trainers-list');
        if (dashList) {
            dashList.innerHTML = `
                <div class="glass-card p-3 text-center text-gray-400 text-sm">
                    Nessun trainer
                </div>
            `;
        }
    }
}

function displayApprovedTrainers(trainers) {
    const list = document.getElementById('approved-trainers-list');
    if (!list) return;

    if (!trainers || trainers.length === 0) {
        list.innerHTML = `
            <div class="glass-card p-3 text-center text-gray-400 text-sm">
                No active trainers yet
            </div>
        `;
        return;
    }

    list.innerHTML = trainers.map(trainer => {
        const initials = trainer.username.substring(0, 2).toUpperCase();
        const clientCount = trainer.client_count || 0;
        return `
        <div class="glass-card overflow-hidden">
            <div class="p-4">
                <div class="flex items-center gap-3">
                    <!-- Avatar -->
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary/30 to-orange-500/20 border border-primary/30 flex items-center justify-center flex-shrink-0">
                        <span class="text-base font-bold text-primary">${initials}</span>
                    </div>

                    <!-- Info -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between mb-0.5">
                            <h4 class="font-bold text-white">${trainer.username}</h4>
                            <div class="flex items-center gap-1.5">
                                <span class="w-2 h-2 rounded-full bg-green-400"></span>
                                <span class="text-xs text-green-400">Attivo</span>
                            </div>
                        </div>
                        <p class="text-sm text-gray-400 truncate">${trainer.email || 'Nessuna email'}</p>
                    </div>

                    <!-- Client count -->
                    <div class="text-right pl-2">
                        <p class="text-xl font-bold text-primary">${clientCount}</p>
                        <p class="text-xs text-gray-500">clienti</p>
                    </div>
                </div>
            </div>
        </div>
    `}).join('');
}

function displayDashboardTrainers(trainers) {
    const list = document.getElementById('dashboard-trainers-list');
    if (!list) return;

    if (!trainers || trainers.length === 0) {
        list.innerHTML = `
            <div class="glass-card p-3 text-center text-gray-400 text-sm">
                <p>No trainers yet</p>
                <p class="text-xs mt-1">Condividi il codice palestra per invitare trainer</p>
            </div>
        `;
        return;
    }

    // Show up to 5 trainers in compact format
    const displayTrainers = trainers.slice(0, 5);
    const totalClients = trainers.reduce((sum, t) => sum + (t.client_count || 0), 0);

    list.innerHTML = `
        <div class="glass-card p-3 mb-2">
            <div class="flex justify-between items-center text-sm">
                <span class="text-gray-400">Staff Totale</span>
                <span class="font-bold text-white">${trainers.length}</span>
            </div>
            <div class="flex justify-between items-center text-sm mt-1">
                <span class="text-gray-400">Gestisce</span>
                <span class="font-bold text-primary">${totalClients} clienti</span>
            </div>
        </div>
        ${displayTrainers.map(trainer => {
            const initials = trainer.username.substring(0, 2).toUpperCase();
            const clientCount = trainer.client_count || 0;
            return `
            <div class="flex items-center gap-2 p-2 rounded-lg bg-white/5 hover:bg-white/10 transition">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-primary/30 to-orange-500/20 border border-primary/30 flex items-center justify-center flex-shrink-0">
                    <span class="text-xs font-bold text-primary">${initials}</span>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-white truncate">${trainer.username}</p>
                </div>
                <div class="flex items-center gap-1">
                    <span class="text-sm font-bold text-primary">${clientCount}</span>
                    <span class="text-xs text-gray-500">${icon('users', 12)}</span>
                </div>
            </div>
        `}).join('')}
        ${trainers.length > 5 ? `
            <button onclick="openTrainersModal()" class="block w-full text-center text-xs text-primary hover:text-primary/80 transition mt-2">
                +${trainers.length - 5} altri trainer
            </button>
        ` : ''}
    `;
}

// --- TRAINERS MODAL FUNCTIONS ---

let cachedTrainers = [];
let cachedPendingTrainers = [];

function openTrainersModal() {
    document.getElementById('trainers-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    loadTrainersForModal();
}

function closeTrainersModal() {
    document.getElementById('trainers-modal').classList.add('hidden');
    document.body.style.overflow = '';
}

async function loadTrainersForModal() {
    // Load both pending and approved trainers
    try {
        const [pendingRes, approvedRes] = await Promise.all([
            fetch('/api/owner/pending-trainers', { credentials: 'include' }),
            fetch('/api/owner/approved-trainers', { credentials: 'include' })
        ]);

        if (pendingRes.ok) {
            cachedPendingTrainers = await pendingRes.json();
            displayModalPendingTrainers(cachedPendingTrainers);
        }

        if (approvedRes.ok) {
            cachedTrainers = await approvedRes.json();
            displayModalApprovedTrainers(cachedTrainers);
        }
    } catch (error) {
        console.error('Error loading trainers for modal:', error);
    }
}

function displayModalPendingTrainers(trainers) {
    const section = document.getElementById('modal-pending-section');
    const container = document.getElementById('modal-pending-trainers');
    if (!section || !container) return;

    if (!trainers || trainers.length === 0) {
        section.classList.add('hidden');
        return;
    }

    section.classList.remove('hidden');

    function getRoleLabel(user) {
        if (user.role === 'staff') return 'Staff';
        if (user.sub_role === 'nutritionist') return 'Nutritionist';
        if (user.sub_role === 'both') return 'Trainer & Nutritionist';
        return 'Trainer';
    }

    function getRoleBadgeClass(user) {
        if (user.role === 'staff') return 'bg-blue-500/20 text-blue-400';
        if (user.sub_role === 'nutritionist') return 'bg-green-500/20 text-green-400';
        if (user.sub_role === 'both') return 'bg-purple-500/20 text-purple-400';
        return 'bg-orange-500/20 text-orange-400';
    }

    container.innerHTML = trainers.map(trainer => {
        const initials = trainer.username.substring(0, 2).toUpperCase();
        return `
        <div class="glass-card p-3 border border-yellow-500/20">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-yellow-500/30 to-orange-500/20 border border-yellow-500/30 flex items-center justify-center flex-shrink-0">
                    <span class="text-sm font-bold text-yellow-400">${initials}</span>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2">
                        <h4 class="font-semibold text-white text-sm">${trainer.username}</h4>
                        <span class="text-[10px] px-1.5 py-0.5 rounded-full ${getRoleBadgeClass(trainer)}">${getRoleLabel(trainer)}</span>
                    </div>
                    <p class="text-xs text-gray-400 truncate">${trainer.email || 'Nessuna email'}</p>
                </div>
                <div class="flex gap-1.5">
                    <button onclick="approveTrainerFromModal('${trainer.id}')"
                        class="w-8 h-8 rounded-lg bg-green-500/20 hover:bg-green-500/30 text-green-400 flex items-center justify-center transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    </button>
                    <button onclick="rejectTrainerFromModal('${trainer.id}', '${trainer.username}')"
                        class="w-8 h-8 rounded-lg bg-red-500/20 hover:bg-red-500/30 text-red-400 flex items-center justify-center transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    `}).join('');
}

function displayModalApprovedTrainers(trainers) {
    const container = document.getElementById('modal-approved-trainers');
    if (!container) return;

    if (!trainers || trainers.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-400 text-sm py-4">
                <p>No active trainers yet</p>
                <p class="text-xs mt-1">Condividi il codice palestra per invitare trainer</p>
            </div>
        `;
        return;
    }

    container.innerHTML = trainers.map(trainer => {
        const initials = trainer.username.substring(0, 2).toUpperCase();
        const clientCount = trainer.client_count || 0;
        return `
        <div class="flex items-center gap-3 p-3 rounded-xl bg-white/5 hover:bg-white/10 transition">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary/30 to-orange-500/20 border border-primary/30 flex items-center justify-center flex-shrink-0">
                <span class="text-sm font-bold text-primary">${initials}</span>
            </div>
            <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2">
                    <h4 class="font-semibold text-white text-sm">${trainer.username}</h4>
                    <span class="w-1.5 h-1.5 rounded-full bg-green-400"></span>
                </div>
                <p class="text-xs text-gray-400 truncate">${trainer.email || 'Nessuna email'}</p>
            </div>
            <div class="text-right">
                <p class="text-lg font-bold text-primary">${clientCount}</p>
                <p class="text-[10px] text-gray-500">clienti</p>
            </div>
        </div>
    `}).join('');
}

async function approveTrainerFromModal(trainerId) {
    try {
        const response = await fetch(`/api/owner/approve-trainer/${trainerId}`, {
            method: 'POST',
            credentials: 'include'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Impossibile approvare il trainer');
        }

        if (typeof showToast === 'function') {
            showToast('Trainer approvato!', 'success');
        }
        loadTrainersForModal();
        loadApprovedTrainers(); // Update dashboard
        loadPendingTrainers(); // Update dashboard pending section
    } catch (error) {
        console.error('Error approving trainer:', error);
        if (typeof showToast === 'function') {
            showToast(error.message, 'error');
        }
    }
}

async function rejectTrainerFromModal(trainerId, username) {
    if (!confirm(`Sei sicuro di voler rifiutare ${username}?`)) {
        return;
    }

    try {
        const response = await fetch(`/api/owner/reject-trainer/${trainerId}`, {
            method: 'POST',
            credentials: 'include'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Impossibile rifiutare il trainer');
        }

        if (typeof showToast === 'function') {
            showToast('Trainer rifiutato', 'success');
        }
        loadTrainersForModal();
        loadPendingTrainers(); // Update dashboard pending section
    } catch (error) {
        console.error('Error rejecting trainer:', error);
        if (typeof showToast === 'function') {
            showToast(error.message, 'error');
        }
    }
}

// copyGymCode() defined above in main script section

// Close modal on backdrop click
document.getElementById('trainers-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeTrainersModal();
    }
});

async function approveTrainer(trainerId) {
    try {
        const response = await fetch(`/api/owner/approve-trainer/${trainerId}`, {
            method: 'POST',
            credentials: 'include'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Impossibile approvare il trainer');
        }

        if (typeof showToast === 'function') {
            showToast('Trainer approvato con successo!', 'success');
        }
        loadPendingTrainers();
        loadApprovedTrainers(); // Update dashboard team overview
    } catch (error) {
        console.error('Error approving trainer:', error);
        if (typeof showToast === 'function') {
            showToast(error.message, 'error');
        }
    }
}

async function rejectTrainer(trainerId, username) {
    if (!confirm(`Sei sicuro di voler rifiutare ${username}? Dovr√† registrarsi di nuovo.`)) {
        return;
    }

    try {
        const response = await fetch(`/api/owner/reject-trainer/${trainerId}`, {
            method: 'POST',
            credentials: 'include'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Impossibile rifiutare il trainer');
        }

        if (typeof showToast === 'function') {
            showToast('Trainer rifiutato', 'success');
        }
        loadPendingTrainers();
    } catch (error) {
        console.error('Error rejecting trainer:', error);
        if (typeof showToast === 'function') {
            showToast(error.message, 'error');
        }
    }
}

// --- AUTOMATED MESSAGES FUNCTIONS ---

let currentTemplateId = null;

async function loadTemplates() {
    try {
        const response = await fetch('/api/owner/automated-messages', {
            credentials: 'include'
        });
        if (!response.ok) throw new Error('Impossibile caricare i modelli');
        const templates = await response.json();
        displayTemplates(templates);
    } catch (error) {
        console.error('Error loading templates:', error);
        const container = document.getElementById('templates-list');
        if (container) {
            container.innerHTML = `<div class="glass-card p-3 text-center text-red-400 text-sm">Impossibile caricare i modelli</div>`;
        }
    }
}

function displayTemplates(templates) {
    const container = document.getElementById('templates-list');
    if (!container) return;

    if (!templates || templates.length === 0) {
        container.innerHTML = `
            <div class="glass-card p-4 text-center text-gray-400 text-sm">
                Nessun messaggio automatico configurato. Crea il tuo primo modello per coinvolgere i clienti inattivi.
            </div>
        `;
        return;
    }

    const triggerLabels = {
        'missed_workout': 'Allenamento Mancato',
        'days_inactive': 'Giorni Inattivo',
        'no_show_appointment': 'Non Presentato'
    };

    container.innerHTML = templates.map(t => `
        <div class="glass-card p-4 ${t.is_enabled ? '' : 'opacity-50'}">
            <div class="flex justify-between items-start mb-2">
                <div class="flex-1">
                    <div class="flex items-center gap-2 flex-wrap">
                        <h4 class="font-bold">${escapeHtml(t.name)}</h4>
                        <span class="text-xs px-2 py-0.5 rounded-full ${t.is_enabled ? 'bg-green-500/20 text-green-400' : 'bg-gray-500/20 text-gray-400'}">
                            ${t.is_enabled ? 'Attivo' : 'Disattivato'}
                        </span>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Trigger: ${triggerLabels[t.trigger_type] || t.trigger_type}${t.trigger_type === 'days_inactive' && t.trigger_config ? ` (${t.trigger_config.days_threshold} days)` : ''}</p>
                </div>
                <div class="flex gap-2 flex-shrink-0">
                    <button onclick="toggleTemplate('${t.id}')" class="text-xs bg-white/10 px-2 py-1 rounded hover:bg-white/20 transition">
                        ${t.is_enabled ? 'Disattiva' : 'Attiva'}
                    </button>
                    <button onclick="editTemplate('${t.id}')" class="text-xs bg-white/10 px-2 py-1 rounded hover:bg-white/20 transition">
                        Modifica
                    </button>
                    <button onclick="deleteTemplate('${t.id}', '${escapeHtml(t.name)}')" class="text-xs bg-red-500/20 text-red-400 px-2 py-1 rounded hover:bg-red-500/30 transition">
                        Elimina
                    </button>
                </div>
            </div>
            <div class="mt-3 pt-3 border-t border-white/10">
                <p class="text-xs text-gray-400 line-clamp-2">${escapeHtml(t.message_template)}</p>
            </div>
            <div class="mt-2 flex gap-2">
                ${t.delivery_methods.includes('in_app') ? '<span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-0.5 rounded">In-App</span>' : ''}
                ${t.delivery_methods.includes('email') ? '<span class="text-xs bg-purple-500/20 text-purple-400 px-2 py-0.5 rounded">Email</span>' : ''}
                ${t.delivery_methods.includes('whatsapp') ? '<span class="text-xs bg-green-500/20 text-green-400 px-2 py-0.5 rounded">WhatsApp</span>' : ''}
            </div>
        </div>
    `).join('');
}

function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function openCreateTemplateModal() {
    currentTemplateId = null;
    document.getElementById('template-modal-title').textContent = 'Crea Messaggio Automatico';
    document.getElementById('template-submit-btn').textContent = 'Crea Modello';
    document.getElementById('template-form').reset();
    document.getElementById('template-id').value = '';
    document.getElementById('template-preview').classList.add('hidden');
    document.getElementById('delivery-in-app').checked = true;
    document.getElementById('template-enabled').checked = true;
    updateTriggerConfig();
    document.getElementById('template-modal').classList.remove('hidden');
}

function closeTemplateModal() {
    document.getElementById('template-modal').classList.add('hidden');
    currentTemplateId = null;
}

function updateTriggerConfig() {
    const trigger = document.getElementById('template-trigger').value;
    const configSection = document.getElementById('trigger-config-section');

    if (trigger === 'days_inactive') {
        configSection.classList.remove('hidden');
    } else {
        configSection.classList.add('hidden');
    }
}

function previewTemplate() {
    const message = document.getElementById('template-message').value;
    // Simple client-side preview with sample data
    const preview = message
        .replace(/{client_name}/g, 'John Doe')
        .replace(/{days_inactive}/g, '7')
        .replace(/{workout_title}/g, 'Push Day')
        .replace(/{trainer_name}/g, 'Mike');

    document.getElementById('preview-output').textContent = preview;
    document.getElementById('template-preview').classList.remove('hidden');
}

async function saveTemplate(event) {
    event.preventDefault();

    const templateId = document.getElementById('template-id').value;
    const isEdit = !!templateId;

    const deliveryMethods = [];
    if (document.getElementById('delivery-in-app').checked) deliveryMethods.push('in_app');
    if (document.getElementById('delivery-email').checked) deliveryMethods.push('email');
    if (document.getElementById('delivery-whatsapp').checked) deliveryMethods.push('whatsapp');

    const triggerType = document.getElementById('template-trigger').value;
    let triggerConfig = null;
    if (triggerType === 'days_inactive') {
        triggerConfig = {
            days_threshold: parseInt(document.getElementById('trigger-days-threshold').value) || 5
        };
    }

    const data = {
        name: document.getElementById('template-name').value,
        trigger_type: triggerType,
        trigger_config: triggerConfig,
        message_template: document.getElementById('template-message').value,
        delivery_methods: deliveryMethods,
        is_enabled: document.getElementById('template-enabled').checked
    };

    try {
        const url = isEdit
            ? `/api/owner/automated-messages/${templateId}`
            : '/api/owner/automated-messages';
        const method = isEdit ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Impossibile salvare il modello');
        }

        showToast(isEdit ? 'Modello aggiornato!' : 'Modello creato!', 'success');
        closeTemplateModal();
        loadTemplates();
    } catch (error) {
        showToast(error.message, 'error');
    }
}

async function editTemplate(templateId) {
    try {
        const response = await fetch(`/api/owner/automated-messages/${templateId}`, {
            credentials: 'include'
        });
        if (!response.ok) throw new Error('Impossibile caricare il modello');
        const template = await response.json();

        currentTemplateId = templateId;
        document.getElementById('template-id').value = templateId;
        document.getElementById('template-modal-title').textContent = 'Modifica Messaggio Automatico';
        document.getElementById('template-submit-btn').textContent = 'Salva Modifiche';

        document.getElementById('template-name').value = template.name;
        document.getElementById('template-trigger').value = template.trigger_type;
        document.getElementById('template-message').value = template.message_template;
        document.getElementById('template-enabled').checked = template.is_enabled;

        if (template.trigger_config && template.trigger_config.days_threshold) {
            document.getElementById('trigger-days-threshold').value = template.trigger_config.days_threshold;
        }

        document.getElementById('delivery-in-app').checked = template.delivery_methods.includes('in_app');

        updateTriggerConfig();
        document.getElementById('template-preview').classList.add('hidden');
        document.getElementById('template-modal').classList.remove('hidden');
    } catch (error) {
        showToast('Impossibile caricare il modello', 'error');
    }
}

async function toggleTemplate(templateId) {
    try {
        const response = await fetch(`/api/owner/automated-messages/${templateId}/toggle`, {
            method: 'POST',
            credentials: 'include'
        });
        if (!response.ok) throw new Error('Impossibile attivare/disattivare il modello');
        const template = await response.json();
        showToast(`Modello ${template.is_enabled ? 'attivato' : 'disattivato'}`, 'success');
        loadTemplates();
    } catch (error) {
        showToast('Impossibile cambiare stato del modello', 'error');
    }
}

async function deleteTemplate(templateId, templateName) {
    if (!confirm(`Eliminare il modello "${templateName}"? Questa azione non pu√≤ essere annullata.`)) return;

    try {
        const response = await fetch(`/api/owner/automated-messages/${templateId}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        if (!response.ok) throw new Error('Impossibile eliminare il modello');
        showToast('Modello eliminato', 'success');
        loadTemplates();
    } catch (error) {
        showToast('Impossibile eliminare il modello', 'error');
    }
}

async function loadMessageLog() {
    try {
        const response = await fetch('/api/owner/automated-messages/log?limit=20', {
            credentials: 'include'
        });
        if (!response.ok) throw new Error('Impossibile caricare il registro messaggi');
        const logs = await response.json();
        displayMessageLog(logs);
    } catch (error) {
        console.error('Error loading message log:', error);
        const container = document.getElementById('message-log');
        if (container) {
            container.innerHTML = `<div class="glass-card p-3 text-center text-gray-400 text-sm">Nessuna attivit√† recente</div>`;
        }
    }
}

function displayMessageLog(logs) {
    const container = document.getElementById('message-log');
    if (!container) return;

    if (!logs || logs.length === 0) {
        container.innerHTML = `
            <div class="glass-card p-3 text-center text-gray-400 text-sm">
                Nessun messaggio automatico inviato.
            </div>
        `;
        return;
    }

    const triggerLabels = {
        'missed_workout': 'Allenamento Mancato',
        'days_inactive': 'Inattivo',
        'no_show_appointment': 'Non Presentato'
    };

    container.innerHTML = logs.map(log => `
        <div class="glass-card p-3 flex items-center gap-3">
            <div class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0">
                <span class="text-xs">${log.status === 'sent' ? '‚úì' : '‚úó'}</span>
            </div>
            <div class="flex-1 min-w-0">
                <p class="text-sm font-semibold truncate">${escapeHtml(log.client_name)}</p>
                <p class="text-xs text-gray-400">${triggerLabels[log.trigger_type] || log.trigger_type} ¬∑ ${escapeHtml(log.template_name)}</p>
            </div>
            <div class="text-right flex-shrink-0">
                <span class="text-xs px-2 py-0.5 rounded-full ${log.status === 'sent' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">
                    ${log.status}
                </span>
                <p class="text-xs text-gray-500 mt-1">${formatRelativeTime(log.triggered_at)}</p>
            </div>
        </div>
    `).join('');
}

function formatRelativeTime(isoString) {
    if (!isoString) return '';
    const date = new Date(isoString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Adesso';
    if (diffMins < 60) return `${diffMins}m fa`;
    if (diffHours < 24) return `${diffHours}h fa`;
    if (diffDays < 7) return `${diffDays}g fa`;
    return date.toLocaleDateString();
}

async function manualTriggerCheck() {
    try {
        showToast('Esecuzione controllo trigger...', 'info');
        const response = await fetch('/api/owner/automated-messages/trigger-check', {
            method: 'POST',
            credentials: 'include'
        });
        if (!response.ok) throw new Error('Impossibile eseguire il controllo trigger');
        const result = await response.json();
        showToast(`Controllo completato: ${result.messages_sent} messaggi inviati`, 'success');
        loadMessageLog();
    } catch (error) {
        showToast('Impossibile eseguire il controllo trigger', 'error');
    }
}

// --- CRM FUNCTIONS ---

async function loadPipeline() {
    try {
        const response = await fetch('/api/owner/crm/pipeline', {
            credentials: 'include'
        });
        if (!response.ok) throw new Error('Impossibile caricare la pipeline');
        const data = await response.json();
        displayPipeline(data);
    } catch (error) {
        console.error('Error loading pipeline:', error);
    }
}

function displayPipeline(data) {
    const newEl = document.getElementById('pipeline-new');
    const activeEl = document.getElementById('pipeline-active');
    const atRiskEl = document.getElementById('pipeline-at-risk');
    const churningEl = document.getElementById('pipeline-churning');

    if (newEl) newEl.textContent = data.new || 0;
    if (activeEl) activeEl.textContent = data.active || 0;
    if (atRiskEl) atRiskEl.textContent = data.at_risk || 0;
    if (churningEl) churningEl.textContent = data.churning || 0;
}

async function loadRetentionAnalytics() {
    const periodSelect = document.getElementById('analytics-period');
    const period = periodSelect?.value || 'month';
    try {
        const response = await fetch(`/api/owner/crm/analytics?period=${period}`, {
            credentials: 'include'
        });
        if (!response.ok) throw new Error('Impossibile caricare le analitiche');
        const data = await response.json();
        displayAnalytics(data);
    } catch (error) {
        console.error('Error loading analytics:', error);
    }
}

function displayAnalytics(data) {
    const engagementEl = document.getElementById('engagement-rate');
    const atRiskEl = document.getElementById('at-risk-count');
    const churnEl = document.getElementById('churn-rate');
    const healthEl = document.getElementById('avg-health');

    if (engagementEl) engagementEl.textContent = `${data.engagement_rate || 0}%`;
    if (atRiskEl) atRiskEl.textContent = data.at_risk_count || 0;
    if (churnEl) churnEl.textContent = `${data.churn_rate || 0}%`;
    if (healthEl) healthEl.textContent = data.avg_health_score || 0;
}

async function loadAtRiskClients() {
    try {
        const response = await fetch('/api/owner/crm/at-risk?limit=20', {
            credentials: 'include'
        });
        if (!response.ok) throw new Error('Impossibile caricare i clienti a rischio');
        const clients = await response.json();
        displayAtRiskClients(clients);
    } catch (error) {
        console.error('Error loading at-risk clients:', error);
    }
}

function displayAtRiskClients(clients) {
    const container = document.getElementById('at-risk-list');
    if (!container) return;

    if (!clients || clients.length === 0) {
        container.innerHTML = `
            <div class="glass-card p-4 text-center text-green-400 text-sm flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Nessun cliente a rischio! Ottima fidelizzazione.
            </div>
        `;
        return;
    }

    container.innerHTML = clients.map(client => `
        <div class="glass-card p-3 flex items-center gap-3 hover:bg-white/5 transition">
            <div class="w-10 h-10 rounded-full bg-yellow-500/20 border border-yellow-500/30 flex items-center justify-center flex-shrink-0">
                <span class="text-sm font-bold text-yellow-400">${(client.name || 'U').substring(0, 2).toUpperCase()}</span>
            </div>
            <div class="flex-1 min-w-0">
                <p class="font-semibold text-sm truncate">${escapeHtml(client.name)}</p>
                <p class="text-xs text-gray-400">
                    ${client.days_inactive} giorni inattivo ¬∑
                    ${client.trainer_name ? `Trainer: ${client.trainer_name}` : 'Nessun trainer'}
                </p>
            </div>
            <div class="text-right flex-shrink-0">
                <span class="text-xs px-2 py-1 rounded-full ${
                    client.days_inactive > 10 ? 'bg-red-500/20 text-red-400' : 'bg-yellow-500/20 text-yellow-400'
                }">
                    ${client.days_inactive > 10 ? 'Critico' : 'A Rischio'}
                </span>
                <p class="text-xs text-gray-500 mt-1">Salute: ${client.health_score || 0}</p>
            </div>
        </div>
    `).join('');
}

async function loadInteractions(clientId = null) {
    try {
        let url = '/api/owner/crm/interactions?limit=30';
        if (clientId) url += `&client_id=${clientId}`;

        const response = await fetch(url, { credentials: 'include' });
        if (!response.ok) throw new Error('Impossibile caricare le interazioni');
        const interactions = await response.json();
        displayInteractions(interactions);
    } catch (error) {
        console.error('Error loading interactions:', error);
    }
}

function displayInteractions(interactions) {
    const container = document.getElementById('interactions-list');
    if (!container) return;

    if (!interactions || interactions.length === 0) {
        container.innerHTML = `
            <div class="glass-card p-3 text-center text-gray-400 text-sm">
                Nessuna attivit√† recente
            </div>
        `;
        return;
    }

    const typeIcons = {
        'workout': 'dumbbell',
        'appointment': 'calendar',
        'message': 'message-circle',
        'automated_message': 'bot',
        'subscription': 'credit-card'
    };

    const typeColors = {
        'workout': 'bg-green-500/20 text-green-400',
        'appointment': 'bg-blue-500/20 text-blue-400',
        'message': 'bg-purple-500/20 text-purple-400',
        'automated_message': 'bg-orange-500/20 text-orange-400',
        'subscription': 'bg-yellow-500/20 text-yellow-400'
    };

    container.innerHTML = interactions.map(i => `
        <div class="glass-card p-3 flex items-center gap-3">
            <div class="w-8 h-8 rounded-full ${typeColors[i.type] || 'bg-gray-500/20'} flex items-center justify-center flex-shrink-0">
                ${icon(typeIcons[i.type] || 'pin', 16)}
            </div>
            <div class="flex-1 min-w-0">
                <p class="text-sm font-semibold truncate">${escapeHtml(i.client_name)}</p>
                <p class="text-xs text-gray-400 truncate">${escapeHtml(i.description)}</p>
            </div>
            <div class="text-xs text-gray-500 flex-shrink-0">
                ${i.timestamp ? i.timestamp.split('T')[0] : ''}
            </div>
        </div>
    `).join('');
}

// --- MEDICAL CERTIFICATES OVERVIEW ---

async function loadCertificatesOverview() {
    try {
        const response = await fetch('/api/medical/certificates/overview', {
            credentials: 'include'
        });
        if (!response.ok) throw new Error('Impossibile caricare i certificati');
        const data = await response.json();
        displayCertificatesOverview(data.clients);
    } catch (error) {
        console.error('Error loading certificates overview:', error);
    }
}

function displayCertificatesOverview(clients) {
    const container = document.getElementById('certificates-overview');
    if (!container) return;

    if (!clients || clients.length === 0) {
        container.innerHTML = `
            <div class="glass-card p-4 text-center text-gray-400 text-sm">
                Nessun cliente trovato.
            </div>
        `;
        return;
    }

    const statusConfig = {
        valid: { icon: '&#10003;', bg: 'bg-green-500/20', border: 'border-green-500/30', text: 'text-green-400', label: 'Valido' },
        expiring: { icon: '&#9888;', bg: 'bg-yellow-500/20', border: 'border-yellow-500/30', text: 'text-yellow-400', label: 'In Scadenza' },
        expired: { icon: '&#10007;', bg: 'bg-red-500/20', border: 'border-red-500/30', text: 'text-red-400', label: 'Scaduto' },
        missing: { icon: '&mdash;', bg: 'bg-gray-500/20', border: 'border-gray-500/30', text: 'text-gray-400', label: 'Mancante' }
    };

    container.innerHTML = clients.map(c => {
        const cfg = statusConfig[c.status] || statusConfig.missing;
        const expiryInfo = c.expiration_date ? new Date(c.expiration_date).toLocaleDateString() : '';
        const viewBtn = c.file_url ? `<a href="${c.file_url}" target="_blank" class="text-xs ${cfg.text} hover:underline">Vedi</a>` : '';

        return `
            <div class="glass-card p-3 flex items-center gap-3">
                <div class="w-8 h-8 rounded-full ${cfg.bg} border ${cfg.border} flex items-center justify-center flex-shrink-0">
                    <span class="text-sm font-bold ${cfg.text}">${cfg.icon}</span>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-semibold truncate">${escapeHtml(c.name)}</p>
                    <p class="text-xs text-gray-400">${expiryInfo ? `Scade: ${expiryInfo}` : 'Nessun certificato'}</p>
                </div>
                <div class="flex items-center gap-2">
                    ${viewBtn}
                    <span class="text-xs px-2 py-1 rounded-full ${cfg.bg} ${cfg.text}">${cfg.label}</span>
                </div>
            </div>
        `;
    }).join('');
}

// --- ACTIVITY FEED FUNCTIONS ---

async function loadActivityFeed() {
    try {
        const response = await fetch('/api/owner/activity-feed?limit=15', {
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error('Impossibile caricare il feed attivit\u00e0');
        }

        const activities = await response.json();
        displayActivityFeed(activities);
    } catch (error) {
        console.error('Error loading activity feed:', error);
        const container = document.getElementById('activity-feed');
        if (container) {
            container.innerHTML = `
                <div class="p-4 text-center text-gray-400 text-sm">
                    Nessuna attivit√† recente
                </div>
            `;
        }
    }
}

function displayActivityFeed(activities) {
    const container = document.getElementById('activity-feed');
    if (!container) return;

    if (!activities || activities.length === 0) {
        container.innerHTML = `
            <div class="p-4 text-center text-gray-400 text-sm">
                <p>Nessuna attivit√† recente</p>
                <p class="text-xs mt-1">Le attivit√† appariranno qui quando i clienti usano la palestra</p>
            </div>
        `;
        return;
    }

    container.innerHTML = activities.map(activity => {
        // Format timestamp
        let timeDisplay = '';
        if (activity.timestamp) {
            try {
                const date = new Date(activity.timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 60) {
                    timeDisplay = diffMins <= 1 ? 'Adesso' : `${diffMins}m fa`;
                } else if (diffHours < 24) {
                    timeDisplay = `${diffHours}h fa`;
                } else if (diffDays < 7) {
                    timeDisplay = `${diffDays}g fa`;
                } else {
                    timeDisplay = date.toLocaleDateString();
                }
            } catch {
                timeDisplay = activity.timestamp.split('T')[0];
            }
        }

        // Type-based colors
        const typeColors = {
            'workout': 'bg-green-500/20 text-green-400',
            'appointment': 'bg-blue-500/20 text-blue-400',
            'signup': 'bg-yellow-500/20 text-yellow-400',
            'subscription': 'bg-purple-500/20 text-purple-400'
        };

        return `
        <div class="flex items-center gap-3 p-3 border-b border-white/5 last:border-b-0 hover:bg-white/5 transition">
            <div class="w-9 h-9 rounded-xl ${typeColors[activity.type] || 'bg-gray-500/20'} flex items-center justify-center flex-shrink-0">
                ${icon(CRM_ACTIVITY_ICONS[activity.type] || 'pin', 18)}
            </div>
            <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-white truncate">${escapeHtml(activity.title)}</p>
                <p class="text-xs text-gray-400 truncate">${escapeHtml(activity.description || '')}</p>
            </div>
            <div class="text-xs text-gray-500 flex-shrink-0">
                ${timeDisplay}
            </div>
        </div>
    `}).join('');
}

// ========== SHOWER SYSTEM SETTINGS ==========

async function loadShowerSettings() {
    try {
        const res = await fetch('/api/owner/shower-settings', { credentials: 'include' });
        if (!res.ok) return;
        const data = await res.json();

        const timerEl = document.getElementById('shower-timer-input');
        const limitEl = document.getElementById('shower-limit-input');
        const keyEl = document.getElementById('device-api-key-display');

        if (timerEl) timerEl.value = data.shower_timer_minutes;
        if (limitEl) limitEl.value = data.shower_daily_limit;
        if (keyEl) keyEl.value = data.device_api_key || 'Non ancora generata';
        updateSetupCommand(data.device_api_key);
    } catch (err) {
        console.error('Error loading shower settings:', err);
    }
}


async function saveShowerSettings() {
    const timer = parseInt(document.getElementById('shower-timer-input').value);
    const limit = parseInt(document.getElementById('shower-limit-input').value);

    if (isNaN(timer) || timer < 1 || timer > 30) { alert('Il timer deve essere tra 1-30 minuti'); return; }
    if (isNaN(limit) || limit < 1 || limit > 20) { alert('Il limite deve essere tra 1-20 sessioni'); return; }

    try {
        const res = await fetch('/api/owner/shower-settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ shower_timer_minutes: timer, shower_daily_limit: limit })
        });

        if (!res.ok) throw new Error('Impossibile salvare');
        showToast('Impostazioni docce salvate!');
    } catch (err) {
        alert('Errore: ' + err.message);
    }
}

async function generateDeviceKey() {
    if (!confirm('Generare una nuova chiave API dispositivo? Questo disconnetter√† tutti i dispositivi ESP32 fino alla riconfigurazione.')) return;

    try {
        const res = await fetch('/api/owner/generate-device-key', {
            method: 'POST',
            credentials: 'include'
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Failed');

        document.getElementById('device-api-key-display').value = data.device_api_key;
        updatePiSetupCommand(data.device_api_key);
        showToast('Nuova chiave dispositivo generata!');
    } catch (err) {
        alert('Errore: ' + err.message);
    }
}

function copyDeviceKey() {
    const key = document.getElementById('device-api-key-display').value;
    if (key === 'Non ancora generata') { alert('Genera prima una chiave'); return; }
    navigator.clipboard.writeText(key);
    showToast('Chiave dispositivo copiata!');
}

// ========== TURNSTILE QR SCANNER SETTINGS ==========

async function loadTurnstileSettings() {
    try {
        const res = await fetch('/api/owner/shower-settings', { credentials: 'include' });
        if (!res.ok) return;
        const data = await res.json();

        const gateEl = document.getElementById('turnstile-gate-input');
        if (gateEl) gateEl.value = data.turnstile_gate_seconds || 5;

        // Build the pi setup command
        updatePiSetupCommand(data.device_api_key);
    } catch (err) {
        console.error('Error loading turnstile settings:', err);
    }
}

function updatePiSetupCommand(deviceKey) {
    const cmdEl = document.getElementById('pi-setup-command');
    if (!cmdEl) return;
    if (!deviceKey) {
        cmdEl.value = 'Genera prima una chiave API dispositivo nella sezione sopra';
        return;
    }
    const serverUrl = window.location.origin;
    cmdEl.value = `curl -sSL ${serverUrl}/api/device/pi-setup | bash -s -- --server ${serverUrl} --key ${deviceKey}`;
}

async function saveTurnstileSettings() {
    const gate = parseInt(document.getElementById('turnstile-gate-input').value);
    if (isNaN(gate) || gate < 2 || gate > 15) { alert('La durata deve essere tra 2-15 secondi'); return; }

    try {
        const res = await fetch('/api/owner/shower-settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ turnstile_gate_seconds: gate })
        });

        if (!res.ok) throw new Error('Impossibile salvare');
        showToast('Impostazioni tornello salvate!');
    } catch (err) {
        alert('Errore: ' + err.message);
    }
}

function copyPiSetupCommand() {
    const cmd = document.getElementById('pi-setup-command').value;
    if (cmd.startsWith('Genera prima')) { alert('Genera prima una chiave API dispositivo'); return; }
    navigator.clipboard.writeText(cmd);
    showToast('Comando Pi copiato!');
}

// ========== CLIENT CSV IMPORT ==========

function triggerClientImport() {
    const consent = document.getElementById('import-dpa-consent');
    if (!consent || !consent.checked) {
        if (typeof showToast === 'function') showToast('You must confirm data protection consent before importing', 'error');
        return;
    }
    document.getElementById('client-csv-input').click();
}

async function handleClientCsvUpload(input) {
    if (!input.files[0]) return;

    const file = input.files[0];
    if (!file.name.toLowerCase().endsWith('.csv')) {
        if (typeof showToast === 'function') showToast('Please select a CSV file', 'error');
        input.value = '';
        return;
    }

    const consent = document.getElementById('import-dpa-consent');
    if (!consent || !consent.checked) {
        if (typeof showToast === 'function') showToast('Consent checkbox must be checked', 'error');
        input.value = '';
        return;
    }

    const btn = document.getElementById('import-clients-btn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = 'Importing...';

    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch('/api/owner/import-clients', {
            method: 'POST',
            credentials: 'include',
            body: formData
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.detail || 'Import failed');
        }

        displayImportResults(data);

        if (data.created > 0) {
            if (typeof showToast === 'function') showToast(`${data.created} client(s) imported successfully!`, 'success');
        } else {
            if (typeof showToast === 'function') showToast('No new clients were created', 'error');
        }

    } catch (error) {
        console.error('Client import error:', error);
        if (typeof showToast === 'function') showToast(error.message || 'Import failed', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
        input.value = '';
    }
}

function displayImportResults(data) {
    const resultsDiv = document.getElementById('import-results');
    resultsDiv.classList.remove('hidden');

    document.getElementById('import-created-count').textContent = data.created || 0;
    document.getElementById('import-skipped-count').textContent = data.skipped || 0;

    const errorsSection = document.getElementById('import-errors-section');
    const errorsList = document.getElementById('import-errors-list');
    if (data.errors && data.errors.length > 0) {
        errorsSection.classList.remove('hidden');
        errorsList.innerHTML = data.errors.map(e =>
            `<div class="text-xs text-red-300/70 bg-red-500/10 px-2 py-1 rounded">
                Row ${e.row}: ${typeof escapeHtml === 'function' ? escapeHtml(e.reason) : e.reason}
            </div>`
        ).join('');
    } else {
        errorsSection.classList.add('hidden');
    }

    const clientsSection = document.getElementById('import-clients-section');
    const clientsList = document.getElementById('import-clients-list');
    if (data.created_clients && data.created_clients.length > 0) {
        clientsSection.classList.remove('hidden');
        clientsList.innerHTML = data.created_clients.map(c =>
            `<div class="bg-green-500/10 px-2 py-1.5 rounded flex justify-between items-center">
                <span class="text-gray-300">${typeof escapeHtml === 'function' ? escapeHtml(c.name) : c.name}</span>
                <span class="text-gray-500 font-mono">${typeof escapeHtml === 'function' ? escapeHtml(c.username) : c.username} / ${typeof escapeHtml === 'function' ? escapeHtml(c.temp_password) : c.temp_password}</span>
            </div>`
        ).join('');
    } else {
        clientsSection.classList.add('hidden');
    }
}

function copyImportCredentials() {
    const clientsList = document.getElementById('import-clients-list');
    if (!clientsList) return;

    const rows = clientsList.querySelectorAll('div');
    let text = 'Name\tUsername\tTemporary Password\n';
    rows.forEach(row => {
        const spans = row.querySelectorAll('span');
        if (spans.length >= 2) {
            const name = spans[0].textContent.trim();
            const creds = spans[1].textContent.trim();
            text += `${name}\t${creds.replace(' / ', '\t')}\n`;
        }
    });

    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
            if (typeof showToast === 'function') showToast('Credentials copied to clipboard!', 'success');
        });
    } else {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand('copy'); showToast('Credentials copied!', 'success'); } catch (e) {}
        document.body.removeChild(ta);
    }
}

// ========== FACILITY MANAGEMENT ==========

let currentActivityTypeId = null;
let currentFacilityId = null;
const DAY_NAMES = ['Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato', 'Domenica'];

async function loadActivityTypes() {
    const container = document.getElementById('activity-types-grid');
    if (!container) return;
    try {
        const res = await fetch('/api/owner/activity-types', { credentials: 'include' });
        const types = await res.json();
        if (!types.length) {
            container.innerHTML = `<div class="glass-card p-6 text-center text-gray-500 text-sm col-span-full">
                <i data-lucide="plus-circle" class="w-10 h-10 mx-auto mb-3 text-gray-600"></i>
                <p class="font-semibold text-gray-400">Nessun tipo di attivit√†</p>
                <p class="text-xs text-gray-600 mt-1">Crea la tua prima attivit√† per iniziare a gestire campi, sale e strutture</p>
            </div>`;
            lucide.createIcons();
            return;
        }
        container.innerHTML = types.map(t => {
            const count = t.facility_count || 0;
            const countLabel = count === 0 ? 'Nessuna struttura' : count === 1 ? '1 struttura' : count + ' strutture';
            const countColor = count === 0 ? 'text-yellow-400' : 'text-teal-400';
            const escapedName = t.name.replace(/'/g, "\\'");
            const escapedDesc = (t.description || '').replace(/'/g, "\\'");
            return `
            <div class="glass-card p-4 rounded-2xl cursor-pointer hover:bg-white/10 transition group relative"
                 onclick="selectActivityType('${t.id}', '${t.name}')">
                <div class="flex items-start gap-3">
                    <div class="text-3xl flex-shrink-0">${t.emoji || 'üèüÔ∏è'}</div>
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-white text-sm">${t.name}</p>
                        <p class="text-xs ${countColor} mt-0.5">${countLabel}</p>
                        ${t.description ? `<p class="text-xs text-gray-500 mt-1 line-clamp-2">${t.description}</p>` : ''}
                    </div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-600 group-hover:text-white transition flex-shrink-0 mt-1"></i>
                </div>
                <div class="mt-3 flex gap-2 opacity-0 group-hover:opacity-100 transition">
                    <button onclick="event.stopPropagation(); editActivityType('${t.id}', '${escapedName}', '${t.emoji || ''}', '${escapedDesc}')"
                        class="text-xs text-gray-400 hover:text-white px-2 py-1 rounded-lg bg-white/5 hover:bg-white/10 transition">Modifica</button>
                    <button onclick="event.stopPropagation(); deleteActivityType('${t.id}')"
                        class="text-xs text-red-400 hover:text-red-300 px-2 py-1 rounded-lg bg-red-500/10 hover:bg-red-500/20 transition">Elimina</button>
                </div>
            </div>
        `}).join('');
        lucide.createIcons();
    } catch (e) {
        container.innerHTML = '<div class="glass-card p-3 text-center text-red-400 text-sm">Impossibile caricare</div>';
    }
}

function openCreateActivityTypeModal() {
    document.getElementById('activity-type-id').value = '';
    document.getElementById('activity-type-name').value = '';
    document.getElementById('activity-type-emoji').value = '';
    document.getElementById('activity-type-description').value = '';
    document.getElementById('activity-type-modal-title').innerText = 'Nuovo Tipo di Attivit√†';
    showModal('activity-type-modal');
}

function editActivityType(id, name, emoji, description) {
    document.getElementById('activity-type-id').value = id;
    document.getElementById('activity-type-name').value = name;
    document.getElementById('activity-type-emoji').value = emoji;
    document.getElementById('activity-type-description').value = description;
    document.getElementById('activity-type-modal-title').innerText = 'Modifica Tipo di Attivit√†';
    showModal('activity-type-modal');
}

async function saveActivityType() {
    const id = document.getElementById('activity-type-id').value;
    const isNew = !id;
    const data = {
        name: document.getElementById('activity-type-name').value,
        emoji: document.getElementById('activity-type-emoji').value || null,
        description: document.getElementById('activity-type-description').value || null
    };
    if (!data.name) { alert('Il nome √® obbligatorio'); return; }

    const url = id ? `/api/owner/activity-types/${id}` : '/api/owner/activity-types';
    const method = id ? 'PUT' : 'POST';
    try {
        const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify(data) });
        if (res.ok) {
            const result = await res.json();
            hideModal('activity-type-modal');
            showToast(isNew ? 'Tipo di attivit√† creato! Ora aggiungi le strutture.' : 'Tipo di attivit√† salvato!');
            if (isNew && result.id) {
                // Auto-navigate to facilities for the new activity type
                await loadActivityTypes();
                selectActivityType(result.id, data.name);
            } else {
                loadActivityTypes();
            }
        } else {
            const err = await res.json();
            alert(err.detail || 'Impossibile salvare');
        }
    } catch (e) { alert('Errore nel salvataggio del tipo di attivit√†'); }
}

async function deleteActivityType(id) {
    if (!confirm('Eliminare questo tipo di attivit√†?')) return;
    try {
        await fetch(`/api/owner/activity-types/${id}`, { method: 'DELETE', credentials: 'include' });
        loadActivityTypes();
        showToast('Tipo di attivit√† eliminato');
    } catch (e) { alert('Errore nell\'eliminazione'); }
}

async function selectActivityType(id, name) {
    currentActivityTypeId = id;
    document.getElementById('activity-types-section').classList.add('hidden');
    document.getElementById('facilities-section').classList.remove('hidden');
    document.getElementById('facilities-section-title').innerText = name.toUpperCase();
    document.getElementById('facility-activity-type-id').value = id;
    await loadFacilities(id);
}

function closeFacilitiesSection() {
    document.getElementById('facilities-section').classList.add('hidden');
    document.getElementById('facility-availability-section').classList.add('hidden');
    document.getElementById('activity-types-section').classList.remove('hidden');
    currentActivityTypeId = null;
    // Refresh to update facility counts
    loadActivityTypes();
}

async function loadFacilities(activityTypeId) {
    const container = document.getElementById('facilities-list');
    try {
        const res = await fetch(`/api/owner/facilities/${activityTypeId}`, { credentials: 'include' });
        const facilities = await res.json();
        if (!facilities.length) {
            container.innerHTML = '<div class="glass-card p-4 text-center text-gray-500 text-sm">Nessuna struttura. Clicca "+ Nuovo" per aggiungerne una.</div>';
            return;
        }
        container.innerHTML = facilities.map(f => {
            const days = f.availability_days || 0;
            const availLabel = days === 0 ? 'Nessuna disponibilit√† impostata' : days + ' giorn' + (days > 1 ? 'i' : 'o') + ' disponibil' + (days > 1 ? 'i' : 'e');
            const availColor = days === 0 ? 'text-yellow-400' : 'text-green-400';
            const availIcon = days === 0 ? 'alert-circle' : 'check-circle';
            return `
            <div class="glass-card p-4 rounded-2xl">
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 rounded-xl bg-orange-500/20 flex items-center justify-center flex-shrink-0">
                        <i data-lucide="map-pin" class="w-5 h-5 text-orange-400"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-white">${f.name}</p>
                        <p class="text-xs text-gray-400">${f.slot_duration}min slot${f.price_per_slot ? ' ¬∑ ‚Ç¨' + f.price_per_slot : ' ¬∑ Gratuito'}${f.max_participants ? ' ¬∑ Max ' + f.max_participants : ''}</p>
                        <p class="text-xs ${availColor} mt-1"><i data-lucide="${availIcon}" class="w-3 h-3 inline-block align-middle"></i> ${availLabel}</p>
                    </div>
                </div>
                <div class="flex gap-2 mt-3">
                    <button onclick="openFacilityAvailability('${f.id}', '${f.name.replace(/'/g, "\\'")}')"
                        class="flex-1 text-xs bg-purple-500/20 text-purple-400 px-3 py-2 rounded-lg hover:bg-purple-500/30 transition font-semibold text-center">
                        <i data-lucide="clock" class="w-3 h-3 inline-block align-middle"></i> Imposta Disponibilit√†
                    </button>
                    <button onclick="editFacility('${f.id}', '${f.name.replace(/'/g, "\\'")}', ${f.slot_duration}, ${f.price_per_slot || 0}, ${f.max_participants || 0})"
                        class="text-xs bg-white/10 text-white px-3 py-2 rounded-lg hover:bg-white/20 transition">Modifica</button>
                    <button onclick="deleteFacility('${f.id}')"
                        class="text-xs text-red-400 hover:text-red-300 px-2 py-2 rounded-lg hover:bg-red-500/10 transition">
                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                    </button>
                </div>
            </div>
        `}).join('');
        lucide.createIcons();
    } catch (e) {
        container.innerHTML = '<div class="glass-card p-3 text-center text-red-400 text-sm">Impossibile caricare</div>';
    }
}

function openCreateFacilityModal() {
    document.getElementById('facility-id').value = '';
    document.getElementById('facility-name').value = '';
    document.getElementById('facility-slot-duration').value = '60';
    document.getElementById('facility-price').value = '';
    document.getElementById('facility-max-participants').value = '';
    document.getElementById('facility-modal-title').innerText = 'Nuova Struttura';
    showModal('facility-modal');
}

function editFacility(id, name, duration, price, maxP) {
    document.getElementById('facility-id').value = id;
    document.getElementById('facility-name').value = name;
    document.getElementById('facility-slot-duration').value = duration;
    document.getElementById('facility-price').value = price || '';
    document.getElementById('facility-max-participants').value = maxP || '';
    document.getElementById('facility-modal-title').innerText = 'Modifica Struttura';
    showModal('facility-modal');
}

async function saveFacility() {
    const id = document.getElementById('facility-id').value;
    const isNew = !id;
    const data = {
        activity_type_id: currentActivityTypeId,
        name: document.getElementById('facility-name').value,
        slot_duration: parseInt(document.getElementById('facility-slot-duration').value) || 60,
        price_per_slot: parseFloat(document.getElementById('facility-price').value) || null,
        max_participants: parseInt(document.getElementById('facility-max-participants').value) || null
    };
    if (!data.name) { alert('Il nome √® obbligatorio'); return; }

    const url = id ? `/api/owner/facilities/${id}` : '/api/owner/facilities';
    const method = id ? 'PUT' : 'POST';
    try {
        const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify(data) });
        if (res.ok) {
            const result = await res.json();
            hideModal('facility-modal');
            await loadFacilities(currentActivityTypeId);
            if (isNew && result.id) {
                showToast('Struttura creata! Imposta ora la disponibilit√†.');
                openFacilityAvailability(result.id, data.name);
            } else {
                showToast('Struttura salvata!');
            }
        } else {
            const err = await res.json();
            alert(err.detail || 'Impossibile salvare');
        }
    } catch (e) { alert('Errore nel salvataggio della struttura'); }
}

async function deleteFacility(id) {
    if (!confirm('Eliminare questa struttura?')) return;
    try {
        await fetch(`/api/owner/facilities/${id}`, { method: 'DELETE', credentials: 'include' });
        loadFacilities(currentActivityTypeId);
        showToast('Struttura eliminata');
    } catch (e) { alert('Errore nell\'eliminazione'); }
}

// ---- Availability ----

async function openFacilityAvailability(facilityId, facilityName) {
    currentFacilityId = facilityId;
    document.getElementById('facility-avail-title').innerText = facilityName + ' ‚Äî Disponibilit√†';
    document.getElementById('facility-availability-section').classList.remove('hidden');

    // Build day grid
    const grid = document.getElementById('facility-days-grid');
    grid.innerHTML = DAY_NAMES.map((day, i) => `
        <div class="flex items-center gap-3 bg-white/5 rounded-xl p-3">
            <label class="flex items-center gap-2 cursor-pointer flex-1">
                <input type="checkbox" id="fday-${i}" class="w-4 h-4 accent-orange-500" onchange="toggleFacilityDay(${i})">
                <span class="text-sm font-medium text-white">${day}</span>
            </label>
            <div id="fday-times-${i}" class="hidden flex items-center gap-2">
                <input type="time" id="fday-start-${i}" value="${i < 5 ? '09:00' : '10:00'}" class="bg-white/10 text-white text-sm rounded-lg px-2 py-1 border border-white/10 outline-none">
                <span class="text-gray-400 text-xs">a</span>
                <input type="time" id="fday-end-${i}" value="${i < 5 ? '20:00' : '14:00'}" class="bg-white/10 text-white text-sm rounded-lg px-2 py-1 border border-white/10 outline-none">
            </div>
        </div>
    `).join('');

    // Load existing availability
    try {
        const res = await fetch(`/api/owner/facilities/${facilityId}/availability`, { credentials: 'include' });
        const slots = await res.json();
        for (const slot of slots) {
            const d = slot.day_of_week;
            const cb = document.getElementById(`fday-${d}`);
            if (cb) {
                cb.checked = true;
                document.getElementById(`fday-times-${d}`).classList.remove('hidden');
                document.getElementById(`fday-start-${d}`).value = slot.start_time;
                document.getElementById(`fday-end-${d}`).value = slot.end_time;
            }
        }
    } catch (e) { console.error('Error loading availability:', e); }
}

function closeFacilityAvailability() {
    document.getElementById('facility-availability-section').classList.add('hidden');
    currentFacilityId = null;
}

function toggleFacilityDay(dayIndex) {
    const cb = document.getElementById(`fday-${dayIndex}`);
    const times = document.getElementById(`fday-times-${dayIndex}`);
    if (cb.checked) times.classList.remove('hidden');
    else times.classList.add('hidden');
}

async function saveFacilityAvailability() {
    if (!currentFacilityId) { showToast('Nessuna struttura selezionata', 'error'); return; }
    const availability = [];
    for (let i = 0; i < 7; i++) {
        const cb = document.getElementById(`fday-${i}`);
        if (cb && cb.checked) {
            availability.push({
                day_of_week: i,
                start_time: document.getElementById(`fday-start-${i}`).value,
                end_time: document.getElementById(`fday-end-${i}`).value
            });
        }
    }
    if (!availability.length) {
        if (!confirm('Nessun giorno selezionato. Questo canceller√† tutta la disponibilit√†. Continuare?')) return;
    }
    const activityTypeId = currentActivityTypeId; // save before close clears it
    try {
        const res = await fetch(`/api/owner/facilities/${currentFacilityId}/availability`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ availability })
        });
        if (res.ok) {
            showToast('Disponibilit√† salvata!');
            closeFacilityAvailability();
            if (activityTypeId) {
                await loadFacilities(activityTypeId);
            }
        } else {
            const err = await res.json().catch(() => ({}));
            showToast(err.detail || 'Impossibile salvare la disponibilit√†', 'error');
        }
    } catch (e) { showToast('Errore nel salvataggio della disponibilit√†', 'error'); }
}

// ---- Bookings ----

async function loadFacilityBookings() {
    const container = document.getElementById('facility-bookings-list');
    if (!container) return;
    try {
        const today = new Date().toISOString().split('T')[0];
        const res = await fetch(`/api/owner/facility-bookings?date_from=${today}`, { credentials: 'include' });
        const bookings = await res.json();
        if (!bookings.length) {
            container.innerHTML = `<div class="glass-card p-3 text-center text-gray-400 text-sm">
                Nessuna prenotazione imminente
            </div>`;
            return;
        }
        container.innerHTML = bookings.map(b => `
            <div class="glass-card p-3 rounded-xl flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl ${b.status === 'confirmed' ? 'bg-green-500/20' : 'bg-gray-500/20'} flex items-center justify-center flex-shrink-0">
                    <i data-lucide="calendar-check" class="w-5 h-5 ${b.status === 'confirmed' ? 'text-green-400' : 'text-gray-400'}"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-bold text-white truncate">${b.title || 'Prenotazione'}</p>
                    <p class="text-xs text-gray-400">${b.date} ¬∑ ${b.start_time} - ${b.end_time}${b.client_name ? ' ¬∑ ' + b.client_name : ''}</p>
                </div>
                <span class="text-xs px-2 py-1 rounded-full flex-shrink-0 ${b.status === 'confirmed' ? 'bg-green-500/20 text-green-400' : 'bg-gray-500/20 text-gray-400'}">${b.status}</span>
            </div>
        `).join('');
        lucide.createIcons();
    } catch (e) {
        container.innerHTML = '<div class="glass-card p-3 text-center text-red-400 text-sm">Impossibile caricare le prenotazioni</div>';
    }
}

// Initialize based on mode
if (currentMode === 'settings') {
    loadGymCode();
    loadGymSettings();
    loadStripeConnectStatus();
    // Load terminal status after a short delay so Connect status is resolved first
    setTimeout(loadTerminalStatus, 1000);
    loadShowerSettings();
    loadTurnstileSettings();
} else if (currentMode === 'crm') {
    loadPipeline();
    loadRetentionAnalytics();
    loadAtRiskClients();
    loadInteractions();
    loadCertificatesOverview();
} else if (currentMode === 'facilities') {
    loadActivityTypes();
    loadFacilityBookings();
} else {
    // Dashboard mode (default) ‚Äî includes automation
    loadPendingTrainers();
    loadApprovedTrainers();
    loadSubscriptionPlans();
    loadOffers();
    loadActivityFeed();
    loadTemplates();
    loadMessageLog();
}
</script>

<!-- Gym Name Edit Modal (top-level so fixed positioning works) -->
<div id="gym-name-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[80] hidden flex items-center justify-center px-4" onclick="if(event.target===this)closeGymNameModal()">
    <div class="bg-gray-900 border border-white/10 rounded-2xl p-6 w-full max-w-sm">
        <h3 class="text-white font-bold text-lg mb-1">Cambia Nome Palestra</h3>
        <p class="text-gray-400 text-xs mb-4">Inserisci il nuovo nome e la tua password per confermare</p>
        <input type="text" id="gym-name-new" placeholder="Nuovo nome palestra"
            class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white text-sm outline-none focus:border-primary/50 transition mb-3">
        <input type="password" id="gym-name-password" placeholder="La tua password"
            class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white text-sm outline-none focus:border-primary/50 transition mb-4">
        <div class="flex gap-2">
            <button onclick="closeGymNameModal()"
                class="flex-1 py-3 rounded-xl bg-white/5 text-gray-400 text-sm font-semibold hover:bg-white/10 transition">Annulla</button>
            <button onclick="confirmGymNameEdit()"
                class="flex-1 py-3 rounded-xl bg-gradient-to-r from-orange-500 to-red-500 text-white text-sm font-semibold active:scale-95 transition-transform">Conferma</button>
        </div>
    </div>
</div>
{% endblock %}
