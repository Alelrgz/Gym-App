{% extends "base.html" %}

{% block content %}
<div class="p-4 pb-24">
    <!-- Header -->
    <div class="flex justify-between items-start mb-6">
        <div>
            <p class="text-xs text-white/60 uppercase tracking-wider">My Profile</p>
            <h2 class="text-2xl font-bold" id="personal-name">Loading...</h2>
        </div>
        <div class="flex space-x-2">
            <div data-action="showModal" data-target="notification-modal"
                class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center tap-effect cursor-pointer">
                üîî
            </div>
            <div data-action="showModal" data-target="profile-modal"
                class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center tap-effect cursor-pointer">
                ‚öôÔ∏è
            </div>
            <!-- Back Button -->
            <a href="{{ 'trainer.html' if static_build else '/?gym_id=' + gym_id + '&role=trainer' }}"
                class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center tap-effect cursor-pointer">
                ‚Üê
            </a>
        </div>
    </div>

    <!-- Personal Stats Grid -->
    <div class="flex justify-center mb-6">
        <div class="glass-card p-6 flex flex-col items-center justify-center w-48">
            <span class="text-4xl font-bold text-green-400" id="personal-streak">0</span>
            <span class="text-xs text-white/50 uppercase tracking-wider mt-2">Day Streak üî•</span>
        </div>
    </div>

    <!-- My Workout Section -->
    <div class="mb-6">
        <button id="toggle-my-workout-btn"
            class="w-full py-2 text-sm bg-red-600 text-white font-bold rounded-xl mb-4 hover:bg-red-700 transition shadow-lg shadow-red-600/20">
            My Workouts
        </button>

        <div id="my-workout-section" class="hidden transition-all duration-300 ease-in-out mb-4">
            <div id="my-workout-card-container">
                <!-- Injected via JS -->
                <div class="glass-card p-4 text-center">
                    <p class="text-gray-400 text-sm mb-2">Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- My Splits Section -->
    <div class="mb-6">
        <button id="toggle-my-split-btn"
            class="w-full py-2 text-sm bg-orange-600 text-white font-bold rounded-xl mb-4 hover:bg-orange-700 transition shadow-lg shadow-orange-600/20">
            My Splits
        </button>

        <div id="my-split-section" class="hidden transition-all duration-300 ease-in-out mb-4">
            <div id="my-split-card-container">
                <!-- Injected via JS -->
                <div class="glass-card p-4 text-center">
                    <p class="text-gray-400 text-sm mb-2">Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Today's Plan Section - Always Visible -->
    <div id="todays-plan-container" class="mb-6">
        <!-- Default: No workout assigned - will be replaced by JS if workout exists -->
        <div class="glass-card p-5 relative overflow-hidden" id="default-plan-placeholder">
            <div class="flex justify-between items-start mb-4">
                <span class="bg-white/10 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider">Today's
                    Plan</span>
                <span class="text-xl">üìã</span>
            </div>
            <h3 class="text-xl font-bold text-white/50 mb-2">No Workout Assigned</h3>
            <p class="text-sm text-gray-400 mb-4">Select a workout from "My Workouts" and click "Assign to Me" to set
                today's workout.</p>
        </div>
    </div>

    <!-- Calendar / Schedule Section -->
    <div class="glass-card p-4 rounded-2xl mb-6">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center space-x-2">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Schedule</h3>
            </div>

            <div class="flex items-center space-x-2">
                <button onclick="changeWeek(-1)"
                    class="w-6 h-6 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-white/70">‚Üê</button>
                <span class="text-xs text-white/40 min-w-[3rem] text-center" id="month-label">...</span>
                <button onclick="changeWeek(1)"
                    class="w-6 h-6 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-white/70">‚Üí</button>
            </div>
        </div>

        <div class="text-xs text-center font-mono mb-2 text-white/50 uppercase tracking-widest" id="current-full-date">
        </div>

        <!-- Interactive Weekly Strip -->
        <div class="grid grid-cols-7 gap-1 mb-4 text-xs text-center font-mono" id="calendar-strip">
            <!-- Dynamic Content -->
        </div>

        <!-- Hours / Agenda -->
        <div class="space-y-3" id="schedule-container">
            <!-- Dynamic Content -->
        </div>
    </div>

    <!-- Personal Notes -->
    <div class="glass-card p-4 rounded-2xl">
        <div class="flex justify-between items-center mb-2">
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Personal Notes</h3>
            <span class="text-[10px] text-green-400 opacity-0 transition-opacity duration-500"
                id="personal-notes-saved-indicator">Saved</span>
        </div>
        <textarea id="personal-notes"
            class="w-full bg-black/20 text-white text-sm rounded-xl p-3 border border-white/5 focus:border-white/20 outline-none resize-none h-32 placeholder-white/20 transition"
            placeholder="Journal your progress, ideas, or training logs..."></textarea>
    </div>
</div>

<!-- Add Event Modal -->
<div id="add-event-modal"
    class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50 backdrop-blur-sm z-[60]">
    <div class="glass-card w-full max-w-sm mx-4 p-6 rounded-2xl relative">
        <button onclick="document.getElementById('add-event-modal').classList.add('hidden')"
            class="absolute top-4 right-4 text-white/50 hover:text-white">‚úï</button>
        <h3 class="text-xl font-bold mb-4 text-center">Add Event</h3>

        <form id="add-event-form" class="space-y-4">
            <div>
                <label class="text-xs text-gray-400 uppercase">Title</label>
                <input type="text" name="title" required
                    class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none"
                    placeholder="e.g. Client Consultation">
            </div>
            <div>
                <label class="text-xs text-gray-400 uppercase">Subtitle / Details</label>
                <input type="text" name="subtitle"
                    class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none"
                    placeholder="e.g. John Doe - Leg Day">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-xs text-gray-400 uppercase">Time</label>
                    <input type="time" name="time" required
                        class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none">
                </div>
                <div>
                    <label class="text-xs text-gray-400 uppercase">Type</label>
                    <select name="type"
                        class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none">
                        <option value="personal">Personal</option>
                        <option value="consultation">Consultation</option>
                        <option value="class">Class</option>
                    </select>
                </div>
            </div>
            <div id="workout-selector-container" class="hidden">
                <label class="text-xs text-gray-400 uppercase">Select Workout</label>
                <select name="workout_id" id="event-workout-select"
                    class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none">
                    <option value="">None</option>
                </select>
            </div>
            <div>
                <label class="text-xs text-gray-400 uppercase">Duration (minutes)</label>
                <input type="number" name="duration" value="60" min="15" step="15"
                    class="w-full bg-white/5 border border-white/10 rounded-lg p-3 text-white focus:border-primary outline-none"
                    placeholder="60">
            </div>
            <input type="hidden" name="date" id="event-date-input">

            <button type="submit"
                class="w-full py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 transition text-center flex items-center justify-center">
                Add to Schedule
            </button>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="/static/trainer_notes.js"></script>
<script>
    let currentSchedule = [];
    const username = localStorage.getItem('username') || 'Trainer';
    const { gymId: localGymId } = window.APP_CONFIG;

    // Fallback for modal utils if app.js fails or is late
    if (typeof window.showModal === 'undefined') {
        window.showModal = function (id) {
            const el = document.getElementById(id);
            if (el) el.classList.remove('hidden');
        }
    }
    if (typeof window.hideModal === 'undefined') {
        window.hideModal = function (id) {
            const el = document.getElementById(id);
            if (el) el.classList.add('hidden');
        }
    }

    // Calendar State
    let currentWeekMonday = new Date();
    const day = currentWeekMonday.getDay() || 7;
    if (day !== 1) currentWeekMonday.setHours(-24 * (day - 1));
    currentWeekMonday.setHours(0, 0, 0, 0);

    const toLocalISO = (d) => {
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    let selectedDateStr = toLocalISO(new Date());

    // Initialize Personal Page Logic
    document.addEventListener('DOMContentLoaded', async () => {
        // Name
        const nameEl = document.getElementById('personal-name');
        if (nameEl) nameEl.textContent = username;

        // Fetch Data
        await fetchTrainerData();

        // Notes Logic
        const notesArea = document.getElementById('personal-notes');
        if (notesArea) {
            const savedNotes = localStorage.getItem(`personal_notes_${username}`);
            if (savedNotes) notesArea.value = savedNotes;

            let saveTimeout;
            notesArea.addEventListener('input', () => {
                const indicator = document.getElementById('personal-notes-saved-indicator');
                if (indicator) indicator.style.opacity = '0';

                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    localStorage.setItem(`personal_notes_${username}`, notesArea.value);
                    if (indicator) indicator.style.opacity = '1';
                }, 1000);
            });
        }

        // Type Selector Logic
        const typeSelect = document.querySelector('select[name="type"]');
        const workoutContainer = document.getElementById('workout-selector-container');
        if (typeSelect && workoutContainer) {
            typeSelect.addEventListener('change', () => {
                if (typeSelect.value === 'personal' || typeSelect.value === 'workout') {
                    workoutContainer.classList.remove('hidden');
                } else {
                    workoutContainer.classList.add('hidden');
                }
            });
            // Trigger initial state
            typeSelect.dispatchEvent(new Event('change'));
        }

        // Toggle Logic for My Workouts / My Splits
        const workoutBtn = document.getElementById('toggle-my-workout-btn');
        if (workoutBtn) {
            workoutBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const section = document.getElementById('my-workout-section');
                if (section) {
                    section.classList.toggle('hidden');
                }
            });
        }

        const splitBtn = document.getElementById('toggle-my-split-btn');
        if (splitBtn) {
            splitBtn.addEventListener('click', () => {
                const section = document.getElementById('my-split-section');
                if (section) {
                    section.classList.toggle('hidden');
                }
            });
        }
    });

    async function fetchTrainerData() {
        try {
            const res = await fetch('/api/trainer/data');
            const data = await res.json();
            console.log("TRAINER DATA FETCHED:", data);

            if (data.schedule) {
                const personalCount = data.schedule.filter(e => e.type === 'personal').length;
                const personalEl = document.getElementById('personal-workouts');
                if (personalEl) personalEl.innerText = personalCount;
            }

            currentSchedule = data.schedule || [];

            // Render Today's Plan
            const planContainer = document.getElementById('todays-plan-container');
            if (planContainer) {
                if (data.todays_workout) {
                    const w = data.todays_workout;
                    planContainer.innerHTML = `
                        <div class="glass-card p-5 relative overflow-hidden group tap-effect cursor-pointer" onclick="window.location.href='/?gym_id=${localGymId}&role=trainer&mode=workout${w.completed ? '&view=completed' : ''}'">
                            <div class="absolute inset-0 bg-primary opacity-20 group-hover:opacity-30 transition"></div>
                            <div class="relative z-10">
                                <div class="flex justify-between items-start mb-4">
                                    <span class="bg-white/10 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider">Today's Plan</span>
                                    <span class="text-xl">${w.completed ? '‚úÖ' : 'üí™'}</span>
                                </div>
                                <h3 class="text-2xl font-black italic uppercase mb-1">${w.title}</h3>
                                <p class="text-sm text-gray-300 mb-4">${w.duration || 60} min ‚Ä¢ ${w.difficulty || 'Intermediate'}</p>
                                <button class="block w-full py-3 ${w.completed ? 'bg-green-500 text-white' : 'bg-white text-black hover:bg-gray-200'} text-center font-bold rounded-xl transition">${w.completed ? 'COMPLETED ‚úì' : 'START SESSION'}</button>
                            </div>
                        </div>
                    `;
                    planContainer.classList.remove('hidden');
                } else {
                    // Show default "No Workout" message
                    planContainer.innerHTML = `
                        <div class="glass-card p-5 relative overflow-hidden" id="default-plan-placeholder">
                            <div class="flex justify-between items-start mb-4">
                                <span class="bg-white/10 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider">Today's Plan</span>
                                <span class="text-xl">üìã</span>
                            </div>
                            <h3 class="text-xl font-bold text-white/50 mb-2">No Workout Assigned</h3>
                            <p class="text-sm text-gray-400 mb-4">Select a workout from "My Workouts" and click "Assign to Me" to set today's workout.</p>
                        </div>
                    `;
                    planContainer.classList.remove('hidden');
                }
            }

            // Render My Workouts
            const workoutCardContainer = document.getElementById('my-workout-card-container');
            if (workoutCardContainer && data.workouts) {
                if (data.workouts.length === 0) {
                    workoutCardContainer.innerHTML = '<p class="text-xs text-gray-500 italic text-center py-2">No workouts created yet.</p>';
                } else {
                    workoutCardContainer.innerHTML = '';
                    data.workouts.forEach(w => {
                        const div = document.createElement('div');
                        div.className = "glass-card p-3 mb-2";
                        div.innerHTML = `
                            <div class="flex justify-between items-center mb-2">
                                <div>
                                    <h4 class="font-bold text-sm text-white">${w.title}</h4>
                                    <p class="text-[10px] text-gray-400">${w.duration} ‚Ä¢ ${w.difficulty}</p>
                                </div>
                                <button class="text-xs bg-white/10 hover:bg-white/20 px-2 py-1 rounded text-white transition" 
                                    onclick="window.location.href='/?gym_id=${localGymId}&role=trainer&mode=workout&workout_id=${w.id}'">
                                    Preview
                                </button>
                            </div>
                            <button class="w-full py-1.5 bg-green-600/20 hover:bg-green-600 text-green-400 hover:text-white text-xs font-bold rounded-lg transition border border-green-500/30"
                                onclick="window.assignWorkoutToSelf('${w.id}', '${w.title}')">‚úÖ Assign to Me (Today)
                            </button>
                        `;
                        workoutCardContainer.appendChild(div);
                    });
                }
            }

            // Render My Splits
            const splitCardContainer = document.getElementById('my-split-card-container');
            if (splitCardContainer && data.splits) {
                if (data.splits.length === 0) {
                    splitCardContainer.innerHTML = '<p class="text-xs text-gray-500 italic text-center py-2">No splits created yet.</p>';
                } else {
                    splitCardContainer.innerHTML = '';
                    data.splits.forEach(s => {
                        const div = document.createElement('div');
                        div.className = "glass-card p-3 mb-2";
                        div.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-bold text-sm text-white">${s.name}</h4>
                                    <p class="text-[10px] text-gray-400">${s.description || 'No description'}</p>
                                </div>
                                <span class="text-[10px] bg-primary/20 text-primary px-2 py-0.5 rounded">${s.days_per_week} Days</span>
                            </div>
                        `;
                        splitCardContainer.appendChild(div);
                    });
                }
            }

            renderCalendarStrip();
            renderSchedule(selectedDateStr);
        } catch (e) {
            console.error("Error fetching trainer data:", e);
        }
    }

    window.changeWeek = function (offset) {
        currentWeekMonday.setDate(currentWeekMonday.getDate() + (offset * 7));
        selectedDateStr = toLocalISO(currentWeekMonday);
        renderCalendarStrip();
        renderSchedule(selectedDateStr);
    };

    function renderCalendarStrip() {
        const daysContainer = document.getElementById('calendar-strip');
        if (!daysContainer) return;
        daysContainer.innerHTML = '';
        const monthLabel = document.getElementById('month-label');
        if (monthLabel) monthLabel.innerText = currentWeekMonday.toLocaleDateString('en-US', { month: 'short' });

        for (let i = 0; i < 7; i++) {
            const d = new Date(currentWeekMonday);
            d.setDate(currentWeekMonday.getDate() + i);

            const dateStr = toLocalISO(d);
            const isSelected = dateStr === selectedDateStr;
            const isToday = dateStr === toLocalISO(new Date());

            const div = document.createElement('div');
            div.className = `flex flex-col items-center p-2 rounded cursor-pointer transition ${isSelected ? 'bg-white/10 text-white' : 'text-white/40 hover:bg-white/5'}`;
            if (isToday && !isSelected) div.classList.add('border', 'border-white/10');

            const dayName = d.toLocaleDateString('en-US', { weekday: 'narrow' });
            const dayNum = d.getDate();

            const hasEvents = currentSchedule.some(e => e.date === dateStr);
            const dot = hasEvents ? `<div class="w-1 h-1 rounded-full bg-primary mt-1"></div>` : '';

            div.innerHTML = `<span class="opacity-50">${dayName}</span><span>${dayNum}</span>${dot}`;

            div.onclick = () => {
                selectedDateStr = dateStr;
                renderCalendarStrip();
                renderSchedule(dateStr);
            };

            daysContainer.appendChild(div);
        }
    }

    function renderSchedule(dateStr) {
        const container = document.getElementById('schedule-container');
        if (!container) return;

        const [y, m, d] = dateStr.split('-').map(Number);
        const dateObj = new Date(y, m - 1, d);
        const dateEl = document.getElementById('current-full-date');
        if (dateEl) dateEl.innerText = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

        container.innerHTML = '';

        const dayEvents = currentSchedule.filter(e => e.date === dateStr);
        dayEvents.sort((a, b) => a.time.localeCompare(b.time));

        dayEvents.forEach(s => {
            const div = document.createElement('div');
            const opacityClass = s.completed ? 'opacity-50 grayscale' : '';
            div.className = `flex justify-between items-center bg-white/5 border border-white/5 rounded-xl p-3 slide-up group relative ${opacityClass}`;

            let colorClass = "text-blue-400 bg-blue-500/20";
            if (s.type === 'personal') colorClass = "text-green-400 bg-green-500/20";
            if (s.type === 'class') colorClass = "text-yellow-400 bg-yellow-500/20";

            let [h, m] = s.time.split(':');
            let ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12;
            h = h ? h : 12;

            div.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 rounded-lg ${colorClass} flex flex-col items-center justify-center">
                        <span class="font-bold text-lg leading-none">${h}</span>
                        <span class="text-[9px] uppercase">${ampm}</span>
                    </div>
                    <div>
                        <p class="text-[10px] text-white/30">${s.duration || 60} min</p>
                        <h4 class="font-bold text-sm text-white ${s.completed ? 'line-through text-white/50' : ''}">${s.title}</h4>
                        <p class="text-xs text-white/50">${s.subtitle}</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="toggleComplete('${s.id}')" 
                        class="w-10 h-10 rounded-full flex items-center justify-center border-2 transition-all duration-300 group/btn relative overflow-hidden
                        ${s.completed
                    ? 'bg-green-500 border-green-500 text-white shadow-[0_0_15px_rgba(34,197,94,0.5)]'
                    : 'border-white/20 text-transparent hover:border-white/50 hover:bg-white/5'}">
                        <span class="transform transition-transform duration-300 ${s.completed ? 'scale-100' : 'scale-0'}">‚úì</span>
                    </button>
                    <button onclick="deleteEvent('${s.id}')" class="text-red-500 opacity-0 group-hover:opacity-100 transition p-2 hover:bg-white/10 rounded-lg cursor-pointer z-10">
                        <span class="text-lg">‚úï</span>
                    </button>
                </div>
            `;
            container.appendChild(div);
        });

        // Add Button (Free Slot)
        const addDiv = document.createElement('div');
        addDiv.className = "flex items-center justify-center space-x-3 p-3 rounded-xl border border-white/20 border-dashed hover:bg-white/5 transition cursor-pointer group py-4";
        addDiv.onclick = () => openAddModal(dateStr);
        addDiv.innerHTML = `
             <div class="flex items-center justify-center text-white/50 group-hover:text-white transition">
                <span class="text-2xl font-light mr-2">+</span>
                <span class="font-bold text-sm text-white/60 group-hover:text-white transition">Free Slot</span>
            </div>
        `;
        container.appendChild(addDiv);
    }

    async function openAddModal(dateStr) {
        const dateInput = document.getElementById('event-date-input');
        if (dateInput) dateInput.value = dateStr;
        window.showModal('add-event-modal');

        // Fetch workouts for selector
        const select = document.getElementById('event-workout-select');
        if (select && select.options.length <= 1) {
            try {
                const res = await fetch('/api/trainer/workouts');
                const workouts = await res.json();
                workouts.forEach(w => {
                    const opt = document.createElement('option');
                    opt.value = w.id;
                    opt.innerText = w.title;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error("Failed to load workouts", e);
            }
        }
    }

    const addEventForm = document.getElementById('add-event-form');
    if (addEventForm) {
        addEventForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.duration = parseInt(data.duration) || 60;

            try {
                const res = await fetch('/api/trainer/events', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    await fetchTrainerData();
                    window.hideModal('add-event-modal');
                    e.target.reset();
                    const durationInput = e.target.querySelector('[name="duration"]');
                    if (durationInput) durationInput.value = 60;
                } else {
                    const err = await res.json();
                    alert(err.detail || "Failed to add event");
                }
            } catch (err) {
                console.error(err);
                alert("Network Error: " + err.message);
            }
        });
    }

    async function deleteEvent(id) {
        if (!confirm("Delete this event?")) return;
        try {
            const res = await fetch(`/api/trainer/events/${id}`, { method: 'DELETE' });
            if (res.ok) {
                await fetchTrainerData();
            } else {
                const text = await res.text();
                alert("Failed to delete event: " + text);
            }
        } catch (e) {
            console.error(e);
            alert("Error deleting event: " + e.message);
        }
    }

    async function toggleComplete(id) {
        try {
            const res = await fetch(`/api/trainer/events/${id}/toggle_complete`, { method: 'POST' });
            if (res.ok) {
                await fetchTrainerData();
            } else {
                const text = await res.text();
                alert("Failed to toggle completion: " + text);
            }
        } catch (e) {
            console.error(e);
            alert("Error: " + e.message);
        }
    }
</script>
{% endblock %}