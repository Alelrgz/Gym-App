{% extends "base.html" %}
{% from "macros.html" import card %}

{% block content %}

<!-- ===== MOBILE HEADER ===== -->
<header class="staff-mobile-header nutritionist-mobile-header">
    <div class="staff-mobile-header-logo">
        <img src="/static/fitos-logo.svg" alt="FitOS" class="staff-logo-img">
        <span class="staff-role-label">Nutrizionista</span>
    </div>
    <div class="staff-mobile-header-actions">
        <button class="staff-mobile-msg-btn relative" onclick="nutriOpenConversations()">
            <i data-lucide="message-circle" class="w-5 h-5"></i>
            <span id="unread-messages-badge-mobile" class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white text-[8px] font-bold rounded-full flex items-center justify-center hidden">0</span>
        </button>
        <button class="staff-mobile-msg-btn" onclick="nutriOpenNotifications()">
            <i data-lucide="bell" class="w-5 h-5"></i>
        </button>
        <a href="/auth/logout" class="staff-mobile-msg-btn" style="color:#f87171;">
            <i data-lucide="log-out" class="w-5 h-5"></i>
        </a>
    </div>
</header>

<!-- Desktop Sidebar + Main Content Layout -->
<div class="nutritionist-layout">

    <!-- ===== LEFT SIDEBAR (desktop) ===== -->
    <aside class="staff-sidebar nutritionist-sidebar">
        <div class="staff-sidebar-logo">
            <img src="/static/fitos-logo.svg" alt="FitOS" class="staff-logo-img staff-logo-img--sidebar">
            <span class="staff-role-label">Nutrizionista</span>
        </div>

        <nav class="staff-sidebar-nav">
            <button onclick="switchNutriSection('dashboard')"
                    class="staff-nav-item active sidebar-nav-item"
                    data-section="dashboard">
                <i data-lucide="home" class="w-[18px] h-[18px]"></i>
                <span>Dashboard</span>
            </button>
            <button onclick="nutriOpenConversations()"
                    class="staff-nav-item sidebar-nav-item relative">
                <i data-lucide="message-circle" class="w-[18px] h-[18px]"></i>
                <span>Messaggi</span>
                <span id="unread-messages-badge" class="absolute top-1 right-1 w-4 h-4 bg-red-500 text-white text-[8px] font-bold rounded-full flex items-center justify-center hidden">0</span>
            </button>
            <button onclick="switchNutriSection('settings')"
                    class="staff-nav-item sidebar-nav-item"
                    data-section="settings">
                <i data-lucide="settings" class="w-[18px] h-[18px]"></i>
                <span>Impostazioni</span>
            </button>
        </nav>

        <div style="flex:1"></div>

        <a href="/auth/logout" class="staff-nav-item" style="color:#f87171;">
            <i data-lucide="log-out" class="w-[18px] h-[18px]"></i>
            <span>Esci</span>
        </a>
    </aside>

    <!-- Main Content Area -->
    <main class="nutritionist-main">

        <!-- ==================== SECTION: DASHBOARD ==================== -->
        <section id="section-dashboard" class="nutritionist-section">

            <!-- Header -->
            <div class="flex items-center justify-between mb-6">
                <div>
                    <p class="text-xs text-green-400 font-bold uppercase tracking-widest">Dashboard Nutrizionista</p>
                    <h1 class="text-2xl font-black text-white" id="nutri-name">Caricamento...</h1>
                </div>
                <div class="flex items-center gap-2">
                    <div onclick="nutriOpenConversations()" class="relative w-11 h-11 rounded-xl glass-card-interactive flex items-center justify-center cursor-pointer">
                        <i data-lucide="message-circle" class="w-5 h-5 text-gray-400"></i>
                        <span id="unread-messages-badge-desktop" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center hidden">0</span>
                    </div>
                    <button class="staff-mobile-msg-btn" onclick="nutriOpenNotifications()">
                        <i data-lucide="bell" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                {% call card(classes="p-4 text-center") %}
                    <p class="text-2xl font-black text-green-400" id="stat-active">0</p>
                    <p class="text-xs text-gray-400 font-bold uppercase mt-1">Clienti Attivi</p>
                {% endcall %}
                {% call card(classes="p-4 text-center") %}
                    <p class="text-2xl font-black text-red-400" id="stat-at-risk">0</p>
                    <p class="text-xs text-gray-400 font-bold uppercase mt-1">A Rischio</p>
                {% endcall %}
                {% call card(classes="p-4 text-center") %}
                    <p class="text-2xl font-black text-white" id="stat-total">0</p>
                    <p class="text-xs text-gray-400 font-bold uppercase mt-1">Clienti Totali</p>
                {% endcall %}
                {% call card(classes="p-4 text-center") %}
                    <p class="text-2xl font-black text-orange-400" id="stat-diets">0</p>
                    <p class="text-xs text-gray-400 font-bold uppercase mt-1">Diete Impostate</p>
                {% endcall %}
            </div>

            <!-- Availability + Appointments Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                <!-- Availability -->
                {% call card(classes="p-4") %}
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <div class="w-7 h-7 rounded-lg bg-cyan-500/20 flex items-center justify-center">
                                <i data-lucide="clock" class="w-4 h-4 text-cyan-400"></i>
                            </div>
                            <h3 class="text-sm font-bold text-cyan-400 uppercase tracking-wider">Disponibilit&agrave;</h3>
                        </div>
                        <button onclick="openNutriAvailabilityModal()" class="text-xs bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 px-4 py-2 rounded-lg transition">
                            Configura Disponibilit&agrave;
                        </button>
                    </div>
                    <div id="nutri-availability-summary" class="text-sm text-gray-400">
                        Caricamento...
                    </div>
                {% endcall %}

                <!-- Upcoming Appointments -->
                {% call card(classes="p-4") %}
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-7 h-7 rounded-lg bg-orange-500/20 flex items-center justify-center">
                            <i data-lucide="calendar" class="w-4 h-4 text-orange-400"></i>
                        </div>
                        <h3 class="text-sm font-bold text-orange-400 uppercase tracking-wider">Prossimi Appuntamenti</h3>
                    </div>
                    <div id="nutri-appointments-list" class="space-y-2 max-h-48 overflow-y-auto">
                        <p class="text-sm text-gray-500">Nessun appuntamento</p>
                    </div>
                {% endcall %}
            </div>

            <!-- Two-column layout: Client List + Detail -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <!-- Client List (1/3) -->
                <div>
                    <div class="flex items-center gap-2 mb-3 border-l-4 border-green-400 pl-3">
                        <div class="w-7 h-7 rounded-lg bg-green-500/20 flex items-center justify-center">
                            <i data-lucide="users" class="w-4 h-4 text-green-400"></i>
                        </div>
                        <div>
                            <h3 class="text-sm font-bold text-green-400 uppercase tracking-wider">Clienti</h3>
                            <p class="text-xs text-gray-500">I membri della tua palestra</p>
                        </div>
                    </div>
                    {% call card(classes="overflow-hidden") %}
                        <div class="p-3 border-b border-white/5">
                            <div class="relative">
                                <i data-lucide="search" class="w-4 h-4 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                <input type="text" placeholder="Cerca clienti..."
                                    class="w-full bg-white/5 border border-white/10 rounded-lg pl-9 pr-3 py-2 text-sm text-white outline-none focus:border-green-500/50"
                                    oninput="filterNutriClients(this.value)">
                            </div>
                        </div>
                        <div id="nutri-client-list" class="max-h-[60vh] overflow-y-auto">
                            <div class="p-4 text-center text-gray-500 text-sm">Caricamento clienti...</div>
                        </div>
                    {% endcall %}
                </div>

                <!-- Client Detail Panel (2/3) -->
                <div class="lg:col-span-2" id="client-detail-panel" style="display:none;">

                    <!-- Client header -->
                    <div class="flex items-center gap-3 mb-4">
                        <div id="detail-client-avatar-wrap" class="w-12 h-12 rounded-full border-2 border-green-500/30 overflow-hidden flex-shrink-0 flex items-center justify-center bg-white/10">
                            <span id="detail-client-initials" class="text-lg font-bold text-white">?</span>
                            <img id="detail-client-avatar" class="w-full h-full object-cover hidden" onerror="this.classList.add('hidden');this.previousElementSibling.classList.remove('hidden')">
                        </div>
                        <div class="flex-1">
                            <h2 class="text-xl font-bold text-white" id="detail-client-name"></h2>
                            <p class="text-xs text-gray-400" id="detail-client-status"></p>
                        </div>
                        <button onclick="chatWithSelectedClient()" class="flex items-center gap-2 bg-white/10 hover:bg-white/15 border border-white/10 text-white font-semibold py-2 px-4 rounded-xl transition text-sm">
                            <i data-lucide="message-circle" class="w-4 h-4"></i> Messaggio
                        </button>
                    </div>

                    <!-- Current Stats -->
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
                        <div class="glass-card p-3 text-center">
                            <p class="text-lg font-bold text-white" id="detail-weight">—</p>
                            <p class="text-[10px] text-gray-500 uppercase">Peso (kg)</p>
                        </div>
                        <div class="glass-card p-3 text-center">
                            <p class="text-lg font-bold text-white" id="detail-bodyfat">—</p>
                            <p class="text-[10px] text-gray-500 uppercase">Massa Grassa %</p>
                        </div>
                        <div class="glass-card p-3 text-center">
                            <p class="text-lg font-bold text-white" id="detail-leanmass">—</p>
                            <p class="text-[10px] text-gray-500 uppercase">Massa Magra</p>
                        </div>
                        <div class="glass-card p-3 text-center">
                            <p class="text-lg font-bold text-white" id="detail-fatmass">—</p>
                            <p class="text-[10px] text-gray-500 uppercase">Massa Grassa</p>
                        </div>
                    </div>

                    <!-- Body Composition Form -->
                    <div class="flex items-center gap-2 mb-3 border-l-4 border-orange-400 pl-3">
                        <div class="w-7 h-7 rounded-lg bg-orange-500/20 flex items-center justify-center">
                            <i data-lucide="activity" class="w-4 h-4 text-orange-400"></i>
                        </div>
                        <h3 class="text-sm font-bold text-orange-400 uppercase tracking-wider">Aggiungi Composizione Corporea</h3>
                    </div>
                    {% call card(classes="p-4 mb-4") %}
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                            <div>
                                <label class="text-[10px] text-gray-400 uppercase font-bold">Peso (kg) *</label>
                                <input type="number" step="0.1" id="bc-weight" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm mt-1 outline-none focus:border-orange-500/50">
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-400 uppercase font-bold">Massa Grassa %</label>
                                <input type="number" step="0.1" id="bc-bodyfat" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm mt-1 outline-none focus:border-orange-500/50">
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-400 uppercase font-bold">Massa Grassa (kg)</label>
                                <input type="number" step="0.1" id="bc-fatmass" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm mt-1 outline-none focus:border-orange-500/50">
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-400 uppercase font-bold">Massa Magra (kg)</label>
                                <input type="number" step="0.1" id="bc-leanmass" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm mt-1 outline-none focus:border-orange-500/50">
                            </div>
                        </div>
                        <button onclick="submitBodyComposition()" class="mt-3 bg-orange-500 hover:bg-orange-400 text-white font-bold py-2.5 px-6 rounded-xl transition text-sm">
                            <i data-lucide="plus" class="w-4 h-4 inline-block align-middle mr-1"></i> Registra Misurazione
                        </button>
                    {% endcall %}

                    <!-- Weight Goal + Diet Assignment side by side -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                        <!-- Weight Goal -->
                        <div>
                            <div class="flex items-center gap-2 mb-3 border-l-4 border-purple-400 pl-3">
                                <div class="w-7 h-7 rounded-lg bg-purple-500/20 flex items-center justify-center">
                                    <i data-lucide="target" class="w-4 h-4 text-purple-400"></i>
                                </div>
                                <h3 class="text-sm font-bold text-purple-400 uppercase tracking-wider">Obiettivo Peso</h3>
                            </div>
                            {% call card(classes="p-4") %}
                                <p class="text-xs text-gray-400 mb-2">Obiettivo attuale: <span id="detail-weight-goal" class="text-white font-bold">Non impostato</span></p>
                                <div class="flex gap-2">
                                    <input type="number" step="0.1" id="weight-goal-input" placeholder="Peso obiettivo kg"
                                        class="flex-1 bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm outline-none focus:border-purple-500/50">
                                    <button onclick="setWeightGoal()" class="bg-purple-500 hover:bg-purple-400 text-white font-bold py-2 px-4 rounded-xl transition text-sm">Imposta</button>
                                </div>
                            {% endcall %}
                        </div>

                        <!-- Diet Assignment -->
                        <div>
                            <div class="flex items-center gap-2 mb-3 border-l-4 border-teal-400 pl-3">
                                <div class="w-7 h-7 rounded-lg bg-teal-500/20 flex items-center justify-center">
                                    <i data-lucide="utensils" class="w-4 h-4 text-teal-400"></i>
                                </div>
                                <h3 class="text-sm font-bold text-teal-400 uppercase tracking-wider">Piano Dieta</h3>
                            </div>
                            {% call card(classes="p-4") %}
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-[10px] text-gray-400 uppercase font-bold">Calorie</label>
                                        <input type="number" id="diet-calories" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm mt-1 outline-none focus:border-teal-500/50">
                                    </div>
                                    <div>
                                        <label class="text-[10px] text-gray-400 uppercase font-bold">Proteine (g)</label>
                                        <input type="number" id="diet-protein" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm mt-1 outline-none focus:border-teal-500/50">
                                    </div>
                                    <div>
                                        <label class="text-[10px] text-gray-400 uppercase font-bold">Carboidrati (g)</label>
                                        <input type="number" id="diet-carbs" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm mt-1 outline-none focus:border-teal-500/50">
                                    </div>
                                    <div>
                                        <label class="text-[10px] text-gray-400 uppercase font-bold">Grassi (g)</label>
                                        <input type="number" id="diet-fat" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm mt-1 outline-none focus:border-teal-500/50">
                                    </div>
                                </div>
                                <button onclick="assignDiet()" class="mt-3 w-full bg-teal-500 hover:bg-teal-400 text-white font-bold py-2.5 rounded-xl transition text-sm">
                                    Assegna Dieta
                                </button>
                            {% endcall %}
                        </div>
                    </div>

                    <!-- Weekly Meal Plan Editor -->
                    <div class="flex items-center gap-2 mb-3 border-l-4 border-amber-400 pl-3">
                        <div class="w-7 h-7 rounded-lg bg-amber-500/20 flex items-center justify-center">
                            <i data-lucide="calendar-days" class="w-4 h-4 text-amber-400"></i>
                        </div>
                        <h3 class="text-sm font-bold text-amber-400 uppercase tracking-wider">Piano Alimentare Settimanale</h3>
                    </div>
                    {% call card(classes="p-4 mb-4") %}
                        <!-- Day selector tabs -->
                        <div class="flex gap-1 mb-4 overflow-x-auto pb-1" id="meal-plan-day-tabs">
                            <button onclick="selectMealPlanDay(0)" data-mp-day="0" class="text-xs px-3 py-1.5 rounded-lg bg-amber-500/20 text-amber-400 font-bold whitespace-nowrap transition">LUN</button>
                            <button onclick="selectMealPlanDay(1)" data-mp-day="1" class="text-xs px-3 py-1.5 rounded-lg bg-white/5 text-gray-400 font-bold whitespace-nowrap transition hover:bg-white/10">MAR</button>
                            <button onclick="selectMealPlanDay(2)" data-mp-day="2" class="text-xs px-3 py-1.5 rounded-lg bg-white/5 text-gray-400 font-bold whitespace-nowrap transition hover:bg-white/10">MER</button>
                            <button onclick="selectMealPlanDay(3)" data-mp-day="3" class="text-xs px-3 py-1.5 rounded-lg bg-white/5 text-gray-400 font-bold whitespace-nowrap transition hover:bg-white/10">GIO</button>
                            <button onclick="selectMealPlanDay(4)" data-mp-day="4" class="text-xs px-3 py-1.5 rounded-lg bg-white/5 text-gray-400 font-bold whitespace-nowrap transition hover:bg-white/10">VEN</button>
                            <button onclick="selectMealPlanDay(5)" data-mp-day="5" class="text-xs px-3 py-1.5 rounded-lg bg-white/5 text-gray-400 font-bold whitespace-nowrap transition hover:bg-white/10">SAB</button>
                            <button onclick="selectMealPlanDay(6)" data-mp-day="6" class="text-xs px-3 py-1.5 rounded-lg bg-white/5 text-gray-400 font-bold whitespace-nowrap transition hover:bg-white/10">DOM</button>
                        </div>

                        <!-- Meal entries for selected day -->
                        <div id="meal-plan-entries" class="space-y-3">
                            <!-- Dynamically populated -->
                        </div>

                        <!-- Add meal button -->
                        <button onclick="addMealPlanEntry()" class="mt-3 w-full bg-white/5 hover:bg-white/10 border border-dashed border-white/10 text-gray-400 hover:text-white py-2 rounded-xl transition text-sm flex items-center justify-center gap-1">
                            <i data-lucide="plus" class="w-3.5 h-3.5 inline-block align-middle"></i> Aggiungi Pasto
                        </button>

                        <!-- Save button -->
                        <button onclick="saveMealPlan()" class="mt-3 w-full bg-amber-500 hover:bg-amber-400 text-white font-bold py-2.5 rounded-xl transition text-sm">
                            Salva Piano Giornaliero
                        </button>
                    {% endcall %}

                    <!-- Charts -->
                    <div class="flex items-center gap-2 mb-3 border-l-4 border-blue-400 pl-3">
                        <div class="w-7 h-7 rounded-lg bg-blue-500/20 flex items-center justify-center">
                            <i data-lucide="trending-up" class="w-4 h-4 text-blue-400"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-sm font-bold text-blue-400 uppercase tracking-wider">Grafici Progressi</h3>
                        </div>
                        <select id="chart-period" onchange="loadClientCharts()" class="bg-white/5 border border-white/10 rounded-lg px-2 py-1 text-xs text-white outline-none">
                            <option value="week">Settimana</option>
                            <option value="month" selected>Mese</option>
                            <option value="year">Anno</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        {% call card(classes="p-4") %}
                            <h4 class="text-xs font-bold text-gray-400 uppercase mb-3">Andamento Peso</h4>
                            <canvas id="nutri-weight-chart" height="200"></canvas>
                        {% endcall %}
                        {% call card(classes="p-4") %}
                            <h4 class="text-xs font-bold text-gray-400 uppercase mb-3">Costanza Dieta</h4>
                            <canvas id="nutri-diet-chart" height="200"></canvas>
                        {% endcall %}
                    </div>

                </div>

                <!-- Empty state when no client selected -->
                <div class="lg:col-span-2" id="no-client-selected">
                    {% call card(classes="p-12 text-center") %}
                        <i data-lucide="user-check" class="w-12 h-12 text-gray-600 mx-auto mb-3"></i>
                        <p class="text-gray-500 text-sm">Seleziona un cliente dalla lista per visualizzare i suoi dati</p>
                    {% endcall %}
                </div>
            </div>
        </section>

        <!-- ==================== SECTION: SETTINGS ==================== -->
        <section id="section-settings" class="nutritionist-section" style="display:none;">
            <div class="max-w-2xl">
                <h1 class="text-2xl font-black text-white mb-6">Impostazioni</h1>
                {% call card(classes="p-6") %}
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-gray-400 uppercase font-bold">Bio</label>
                            <textarea id="settings-bio" rows="3" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm mt-1 outline-none focus:border-green-500/50" placeholder="Scrivi una breve biografia..."></textarea>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 uppercase font-bold">Specializzazioni</label>
                            <input type="text" id="settings-specialties" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm mt-1 outline-none focus:border-green-500/50" placeholder="es. Nutrizione Sportiva, Gestione del Peso">
                        </div>
                        <button onclick="saveSettings()" class="bg-green-500 hover:bg-green-400 text-white font-bold py-2.5 px-6 rounded-xl transition text-sm">
                            Salva Impostazioni
                        </button>
                    </div>
                {% endcall %}
            </div>
        </section>

    </main>
</div>

<!-- Nutritionist Availability Modal -->
<div id="nutri-availability-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50 backdrop-blur-sm">
    <div class="glass-card w-full max-w-md mx-4 p-6 rounded-2xl relative max-h-[90vh] overflow-y-auto">
        <button onclick="closeNutriAvailabilityModal()" class="absolute top-4 right-4 text-white/50 hover:text-white">&times;</button>
        <h3 class="text-xl font-bold mb-2 text-center">Disponibilit&agrave; Consulenze</h3>
        <p class="text-xs text-gray-400 text-center mb-4">Imposta i tuoi orari settimanali per le prenotazioni</p>

        <div id="nutri-availability-days" class="space-y-3">
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-nutri-day="0" class="nutri-day-toggle w-5 h-5 rounded accent-cyan-500">
                    <span class="font-bold text-sm">Luned&igrave;</span>
                </label>
                <div class="nutri-day-times hidden grid grid-cols-2 gap-2 mt-2" data-nutri-day="0">
                    <div><label class="text-[10px] text-gray-400">Inizio</label><input type="time" class="nutri-start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="09:00"></div>
                    <div><label class="text-[10px] text-gray-400">Fine</label><input type="time" class="nutri-end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="17:00"></div>
                </div>
            </div>
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-nutri-day="1" class="nutri-day-toggle w-5 h-5 rounded accent-cyan-500">
                    <span class="font-bold text-sm">Marted&igrave;</span>
                </label>
                <div class="nutri-day-times hidden grid grid-cols-2 gap-2 mt-2" data-nutri-day="1">
                    <div><label class="text-[10px] text-gray-400">Inizio</label><input type="time" class="nutri-start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="09:00"></div>
                    <div><label class="text-[10px] text-gray-400">Fine</label><input type="time" class="nutri-end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="17:00"></div>
                </div>
            </div>
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-nutri-day="2" class="nutri-day-toggle w-5 h-5 rounded accent-cyan-500">
                    <span class="font-bold text-sm">Mercoled&igrave;</span>
                </label>
                <div class="nutri-day-times hidden grid grid-cols-2 gap-2 mt-2" data-nutri-day="2">
                    <div><label class="text-[10px] text-gray-400">Inizio</label><input type="time" class="nutri-start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="09:00"></div>
                    <div><label class="text-[10px] text-gray-400">Fine</label><input type="time" class="nutri-end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="17:00"></div>
                </div>
            </div>
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-nutri-day="3" class="nutri-day-toggle w-5 h-5 rounded accent-cyan-500">
                    <span class="font-bold text-sm">Gioved&igrave;</span>
                </label>
                <div class="nutri-day-times hidden grid grid-cols-2 gap-2 mt-2" data-nutri-day="3">
                    <div><label class="text-[10px] text-gray-400">Inizio</label><input type="time" class="nutri-start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="09:00"></div>
                    <div><label class="text-[10px] text-gray-400">Fine</label><input type="time" class="nutri-end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="17:00"></div>
                </div>
            </div>
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-nutri-day="4" class="nutri-day-toggle w-5 h-5 rounded accent-cyan-500">
                    <span class="font-bold text-sm">Venerd&igrave;</span>
                </label>
                <div class="nutri-day-times hidden grid grid-cols-2 gap-2 mt-2" data-nutri-day="4">
                    <div><label class="text-[10px] text-gray-400">Inizio</label><input type="time" class="nutri-start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="09:00"></div>
                    <div><label class="text-[10px] text-gray-400">Fine</label><input type="time" class="nutri-end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="17:00"></div>
                </div>
            </div>
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-nutri-day="5" class="nutri-day-toggle w-5 h-5 rounded accent-cyan-500">
                    <span class="font-bold text-sm">Sabato</span>
                </label>
                <div class="nutri-day-times hidden grid grid-cols-2 gap-2 mt-2" data-nutri-day="5">
                    <div><label class="text-[10px] text-gray-400">Inizio</label><input type="time" class="nutri-start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="10:00"></div>
                    <div><label class="text-[10px] text-gray-400">Fine</label><input type="time" class="nutri-end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="14:00"></div>
                </div>
            </div>
            <div class="bg-white/5 rounded-xl p-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" data-nutri-day="6" class="nutri-day-toggle w-5 h-5 rounded accent-cyan-500">
                    <span class="font-bold text-sm">Domenica</span>
                </label>
                <div class="nutri-day-times hidden grid grid-cols-2 gap-2 mt-2" data-nutri-day="6">
                    <div><label class="text-[10px] text-gray-400">Inizio</label><input type="time" class="nutri-start-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="10:00"></div>
                    <div><label class="text-[10px] text-gray-400">Fine</label><input type="time" class="nutri-end-time w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm" value="14:00"></div>
                </div>
            </div>
        </div>

        <!-- Session Rate -->
        <div class="mt-4 bg-white/5 rounded-xl p-3">
            <label class="text-sm font-bold text-white mb-2 block">Tariffa Oraria Consulenza (&euro;)</label>
            <p class="text-[10px] text-gray-400 mb-2">I clienti vedranno questo prezzo durante la prenotazione. Lascia vuoto per consulenze gratuite.</p>
            <input type="number" id="nutri-session-rate" min="0" step="0.01" placeholder="es. 50.00"
                class="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm">
        </div>

        <button onclick="saveNutriAvailability()"
            class="w-full mt-4 py-3 bg-cyan-500 text-white font-bold rounded-xl hover:bg-cyan-600 transition">
            Salva Disponibilit&agrave;
        </button>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
// ===================== STATE =====================
let nutriData = null;
let selectedClientId = null;
let weightChartInstance = null;
let dietChartInstance = null;

// ===================== INIT =====================
document.addEventListener('DOMContentLoaded', async () => {
    await loadNutritionistData();
    setupNutriDayToggles();
    loadNutriAvailabilitySummary();
    loadNutriAppointments();
    if (typeof lucide !== 'undefined') lucide.createIcons();
    // Load unread message count
    if (typeof updateUnreadBadge === 'function') updateUnreadBadge();
});

// ===================== DATA LOADING =====================
async function loadNutritionistData() {
    try {
        const res = await fetch('/api/nutritionist/data', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load');
        nutriData = await res.json();

        document.getElementById('nutri-name').textContent = nutriData.name || 'Nutrizionista';
        document.getElementById('stat-active').textContent = nutriData.active_clients;
        document.getElementById('stat-at-risk').textContent = nutriData.at_risk_clients;
        document.getElementById('stat-total').textContent = nutriData.clients.length;
        document.getElementById('stat-diets').textContent = nutriData.clients.filter(c => c.calories_target).length;

        renderClientList(nutriData.clients);
    } catch (e) {
        console.error('Failed to load nutritionist data:', e);
    }
}

function _clientAvatar(c) {
    if (c.profile_picture) {
        return `<img src="${c.profile_picture}" class="w-9 h-9 rounded-full object-cover flex-shrink-0" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
                <div class="w-9 h-9 rounded-full bg-white/10 flex-shrink-0 items-center justify-center text-xs font-bold text-white" style="display:none">${(c.name || '?')[0].toUpperCase()}</div>`;
    }
    return `<div class="w-9 h-9 rounded-full bg-white/10 flex-shrink-0 flex items-center justify-center text-xs font-bold text-white">${(c.name || '?')[0].toUpperCase()}</div>`;
}

function renderClientList(clients) {
    const container = document.getElementById('nutri-client-list');
    if (!clients.length) {
        container.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">Nessun cliente nella tua palestra</div>';
        return;
    }
    container.innerHTML = clients.map(c => `
        <div class="p-3 border-b border-white/5 flex items-center gap-3 cursor-pointer hover:bg-white/5 transition ${selectedClientId === c.id ? 'bg-green-500/10 border-l-2 border-l-green-400' : ''}"
             onclick="selectClient('${c.id}')">
            ${_clientAvatar(c)}
            <div class="flex-1 min-w-0">
                <p class="text-white font-medium text-sm truncate">${c.name}</p>
                <p class="text-[10px] ${c.status === 'Active' ? 'text-green-400' : 'text-red-400'}">${c.status === 'Active' ? 'Attivo' : c.status === 'Inactive' ? 'Inattivo' : c.status} · ${c.weight ? c.weight + 'kg' : 'Nessun dato'}</p>
            </div>
            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-600 flex-shrink-0"></i>
        </div>
    `).join('');
    if (typeof lucide !== 'undefined') lucide.createIcons();
}

function filterNutriClients(query) {
    if (!nutriData) return;
    const q = query.toLowerCase();
    const filtered = nutriData.clients.filter(c => c.name.toLowerCase().includes(q));
    renderClientList(filtered);
}

// ===================== CLIENT DETAIL =====================
async function selectClient(clientId) {
    selectedClientId = clientId;
    document.getElementById('client-detail-panel').style.display = 'block';
    document.getElementById('no-client-selected').style.display = 'none';

    // Re-render list to show selection highlight
    if (nutriData) renderClientList(nutriData.clients);

    try {
        const res = await fetch(`/api/nutritionist/client/${clientId}`, { credentials: 'include' });
        const data = await res.json();

        document.getElementById('detail-client-name').textContent = data.name;
        const avatarImg = document.getElementById('detail-client-avatar');
        const avatarInitials = document.getElementById('detail-client-initials');
        if (data.profile_picture) {
            avatarImg.src = data.profile_picture;
            avatarImg.classList.remove('hidden');
            avatarInitials.classList.add('hidden');
        } else {
            avatarImg.classList.add('hidden');
            avatarInitials.classList.remove('hidden');
            avatarInitials.textContent = (data.name || '?')[0].toUpperCase();
        }
        document.getElementById('detail-client-status').textContent = `Peso: ${data.weight || '—'}kg · Massa Grassa: ${data.body_fat_pct || '—'}%`;

        document.getElementById('detail-weight').textContent = data.weight ? data.weight + 'kg' : '—';
        document.getElementById('detail-bodyfat').textContent = data.body_fat_pct ? data.body_fat_pct + '%' : '—';
        document.getElementById('detail-leanmass').textContent = data.lean_mass ? data.lean_mass + 'kg' : '—';
        document.getElementById('detail-fatmass').textContent = data.fat_mass ? data.fat_mass + 'kg' : '—';

        // Weight goal
        document.getElementById('detail-weight-goal').textContent = data.weight_goal ? data.weight_goal + ' kg' : 'Non impostato';
        document.getElementById('weight-goal-input').value = data.weight_goal || '';

        // Diet fields
        if (data.diet) {
            document.getElementById('diet-calories').value = data.diet.calories_target || '';
            document.getElementById('diet-protein').value = data.diet.protein_target || '';
            document.getElementById('diet-carbs').value = data.diet.carbs_target || '';
            document.getElementById('diet-fat').value = data.diet.fat_target || '';
        } else {
            document.getElementById('diet-calories').value = '';
            document.getElementById('diet-protein').value = '';
            document.getElementById('diet-carbs').value = '';
            document.getElementById('diet-fat').value = '';
        }

        // Pre-fill body comp with current values
        document.getElementById('bc-weight').value = data.weight || '';
        document.getElementById('bc-bodyfat').value = data.body_fat_pct || '';
        document.getElementById('bc-fatmass').value = data.fat_mass || '';
        document.getElementById('bc-leanmass').value = data.lean_mass || '';

        await loadClientCharts();
        await loadClientMealPlan(clientId);
    } catch (e) {
        console.error('Failed to load client detail:', e);
        showToast('Impossibile caricare i dati del cliente', 'error');
    }
}

// ===================== BODY COMPOSITION =====================
async function submitBodyComposition() {
    if (!selectedClientId) return;
    const weight = parseFloat(document.getElementById('bc-weight').value);
    if (!weight || weight <= 0) { showToast('Il peso \u00e8 obbligatorio', 'error'); return; }

    try {
        const res = await fetch('/api/nutritionist/client/body-composition', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                client_id: selectedClientId,
                weight: weight,
                body_fat_pct: parseFloat(document.getElementById('bc-bodyfat').value) || null,
                fat_mass: parseFloat(document.getElementById('bc-fatmass').value) || null,
                lean_mass: parseFloat(document.getElementById('bc-leanmass').value) || null
            })
        });
        if (res.ok) {
            showToast('Composizione corporea registrata!', 'success');
            await selectClient(selectedClientId); // Refresh
        } else {
            const err = await res.json().catch(() => ({}));
            showToast(err.detail || 'Salvataggio fallito', 'error');
        }
    } catch (e) { showToast('Errore nel salvataggio della composizione corporea', 'error'); }
}

// ===================== WEIGHT GOAL =====================
async function setWeightGoal() {
    if (!selectedClientId) return;
    const goal = parseFloat(document.getElementById('weight-goal-input').value);
    if (!goal || goal <= 0) { showToast('Inserisci un obiettivo di peso valido', 'error'); return; }

    try {
        const res = await fetch('/api/nutritionist/client/weight-goal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ client_id: selectedClientId, weight_goal: goal })
        });
        if (res.ok) {
            showToast('Obiettivo peso impostato!', 'success');
            document.getElementById('detail-weight-goal').textContent = goal + ' kg';
        } else {
            showToast('Impossibile impostare obiettivo peso', 'error');
        }
    } catch (e) { showToast('Errore nell\'impostazione obiettivo peso', 'error'); }
}

// ===================== DIET ASSIGNMENT =====================
async function assignDiet() {
    if (!selectedClientId) return;
    const calories = parseInt(document.getElementById('diet-calories').value);
    const protein = parseInt(document.getElementById('diet-protein').value);
    const carbs = parseInt(document.getElementById('diet-carbs').value);
    const fat = parseInt(document.getElementById('diet-fat').value);

    if (!calories) { showToast('Le calorie sono obbligatorie', 'error'); return; }

    try {
        const res = await fetch('/api/nutritionist/assign_diet', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                client_id: selectedClientId,
                calories: calories,
                protein: protein || 0,
                carbs: carbs || 0,
                fat: fat || 0,
                hydration_target: 2500,
                consistency_target: 80
            })
        });
        if (res.ok) {
            showToast('Piano dieta assegnato!', 'success');
        } else {
            const err = await res.json().catch(() => ({}));
            showToast(err.detail || 'Impossibile assegnare la dieta', 'error');
        }
    } catch (e) { showToast('Errore nell\'assegnazione della dieta', 'error'); }
}

// ===================== CHARTS =====================
async function loadClientCharts() {
    if (!selectedClientId) return;
    const period = document.getElementById('chart-period').value;

    // Weight chart
    try {
        const res = await fetch(`/api/nutritionist/client/${selectedClientId}/weight-history?period=${period}`, { credentials: 'include' });
        const weightData = await res.json();

        const ctx = document.getElementById('nutri-weight-chart');
        if (weightChartInstance) weightChartInstance.destroy();

        const datasets = [{
            label: 'Peso (kg)',
            data: weightData.data.map(d => d.weight),
            borderColor: '#f97316',
            backgroundColor: 'rgba(249,115,22,0.1)',
            fill: true,
            tension: 0.4,
            pointRadius: 3
        }];

        // Add lean mass if available
        if (weightData.data.some(d => d.lean_mass)) {
            datasets.push({
                label: 'Massa Magra (kg)',
                data: weightData.data.map(d => d.lean_mass),
                borderColor: '#22c55e',
                backgroundColor: 'rgba(34,197,94,0.05)',
                fill: false,
                tension: 0.4,
                pointRadius: 2,
                borderDash: [5, 5]
            });
        }

        // Add fat mass if available
        if (weightData.data.some(d => d.fat_mass)) {
            datasets.push({
                label: 'Massa Grassa (kg)',
                data: weightData.data.map(d => d.fat_mass),
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239,68,68,0.05)',
                fill: false,
                tension: 0.4,
                pointRadius: 2,
                borderDash: [5, 5]
            });
        }

        weightChartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels: weightData.data.map(d => d.label), datasets },
            options: {
                responsive: true,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: { display: datasets.length > 1, labels: { color: '#9ca3af', boxWidth: 12, font: { size: 10 } } }
                },
                scales: {
                    x: { ticks: { color: '#6b7280', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.03)' } },
                    y: { ticks: { color: '#6b7280', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.05)' } }
                }
            }
        });
    } catch (e) { console.error('Weight chart error:', e); }

    // Diet consistency chart
    try {
        const res = await fetch(`/api/nutritionist/client/${selectedClientId}/diet-consistency?period=${period}`, { credentials: 'include' });
        const dietData = await res.json();

        const ctx2 = document.getElementById('nutri-diet-chart');
        if (dietChartInstance) dietChartInstance.destroy();

        dietChartInstance = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: (dietData.data || []).map(d => d.label || d.date),
                datasets: [{
                    label: 'Punteggio Salute',
                    data: (dietData.data || []).map(d => d.health_score || d.score || 0),
                    backgroundColor: (dietData.data || []).map(d => {
                        const s = d.health_score || d.score || 0;
                        return s >= 70 ? 'rgba(34,197,94,0.5)' : s >= 40 ? 'rgba(249,115,22,0.5)' : 'rgba(239,68,68,0.5)';
                    }),
                    borderRadius: 4,
                    maxBarThickness: 20
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { color: '#6b7280', font: { size: 10 } }, grid: { display: false } },
                    y: { min: 0, max: 100, ticks: { color: '#6b7280', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.05)' } }
                }
            }
        });
    } catch (e) { console.error('Diet chart error:', e); }
}

// ===================== AVAILABILITY & APPOINTMENTS =====================
const dayNamesIt = ['Luned\u00ec', 'Marted\u00ec', 'Mercoled\u00ec', 'Gioved\u00ec', 'Venerd\u00ec', 'Sabato', 'Domenica'];

function setupNutriDayToggles() {
    document.querySelectorAll('.nutri-day-toggle').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const day = this.dataset.nutriDay;
            const timesDiv = document.querySelector(`.nutri-day-times[data-nutri-day="${day}"]`);
            if (timesDiv) timesDiv.classList.toggle('hidden', !this.checked);
        });
    });
}

function openNutriAvailabilityModal() {
    document.getElementById('nutri-availability-modal').classList.remove('hidden');
    loadNutriAvailability();
}

function closeNutriAvailabilityModal() {
    document.getElementById('nutri-availability-modal').classList.add('hidden');
}

async function loadNutriAvailability() {
    try {
        const res = await fetch('/api/nutritionist/availability', { credentials: 'include' });
        const slots = await res.json();

        document.querySelectorAll('.nutri-day-toggle').forEach(cb => cb.checked = false);
        document.querySelectorAll('.nutri-day-times').forEach(div => div.classList.add('hidden'));

        slots.forEach(slot => {
            const checkbox = document.querySelector(`.nutri-day-toggle[data-nutri-day="${slot.day_of_week}"]`);
            const timesDiv = document.querySelector(`.nutri-day-times[data-nutri-day="${slot.day_of_week}"]`);
            if (checkbox && timesDiv) {
                checkbox.checked = true;
                timesDiv.classList.remove('hidden');
                timesDiv.querySelector('.nutri-start-time').value = slot.start_time;
                timesDiv.querySelector('.nutri-end-time').value = slot.end_time;
            }
        });
    } catch (e) { console.error('Error loading availability:', e); }

    // Load session rate
    try {
        const rateRes = await fetch('/api/nutritionist/session-rate', { credentials: 'include' });
        if (rateRes.ok) {
            const rateData = await rateRes.json();
            const rateInput = document.getElementById('nutri-session-rate');
            if (rateInput && rateData.session_rate != null) {
                rateInput.value = rateData.session_rate;
            }
        }
    } catch (e) { console.error('Error loading session rate:', e); }
}

async function saveNutriAvailability() {
    const availability = [];
    document.querySelectorAll('.nutri-day-toggle:checked').forEach(checkbox => {
        const day = parseInt(checkbox.dataset.nutriDay);
        const timesDiv = document.querySelector(`.nutri-day-times[data-nutri-day="${day}"]`);
        if (timesDiv) {
            availability.push({
                day_of_week: day,
                start_time: timesDiv.querySelector('.nutri-start-time').value,
                end_time: timesDiv.querySelector('.nutri-end-time').value
            });
        }
    });

    try {
        const res = await fetch('/api/nutritionist/availability', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ availability })
        });

        // Save session rate
        const rateInput = document.getElementById('nutri-session-rate');
        const rateValue = rateInput.value ? parseFloat(rateInput.value) : null;
        await fetch('/api/nutritionist/session-rate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ session_rate: rateValue })
        });

        if (res.ok) {
            closeNutriAvailabilityModal();
            showToast('Disponibilit\u00e0 e tariffa salvate!', 'success');
            loadNutriAvailabilitySummary();
        }
    } catch (e) { console.error('Error saving availability:', e); }
}

async function loadNutriAvailabilitySummary() {
    const summaryEl = document.getElementById('nutri-availability-summary');
    if (!summaryEl) return;

    try {
        const res = await fetch('/api/nutritionist/availability', { credentials: 'include' });
        const slots = await res.json();

        if (slots.length === 0) {
            summaryEl.innerHTML = '<p class="text-gray-500 text-sm">Nessuna disponibilit\u00e0 configurata</p>';
            return;
        }

        summaryEl.innerHTML = slots.map(s =>
            `<div class="flex items-center justify-between py-1 text-sm">
                <span class="font-medium text-white">${dayNamesIt[s.day_of_week]}</span>
                <span class="text-gray-400">${s.start_time} - ${s.end_time}</span>
            </div>`
        ).join('');
    } catch (e) {
        summaryEl.innerHTML = '<p class="text-red-400 text-sm">Errore caricamento</p>';
    }
}

async function loadNutriAppointments() {
    const listEl = document.getElementById('nutri-appointments-list');
    if (!listEl) return;

    try {
        const res = await fetch('/api/nutritionist/appointments', { credentials: 'include' });
        if (!res.ok) return;
        const appointments = await res.json();

        const upcoming = appointments.filter(a => a.status === 'scheduled');

        if (upcoming.length === 0) {
            listEl.innerHTML = '<p class="text-sm text-gray-500">Nessun appuntamento in programma</p>';
            return;
        }

        listEl.innerHTML = upcoming.slice(0, 5).map(appt => `
            <div class="flex items-center justify-between p-2 bg-white/5 rounded-lg">
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-white truncate">${appt.client_name || 'Cliente'}</p>
                    <p class="text-xs text-gray-400">${new Date(appt.date).toLocaleDateString('it-IT', { weekday: 'short', month: 'short', day: 'numeric' })} &middot; ${appt.start_time} &middot; ${appt.duration}min</p>
                </div>
                <button onclick="completeNutriAppointment('${appt.id}')" class="text-xs bg-green-500/20 text-green-400 px-3 py-1 rounded-lg hover:bg-green-500/30 transition" title="Completato">
                    <i data-lucide="check" class="w-3.5 h-3.5 inline"></i>
                </button>
            </div>
        `).join('');

        if (typeof lucide !== 'undefined') lucide.createIcons();
    } catch (e) { console.error('Error loading appointments:', e); }
}

async function completeNutriAppointment(appointmentId) {
    if (!confirm('Segna questo appuntamento come completato?')) return;
    try {
        const res = await fetch(`/api/nutritionist/appointments/${appointmentId}/complete`, {
            method: 'POST', credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });
        if (res.ok) {
            showToast('Appuntamento completato!', 'success');
            loadNutriAppointments();
        } else {
            const err = await res.json();
            showToast(err.detail || 'Errore', 'error');
        }
    } catch (e) { showToast('Errore di rete', 'error'); }
}

// ===================== WEEKLY MEAL PLAN EDITOR =====================
let currentMealPlanDay = 0;
let clientMealPlan = {}; // { day: [meals] }

const mealTypeOptions = [
    { value: 'colazione', label: 'Colazione' },
    { value: 'spuntino_mattina', label: 'Spuntino Mattina' },
    { value: 'pranzo', label: 'Pranzo' },
    { value: 'spuntino_pomeriggio', label: 'Merenda' },
    { value: 'cena', label: 'Cena' }
];

function selectMealPlanDay(day) {
    currentMealPlanDay = day;
    // Update tab styling
    document.querySelectorAll('#meal-plan-day-tabs button').forEach(btn => {
        if (parseInt(btn.dataset.mpDay) === day) {
            btn.className = 'text-xs px-3 py-1.5 rounded-lg bg-amber-500/20 text-amber-400 font-bold whitespace-nowrap transition';
        } else {
            btn.className = 'text-xs px-3 py-1.5 rounded-lg bg-white/5 text-gray-400 font-bold whitespace-nowrap transition hover:bg-white/10';
        }
    });
    renderMealPlanEntries();
}

function renderMealPlanEntries() {
    const container = document.getElementById('meal-plan-entries');
    const meals = clientMealPlan[currentMealPlanDay] || [];

    if (meals.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500 text-center py-3">Nessun pasto configurato per questo giorno</p>';
        return;
    }

    // Group by meal_type, preserving flat indices
    const grouped = {};
    meals.forEach((meal, idx) => {
        const key = meal.meal_type;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push({ ...meal, _flatIdx: idx });
    });

    const mealOrder = ['colazione', 'spuntino_mattina', 'pranzo', 'spuntino_pomeriggio', 'cena'];
    const sortedGroups = Object.entries(grouped).sort(([a], [b]) => {
        const ai = mealOrder.indexOf(a) === -1 ? 99 : mealOrder.indexOf(a);
        const bi = mealOrder.indexOf(b) === -1 ? 99 : mealOrder.indexOf(b);
        return ai - bi;
    });

    let html = '';
    sortedGroups.forEach(([mealType, entries]) => {
        entries.sort((a, b) => (a.alternative_index || 0) - (b.alternative_index || 0));

        entries.forEach(entry => {
            const idx = entry._flatIdx;
            const isAlt = (entry.alternative_index || 0) > 0;
            const altBadge = isAlt ? `<span class="text-[9px] bg-amber-500/20 text-amber-400 px-1.5 py-0.5 rounded-full font-bold">ALT ${entry.alternative_index}</span>` : '';
            const borderClass = isAlt ? 'ml-4 border-l-2 border-amber-500/30 pl-3' : '';

            html += `<div class="bg-white/5 rounded-xl p-3 border border-white/5 ${borderClass}">
                <div class="flex items-center justify-between mb-2">
                    ${isAlt
                        ? `<div class="flex items-center gap-2">
                            <span class="text-xs text-gray-500">${mealTypeOptions.find(o => o.value === mealType)?.label || mealType}</span>
                            ${altBadge}
                           </div>`
                        : `<select onchange="updateMealField(${idx}, 'meal_type', this.value)" class="bg-white/5 border border-white/10 rounded-lg px-2 py-1 text-xs text-white outline-none">
                            ${mealTypeOptions.map(opt => `<option value="${opt.value}" ${entry.meal_type === opt.value ? 'selected' : ''}>${opt.label}</option>`).join('')}
                           </select>`
                    }
                    <button onclick="removeMealEntry(${idx})" class="text-red-400 hover:text-red-300 transition p-1">
                        <i data-lucide="trash-2" class="w-3.5 h-3.5 inline"></i>
                    </button>
                </div>
                <input type="text" value="${entry.meal_name || ''}" placeholder="Nome pasto (es. Yogurt greco con frutta)"
                    onchange="updateMealField(${idx}, 'meal_name', this.value)"
                    class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-1.5 text-sm text-white outline-none focus:border-amber-500/50 mb-2">
                <input type="text" value="${entry.description || ''}" placeholder="Dettagli (es. 200g yogurt, 100g fragole, 30g muesli)"
                    onchange="updateMealField(${idx}, 'description', this.value)"
                    class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-1.5 text-xs text-gray-300 outline-none focus:border-amber-500/50 mb-2">
                <div class="grid grid-cols-4 gap-2">
                    <div>
                        <label class="text-[9px] text-gray-500 uppercase">Kcal</label>
                        <input type="number" value="${entry.calories || 0}" onchange="updateMealField(${idx}, 'calories', parseInt(this.value)||0)"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-2 py-1 text-xs text-white outline-none">
                    </div>
                    <div>
                        <label class="text-[9px] text-gray-500 uppercase">Prot</label>
                        <input type="number" value="${entry.protein || 0}" onchange="updateMealField(${idx}, 'protein', parseInt(this.value)||0)"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-2 py-1 text-xs text-white outline-none">
                    </div>
                    <div>
                        <label class="text-[9px] text-gray-500 uppercase">Carb</label>
                        <input type="number" value="${entry.carbs || 0}" onchange="updateMealField(${idx}, 'carbs', parseInt(this.value)||0)"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-2 py-1 text-xs text-white outline-none">
                    </div>
                    <div>
                        <label class="text-[9px] text-gray-500 uppercase">Grassi</label>
                        <input type="number" value="${entry.fat || 0}" onchange="updateMealField(${idx}, 'fat', parseInt(this.value)||0)"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-2 py-1 text-xs text-white outline-none">
                    </div>
                </div>
            </div>`;
        });

        // "+ Alternativa" button for this meal_type group
        html += `<button onclick="addAlternativeEntry('${mealType}')" class="ml-4 mb-1 text-[10px] text-amber-400/50 hover:text-amber-400 transition flex items-center gap-1 py-0.5">
            <i data-lucide="plus-circle" class="w-3 h-3 inline"></i> Alternativa
        </button>`;
    });

    container.innerHTML = html;
    if (typeof lucide !== 'undefined') lucide.createIcons();
}

function addMealPlanEntry() {
    if (!clientMealPlan[currentMealPlanDay]) clientMealPlan[currentMealPlanDay] = [];
    // Auto-select next primary meal type (only count primary meals, not alternatives)
    const usedPrimary = clientMealPlan[currentMealPlanDay].filter(m => (m.alternative_index || 0) === 0).map(m => m.meal_type);
    const next = mealTypeOptions.find(opt => !usedPrimary.includes(opt.value));
    clientMealPlan[currentMealPlanDay].push({
        meal_type: next ? next.value : 'colazione',
        meal_name: '',
        description: '',
        calories: 0, protein: 0, carbs: 0, fat: 0,
        alternative_index: 0
    });
    renderMealPlanEntries();
}

function addAlternativeEntry(mealType) {
    if (!clientMealPlan[currentMealPlanDay]) clientMealPlan[currentMealPlanDay] = [];
    const existing = clientMealPlan[currentMealPlanDay].filter(m => m.meal_type === mealType);
    const maxIdx = existing.reduce((max, m) => Math.max(max, m.alternative_index || 0), 0);
    clientMealPlan[currentMealPlanDay].push({
        meal_type: mealType,
        meal_name: '',
        description: '',
        calories: 0, protein: 0, carbs: 0, fat: 0,
        alternative_index: maxIdx + 1
    });
    renderMealPlanEntries();
}

function removeMealEntry(idx) {
    if (!clientMealPlan[currentMealPlanDay]) return;
    clientMealPlan[currentMealPlanDay].splice(idx, 1);
    renderMealPlanEntries();
}

function updateMealField(idx, field, value) {
    if (!clientMealPlan[currentMealPlanDay] || !clientMealPlan[currentMealPlanDay][idx]) return;
    clientMealPlan[currentMealPlanDay][idx][field] = value;
}

async function saveMealPlan() {
    if (!selectedClientId) { showToast('Seleziona un cliente', 'error'); return; }
    const meals = clientMealPlan[currentMealPlanDay] || [];

    try {
        const res = await fetch(`/api/nutritionist/client/${selectedClientId}/weekly-meal-plan`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                client_id: selectedClientId,
                day_of_week: currentMealPlanDay,
                meals: meals.map(m => ({
                    meal_type: m.meal_type,
                    meal_name: m.meal_name,
                    description: m.description,
                    calories: m.calories,
                    protein: m.protein,
                    carbs: m.carbs,
                    fat: m.fat,
                    alternative_index: m.alternative_index || 0
                }))
            })
        });
        if (res.ok) {
            showToast('Piano alimentare salvato!', 'success');
        } else {
            const err = await res.json().catch(() => ({}));
            showToast(err.detail || 'Errore nel salvataggio', 'error');
        }
    } catch (e) { showToast('Errore di rete', 'error'); }
}

async function loadClientMealPlan(clientId) {
    clientMealPlan = {};
    try {
        const res = await fetch(`/api/nutritionist/client/${clientId}/weekly-meal-plan`, { credentials: 'include' });
        if (res.ok) {
            const data = await res.json();
            // Convert string keys to integers
            const plan = data.plan || {};
            for (const key in plan) {
                clientMealPlan[parseInt(key)] = plan[key];
            }
        }
    } catch (e) { console.error('Error loading meal plan:', e); }
    renderMealPlanEntries();
}

// ===================== SETTINGS =====================
async function saveSettings() {
    try {
        const res = await fetch('/api/profile/update', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                bio: document.getElementById('settings-bio').value,
                specialties: document.getElementById('settings-specialties').value
            })
        });
        if (res.ok) showToast('Impostazioni salvate!', 'success');
        else showToast('Salvataggio fallito', 'error');
    } catch (e) { showToast('Errore nel salvataggio delle impostazioni', 'error'); }
}

// ===================== NOTIFICATIONS =====================
function nutriOpenNotifications() {
    const modal = document.getElementById('notification-modal');
    if (modal) {
        modal.classList.remove('hidden');
    }
}

// Override closeNotificationsModal so it doesn't depend on app.js hideModal
window.closeNotificationsModal = function() {
    const modal = document.getElementById('notification-modal');
    if (modal) modal.classList.add('hidden');
};

// Override markAllNotificationsRead with self-contained version
window.markAllNotificationsRead = async function() {
    try {
        await fetch('/api/notifications/read-all', { method: 'POST', credentials: 'include' });
        // Reload the notification list
        const list = document.getElementById('notifications-list');
        if (list) {
            const res = await fetch('/api/notifications?limit=20', { credentials: 'include' });
            const notifications = await res.json();
            if (notifications.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-400 py-8"><p class="text-sm">Nessuna notifica</p></div>';
                return;
            }
            list.innerHTML = notifications.map(n => {
                const timeAgo = n.created_at ? new Date(n.created_at).toLocaleDateString() : '';
                return `<div class="flex items-start space-x-3 p-3 bg-white/5 rounded-xl opacity-60">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-bold text-white">${n.title || ''}</p>
                        <p class="text-xs text-gray-400 truncate">${n.message || ''}</p>
                        <p class="text-[10px] text-gray-500 mt-1">${timeAgo}</p>
                    </div>
                </div>`;
            }).join('');
        }
    } catch (e) {
        console.error('Error marking notifications read:', e);
    }
};

// ===================== CHAT =====================
// Local fallback: if app.js openConversationsModal isn't available, provide our own
function nutriOpenConversations() {
    if (typeof window.openConversationsModal === 'function') {
        window.openConversationsModal();
        return;
    }
    // Fallback: open conversations modal directly
    const modal = document.getElementById('conversations-modal');
    if (!modal) { console.error('conversations-modal not found'); return; }
    modal.classList.remove('hidden', 'slide-out-right');
    modal.classList.add('slide-in-right');
    // Load conversations
    fetch('/api/messages/conversations', { credentials: 'include' })
        .then(r => r.json())
        .then(conversations => {
            const list = document.getElementById('conversations-list');
            if (!list) return;
            if (!conversations.length) {
                list.innerHTML = '<div class="text-center text-gray-500 py-8"><p>Nessuna conversazione</p></div>';
                return;
            }
            list.innerHTML = conversations.map(conv => `
                <div class="bg-white/5 hover:bg-white/10 p-4 rounded-xl cursor-pointer transition"
                     onclick="nutriOpenChat('${conv.other_user_id}', '${(conv.other_user_name||'').replace(/'/g,"\\'")}', '${conv.other_user_profile_picture||''}')">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-red-500 to-orange-500 flex items-center justify-center overflow-hidden flex-shrink-0">
                            ${conv.other_user_profile_picture ? '<img src="'+conv.other_user_profile_picture+'" class="w-full h-full object-cover">' : '<i data-lucide="user" class="w-5 h-5"></i>'}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-center">
                                <p class="font-semibold text-white text-sm truncate">${conv.other_user_name}</p>
                                ${conv.unread_count > 0 ? '<span class="w-5 h-5 bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center">'+conv.unread_count+'</span>' : ''}
                            </div>
                            <p class="text-xs text-gray-500 truncate">${conv.last_message_preview || 'Nessun messaggio'}</p>
                        </div>
                    </div>
                </div>
            `).join('');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        })
        .catch(e => console.error('Failed to load conversations:', e));
}

function nutriNewChat() {
    const modal = document.getElementById('conversations-modal');
    if (!modal) return;
    modal.classList.remove('hidden', 'slide-out-right');
    modal.classList.add('slide-in-right');
    const list = document.getElementById('conversations-list');
    if (!list) return;
    list.innerHTML = '<div class="text-center text-gray-500 py-8">Caricamento membri palestra...</div>';

    const members = [];
    if (nutriData && nutriData.clients) {
        nutriData.clients.forEach(c => members.push({ id: c.id, name: c.name, role: 'Cliente', pic: c.profile_picture }));
    }
    if (!members.length) {
        list.innerHTML = '<div class="text-center text-gray-500 py-8">Nessun membro della palestra trovato</div>';
        return;
    }
    list.innerHTML = '<p class="text-xs text-gray-500 uppercase font-bold mb-3">Inizia una nuova conversazione</p>' +
        members.map(m => `
            <div class="bg-white/5 hover:bg-white/10 p-3 rounded-xl cursor-pointer transition flex items-center gap-3"
                 onclick="nutriOpenChat('${m.id}', '${(m.name||'').replace(/'/g,"\\'")}', '${m.pic||''}')">
                <div class="w-9 h-9 rounded-full bg-gradient-to-tr from-green-500 to-emerald-600 flex items-center justify-center overflow-hidden flex-shrink-0">
                    ${m.pic ? '<img src="'+m.pic+'" class="w-full h-full object-cover">' : '<i data-lucide="user" class="w-4 h-4"></i>'}
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-white text-sm font-medium truncate">${m.name}</p>
                    <p class="text-[10px] text-gray-500">${m.role}</p>
                </div>
            </div>
        `).join('');
    if (typeof lucide !== 'undefined') lucide.createIcons();
}

function nutriCloseConversations() {
    const modal = document.getElementById('conversations-modal');
    if (modal) { modal.classList.add('hidden'); modal.classList.remove('slide-in-right'); }
}

function nutriOpenChat(userId, userName, profilePic) {
    if (typeof window.openChatModal === 'function') {
        nutriCloseConversations();
        window.openChatModal(userId, userName, profilePic);
        return;
    }
    // Fallback: open chat modal directly
    nutriCloseConversations();
    const modal = document.getElementById('chat-modal');
    if (!modal) return;
    const nameEl = document.getElementById('chat-user-name');
    if (nameEl) nameEl.textContent = userName;
    const avatarEl = document.getElementById('chat-user-avatar');
    if (avatarEl) {
        avatarEl.innerHTML = profilePic
            ? `<img src="${profilePic}" class="w-full h-full object-cover">`
            : '<i data-lucide="user" class="w-5 h-5"></i>';
    }
    modal.classList.remove('hidden', 'slide-out-right');
    modal.classList.add('slide-in-right');

    // Store state for sending
    window._nutriChatUserId = userId;

    // Load messages
    fetch('/api/messages/conversations', { credentials: 'include' })
        .then(r => r.json())
        .then(convs => {
            const conv = convs.find(c => c.other_user_id === userId);
            if (!conv) { document.getElementById('chat-messages').innerHTML = '<div class="text-center text-gray-500 py-8">Inizia la conversazione!</div>'; return; }
            window._nutriConvId = conv.id;
            return fetch(`/api/messages/conversation/${conv.id}`, { credentials: 'include' });
        })
        .then(r => r ? r.json() : null)
        .then(data => {
            if (!data) return;
            const container = document.getElementById('chat-messages');
            if (!container) return;
            const messages = data.messages || data;
            container.innerHTML = messages.map(m => `
                <div class="flex ${m.is_mine ? 'justify-end' : 'justify-start'}">
                    <div class="${m.is_mine ? 'bg-orange-500/20 text-orange-100' : 'bg-white/10 text-white'} max-w-[75%] rounded-2xl px-4 py-2">
                        <p class="text-sm">${m.content}</p>
                        <p class="text-[10px] text-gray-500 mt-1">${new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</p>
                    </div>
                </div>
            `).join('');
            container.scrollTop = container.scrollHeight;
            // Mark as read
            if (window._nutriConvId) fetch(`/api/messages/conversation/${window._nutriConvId}/read`, { method: 'POST', credentials: 'include' });
        })
        .catch(e => console.error('Failed to load messages:', e));
}

function chatWithSelectedClient() {
    if (!selectedClientId || !nutriData) return;
    const client = nutriData.clients.find(c => c.id === selectedClientId);
    if (!client) { if (typeof showToast === 'function') showToast('Seleziona prima un cliente', 'error'); return; }
    nutriOpenChat(client.id, client.name, client.profile_picture || '');
}

// ===================== SEND MESSAGE (fallback) =====================
// Override sendChatMessage if app.js didn't define it
if (typeof window.sendChatMessage !== 'function') {
    window.sendChatMessage = async function() {
        const input = document.getElementById('chat-input');
        if (!input || !input.value.trim()) return;
        const content = input.value.trim();
        const userId = window._nutriChatUserId;
        if (!userId) return;

        input.value = '';
        // Optimistic: show message immediately
        const container = document.getElementById('chat-messages');
        if (container) {
            const div = document.createElement('div');
            div.className = 'flex justify-end';
            div.innerHTML = `<div class="bg-orange-500/20 text-orange-100 max-w-[75%] rounded-2xl px-4 py-2"><p class="text-sm">${content}</p><p class="text-[10px] text-gray-500 mt-1">now</p></div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        try {
            await fetch('/api/messages/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ receiver_id: userId, content: content })
            });
        } catch (e) { console.error('Failed to send message:', e); }
    };
}

// ===================== NAVIGATION =====================
function switchNutriSection(section) {
    document.querySelectorAll('.nutritionist-section').forEach(s => s.style.display = 'none');
    document.getElementById(`section-${section}`).style.display = 'block';
    document.querySelectorAll('.sidebar-nav-item').forEach(l => l.classList.remove('active'));
    document.querySelector(`[data-section="${section}"]`).classList.add('active');
}
</script>

{% endblock %}
