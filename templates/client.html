{% extends "base.html" %}
{% from 'macros.html' import card %}

{% block content %}
{% if mode == "leaderboard" %}
<div class="p-6 pt-10 flex justify-between items-center bg-gradient-to-b from-black/80 to-transparent z-10">
    <div class="flex items-center space-x-3">
        <a href="{{ 'client.html' if static_build else '/?gym_id=' + gym_id + '&role=client' }}"
            class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center tap-effect">‚Üê</a>
        <h2 class="font-bold text-xl">Weekly Leaderboard</h2>
    </div>
    <div class="flex space-x-2">
        <div onclick="openClientChatModal()" class="relative w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center tap-effect cursor-pointer">
            üí¨
        </div>
        <div data-action="showModal" data-target="notification-modal"
            class="w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center tap-effect">
            üîî
        </div>
    </div>
</div>
<div class="flex-1 p-4 space-y-4">

    <!-- Weekly Challenge -->
    {% call card(classes="p-6 relative overflow-hidden") %}
    <div class="absolute top-0 right-0 w-40 h-40 bg-purple-500/10 blur-3xl rounded-full -mr-10 -mt-10"></div>
    <div class="relative z-10">
        <div class="flex justify-between items-start mb-3">
            <div>
                <p class="text-xs text-gray-400 uppercase tracking-wider mb-1">Current Challenge</p>
                <h3 class="text-lg font-black text-white" id="challenge-title">...</h3>
                <p class="text-xs text-gray-400 mt-1" id="challenge-desc">...</p>
            </div>
            <span class="text-2xl">üèÜ</span>
        </div>
        <div class="mt-4">
            <div class="flex justify-between text-xs mb-2">
                <span class="text-gray-400">Progress</span>
                <span class="text-white font-bold"><span id="challenge-progress">0</span>/<span
                        id="challenge-target">0</span></span>
            </div>
            <div class="w-full h-3 bg-white/10 rounded-full overflow-hidden">
                <div id="challenge-bar"
                    class="h-full bg-gradient-to-r from-red-500 to-orange-500 transition-all duration-500"
                    style="width: 0%"></div>
            </div>
            <p class="text-xs text-yellow-400 font-bold mt-2">Reward: <span id="challenge-reward">0</span> üî∂</p>
        </div>
    </div>
    {% endcall %}

    <!-- Rankings -->
    <div>
        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3 ml-1">Rankings</h3>
        <div id="leaderboard-list" class="space-y-2"></div>
    </div>
</div>

<!-- Member Profile Modal (for leaderboard) -->
<div id="member-profile-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeMemberProfileModal()">
    <div class="glass-card p-5 rounded-2xl max-w-sm w-full">
        <div class="flex justify-between items-start mb-4">
            <div class="flex items-center gap-3">
                <div id="member-profile-avatar" class="w-14 h-14 rounded-full bg-orange-500/20 flex items-center justify-center overflow-hidden border-2 border-orange-500/30">
                    <span class="text-2xl">üë§</span>
                </div>
                <div>
                    <h3 id="member-profile-name" class="text-lg font-bold text-white">Username</h3>
                    <p id="member-profile-bio" class="text-gray-400 text-xs max-w-[180px] truncate"></p>
                </div>
            </div>
            <button onclick="closeMemberProfileModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>
        <div class="grid grid-cols-3 gap-2 mb-4">
            <div class="bg-white/5 rounded-xl p-3 text-center border border-white/5">
                <div class="flex items-center justify-center gap-1">
                    <span class="text-sm">üî•</span>
                    <p id="member-profile-streak" class="text-xl font-bold text-orange-400">0</p>
                </div>
                <p class="text-[10px] text-gray-500 uppercase font-medium mt-1">Streak</p>
            </div>
            <div class="bg-white/5 rounded-xl p-3 text-center border border-white/5">
                <div class="flex items-center justify-center gap-1">
                    <span class="text-sm">üî∂</span>
                    <p id="member-profile-gems" class="text-xl font-bold text-orange-400">0</p>
                </div>
                <p class="text-[10px] text-gray-500 uppercase font-medium mt-1">Gems</p>
            </div>
            <div class="bg-white/5 rounded-xl p-3 text-center border border-white/5">
                <div class="flex items-center justify-center gap-0.5">
                    <p id="member-profile-health" class="text-xl font-bold text-green-400">0</p>
                    <span class="text-xs text-green-400 font-bold">%</span>
                </div>
                <p class="text-[10px] text-gray-500 uppercase font-medium mt-1">Diet</p>
            </div>
        </div>

        <!-- Weekly Activity -->
        <div class="bg-white/5 rounded-xl p-4 mb-4 border border-white/5">
            <div class="flex justify-between items-center mb-3">
                <span class="text-xs text-gray-400 uppercase tracking-wider font-medium">Weekly Activity</span>
                <span class="text-[10px] text-orange-400">Last 7 days</span>
            </div>
            <!-- Activity Dots -->
            <div id="member-progress-chart" class="flex items-center justify-between">
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">M</span>
                    </div>
                </div>
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">T</span>
                    </div>
                </div>
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">W</span>
                    </div>
                </div>
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">T</span>
                    </div>
                </div>
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">F</span>
                    </div>
                </div>
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">S</span>
                    </div>
                </div>
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">S</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Friend-only Progress Section (hidden by default) -->
        <div id="friend-progress-section" class="hidden mb-4">
            <div class="bg-gradient-to-br from-purple-500/10 to-pink-500/10 rounded-xl p-4 border border-purple-500/20">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-purple-400">üë•</span>
                    <span class="text-xs text-purple-300 uppercase tracking-wider font-medium">Friend Progress</span>
                </div>
                <!-- Weight Trend -->
                <div class="mb-3">
                    <p class="text-[10px] text-gray-400 mb-1">Weight Trend (30 days)</p>
                    <div id="friend-weight-chart" class="h-16 flex items-end gap-1">
                        <!-- Bars will be rendered here -->
                    </div>
                </div>
                <!-- Health Score History -->
                <div>
                    <p class="text-[10px] text-gray-400 mb-1">Health Score (7 days)</p>
                    <div id="friend-health-bars" class="flex items-end justify-between h-12 gap-1">
                        <!-- Bars will be rendered here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Friend Action Button -->
        <div id="friend-action-container" class="mb-3">
            <button id="friend-action-btn" onclick="handleFriendAction()"
                class="w-full py-2.5 bg-purple-500/20 text-purple-300 font-bold rounded-xl border border-purple-500/30 hover:bg-purple-500/30 transition tap-effect">
                <span id="friend-action-text">Add Friend</span>
            </button>
        </div>

        <button id="member-profile-message-btn" onclick="messageFromLeaderboard()"
            class="w-full py-3 bg-orange-500 text-white font-bold rounded-xl hover:bg-orange-400 transition tap-effect">
            Message
        </button>
    </div>
</div>

<!-- Friend Request Modal (for leaderboard) -->
<div id="friend-request-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeFriendRequestModal()">
    <div class="glass-card p-6 rounded-2xl max-w-sm w-full">
        <div class="text-center mb-4">
            <div id="friend-request-avatar" class="w-20 h-20 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center mx-auto mb-3 overflow-hidden">
                <span class="text-3xl">üë§</span>
            </div>
            <h3 id="friend-request-name" class="text-xl font-bold">Username</h3>
            <p class="text-gray-400 text-sm mt-1">Send a friend request</p>
        </div>
        <div class="space-y-3">
            <textarea id="friend-request-message" rows="2"
                class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white placeholder-gray-500 resize-none outline-none focus:border-purple-500"
                placeholder="Add a message (optional)..."></textarea>
            <button onclick="submitFriendRequest()" class="w-full py-3 bg-purple-500 text-white font-bold rounded-xl hover:bg-purple-400 transition tap-effect">
                Send Friend Request
            </button>
            <button onclick="closeFriendRequestModal()" class="w-full py-2 bg-white/10 text-gray-300 font-medium rounded-xl hover:bg-white/20 transition tap-effect">
                Cancel
            </button>
        </div>
    </div>
</div>

<script>
let currentProfileMember = null;
let friendRequestTarget = null;

async function openMemberProfile(memberId) {
    try {
        const response = await fetch(`/api/client/member/${memberId}`, { credentials: 'include' });
        if (!response.ok) throw new Error('Failed to load profile');

        const member = await response.json();
        currentProfileMember = member;

        document.getElementById('member-profile-name').textContent = member.username;
        document.getElementById('member-profile-bio').textContent = member.bio || '';
        document.getElementById('member-profile-streak').textContent = member.streak || 0;
        document.getElementById('member-profile-gems').textContent = member.gems || 0;
        document.getElementById('member-profile-health').textContent = member.health_score || 0;

        const avatarEl = document.getElementById('member-profile-avatar');
        if (member.profile_picture) {
            avatarEl.innerHTML = `<img src="${member.profile_picture}" class="w-full h-full object-cover">`;
        } else {
            avatarEl.innerHTML = '<span class="text-2xl">üë§</span>';
        }

        // Update weekly activity chart
        updateMemberProgressChart(member.health_score || 0, member.streak || 0);

        // Update friend action button
        const friendshipStatus = member.friendship_status || 'none';
        updateFriendActionButton(friendshipStatus);

        // Show/hide friend progress section
        const progressSection = document.getElementById('friend-progress-section');
        if (member.is_friend) {
            loadFriendProgress(memberId);
        } else {
            progressSection?.classList.add('hidden');
        }

        document.getElementById('member-profile-modal').classList.remove('hidden');
    } catch (error) {
        console.error('Error loading member profile:', error);
        if (typeof showToast === 'function') showToast('Failed to load profile', 'error');
    }
}

function closeMemberProfileModal() {
    document.getElementById('member-profile-modal').classList.add('hidden');
    document.getElementById('friend-progress-section')?.classList.add('hidden');
    currentProfileMember = null;
}

function messageFromLeaderboard() {
    if (!currentProfileMember) return;
    closeMemberProfileModal();
    if (typeof window.openChatWithUser === 'function') {
        window.openChatWithUser(currentProfileMember.id, currentProfileMember.username, currentProfileMember.profile_picture);
    }
}

function updateFriendActionButton(status) {
    const btn = document.getElementById('friend-action-btn');
    const text = document.getElementById('friend-action-text');
    if (!btn || !text) return;

    switch (status) {
        case 'none':
            text.textContent = 'Add Friend';
            btn.className = 'w-full py-2.5 bg-purple-500/20 text-purple-300 font-bold rounded-xl border border-purple-500/30 hover:bg-purple-500/30 transition tap-effect';
            break;
        case 'pending_outgoing':
            text.textContent = 'Request Sent';
            btn.className = 'w-full py-2.5 bg-gray-500/20 text-gray-400 font-bold rounded-xl border border-gray-500/30 transition tap-effect';
            break;
        case 'pending_incoming':
            text.textContent = 'Accept Friend Request';
            btn.className = 'w-full py-2.5 bg-green-500/20 text-green-300 font-bold rounded-xl border border-green-500/30 hover:bg-green-500/30 transition tap-effect';
            break;
        case 'friends':
            text.textContent = 'Friends ‚úì';
            btn.className = 'w-full py-2.5 bg-purple-500 text-white font-bold rounded-xl hover:bg-purple-400 transition tap-effect';
            break;
    }
}

function handleFriendAction() {
    console.log('handleFriendAction called, currentProfileMember:', currentProfileMember);
    if (!currentProfileMember) {
        console.error('No currentProfileMember set');
        alert('Error: No profile loaded');
        return;
    }
    const status = currentProfileMember.friendship_status || 'none';
    console.log('Friendship status:', status);

    switch (status) {
        case 'none':
            console.log('Opening friend request modal for:', currentProfileMember.id);
            openFriendRequestModal(currentProfileMember.id, currentProfileMember.username, currentProfileMember.profile_picture);
            break;
        case 'pending_outgoing':
            if (typeof showToast === 'function') showToast('Friend request already sent', 'info');
            break;
        case 'pending_incoming':
            if (currentProfileMember.friendship_request_id) {
                respondToFriendRequest(currentProfileMember.friendship_request_id, true);
            }
            break;
        case 'friends':
            if (typeof showToast === 'function') showToast('You are already friends!', 'info');
            break;
        default:
            console.log('Unknown status:', status);
    }
}

function openFriendRequestModal(userId, username, profilePicture) {
    console.log('openFriendRequestModal called:', userId, username);
    friendRequestTarget = { userId, username, profilePicture };

    const nameEl = document.getElementById('friend-request-name');
    const avatarEl = document.getElementById('friend-request-avatar');
    const messageEl = document.getElementById('friend-request-message');
    const modal = document.getElementById('friend-request-modal');

    console.log('Modal elements found:', { nameEl: !!nameEl, avatarEl: !!avatarEl, messageEl: !!messageEl, modal: !!modal });

    if (!modal) {
        console.error('Friend request modal not found!');
        alert('Error: Modal not found');
        return;
    }

    if (nameEl) nameEl.textContent = username;
    if (avatarEl) {
        if (profilePicture) {
            avatarEl.innerHTML = `<img src="${profilePicture}" class="w-full h-full object-cover">`;
        } else {
            avatarEl.innerHTML = '<span class="text-3xl">üë§</span>';
        }
    }
    if (messageEl) messageEl.value = '';

    modal.classList.remove('hidden');
    console.log('Modal should now be visible');
}

function closeFriendRequestModal() {
    document.getElementById('friend-request-modal').classList.add('hidden');
    friendRequestTarget = null;
}

async function submitFriendRequest() {
    if (!friendRequestTarget) return;

    const message = document.getElementById('friend-request-message').value.trim();

    try {
        const response = await fetch('/api/friends/request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                to_user_id: friendRequestTarget.userId,
                message: message || null
            })
        });

        if (response.ok) {
            const result = await response.json();
            if (result.status === 'accepted') {
                if (typeof showToast === 'function') showToast('You are now friends!', 'success');
                updateFriendActionButton('friends');
                if (currentProfileMember) currentProfileMember.friendship_status = 'friends';
            } else {
                if (typeof showToast === 'function') showToast('Friend request sent!', 'success');
                updateFriendActionButton('pending_outgoing');
                if (currentProfileMember) currentProfileMember.friendship_status = 'pending_outgoing';
            }
            closeFriendRequestModal();
        } else {
            const error = await response.json();
            if (typeof showToast === 'function') showToast(error.detail || 'Failed to send request', 'error');
        }
    } catch (error) {
        console.error('Error sending friend request:', error);
        if (typeof showToast === 'function') showToast('Failed to send request', 'error');
    }
}

async function respondToFriendRequest(requestId, accept) {
    try {
        const response = await fetch('/api/friends/request/respond', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ request_id: requestId, accept })
        });

        if (response.ok) {
            if (accept) {
                if (typeof showToast === 'function') showToast('Friend added!', 'success');
                updateFriendActionButton('friends');
                if (currentProfileMember) {
                    currentProfileMember.friendship_status = 'friends';
                    currentProfileMember.is_friend = true;
                    // Load friend progress now that they're friends
                    loadFriendProgress(currentProfileMember.id);
                }
            }
        } else {
            const error = await response.json();
            if (typeof showToast === 'function') showToast(error.detail || 'Failed to respond', 'error');
        }
    } catch (error) {
        console.error('Error responding to friend request:', error);
        if (typeof showToast === 'function') showToast('Failed to respond', 'error');
    }
}

function updateMemberProgressChart(healthScore, streak) {
    const chartEl = document.getElementById('member-progress-chart');
    if (!chartEl) return;

    const days = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
    const today = new Date().getDay(); // 0=Sunday, 1=Monday, etc
    const todayIndex = today === 0 ? 6 : today - 1; // Convert to 0=Monday

    // Determine active days based on streak
    const activeDays = Math.min(streak, 7);

    let html = '';
    days.forEach((day, index) => {
        const isPast = index <= todayIndex;
        const isToday = index === todayIndex;

        // Active if within streak and not future
        const isActive = isPast && (todayIndex - index) < activeDays;

        const bgClass = isActive ? 'bg-orange-500' : 'bg-orange-500/20';
        const borderClass = isActive ? 'border-orange-400' : 'border-orange-500/30';
        const textClass = isActive ? 'text-white font-bold' : (isToday ? 'text-orange-400' : 'text-gray-500');

        html += `
            <div class="flex-1 flex flex-col items-center gap-1">
                <div class="w-8 h-8 rounded-full ${bgClass} border ${borderClass} flex items-center justify-center transition-all">
                    <span class="text-xs ${textClass}">${day}</span>
                </div>
            </div>
        `;
    });

    chartEl.innerHTML = html;
}

async function loadFriendProgress(friendId) {
    try {
        const response = await fetch(`/api/friends/${friendId}/progress`, { credentials: 'include' });
        if (!response.ok) return;

        const data = await response.json();
        renderFriendProgress(data);
        document.getElementById('friend-progress-section')?.classList.remove('hidden');
    } catch (error) {
        console.error('Error loading friend progress:', error);
    }
}

function renderFriendProgress(data) {
    // Render weight chart
    const weightChart = document.getElementById('friend-weight-chart');
    if (weightChart && data.weight_history && data.weight_history.length > 0) {
        const weights = data.weight_history.map(w => w.weight);
        const maxW = Math.max(...weights);
        const minW = Math.min(...weights);
        const range = maxW - minW || 1;

        // Show last 10 entries
        const recent = data.weight_history.slice(-10);
        weightChart.innerHTML = recent.map(entry => {
            const height = ((entry.weight - minW) / range) * 100;
            return `<div class="flex-1 bg-purple-500/50 rounded-t" style="height: ${Math.max(20, height)}%" title="${entry.weight}kg"></div>`;
        }).join('');
    } else if (weightChart) {
        weightChart.innerHTML = '<p class="text-xs text-gray-500 w-full text-center">No weight data</p>';
    }

    // Render health score bars
    const healthBars = document.getElementById('friend-health-bars');
    if (healthBars && data.weekly_health_scores && data.weekly_health_scores.length > 0) {
        healthBars.innerHTML = data.weekly_health_scores.map(entry => {
            const score = entry.score || 0;
            const color = score >= 80 ? 'bg-green-500' : score >= 60 ? 'bg-yellow-500' : 'bg-red-500';
            return `<div class="flex-1 ${color}/70 rounded-t" style="height: ${score}%" title="${score}%"></div>`;
        }).join('');
    } else if (healthBars) {
        healthBars.innerHTML = '<p class="text-xs text-gray-500 w-full text-center">No health data</p>';
    }
}
</script>

{% elif mode == "progress" %}
<div class="p-6 pt-10 flex justify-between items-center bg-gradient-to-b from-black/80 to-transparent z-10">
    <div class="flex items-center space-x-3">
        <a href="{{ 'client.html' if static_build else '/?gym_id=' + gym_id + '&role=client' }}"
            class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center tap-effect">‚Üê</a>
        <h2 class="font-bold text-xl">My Nutrition</h2>
    </div>
    <div class="flex space-x-2">
        <div onclick="openBookingChoiceForMyTrainer()" class="relative w-10 h-10 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center tap-effect cursor-pointer" title="Book Session">
            üìÖ
        </div>
        <div onclick="openClientChatModal()" class="relative w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center tap-effect cursor-pointer">
            üí¨
        </div>
        <div data-action="showModal" data-target="notification-modal"
            class="w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center tap-effect">
            üîî
        </div>
    </div>
</div>
<div class="flex-1 p-4 space-y-4">

    <!-- Stats Carousel -->
    <div class="relative">
        <div id="stats-carousel" class="flex overflow-x-auto snap-x snap-mandatory scrollbar-hide -mx-4 px-4 gap-3" style="scroll-behavior: smooth;">
            <!-- Slide 1: Diet + Macros Combined -->
            <div class="snap-center flex-shrink-0 w-full">
                {% call card(classes="p-4 relative overflow-hidden h-[137px]") %}
                <div class="absolute top-0 right-0 w-32 h-32 bg-green-500/10 blur-3xl rounded-full -mr-8 -mt-8"></div>
                <div class="flex items-center gap-4 relative z-10 h-full">
                    <!-- Diet Score - Large Circle -->
                    <div class="flex items-center gap-3 flex-shrink-0">
                        <div class="w-20 h-20 relative flex items-center justify-center">
                            <svg class="w-full h-full transform -rotate-90" viewBox="0 0 80 80">
                                <circle cx="40" cy="40" r="34" stroke="rgba(255,255,255,0.1)" stroke-width="6" fill="none" />
                                <circle cx="40" cy="40" r="34" stroke="#4ADE80" stroke-width="6" fill="none" stroke-dasharray="213.6"
                                    stroke-dashoffset="42" stroke-linecap="round" id="diet-progress-ring" />
                            </svg>
                            <span class="absolute text-xl">ü•ó</span>
                        </div>
                        <div>
                            <p class="text-[10px] text-gray-400 uppercase tracking-wider">Diet</p>
                            <p class="text-3xl font-black text-white leading-none"><span id="health-score">...</span><span class="text-xl text-green-400">%</span></p>
                            <p class="text-[10px] text-green-400 font-bold" id="diet-status">Keep going!</p>
                            <div class="mt-1 inline-flex items-center bg-white/10 rounded-full px-2 py-0.5">
                                <span class="text-[9px] text-white font-medium" id="hero-cals-current">--</span>
                                <span class="text-[9px] text-gray-400 mx-0.5">/</span>
                                <span class="text-[9px] text-gray-400" id="hero-cals-target">--</span>
                                <span class="text-[9px] text-gray-400 ml-0.5">kcal</span>
                            </div>
                        </div>
                    </div>
                    <!-- Divider -->
                    <div class="w-px h-16 bg-white/10 flex-shrink-0"></div>
                    <!-- Macros - Horizontal Layout -->
                    <div class="flex-1 flex items-center justify-evenly">
                        <div class="text-center">
                            <div id="hero-ring-protein" class="w-11 h-11 mx-auto rounded-full flex items-center justify-center" style="background: conic-gradient(#4ADE80 0%, #333 0%);">
                                <div class="w-8 h-8 rounded-full bg-gray-900 flex items-center justify-center">
                                    <span class="text-[10px] font-bold text-green-400" id="hero-val-protein">0g</span>
                                </div>
                            </div>
                            <p class="text-[9px] text-gray-400 font-medium mt-1">Pro</p>
                        </div>
                        <div class="text-center">
                            <div id="hero-ring-carbs" class="w-11 h-11 mx-auto rounded-full flex items-center justify-center" style="background: conic-gradient(#60A5FA 0%, #333 0%);">
                                <div class="w-8 h-8 rounded-full bg-gray-900 flex items-center justify-center">
                                    <span class="text-[10px] font-bold text-blue-400" id="hero-val-carbs">0g</span>
                                </div>
                            </div>
                            <p class="text-[9px] text-gray-400 font-medium mt-1">Carb</p>
                        </div>
                        <div class="text-center">
                            <div id="hero-ring-fat" class="w-11 h-11 mx-auto rounded-full flex items-center justify-center" style="background: conic-gradient(#F472B6 0%, #333 0%);">
                                <div class="w-8 h-8 rounded-full bg-gray-900 flex items-center justify-center">
                                    <span class="text-[10px] font-bold text-pink-400" id="hero-val-fat">0g</span>
                                </div>
                            </div>
                            <p class="text-[9px] text-gray-400 font-medium mt-1">Fat</p>
                        </div>
                    </div>
                </div>
                {% endcall %}
            </div>

            <!-- Slide 2: Weight Stats -->
            <div class="snap-center flex-shrink-0 w-full">
                {% call card(classes="p-4 relative overflow-hidden h-[137px]") %}
                <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500/10 blur-3xl rounded-full -mr-8 -mt-8"></div>
                <div class="relative z-10">
                    <div class="flex justify-between items-center mb-2">
                        <div>
                            <p class="text-[10px] text-gray-400 uppercase tracking-wider">Weight</p>
                            <div class="flex items-baseline gap-1">
                                <span class="text-2xl font-black text-white" id="hero-weight">--</span>
                                <span class="text-sm text-blue-400">kg</span>
                                <span id="hero-weight-trend" class="text-[10px] px-1.5 py-0.5 rounded-full bg-green-500/20 text-green-400 font-bold ml-1">--</span>
                            </div>
                        </div>
                        <button onclick="openWeightModal()" class="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center hover:bg-blue-500/30 transition tap-effect">
                            <span class="text-lg">‚öñÔ∏è</span>
                        </button>
                    </div>
                    <!-- Mini Chart -->
                    <div class="h-12">
                        <canvas id="hero-weight-chart" class="w-full h-full"></canvas>
                    </div>
                </div>
                {% endcall %}
            </div>
        </div>

        <!-- Carousel Dots -->
        <div class="flex justify-center gap-1.5 mt-2">
            <button onclick="scrollToSlide(0)" id="carousel-dot-0" class="w-2 h-2 rounded-full bg-white/60 transition"></button>
            <button onclick="scrollToSlide(1)" id="carousel-dot-1" class="w-2 h-2 rounded-full bg-white/20 transition"></button>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="flex space-x-3 overflow-x-auto pb-2 -mx-1 px-1">
        <button onclick="openManualMealModal()"
            class="flex-shrink-0 bg-white/5 border border-white/10 backdrop-blur-sm px-4 py-3 rounded-2xl flex items-center space-x-2 tap-effect hover:bg-white/10 transition">
            <span class="text-sm">‚úèÔ∏è</span> <span class="text-xs font-medium text-white/90">Add Meal</span>
        </button>
        <button data-action="quickAction" data-type="scan"
            class="flex-shrink-0 bg-white/5 border border-white/10 backdrop-blur-sm px-4 py-3 rounded-2xl flex items-center space-x-2 tap-effect hover:bg-white/10 transition">
            <span class="text-sm">üì∑</span> <span class="text-xs font-medium text-white/90">Scan Meal</span>
        </button>
        <button data-action="quickAction" data-type="search"
            class="flex-shrink-0 bg-white/5 border border-white/10 backdrop-blur-sm px-4 py-3 rounded-2xl flex items-center space-x-2 tap-effect hover:bg-white/10 transition">
            <span class="text-sm">üîç</span> <span class="text-xs font-medium text-white/90">Search</span>
        </button>
        <button data-action="quickAction" data-type="copy"
            class="flex-shrink-0 bg-white/5 border border-white/10 backdrop-blur-sm px-4 py-3 rounded-2xl flex items-center space-x-2 tap-effect hover:bg-white/10 transition">
            <span class="text-sm">üìã</span> <span class="text-xs font-medium text-white/90">Copy Yesterday</span>
        </button>
    </div>

    <!-- Bento Grid: Hydration & Weekly -->
    <div class="bento-grid">
        <!-- Hydration Wave -->
        {% call card(classes="wave-container h-40 flex flex-col justify-between p-4 relative tap-effect") %}
        <div class="relative z-10">
            <p class="text-xs text-white/70 uppercase font-bold">Hydration</p>
            <p class="text-2xl font-black text-white mt-1" id="hydro-val">...</p>
        </div>
        <div class="wave" id="hydro-wave" style="top: 50%;"></div>
        <button data-action="addWater"
            class="absolute bottom-3 right-3 z-20 w-8 h-8 bg-white/20 rounded-full flex items-center justify-center text-white hover:bg-white/30 transition">+</button>
        {% endcall %}

        <!-- Weekly Consistency -->
        {% call card(classes="p-4 flex flex-col justify-between") %}
        <div class="flex justify-between items-center">
            <p class="text-xs text-gray-400 uppercase font-bold">Consistency</p>
            <p class="text-[10px] text-gray-500">This Week</p>
        </div>
        <div class="flex items-end justify-between h-16 mt-2 space-x-1" id="weekly-chart">
            <!-- Bars injected by JS -->
        </div>
        <div class="flex justify-between mt-1">
            <span class="text-[8px] text-gray-500">M</span>
            <span class="text-[8px] text-gray-500">T</span>
            <span class="text-[8px] text-gray-500">W</span>
            <span class="text-[8px] text-gray-500">T</span>
            <span class="text-[8px] text-gray-500">F</span>
            <span class="text-[8px] text-gray-500">S</span>
            <span class="text-[8px] text-gray-500">S</span>
        </div>
        {% endcall %}
    </div>

    <!-- Weight/Strength Trend Section -->
    <div>
        <div class="flex justify-between items-center mb-3">
            <h3 id="trend-section-title" class="text-sm font-bold text-gray-400 uppercase tracking-wider">Weight Trend</h3>
            <!-- Toggle between Weight and Strength -->
            <div class="flex bg-white/5 rounded-lg p-0.5">
                <button onclick="switchTrendView('weight')" id="trend-toggle-weight" class="text-[10px] px-3 py-1 rounded-md bg-blue-500/20 text-blue-400 font-bold transition">Weight</button>
                <button onclick="switchTrendView('strength')" id="trend-toggle-strength" class="text-[10px] px-3 py-1 rounded-md text-gray-400 hover:text-white transition">Strength</button>
            </div>
        </div>
        <div id="weight-chart-container" class="bg-white/5 rounded-xl p-4">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-2">
                    <button onclick="openWeightModal()" id="weight-update-btn" class="flex items-center gap-1.5 bg-gradient-to-r from-blue-500/20 to-cyan-500/20 border border-blue-500/30 px-3 py-1 rounded-full hover:from-blue-500/30 hover:to-cyan-500/30 transition tap-effect">
                        <span class="text-xs">‚öñÔ∏è</span>
                        <span id="client-weight" class="text-sm font-bold text-blue-400">--</span>
                        <span class="text-xs text-blue-400/70">kg</span>
                    </button>
                    <span id="weight-trend-badge" class="text-[10px] px-2 py-0.5 rounded-full bg-green-500/20 text-green-400 font-bold">--</span>
                </div>
                <div class="flex gap-1">
                    <button onclick="loadTrendChart('week')" id="weight-period-week" class="text-[10px] px-2 py-1 rounded-lg bg-white/5 text-gray-400 hover:bg-white/10 transition">Week</button>
                    <button onclick="loadTrendChart('month')" id="weight-period-month" class="text-[10px] px-2 py-1 rounded-lg bg-blue-500/20 text-blue-400 font-bold">Month</button>
                    <button onclick="loadTrendChart('year')" id="weight-period-year" class="text-[10px] px-2 py-1 rounded-lg bg-white/5 text-gray-400 hover:bg-white/10 transition">Year</button>
                </div>
            </div>
        <!-- Chart Area -->
        <div class="relative h-32">
            <canvas id="weight-chart" class="w-full h-full"></canvas>
            <div id="weight-chart-loading" class="absolute inset-0 flex items-center justify-center">
                <span class="text-gray-500 text-xs">Loading chart...</span>
            </div>
        </div>
        <!-- Weight Stats Row -->
        <div id="weight-stats-row" class="flex justify-between mt-3 text-center">
            <div>
                <p class="text-[10px] text-gray-500">Start</p>
                <p id="weight-stat-start" class="text-sm font-bold text-gray-400">--</p>
            </div>
            <div>
                <p class="text-[10px] text-gray-500">Min</p>
                <p id="weight-stat-min" class="text-sm font-bold text-green-400">--</p>
            </div>
            <div>
                <p class="text-[10px] text-gray-500">Max</p>
                <p id="weight-stat-max" class="text-sm font-bold text-red-400">--</p>
            </div>
            <div>
                <p class="text-[10px] text-gray-500">Change</p>
                <p id="weight-stat-change" class="text-sm font-bold text-blue-400">--</p>
            </div>
        </div>
        <!-- Strength Stats Row (hidden by default) -->
        <div id="strength-stats-row" class="hidden flex justify-between mt-3 text-center">
            <div>
                <p class="text-[10px] text-gray-500">Start</p>
                <p id="strength-stat-start" class="text-sm font-bold text-gray-400">0%</p>
            </div>
            <div>
                <p class="text-[10px] text-gray-500">Current</p>
                <p id="strength-stat-current" class="text-sm font-bold text-green-400">--</p>
            </div>
            <div>
                <p class="text-[10px] text-gray-500">Progress</p>
                <p id="strength-stat-progress" class="text-sm font-bold text-purple-400">--%</p>
            </div>
            <div>
                <p class="text-[10px] text-gray-500">Trend</p>
                <p id="strength-stat-trend" class="text-sm font-bold text-blue-400">--</p>
            </div>
        </div>
        </div>
    </div>

    <!-- Grouped Diet Log -->
    <div id="diet-log-container" class="space-y-4"></div>

    <!-- Physique Photos -->
    <div>
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Physique Update</h3>
            <div class="flex gap-2">
                <button onclick="openCompareModal()" class="text-xs bg-white/5 border border-white/10 backdrop-blur-sm px-3 py-1.5 rounded-xl text-white/80 hover:bg-white/10 hover:text-white transition tap-effect flex items-center gap-1">
                    <span class="text-[10px]">‚öñÔ∏è</span> Compare
                </button>
                <button onclick="openPhysiqueModal()" class="text-xs bg-primary/20 border border-primary/30 backdrop-blur-sm px-3 py-1.5 rounded-xl text-white hover:bg-primary/30 transition tap-effect flex items-center gap-1">
                    <span class="text-[10px]">‚ûï</span> Add
                </button>
            </div>
        </div>
        <div class="flex space-x-3 overflow-x-auto pb-2" id="photo-gallery">
            <p class="text-gray-500 text-xs py-4">Loading photos...</p>
        </div>
    </div>
</div>

<!-- Weight Update Modal -->
<div id="weight-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeWeightModal()">
    <div class="glass-card p-6 rounded-2xl max-w-xs w-full">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Update Weight</h3>
            <button onclick="closeWeightModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>
        <div class="text-center mb-6">
            <div class="relative inline-block">
                <input type="number" id="weight-input" step="0.1" min="20" max="300"
                    class="text-5xl font-black text-center bg-transparent border-b-2 border-blue-500 w-32 focus:outline-none text-blue-400"
                    placeholder="--">
                <span class="text-2xl text-blue-400/70 ml-2">kg</span>
            </div>
        </div>
        <button onclick="saveWeight()" class="w-full py-3 bg-gradient-to-r from-blue-500 to-cyan-500 text-white font-bold rounded-xl hover:from-blue-400 hover:to-cyan-400 transition tap-effect">
            Save Weight
        </button>
    </div>
</div>

<!-- Physique Photo Upload Modal -->
<div id="physique-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Add Progress Photo</h3>
            <button onclick="closePhysiqueModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>

        <form id="physique-form" class="space-y-4">
            <!-- Photo Preview -->
            <div id="physique-preview-container" class="hidden">
                <img id="physique-preview" class="w-full h-48 object-cover rounded-xl border border-white/10 mb-2">
                <button type="button" onclick="clearPhysiquePhoto()" class="text-xs text-red-400 hover:text-red-300">Remove photo</button>
            </div>

            <!-- Upload Button -->
            <div id="physique-upload-area" class="border-2 border-dashed border-white/20 rounded-xl p-8 text-center cursor-pointer hover:border-primary/50 transition"
                onclick="document.getElementById('physique-file-input').click()">
                <span class="text-4xl mb-2 block">üì∑</span>
                <p class="text-sm text-gray-400">Tap to select a photo</p>
                <p class="text-xs text-gray-500 mt-1">JPG, PNG, WEBP (max 10MB)</p>
            </div>
            <input type="file" id="physique-file-input" accept="image/*" class="hidden" onchange="previewPhysiquePhoto(this)">

            <!-- Pose Tags -->
            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Pose Tag</label>
                <div class="flex flex-wrap gap-2" id="physique-tags">
                    <button type="button" onclick="selectPhysiqueTag(this, 'Front')" class="physique-tag px-3 py-1.5 rounded-full text-xs font-medium bg-white/10 border border-white/20 hover:bg-white/20 transition">Front</button>
                    <button type="button" onclick="selectPhysiqueTag(this, 'Back')" class="physique-tag px-3 py-1.5 rounded-full text-xs font-medium bg-white/10 border border-white/20 hover:bg-white/20 transition">Back</button>
                    <button type="button" onclick="selectPhysiqueTag(this, 'Side L')" class="physique-tag px-3 py-1.5 rounded-full text-xs font-medium bg-white/10 border border-white/20 hover:bg-white/20 transition">Side L</button>
                    <button type="button" onclick="selectPhysiqueTag(this, 'Side R')" class="physique-tag px-3 py-1.5 rounded-full text-xs font-medium bg-white/10 border border-white/20 hover:bg-white/20 transition">Side R</button>
                    <button type="button" onclick="selectPhysiqueTag(this, 'Flexed')" class="physique-tag px-3 py-1.5 rounded-full text-xs font-medium bg-white/10 border border-white/20 hover:bg-white/20 transition">Flexed</button>
                    <button type="button" onclick="selectPhysiqueTag(this, 'Relaxed')" class="physique-tag px-3 py-1.5 rounded-full text-xs font-medium bg-white/10 border border-white/20 hover:bg-white/20 transition">Relaxed</button>
                </div>
            </div>

            <!-- Title -->
            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Title (optional)</label>
                <input type="text" id="physique-title" placeholder="e.g., Week 4 Progress"
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-3 text-sm text-white outline-none focus:border-primary/50 transition">
            </div>

            <!-- Date -->
            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Photo Date</label>
                <input type="date" id="physique-date"
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-3 text-sm text-white outline-none focus:border-primary/50 transition">
            </div>

            <!-- Notes -->
            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Notes (optional)</label>
                <textarea id="physique-notes" rows="2" placeholder="Any notes about this photo..."
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-3 text-sm text-white outline-none focus:border-primary/50 transition resize-none"></textarea>
            </div>

            <!-- Submit -->
            <button type="submit" id="physique-submit-btn"
                class="w-full bg-primary text-white py-3 rounded-xl font-bold hover:bg-primary/80 transition disabled:opacity-50 disabled:cursor-not-allowed">
                Upload Photo
            </button>
        </form>
    </div>
</div>

<!-- Physique Comparison Modal (Carousel) -->
<div id="compare-modal" class="fixed inset-0 bg-black/70 backdrop-blur-xl z-50 hidden flex flex-col">
    <div class="p-4 flex justify-between items-center border-b border-white/10 bg-white/5">
        <h3 class="text-lg font-bold">Compare Progress</h3>
        <div class="flex items-center gap-2">
            <!-- Animation Toggle Button -->
            <button id="animation-toggle-btn" onclick="toggleCarouselAnimations()" title="Animations On"
                class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/20 transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </button>
            <button onclick="closeCompareModal()" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/20 transition">&times;</button>
        </div>
    </div>

    <!-- Carousel Container -->
    <div class="flex-1 flex flex-col p-4 overflow-hidden min-h-0">
        <!-- Carousel View -->
        <div class="flex-1 relative flex items-center justify-center min-h-[200px]">
            <!-- Navigation Arrow Left -->
            <button id="carousel-prev" onclick="carouselPrev()"
                class="absolute left-2 z-10 w-10 h-10 rounded-full bg-white/10 backdrop-blur-sm border border-white/20 flex items-center justify-center text-white hover:bg-white/20 transition tap-effect disabled:opacity-30 disabled:cursor-not-allowed">
                ‚Üê
            </button>

            <!-- Photo Display -->
            <div id="carousel-photo-container" class="flex-1 h-full mx-14 bg-white/10 backdrop-blur-sm rounded-2xl border border-white/20 flex items-center justify-center overflow-hidden relative transition-all duration-300">
                <p class="text-gray-400 text-sm" id="carousel-placeholder">Select photos below to compare</p>
                <img id="carousel-img" class="hidden w-full h-full object-contain">
            </div>

            <!-- Navigation Arrow Right -->
            <button id="carousel-next" onclick="carouselNext()"
                class="absolute right-2 z-10 w-10 h-10 rounded-full bg-white/10 backdrop-blur-sm border border-white/20 flex items-center justify-center text-white hover:bg-white/20 transition tap-effect disabled:opacity-30 disabled:cursor-not-allowed">
                ‚Üí
            </button>
        </div>

        <!-- Photo Label -->
        <p id="carousel-label" class="text-center text-sm text-white mt-3 h-6 font-medium"></p>
        <p id="carousel-date" class="text-center text-xs text-gray-400 h-5"></p>

        <!-- Pagination Dots -->
        <div id="carousel-dots" class="flex justify-center gap-2 mt-3 flex-wrap max-w-full px-4"></div>
    </div>

    <!-- Photo Selector with Filters (Collapsible) -->
    <div id="photo-selector-panel" class="border-t border-white/10 bg-white/5 flex-shrink-0 overflow-hidden transition-all duration-300 ease-in-out" style="max-height: 260px;">
        <!-- Drag Handle -->
        <div onclick="togglePhotoSelector()" class="cursor-pointer py-3 flex justify-center hover:bg-white/5 transition">
            <div id="selector-toggle-icon" class="w-10 h-1 bg-white/30 rounded-full transition-all duration-300 hover:bg-white/50"></div>
        </div>
        <div class="px-4 pb-4 pt-3">
            <!-- Filter Bar -->
            <div class="flex gap-2 mb-3 flex-wrap">
                <input type="text" id="compare-search" placeholder="Search by title..."
                    oninput="filterComparePhotos()"
                    class="flex-1 min-w-[120px] bg-white/10 border border-white/20 rounded-xl px-3 py-2 text-xs text-white placeholder-gray-500 outline-none focus:border-primary/50 transition">
                <select id="compare-date-filter" onchange="filterComparePhotos()"
                    class="bg-white/10 border border-white/20 rounded-xl px-3 py-2 text-xs text-white outline-none focus:border-primary/50 transition">
                    <option value="all">All dates</option>
                    <option value="week">This week</option>
                    <option value="month">This month</option>
                    <option value="3months">Last 3 months</option>
                    <option value="year">This year</option>
                </select>
                <select id="compare-pose-filter" onchange="filterComparePhotos()"
                    class="bg-white/10 border border-white/20 rounded-xl px-3 py-2 text-xs text-white outline-none focus:border-primary/50 transition">
                    <option value="all">All poses</option>
                    <option value="Front">Front</option>
                    <option value="Back">Back</option>
                    <option value="Side">Side</option>
                    <option value="Flexed">Flexed</option>
                    <option value="Relaxed">Relaxed</option>
                </select>
            </div>
            <p class="text-xs text-gray-400 mb-2">Tap photos to add/remove: <span id="compare-photo-count" class="text-white/60"></span></p>
            <div id="compare-photo-list" class="flex gap-2 overflow-x-auto pb-2"></div>
        </div>
    </div>
</div>

<!-- Manual Meal Entry Modal -->
<div id="manual-meal-modal" class="fixed inset-0 bg-black/70 backdrop-blur-xl z-50 hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Add Meal Manually</h3>
            <button onclick="closeManualMealModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>

        <form id="manual-meal-form" class="space-y-4">
            <!-- Meal Name -->
            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Meal Name</label>
                <input type="text" id="meal-name" required
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-3 text-sm text-white outline-none focus:border-primary/50 transition"
                    placeholder="e.g., Grilled Chicken with Rice">
            </div>

            <!-- Meal Type -->
            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Meal Type</label>
                <select id="meal-type" required
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-3 text-sm text-white outline-none focus:border-primary/50 transition">
                    <option value="Breakfast">Breakfast</option>
                    <option value="Lunch">Lunch</option>
                    <option value="Dinner">Dinner</option>
                    <option value="Snack">Snack</option>
                </select>
            </div>

            <!-- Macros Grid -->
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Calories</label>
                    <input type="number" id="meal-calories" required min="0"
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-3 text-sm text-white outline-none focus:border-primary/50 transition"
                        placeholder="0">
                </div>
                <div>
                    <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Protein (g)</label>
                    <input type="number" id="meal-protein" required min="0"
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-3 text-sm text-white outline-none focus:border-primary/50 transition"
                        placeholder="0">
                </div>
                <div>
                    <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Carbs (g)</label>
                    <input type="number" id="meal-carbs" required min="0"
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-3 text-sm text-white outline-none focus:border-primary/50 transition"
                        placeholder="0">
                </div>
                <div>
                    <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Fat (g)</label>
                    <input type="number" id="meal-fat" required min="0"
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-3 text-sm text-white outline-none focus:border-primary/50 transition"
                        placeholder="0">
                </div>
            </div>

            <!-- Future AI Button (Disabled) -->
            <div class="bg-white/5 border border-white/10 rounded-lg p-3 text-center">
                <button type="button" disabled
                    class="w-full bg-white/5 text-gray-500 px-4 py-2 rounded-lg text-sm font-bold cursor-not-allowed opacity-50">
                    ü§ñ Calculate with AI (Coming Soon)
                </button>
                <p class="text-xs text-gray-500 mt-2">AI-powered macro calculation will be available in a future update</p>
            </div>

            <!-- Submit Button -->
            <button type="submit"
                class="w-full bg-primary px-4 py-3 rounded-lg font-bold hover:bg-primary/80 transition">
                Add Meal
            </button>
        </form>
    </div>
</div>

<!-- Camera Scanner Modal -->
<div id="camera-scanner-modal" class="fixed inset-0 bg-black z-50 hidden flex flex-col">
    <!-- Header -->
    <div class="flex justify-between items-center p-4 bg-black/50 backdrop-blur-sm">
        <button onclick="closeCameraScanner()" class="text-white text-2xl">&times;</button>
        <h3 class="text-white font-bold">Scan Your Meal</h3>
        <button id="flip-btn" onclick="flipCamera()" class="text-white text-xl" title="Switch Camera">üîÑ</button>
    </div>

    <!-- Mode Toggle Tabs -->
    <div id="scan-mode-tabs" class="flex bg-black/30 mx-4 rounded-full p-1">
        <button onclick="setScanMode('photo')" id="photo-mode-btn" class="flex-1 py-2 px-4 rounded-full text-sm font-medium transition bg-primary text-white">
            üì∑ Photo
        </button>
        <button onclick="setScanMode('barcode')" id="barcode-mode-btn" class="flex-1 py-2 px-4 rounded-full text-sm font-medium transition text-white/60">
            ‚ñ¶ Barcode
        </button>
    </div>

    <!-- Camera Preview (Live) - Photo Mode -->
    <div id="camera-live-view" class="flex-1 relative overflow-hidden">
        <video id="camera-preview" autoplay playsinline class="w-full h-full object-cover"></video>

        <!-- Photo Scanning Overlay -->
        <div id="photo-overlay" class="absolute inset-0 pointer-events-none">
            <div class="absolute top-1/4 left-1/4 w-1/2 h-1/2">
                <div class="absolute top-0 left-0 w-8 h-8 border-t-2 border-l-2 border-white/70 rounded-tl-lg"></div>
                <div class="absolute top-0 right-0 w-8 h-8 border-t-2 border-r-2 border-white/70 rounded-tr-lg"></div>
                <div class="absolute bottom-0 left-0 w-8 h-8 border-b-2 border-l-2 border-white/70 rounded-bl-lg"></div>
                <div class="absolute bottom-0 right-0 w-8 h-8 border-b-2 border-r-2 border-white/70 rounded-br-lg"></div>
            </div>
        </div>
    </div>

    <!-- Barcode Scanner View (QuaggaJS container) -->
    <div id="barcode-scanner-view" class="flex-1 relative overflow-hidden hidden">
        <div id="barcode-scanner-container" class="w-full h-full"></div>

        <!-- Barcode Scanning Overlay -->
        <div class="absolute inset-0 pointer-events-none">
            <div class="absolute top-1/3 left-[10%] w-[80%] h-24">
                <div class="absolute inset-0 border-2 border-red-500/70 rounded-lg"></div>
                <div class="absolute top-1/2 left-0 right-0 h-0.5 bg-red-500 animate-pulse"></div>
            </div>
            <p class="absolute top-[60%] left-0 right-0 text-center text-white/80 text-sm">Point at barcode</p>
        </div>
    </div>

    <!-- Captured Photo Preview (Hidden initially) -->
    <div id="camera-preview-view" class="flex-1 relative overflow-hidden hidden">
        <img id="captured-photo" class="w-full h-full object-cover" src="" alt="Captured photo">

        <!-- Loading Overlay -->
        <div id="camera-loading" class="absolute inset-0 bg-black/70 flex items-center justify-center hidden">
            <div class="text-center">
                <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
                <p class="text-white text-sm" id="loading-text">Analyzing meal...</p>
            </div>
        </div>
    </div>

    <!-- Results Edit View (Hidden initially) -->
    <div id="results-edit-view" class="flex-1 overflow-y-auto hidden bg-gray-900">
        <div class="p-4">
            <h4 id="result-food-name" class="text-white font-bold text-lg mb-4 text-center">Scanned Food</h4>

            <!-- Editable Fields -->
            <div class="space-y-3">
                <div class="bg-white/10 rounded-xl p-3">
                    <label class="text-white/60 text-xs">Food Name</label>
                    <input type="text" id="edit-food-name" class="w-full bg-transparent text-white text-lg font-medium border-none outline-none mt-1" placeholder="Food name">
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white/10 rounded-xl p-3">
                        <label class="text-white/60 text-xs">Calories</label>
                        <div class="flex items-center mt-1">
                            <input type="number" id="edit-calories" class="w-full bg-transparent text-white text-xl font-bold border-none outline-none" placeholder="0">
                            <span class="text-white/40 text-sm ml-1">kcal</span>
                        </div>
                    </div>
                    <div class="bg-white/10 rounded-xl p-3">
                        <label class="text-white/60 text-xs">Protein</label>
                        <div class="flex items-center mt-1">
                            <input type="number" id="edit-protein" class="w-full bg-transparent text-white text-xl font-bold border-none outline-none" placeholder="0" step="0.1">
                            <span class="text-white/40 text-sm ml-1">g</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white/10 rounded-xl p-3">
                        <label class="text-white/60 text-xs">Carbs</label>
                        <div class="flex items-center mt-1">
                            <input type="number" id="edit-carbs" class="w-full bg-transparent text-white text-xl font-bold border-none outline-none" placeholder="0" step="0.1">
                            <span class="text-white/40 text-sm ml-1">g</span>
                        </div>
                    </div>
                    <div class="bg-white/10 rounded-xl p-3">
                        <label class="text-white/60 text-xs">Fat</label>
                        <div class="flex items-center mt-1">
                            <input type="number" id="edit-fat" class="w-full bg-transparent text-white text-xl font-bold border-none outline-none" placeholder="0" step="0.1">
                            <span class="text-white/40 text-sm ml-1">g</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white/10 rounded-xl p-3">
                    <label class="text-white/60 text-xs">Portion Size</label>
                    <input type="text" id="edit-portion" class="w-full bg-transparent text-white font-medium border-none outline-none mt-1" placeholder="e.g., 100g, 1 serving">
                </div>
            </div>

            <!-- Source Info -->
            <p id="result-source" class="text-white/40 text-xs text-center mt-4">Source: AI Vision</p>
        </div>
    </div>

    <!-- Bottom Controls - Capture Mode (Photo) -->
    <div id="capture-controls" class="p-6 bg-gradient-to-t from-black to-transparent">
        <p class="text-center text-white/60 text-xs mb-4">Take a photo of your meal</p>
        <div class="flex justify-center items-center space-x-6">
            <button onclick="openGalleryForScan()" class="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center text-white">
                üñºÔ∏è
            </button>
            <button onclick="takePhoto()" id="capture-btn" class="w-20 h-20 rounded-full bg-white flex items-center justify-center shadow-lg active:scale-95 transition">
                <div class="w-16 h-16 rounded-full border-4 border-black/20"></div>
            </button>
            <div class="w-12 h-12"></div>
        </div>
    </div>

    <!-- Bottom Controls - Barcode Mode -->
    <div id="barcode-controls" class="p-6 bg-gradient-to-t from-black to-transparent hidden">
        <p class="text-center text-white/60 text-xs mb-4">Scanning for barcode...</p>
        <div class="flex justify-center">
            <div class="w-12 h-12 border-4 border-white/30 border-t-white rounded-full animate-spin"></div>
        </div>
    </div>

    <!-- Bottom Controls - Review Mode -->
    <div id="review-controls" class="p-6 bg-gradient-to-t from-black to-transparent hidden">
        <p class="text-center text-white/60 text-xs mb-4">Review your photo</p>
        <div class="flex justify-center items-center space-x-4">
            <button onclick="retakePhoto()" class="px-6 py-3 rounded-full bg-white/20 text-white font-medium">
                ‚Ü©Ô∏è Retake
            </button>
            <button onclick="analyzePhoto()" id="analyze-btn" class="px-8 py-3 rounded-full bg-primary text-white font-bold shadow-lg">
                ‚ú® Analyze
            </button>
        </div>
    </div>

    <!-- Bottom Controls - Results Edit Mode -->
    <div id="results-controls" class="p-4 bg-black hidden">
        <div class="flex justify-center items-center space-x-4">
            <button onclick="cancelScanResult()" class="px-6 py-3 rounded-full bg-white/20 text-white font-medium">
                ‚úï Cancel
            </button>
            <button onclick="logScannedMeal()" class="px-8 py-3 rounded-full bg-green-500 text-white font-bold shadow-lg">
                ‚úì Log Meal
            </button>
        </div>
    </div>

    <!-- Hidden canvas for capturing -->
    <canvas id="camera-canvas" class="hidden"></canvas>
    <!-- Hidden file input for gallery -->
    <input type="file" id="gallery-input" accept="image/*" class="hidden" onchange="handleGallerySelect(event)">
</div>

<script>
// --- MANUAL MEAL ENTRY (Progress/Nutrition Page) ---

function openManualMealModal() {
    document.getElementById('manual-meal-modal').classList.remove('hidden');
    // Reset form
    const form = document.getElementById('manual-meal-form');
    if (form) form.reset();
}

function closeManualMealModal() {
    document.getElementById('manual-meal-modal').classList.add('hidden');
}

// Handle manual meal form submission
const mealForm = document.getElementById('manual-meal-form');
if (mealForm) {
    mealForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const mealData = {
            name: document.getElementById('meal-name').value,
            meal_type: document.getElementById('meal-type').value,
            cals: parseInt(document.getElementById('meal-calories').value),
            protein: parseInt(document.getElementById('meal-protein').value),
            carbs: parseInt(document.getElementById('meal-carbs').value),
            fat: parseInt(document.getElementById('meal-fat').value)
        };

        try {
            const response = await fetch('/api/client/diet/log', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify(mealData)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to log meal');
            }

            showToast(`${mealData.name} logged successfully! üçΩÔ∏è`, 'success');
            closeManualMealModal();

            // Reload the page to show updated data
            setTimeout(() => window.location.reload(), 500);
        } catch (error) {
            console.error('Error logging meal:', error);
            showToast(error.message, 'error');
        }
    });
}
</script>

{% elif mode == "calendar" %}
<div class="p-6 pt-10 flex justify-between items-center bg-gradient-to-b from-black/80 to-transparent z-10">
    <div class="flex items-center space-x-3">
        <a href="{{ 'client.html' if static_build else '/?gym_id=' + gym_id + '&role=client' }}"
            class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center tap-effect">‚Üê</a>
        <h2 class="font-bold text-xl">Schedule</h2>
    </div>
    <div class="flex space-x-2">
        <div onclick="openClientBookAppointmentModal()" class="relative w-10 h-10 rounded-full bg-blue-500/20 border border-blue-500/30 flex items-center justify-center tap-effect cursor-pointer" title="Book Appointment">
            üìÖ
        </div>
        <div onclick="openClientChatModal()" class="relative w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center tap-effect cursor-pointer">
            üí¨
        </div>
        <div data-action="showModal" data-target="notification-modal"
            class="w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center tap-effect">
            üîî
        </div>
    </div>
</div>
<div class="flex-1 p-4 space-y-4">
    <!-- Calendar Header -->
    <div class="flex justify-between items-center mb-4">
        <button id="prev-month" class="p-2 bg-white/10 rounded-full tap-effect">‚Üê</button>
        <h2 id="current-month-year" class="text-xl font-bold text-white">December 2025</h2>
        <button id="next-month" class="p-2 bg-white/10 rounded-full tap-effect">‚Üí</button>
    </div>

    <!-- Calendar Grid -->
    {% call card(classes="p-4") %}
    <div class="grid grid-cols-7 gap-2 text-center mb-2">
        <div class="text-xs text-gray-500 font-bold">S</div>
        <div class="text-xs text-gray-500 font-bold">M</div>
        <div class="text-xs text-gray-500 font-bold">T</div>
        <div class="text-xs text-gray-500 font-bold">W</div>
        <div class="text-xs text-gray-500 font-bold">T</div>
        <div class="text-xs text-gray-500 font-bold">F</div>
        <div class="text-xs text-gray-500 font-bold">S</div>
    </div>
    <div id="calendar-grid" class="grid grid-cols-7 gap-y-2 gap-x-0">
        <!-- Days injected by JS -->
    </div>
    {% endcall %}

    <!-- Selected Day Details -->
    <div id="selected-day-details" class="space-y-3">
        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider ml-1" id="selected-date-title">Today</h3>
        <div id="day-events-list" class="space-y-2">
            <!-- Events injected by JS -->
        </div>
    </div>
</div>

{% elif mode == "account_settings" %}
<div class="p-6 pt-10 flex items-center space-x-4 bg-black/50 z-10">
    <a href="{{ 'client.html' if static_build else '/?gym_id=' + gym_id + '&role=client&mode=client_dashboard' }}"
        class="text-2xl tap-effect">‚Üê</a>
    <h2 class="font-bold text-xl">Account Management</h2>
</div>
<div class="flex-1 p-4 space-y-6">
    <!-- Gym & Trainer Section -->
    {% call card(classes="p-6 space-y-4") %}
    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Gym & Trainer</h3>

    <!-- Current Gym -->
    <div id="gym-status-container">
        <label class="text-xs text-gray-500 uppercase font-bold block mb-2">Current Gym</label>
        <div id="current-gym-display" class="text-white mb-3">Loading...</div>
    </div>

    <!-- Leave Gym Button (shown if has gym) -->
    <div id="leave-gym-section" class="hidden mb-4">
        <button onclick="leaveGym()"
            class="px-4 py-2 bg-red-500/20 text-red-400 border border-red-500/30 font-bold rounded-xl tap-effect hover:bg-red-500/30 transition">
            LEAVE GYM
        </button>
    </div>

    <!-- Join Gym (shown if no gym) -->
    <div id="join-gym-section" class="hidden">
        <label class="text-xs text-gray-500 uppercase font-bold block mb-2">Enter Gym Code</label>
        <div class="flex gap-2">
            <input type="text" id="gym-code-input" placeholder="Enter code from your gym"
                class="flex-1 bg-white/5 border border-white/10 rounded-xl p-3 text-white focus:border-primary outline-none transition">
            <button onclick="joinGym()"
                class="px-6 py-3 bg-primary text-black font-bold rounded-xl tap-effect hover:bg-primary/90 transition">
                JOIN
            </button>
        </div>
    </div>

    <!-- Current Trainer -->
    <div id="trainer-status-container" class="mt-4">
        <label class="text-xs text-gray-500 uppercase font-bold block mb-2">Your Trainer</label>
        <div id="current-trainer-display" class="text-white mb-3">Loading...</div>
    </div>

    <!-- Select Trainer (shown if no trainer) -->
    <div id="select-trainer-section" class="hidden">
        <label class="text-xs text-gray-500 uppercase font-bold block mb-2">Choose Your Trainer</label>
        <div id="trainer-list" class="space-y-2 mb-3">
            <!-- Trainers will be loaded here -->
        </div>
    </div>
    {% endcall %}

    <!-- Profile Section -->
    {% call card(classes="p-6 space-y-4") %}
    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Profile</h3>
    <div>
        <label class="text-xs text-gray-500 uppercase font-bold block mb-2">Full Name</label>
        <input type="text" id="profile-name"
            class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white focus:border-primary outline-none transition">
    </div>
    <div>
        <label class="text-xs text-gray-500 uppercase font-bold block mb-2">Email Address</label>
        <input type="email" id="profile-email"
            class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white focus:border-primary outline-none transition">
    </div>
    <div>
        <label class="text-xs text-gray-500 uppercase font-bold block mb-2">Password</label>
        <input type="password" id="profile-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white focus:border-primary outline-none transition">
    </div>
    <button onclick="saveProfile()"
        class="w-full py-4 bg-primary text-black font-bold rounded-xl tap-effect hover:bg-primary/90 transition mt-4">
        SAVE CHANGES
    </button>
    {% endcall %}

    <!-- Privacy Section -->
    {% call card(classes="p-6 space-y-4") %}
    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Privacy</h3>
    <p class="text-sm text-gray-400 mb-4">Control who can message you in the gym</p>

    <!-- Privacy Mode Selector -->
    <div class="space-y-3">
        <!-- Public Option -->
        <button onclick="setPrivacyMode('public')" id="privacy-opt-public"
            class="w-full p-4 rounded-xl border-2 transition-all duration-200 text-left privacy-option">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center">
                    <span class="text-xl">üåç</span>
                </div>
                <div class="flex-1">
                    <p class="font-bold text-white">Public</p>
                    <p class="text-xs text-gray-400">Anyone in your gym can message you</p>
                </div>
                <div id="privacy-check-public" class="w-6 h-6 rounded-full bg-green-500 hidden items-center justify-center">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
            </div>
        </button>

        <!-- Private Option -->
        <button onclick="setPrivacyMode('private')" id="privacy-opt-private"
            class="w-full p-4 rounded-xl border-2 transition-all duration-200 text-left privacy-option">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-yellow-500/20 flex items-center justify-center">
                    <span class="text-xl">üîí</span>
                </div>
                <div class="flex-1">
                    <p class="font-bold text-white">Private</p>
                    <p class="text-xs text-gray-400">Requires approval before clients can message you</p>
                </div>
                <div id="privacy-check-private" class="w-6 h-6 rounded-full bg-yellow-500 hidden items-center justify-center">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
            </div>
        </button>

        <!-- Staff Only Option -->
        <button onclick="setPrivacyMode('staff_only')" id="privacy-opt-staff_only"
            class="w-full p-4 rounded-xl border-2 transition-all duration-200 text-left privacy-option">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center">
                    <span class="text-xl">üõ°Ô∏è</span>
                </div>
                <div class="flex-1">
                    <p class="font-bold text-white">Staff Only</p>
                    <p class="text-xs text-gray-400">Only trainers and gym staff can message you</p>
                </div>
                <div id="privacy-check-staff_only" class="w-6 h-6 rounded-full bg-red-500 hidden items-center justify-center">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
            </div>
        </button>
    </div>

    <!-- Pending Chat Requests -->
    <div id="chat-requests-section" class="mt-6 hidden">
        <h4 class="text-xs font-bold text-gray-500 uppercase mb-3">Pending Chat Requests</h4>
        <div id="pending-requests-list" class="space-y-2">
            <!-- Requests will be loaded here -->
        </div>
    </div>
    {% endcall %}
</div>

<script>
// --- PRIVACY SETTINGS ---

let currentPrivacyMode = 'public';

async function loadPrivacySettings() {
    try {
        const response = await fetch('/api/client/privacy', { credentials: 'include' });
        if (response.ok) {
            const data = await response.json();
            currentPrivacyMode = data.privacy_mode || 'public';
            updatePrivacyUI();
            loadPendingChatRequests();
        }
    } catch (error) {
        console.error('Error loading privacy settings:', error);
    }
}

function updatePrivacyUI() {
    const requestsSection = document.getElementById('chat-requests-section');
    const modes = ['public', 'private', 'staff_only'];

    // Update all option buttons
    modes.forEach(mode => {
        const opt = document.getElementById(`privacy-opt-${mode}`);
        const check = document.getElementById(`privacy-check-${mode}`);

        if (mode === currentPrivacyMode) {
            // Selected state
            opt.classList.add('border-white/30', 'bg-white/10');
            opt.classList.remove('border-white/10', 'bg-white/5');
            check.classList.remove('hidden');
            check.classList.add('flex');
        } else {
            // Unselected state
            opt.classList.remove('border-white/30', 'bg-white/10');
            opt.classList.add('border-white/10', 'bg-white/5');
            check.classList.add('hidden');
            check.classList.remove('flex');
        }
    });

    // Show pending requests section only for private mode
    if (currentPrivacyMode === 'private') {
        requestsSection.classList.remove('hidden');
    } else {
        requestsSection.classList.add('hidden');
    }
}

async function setPrivacyMode(newMode) {
    if (newMode === currentPrivacyMode) return;

    try {
        const response = await fetch('/api/client/privacy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ mode: newMode })
        });

        if (response.ok) {
            currentPrivacyMode = newMode;
            updatePrivacyUI();
            const modeLabels = {
                'public': 'PUBLIC',
                'private': 'PRIVATE',
                'staff_only': 'STAFF ONLY'
            };
            showToast(`Profile set to ${modeLabels[newMode]}`, 'success');

            // Load pending requests if switching to private mode
            if (newMode === 'private') {
                loadPendingChatRequests();
            }
        } else {
            showToast('Failed to update privacy', 'error');
        }
    } catch (error) {
        console.error('Error updating privacy:', error);
        showToast('Failed to update privacy', 'error');
    }
}

async function loadPendingChatRequests() {
    if (currentPrivacyMode !== 'private') return;

    try {
        const response = await fetch('/api/client/chat-requests/pending', { credentials: 'include' });
        if (response.ok) {
            const requests = await response.json();
            renderPendingRequests(requests);
        }
    } catch (error) {
        console.error('Error loading chat requests:', error);
    }
}

function renderPendingRequests(requests) {
    const container = document.getElementById('pending-requests-list');

    if (requests.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No pending requests</p>';
        return;
    }

    container.innerHTML = requests.map(req => `
        <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center overflow-hidden">
                    ${req.from_profile_picture
                        ? `<img src="${req.from_profile_picture}" class="w-full h-full object-cover">`
                        : '<span class="text-lg">üë§</span>'}
                </div>
                <div>
                    <p class="font-bold text-white text-sm">${req.from_username}</p>
                    ${req.message ? `<p class="text-xs text-gray-400 truncate max-w-[150px]">"${req.message}"</p>` : ''}
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="respondToRequest(${req.id}, true)"
                    class="px-3 py-1.5 bg-green-500/20 text-green-400 text-xs font-bold rounded-lg hover:bg-green-500/30 transition">
                    Accept
                </button>
                <button onclick="respondToRequest(${req.id}, false)"
                    class="px-3 py-1.5 bg-red-500/20 text-red-400 text-xs font-bold rounded-lg hover:bg-red-500/30 transition">
                    Reject
                </button>
            </div>
        </div>
    `).join('');
}

async function respondToRequest(requestId, accept) {
    try {
        const response = await fetch('/api/client/chat-requests/respond', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ request_id: requestId, accept: accept })
        });

        if (response.ok) {
            showToast(accept ? 'Request accepted!' : 'Request rejected', 'success');
            loadPendingChatRequests();
        } else {
            showToast('Failed to respond to request', 'error');
        }
    } catch (error) {
        console.error('Error responding to request:', error);
        showToast('Failed to respond to request', 'error');
    }
}

// Load privacy settings on page load
loadPrivacySettings();

// --- GYM & TRAINER ASSIGNMENT (Account Settings Page) ---

async function loadGymAndTrainerInfo() {
    console.log('[GYM INFO] Loading gym and trainer info...');

    try {
        const response = await fetch('/api/client/gym-info', {
            credentials: 'include'
        });

        console.log('[GYM INFO] Response status:', response.status);

        if (!response.ok) {
            console.error('[GYM INFO] Failed to load:', response.status, await response.text());
            document.getElementById('current-gym-display').textContent = 'Error loading gym info';
            document.getElementById('current-trainer-display').textContent = 'Error loading trainer info';
            return;
        }

        const info = await response.json();
        console.log('[GYM INFO] Data received:', info);

        // Update gym display
        const gymDisplay = document.getElementById('current-gym-display');
        const joinGymSection = document.getElementById('join-gym-section');
        const leaveGymSection = document.getElementById('leave-gym-section');

        if (info.has_gym) {
            gymDisplay.textContent = info.gym_name || 'Unknown Gym';
            gymDisplay.classList.add('font-bold');
            joinGymSection.classList.add('hidden');
            if (leaveGymSection) leaveGymSection.classList.remove('hidden');
        } else {
            gymDisplay.textContent = 'No gym assigned';
            gymDisplay.classList.remove('font-bold');
            gymDisplay.classList.add('text-gray-400');
            joinGymSection.classList.remove('hidden');
            if (leaveGymSection) leaveGymSection.classList.add('hidden');
        }

        // Update trainer display
        const trainerDisplay = document.getElementById('current-trainer-display');
        const selectTrainerSection = document.getElementById('select-trainer-section');

        if (info.has_trainer) {
            trainerDisplay.textContent = info.trainer_name || 'Unknown Trainer';
            trainerDisplay.classList.add('font-bold');
            selectTrainerSection.classList.add('hidden');
        } else {
            trainerDisplay.textContent = 'No trainer selected';
            trainerDisplay.classList.remove('font-bold');
            trainerDisplay.classList.add('text-gray-400');

            if (info.has_gym) {
                selectTrainerSection.classList.remove('hidden');
                await loadTrainersForSelection(info.gym_id);
            }
        }
    } catch (error) {
        console.error('[GYM INFO] Error:', error);
    }
}

async function joinGym() {
    const gymCode = document.getElementById('gym-code-input').value.trim();

    if (!gymCode) {
        alert('Please enter a gym code');
        return;
    }

    try {
        const response = await fetch('/api/client/join-gym', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ gym_code: gymCode })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to join gym');
        }

        const result = await response.json();
        alert(`Joined ${result.gym_name} successfully!`);

        setTimeout(() => loadGymAndTrainerInfo(), 500);
    } catch (error) {
        console.error('Error joining gym:', error);
        alert(error.message);
    }
}

async function leaveGym() {
    if (!confirm('Are you sure you want to leave your current gym? This will also unassign your trainer.')) {
        return;
    }

    try {
        const response = await fetch('/api/client/leave-gym', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to leave gym');
        }

        const result = await response.json();
        alert('Successfully left gym');

        setTimeout(() => loadGymAndTrainerInfo(), 500);
    } catch (error) {
        console.error('Error leaving gym:', error);
        alert(error.message);
    }
}

async function loadTrainersForSelection(gymId) {
    try {
        const response = await fetch(`/api/gym/${gymId}/trainers`, {
            credentials: 'include'
        });

        if (!response.ok) return;

        const trainers = await response.json();
        const trainerList = document.getElementById('trainer-list');

        if (trainers.length === 0) {
            trainerList.innerHTML = '<p class="text-gray-400 text-sm">No trainers available</p>';
            return;
        }

        trainerList.innerHTML = trainers.map(trainer => `
            <button onclick="selectTrainer('${trainer.id}')"
                class="w-full bg-white/10 hover:bg-primary/30 border border-white/10 hover:border-primary px-4 py-3 rounded-lg text-left transition tap-effect">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-bold text-white">${trainer.username}</p>
                        <p class="text-xs text-gray-400">${trainer.client_count} clients</p>
                    </div>
                    <span class="text-primary text-xl">‚Üí</span>
                </div>
            </button>
        `).join('');
    } catch (error) {
        console.error('Error loading trainers:', error);
    }
}

async function selectTrainer(trainerId) {
    try {
        const response = await fetch('/api/client/select-trainer', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ trainer_id: trainerId })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to select trainer');
        }

        const result = await response.json();
        alert(`Assigned to ${result.trainer_name} successfully!`);

        setTimeout(() => loadGymAndTrainerInfo(), 500);
    } catch (error) {
        console.error('Error selecting trainer:', error);
        alert(error.message);
    }
}

// Load gym/trainer info when page loads
console.log('[INIT] Account settings page - loading gym/trainer info');
setTimeout(() => loadGymAndTrainerInfo(), 100);
</script>

{% elif mode == "client_dashboard" %}
<div class="p-6 pt-10 flex justify-between items-center bg-black/50 z-10">
    <div class="flex items-center space-x-3">
        <a href="{{ 'client.html' if static_build else '/?gym_id=' + gym_id + '&role=client' }}"
            class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center tap-effect">‚Üê</a>
        <h2 class="font-bold text-xl">Client Dashboard</h2>
    </div>
    <div class="flex space-x-2">
        <div onclick="openBookingChoiceForMyTrainer()" class="relative w-10 h-10 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center tap-effect cursor-pointer" title="Book Session">
            üìÖ
        </div>
        <div onclick="openClientChatModal()" class="relative w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center tap-effect cursor-pointer">
            üí¨
        </div>
        <div data-action="showModal" data-target="notification-modal"
            class="w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center tap-effect">
            üîî
        </div>
    </div>
</div>
<div class="flex-1 p-4 space-y-6">
    <!-- User Profile Card -->
    {% call card(classes="p-6 flex flex-col items-center relative overflow-hidden") %}
    <div class="absolute top-0 right-0 w-32 h-32 bg-primary/20 blur-3xl rounded-full -mr-10 -mt-10"></div>

    <!-- Profile Picture with Upload -->
    <div class="relative z-10 mb-4 group">
        <div id="profile-avatar-container"
            class="w-24 h-24 rounded-full bg-gradient-to-tr from-gray-700 to-gray-600 border-2 border-primary overflow-hidden cursor-pointer"
            onclick="document.getElementById('profile-picture-input').click()">
            <img id="profile-avatar-img" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Alex" class="w-full h-full object-cover">
        </div>
        <!-- Edit overlay -->
        <div class="absolute inset-0 rounded-full bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center cursor-pointer"
            onclick="document.getElementById('profile-picture-input').click()">
            <span class="text-white text-2xl">üì∑</span>
        </div>
        <!-- Hidden file input -->
        <input type="file" id="profile-picture-input" accept="image/*" class="hidden" onchange="uploadProfilePicture(this)">
    </div>

    <h2 class="text-2xl font-black text-white mb-1" id="client-display-name">Loading...</h2>
    <p class="text-gray-400 text-sm mb-4" id="client-display-email">Loading...</p>
    <div class="flex space-x-4 text-xs text-gray-500 uppercase tracking-wider font-bold">
        <span id="member-since">Member since Jan 2025</span>
    </div>
    {% endcall %}

    <!-- Fitness Goal Selector -->
    <div class="space-y-3">
        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider ml-1">Fitness Goal</h3>
        <p class="text-xs text-gray-500 ml-1 -mt-1" id="goal-subtitle">Adjusts your daily calorie target</p>

        <!-- Trainer managed notice (hidden by default) -->
        <div id="trainer-managed-notice" class="hidden bg-gradient-to-r from-purple-500/20 to-blue-500/20 border border-purple-500/30 rounded-xl p-3 flex items-center gap-3">
            <div class="w-8 h-8 rounded-full bg-purple-500/30 flex items-center justify-center">
                <svg class="w-4 h-4 text-purple-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
            </div>
            <p class="text-sm text-purple-300">Your trainer manages your nutrition plan</p>
        </div>

        <div class="grid grid-cols-3 gap-3" id="goal-selector">
            <!-- Cut -->
            <button onclick="selectFitnessGoal('cut')" id="goal-cut"
                class="goal-card p-4 rounded-2xl border-2 border-transparent bg-white/5 hover:bg-white/10 transition-all duration-300 flex flex-col items-center space-y-2 tap-effect">
                <div class="goal-icon w-12 h-12 rounded-full bg-blue-500/20 flex items-center justify-center text-2xl transition-all duration-300">
                    <svg class="w-6 h-6 text-blue-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 19V5M5 12l7-7 7 7"/>
                    </svg>
                </div>
                <span class="font-bold text-white text-sm">Cut</span>
                <span class="text-[10px] text-gray-500">-500 kcal</span>
            </button>

            <!-- Maintain -->
            <button onclick="selectFitnessGoal('maintain')" id="goal-maintain"
                class="goal-card p-4 rounded-2xl border-2 border-transparent bg-white/5 hover:bg-white/10 transition-all duration-300 flex flex-col items-center space-y-2 tap-effect">
                <div class="goal-icon w-12 h-12 rounded-full bg-green-500/20 flex items-center justify-center text-2xl transition-all duration-300">
                    <svg class="w-6 h-6 text-green-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14"/>
                    </svg>
                </div>
                <span class="font-bold text-white text-sm">Maintain</span>
                <span class="text-[10px] text-gray-500">Baseline</span>
            </button>

            <!-- Bulk -->
            <button onclick="selectFitnessGoal('bulk')" id="goal-bulk"
                class="goal-card p-4 rounded-2xl border-2 border-transparent bg-white/5 hover:bg-white/10 transition-all duration-300 flex flex-col items-center space-y-2 tap-effect">
                <div class="goal-icon w-12 h-12 rounded-full bg-orange-500/20 flex items-center justify-center text-2xl transition-all duration-300">
                    <svg class="w-6 h-6 text-orange-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12l7 7 7-7"/>
                    </svg>
                </div>
                <span class="font-bold text-white text-sm">Bulk</span>
                <span class="text-[10px] text-gray-500">+400 kcal</span>
            </button>
        </div>

        <!-- Current target display -->
        <div class="bg-white/5 rounded-xl p-3 flex items-center justify-between">
            <span class="text-sm text-gray-400">Daily Target</span>
            <span class="font-bold text-white" id="current-calorie-target">2000 kcal</span>
        </div>
    </div>

    <!-- Account Actions -->
    <div class="space-y-3">
        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider ml-1">Settings</h3>

        <button onclick="showToast('Payment settings feature coming soon!')"
            class="w-full bg-white/5 p-4 rounded-2xl flex items-center justify-between tap-effect group hover:bg-white/10 transition">
            <div class="flex items-center space-x-4">
                <div class="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400">
                    üí≥
                </div>
                <div class="text-left">
                    <p class="font-bold text-white group-hover:text-blue-400 transition">Payment Settings</p>
                    <p class="text-xs text-gray-400">Manage cards & billing</p>
                </div>
            </div>
            <span class="text-gray-500">‚Üí</span>
        </button>

        <a href="{{ 'client_account.html' if static_build else '/?gym_id=' + gym_id + '&role=client&mode=account_settings' }}"
            class="w-full bg-white/5 p-4 rounded-2xl flex items-center justify-between tap-effect group hover:bg-white/10 transition">
            <div class="flex items-center space-x-4">
                <div class="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-400">
                    ‚öôÔ∏è
                </div>
                <div class="text-left">
                    <p class="font-bold text-white group-hover:text-purple-400 transition">Account Management</p>
                    <p class="text-xs text-gray-400">Profile details & preferences</p>
                </div>
            </div>
            <span class="text-gray-500">‚Üí</span>
        </a>

        <button onclick="logout()"
            class="w-full bg-red-500/10 p-4 rounded-2xl flex items-center justify-between tap-effect group hover:bg-red-500/20 transition mt-6">
            <div class="flex items-center space-x-4">
                <div class="w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center text-red-500">
                    üö™
                </div>
                <div class="text-left">
                    <p class="font-bold text-red-500 transition">Log Out</p>
                    <p class="text-xs text-red-500/60">Sign out of your account</p>
                </div>
            </div>
        </button>
    </div>
</div>

<script>
// --- PROFILE PICTURE FUNCTIONS (Client Dashboard) ---
async function loadProfilePicture() {
    try {
        const res = await fetch('/api/profile/picture');
        if (res.ok) {
            const data = await res.json();
            if (data.profile_picture) {
                updateAllAvatars(data.profile_picture);
            } else {
                // Use dicebear with username as seed
                const username = data.username || 'User';
                const defaultAvatar = `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(username)}`;
                updateAllAvatars(defaultAvatar);
            }
        }
    } catch (e) {
        console.error('Error loading profile picture:', e);
    }
}

function updateAllAvatars(url) {
    const avatarIds = ['profile-avatar-img', 'header-profile-img'];
    avatarIds.forEach(id => {
        const img = document.getElementById(id);
        if (img) {
            img.src = url;
        }
    });
}

async function uploadProfilePicture(input) {
    const file = input.files?.[0];
    if (!file) return;

    // Validate file type
    const validTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
    if (!validTypes.includes(file.type)) {
        showToast('Please select a valid image file (JPG, PNG, WEBP, GIF)', 'error');
        return;
    }

    // Validate file size (5MB max)
    if (file.size > 5 * 1024 * 1024) {
        showToast('Image too large. Maximum size is 5MB', 'error');
        return;
    }

    // Show loading state
    const container = document.getElementById('profile-avatar-container');
    if (container) {
        container.style.opacity = '0.5';
    }

    try {
        const formData = new FormData();
        formData.append('file', file);

        const res = await fetch('/api/profile/picture', {
            method: 'POST',
            body: formData
        });

        const data = await res.json();

        if (res.ok) {
            updateAllAvatars(data.profile_picture);
            showToast('Profile picture updated!', 'success');
        } else {
            showToast(data.detail || 'Failed to upload image', 'error');
        }
    } catch (e) {
        console.error('Error uploading profile picture:', e);
        showToast('Failed to upload image', 'error');
    } finally {
        if (container) {
            container.style.opacity = '1';
        }
        input.value = '';
    }
}

// Load profile picture on page load
document.addEventListener('DOMContentLoaded', () => {
    loadProfilePicture();
    loadFitnessGoal();
});

// --- FITNESS GOAL FUNCTIONS ---
let currentFitnessGoal = 'maintain';
let baseCalories = 2000;
let hasTrainer = false;

async function loadFitnessGoal() {
    try {
        const res = await fetch('/api/client/fitness-goal', { credentials: 'include' });
        if (res.ok) {
            const data = await res.json();
            currentFitnessGoal = data.fitness_goal || 'maintain';
            baseCalories = data.base_calories || 2000;
            hasTrainer = data.has_trainer || false;
            updateGoalUI(currentFitnessGoal, data.calories_target, hasTrainer);
        }
    } catch (e) {
        console.error('Error loading fitness goal:', e);
    }
}

function updateGoalUI(goal, targetCalories, trainerManaged = false) {
    const goalColors = {
        cut: { border: '#3b82f6', bg: 'rgba(59, 130, 246, 0.25)', glow: '0 0 20px rgba(59, 130, 246, 0.5)' },
        maintain: { border: '#22c55e', bg: 'rgba(34, 197, 94, 0.25)', glow: '0 0 20px rgba(34, 197, 94, 0.5)' },
        bulk: { border: '#f97316', bg: 'rgba(249, 115, 22, 0.25)', glow: '0 0 20px rgba(249, 115, 22, 0.5)' }
    };

    // Show/hide trainer managed notice
    const trainerNotice = document.getElementById('trainer-managed-notice');
    const goalSubtitle = document.getElementById('goal-subtitle');
    if (trainerNotice) {
        trainerNotice.classList.toggle('hidden', !trainerManaged);
    }
    if (goalSubtitle) {
        goalSubtitle.textContent = trainerManaged ? 'Set by your trainer' : 'Adjusts your daily calorie target';
    }

    // Remove active state and checkmarks from all cards
    document.querySelectorAll('.goal-card').forEach(card => {
        card.style.border = '2px solid transparent';
        card.style.background = 'rgba(255,255,255,0.05)';
        card.style.boxShadow = 'none';
        card.style.transform = 'scale(1)';
        card.style.opacity = '1';
        card.style.pointerEvents = 'auto';
        // Remove any existing checkmark
        const existingCheck = card.querySelector('.goal-checkmark');
        if (existingCheck) existingCheck.remove();
    });

    // Add active state to selected card with prominent inline styling
    const activeCard = document.getElementById(`goal-${goal}`);
    const colors = goalColors[goal] || goalColors.maintain;
    if (activeCard) {
        activeCard.style.border = `3px solid ${colors.border}`;
        activeCard.style.background = colors.bg;
        activeCard.style.boxShadow = colors.glow;
        activeCard.style.transform = 'scale(1.05)';

        // Add a checkmark badge
        const checkmark = document.createElement('div');
        checkmark.className = 'goal-checkmark';
        checkmark.innerHTML = `<svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>`;
        checkmark.style.cssText = `position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; background: ${colors.border}; border-radius: 50%; display: flex; align-items: center; justify-content: center;`;
        activeCard.style.position = 'relative';
        activeCard.appendChild(checkmark);
    }

    // If trainer managed, disable other buttons (make them faded and unclickable)
    if (trainerManaged) {
        document.querySelectorAll('.goal-card').forEach(card => {
            if (card.id !== `goal-${goal}`) {
                card.style.opacity = '0.4';
                card.style.pointerEvents = 'none';
            }
        });
    }

    // Update calorie display
    const calorieDisplay = document.getElementById('current-calorie-target');
    if (calorieDisplay && targetCalories) {
        calorieDisplay.textContent = `${targetCalories} kcal`;
    }
}

async function selectFitnessGoal(goal) {
    if (goal === currentFitnessGoal) return;
    if (hasTrainer) {
        showToast('Your trainer manages your nutrition plan', 'error');
        return;
    }

    try {
        const res = await fetch('/api/client/fitness-goal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ fitness_goal: goal })
        });

        if (res.ok) {
            const data = await res.json();
            currentFitnessGoal = goal;
            updateGoalUI(goal, data.new_calories_target, hasTrainer);
            showToast(`Goal set to ${goal.charAt(0).toUpperCase() + goal.slice(1)}! Target: ${data.new_calories_target} kcal`, 'success');
        } else {
            const err = await res.json();
            showToast(err.detail || 'Failed to update goal', 'error');
        }
    } catch (e) {
        console.error('Error updating fitness goal:', e);
        showToast('Failed to update goal', 'error');
    }
}
</script>

{% else %}
<div class="p-6 pt-10 flex justify-between items-center bg-gradient-to-b from-black/80 to-transparent z-10">
    <div class="flex items-center space-x-3">
        <a href="{{ 'client.html' if static_build else '/?gym_id=' + gym_id + '&role=client&mode=client_dashboard' }}"
            class="w-10 h-10 rounded-full bg-gradient-to-tr from-gray-700 to-gray-600 border border-white/10 overflow-hidden tap-effect">
            <img id="header-profile-img" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Alex" class="w-full h-full object-cover">
        </a>
        <div>
            <p class="text-xs text-gray-400 uppercase tracking-wider">Welcome back</p>
            <h2 class="font-bold text-lg" id="client-welcome-name">Loading...</h2>
        </div>
    </div>
    <div class="flex space-x-2">
        <!-- Booking Icon -->
        <div onclick="openBookingChoiceForMyTrainer()" class="relative w-10 h-10 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center tap-effect cursor-pointer" title="Book Session">
            üìÖ
        </div>
        <!-- Messages Icon with Badge -->
        <div onclick="openClientChatModal()" class="relative w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center tap-effect cursor-pointer">
            üí¨
            <span id="unread-messages-badge" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center hidden">0</span>
        </div>
        <div data-action="showModal" data-target="notification-modal"
            class="w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center tap-effect">
            üîî
        </div>
    </div>
</div>
<div class="flex-1 p-4 pt-0 space-y-4">
    <!-- Streak Card with Gems -->
    <a href="{{ 'client_calendar.html' if static_build else '/?gym_id=' + gym_id + '&role=client&mode=calendar' }}"
        class="block slide-up">
        {% call card(classes="p-5 flex justify-between items-center relative overflow-hidden tap-effect") %}
        <div class="absolute top-0 right-0 w-32 h-32 bg-orange-500/30 blur-3xl rounded-full -mr-10 -mt-10 animate-pulse"></div>
        <div class="absolute bottom-0 left-0 w-24 h-24 bg-red-500/20 blur-2xl rounded-full -ml-8 -mb-8"></div>
        <div class="flex items-center gap-6 relative z-10">
            <div class="flex items-center gap-3">
                <div class="text-3xl animate-bounce" style="animation-duration: 2s;">üî•</div>
                <div>
                    <h1 class="text-4xl font-black bg-gradient-to-r from-orange-400 via-red-400 to-orange-500 bg-clip-text text-transparent" id="client-streak">0</h1>
                    <p class="text-orange-400 font-bold uppercase tracking-wider text-[10px]">Week Streak</p>
                </div>
            </div>
            <div class="h-10 w-px bg-white/10"></div>
            <div>
                <p class="text-gray-400 text-[10px] mb-0.5">Next Goal</p>
                <p class="font-bold text-lg" id="client-next-goal">4 Weeks</p>
            </div>
        </div>
        <!-- Gems Badge -->
        <div data-action="showModal" data-target="shop-modal"
            class="flex items-center gap-2 bg-gradient-to-r from-yellow-500/20 to-amber-500/20 border border-yellow-500/30 px-4 py-2 rounded-full tap-effect hover:from-yellow-500/30 hover:to-amber-500/30 transition shadow-lg shadow-yellow-500/10 relative z-10"
            onclick="event.preventDefault(); event.stopPropagation();">
            <span class="text-lg">üî∂</span>
            <span class="text-sm font-bold bg-gradient-to-r from-yellow-300 to-amber-400 bg-clip-text text-transparent" id="gem-count">0</span>
        </div>
        {% endcall %}
    </a>

    <!-- Today's Plan -->
    <div class="slide-up" style="animation-delay: 0.1s;">
        {% call card(classes="p-5 relative overflow-hidden group tap-effect") %}
        <div class="absolute inset-0 bg-gradient-to-br from-red-500/20 to-orange-500/10 group-hover:from-red-500/30 group-hover:to-orange-500/20 transition-all duration-300"></div>
        <div class="relative z-10">
            <div class="flex justify-between items-start mb-3">
                <span class="bg-gradient-to-r from-red-500/30 to-orange-500/30 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider">Today's Plan</span>
                <span class="text-xl">üí™</span>
            </div>
            <h3 class="text-2xl font-black italic uppercase mb-1" id="workout-title">...</h3>
            <p class="text-sm text-gray-300 mb-4"><span id="workout-duration"></span> ‚Ä¢ <span id="workout-difficulty"></span></p>
            <div class="flex gap-2">
                <a href="{{ 'workout.html' if static_build else '/?gym_id=' + gym_id + '&role=client&mode=workout' }}"
                    class="flex-1 py-3 bg-gradient-to-r from-red-500 to-orange-500 text-white text-center font-bold rounded-xl hover:from-red-400 hover:to-orange-400 transition-all shadow-lg shadow-red-500/25">START SESSION</a>
                <button onclick="openCoopModal()"
                    class="px-4 py-3 bg-purple-500/20 text-purple-300 font-bold rounded-xl border border-purple-500/30 hover:bg-purple-500/30 transition-all tap-effect flex items-center gap-2"
                    title="Start a shared workout with a friend">
                    <span>üë•</span>
                    <span class="text-xs">CO-OP</span>
                </button>
            </div>
        </div>
        {% endcall %}
    </div>

    <!-- Diet Tracker -->
    <a href="{{ 'client_progress.html' if static_build else '/?gym_id=' + gym_id + '&role=client&mode=progress' }}"
        class="block slide-up" style="animation-delay: 0.15s;">
        {% call card(classes="p-4 flex items-center justify-between tap-effect hover:bg-white/5 transition") %}
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-xl bg-green-500/20 flex items-center justify-center">
                <span class="text-2xl">ü•ó</span>
            </div>
            <div>
                <p class="font-bold text-white">Diet Tracker</p>
                <p class="text-xs text-gray-400">Track meals & macros</p>
            </div>
        </div>
        <span class="text-white/40 text-lg">‚Üí</span>
        {% endcall %}
    </a>

    <!-- Trainer & Appointments Section -->
    <div class="slide-up" style="animation-delay: 0.15s;">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider ml-1">My Trainer</h3>
            <button onclick="openAllTrainersModal()" class="text-xs text-orange-400 hover:text-orange-300 transition tap-effect">
                See others ‚Üí
            </button>
        </div>

        <div id="trainer-section" class="space-y-3">
            <!-- Trainer Card -->
            <div onclick="openTrainerProfileModal()" class="glass-card p-4 flex items-center justify-between cursor-pointer hover:bg-white/5 transition tap-effect">
                <div class="flex items-center space-x-3">
                    <div id="trainer-avatar" class="w-12 h-12 rounded-full bg-gradient-to-tr from-red-500 to-orange-500 flex items-center justify-center overflow-hidden">
                        <span class="text-xl">üë§</span>
                    </div>
                    <div>
                        <p class="font-bold text-white" id="trainer-name">Loading...</p>
                        <p class="text-xs text-gray-400">Personal Trainer</p>
                    </div>
                </div>
                <div class="flex gap-2" onclick="event.stopPropagation()">
                    <button onclick="openClientChatModal()" class="bg-white/10 px-3 py-2 rounded-lg text-sm font-bold hover:bg-white/20 transition tap-effect" title="Message Trainer">
                        üí¨
                    </button>
                    <button onclick="openBookingChoiceForMyTrainer()" class="bg-orange-500 px-4 py-2 rounded-lg text-sm font-bold hover:bg-orange-400 transition tap-effect">
                        Book Session
                    </button>
                </div>
            </div>

            <!-- Upcoming Appointments -->
            <div id="appointments-list" class="space-y-2">
                <!-- Appointments will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Gym Members Section -->
    <div class="slide-up" style="animation-delay: 0.18s;">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider ml-1">Gym Members</h3>
            <button onclick="openGymMembersModal()" class="text-xs text-orange-400 hover:text-orange-300 transition tap-effect">
                See all ‚Üí
            </button>
        </div>
        <div class="glass-card p-4">
            <div id="gym-members-preview" class="flex items-center space-x-2">
                <div class="flex -space-x-2" id="members-avatars">
                    <!-- Member avatars will be loaded here -->
                </div>
                <span id="members-count" class="text-sm text-gray-400 ml-2">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Friends Section -->
    <div class="slide-up" style="animation-delay: 0.19s;">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider ml-1">Friends</h3>
            <button onclick="openFriendsModal()" class="text-xs text-orange-400 hover:text-orange-300 transition tap-effect">
                Manage ‚Üí
            </button>
        </div>
        <div class="glass-card p-4">
            <div id="friends-preview" class="flex items-center space-x-2">
                <div class="flex -space-x-2" id="friends-avatars">
                    <!-- Friend avatars will be loaded here -->
                </div>
                <span id="friends-count" class="text-sm text-gray-400 ml-2">Loading...</span>
            </div>
            <div id="friend-requests-badge" class="hidden mt-2 text-xs text-orange-400">
                <span id="pending-requests-count">0</span> pending request(s)
            </div>
        </div>
    </div>

    <div class="slide-up" style="animation-delay: 0.2s;">
        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3 ml-1">Daily Quests</h3>
        <div class="space-y-3" id="quest-list"></div>
    </div>
</div>

<!-- Trainer Selection Modal -->
<div id="trainer-selection-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Select Your Trainer</h3>
            <button onclick="closeTrainerSelectionModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>
        <p class="text-gray-400 text-sm mb-4">Choose a trainer from your gym to guide your fitness journey</p>
        <div id="home-trainer-list" class="space-y-3">
            <!-- Trainers will be loaded here -->
        </div>
    </div>
</div>

<!-- Trainer Profile Modal -->
<div id="trainer-profile-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeTrainerProfileModal()">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full max-h-[85vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Trainer Profile</h3>
            <button onclick="closeTrainerProfileModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>

        <!-- Profile Header -->
        <div class="text-center mb-6">
            <div id="profile-trainer-avatar" class="w-24 h-24 rounded-full bg-gradient-to-tr from-red-500 to-orange-500 flex items-center justify-center mx-auto mb-4 overflow-hidden">
                <span class="text-4xl">üë§</span>
            </div>
            <h2 id="profile-trainer-name" class="text-2xl font-bold text-white">Trainer Name</h2>
            <p class="text-orange-400 text-sm font-medium">Personal Trainer</p>
            <div id="profile-trainer-badge" class="mt-2 hidden">
                <span class="bg-green-500/20 text-green-400 text-xs px-3 py-1 rounded-full border border-green-500/30">
                    ‚úì Your Trainer
                </span>
            </div>
        </div>

        <!-- Bio Section -->
        <div id="profile-trainer-bio-section" class="mb-4 hidden">
            <p id="profile-trainer-bio" class="text-sm text-gray-300 text-center italic"></p>
        </div>

        <!-- Specialties Section -->
        <div id="profile-trainer-specialties" class="flex flex-wrap justify-center gap-2 mb-6 hidden">
            <!-- Specialty tags will be populated by JS -->
        </div>

        <!-- Trainer Stats -->
        <div class="grid grid-cols-2 gap-3 mb-6">
            <div class="glass-card p-3 rounded-xl text-center">
                <p id="profile-trainer-clients" class="text-2xl font-bold text-white">-</p>
                <p class="text-xs text-gray-400">Active Clients</p>
            </div>
            <div class="glass-card p-3 rounded-xl text-center">
                <p id="profile-trainer-availability" class="text-lg font-bold text-white">-</p>
                <p class="text-xs text-gray-400">Availability</p>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="space-y-3">
            <button id="profile-message-btn" onclick="messageTrainerFromProfile()" class="w-full bg-white/10 py-3 rounded-xl text-sm font-bold hover:bg-white/20 transition tap-effect flex items-center justify-center gap-2">
                üí¨ Send Message
            </button>
            <button id="profile-book-btn" onclick="bookWithTrainerFromProfile()" class="w-full bg-orange-500 py-3 rounded-xl text-sm font-bold hover:bg-orange-400 transition tap-effect flex items-center justify-center gap-2">
                üìÖ Book Session
            </button>
            <button id="profile-select-btn" onclick="selectTrainerFromProfile()" class="w-full bg-white/5 border border-white/20 py-3 rounded-xl text-sm font-bold hover:bg-white/10 transition tap-effect hidden">
                ‚úì Select as My Trainer
            </button>
        </div>
    </div>
</div>

<!-- Booking Choice Modal (1-on-1 vs Course) -->
<div id="booking-choice-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeBookingChoiceModal()">
    <div class="glass-card p-6 rounded-2xl max-w-sm w-full">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Book with <span id="booking-choice-trainer-name">Trainer</span></h3>
            <button onclick="closeBookingChoiceModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>
        <p class="text-gray-400 text-sm mb-6">What type of session would you like to book?</p>

        <div class="space-y-3">
            <!-- 1-on-1 Session Option -->
            <button onclick="selectBookingType('personal')" class="w-full bg-gradient-to-r from-orange-500 to-red-500 p-4 rounded-xl text-left hover:scale-[1.02] transition tap-effect">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center text-2xl">
                        üë§
                    </div>
                    <div>
                        <h4 class="font-bold text-white">1-on-1 Session</h4>
                        <p class="text-sm text-white/70">Personal training tailored to you</p>
                    </div>
                </div>
            </button>

            <!-- Group Course Option -->
            <button onclick="selectBookingType('course')" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 p-4 rounded-xl text-left hover:scale-[1.02] transition tap-effect">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center text-2xl">
                        üë•
                    </div>
                    <div>
                        <h4 class="font-bold text-white">Group Course</h4>
                        <p class="text-sm text-white/70">Join a scheduled fitness class</p>
                    </div>
                </div>
            </button>
        </div>
    </div>
</div>

<!-- Gym Courses Modal -->
<div id="gym-courses-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeGymCoursesModal()">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full max-h-[85vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Group Classes</h3>
            <button onclick="closeGymCoursesModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>
        <p class="text-gray-400 text-sm mb-4">Browse all available courses at your gym</p>

        <div id="gym-courses-list" class="space-y-3">
            <!-- Loading state -->
            <div class="text-center py-8 text-gray-400">
                <div class="animate-pulse">Loading courses...</div>
            </div>
        </div>
    </div>
</div>

<!-- Course Detail Modal (for clients) -->
<div id="client-course-detail-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeClientCourseDetail()">
    <div class="bg-[#1a1a1a] w-full max-w-lg max-h-[90vh] rounded-2xl border border-white/10 overflow-hidden flex flex-col">
        <!-- Trailer Video -->
        <div class="relative w-full aspect-video bg-black flex-shrink-0">
            <iframe id="client-course-trailer" class="w-full h-full hidden" frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen></iframe>
            <!-- Thumbnail with play button (shown before video plays) -->
            <div id="client-course-thumbnail" class="absolute inset-0 cursor-pointer hidden" onclick="playClientCourseVideo()">
                <img id="client-course-thumb-img" class="w-full h-full object-cover" src="" alt="Video thumbnail">
                <div class="absolute inset-0 flex items-center justify-center bg-black/30">
                    <div class="w-12 h-12 rounded-full bg-white/90 flex items-center justify-center shadow-lg hover:scale-110 transition">
                        <span class="text-lg ml-0.5">‚ñ∂</span>
                    </div>
                </div>
            </div>
            <div id="client-course-no-trailer" class="absolute inset-0 bg-gradient-to-br from-purple-900/50 to-pink-900/30 flex items-center justify-center hidden">
                <span class="text-6xl opacity-30">üé¨</span>
            </div>
            <!-- Close button -->
            <button onclick="closeClientCourseDetail()"
                class="absolute top-3 right-3 w-10 h-10 bg-black/70 hover:bg-black rounded-full text-white text-xl flex items-center justify-center transition z-10">&times;</button>
            <!-- Trainer overlay -->
            <div id="client-course-trainer-overlay" class="absolute top-3 left-3 flex items-center gap-2 bg-black/70 backdrop-blur-sm rounded-xl pr-3 pl-1.5 py-1.5">
                <div id="client-course-trainer-avatar" class="w-9 h-9 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center border-2 border-white/30">
                    <span id="client-course-trainer-initial" class="text-white font-bold text-sm">T</span>
                </div>
                <div class="flex flex-col">
                    <span id="client-course-trainer-name" class="text-white font-medium text-xs leading-tight">Trainer</span>
                    <span class="text-purple-300/80 text-[10px] leading-tight">Instructor</span>
                </div>
            </div>
        </div>

        <!-- Course Info -->
        <div class="flex-1 overflow-y-auto p-5">
            <h2 id="client-course-title" class="text-2xl font-bold text-white mb-2">Course Title</h2>
            <div class="flex flex-wrap gap-3 text-sm text-gray-400 mb-4">
                <span id="client-course-schedule">üìÖ Mon, Wed @ 9:00 AM</span>
                <span id="client-course-duration">‚è±Ô∏è 60 min</span>
            </div>
            <p id="client-course-description" class="text-gray-300 text-sm mb-4"></p>

            <!-- Upcoming Sessions -->
            <div class="bg-white/5 rounded-xl p-4 mb-4">
                <h4 class="text-sm font-bold text-white mb-2">Upcoming Sessions</h4>
                <p id="client-course-sessions" class="text-sm text-gray-400">2 sessions scheduled</p>
            </div>
        </div>

        <!-- Book Button -->
        <div class="p-4 border-t border-white/10 flex-shrink-0">
            <button onclick="bookCourseSession()" id="client-course-book-btn"
                class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-4 rounded-xl hover:opacity-90 transition shadow-lg">
                Book This Class
            </button>
        </div>
    </div>
</div>

<!-- All Trainers Modal -->
<div id="all-trainers-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeAllTrainersModal()">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full max-h-[85vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Gym Trainers</h3>
            <button onclick="closeAllTrainersModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>
        <p class="text-gray-400 text-sm mb-4">Browse all trainers available at your gym</p>

        <div id="all-trainers-list" class="space-y-3">
            <!-- Loading state -->
            <div class="text-center py-8 text-gray-400">
                <div class="animate-pulse">Loading trainers...</div>
            </div>
        </div>
    </div>
</div>

<!-- Gym Members Modal -->
<div id="gym-members-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeGymMembersModal()">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full max-h-[85vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Gym Members</h3>
            <button onclick="closeGymMembersModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>
        <p class="text-gray-400 text-sm mb-4">Connect with other members at your gym</p>

        <div id="gym-members-list" class="space-y-3">
            <!-- Loading state -->
            <div class="text-center py-8 text-gray-400">
                <div class="animate-pulse">Loading members...</div>
            </div>
        </div>
    </div>
</div>

<!-- Member Profile Modal -->
<div id="member-profile-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeMemberProfileModal()">
    <div class="glass-card p-5 rounded-2xl max-w-sm w-full">
        <!-- Header -->
        <div class="flex justify-between items-start mb-4">
            <div class="flex items-center gap-3">
                <div id="member-profile-avatar" class="w-14 h-14 rounded-full bg-orange-500/20 flex items-center justify-center overflow-hidden border-2 border-orange-500/30">
                    <span class="text-2xl">üë§</span>
                </div>
                <div>
                    <h3 id="member-profile-name" class="text-lg font-bold text-white">Username</h3>
                    <p id="member-profile-bio" class="text-gray-400 text-xs max-w-[180px] truncate"></p>
                </div>
            </div>
            <button onclick="closeMemberProfileModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>

        <!-- Stats Row -->
        <div class="grid grid-cols-3 gap-2 mb-4">
            <div class="bg-white/5 rounded-xl p-3 text-center border border-white/5">
                <div class="flex items-center justify-center gap-1">
                    <span class="text-sm">üî•</span>
                    <p id="member-profile-streak" class="text-xl font-bold text-orange-400">0</p>
                </div>
                <p class="text-[10px] text-gray-500 uppercase font-medium mt-1">Streak</p>
            </div>
            <div class="bg-white/5 rounded-xl p-3 text-center border border-white/5">
                <div class="flex items-center justify-center gap-1">
                    <span class="text-sm">üî∂</span>
                    <p id="member-profile-gems" class="text-xl font-bold text-orange-400">0</p>
                </div>
                <p class="text-[10px] text-gray-500 uppercase font-medium mt-1">Gems</p>
            </div>
            <div class="bg-white/5 rounded-xl p-3 text-center border border-white/5">
                <div class="flex items-center justify-center gap-0.5">
                    <p id="member-profile-health" class="text-xl font-bold text-green-400">0</p>
                    <span class="text-xs text-green-400 font-bold">%</span>
                </div>
                <p class="text-[10px] text-gray-500 uppercase font-medium mt-1">Diet</p>
            </div>
        </div>

        <!-- Weekly Activity -->
        <div class="bg-white/5 rounded-xl p-4 mb-4 border border-white/5">
            <div class="flex justify-between items-center mb-3">
                <span class="text-xs text-gray-400 uppercase tracking-wider font-medium">Weekly Activity</span>
                <span class="text-[10px] text-orange-400">Last 7 days</span>
            </div>
            <!-- Activity Dots -->
            <div id="member-progress-chart" class="flex items-center justify-between">
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">M</span>
                    </div>
                </div>
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">T</span>
                    </div>
                </div>
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">W</span>
                    </div>
                </div>
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">T</span>
                    </div>
                </div>
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">F</span>
                    </div>
                </div>
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">S</span>
                    </div>
                </div>
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">S</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Friend-only Progress Section (hidden by default) -->
        <div id="friend-progress-section" class="hidden mb-4">
            <div class="bg-gradient-to-br from-purple-500/10 to-pink-500/10 rounded-xl p-4 border border-purple-500/20">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-purple-400">üë•</span>
                    <span class="text-xs text-purple-300 uppercase tracking-wider font-medium">Friend Progress</span>
                </div>
                <!-- Weight Trend -->
                <div class="mb-3">
                    <p class="text-[10px] text-gray-400 mb-1">Weight Trend (30 days)</p>
                    <div id="friend-weight-chart" class="h-16 flex items-end gap-1">
                        <!-- Bars will be rendered here -->
                    </div>
                </div>
                <!-- Health Score History -->
                <div>
                    <p class="text-[10px] text-gray-400 mb-1">Health Score (7 days)</p>
                    <div id="friend-health-bars" class="flex items-end justify-between h-12 gap-1">
                        <!-- Bars will be rendered here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Friend Action Button -->
        <div id="friend-action-container" class="mb-3">
            <button id="friend-action-btn" onclick="handleFriendAction()"
                class="w-full py-2.5 bg-purple-500/20 text-purple-300 font-bold rounded-xl border border-purple-500/30 hover:bg-purple-500/30 transition tap-effect">
                <span id="friend-action-text">Add Friend</span>
            </button>
        </div>

        <!-- Message Button -->
        <button id="member-profile-message-btn" onclick="messageFromProfile()"
            class="w-full py-3 bg-orange-500 text-white font-bold rounded-xl hover:bg-orange-400 transition tap-effect">
            Message
        </button>
    </div>
</div>

<!-- Chat Request Modal -->
<div id="chat-request-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeChatRequestModal()">
    <div class="glass-card p-6 rounded-2xl max-w-sm w-full">
        <div class="text-center mb-4">
            <div id="chat-request-avatar" class="w-20 h-20 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center mx-auto mb-3 overflow-hidden">
                <span class="text-3xl">üë§</span>
            </div>
            <h3 id="chat-request-name" class="text-xl font-bold">Username</h3>
            <p class="text-gray-400 text-sm mt-1">This user has a private profile</p>
        </div>

        <div class="space-y-3">
            <textarea id="chat-request-message" rows="3"
                class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white placeholder-gray-500 resize-none outline-none focus:border-blue-500"
                placeholder="Write a short intro message (optional)..."></textarea>

            <button onclick="sendChatRequest()" class="w-full py-3 bg-blue-500 text-white font-bold rounded-xl hover:bg-blue-400 transition tap-effect">
                Send Chat Request
            </button>
            <button onclick="closeChatRequestModal()" class="w-full py-3 bg-white/10 text-gray-300 font-bold rounded-xl hover:bg-white/20 transition tap-effect">
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- Friends Modal -->
<div id="friends-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeFriendsModal()">
    <div class="glass-card p-5 rounded-2xl max-w-md w-full max-h-[85vh] overflow-hidden flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Friends</h3>
            <button onclick="closeFriendsModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>

        <!-- Tabs -->
        <div class="flex mb-4 bg-white/5 rounded-lg p-1">
            <button onclick="showFriendsTab('friends')" id="tab-friends"
                class="flex-1 py-2 px-4 rounded-lg text-sm font-medium bg-purple-500 text-white transition">
                Friends
            </button>
            <button onclick="showFriendsTab('requests')" id="tab-requests"
                class="flex-1 py-2 px-4 rounded-lg text-sm font-medium text-gray-400 transition">
                Requests <span id="requests-badge" class="hidden bg-red-500 text-white text-xs rounded-full px-1.5 ml-1">0</span>
            </button>
        </div>

        <!-- Friends List Tab -->
        <div id="friends-list-container" class="flex-1 overflow-y-auto">
            <div id="friends-list" class="space-y-3">
                <!-- Friend cards loaded here -->
            </div>
            <div id="no-friends-message" class="hidden text-center py-8 text-gray-500">
                <p class="text-4xl mb-2">üë•</p>
                <p>No friends yet</p>
                <p class="text-sm">Add gym members as friends to see their progress!</p>
            </div>
        </div>

        <!-- Requests Tab (hidden by default) -->
        <div id="requests-container" class="hidden flex-1 overflow-y-auto">
            <div class="mb-4">
                <h4 class="text-sm text-gray-400 mb-2 flex items-center gap-2">
                    <span>üì•</span> Incoming
                </h4>
                <div id="incoming-requests" class="space-y-3">
                    <!-- Incoming request cards -->
                </div>
                <div id="no-incoming-requests" class="hidden text-center py-4 text-gray-500 text-sm">
                    No pending requests
                </div>
            </div>

            <div>
                <h4 class="text-sm text-gray-400 mb-2 flex items-center gap-2">
                    <span>üì§</span> Sent
                </h4>
                <div id="outgoing-requests" class="space-y-3">
                    <!-- Outgoing request cards -->
                </div>
                <div id="no-outgoing-requests" class="hidden text-center py-4 text-gray-500 text-sm">
                    No sent requests
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Friend Request Modal -->
<div id="friend-request-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeFriendRequestModal()">
    <div class="glass-card p-6 rounded-2xl max-w-sm w-full">
        <div class="text-center mb-4">
            <div id="friend-request-avatar" class="w-20 h-20 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center mx-auto mb-3 overflow-hidden">
                <span class="text-3xl">üë§</span>
            </div>
            <h3 id="friend-request-name" class="text-xl font-bold">Username</h3>
            <p class="text-gray-400 text-sm mt-1">Send a friend request</p>
        </div>

        <div class="space-y-3">
            <textarea id="friend-request-message" rows="2"
                class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white placeholder-gray-500 resize-none outline-none focus:border-purple-500"
                placeholder="Add a message (optional)..."></textarea>

            <button onclick="submitFriendRequest()" class="w-full py-3 bg-purple-500 text-white font-bold rounded-xl hover:bg-purple-400 transition tap-effect">
                Send Friend Request
            </button>
            <button onclick="closeFriendRequestModal()" class="w-full py-2 bg-white/10 text-gray-300 font-medium rounded-xl hover:bg-white/20 transition tap-effect">
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- CO-OP Workout Modal -->
<div id="coop-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeCoopModal()">
    <div class="glass-card p-5 rounded-2xl max-w-md w-full max-h-[85vh] overflow-hidden flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-purple-500/20 flex items-center justify-center">
                    <span class="text-xl">üë•</span>
                </div>
                <div>
                    <h3 class="text-xl font-bold">CO-OP Workout</h3>
                    <p class="text-xs text-gray-400">Choose a friend to workout with</p>
                </div>
            </div>
            <button onclick="closeCoopModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>

        <!-- Info Banner -->
        <div class="bg-purple-500/10 border border-purple-500/20 rounded-xl p-3 mb-4">
            <p class="text-sm text-purple-300">
                <span class="font-bold">How it works:</span> Complete the workout together - it will be logged to both your schedules!
            </p>
        </div>

        <!-- Friends List for CO-OP -->
        <div id="coop-friends-list" class="flex-1 overflow-y-auto space-y-2">
            <!-- Friend cards loaded here -->
        </div>

        <div id="coop-no-friends" class="hidden text-center py-8 text-gray-500">
            <p class="text-4xl mb-2">üë•</p>
            <p>No friends yet</p>
            <p class="text-sm">Add gym members as friends to do CO-OP workouts!</p>
        </div>

        <div id="coop-loading" class="text-center py-8 text-gray-400">
            <p>Loading friends...</p>
        </div>
    </div>
</div>

<script>
let selectedTrainerId = null;
let selectedDate = null;
let selectedTime = null;

// Load trainer info and appointments on page load
async function loadTrainerAndAppointments() {
    try {
        // Get gym/trainer info from the dedicated endpoint
        const response = await fetch('/api/client/gym-info', {
            credentials: 'include'
        });

        if (!response.ok) {
            loadTrainerSelectionForHome();
            return;
        }

        const info = await response.json();

        if (info.has_trainer && info.trainer_id) {
            selectedTrainerId = info.trainer_id;
            const trainerName = info.trainer_name || 'Your Trainer';
            document.getElementById('trainer-name').textContent = trainerName;

            // Update trainer avatar with profile picture
            updateTrainerAvatar(info.trainer_profile_picture, trainerName);

            // Store trainer data for profile modal
            currentTrainerData = {
                id: info.trainer_id,
                name: trainerName,
                profile_picture: info.trainer_profile_picture,
                has_availability: true,
                bio: info.trainer_bio,
                specialties: info.trainer_specialties || []
            };

            // Load upcoming appointments
            loadAppointments();
        } else {
            // No trainer - show selection option if they have a gym
            loadTrainerSelectionForHome();
        }
    } catch (error) {
        console.error('Error loading trainer info:', error);
        loadTrainerSelectionForHome();
    }
}

async function loadAppointments() {
    try {
        const response = await fetch('/api/client/appointments', {
            credentials: 'include'
        });

        if (!response.ok) return;

        const allAppointments = await response.json();

        // Filter out canceled appointments
        const appointments = allAppointments.filter(appt =>
            appt.status !== 'canceled' && appt.status !== 'cancelled'
        );

        if (appointments.length === 0) {
            document.getElementById('appointments-list').innerHTML = `
                <div class="glass-card p-3 text-center text-sm text-gray-400">
                    No upcoming appointments
                </div>
            `;
            return;
        }

        document.getElementById('appointments-list').innerHTML = appointments.slice(0, 3).map(appt => `
            <div class="glass-card p-3">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-bold text-sm text-white">${new Date(appt.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</p>
                        <p class="text-xs text-gray-400">${appt.start_time} ‚Ä¢ ${appt.duration} min</p>
                        ${appt.notes ? `<p class="text-xs text-gray-500 mt-1">${appt.notes}</p>` : ''}
                    </div>
                    <div class="flex items-center gap-2">
                        ${appt.status === 'scheduled' ? `
                            <button onclick="cancelAppointment('${appt.id}')" class="text-xs text-orange-400 hover:text-orange-300 font-medium">Cancel</button>
                        ` : `
                            <span class="text-xs px-2 py-1 rounded bg-green-500/20 text-green-400">${appt.status}</span>
                        `}
                    </div>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading appointments:', error);
    }
}

async function openBookingModal() {
    if (!selectedTrainerId) {
        showToast('No trainer assigned', 'error');
        return;
    }

    // Set min date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('appointment-date').min = today;
    document.getElementById('appointment-date').value = '';

    // Reset session type selection
    const sessionTypeSelect = document.getElementById('appointment-session-type');
    if (sessionTypeSelect) {
        sessionTypeSelect.selectedIndex = 0;
    }

    // Load trainer's custom session types
    await loadTrainerSessionTypes();

    document.getElementById('booking-modal').classList.remove('hidden');
    document.getElementById('booking-step-1').classList.remove('hidden');
    document.getElementById('booking-step-2').classList.add('hidden');
    document.body.style.overflow = 'hidden';
}

// Category labels with emojis (lowercase keys)
const categoryLabels = {
    'bodybuilding': 'üí™ Bodybuilding',
    'crossfit': 'üèãÔ∏è Crossfit',
    'calisthenics': 'ü§∏ Calisthenics',
    'cardio': 'üèÉ Cardio',
    'hiit': '‚ö° HIIT',
    'yoga': 'üßò Yoga',
    'boxing': 'ü•ä Boxing',
    'rehabilitation': 'ü©π Rehabilitation'
};

async function loadTrainerSessionTypes() {
    const sessionTypeSelect = document.getElementById('appointment-session-type');
    if (!sessionTypeSelect) return;

    // Clear all options
    sessionTypeSelect.innerHTML = '<option value="" disabled selected>Loading...</option>';

    try {
        const response = await fetch(`/api/client/trainer/${selectedTrainerId}/session-types`, {
            credentials: 'include'
        });

        if (response.ok) {
            const specialties = await response.json();

            // Clear and add placeholder
            sessionTypeSelect.innerHTML = '<option value="" disabled selected>Choose session type...</option>';

            if (specialties && specialties.length > 0) {
                // Add trainer's specialties as options
                specialties.forEach(specialty => {
                    const option = document.createElement('option');
                    const key = specialty.toLowerCase();
                    option.value = key;
                    option.textContent = categoryLabels[key] || specialty;
                    sessionTypeSelect.appendChild(option);
                });
            } else {
                // Trainer hasn't set specialties - show message
                sessionTypeSelect.innerHTML = '<option value="" disabled selected>No categories available</option>';
            }
        } else {
            sessionTypeSelect.innerHTML = '<option value="" disabled selected>Choose session type...</option>';
        }
    } catch (error) {
        console.error('Error loading trainer specialties:', error);
        sessionTypeSelect.innerHTML = '<option value="" disabled selected>Error loading categories</option>';
    }
}

function closeBookingModal() {
    document.getElementById('booking-modal').classList.add('hidden');
    document.body.style.overflow = '';
    selectedDate = null;
    selectedTime = null;
}

function backToDateSelection() {
    document.getElementById('booking-step-1').classList.remove('hidden');
    document.getElementById('booking-step-2').classList.add('hidden');
}

async function loadAvailableSlots() {
    const dateInput = document.getElementById('appointment-date');
    selectedDate = dateInput.value;
    const checkBtn = document.getElementById('check-availability-btn');
    const noSlotsMsg = document.getElementById('no-slots-message');

    if (!selectedDate) {
        showToast('Please select a date', 'error');
        return;
    }

    // Hide previous no-slots message
    noSlotsMsg.classList.add('hidden');

    try {
        const response = await fetch(`/api/client/trainers/${selectedTrainerId}/available-slots?date=${selectedDate}`, {
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error('Failed to load available slots');
        }

        const slots = await response.json();

        if (slots.length === 0) {
            // Show the no-slots message
            noSlotsMsg.classList.remove('hidden');

            // Add wiggle animation to button
            checkBtn.style.animation = 'wiggle 0.5s ease-in-out';
            setTimeout(() => {
                checkBtn.style.animation = '';
            }, 500);

            return;
        }

        const slotsList = document.getElementById('time-slots-list');
        slotsList.innerHTML = slots.map(slot => `
            <button onclick="selectTimeSlot('${slot.start_time}', this)"
                class="time-slot-btn w-full bg-white/10 hover:bg-primary/30 border border-white/10 hover:border-primary px-4 py-3 rounded-lg text-sm font-bold transition tap-effect"
                data-time="${slot.start_time}">
                ${slot.start_time} - ${slot.end_time}
            </button>
        `).join('');

        document.getElementById('booking-step-1').classList.add('hidden');
        document.getElementById('booking-step-2').classList.remove('hidden');
    } catch (error) {
        console.error('Error loading slots:', error);
        showToast(error.message, 'error');
    }
}

function selectTimeSlot(time, clickedBtn) {
    selectedTime = time;
    // Reset all slots to default state
    document.querySelectorAll('.time-slot-btn').forEach(btn => {
        btn.classList.remove('bg-orange-500', 'border-orange-500', 'text-white');
        btn.classList.add('bg-white/10', 'border-white/10');
    });
    // Highlight selected slot with orange color
    if (clickedBtn) {
        clickedBtn.classList.remove('bg-white/10', 'border-white/10');
        clickedBtn.classList.add('bg-orange-500', 'border-orange-500', 'text-white');
    }
}

async function confirmBooking() {
    if (!selectedTime) {
        showToast('Please select a time slot', 'error');
        return;
    }

    const sessionTypeSelect = document.getElementById('appointment-session-type');
    const sessionType = sessionTypeSelect ? sessionTypeSelect.value : null;

    if (!sessionType) {
        showToast('Please select a session type', 'error');
        return;
    }

    const notes = document.getElementById('appointment-notes').value;

    try {
        const response = await fetch('/api/client/appointments', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                trainer_id: selectedTrainerId,
                date: selectedDate,
                start_time: selectedTime,
                duration: 60,
                session_type: sessionType,
                notes: notes
            })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to book appointment');
        }

        showToast('Appointment booked successfully! üéâ', 'success');
        closeBookingModal();
        loadAppointments();
    } catch (error) {
        console.error('Error booking appointment:', error);
        showToast(error.message, 'error');
    }
}

async function cancelAppointment(appointmentId) {
    if (!confirm('Are you sure you want to cancel this appointment?')) {
        return;
    }

    try {
        const response = await fetch(`/api/appointments/${appointmentId}/cancel`, {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                cancellation_reason: 'Canceled by client'
            })
        });

        if (!response.ok) {
            throw new Error('Failed to cancel appointment');
        }

        showToast('Appointment canceled', 'success');
        loadAppointments();
    } catch (error) {
        console.error('Error canceling appointment:', error);
        showToast(error.message, 'error');
    }
}

// --- GYM & TRAINER ASSIGNMENT ---

async function loadGymAndTrainerInfo() {
    console.log('[GYM INFO] Loading gym and trainer info...');

    try {
        const response = await fetch('/api/client/gym-info', {
            credentials: 'include'
        });

        console.log('[GYM INFO] Response status:', response.status);

        if (!response.ok) {
            console.error('[GYM INFO] Failed to load:', response.status, await response.text());
            // Show error state
            document.getElementById('current-gym-display').textContent = 'Error loading gym info';
            document.getElementById('current-trainer-display').textContent = 'Error loading trainer info';
            return;
        }

        const info = await response.json();
        console.log('[GYM INFO] Data received:', info);

        // Update gym display
        const gymDisplay = document.getElementById('current-gym-display');
        const joinGymSection = document.getElementById('join-gym-section');
        const leaveGymSection = document.getElementById('leave-gym-section');

        if (info.has_gym) {
            gymDisplay.textContent = info.gym_name || 'Unknown Gym';
            gymDisplay.classList.add('font-bold');
            joinGymSection.classList.add('hidden');
            if (leaveGymSection) leaveGymSection.classList.remove('hidden');
        } else {
            gymDisplay.textContent = 'No gym assigned';
            gymDisplay.classList.remove('font-bold');
            gymDisplay.classList.add('text-gray-400');
            joinGymSection.classList.remove('hidden');
            if (leaveGymSection) leaveGymSection.classList.add('hidden');
        }

        // Update trainer display
        const trainerDisplay = document.getElementById('current-trainer-display');
        const selectTrainerSection = document.getElementById('select-trainer-section');

        if (info.has_trainer) {
            trainerDisplay.textContent = info.trainer_name || 'Unknown Trainer';
            trainerDisplay.classList.add('font-bold');
            selectTrainerSection.classList.add('hidden');
        } else {
            trainerDisplay.textContent = 'No trainer selected';
            trainerDisplay.classList.remove('font-bold');
            trainerDisplay.classList.add('text-gray-400');

            if (info.has_gym) {
                selectTrainerSection.classList.remove('hidden');
                await loadTrainersForSelection(info.gym_id);
            }
        }
    } catch (error) {
        console.error('Error loading gym/trainer info:', error);
    }
}

async function joinGym() {
    const gymCode = document.getElementById('gym-code-input').value.trim();

    if (!gymCode) {
        showToast('Please enter a gym code', 'error');
        return;
    }

    try {
        const response = await fetch('/api/client/join-gym', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({ gym_code: gymCode })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to join gym');
        }

        const result = await response.json();
        showToast(`Joined ${result.gym_name} successfully! üéâ`, 'success');

        // Reload gym info to show trainers
        setTimeout(() => loadGymAndTrainerInfo(), 500);
    } catch (error) {
        console.error('Error joining gym:', error);
        showToast(error.message, 'error');
    }
}

async function leaveGym() {
    if (!confirm('Are you sure you want to leave your current gym? This will also unassign your trainer.')) {
        return;
    }

    try {
        const response = await fetch('/api/client/leave-gym', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to leave gym');
        }

        const result = await response.json();
        showToast('Successfully left gym', 'success');

        setTimeout(() => loadGymAndTrainerInfo(), 500);
    } catch (error) {
        console.error('Error leaving gym:', error);
        showToast(error.message, 'error');
    }
}

async function loadTrainersForSelection(gymId) {
    try {
        const response = await fetch(`/api/gym/${gymId}/trainers`, {
            credentials: 'include'
        });

        if (!response.ok) return;

        const trainers = await response.json();
        const trainerList = document.getElementById('trainer-list');

        if (trainers.length === 0) {
            trainerList.innerHTML = '<p class="text-gray-400 text-sm">No trainers available</p>';
            return;
        }

        trainerList.innerHTML = trainers.map(trainer => `
            <button onclick="selectTrainer('${trainer.id}')"
                class="w-full bg-white/10 hover:bg-primary/30 border border-white/10 hover:border-primary px-4 py-3 rounded-lg text-left transition tap-effect">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-bold text-white">${trainer.username}</p>
                        <p class="text-xs text-gray-400">${trainer.client_count} clients</p>
                    </div>
                    <span class="text-primary text-xl">‚Üí</span>
                </div>
            </button>
        `).join('');
    } catch (error) {
        console.error('Error loading trainers:', error);
    }
}

async function selectTrainer(trainerId) {
    try {
        const response = await fetch('/api/client/select-trainer', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ trainer_id: trainerId })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to select trainer');
        }

        const result = await response.json();
        showToast(`Assigned to ${result.trainer_name} successfully! üéâ`, 'success');

        // Reload gym info to update display
        setTimeout(() => loadGymAndTrainerInfo(), 500);
    } catch (error) {
        console.error('Error selecting trainer:', error);
        showToast(error.message, 'error');
    }
}

// --- TRAINER SELECTION FROM HOME PAGE ---

async function loadTrainerSelectionForHome() {
    try {
        // First get gym info
        const response = await fetch('/api/client/gym-info', {
            credentials: 'include'
        });

        if (!response.ok) {
            document.getElementById('trainer-section').innerHTML = `
                <div class="glass-card p-4 text-center text-gray-400">
                    <p>No trainer assigned yet</p>
                </div>
            `;
            return;
        }

        const info = await response.json();

        if (!info.has_gym) {
            // No gym - prompt to join one
            document.getElementById('trainer-section').innerHTML = `
                <div class="glass-card p-4 text-center">
                    <p class="text-gray-400 mb-3">Join a gym to get started</p>
                    <a href="/?gym_id={{ gym_id }}&role=client&mode=account_settings"
                       class="inline-block bg-primary px-4 py-2 rounded-lg text-sm font-bold hover:bg-primary/80 transition tap-effect">
                        Join Gym
                    </a>
                </div>
            `;
        } else {
            // Has gym but no trainer - show selection button
            window.clientGymId = info.gym_id;
            document.getElementById('trainer-section').innerHTML = `
                <div class="glass-card p-4 text-center">
                    <p class="text-gray-400 mb-3">No trainer assigned yet</p>
                    <button onclick="openTrainerSelectionModal()"
                            class="bg-primary px-6 py-3 rounded-xl font-bold hover:bg-primary/80 transition tap-effect">
                        Select Your Trainer
                    </button>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading gym info for home:', error);
        document.getElementById('trainer-section').innerHTML = `
            <div class="glass-card p-4 text-center text-gray-400">
                <p>No trainer assigned yet</p>
            </div>
        `;
    }
}

async function openTrainerSelectionModal() {
    const modal = document.getElementById('trainer-selection-modal');
    const list = document.getElementById('home-trainer-list');

    if (!modal || !list) return;

    modal.classList.remove('hidden');
    list.innerHTML = '<p class="text-center text-gray-400">Loading trainers...</p>';

    try {
        const response = await fetch(`/api/gym/${window.clientGymId}/trainers`, {
            credentials: 'include'
        });

        if (!response.ok) {
            list.innerHTML = '<p class="text-center text-red-400">Failed to load trainers</p>';
            return;
        }

        const trainers = await response.json();

        if (trainers.length === 0) {
            list.innerHTML = '<p class="text-center text-gray-400">No trainers available in this gym yet</p>';
            return;
        }

        list.innerHTML = trainers.map(trainer => `
            <button onclick="selectTrainerFromHome('${trainer.id}', '${trainer.username}')"
                class="w-full bg-white/10 hover:bg-primary/30 border border-white/10 hover:border-primary p-4 rounded-xl text-left transition tap-effect">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-tr from-red-500 to-orange-500 flex items-center justify-center">
                            <span class="text-xl">üë§</span>
                        </div>
                        <div>
                            <p class="font-bold text-white">${trainer.username}</p>
                            <p class="text-xs text-gray-400">${trainer.client_count} clients</p>
                        </div>
                    </div>
                    <span class="text-primary text-xl">‚Üí</span>
                </div>
            </button>
        `).join('');
    } catch (error) {
        console.error('Error loading trainers:', error);
        list.innerHTML = '<p class="text-center text-red-400">Error loading trainers</p>';
    }
}

function closeTrainerSelectionModal() {
    document.getElementById('trainer-selection-modal').classList.add('hidden');
}

async function selectTrainerFromHome(trainerId, trainerName) {
    try {
        const response = await fetch('/api/client/select-trainer', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ trainer_id: trainerId })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to select trainer');
        }

        showToast(`Assigned to ${trainerName} successfully!`, 'success');
        closeTrainerSelectionModal();

        // Reload the page to show trainer info
        setTimeout(() => window.location.reload(), 500);
    } catch (error) {
        console.error('Error selecting trainer:', error);
        showToast(error.message, 'error');
    }
}

// --- CLIENT CHAT FUNCTIONS ---
function openClientChatModal() {
    // Open the conversations list modal (shows all conversations: trainer + gym members)
    if (typeof window.openConversationsModal === 'function') {
        window.openConversationsModal();
    } else {
        showToast('Chat not available', 'error');
    }
}

// Load on page load
if (window.location.search.includes('role=client') && !window.location.search.includes('mode=')) {
    loadTrainerAndAppointments();
}

// Load gym/trainer info on settings page
if (window.location.search.includes('mode=account_settings')) {
    console.log('[INIT] Account settings page detected, loading gym/trainer info');
    // Use setTimeout to ensure DOM is ready
    setTimeout(() => loadGymAndTrainerInfo(), 100);
} else {
    console.log('[INIT] Not on account settings page, search:', window.location.search);
}

// --- PROFILE PICTURE FUNCTIONS ---
async function loadProfilePicture() {
    try {
        const res = await fetch('/api/profile/picture');
        if (res.ok) {
            const data = await res.json();
            if (data.profile_picture) {
                updateAllAvatars(data.profile_picture);
            } else {
                // Use dicebear with username as seed
                const username = data.username || 'User';
                const defaultAvatar = `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(username)}`;
                updateAllAvatars(defaultAvatar);
            }
        }
    } catch (e) {
        console.error('Error loading profile picture:', e);
    }
}

function updateAllAvatars(url) {
    // Update all avatar images on the page
    const avatarIds = ['profile-avatar-img', 'header-profile-img'];
    avatarIds.forEach(id => {
        const img = document.getElementById(id);
        if (img) {
            img.src = url;
        }
    });
}

async function uploadProfilePicture(input) {
    const file = input.files?.[0];
    if (!file) return;

    // Validate file type
    const validTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
    if (!validTypes.includes(file.type)) {
        showToast('Please select a valid image file (JPG, PNG, WEBP, GIF)', 'error');
        return;
    }

    // Validate file size (5MB max)
    if (file.size > 5 * 1024 * 1024) {
        showToast('Image too large. Maximum size is 5MB', 'error');
        return;
    }

    // Show loading state
    const container = document.getElementById('profile-avatar-container');
    if (container) {
        container.style.opacity = '0.5';
    }

    try {
        const formData = new FormData();
        formData.append('file', file);

        const res = await fetch('/api/profile/picture', {
            method: 'POST',
            body: formData
        });

        const data = await res.json();

        if (res.ok) {
            updateAllAvatars(data.profile_picture);
            showToast('Profile picture updated!', 'success');
        } else {
            showToast(data.detail || 'Failed to upload image', 'error');
        }
    } catch (e) {
        console.error('Error uploading profile picture:', e);
        showToast('Failed to upload image', 'error');
    } finally {
        if (container) {
            container.style.opacity = '1';
        }
        // Clear input
        input.value = '';
    }
}

// Load profile picture on page load
document.addEventListener('DOMContentLoaded', () => {
    loadProfilePicture();
});

// --- TRAINER PROFILE & BROWSE FUNCTIONS ---
let currentViewingTrainerId = null;
let currentViewingTrainerName = null;
let allGymTrainers = [];

// Store trainer data for profile modal
let currentTrainerData = {
    id: null,
    name: null,
    profile_picture: null,
    has_availability: false,
    bio: null,
    specialties: []
};

async function openTrainerProfileModal(trainerId = null, trainerName = null, trainerPicture = null, trainerBio = null, trainerSpecialties = null) {
    // If no trainerId passed, use the selected trainer (my trainer) and stored data
    if (!trainerId) {
        trainerId = selectedTrainerId;
        trainerName = currentTrainerData.name || document.getElementById('trainer-name')?.textContent || 'Your Trainer';
        trainerPicture = currentTrainerData.profile_picture;
        trainerBio = currentTrainerData.bio;
        trainerSpecialties = currentTrainerData.specialties || [];
    }

    // Parse specialties if it's a JSON string
    if (typeof trainerSpecialties === 'string') {
        try {
            trainerSpecialties = JSON.parse(trainerSpecialties);
        } catch (e) {
            trainerSpecialties = [];
        }
    }
    trainerSpecialties = trainerSpecialties || [];

    if (!trainerId) {
        showToast('No trainer to show', 'error');
        return;
    }

    // Close the all trainers modal if it's open
    document.getElementById('all-trainers-modal').classList.add('hidden');

    currentViewingTrainerId = trainerId;
    currentViewingTrainerName = trainerName;

    // Update modal content
    document.getElementById('profile-trainer-name').textContent = trainerName;

    // Update avatar
    const avatarContainer = document.getElementById('profile-trainer-avatar');
    if (trainerPicture) {
        avatarContainer.innerHTML = `<img src="${trainerPicture}" alt="${trainerName}" class="w-full h-full object-cover">`;
    } else {
        avatarContainer.innerHTML = `<span class="text-4xl">üë§</span>`;
    }

    // Update bio
    const bioSection = document.getElementById('profile-trainer-bio-section');
    const bioText = document.getElementById('profile-trainer-bio');
    if (trainerBio && trainerBio.trim()) {
        bioText.textContent = `"${trainerBio}"`;
        bioSection.classList.remove('hidden');
    } else {
        bioSection.classList.add('hidden');
    }

    // Update specialties
    const specialtiesContainer = document.getElementById('profile-trainer-specialties');
    if (specialtiesContainer) {
        if (trainerSpecialties.length > 0) {
            specialtiesContainer.innerHTML = trainerSpecialties.map(s =>
                `<span class="bg-white/10 text-white/80 px-3 py-1 rounded-full text-xs border border-white/10">${s}</span>`
            ).join('');
            specialtiesContainer.classList.remove('hidden');
        } else {
            specialtiesContainer.classList.add('hidden');
        }
    }

    // Show "Your Trainer" badge if this is the user's trainer
    const badge = document.getElementById('profile-trainer-badge');
    const selectBtn = document.getElementById('profile-select-btn');

    if (trainerId === selectedTrainerId) {
        badge.classList.remove('hidden');
        selectBtn.classList.add('hidden');
    } else {
        badge.classList.add('hidden');
        selectBtn.classList.remove('hidden');
    }

    // Load trainer stats
    await loadTrainerStats(trainerId);

    // Show modal
    document.getElementById('trainer-profile-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeTrainerProfileModal() {
    document.getElementById('trainer-profile-modal').classList.add('hidden');
    document.body.style.overflow = '';
    currentViewingTrainerId = null;
    currentViewingTrainerName = null;
}

async function loadTrainerStats(trainerId) {
    try {
        // Check availability
        const availResponse = await fetch(`/api/client/trainers/${trainerId}/availability`, {
            credentials: 'include'
        });

        let availabilityText = 'Not set';
        if (availResponse.ok) {
            const availability = await availResponse.json();
            if (availability && availability.length > 0) {
                const daysWithAvailability = [...new Set(availability.map(a => a.day_of_week))];
                availabilityText = `${daysWithAvailability.length} days/week`;
            }
        }

        document.getElementById('profile-trainer-availability').textContent = availabilityText;
        document.getElementById('profile-trainer-clients').textContent = '-'; // We don't have this info from client side

    } catch (error) {
        console.error('Error loading trainer stats:', error);
        document.getElementById('profile-trainer-availability').textContent = '-';
        document.getElementById('profile-trainer-clients').textContent = '-';
    }
}

function messageTrainerFromProfile() {
    if (!currentViewingTrainerId) return;

    closeTrainerProfileModal();

    // Open chat with the trainer
    if (typeof openChatModal === 'function') {
        openChatModal(currentViewingTrainerId, currentViewingTrainerName);
    } else if (typeof openConversationsModal === 'function') {
        openConversationsModal();
    } else {
        showToast('Messaging not available', 'error');
    }
}

function bookWithTrainerFromProfile() {
    if (!currentViewingTrainerId) return;

    // Close the profile modal and show booking choice modal
    closeTrainerProfileModal();
    openBookingChoiceModal(currentViewingTrainerId, currentViewingTrainerName);
}

// Booking Choice Modal Functions
let bookingChoiceTrainerId = null;
let bookingChoiceTrainerName = null;

function openBookingChoiceModal(trainerId, trainerName) {
    bookingChoiceTrainerId = trainerId;
    bookingChoiceTrainerName = trainerName;
    document.getElementById('booking-choice-trainer-name').textContent = trainerName || 'Trainer';
    document.getElementById('booking-choice-modal').classList.remove('hidden');
}

function openBookingChoiceForMyTrainer() {
    // Use the client's assigned trainer
    const trainerName = document.getElementById('trainer-name')?.textContent || 'Trainer';
    if (selectedTrainerId) {
        openBookingChoiceModal(selectedTrainerId, trainerName);
    } else {
        // Fallback to direct booking if no trainer assigned
        openBookingModal();
    }
}

function closeBookingChoiceModal() {
    document.getElementById('booking-choice-modal').classList.add('hidden');
    bookingChoiceTrainerId = null;
    bookingChoiceTrainerName = null;
}

function selectBookingType(type) {
    closeBookingChoiceModal();

    if (type === 'personal') {
        // Book 1-on-1 session
        const originalTrainerId = selectedTrainerId;
        selectedTrainerId = bookingChoiceTrainerId;

        if (typeof openBookingModal === 'function') {
            openBookingModal();
        }
    } else if (type === 'course') {
        // Show all gym courses
        openGymCoursesModal();
    }
}

// Gym Courses Modal Functions
async function openGymCoursesModal() {
    document.getElementById('gym-courses-modal').classList.remove('hidden');

    const listEl = document.getElementById('gym-courses-list');
    listEl.innerHTML = '<div class="text-center py-8 text-gray-400"><div class="animate-pulse">Loading courses...</div></div>';

    try {
        const response = await fetch('/api/client/gym/courses', {
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error('Failed to load courses');
        }

        const courses = await response.json();

        if (courses.length === 0) {
            listEl.innerHTML = `
                <div class="text-center py-8">
                    <div class="text-4xl mb-3">üìö</div>
                    <p class="text-gray-400">No courses available yet</p>
                    <p class="text-sm text-gray-500 mt-2">Your gym hasn't scheduled any group classes</p>
                </div>
            `;
            return;
        }

        listEl.innerHTML = courses.map(course => renderClientCourseCard(course)).join('');
    } catch (error) {
        console.error('Error loading courses:', error);
        listEl.innerHTML = `
            <div class="text-center py-8 text-red-400">
                <p>Failed to load courses</p>
                <button onclick="openGymCoursesModal()" class="mt-2 text-sm text-orange-400 hover:text-orange-300">Try again</button>
            </div>
        `;
    }
}

function closeGymCoursesModal() {
    document.getElementById('gym-courses-modal').classList.add('hidden');
}

function renderClientCourseCard(course) {
    const courseTypeColors = {
        yoga: 'purple',
        pilates: 'pink',
        hiit: 'orange',
        dance: 'cyan',
        spin: 'green',
        strength: 'red',
        stretch: 'teal',
        cardio: 'yellow'
    };

    const color = courseTypeColors[course.course_type] || 'purple';
    const trainerInitial = (course.trainer_name || 'T').charAt(0).toUpperCase();
    const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    const days = course.days_of_week ? course.days_of_week.map(d => dayNames[d]).join(', ') : 'Not scheduled';

    // Check if trailer URL exists and extract thumbnail
    let trailerThumb = null;
    if (course.trailer_url) {
        const ytMatch = course.trailer_url.match(/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
        if (ytMatch) {
            trailerThumb = `https://i.ytimg.com/vi/${ytMatch[1]}/hq720.jpg`;
        }
    }

    return `
        <div class="bg-black/30 rounded-xl overflow-hidden border border-white/10 cursor-pointer hover:border-${color}-500/50 transition" onclick="viewCourseDetails('${course.id}')">
            <!-- Trailer/Cover Area -->
            <div class="relative">
                ${trailerThumb ? `
                    <div class="w-full aspect-video bg-black relative">
                        <img src="${trailerThumb}" class="w-full h-full object-cover" alt="${course.name}">
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="w-10 h-10 rounded-full bg-white/90 flex items-center justify-center shadow-lg">
                                <span class="text-base ml-0.5">‚ñ∂</span>
                            </div>
                        </div>
                    </div>
                ` : `
                    <div class="w-full aspect-video bg-gradient-to-br from-${color}-900/50 to-${color}-800/30 flex items-center justify-center">
                        <span class="text-5xl opacity-30">üé¨</span>
                    </div>
                `}
                <!-- Trainer Overlay -->
                <div class="absolute top-3 left-3 flex items-center gap-2 bg-black/70 backdrop-blur-sm rounded-xl pr-3 pl-1.5 py-1.5">
                    <div class="w-9 h-9 rounded-full bg-gradient-to-br from-${color}-500 to-pink-500 flex items-center justify-center border-2 border-white/30">
                        <span class="text-white font-bold text-sm">${trainerInitial}</span>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-white font-medium text-xs leading-tight">${course.trainer_name || 'Trainer'}</span>
                        <span class="text-${color}-300/80 text-[10px] leading-tight">Instructor</span>
                    </div>
                </div>
            </div>
            <!-- Course Info -->
            <div class="p-4">
                <h3 class="text-lg font-bold text-white">${course.name}</h3>
                <p class="text-sm text-gray-400 mt-1">${days} ${course.time_slot ? '@ ' + course.time_slot : ''}</p>
                <p class="text-xs text-gray-500 mt-1">${course.duration || 60} min ‚Ä¢ ${course.upcoming_lessons || 0} upcoming sessions</p>
                ${course.description ? `<p class="text-sm text-gray-400 mt-2 line-clamp-2">${course.description}</p>` : ''}
            </div>
        </div>
    `;
}

// Store current course data for booking
let currentCourseData = null;

async function viewCourseDetails(courseId) {
    // Find the course in cached data or fetch it
    try {
        const response = await fetch('/api/client/gym/courses', { credentials: 'include' });
        const courses = await response.json();
        const course = courses.find(c => c.id === courseId);

        if (!course) {
            showToast('Course not found', 'error');
            return;
        }

        currentCourseData = course;
        openClientCourseDetail(course);
    } catch (error) {
        console.error('Error loading course:', error);
        showToast('Failed to load course details', 'error');
    }
}

// Store pending video embed URL for lazy loading
let pendingVideoEmbedUrl = null;

function openClientCourseDetail(course) {
    const modal = document.getElementById('client-course-detail-modal');
    const trailerIframe = document.getElementById('client-course-trailer');
    const thumbnail = document.getElementById('client-course-thumbnail');
    const thumbImg = document.getElementById('client-course-thumb-img');
    const noTrailer = document.getElementById('client-course-no-trailer');

    // Set trainer info
    const trainerInitial = (course.trainer_name || 'T').charAt(0).toUpperCase();
    document.getElementById('client-course-trainer-initial').textContent = trainerInitial;
    document.getElementById('client-course-trainer-name').textContent = course.trainer_name || 'Trainer';

    // Reset video state
    pendingVideoEmbedUrl = null;
    trailerIframe.src = '';
    trailerIframe.classList.add('hidden');
    thumbnail.classList.add('hidden');
    noTrailer.classList.add('hidden');

    // Check for trailer URL
    if (course.trailer_url) {
        const ytMatch = course.trailer_url.match(/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
        if (ytMatch) {
            // Show thumbnail with play button
            thumbImg.src = `https://i.ytimg.com/vi/${ytMatch[1]}/hq720.jpg`;
            pendingVideoEmbedUrl = `https://www.youtube.com/embed/${ytMatch[1]}?rel=0&modestbranding=1&autoplay=1&controls=1&fs=1`;
            thumbnail.classList.remove('hidden');
        }
        const vimeoMatch = course.trailer_url.match(/(?:vimeo\.com\/)(\d+)/);
        if (vimeoMatch) {
            // Vimeo doesn't have easy thumbnails, load directly
            trailerIframe.src = `https://player.vimeo.com/video/${vimeoMatch[1]}?autoplay=1&controls=1`;
            trailerIframe.classList.remove('hidden');
        }
    }

    // Show no trailer placeholder if no valid URL
    if (!pendingVideoEmbedUrl && trailerIframe.classList.contains('hidden')) {
        noTrailer.classList.remove('hidden');
    }

    // Set course info
    document.getElementById('client-course-title').textContent = course.name;

    const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    const days = course.days_of_week ? course.days_of_week.map(d => dayNames[d]).join(', ') : 'Not scheduled';
    document.getElementById('client-course-schedule').textContent = `üìÖ ${days} ${course.time_slot ? '@ ' + course.time_slot : ''}`;
    document.getElementById('client-course-duration').textContent = `‚è±Ô∏è ${course.duration || 60} min`;

    document.getElementById('client-course-description').textContent = course.description || 'No description available.';
    document.getElementById('client-course-sessions').textContent = `${course.upcoming_lessons || 0} sessions scheduled`;

    modal.classList.remove('hidden');
}

function closeClientCourseDetail() {
    const modal = document.getElementById('client-course-detail-modal');
    const trailerIframe = document.getElementById('client-course-trailer');
    trailerIframe.src = ''; // Stop video
    modal.classList.add('hidden');
    currentCourseData = null;
    pendingVideoEmbedUrl = null;
}

function playClientCourseVideo() {
    if (!pendingVideoEmbedUrl) return;

    const trailerIframe = document.getElementById('client-course-trailer');
    const thumbnail = document.getElementById('client-course-thumbnail');

    // Hide thumbnail, show iframe with video
    thumbnail.classList.add('hidden');
    trailerIframe.src = pendingVideoEmbedUrl;
    trailerIframe.classList.remove('hidden');
}

function bookCourseSession() {
    if (!currentCourseData) {
        showToast('No course selected', 'error');
        return;
    }

    // Close the detail modal
    closeClientCourseDetail();
    closeGymCoursesModal();

    // Show success message - the course sessions are already in their schedule
    showToast(`You're enrolled in ${currentCourseData.name}! Check your schedule.`, 'success');
}

async function selectTrainerFromProfile() {
    if (!currentViewingTrainerId) return;

    try {
        const response = await fetch('/api/client/select-trainer', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ trainer_id: currentViewingTrainerId })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to select trainer');
        }

        showToast(`${currentViewingTrainerName} is now your trainer!`, 'success');
        closeTrainerProfileModal();
        closeAllTrainersModal();

        // Reload the page to update trainer info
        setTimeout(() => window.location.reload(), 500);
    } catch (error) {
        console.error('Error selecting trainer:', error);
        showToast(error.message, 'error');
    }
}

// --- ALL TRAINERS MODAL ---
async function openAllTrainersModal() {
    document.getElementById('all-trainers-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    // Load trainers
    await loadAllGymTrainers();
}

function closeAllTrainersModal() {
    document.getElementById('all-trainers-modal').classList.add('hidden');
    document.body.style.overflow = '';
}

async function loadAllGymTrainers() {
    const list = document.getElementById('all-trainers-list');
    list.innerHTML = `
        <div class="text-center py-8 text-gray-400">
            <div class="animate-pulse">Loading trainers...</div>
        </div>
    `;

    try {
        const response = await fetch('/api/client/gym-trainers', {
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error('Failed to load trainers');
        }

        allGymTrainers = await response.json();

        if (allGymTrainers.length === 0) {
            list.innerHTML = `
                <div class="text-center py-8 text-gray-400">
                    <p class="text-4xl mb-2">üë§</p>
                    <p>No trainers available in your gym yet</p>
                </div>
            `;
            return;
        }

        list.innerHTML = allGymTrainers.map(trainer => {
            const isMyTrainer = trainer.id === selectedTrainerId;
            const avatarHtml = trainer.profile_picture
                ? `<img src="${trainer.profile_picture}" alt="${trainer.name}" class="w-full h-full object-cover">`
                : `<span class="text-2xl">üë§</span>`;
            const bioEscaped = trainer.bio ? trainer.bio.replace(/'/g, "\\'").replace(/"/g, "&quot;") : '';
            const specialtiesJson = trainer.specialties ? JSON.stringify(trainer.specialties).replace(/'/g, "\\'") : '[]';

            // Render specialty tags
            const specialtyTags = (trainer.specialties || []).map(s =>
                `<span class="bg-white/10 text-white/70 px-2.5 py-1 rounded-full text-[10px] border border-white/10">${s}</span>`
            ).join('');

            return `
                <div onclick="openTrainerProfileModal('${trainer.id}', '${trainer.name}', ${trainer.profile_picture ? `'${trainer.profile_picture}'` : 'null'}, ${trainer.bio ? `'${bioEscaped}'` : 'null'}, '${specialtiesJson}')"
                    class="glass-card p-4 cursor-pointer hover:bg-white/5 transition tap-effect ${isMyTrainer ? 'border border-orange-500/30' : ''}">
                    <div class="flex space-x-4">
                        <!-- Left column: Avatar -->
                        <div class="flex flex-col items-center flex-shrink-0">
                            <div class="w-16 h-16 rounded-full bg-gradient-to-tr from-red-500 to-orange-500 flex items-center justify-center overflow-hidden">
                                ${avatarHtml}
                            </div>
                        </div>
                        <!-- Right column: Name + Bio + Tags -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 flex-wrap">
                                <p class="font-bold text-white text-lg flex items-center gap-1.5">${trainer.name}${trainer.has_availability ? '<svg class="w-4 h-4 text-green-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>' : ''}</p>
                                ${isMyTrainer ? '<span class="text-[10px] bg-orange-500/20 text-orange-400 px-2 py-0.5 rounded-full">Your Trainer</span>' : ''}
                            </div>
                            ${trainer.bio ? `<p class="text-sm text-gray-400 mt-1 line-clamp-2">${trainer.bio}</p>` : '<p class="text-sm text-gray-500 italic mt-1">No bio</p>'}
                            ${specialtyTags ? `<div class="flex flex-wrap gap-1.5 mt-2">${specialtyTags}</div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('Error loading gym trainers:', error);
        list.innerHTML = `
            <div class="text-center py-8 text-red-400">
                <p>Failed to load trainers</p>
                <button onclick="loadAllGymTrainers()" class="mt-2 text-sm text-orange-400 hover:text-orange-300">Try again</button>
            </div>
        `;
    }
}

// Update trainer avatar when loading trainer info
function updateTrainerAvatar(profilePicture, trainerName) {
    const avatarContainer = document.getElementById('trainer-avatar');
    if (avatarContainer) {
        if (profilePicture) {
            avatarContainer.innerHTML = `<img src="${profilePicture}" alt="${trainerName}" class="w-full h-full object-cover">`;
        } else {
            avatarContainer.innerHTML = `<span class="text-xl">üë§</span>`;
        }
    }

    // Store for profile modal
    currentTrainerData.profile_picture = profilePicture;
}

// --- GYM MEMBERS ---
let gymMembers = [];
let chatRequestTarget = null;

async function loadGymMembersPreview() {
    try {
        const response = await fetch('/api/client/gym-members', { credentials: 'include' });
        if (response.ok) {
            gymMembers = await response.json();
            renderMembersPreview();
        }
    } catch (error) {
        console.error('Error loading gym members:', error);
    }
}

function renderMembersPreview() {
    const avatarsContainer = document.getElementById('members-avatars');
    const countSpan = document.getElementById('members-count');

    if (!avatarsContainer || !countSpan) return;

    if (gymMembers.length === 0) {
        avatarsContainer.innerHTML = '';
        countSpan.textContent = 'No other members yet';
        return;
    }

    // Show up to 5 avatars
    const displayMembers = gymMembers.slice(0, 5);
    avatarsContainer.innerHTML = displayMembers.map(member => `
        <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center overflow-hidden border-2 border-black">
            ${member.profile_picture
                ? `<img src="${member.profile_picture}" class="w-full h-full object-cover">`
                : '<span class="text-xs">üë§</span>'}
        </div>
    `).join('');

    const remaining = gymMembers.length - 5;
    if (gymMembers.length === 1) {
        countSpan.textContent = '1 member';
    } else if (remaining > 0) {
        countSpan.textContent = `+${remaining} more`;
    } else {
        countSpan.textContent = `${gymMembers.length} members`;
    }
}

function openGymMembersModal() {
    document.getElementById('gym-members-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    loadGymMembersList();
}

function closeGymMembersModal() {
    document.getElementById('gym-members-modal').classList.add('hidden');
    document.body.style.overflow = '';
}

async function loadGymMembersList() {
    const list = document.getElementById('gym-members-list');
    list.innerHTML = `
        <div class="text-center py-8 text-gray-400">
            <div class="animate-pulse">Loading members...</div>
        </div>
    `;

    try {
        const response = await fetch('/api/client/gym-members', { credentials: 'include' });
        if (!response.ok) throw new Error('Failed to load members');

        gymMembers = await response.json();

        if (gymMembers.length === 0) {
            list.innerHTML = `
                <div class="text-center py-8 text-gray-400">
                    <p class="text-4xl mb-2">üë•</p>
                    <p>No other members in your gym yet</p>
                </div>
            `;
            return;
        }

        list.innerHTML = gymMembers.map(member => {
            const avatarHtml = member.profile_picture
                ? `<img src="${member.profile_picture}" class="w-full h-full object-cover">`
                : '<span class="text-xl">üë§</span>';

            return `
                <div class="glass-card p-4 flex items-center justify-between cursor-pointer hover:bg-white/10 transition"
                    onclick="openMemberProfile('${member.id}')">
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center overflow-hidden">
                            ${avatarHtml}
                        </div>
                        <div>
                            <p class="font-bold text-white">${member.username}</p>
                        </div>
                    </div>
                    <span class="text-gray-400 text-sm">View &rarr;</span>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('Error loading gym members:', error);
        list.innerHTML = `
            <div class="text-center py-8 text-red-400">
                <p>Failed to load members</p>
                <button onclick="loadGymMembersList()" class="mt-2 text-sm text-blue-400 hover:text-blue-300">Try again</button>
            </div>
        `;
    }
}

async function initiateChat(userId, username, profilePicture) {
    try {
        // Check if we can message this user
        const response = await fetch(`/api/client/can-message/${userId}`, { credentials: 'include' });
        if (!response.ok) throw new Error('Failed to check messaging status');

        const result = await response.json();

        if (result.can_message) {
            // Can message directly - open chat
            closeGymMembersModal();
            if (typeof openChatModal === 'function') {
                openChatModal(userId, username);
            } else if (typeof openConversationsModal === 'function') {
                openConversationsModal();
            } else {
                showToast('Messaging not available', 'error');
            }
        } else if (result.reason === 'request_pending') {
            showToast('Your chat request is still pending', 'info');
        } else if (result.needs_request) {
            // Need to send chat request - show modal
            openChatRequestModal(userId, username, profilePicture);
        } else {
            showToast('Cannot message this user', 'error');
        }
    } catch (error) {
        console.error('Error initiating chat:', error);
        showToast('Failed to start chat', 'error');
    }
}

function openChatRequestModal(userId, username, profilePicture) {
    chatRequestTarget = { userId, username, profilePicture };

    // Update modal content
    document.getElementById('chat-request-name').textContent = username;
    const avatarEl = document.getElementById('chat-request-avatar');
    if (profilePicture) {
        avatarEl.innerHTML = `<img src="${profilePicture}" class="w-full h-full object-cover">`;
    } else {
        avatarEl.innerHTML = '<span class="text-3xl">üë§</span>';
    }
    document.getElementById('chat-request-message').value = '';

    document.getElementById('chat-request-modal').classList.remove('hidden');
}

function closeChatRequestModal() {
    document.getElementById('chat-request-modal').classList.add('hidden');
    chatRequestTarget = null;
}

async function sendChatRequest() {
    if (!chatRequestTarget) return;

    const message = document.getElementById('chat-request-message').value.trim();

    try {
        const response = await fetch('/api/client/chat-requests', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                to_user_id: chatRequestTarget.userId,
                message: message || null
            })
        });

        if (response.ok) {
            const result = await response.json();
            if (result.status === 'public' || result.status === 'already_accepted') {
                showToast('You can message them directly!', 'success');
                closeChatRequestModal();
                closeGymMembersModal();
                if (typeof openChatModal === 'function') {
                    openChatModal(chatRequestTarget.userId, chatRequestTarget.username);
                }
            } else {
                showToast('Chat request sent!', 'success');
                closeChatRequestModal();
            }
        } else {
            const error = await response.json();
            showToast(error.detail || 'Failed to send request', 'error');
        }
    } catch (error) {
        console.error('Error sending chat request:', error);
        showToast('Failed to send request', 'error');
    }
}

// --- FRIENDS SYSTEM ---
let friendsList = [];
let pendingFriendRequests = { incoming: [], outgoing: [] };
let friendRequestTarget = null;

async function loadFriendsPreview() {
    console.log('loadFriendsPreview called');
    try {
        const response = await fetch('/api/friends', { credentials: 'include' });
        console.log('/api/friends response:', response.status);
        if (response.ok) {
            friendsList = await response.json();
            console.log('Friends list:', friendsList);
            renderFriendsPreview();
        }
    } catch (error) {
        console.error('Error loading friends:', error);
    }

    // Also load pending requests count
    console.log('Calling loadFriendRequestsCount...');
    loadFriendRequestsCount();
}

function renderFriendsPreview() {
    const avatarsContainer = document.getElementById('friends-avatars');
    const countSpan = document.getElementById('friends-count');

    if (!avatarsContainer || !countSpan) return;

    if (friendsList.length === 0) {
        avatarsContainer.innerHTML = '';
        countSpan.textContent = 'No friends yet';
        return;
    }

    // Show up to 5 avatars
    const displayFriends = friendsList.slice(0, 5);
    avatarsContainer.innerHTML = displayFriends.map(friend => `
        <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center overflow-hidden border-2 border-black">
            ${friend.profile_picture
                ? `<img src="${friend.profile_picture}" class="w-full h-full object-cover">`
                : '<span class="text-xs">üë§</span>'}
        </div>
    `).join('');

    const remaining = friendsList.length - 5;
    if (friendsList.length === 1) {
        countSpan.textContent = '1 friend';
    } else if (remaining > 0) {
        countSpan.textContent = `+${remaining} more`;
    } else {
        countSpan.textContent = `${friendsList.length} friends`;
    }
}

async function loadFriendRequestsCount() {
    console.log('loadFriendRequestsCount called');
    try {
        console.log('Fetching /api/friends/requests/incoming...');
        const response = await fetch('/api/friends/requests/incoming', { credentials: 'include' });
        console.log('/api/friends/requests/incoming response:', response.status);
        if (response.ok) {
            const incoming = await response.json();
            console.log('Incoming requests:', incoming);
            const badge = document.getElementById('friend-requests-badge');
            const count = document.getElementById('pending-requests-count');
            console.log('Badge element:', badge, 'Count element:', count);
            if (incoming.length > 0) {
                console.log('Showing badge for', incoming.length, 'requests');
                badge?.classList.remove('hidden');
                if (count) count.textContent = incoming.length;
            } else {
                badge?.classList.add('hidden');
            }
        }
    } catch (error) {
        console.error('Error loading friend requests count:', error);
    }
}

function openFriendsModal() {
    document.getElementById('friends-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    showFriendsTab('friends');
    loadFriendsModalData();
}

function closeFriendsModal() {
    document.getElementById('friends-modal').classList.add('hidden');
    document.body.style.overflow = '';
}

function showFriendsTab(tab) {
    const friendsTab = document.getElementById('tab-friends');
    const requestsTab = document.getElementById('tab-requests');
    const friendsContainer = document.getElementById('friends-list-container');
    const requestsContainer = document.getElementById('requests-container');

    if (tab === 'friends') {
        friendsTab.classList.add('bg-purple-500', 'text-white');
        friendsTab.classList.remove('text-gray-400');
        requestsTab.classList.remove('bg-purple-500', 'text-white');
        requestsTab.classList.add('text-gray-400');
        friendsContainer.classList.remove('hidden');
        requestsContainer.classList.add('hidden');
    } else {
        requestsTab.classList.add('bg-purple-500', 'text-white');
        requestsTab.classList.remove('text-gray-400');
        friendsTab.classList.remove('bg-purple-500', 'text-white');
        friendsTab.classList.add('text-gray-400');
        requestsContainer.classList.remove('hidden');
        friendsContainer.classList.add('hidden');
        loadFriendRequests();
    }
}

async function loadFriendsModalData() {
    const list = document.getElementById('friends-list');
    const noFriendsMsg = document.getElementById('no-friends-message');

    try {
        const response = await fetch('/api/friends', { credentials: 'include' });
        if (!response.ok) throw new Error('Failed to load friends');

        friendsList = await response.json();

        if (friendsList.length === 0) {
            list.innerHTML = '';
            noFriendsMsg?.classList.remove('hidden');
            return;
        }

        noFriendsMsg?.classList.add('hidden');
        list.innerHTML = friendsList.map(friend => `
            <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl hover:bg-white/10 transition">
                <div class="flex items-center gap-3 cursor-pointer" onclick="openMemberProfile('${friend.id}')">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center overflow-hidden">
                        ${friend.profile_picture
                            ? `<img src="${friend.profile_picture}" class="w-full h-full object-cover">`
                            : '<span class="text-lg">üë§</span>'}
                    </div>
                    <div>
                        <p class="font-medium text-white">${friend.username}</p>
                        <div class="flex items-center gap-2 text-xs text-gray-400">
                            <span>üî• ${friend.streak || 0}</span>
                            <span>üî∂ ${friend.gems || 0}</span>
                        </div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="messageFromFriendsList('${friend.id}', '${friend.username}')"
                        class="p-2 bg-orange-500/20 text-orange-400 rounded-lg hover:bg-orange-500/30 transition">
                        üí¨
                    </button>
                    <button onclick="confirmUnfriend('${friend.id}', '${friend.username}')"
                        class="p-2 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30 transition">
                        ‚úï
                    </button>
                </div>
            </div>
        `).join('');

    } catch (error) {
        console.error('Error loading friends:', error);
        list.innerHTML = '<p class="text-center text-red-400 py-4">Failed to load friends</p>';
    }
}

async function loadFriendRequests() {
    try {
        const [incomingRes, outgoingRes] = await Promise.all([
            fetch('/api/friends/requests/incoming', { credentials: 'include' }),
            fetch('/api/friends/requests/outgoing', { credentials: 'include' })
        ]);

        const incoming = incomingRes.ok ? await incomingRes.json() : [];
        const outgoing = outgoingRes.ok ? await outgoingRes.json() : [];

        pendingFriendRequests = { incoming, outgoing };
        renderFriendRequests();

        // Update badge
        const badge = document.getElementById('requests-badge');
        if (incoming.length > 0) {
            badge.classList.remove('hidden');
            badge.textContent = incoming.length;
        } else {
            badge.classList.add('hidden');
        }

    } catch (error) {
        console.error('Error loading friend requests:', error);
    }
}

function renderFriendRequests() {
    const incomingContainer = document.getElementById('incoming-requests');
    const outgoingContainer = document.getElementById('outgoing-requests');
    const noIncoming = document.getElementById('no-incoming-requests');
    const noOutgoing = document.getElementById('no-outgoing-requests');

    // Render incoming requests
    if (pendingFriendRequests.incoming.length === 0) {
        incomingContainer.innerHTML = '';
        noIncoming?.classList.remove('hidden');
    } else {
        noIncoming?.classList.add('hidden');
        incomingContainer.innerHTML = pendingFriendRequests.incoming.map(req => `
            <div class="flex items-center justify-between p-3 bg-purple-500/10 rounded-xl border border-purple-500/20">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center overflow-hidden">
                        ${req.profile_picture
                            ? `<img src="${req.profile_picture}" class="w-full h-full object-cover">`
                            : '<span class="text-sm">üë§</span>'}
                    </div>
                    <div>
                        <p class="font-medium text-white text-sm">${req.username}</p>
                        ${req.message ? `<p class="text-xs text-gray-400 truncate max-w-[150px]">"${req.message}"</p>` : ''}
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="respondToFriendRequest(${req.id}, true)"
                        class="px-3 py-1.5 bg-green-500 text-white text-xs font-bold rounded-lg hover:bg-green-400 transition">
                        Accept
                    </button>
                    <button onclick="respondToFriendRequest(${req.id}, false)"
                        class="px-3 py-1.5 bg-white/10 text-gray-300 text-xs font-bold rounded-lg hover:bg-white/20 transition">
                        Decline
                    </button>
                </div>
            </div>
        `).join('');
    }

    // Render outgoing requests
    if (pendingFriendRequests.outgoing.length === 0) {
        outgoingContainer.innerHTML = '';
        noOutgoing?.classList.remove('hidden');
    } else {
        noOutgoing?.classList.add('hidden');
        outgoingContainer.innerHTML = pendingFriendRequests.outgoing.map(req => `
            <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-gray-500 to-gray-600 flex items-center justify-center overflow-hidden">
                        ${req.profile_picture
                            ? `<img src="${req.profile_picture}" class="w-full h-full object-cover">`
                            : '<span class="text-sm">üë§</span>'}
                    </div>
                    <div>
                        <p class="font-medium text-white text-sm">${req.username}</p>
                        <p class="text-xs text-gray-500">Pending...</p>
                    </div>
                </div>
                <button onclick="cancelFriendRequest(${req.id})"
                    class="px-3 py-1.5 bg-white/10 text-gray-300 text-xs font-bold rounded-lg hover:bg-white/20 transition">
                    Cancel
                </button>
            </div>
        `).join('');
    }
}

async function respondToFriendRequest(requestId, accept) {
    try {
        const response = await fetch('/api/friends/request/respond', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ request_id: requestId, accept })
        });

        if (response.ok) {
            showToast(accept ? 'Friend added!' : 'Request declined', accept ? 'success' : 'info');
            loadFriendRequests();
            if (accept) {
                loadFriendsModalData();
                loadFriendsPreview();
            }
        } else {
            const error = await response.json();
            showToast(error.detail || 'Failed to respond', 'error');
        }
    } catch (error) {
        console.error('Error responding to friend request:', error);
        showToast('Failed to respond', 'error');
    }
}

async function cancelFriendRequest(requestId) {
    try {
        const response = await fetch(`/api/friends/request/${requestId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        if (response.ok) {
            showToast('Request cancelled', 'info');
            loadFriendRequests();
        } else {
            showToast('Failed to cancel request', 'error');
        }
    } catch (error) {
        console.error('Error cancelling friend request:', error);
        showToast('Failed to cancel request', 'error');
    }
}

function confirmUnfriend(friendId, friendName) {
    if (confirm(`Remove ${friendName} from your friends?`)) {
        removeFriend(friendId);
    }
}

async function removeFriend(friendId) {
    try {
        const response = await fetch(`/api/friends/${friendId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        if (response.ok) {
            showToast('Friend removed', 'info');
            loadFriendsModalData();
            loadFriendsPreview();
        } else {
            showToast('Failed to remove friend', 'error');
        }
    } catch (error) {
        console.error('Error removing friend:', error);
        showToast('Failed to remove friend', 'error');
    }
}

// --- CO-OP WORKOUT FUNCTIONS ---

function openCoopModal() {
    document.getElementById('coop-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    loadCoopFriends();
}

function closeCoopModal() {
    document.getElementById('coop-modal').classList.add('hidden');
    document.body.style.overflow = '';
}

async function loadCoopFriends() {
    const list = document.getElementById('coop-friends-list');
    const noFriendsMsg = document.getElementById('coop-no-friends');
    const loadingMsg = document.getElementById('coop-loading');

    loadingMsg?.classList.remove('hidden');
    list.innerHTML = '';
    noFriendsMsg?.classList.add('hidden');

    try {
        const response = await fetch('/api/friends', { credentials: 'include' });
        if (!response.ok) throw new Error('Failed to load friends');

        const friends = await response.json();
        loadingMsg?.classList.add('hidden');

        if (friends.length === 0) {
            noFriendsMsg?.classList.remove('hidden');
            return;
        }

        list.innerHTML = friends.map(friend => `
            <div onclick="startCoopWorkout('${friend.id}', '${friend.username}', '${friend.profile_picture || ''}')"
                class="flex items-center gap-3 p-4 bg-white/5 rounded-xl hover:bg-purple-500/20 border border-transparent hover:border-purple-500/30 transition cursor-pointer tap-effect">
                <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center overflow-hidden flex-shrink-0">
                    ${friend.profile_picture
                        ? `<img src="${friend.profile_picture}" class="w-full h-full object-cover">`
                        : '<span class="text-xl">üë§</span>'}
                </div>
                <div class="flex-1">
                    <p class="font-bold text-white">${friend.username}</p>
                    <div class="flex items-center gap-3 text-sm text-gray-400">
                        <span>üî• ${friend.streak || 0} streak</span>
                        <span>üíö ${friend.health_score || 0}%</span>
                    </div>
                </div>
                <div class="text-purple-400 text-xl">‚Üí</div>
            </div>
        `).join('');

    } catch (error) {
        console.error('Error loading friends for CO-OP:', error);
        loadingMsg?.classList.add('hidden');
        list.innerHTML = '<p class="text-center text-red-400 py-4">Failed to load friends</p>';
    }
}

function startCoopWorkout(partnerId, partnerName, partnerPicture) {
    // Store co-op partner info in localStorage for the workout page
    localStorage.setItem('coopPartner', JSON.stringify({
        id: partnerId,
        name: partnerName,
        profile_picture: partnerPicture
    }));

    closeCoopModal();
    showToast(`Starting CO-OP workout with ${partnerName}!`, 'success');

    // Navigate to workout with coop param
    const workoutUrl = '{{ "workout.html" if static_build else "/?gym_id=" + gym_id + "&role=client&mode=workout" }}';
    const separator = workoutUrl.includes('?') ? '&' : '?';
    window.location.href = `${workoutUrl}${separator}coop=true`;
}

function openFriendRequestModal(userId, username, profilePicture) {
    console.log('openFriendRequestModal called:', userId, username);
    friendRequestTarget = { userId, username, profilePicture };

    const nameEl = document.getElementById('friend-request-name');
    const avatarEl = document.getElementById('friend-request-avatar');
    const messageEl = document.getElementById('friend-request-message');
    const modal = document.getElementById('friend-request-modal');

    console.log('Modal elements:', { nameEl: !!nameEl, avatarEl: !!avatarEl, messageEl: !!messageEl, modal: !!modal });

    if (nameEl) nameEl.textContent = username;
    if (avatarEl) {
        if (profilePicture) {
            avatarEl.innerHTML = `<img src="${profilePicture}" class="w-full h-full object-cover">`;
        } else {
            avatarEl.innerHTML = '<span class="text-3xl">üë§</span>';
        }
    }
    if (messageEl) messageEl.value = '';

    if (modal) {
        modal.classList.remove('hidden');
        console.log('Friend request modal opened');
    } else {
        console.error('Friend request modal not found!');
    }
}

function closeFriendRequestModal() {
    document.getElementById('friend-request-modal').classList.add('hidden');
    friendRequestTarget = null;
}

async function submitFriendRequest() {
    if (!friendRequestTarget) return;

    const message = document.getElementById('friend-request-message').value.trim();

    try {
        const response = await fetch('/api/friends/request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                to_user_id: friendRequestTarget.userId,
                message: message || null
            })
        });

        if (response.ok) {
            const result = await response.json();
            if (result.status === 'accepted') {
                showToast('You are now friends!', 'success');
                loadFriendsPreview();
            } else {
                showToast('Friend request sent!', 'success');
            }
            closeFriendRequestModal();
            closeMemberProfileModal();
            // Refresh member profile if still viewing
            if (currentProfileMember) {
                updateFriendActionButton(result.status === 'accepted' ? 'friends' : 'pending_outgoing');
            }
        } else {
            const error = await response.json();
            showToast(error.detail || 'Failed to send request', 'error');
        }
    } catch (error) {
        console.error('Error sending friend request:', error);
        showToast('Failed to send request', 'error');
    }
}

function handleFriendAction() {
    console.log('handleFriendAction called, currentProfileMember:', currentProfileMember);
    if (!currentProfileMember) {
        console.error('No currentProfileMember');
        return;
    }

    const status = currentProfileMember.friendship_status || 'none';
    console.log('Friendship status:', status);

    switch (status) {
        case 'none':
            console.log('Opening friend request modal');
            openFriendRequestModal(
                currentProfileMember.id,
                currentProfileMember.username,
                currentProfileMember.profile_picture
            );
            break;
        case 'pending_outgoing':
            if (currentProfileMember.friendship_request_id) {
                if (confirm('Cancel your friend request?')) {
                    cancelFriendRequestAndUpdate(currentProfileMember.friendship_request_id);
                }
            }
            break;
        case 'pending_incoming':
            if (currentProfileMember.friendship_request_id) {
                respondToFriendRequestAndUpdate(currentProfileMember.friendship_request_id, true);
            }
            break;
        case 'friends':
            if (confirm(`Remove ${currentProfileMember.username} from friends?`)) {
                removeFriendAndUpdate(currentProfileMember.id);
            }
            break;
        default:
            console.log('Unknown friendship status:', status);
    }
}

async function cancelFriendRequestAndUpdate(requestId) {
    await cancelFriendRequest(requestId);
    updateFriendActionButton('none');
    currentProfileMember.friendship_status = 'none';
}

async function respondToFriendRequestAndUpdate(requestId, accept) {
    await respondToFriendRequest(requestId, accept);
    if (accept) {
        updateFriendActionButton('friends');
        currentProfileMember.friendship_status = 'friends';
        currentProfileMember.is_friend = true;
        loadFriendProgress(currentProfileMember.id);
    } else {
        updateFriendActionButton('none');
        currentProfileMember.friendship_status = 'none';
    }
}

async function removeFriendAndUpdate(friendId) {
    await removeFriend(friendId);
    updateFriendActionButton('none');
    currentProfileMember.friendship_status = 'none';
    currentProfileMember.is_friend = false;
    document.getElementById('friend-progress-section')?.classList.add('hidden');
}

function updateFriendActionButton(status) {
    const btn = document.getElementById('friend-action-btn');
    const text = document.getElementById('friend-action-text');
    if (!btn || !text) return;

    switch (status) {
        case 'none':
            text.textContent = 'Add Friend';
            btn.className = 'w-full py-2.5 bg-purple-500/20 text-purple-300 font-bold rounded-xl border border-purple-500/30 hover:bg-purple-500/30 transition tap-effect';
            break;
        case 'pending_outgoing':
            text.textContent = 'Request Sent (tap to cancel)';
            btn.className = 'w-full py-2.5 bg-gray-500/20 text-gray-400 font-bold rounded-xl border border-gray-500/30 hover:bg-gray-500/30 transition tap-effect';
            break;
        case 'pending_incoming':
            text.textContent = 'Accept Friend Request';
            btn.className = 'w-full py-2.5 bg-green-500/20 text-green-300 font-bold rounded-xl border border-green-500/30 hover:bg-green-500/30 transition tap-effect';
            break;
        case 'friends':
            text.textContent = 'Friends ‚úì';
            btn.className = 'w-full py-2.5 bg-purple-500 text-white font-bold rounded-xl hover:bg-purple-400 transition tap-effect';
            break;
    }
}

async function loadFriendProgress(friendId) {
    try {
        const response = await fetch(`/api/friends/${friendId}/progress`, { credentials: 'include' });
        if (!response.ok) return;

        const data = await response.json();
        renderFriendProgress(data);
        document.getElementById('friend-progress-section')?.classList.remove('hidden');
    } catch (error) {
        console.error('Error loading friend progress:', error);
    }
}

function renderFriendProgress(data) {
    // Render weight chart
    const weightChart = document.getElementById('friend-weight-chart');
    if (weightChart && data.weight_history && data.weight_history.length > 0) {
        const weights = data.weight_history.map(w => w.weight);
        const maxW = Math.max(...weights);
        const minW = Math.min(...weights);
        const range = maxW - minW || 1;

        // Show last 10 entries
        const recent = data.weight_history.slice(-10);
        weightChart.innerHTML = recent.map(entry => {
            const height = ((entry.weight - minW) / range) * 100;
            return `<div class="flex-1 bg-purple-500/50 rounded-t" style="height: ${Math.max(20, height)}%" title="${entry.weight}kg"></div>`;
        }).join('');
    } else if (weightChart) {
        weightChart.innerHTML = '<p class="text-xs text-gray-500 w-full text-center">No weight data</p>';
    }

    // Render health score bars
    const healthBars = document.getElementById('friend-health-bars');
    if (healthBars && data.weekly_health_scores && data.weekly_health_scores.length > 0) {
        healthBars.innerHTML = data.weekly_health_scores.map(entry => {
            const score = entry.score || 0;
            const color = score >= 80 ? 'bg-green-500' : score >= 60 ? 'bg-yellow-500' : 'bg-red-500';
            return `<div class="flex-1 ${color}/70 rounded-t" style="height: ${score}%" title="${score}%"></div>`;
        }).join('');
    } else if (healthBars) {
        healthBars.innerHTML = '<p class="text-xs text-gray-500 w-full text-center">No health data</p>';
    }
}

async function messageFromFriendsList(userId, username) {
    closeFriendsModal();
    if (typeof openChatModal === 'function') {
        openChatModal(userId, username);
    } else if (typeof openConversationsModal === 'function') {
        openConversationsModal();
    } else {
        showToast('Messaging not available', 'error');
    }
}

// --- MEMBER PROFILE FUNCTIONS ---

let currentProfileMember = null;

async function openMemberProfile(memberId) {
    try {
        const response = await fetch(`/api/client/member/${memberId}`, { credentials: 'include' });
        if (!response.ok) throw new Error('Failed to load profile');

        const member = await response.json();
        currentProfileMember = member;

        // Update modal content
        document.getElementById('member-profile-name').textContent = member.username;
        document.getElementById('member-profile-bio').textContent = member.bio || '';
        document.getElementById('member-profile-streak').textContent = member.streak || 0;
        document.getElementById('member-profile-gems').textContent = member.gems || 0;
        document.getElementById('member-profile-health').textContent = member.health_score || 0;

        // Update avatar
        const avatarEl = document.getElementById('member-profile-avatar');
        if (member.profile_picture) {
            avatarEl.innerHTML = `<img src="${member.profile_picture}" class="w-full h-full object-cover">`;
        } else {
            avatarEl.innerHTML = '<span class="text-2xl">üë§</span>';
        }

        // Update progress chart based on member's health score
        updateMemberProgressChart(member.health_score || 0, member.streak || 0);

        // Update friend action button based on friendship status
        const friendshipStatus = member.friendship_status || 'none';
        updateFriendActionButton(friendshipStatus);

        // Show/hide friend progress section
        const progressSection = document.getElementById('friend-progress-section');
        if (member.is_friend) {
            loadFriendProgress(memberId);
        } else {
            progressSection?.classList.add('hidden');
        }

        // Show modal
        document.getElementById('member-profile-modal').classList.remove('hidden');

    } catch (error) {
        console.error('Error loading member profile:', error);
        showToast('Failed to load profile', 'error');
    }
}

function closeMemberProfileModal() {
    document.getElementById('member-profile-modal').classList.add('hidden');
    document.getElementById('friend-progress-section')?.classList.add('hidden');
    currentProfileMember = null;
}

function updateMemberProgressChart(healthScore, streak) {
    const chartEl = document.getElementById('member-progress-chart');
    if (!chartEl) return;

    const days = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
    const today = new Date().getDay(); // 0=Sunday, 1=Monday, etc
    const todayIndex = today === 0 ? 6 : today - 1; // Convert to 0=Monday

    // Determine active days based on streak
    const activeDays = Math.min(streak, 7);

    let html = '';
    days.forEach((day, index) => {
        const isPast = index <= todayIndex;
        const isToday = index === todayIndex;

        // Active if within streak and not future
        const isActive = isPast && (todayIndex - index) < activeDays;

        const bgClass = isActive ? 'bg-orange-500' : 'bg-orange-500/20';
        const borderClass = isActive ? 'border-orange-400' : 'border-orange-500/30';
        const textClass = isActive ? 'text-white font-bold' : (isToday ? 'text-orange-400' : 'text-gray-500');

        html += `
            <div class="flex-1 flex flex-col items-center gap-1">
                <div class="w-8 h-8 rounded-full ${bgClass} border ${borderClass} flex items-center justify-center transition-all">
                    <span class="text-xs ${textClass}">${day}</span>
                </div>
            </div>
        `;
    });

    chartEl.innerHTML = html;
}

async function messageFromProfile() {
    if (!currentProfileMember) return;

    const userId = currentProfileMember.id;
    const username = currentProfileMember.username;
    const profilePicture = currentProfileMember.profile_picture;

    try {
        // Check if we can message this user
        const response = await fetch(`/api/client/can-message/${userId}`, { credentials: 'include' });
        if (!response.ok) throw new Error('Failed to check messaging status');

        const result = await response.json();

        if (result.can_message) {
            // Can message directly - open chat
            closeMemberProfileModal();
            closeGymMembersModal();
            if (typeof openChatModal === 'function') {
                openChatModal(userId, username);
            } else if (typeof window.openChatWithUser === 'function') {
                window.openChatWithUser(userId, username, profilePicture);
            } else {
                showToast('Messaging not available', 'error');
            }
        } else if (result.reason === 'staff_only') {
            showToast('This user only accepts messages from gym staff', 'info');
        } else if (result.reason === 'request_pending') {
            showToast('Your chat request is still pending', 'info');
        } else if (result.needs_request) {
            // Need to send chat request - show modal
            closeMemberProfileModal();
            openChatRequestModal(userId, username, profilePicture);
        } else {
            showToast('Cannot message this user', 'error');
        }
    } catch (error) {
        console.error('Error initiating chat:', error);
        showToast('Failed to start chat', 'error');
    }
}

// Load gym members preview on page load
loadGymMembersPreview();

// Load friends preview on page load
loadFriendsPreview();
</script>

{% endif %}
{% endblock %}