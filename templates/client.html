{% extends "base.html" %}
{% from 'macros.html' import card %}

{% block content %}
{% if mode == "leaderboard" %}
<!-- Header -->
<div class="p-6 pt-10 flex justify-between items-center bg-gradient-to-b from-black/80 to-transparent z-10">
    <div class="flex items-center space-x-3">
        <a href="{{ 'client.html' if static_build else '/?gym_id=' + gym_id + '&role=client' }}"
            class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center tap-effect">
            <i data-lucide="arrow-left" class="w-5 h-5"></i>
        </a>
        <h2 class="font-bold text-xl">Classifica</h2>
    </div>
    <div class="flex items-center space-x-2">
        <div class="flex items-center gap-1 bg-yellow-500/20 border border-yellow-500/30 px-3 py-1.5 rounded-full">
            <span class="text-sm">ðŸ”¶</span>
            <span class="text-sm font-bold text-yellow-400" id="gem-count">0</span>
        </div>
        <div onclick="openClientChatModal()" class="relative w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center tap-effect cursor-pointer">
            <i data-lucide="message-circle" class="w-5 h-5"></i>
        </div>
        <div data-action="showModal" data-target="notification-modal"
            class="notification-bell w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center tap-effect relative">
            <i data-lucide="bell" class="w-5 h-5"></i>
            <span class="notification-badge hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">0</span>
        </div>
    </div>
</div>

<div class="flex-1 p-4 space-y-5 pb-32">

    <!-- League Tier Badges -->
    <div id="league-tiers-container" class="flex items-end justify-center gap-3 py-2">
        <!-- Rendered by JS: 5 shield badges -->
    </div>

    <!-- League Info -->
    <div class="text-center space-y-1">
        <h3 id="league-name" class="text-2xl font-black text-white">Caricamento...</h3>
        <p id="league-subtitle" class="text-xs text-gray-400">I primi 10 avanzano alla lega successiva</p>
    </div>

    <!-- Countdown Timer -->
    <div class="flex items-center justify-center gap-2">
        <i data-lucide="timer" class="w-4 h-4 text-yellow-500"></i>
        <span id="weekly-countdown" class="text-sm font-medium text-yellow-500"></span>
    </div>

    <!-- Weekly Challenge (compact) -->
    <div class="glass-card p-4 relative overflow-hidden">
        <div class="absolute top-0 right-0 w-32 h-32 bg-purple-500/10 blur-3xl rounded-full -mr-8 -mt-8"></div>
        <div class="relative z-10">
            <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2">
                    <i data-lucide="target" class="w-4 h-4 text-purple-400"></i>
                    <span class="text-xs text-gray-400 uppercase tracking-wider font-medium">Sfida Settimanale</span>
                </div>
                <span class="text-xs text-yellow-400 font-bold"><span id="challenge-reward">0</span> ðŸ”¶</span>
            </div>
            <p class="text-sm font-bold text-white" id="challenge-title">...</p>
            <div class="mt-2 flex items-center gap-3">
                <div class="flex-1 h-2 bg-white/10 rounded-full overflow-hidden">
                    <div id="challenge-bar"
                        class="h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all duration-500"
                        style="width: 0%"></div>
                </div>
                <span class="text-xs text-white font-bold whitespace-nowrap">
                    <span id="challenge-progress">0</span>/<span id="challenge-target">0</span>
                </span>
            </div>
        </div>
    </div>

    <!-- Rankings -->
    <div>
        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3 ml-1">Classifiche</h3>
        <div id="leaderboard-list" class="space-y-2"></div>
    </div>

    <!-- Daily Quests (collapsible) -->
    <div>
        <button onclick="toggleQuestSection()"
            class="w-full flex items-center justify-between py-3 tap-effect">
            <div class="flex items-center gap-2">
                <i data-lucide="scroll-text" class="w-4 h-4 text-orange-400"></i>
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Sfide Giornaliere</h3>
                <span id="quest-progress-badge"
                    class="text-[10px] bg-orange-500/20 text-orange-400 px-2 py-0.5 rounded-full font-bold">0/0</span>
            </div>
            <i data-lucide="chevron-down" id="quest-chevron"
                class="w-4 h-4 text-gray-500 transition-transform duration-300"></i>
        </button>
        <div id="quest-section" class="space-y-3 transition-all duration-300 overflow-hidden">
            <div id="quest-list" class="space-y-3"></div>
        </div>
    </div>

</div>

<!-- Member Profile Modal (for leaderboard) -->
<div id="member-profile-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeMemberProfileModal()">
    <div class="glass-card p-5 rounded-2xl max-w-sm w-full">
        <div class="flex justify-between items-start mb-4">
            <div class="flex items-center gap-3">
                <div id="member-profile-avatar" class="w-14 h-14 rounded-full bg-orange-500/20 flex items-center justify-center overflow-hidden border-2 border-orange-500/30">
                    <i data-lucide="user" class="w-6 h-6"></i>
                </div>
                <div>
                    <h3 id="member-profile-name" class="text-lg font-bold text-white">Username</h3>
                    <p id="member-profile-bio" class="text-gray-400 text-xs max-w-[180px] truncate"></p>
                </div>
            </div>
            <button onclick="closeMemberProfileModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>
        <div class="grid grid-cols-3 gap-2 mb-4">
            <div class="bg-white/5 rounded-xl p-3 text-center border border-white/5">
                <div class="flex items-center justify-center gap-1">
                    <i data-lucide="flame" class="w-4 h-4"></i>
                    <p id="member-profile-streak" class="text-xl font-bold text-orange-400">0</p>
                </div>
                <p class="text-[10px] text-gray-500 uppercase font-medium mt-1">Serie</p>
            </div>
            <div class="bg-white/5 rounded-xl p-3 text-center border border-white/5">
                <div class="flex items-center justify-center gap-1">
                    <span class="text-sm">ðŸ”¶</span>
                    <p id="member-profile-gems" class="text-xl font-bold text-orange-400">0</p>
                </div>
                <p class="text-[10px] text-gray-500 uppercase font-medium mt-1">Gemme</p>
            </div>
            <div class="bg-white/5 rounded-xl p-3 text-center border border-white/5">
                <div class="flex items-center justify-center gap-0.5">
                    <p id="member-profile-health" class="text-xl font-bold text-green-400">0</p>
                    <span class="text-xs text-green-400 font-bold">%</span>
                </div>
                <p class="text-[10px] text-gray-500 uppercase font-medium mt-1">Dieta</p>
            </div>
        </div>

        <!-- Weekly Activity -->
        <div class="bg-white/5 rounded-xl p-4 mb-4 border border-white/5">
            <div class="flex justify-between items-center mb-3">
                <span class="text-xs text-gray-400 uppercase tracking-wider font-medium">AttivitÃ  Settimanale</span>
                <span class="text-[10px] text-orange-400">Ultimi 7 giorni</span>
            </div>
            <!-- Activity Dots -->
            <div id="member-progress-chart" class="flex items-center justify-between">
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">L</span>
                    </div>
                </div>
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">M</span>
                    </div>
                </div>
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">M</span>
                    </div>
                </div>
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">G</span>
                    </div>
                </div>
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">V</span>
                    </div>
                </div>
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">S</span>
                    </div>
                </div>
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">D</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Friend-only Progress Section (hidden by default) -->
        <div id="friend-progress-section" class="hidden mb-4">
            <div class="bg-gradient-to-br from-purple-500/10 to-pink-500/10 rounded-xl p-4 border border-purple-500/20">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <i data-lucide="bar-chart-3" class="w-4 h-4 text-purple-400"></i>
                        <span class="text-xs text-purple-300 uppercase tracking-wider font-medium">Progressi Amici</span>
                    </div>
                    <!-- View Tabs -->
                    <div class="flex gap-1 bg-white/5 rounded-lg p-0.5">
                        <button onclick="switchFriendProgressTab('strength')" id="friend-tab-strength" class="px-2 py-1 text-[10px] font-semibold rounded-md bg-purple-500 text-white transition">Forza</button>
                        <button onclick="switchFriendProgressTab('weight')" id="friend-tab-weight" class="px-2 py-1 text-[10px] font-semibold rounded-md text-gray-400 hover:text-white transition">Peso</button>
                        <button onclick="switchFriendProgressTab('health')" id="friend-tab-health" class="px-2 py-1 text-[10px] font-semibold rounded-md text-gray-400 hover:text-white transition">Salute</button>
                    </div>
                </div>

                <!-- Strength Progress View -->
                <div id="friend-strength-view" class="space-y-3">
                    <!-- Strength Chart -->
                    <div class="relative w-full" style="aspect-ratio: 16/9; min-height: 100px; max-height: 160px;">
                        <canvas id="friend-strength-chart" class="absolute inset-0 w-full h-full"></canvas>
                    </div>
                    <!-- Strength Stats with Goals -->
                    <div id="friend-strength-stats" class="grid grid-cols-3 gap-2">
                        <div class="bg-white/5 rounded-lg p-2 text-center">
                            <p class="text-[9px] text-gray-400 uppercase">Parte Sup.</p>
                            <p id="friend-strength-upper" class="text-sm font-bold text-orange-400">--%</p>
                            <p id="friend-goal-upper" class="text-[9px] text-gray-500">Obiettivo: --</p>
                        </div>
                        <div class="bg-white/5 rounded-lg p-2 text-center">
                            <p class="text-[9px] text-gray-400 uppercase">Parte Inf.</p>
                            <p id="friend-strength-lower" class="text-sm font-bold text-purple-400">--%</p>
                            <p id="friend-goal-lower" class="text-[9px] text-gray-500">Obiettivo: --</p>
                        </div>
                        <div class="bg-white/5 rounded-lg p-2 text-center">
                            <p class="text-[9px] text-gray-400 uppercase">Cardio</p>
                            <p id="friend-strength-cardio" class="text-sm font-bold text-green-400">--%</p>
                            <p id="friend-goal-cardio" class="text-[9px] text-gray-500">Obiettivo: --</p>
                        </div>
                    </div>
                </div>

                <!-- Weight Trend View -->
                <div id="friend-weight-view" class="hidden">
                    <p class="text-[10px] text-gray-400 mb-1">Andamento Peso (30 giorni)</p>
                    <div id="friend-weight-chart" class="h-20 flex items-end gap-1">
                        <!-- Bars will be rendered here -->
                    </div>
                    <div class="flex justify-between mt-2 text-[10px] text-gray-500">
                        <span id="friend-weight-start">--</span>
                        <span id="friend-weight-current" class="font-bold text-white">Current: --</span>
                    </div>
                </div>

                <!-- Health Score View -->
                <div id="friend-health-view" class="hidden">
                    <p class="text-[10px] text-gray-400 mb-1">Punteggio Salute (7 giorni)</p>
                    <div id="friend-health-bars" class="flex items-end justify-between h-16 gap-1">
                        <!-- Bars will be rendered here -->
                    </div>
                    <p id="friend-health-avg" class="text-[10px] text-gray-500 mt-2 text-center">Avg: --</p>
                </div>
            </div>
        </div>

        <!-- Friend Action Button -->
        <div id="friend-action-container" class="mb-3">
            <button id="friend-action-btn" onclick="handleFriendAction()"
                class="w-full py-2.5 bg-purple-500/20 text-purple-300 font-bold rounded-xl border border-purple-500/30 hover:bg-purple-500/30 transition tap-effect">
                <span id="friend-action-text">Aggiungi Amico</span>
            </button>
        </div>

        <button id="member-profile-message-btn" onclick="messageFromLeaderboard()"
            class="w-full py-3 bg-orange-500 text-white font-bold rounded-xl hover:bg-orange-400 transition tap-effect">
            Messaggio
        </button>
    </div>
</div>

<!-- Friend Request Modal (for leaderboard) -->
<div id="friend-request-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeFriendRequestModal()">
    <div class="glass-card p-6 rounded-2xl max-w-sm w-full">
        <div class="text-center mb-4">
            <div id="friend-request-avatar" class="w-20 h-20 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center mx-auto mb-3 overflow-hidden">
                <i data-lucide="user" class="w-8 h-8"></i>
            </div>
            <h3 id="friend-request-name" class="text-xl font-bold">Username</h3>
            <p class="text-gray-400 text-sm mt-1">Invia una richiesta di amicizia</p>
        </div>
        <div class="space-y-3">
            <textarea id="friend-request-message" rows="2"
                class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white placeholder-gray-500 resize-none outline-none focus:border-purple-500"
                placeholder="Aggiungi un messaggio (opzionale)..."></textarea>
            <button onclick="submitFriendRequest()" class="w-full py-3 bg-purple-500 text-white font-bold rounded-xl hover:bg-purple-400 transition tap-effect">
                Invia Richiesta di Amicizia
            </button>
            <button onclick="closeFriendRequestModal()" class="w-full py-2 bg-white/10 text-gray-300 font-medium rounded-xl hover:bg-white/20 transition tap-effect">
                Annulla
            </button>
        </div>
    </div>
</div>

<script>
let currentProfileMember = null;
let friendRequestTarget = null;

async function openMemberProfile(memberId) {
    try {
        const response = await fetch(`/api/client/member/${memberId}`, { credentials: 'include' });
        if (!response.ok) throw new Error('Failed to load profile');

        const member = await response.json();
        currentProfileMember = member;

        document.getElementById('member-profile-name').textContent = member.name || member.username;
        document.getElementById('member-profile-bio').textContent = member.bio || '';
        document.getElementById('member-profile-streak').textContent = member.streak || 0;
        document.getElementById('member-profile-gems').textContent = member.gems || 0;
        document.getElementById('member-profile-health').textContent = member.health_score || 0;

        const avatarEl = document.getElementById('member-profile-avatar');
        if (member.profile_picture) {
            avatarEl.innerHTML = `<img src="${member.profile_picture}" class="w-full h-full object-cover">`;
        } else {
            avatarEl.innerHTML = '<i data-lucide="user" class="w-6 h-6"></i>';
        }

        // Update weekly activity chart
        updateMemberProgressChart(member.health_score || 0, member.streak || 0);

        // Update friend action button
        const friendshipStatus = member.friendship_status || 'none';
        updateFriendActionButton(friendshipStatus);

        // Show/hide friend progress section
        console.log('[MemberProfile] is_friend:', member.is_friend, 'friendship_status:', member.friendship_status);
        const progressSection = document.getElementById('friend-progress-section');
        if (member.is_friend) {
            console.log('[MemberProfile] Loading friend progress...');
            loadFriendProgress(memberId);
        } else {
            console.log('[MemberProfile] Not friends, hiding progress section');
            progressSection?.classList.add('hidden');
        }

        document.getElementById('member-profile-modal').classList.remove('hidden');
    } catch (error) {
        console.error('Error loading member profile:', error);
        if (typeof showToast === 'function') showToast('Impossibile caricare il profilo', 'error');
    }
}

function closeMemberProfileModal() {
    document.getElementById('member-profile-modal').classList.add('hidden');
    document.getElementById('friend-progress-section')?.classList.add('hidden');
    currentProfileMember = null;
}

function messageFromLeaderboard() {
    if (!currentProfileMember) return;
    closeMemberProfileModal();
    if (typeof window.openChatWithUser === 'function') {
        window.openChatWithUser(currentProfileMember.id, currentProfileMember.name || currentProfileMember.username, currentProfileMember.profile_picture);
    }
}

function updateFriendActionButton(status) {
    const btn = document.getElementById('friend-action-btn');
    const text = document.getElementById('friend-action-text');
    if (!btn || !text) return;

    switch (status) {
        case 'none':
            text.textContent = 'Aggiungi Amico';
            btn.className = 'w-full py-2.5 bg-purple-500/20 text-purple-300 font-bold rounded-xl border border-purple-500/30 hover:bg-purple-500/30 transition tap-effect';
            break;
        case 'pending_outgoing':
            text.textContent = 'Richiesta Inviata';
            btn.className = 'w-full py-2.5 bg-gray-500/20 text-gray-400 font-bold rounded-xl border border-gray-500/30 transition tap-effect';
            break;
        case 'pending_incoming':
            text.textContent = 'Accetta Richiesta di Amicizia';
            btn.className = 'w-full py-2.5 bg-green-500/20 text-green-300 font-bold rounded-xl border border-green-500/30 hover:bg-green-500/30 transition tap-effect';
            break;
        case 'friends':
            text.textContent = 'Amici âœ“';
            btn.className = 'w-full py-2.5 bg-purple-500 text-white font-bold rounded-xl hover:bg-purple-400 transition tap-effect';
            break;
    }
}

function handleFriendAction() {
    console.log('handleFriendAction called, currentProfileMember:', currentProfileMember);
    if (!currentProfileMember) {
        console.error('No currentProfileMember set');
        alert('Error: No profile loaded');
        return;
    }
    const status = currentProfileMember.friendship_status || 'none';
    console.log('Friendship status:', status);

    switch (status) {
        case 'none':
            console.log('Opening friend request modal for:', currentProfileMember.id);
            openFriendRequestModal(currentProfileMember.id, currentProfileMember.name || currentProfileMember.username, currentProfileMember.profile_picture);
            break;
        case 'pending_outgoing':
            if (typeof showToast === 'function') showToast('Richiesta di amicizia giÃ  inviata', 'info');
            break;
        case 'pending_incoming':
            if (currentProfileMember.friendship_request_id) {
                respondToFriendRequest(currentProfileMember.friendship_request_id, true);
            }
            break;
        case 'friends':
            if (typeof showToast === 'function') showToast('Siete giÃ  amici!', 'info');
            break;
        default:
            console.log('Unknown status:', status);
    }
}

function openFriendRequestModal(userId, username, profilePicture) {
    console.log('openFriendRequestModal called:', userId, username);
    friendRequestTarget = { userId, username, profilePicture };

    const nameEl = document.getElementById('friend-request-name');
    const avatarEl = document.getElementById('friend-request-avatar');
    const messageEl = document.getElementById('friend-request-message');
    const modal = document.getElementById('friend-request-modal');

    console.log('Modal elements found:', { nameEl: !!nameEl, avatarEl: !!avatarEl, messageEl: !!messageEl, modal: !!modal });

    if (!modal) {
        console.error('Friend request modal not found!');
        alert('Error: Modal not found');
        return;
    }

    if (nameEl) nameEl.textContent = username;
    if (avatarEl) {
        if (profilePicture) {
            avatarEl.innerHTML = `<img src="${profilePicture}" class="w-full h-full object-cover">`;
        } else {
            avatarEl.innerHTML = '<i data-lucide="user" class="w-8 h-8"></i>';
        }
    }
    if (messageEl) messageEl.value = '';

    modal.classList.remove('hidden');
    console.log('Modal should now be visible');
}

function closeFriendRequestModal() {
    document.getElementById('friend-request-modal').classList.add('hidden');
    friendRequestTarget = null;
}

async function submitFriendRequest() {
    if (!friendRequestTarget) return;

    const message = document.getElementById('friend-request-message').value.trim();

    try {
        const response = await fetch('/api/friends/request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                to_user_id: friendRequestTarget.userId,
                message: message || null
            })
        });

        if (response.ok) {
            const result = await response.json();
            if (result.status === 'accepted') {
                if (typeof showToast === 'function') showToast('Ora siete amici!', 'success');
                updateFriendActionButton('friends');
                if (currentProfileMember) currentProfileMember.friendship_status = 'friends';
            } else {
                if (typeof showToast === 'function') showToast('Richiesta di amicizia inviata!', 'success');
                updateFriendActionButton('pending_outgoing');
                if (currentProfileMember) currentProfileMember.friendship_status = 'pending_outgoing';
            }
            closeFriendRequestModal();
        } else {
            const error = await response.json();
            if (typeof showToast === 'function') showToast(error.detail || 'Impossibile inviare la richiesta', 'error');
        }
    } catch (error) {
        console.error('Error sending friend request:', error);
        if (typeof showToast === 'function') showToast('Impossibile inviare la richiesta', 'error');
    }
}

async function respondToFriendRequest(requestId, accept) {
    try {
        const response = await fetch('/api/friends/request/respond', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ request_id: requestId, accept })
        });

        if (response.ok) {
            if (accept) {
                if (typeof showToast === 'function') showToast('Amico aggiunto!', 'success');
                updateFriendActionButton('friends');
                if (currentProfileMember) {
                    currentProfileMember.friendship_status = 'friends';
                    currentProfileMember.is_friend = true;
                    // Load friend progress now that they're friends
                    loadFriendProgress(currentProfileMember.id);
                }
            }
        } else {
            const error = await response.json();
            if (typeof showToast === 'function') showToast(error.detail || 'Impossibile rispondere', 'error');
        }
    } catch (error) {
        console.error('Error responding to friend request:', error);
        if (typeof showToast === 'function') showToast('Impossibile rispondere', 'error');
    }
}

function updateMemberProgressChart(healthScore, streak) {
    const chartEl = document.getElementById('member-progress-chart');
    if (!chartEl) return;

    const days = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
    const today = new Date().getDay(); // 0=Sunday, 1=Monday, etc
    const todayIndex = today === 0 ? 6 : today - 1; // Convert to 0=Monday

    // Determine active days based on streak
    const activeDays = Math.min(streak, 7);

    let html = '';
    days.forEach((day, index) => {
        const isPast = index <= todayIndex;
        const isToday = index === todayIndex;

        // Active if within streak and not future
        const isActive = isPast && (todayIndex - index) < activeDays;

        const bgClass = isActive ? 'bg-orange-500' : 'bg-orange-500/20';
        const borderClass = isActive ? 'border-orange-400' : 'border-orange-500/30';
        const textClass = isActive ? 'text-white font-bold' : (isToday ? 'text-orange-400' : 'text-gray-500');

        html += `
            <div class="flex-1 flex flex-col items-center gap-1">
                <div class="w-8 h-8 rounded-full ${bgClass} border ${borderClass} flex items-center justify-center transition-all">
                    <span class="text-xs ${textClass}">${day}</span>
                </div>
            </div>
        `;
    });

    chartEl.innerHTML = html;
}

async function loadFriendProgress(friendId) {
    console.log('[FriendProgress] Loading progress for friend:', friendId);
    try {
        const response = await fetch(`/api/friends/${friendId}/progress`, { credentials: 'include' });
        console.log('[FriendProgress] Response status:', response.status);
        if (!response.ok) {
            const errorText = await response.text();
            console.error('[FriendProgress] API error:', errorText);
            return;
        }

        const data = await response.json();
        console.log('[FriendProgress] Data received:', data);

        // Show section FIRST so canvas has dimensions
        const section = document.getElementById('friend-progress-section');
        console.log('[FriendProgress] Section element:', section);
        if (section) {
            section.classList.remove('hidden');
            console.log('[FriendProgress] Section should now be visible');
        }

        // Then render charts
        renderFriendProgress(data);
    } catch (error) {
        console.error('[FriendProgress] Error:', error);
    }
}

let currentFriendProgressData = null;

function renderFriendProgress(data) {
    currentFriendProgressData = data;

    // Wait for DOM to compute dimensions before rendering charts
    requestAnimationFrame(() => {
        setTimeout(() => {
            // Render strength chart
            renderFriendStrengthChart(data);

            // Render strength stats with goals
            renderFriendStrengthStats(data);

            // Render weight chart
            renderFriendWeightChart(data);

            // Render health score bars
            renderFriendHealthBars(data);
        }, 50);
    });
}

function switchFriendProgressTab(tab) {
    const tabs = ['strength', 'weight', 'health'];
    tabs.forEach(t => {
        const tabBtn = document.getElementById(`friend-tab-${t}`);
        const view = document.getElementById(`friend-${t}-view`);
        if (tabBtn && view) {
            if (t === tab) {
                tabBtn.className = 'px-2 py-1 text-[10px] font-semibold rounded-md bg-purple-500 text-white transition';
                view.classList.remove('hidden');
            } else {
                tabBtn.className = 'px-2 py-1 text-[10px] font-semibold rounded-md text-gray-400 hover:text-white transition';
                view.classList.add('hidden');
            }
        }
    });
}

function renderFriendStrengthChart(data) {
    const canvas = document.getElementById('friend-strength-chart');
    if (!canvas) return;

    const strengthData = data.strength_by_category;
    if (!strengthData || !strengthData.categories) {
        const ctx = canvas.getContext('2d');
        const rect = canvas.getBoundingClientRect();
        ctx.fillStyle = '#6b7280';
        ctx.font = '11px system-ui';
        ctx.textAlign = 'center';
        ctx.fillText('Nessun dato sulla forza disponibile', rect.width / 2, rect.height / 2);
        return;
    }

    const ctx = canvas.getContext('2d');
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 2;
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.scale(dpr, dpr);

    const width = rect.width;
    const height = rect.height;
    const padding = { top: 15, right: 10, bottom: 20, left: 30 };
    const chartWidth = width - padding.left - padding.right;
    const chartHeight = height - padding.top - padding.bottom;

    // Clear canvas
    ctx.clearRect(0, 0, width, height);

    // Get all data points
    const categories = ['upper_body', 'lower_body', 'cardio'];
    const colors = {
        upper_body: '#F97316',
        lower_body: '#8B5CF6',
        cardio: '#22C55E'
    };

    let allValues = [];
    let referenceData = null;

    categories.forEach(cat => {
        const catData = strengthData.categories[cat]?.data || [];
        catData.forEach(d => {
            if (d.strength !== null) allValues.push(d.strength);
        });
        if (!referenceData && catData.length > 0) referenceData = catData;
    });

    if (!referenceData || allValues.length === 0) {
        ctx.fillStyle = '#6b7280';
        ctx.font = '11px system-ui';
        ctx.textAlign = 'center';
        ctx.fillText('Nessun dato sulla forza', width / 2, height / 2);
        return;
    }

    // Include goals in scaling
    const goals = data.strength_goals || {};
    if (goals.upper) allValues.push(goals.upper);
    if (goals.lower) allValues.push(goals.lower);
    if (goals.cardio) allValues.push(goals.cardio);

    const minStrength = Math.min(...allValues) - 5;
    const maxStrength = Math.max(...allValues) + 5;
    const strengthRange = maxStrength - minStrength || 1;

    // Draw grid
    ctx.strokeStyle = 'rgba(255,255,255,0.05)';
    ctx.lineWidth = 1;
    for (let i = 0; i <= 4; i++) {
        const y = padding.top + (chartHeight * i / 4);
        ctx.beginPath();
        ctx.moveTo(padding.left, y);
        ctx.lineTo(width - padding.right, y);
        ctx.stroke();
    }

    // Draw goal lines
    const goalConfig = {
        upper_body: { goal: goals.upper, color: colors.upper_body },
        lower_body: { goal: goals.lower, color: colors.lower_body },
        cardio: { goal: goals.cardio, color: colors.cardio }
    };

    Object.entries(goalConfig).forEach(([key, config]) => {
        if (config.goal !== null && config.goal !== undefined) {
            const goalY = padding.top + chartHeight - ((config.goal - minStrength) / strengthRange * chartHeight);
            if (goalY >= padding.top && goalY <= padding.top + chartHeight) {
                ctx.save();
                ctx.strokeStyle = config.color;
                ctx.lineWidth = 1.5;
                ctx.setLineDash([4, 3]);
                ctx.globalAlpha = 0.6;
                ctx.beginPath();
                ctx.moveTo(padding.left, goalY);
                ctx.lineTo(width - padding.right, goalY);
                ctx.stroke();
                ctx.restore();
            }
        }
    });

    // Draw data lines
    categories.forEach(cat => {
        const catData = strengthData.categories[cat]?.data || [];
        if (catData.length === 0) return;

        const color = colors[cat];
        const points = catData.map((d, i) => ({
            x: padding.left + (chartWidth * i / (catData.length - 1 || 1)),
            y: d.strength !== null ? padding.top + chartHeight - ((d.strength - minStrength) / strengthRange * chartHeight) : null
        })).filter(p => p.y !== null);

        if (points.length < 2) return;

        // Draw line
        ctx.beginPath();
        ctx.moveTo(points[0].x, points[0].y);
        points.forEach(p => ctx.lineTo(p.x, p.y));
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.setLineDash([]);
        ctx.stroke();

        // Draw last point
        const lastPoint = points[points.length - 1];
        ctx.beginPath();
        ctx.arc(lastPoint.x, lastPoint.y, 3, 0, Math.PI * 2);
        ctx.fillStyle = color;
        ctx.fill();
    });

    // Draw Y-axis labels
    ctx.fillStyle = '#9ca3af';
    ctx.font = '9px system-ui';
    ctx.textAlign = 'right';
    for (let i = 0; i <= 4; i++) {
        const val = Math.round(maxStrength - (strengthRange * i / 4));
        const y = padding.top + (chartHeight * i / 4);
        ctx.fillText(`${val}%`, padding.left - 4, y + 3);
    }
}

function renderFriendStrengthStats(data) {
    const strengthData = data.strength_by_category;
    const goals = data.strength_goals || {};

    // Update stats
    const categories = {
        upper: { el: 'friend-strength-upper', goalEl: 'friend-goal-upper', catKey: 'upper_body' },
        lower: { el: 'friend-strength-lower', goalEl: 'friend-goal-lower', catKey: 'lower_body' },
        cardio: { el: 'friend-strength-cardio', goalEl: 'friend-goal-cardio', catKey: 'cardio' }
    };

    Object.entries(categories).forEach(([key, config]) => {
        const statEl = document.getElementById(config.el);
        const goalEl = document.getElementById(config.goalEl);

        // Get current strength value
        let currentVal = null;
        if (strengthData?.categories?.[config.catKey]?.data) {
            const catData = strengthData.categories[config.catKey].data;
            const lastPoint = catData.filter(d => d.strength !== null).pop();
            if (lastPoint) currentVal = lastPoint.strength;
        }

        if (statEl) {
            if (currentVal !== null) {
                const prefix = currentVal >= 0 ? '+' : '';
                statEl.textContent = `${prefix}${Math.round(currentVal)}%`;
            } else {
                statEl.textContent = '--%';
            }
        }

        if (goalEl) {
            const goalVal = goals[key];
            if (goalVal !== null && goalVal !== undefined) {
                goalEl.textContent = `Obiettivo: +${goalVal}%`;
                goalEl.className = 'text-[9px] text-purple-400';
            } else {
                goalEl.textContent = 'Nessun obiettivo';
                goalEl.className = 'text-[9px] text-gray-500';
            }
        }
    });
}

function renderFriendWeightChart(data) {
    const weightChart = document.getElementById('friend-weight-chart');
    if (!weightChart) return;

    if (data.weight_history && data.weight_history.length > 0) {
        const weights = data.weight_history.map(w => w.weight);
        const maxW = Math.max(...weights);
        const minW = Math.min(...weights);
        const range = maxW - minW || 1;

        const recent = data.weight_history.slice(-10);
        weightChart.innerHTML = recent.map(entry => {
            const height = ((entry.weight - minW) / range) * 100;
            return `<div class="flex-1 bg-purple-500/50 rounded-t transition-all duration-300" style="height: ${Math.max(20, height)}%" title="${entry.weight}kg"></div>`;
        }).join('');

        // Update weight labels
        const startEl = document.getElementById('friend-weight-start');
        const currentEl = document.getElementById('friend-weight-current');
        if (startEl) startEl.textContent = `${recent[0].weight}kg`;
        if (currentEl) currentEl.textContent = `Attuale: ${data.current_weight || recent[recent.length - 1].weight}kg`;
    } else {
        weightChart.innerHTML = '<p class="text-xs text-gray-500 w-full text-center">Nessun dato sul peso</p>';
    }
}

function renderFriendHealthBars(data) {
    const healthBars = document.getElementById('friend-health-bars');
    if (!healthBars) return;

    if (data.weekly_health_scores && data.weekly_health_scores.length > 0) {
        let totalScore = 0;
        healthBars.innerHTML = data.weekly_health_scores.map(entry => {
            const score = entry.score || 0;
            totalScore += score;
            const color = score >= 80 ? 'bg-green-500' : score >= 60 ? 'bg-yellow-500' : 'bg-red-500';
            return `<div class="flex-1 ${color}/70 rounded-t transition-all duration-300" style="height: ${score}%" title="${score}%"></div>`;
        }).join('');

        const avgEl = document.getElementById('friend-health-avg');
        if (avgEl) {
            const avg = Math.round(totalScore / data.weekly_health_scores.length);
            avgEl.textContent = `Media: ${avg}%`;
        }
    } else {
        healthBars.innerHTML = '<p class="text-xs text-gray-500 w-full text-center">Nessun dato sulla salute</p>';
    }
}
</script>

{% elif mode == "progress" %}
<div id="progress-top-bar" class="fixed top-0 left-0 right-0 px-4 pb-3 flex justify-between items-center z-30 transition-all duration-200" style="padding-top: max(env(safe-area-inset-top, 0px), 2.5rem);">
    <div class="flex items-center">
        <img src="/static/fitos-logo.svg" class="h-7 object-contain">
    </div>
    <div class="flex items-center space-x-2">
        <div onclick="openBookingChoiceForMyTrainer()" class="relative w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center tap-effect cursor-pointer" title="Prenota Sessione">
            <i data-lucide="calendar" class="w-5 h-5"></i>
        </div>
        <div data-action="showModal" data-target="notification-modal"
            class="notification-bell w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center tap-effect relative">
            <i data-lucide="bell" class="w-5 h-5"></i>
            <span class="notification-badge hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">0</span>
        </div>
        <div onclick="openClientChatModal()" class="relative w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center tap-effect cursor-pointer">
            <i data-lucide="send" class="w-5 h-5"></i>
        </div>
    </div>
</div>
<script>
(function(){
    const bar = document.getElementById('progress-top-bar');
    if (!bar) return;
    let scrolled = false;
    window.addEventListener('scroll', function(){
        if(window.scrollY > 10 && !scrolled){
            scrolled = true;
            bar.style.backgroundColor = 'rgba(17,24,39,0.85)';
            bar.style.backdropFilter = 'blur(12px)';
            bar.style.webkitBackdropFilter = 'blur(12px)';
            bar.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
        } else if(window.scrollY <= 10 && scrolled){
            scrolled = false;
            bar.style.backgroundColor = '';
            bar.style.backdropFilter = '';
            bar.style.webkitBackdropFilter = '';
            bar.style.borderBottom = '';
        }
    });
})();
</script>
<div class="flex-1 p-4 space-y-4" style="padding-top: calc(max(env(safe-area-inset-top, 0px), 2.5rem) + 3.5rem);">

    <!-- Stats Carousel -->
    <div class="relative">
        <div id="stats-carousel" class="flex overflow-x-auto snap-x snap-mandatory scrollbar-hide -mx-4 px-4 gap-3" style="scroll-behavior: smooth;">
            <!-- Slide 1: Diet + Macros Combined -->
            <div class="snap-center flex-shrink-0 w-full">
                {% call card(classes="p-4 relative overflow-hidden") %}
                <div class="absolute top-0 right-0 w-32 h-32 bg-orange-500/10 blur-3xl rounded-full -mr-8 -mt-8"></div>
                <div class="relative z-10">
                    <div class="flex items-center gap-4">
                        <!-- Diet Score - Orange Circle -->
                        <div class="flex items-center gap-3 flex-shrink-0">
                            <div class="w-20 h-20 relative flex items-center justify-center">
                                <svg class="w-full h-full transform -rotate-90" viewBox="0 0 80 80">
                                    <circle cx="40" cy="40" r="34" stroke="rgba(255,255,255,0.1)" stroke-width="6" fill="none" />
                                    <circle cx="40" cy="40" r="34" stroke="#f97316" stroke-width="6" fill="none" stroke-dasharray="213.6"
                                        stroke-dashoffset="42" stroke-linecap="round" id="diet-progress-ring" />
                                </svg>
                                <i data-lucide="utensils" class="w-5 h-5 absolute text-orange-400"></i>
                            </div>
                            <div>
                                <p class="text-[10px] text-gray-400 uppercase tracking-wider font-bold">Dieta</p>
                                <p class="text-3xl font-black text-white leading-none"><span id="health-score">...</span><span class="text-xl text-orange-400">%</span></p>
                                <p class="text-[10px] text-orange-400 font-bold" id="diet-status">Continua cosi!</p>
                                <div class="mt-1 inline-flex items-center bg-white/10 rounded-full px-2 py-0.5">
                                    <span class="text-[9px] text-white font-medium" id="hero-cals-current">--</span>
                                    <span class="text-[9px] text-gray-400 mx-0.5">/</span>
                                    <span class="text-[9px] text-gray-400" id="hero-cals-target">--</span>
                                    <span class="text-[9px] text-gray-400 ml-0.5">kgcal</span>
                                </div>
                            </div>
                        </div>
                        <!-- Divider -->
                        <div class="w-px h-16 bg-white/10 flex-shrink-0"></div>
                        <!-- Macros: Carbs (orange), Grassi (blue), Pro (pink) -->
                        <div class="flex-1 flex items-center justify-evenly">
                            <div class="text-center">
                                <div id="hero-ring-carbs" class="w-11 h-11 mx-auto rounded-full flex items-center justify-center" style="background: conic-gradient(#f97316 0%, #333 0%);">
                                    <div class="w-8 h-8 rounded-full bg-gray-900 flex items-center justify-center">
                                        <span class="text-[10px] font-bold text-orange-400" id="hero-val-carbs">0g</span>
                                    </div>
                                </div>
                                <p class="text-[9px] text-gray-400 font-medium mt-1">Carbs</p>
                            </div>
                            <div class="text-center">
                                <div id="hero-ring-fat" class="w-11 h-11 mx-auto rounded-full flex items-center justify-center" style="background: conic-gradient(#60A5FA 0%, #333 0%);">
                                    <div class="w-8 h-8 rounded-full bg-gray-900 flex items-center justify-center">
                                        <span class="text-[10px] font-bold text-blue-400" id="hero-val-fat">0g</span>
                                    </div>
                                </div>
                                <p class="text-[9px] text-gray-400 font-medium mt-1">Grassi</p>
                            </div>
                            <div class="text-center">
                                <div id="hero-ring-protein" class="w-11 h-11 mx-auto rounded-full flex items-center justify-center" style="background: conic-gradient(#F472B6 0%, #333 0%);">
                                    <div class="w-8 h-8 rounded-full bg-gray-900 flex items-center justify-center">
                                        <span class="text-[10px] font-bold text-pink-400" id="hero-val-protein">0g</span>
                                    </div>
                                </div>
                                <p class="text-[9px] text-gray-400 font-medium mt-1">Pro</p>
                            </div>
                        </div>
                    </div>
                    <!-- VAI A DIETA Button -->
                    <a href="{{ '/?gym_id=' + gym_id + '&role=client&mode=progress' }}" class="block mt-4">
                        <div class="w-full py-3.5 bg-orange-500 hover:bg-orange-400 text-white text-center font-bold uppercase tracking-wider rounded-xl transition tap-effect text-sm">
                            VAI A DIETA
                        </div>
                    </a>
                </div>
                {% endcall %}
            </div>

            <!-- Slide 2: Weight Stats -->
            <div class="snap-center flex-shrink-0 w-full">
                {% call card(classes="p-4 relative overflow-hidden h-[137px]") %}
                <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500/10 blur-3xl rounded-full -mr-8 -mt-8"></div>
                <div class="relative z-10">
                    <div class="flex justify-between items-center mb-2">
                        <div>
                            <p class="text-[10px] text-gray-400 uppercase tracking-wider">Peso</p>
                            <div class="flex items-baseline gap-1">
                                <span class="text-2xl font-black text-white" id="hero-weight">--</span>
                                <span class="text-sm text-blue-400">kg</span>
                                <span id="hero-weight-trend" class="text-[10px] px-1.5 py-0.5 rounded-full bg-green-500/20 text-green-400 font-bold ml-1">--</span>
                            </div>
                        </div>
                        <button onclick="openWeightModal()" class="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center hover:bg-blue-500/30 transition tap-effect">
                            <i data-lucide="scale" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <!-- Mini Chart -->
                    <div class="h-12">
                        <canvas id="hero-weight-chart" class="w-full h-full"></canvas>
                    </div>
                </div>
                {% endcall %}
            </div>

            <!-- Slide 3: Weekly Consistency -->
            <div class="snap-center flex-shrink-0 w-full">
                {% call card(classes="p-4 flex flex-col justify-between h-[137px]") %}
                <div class="flex justify-between items-center">
                    <p class="text-[10px] text-gray-400 uppercase tracking-wider">Costanza</p>
                    <span class="text-[10px] px-1.5 py-0.5 rounded-full bg-green-500/20 text-green-400 font-bold" id="hero-consistency-score">--</span>
                </div>
                <div class="flex items-end justify-between h-16 mt-2 space-x-1" id="weekly-chart">
                    <!-- Bars injected by JS -->
                </div>
                <div class="flex justify-between mt-1">
                    <span class="text-[8px] text-gray-500">L</span>
                    <span class="text-[8px] text-gray-500">M</span>
                    <span class="text-[8px] text-gray-500">M</span>
                    <span class="text-[8px] text-gray-500">G</span>
                    <span class="text-[8px] text-gray-500">V</span>
                    <span class="text-[8px] text-gray-500">S</span>
                    <span class="text-[8px] text-gray-500">D</span>
                </div>
                {% endcall %}
            </div>
        </div>

        <!-- Carousel Dots -->
        <div class="flex justify-center gap-1.5 mt-2">
            <button onclick="scrollToSlide(0)" id="carousel-dot-0" class="w-2 h-2 rounded-full bg-white/60 transition"></button>
            <button onclick="scrollToSlide(1)" id="carousel-dot-1" class="w-2 h-2 rounded-full bg-white/20 transition"></button>
            <button onclick="scrollToSlide(2)" id="carousel-dot-2" class="w-2 h-2 rounded-full bg-white/20 transition"></button>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="flex space-x-2 overflow-x-auto pb-2 -mx-1 px-1">
        <button onclick="openManualMealModal()"
            class="flex-shrink-0 bg-transparent border-2 border-orange-500 px-3 py-2.5 rounded-full flex items-center space-x-1.5 tap-effect hover:bg-orange-500/10 transition">
            <i data-lucide="pencil" class="w-3.5 h-3.5 text-orange-400"></i> <span class="text-[10px] font-bold text-orange-400 uppercase tracking-wider">Aggiungi Pasto</span>
        </button>
        <button data-action="quickAction" data-type="scan"
            class="flex-shrink-0 bg-transparent border-2 border-orange-500 px-3 py-2.5 rounded-full flex items-center space-x-1.5 tap-effect hover:bg-orange-500/10 transition">
            <i data-lucide="camera" class="w-3.5 h-3.5 text-orange-400"></i> <span class="text-[10px] font-bold text-orange-400 uppercase tracking-wider">Scansiona Pasto</span>
        </button>
        <button data-action="quickAction" data-type="search"
            class="flex-shrink-0 bg-transparent border-2 border-orange-500 px-3 py-2.5 rounded-full flex items-center space-x-1.5 tap-effect hover:bg-orange-500/10 transition">
            <i data-lucide="search" class="w-3.5 h-3.5 text-orange-400"></i> <span class="text-[10px] font-bold text-orange-400 uppercase tracking-wider">Cerca</span>
        </button>
        <button data-action="quickAction" data-type="copy"
            class="flex-shrink-0 bg-transparent border-2 border-orange-500 px-3 py-2.5 rounded-full flex items-center space-x-1.5 tap-effect hover:bg-orange-500/10 transition">
            <i data-lucide="clipboard" class="w-3.5 h-3.5 text-orange-400"></i> <span class="text-[10px] font-bold text-orange-400 uppercase tracking-wider">Copia Ieri</span>
        </button>
    </div>

    <!-- Week Calendar Strip + Daily Meal Plan -->
    <div class="glass-card rounded-2xl overflow-hidden">
        <!-- Calendar header -->
        <div class="p-4 pb-3">
            <div class="flex justify-between items-center" id="week-days-container"></div>
        </div>

        <!-- Daily Meal Plan (shown for selected day) -->
        <div id="daily-meal-plan-section" class="border-t border-white/10">
            <!-- Plan header -->
            <div class="px-4 pt-3 pb-2 flex justify-between items-center">
                <p class="text-xs font-bold text-white/60 uppercase tracking-wider" id="meal-plan-day-label">Piano Alimentare - Oggi</p>
                <span class="text-[10px] text-orange-400 font-semibold" id="meal-plan-total-kcal"></span>
            </div>
            <!-- Meal list -->
            <div id="daily-meal-plan-list" class="px-4 pb-4 space-y-2">
                <p class="text-xs text-white/30 py-2">Caricamento piano...</p>
            </div>
        </div>
    </div>
    <script>
    (function(){
        var c = document.getElementById('week-days-container');
        if (!c) return;
        var labels = ['LUN','MAR','MER','GIO','VEN','SAB','DOM'];
        var now = new Date();
        var dow = now.getDay();
        var off = dow === 0 ? -6 : 1 - dow;
        var mon = new Date(now); mon.setDate(now.getDate() + off);

        // Store week data globally
        window._weekDays = [];
        for (var i = 0; i < 7; i++) {
            var d = new Date(mon); d.setDate(mon.getDate() + i);
            window._weekDays.push(d);
        }
        window._selectedDayIndex = (dow === 0 ? 6 : dow - 1); // Default to today (Monday=0)

        function renderWeekStrip() {
            c.innerHTML = '';
            for (var i = 0; i < 7; i++) {
                var d = window._weekDays[i];
                var selected = (i === window._selectedDayIndex);
                var el = document.createElement('div');
                el.style.cssText = 'display:flex;flex-direction:column;align-items:center;flex:1;gap:6px;cursor:pointer;-webkit-tap-highlight-color:transparent';
                el.dataset.dayIndex = i;
                if (selected) {
                    el.innerHTML = '<span style="font-size:10px;letter-spacing:0.05em;font-weight:700;color:#f97316;text-transform:uppercase">' + labels[i] + '</span>'
                        + '<span style="width:2.5rem;height:2.5rem;display:flex;align-items:center;justify-content:center;border-radius:9999px;font-size:1rem;font-weight:700;background:#f97316;color:#fff;box-shadow:0 4px 12px rgba(249,115,22,0.35);transition:all 0.2s">' + d.getDate() + '</span>';
                } else {
                    el.innerHTML = '<span style="font-size:10px;letter-spacing:0.05em;font-weight:500;color:#6b7280;text-transform:uppercase">' + labels[i] + '</span>'
                        + '<span style="width:2.5rem;height:2.5rem;display:flex;align-items:center;justify-content:center;border-radius:9999px;font-size:1rem;font-weight:700;color:#fff;transition:all 0.2s">' + d.getDate() + '</span>';
                }
                el.addEventListener('click', function() {
                    var idx = parseInt(this.dataset.dayIndex);
                    window._selectedDayIndex = idx;
                    renderWeekStrip();
                    loadDayMealPlan(idx);
                });
                c.appendChild(el);
            }
        }

        renderWeekStrip();

        // Load meal plan for today
        window._dayDietLogs = {}; // cache: 'YYYY-MM-DD' -> [logged meals]

        window.loadDayMealPlan = function(dayIndex) {
            var fullLabels = ['LunedÃ¬','MartedÃ¬','MercoledÃ¬','GiovedÃ¬','VenerdÃ¬','Sabato','Domenica'];
            var dayLabel = document.getElementById('meal-plan-day-label');
            var now = new Date();
            var todayIdx = (now.getDay() === 0 ? 6 : now.getDay() - 1);
            dayLabel.textContent = 'Piano Alimentare - ' + (dayIndex === todayIdx ? 'Oggi' : fullLabels[dayIndex]);

            var list = document.getElementById('daily-meal-plan-list');
            var totalEl = document.getElementById('meal-plan-total-kcal');
            list.innerHTML = '<p class="text-xs text-white/30 py-2">Caricamento...</p>';

            // Get the actual date for this day index
            var selectedDate = window._weekDays[dayIndex];
            var dateStr = selectedDate.getFullYear() + '-' + String(selectedDate.getMonth()+1).padStart(2,'0') + '-' + String(selectedDate.getDate()).padStart(2,'0');

            // Fetch meal plan (cached) + diet log for date
            var planReady = window._weeklyMealPlan ? Promise.resolve() :
                fetch('/api/client/weekly-meal-plan', {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
                })
                .then(function(r) { return r.json(); })
                .then(function(data) { window._weeklyMealPlan = data.plan || {}; });

            var logReady = window._dayDietLogs[dateStr] ? Promise.resolve() :
                fetch('/api/client/diet-log/' + dateStr, {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
                })
                .then(function(r) { return r.json(); })
                .then(function(data) { window._dayDietLogs[dateStr] = data.meals || []; })
                .catch(function() { window._dayDietLogs[dateStr] = []; });

            Promise.all([planReady, logReady]).then(function() {
                renderMealPlan(dayIndex, dateStr);
            }).catch(function() {
                list.innerHTML = '<p class="text-xs text-white/30 py-2">Nessun piano assegnato</p>';
                totalEl.textContent = '';
            });
        };

        var mealTypeLabels = {
            'colazione': { label: 'Colazione', icon: 'ðŸŒ…', color: '#fbbf24' },
            'spuntino_mattina': { label: 'Spuntino', icon: 'ðŸŽ', color: '#34d399' },
            'pranzo': { label: 'Pranzo', icon: 'ðŸ', color: '#f97316' },
            'spuntino_pomeriggio': { label: 'Merenda', icon: 'ðŸ¥¤', color: '#818cf8' },
            'cena': { label: 'Cena', icon: 'ðŸŒ™', color: '#60a5fa' }
        };

        // Map logged meal_type values to plan meal_type values
        var logTypeToMealType = {
            'Colazione': 'colazione',
            'colazione': 'colazione',
            'Spuntino': 'spuntino_mattina',
            'spuntino_mattina': 'spuntino_mattina',
            'spuntino': 'spuntino_mattina',
            'Pranzo': 'pranzo',
            'pranzo': 'pranzo',
            'Merenda': 'spuntino_pomeriggio',
            'merenda': 'spuntino_pomeriggio',
            'spuntino_pomeriggio': 'spuntino_pomeriggio',
            'Cena': 'cena',
            'cena': 'cena',
            'Snack': 'spuntino_mattina'
        };

        function buildMealRow(meal, info, isChecked, isAlternative) {
            var checkIcon = isChecked
                ? '<div style="width:20px;height:20px;border-radius:50%;background:#22c55e;display:flex;align-items:center;justify-content:center;flex-shrink:0">'
                  + '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div>'
                : '<div style="width:20px;height:20px;border-radius:50%;border:2px solid rgba(255,255,255,0.15);flex-shrink:0"></div>';

            var rowOpacity = isChecked ? 'opacity:0.6;' : '';
            var nameStrike = isChecked ? 'text-decoration:line-through;' : '';
            var altBadge = isAlternative ? '<span style="font-size:8px;background:rgba(251,191,36,0.2);color:#fbbf24;padding:1px 5px;border-radius:4px;margin-left:6px">ALT</span>' : '';
            var borderColor = isChecked ? 'rgba(34,197,94,0.2)' : (isAlternative ? 'rgba(251,191,36,0.15)' : 'rgba(255,255,255,0.06)');

            return '<div style="display:flex;align-items:center;gap:10px;padding:8px 10px;background:rgba(255,255,255,0.04);border-radius:12px;border:1px solid ' + borderColor + ';' + rowOpacity + '">'
                + checkIcon
                + '<div style="width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;background:rgba(255,255,255,0.05)">' + info.icon + '</div>'
                + '<div style="flex:1;min-width:0">'
                + '<div style="display:flex;justify-content:space-between;align-items:center">'
                + '<span style="font-size:11px;font-weight:600;color:' + info.color + ';text-transform:uppercase;letter-spacing:0.03em">' + info.label + altBadge + '</span>'
                + '<span style="font-size:10px;font-weight:700;color:#fff">' + (meal.calories || 0) + ' kcal</span>'
                + '</div>'
                + '<p style="font-size:12px;font-weight:500;color:#fff;margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;' + nameStrike + '">' + meal.meal_name + '</p>'
                + (meal.description ? '<p style="font-size:10px;color:rgba(255,255,255,0.4);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + meal.description + '</p>' : '')
                + '</div></div>';
        }

        window.toggleAlternatives = function(id) {
            var el = document.getElementById(id);
            if (!el) return;
            if (el.style.display === 'none' || el.style.display === '') {
                el.style.display = 'flex';
            } else {
                el.style.display = 'none';
            }
        };

        function renderMealPlan(dayIndex, dateStr) {
            var list = document.getElementById('daily-meal-plan-list');
            var totalEl = document.getElementById('meal-plan-total-kcal');
            var dayKey = String(dayIndex);
            var meals = window._weeklyMealPlan[dayKey] || [];
            var loggedMeals = window._dayDietLogs[dateStr] || [];

            if (meals.length === 0) {
                list.innerHTML = '<p class="text-xs text-white/30 py-3 text-center">Nessun piano assegnato per questo giorno</p>';
                totalEl.textContent = '';
                return;
            }

            // Build a set of logged meal types for check-off
            var loggedTypes = {};
            loggedMeals.forEach(function(log) {
                var mapped = logTypeToMealType[log.meal_type] || log.meal_type;
                loggedTypes[mapped] = true;
            });

            // Group meals by meal_type
            var grouped = {};
            var mealOrder = ['colazione', 'spuntino_mattina', 'pranzo', 'spuntino_pomeriggio', 'cena'];
            meals.forEach(function(meal) {
                var key = meal.meal_type;
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(meal);
            });

            // Sort groups by meal_order
            var sortedKeys = Object.keys(grouped).sort(function(a, b) {
                var ai = mealOrder.indexOf(a); if (ai === -1) ai = 99;
                var bi = mealOrder.indexOf(b); if (bi === -1) bi = 99;
                return ai - bi;
            });

            var totalKcal = 0;
            var checkedCount = 0;
            var totalPrimaryMeals = 0;
            var html = '';

            sortedKeys.forEach(function(mealType) {
                var group = grouped[mealType];
                group.sort(function(a, b) { return (a.alternative_index || 0) - (b.alternative_index || 0); });

                var primary = group.find(function(m) { return (m.alternative_index || 0) === 0; }) || group[0];
                var alternatives = group.filter(function(m) { return (m.alternative_index || 0) > 0; });

                var info = mealTypeLabels[mealType] || { label: mealType, icon: 'ðŸ½ï¸', color: '#9ca3af' };
                var isChecked = !!loggedTypes[mealType];
                if (isChecked) checkedCount++;
                totalKcal += primary.calories || 0;
                totalPrimaryMeals++;

                // Render primary meal
                html += buildMealRow(primary, info, isChecked, false);

                // If alternatives exist, add toggle button + hidden alternatives
                if (alternatives.length > 0) {
                    var altId = 'alt-' + mealType + '-' + dayIndex;
                    html += '<div style="padding-left:30px;margin-top:-2px;margin-bottom:4px">'
                        + '<button onclick="toggleAlternatives(\'' + altId + '\')" '
                        + 'style="font-size:10px;color:#fbbf24;background:none;border:none;cursor:pointer;display:flex;align-items:center;gap:4px;padding:2px 0">'
                        + '<span style="font-size:14px">&#8693;</span> '
                        + 'Alternativa (' + alternatives.length + ')'
                        + '</button>'
                        + '<div id="' + altId + '" style="display:none;flex-direction:column;gap:4px;margin-top:4px">';

                    alternatives.forEach(function(alt) {
                        html += buildMealRow(alt, info, isChecked, true);
                    });

                    html += '</div></div>';
                }
            });

            list.innerHTML = html;
            totalEl.textContent = totalKcal + ' kcal totali Â· ' + checkedCount + '/' + totalPrimaryMeals;
        }

        // Auto-load today's plan
        loadDayMealPlan(window._selectedDayIndex);
    })();
    </script>

    <!-- Grouped Diet Log -->
    <div id="diet-log-container" class="space-y-4"></div>
</div>

<!-- Weight & Body Composition Update Modal -->
<div id="weight-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeWeightModal()">
    <div class="glass-card p-6 rounded-2xl max-w-sm w-full">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Aggiorna Statistiche Corpo</h3>
            <button onclick="closeWeightModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>

        <!-- Weight Input -->
        <div class="text-center mb-4">
            <label class="text-xs text-gray-400 uppercase tracking-wider block mb-2">Peso</label>
            <div class="relative inline-block">
                <input type="number" id="weight-input" step="0.1" min="20" max="300"
                    class="text-5xl font-black text-center bg-transparent border-b-2 border-blue-500 w-32 focus:outline-none text-blue-400"
                    placeholder="--" oninput="updateCompositionPreview()">
                <span class="text-2xl text-blue-400/70 ml-2">kg</span>
            </div>
        </div>

        <!-- Body Fat Input (Optional) -->
        <div class="text-center mb-4">
            <label class="text-xs text-gray-400 uppercase tracking-wider block mb-2">Grasso Corporeo % <span class="text-gray-500">(opzionale)</span></label>
            <div class="relative inline-block">
                <input type="number" id="body-fat-input" step="0.1" min="1" max="70"
                    class="text-3xl font-bold text-center bg-transparent border-b-2 border-amber-500 w-24 focus:outline-none text-amber-400"
                    placeholder="--" oninput="updateCompositionPreview()">
                <span class="text-xl text-amber-400/70 ml-2">%</span>
            </div>
        </div>

        <!-- Calculated Preview -->
        <div id="composition-preview" class="hidden bg-white/5 rounded-xl p-3 mb-4">
            <div class="grid grid-cols-2 gap-3 text-center">
                <div>
                    <span class="text-xs text-gray-400 block">Massa Grassa</span>
                    <span id="preview-fat-mass" class="text-lg font-bold text-red-400">-</span>
                    <span class="text-sm text-gray-500">kg</span>
                </div>
                <div>
                    <span class="text-xs text-gray-400 block">Massa Magra</span>
                    <span id="preview-lean-mass" class="text-lg font-bold text-green-400">-</span>
                    <span class="text-sm text-gray-500">kg</span>
                </div>
            </div>
        </div>

        <button onclick="saveWeight()" class="w-full py-3 bg-gradient-to-r from-blue-500 to-cyan-500 text-white font-bold rounded-xl hover:from-blue-400 hover:to-cyan-400 transition tap-effect">
            Salva
        </button>
    </div>
</div>

<!-- Strength Details Modal -->
<div id="strength-details-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeStrengthDetailsModal()">
    <div class="glass-card rounded-2xl max-w-lg w-full max-h-[85vh] overflow-hidden flex flex-col">
        <!-- Header -->
        <div class="flex justify-between items-center p-5 border-b border-white/10">
            <h3 class="text-xl font-bold">Dettagli Forza</h3>
            <button onclick="closeStrengthDetailsModal()" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/20 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Category Tabs -->
        <div class="flex border-b border-white/10">
            <button id="strength-tab-upper" onclick="switchStrengthTab('upper_body')" class="flex-1 py-3 text-sm font-semibold text-center border-b-2 border-orange-500 text-orange-400 transition">
                Parte Superiore
            </button>
            <button id="strength-tab-lower" onclick="switchStrengthTab('lower_body')" class="flex-1 py-3 text-sm font-semibold text-center border-b-2 border-transparent text-gray-400 hover:text-white transition">
                Parte Inferiore
            </button>
            <button id="strength-tab-cardio" onclick="switchStrengthTab('cardio')" class="flex-1 py-3 text-sm font-semibold text-center border-b-2 border-transparent text-gray-400 hover:text-white transition">
                Cardio
            </button>
        </div>

        <!-- Goal Progress Section -->
        <div id="strength-goal-section" class="hidden px-5 pt-4">
            <div class="bg-gradient-to-r from-white/5 to-white/[0.02] rounded-xl p-4 border border-white/10">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <div id="strength-goal-icon" class="w-8 h-8 rounded-lg bg-orange-500/20 flex items-center justify-center">
                            <svg class="w-4 h-4 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                            </svg>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400">Obiettivo Trainer</p>
                            <p id="strength-goal-target" class="text-lg font-bold text-white">+25%</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-400">I Tuoi Progressi</p>
                        <p id="strength-goal-current" class="text-lg font-bold text-orange-400">+21%</p>
                    </div>
                </div>
                <!-- Progress Bar -->
                <div class="relative h-2 bg-white/10 rounded-full overflow-hidden">
                    <div id="strength-goal-bar" class="absolute inset-y-0 left-0 bg-gradient-to-r from-orange-500 to-orange-400 rounded-full transition-all duration-500" style="width: 84%"></div>
                </div>
                <p id="strength-goal-status" class="text-xs text-gray-500 mt-2 text-center">84% dell'obiettivo raggiunto</p>
            </div>
        </div>

        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto p-5">
            <!-- Loading State -->
            <div id="strength-details-loading" class="hidden flex flex-col items-center justify-center py-10">
                <div class="w-8 h-8 border-2 border-orange-500 border-t-transparent rounded-full animate-spin mb-3"></div>
                <p class="text-gray-400 text-sm">Caricamento dati esercizi...</p>
            </div>

            <!-- Empty State -->
            <div id="strength-details-empty" class="hidden flex flex-col items-center justify-center py-10">
                <div class="w-16 h-16 rounded-full bg-white/5 flex items-center justify-center mb-4">
                    <svg class="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                </div>
                <p class="text-gray-400 text-sm">Nessun dato per questa categoria</p>
                <p class="text-gray-500 text-xs mt-1">Completa gli allenamenti per vedere i tuoi progressi</p>
            </div>

            <!-- Exercise List -->
            <div id="strength-details-list" class="space-y-4">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Manual Meal Entry Modal -->
<div id="manual-meal-modal" class="fixed inset-0 bg-black/70 backdrop-blur-xl z-50 hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Aggiungi Pasto Manualmente</h3>
            <button onclick="closeManualMealModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>

        <form id="manual-meal-form" class="space-y-4">
            <!-- Meal Name -->
            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Nome Pasto</label>
                <input type="text" id="meal-name" required
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-3 text-sm text-white outline-none focus:border-primary/50 transition"
                    placeholder="es. Pollo alla griglia con riso">
            </div>

            <!-- Meal Type -->
            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Tipo Pasto</label>
                <select id="meal-type" required
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-3 text-sm text-white outline-none focus:border-primary/50 transition">
                    <option value="Breakfast">Colazione</option>
                    <option value="Lunch">Pranzo</option>
                    <option value="Dinner">Cena</option>
                    <option value="Snack">Spuntino</option>
                </select>
            </div>

            <!-- Macros Grid -->
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Calorie</label>
                    <input type="number" id="meal-calories" required min="0"
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-3 text-sm text-white outline-none focus:border-primary/50 transition"
                        placeholder="0">
                </div>
                <div>
                    <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Proteine (g)</label>
                    <input type="number" id="meal-protein" required min="0"
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-3 text-sm text-white outline-none focus:border-primary/50 transition"
                        placeholder="0">
                </div>
                <div>
                    <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Carboidrati (g)</label>
                    <input type="number" id="meal-carbs" required min="0"
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-3 text-sm text-white outline-none focus:border-primary/50 transition"
                        placeholder="0">
                </div>
                <div>
                    <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Grassi (g)</label>
                    <input type="number" id="meal-fat" required min="0"
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-3 text-sm text-white outline-none focus:border-primary/50 transition"
                        placeholder="0">
                </div>
            </div>

            <!-- Future AI Button (Disabled) -->
            <div class="bg-white/5 border border-white/10 rounded-lg p-3 text-center">
                <button type="button" disabled
                    class="w-full bg-white/5 text-gray-500 px-4 py-2 rounded-lg text-sm font-bold cursor-not-allowed opacity-50">
                    <i data-lucide="bot" class="w-4 h-4 inline-block align-middle stroke-current"></i> Calcola con IA (Prossimamente)
                </button>
                <p class="text-xs text-gray-500 mt-2">Il calcolo macro con IA sarÃ  disponibile in un futuro aggiornamento</p>
            </div>

            <!-- Submit Button -->
            <button type="submit"
                class="w-full bg-primary px-4 py-3 rounded-lg font-bold hover:bg-primary/80 transition">
                Aggiungi Pasto
            </button>
        </form>
    </div>
</div>

<!-- Camera Scanner Modal -->
<div id="camera-scanner-modal" class="fixed inset-0 bg-black z-50 hidden flex flex-col">
    <!-- Header -->
    <div class="flex justify-between items-center p-4 bg-black/50 backdrop-blur-sm">
        <button onclick="closeCameraScanner()" class="text-white text-2xl">&times;</button>
        <h3 class="text-white font-bold">Scansiona il Tuo Pasto</h3>
        <button id="flip-btn" onclick="flipCamera()" class="text-white text-xl" title="Cambia Fotocamera"><i data-lucide="refresh-cw" class="w-5 h-5"></i></button>
    </div>

    <!-- Mode Toggle Tabs -->
    <div id="scan-mode-tabs" class="flex bg-black/30 mx-4 rounded-full p-1">
        <button onclick="setScanMode('photo')" id="photo-mode-btn" class="flex-1 py-2 px-4 rounded-full text-sm font-medium transition bg-primary text-white">
            <i data-lucide="camera" class="w-4 h-4 inline-block align-middle"></i> Foto
        </button>
        <button onclick="setScanMode('barcode')" id="barcode-mode-btn" class="flex-1 py-2 px-4 rounded-full text-sm font-medium transition text-white/60">
            â–¦ Codice a Barre
        </button>
    </div>

    <!-- Camera Preview (Live) - Photo Mode -->
    <div id="camera-live-view" class="flex-1 relative overflow-hidden">
        <video id="camera-preview" autoplay playsinline class="w-full h-full object-cover"></video>

        <!-- Photo Scanning Overlay -->
        <div id="photo-overlay" class="absolute inset-0 pointer-events-none">
            <div class="absolute top-1/4 left-1/4 w-1/2 h-1/2">
                <div class="absolute top-0 left-0 w-8 h-8 border-t-2 border-l-2 border-white/70 rounded-tl-lg"></div>
                <div class="absolute top-0 right-0 w-8 h-8 border-t-2 border-r-2 border-white/70 rounded-tr-lg"></div>
                <div class="absolute bottom-0 left-0 w-8 h-8 border-b-2 border-l-2 border-white/70 rounded-bl-lg"></div>
                <div class="absolute bottom-0 right-0 w-8 h-8 border-b-2 border-r-2 border-white/70 rounded-br-lg"></div>
            </div>
        </div>
    </div>

    <!-- Barcode Scanner View (QuaggaJS container) -->
    <div id="barcode-scanner-view" class="flex-1 relative overflow-hidden hidden">
        <div id="barcode-scanner-container" class="w-full h-full"></div>

        <!-- Barcode Scanning Overlay -->
        <div class="absolute inset-0 pointer-events-none">
            <div class="absolute top-1/3 left-[10%] w-[80%] h-24">
                <div class="absolute inset-0 border-2 border-red-500/70 rounded-lg"></div>
                <div class="absolute top-1/2 left-0 right-0 h-0.5 bg-red-500 animate-pulse"></div>
            </div>
            <p class="absolute top-[60%] left-0 right-0 text-center text-white/80 text-sm">Punta verso il codice a barre</p>
        </div>
    </div>

    <!-- Captured Photo Preview (Hidden initially) -->
    <div id="camera-preview-view" class="flex-1 relative overflow-hidden hidden">
        <img id="captured-photo" class="w-full h-full object-cover" src="" alt="Captured photo">

        <!-- Loading Overlay -->
        <div id="camera-loading" class="absolute inset-0 bg-black/70 flex items-center justify-center hidden">
            <div class="text-center">
                <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
                <p class="text-white text-sm" id="loading-text">Analizzando il pasto...</p>
            </div>
        </div>
    </div>

    <!-- Results Edit View (Hidden initially) -->
    <div id="results-edit-view" class="flex-1 overflow-y-auto hidden bg-gray-900">
        <div class="p-4">
            <h4 id="result-food-name" class="text-white font-bold text-lg mb-4 text-center">Cibo Scansionato</h4>

            <!-- Editable Fields -->
            <div class="space-y-3">
                <div class="bg-white/10 rounded-xl p-3">
                    <label class="text-white/60 text-xs">Nome Cibo</label>
                    <input type="text" id="edit-food-name" class="w-full bg-transparent text-white text-lg font-medium border-none outline-none mt-1" placeholder="Nome cibo">
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white/10 rounded-xl p-3">
                        <label class="text-white/60 text-xs">Calorie</label>
                        <div class="flex items-center mt-1">
                            <input type="number" id="edit-calories" class="w-full bg-transparent text-white text-xl font-bold border-none outline-none" placeholder="0">
                            <span class="text-white/40 text-sm ml-1">kcal</span>
                        </div>
                    </div>
                    <div class="bg-white/10 rounded-xl p-3">
                        <label class="text-white/60 text-xs">Proteine</label>
                        <div class="flex items-center mt-1">
                            <input type="number" id="edit-protein" class="w-full bg-transparent text-white text-xl font-bold border-none outline-none" placeholder="0" step="0.1">
                            <span class="text-white/40 text-sm ml-1">g</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white/10 rounded-xl p-3">
                        <label class="text-white/60 text-xs">Carboidrati</label>
                        <div class="flex items-center mt-1">
                            <input type="number" id="edit-carbs" class="w-full bg-transparent text-white text-xl font-bold border-none outline-none" placeholder="0" step="0.1">
                            <span class="text-white/40 text-sm ml-1">g</span>
                        </div>
                    </div>
                    <div class="bg-white/10 rounded-xl p-3">
                        <label class="text-white/60 text-xs">Grassi</label>
                        <div class="flex items-center mt-1">
                            <input type="number" id="edit-fat" class="w-full bg-transparent text-white text-xl font-bold border-none outline-none" placeholder="0" step="0.1">
                            <span class="text-white/40 text-sm ml-1">g</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white/10 rounded-xl p-3">
                    <label class="text-white/60 text-xs">Porzione</label>
                    <input type="text" id="edit-portion" class="w-full bg-transparent text-white font-medium border-none outline-none mt-1" placeholder="es. 100g, 1 porzione">
                </div>
            </div>

            <!-- Source Info -->
            <p id="result-source" class="text-white/40 text-xs text-center mt-4">Fonte: IA Vision</p>
        </div>
    </div>

    <!-- Bottom Controls - Capture Mode (Photo) -->
    <div id="capture-controls" class="p-6 bg-gradient-to-t from-black to-transparent">
        <p class="text-center text-white/60 text-xs mb-4">Scatta una foto del tuo pasto</p>
        <div class="flex justify-center items-center space-x-6">
            <button onclick="openGalleryForScan()" class="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center text-white">
                <i data-lucide="image" class="w-4 h-4 inline-block align-middle"></i>
            </button>
            <button onclick="takePhoto()" id="capture-btn" class="w-20 h-20 rounded-full bg-white flex items-center justify-center shadow-lg active:scale-95 transition">
                <div class="w-16 h-16 rounded-full border-4 border-black/20"></div>
            </button>
            <div class="w-12 h-12"></div>
        </div>
    </div>

    <!-- Bottom Controls - Barcode Mode -->
    <div id="barcode-controls" class="p-6 bg-gradient-to-t from-black to-transparent hidden">
        <p class="text-center text-white/60 text-xs mb-4">Scansione codice a barre...</p>
        <div class="flex justify-center">
            <div class="w-12 h-12 border-4 border-white/30 border-t-white rounded-full animate-spin"></div>
        </div>
    </div>

    <!-- Bottom Controls - Review Mode -->
    <div id="review-controls" class="p-6 bg-gradient-to-t from-black to-transparent hidden">
        <p class="text-center text-white/60 text-xs mb-4">Rivedi la tua foto</p>
        <div class="flex justify-center items-center space-x-4">
            <button onclick="retakePhoto()" class="px-6 py-3 rounded-full bg-white/20 text-white font-medium">
                <i data-lucide="undo-2" class="w-4 h-4 inline-block align-middle"></i> Rifai
            </button>
            <button onclick="analyzePhoto()" id="analyze-btn" class="px-8 py-3 rounded-full bg-primary text-white font-bold shadow-lg">
                <i data-lucide="sparkles" class="w-4 h-4 inline-block align-middle stroke-current"></i> Analizza
            </button>
        </div>
    </div>

    <!-- Bottom Controls - Results Edit Mode -->
    <div id="results-controls" class="p-4 bg-black hidden">
        <div class="flex justify-center items-center space-x-4">
            <button onclick="cancelScanResult()" class="px-6 py-3 rounded-full bg-white/20 text-white font-medium">
                âœ• Annulla
            </button>
            <button onclick="logScannedMeal()" class="px-8 py-3 rounded-full bg-green-500 text-white font-bold shadow-lg">
                âœ“ Registra Pasto
            </button>
        </div>
    </div>

    <!-- Hidden canvas for capturing -->
    <canvas id="camera-canvas" class="hidden"></canvas>
    <!-- Hidden file input for gallery -->
    <input type="file" id="gallery-input" accept="image/*" class="hidden" onchange="handleGallerySelect(event)">
</div>

<script>
// --- MANUAL MEAL ENTRY (Progress/Nutrition Page) ---

function openManualMealModal() {
    document.getElementById('manual-meal-modal').classList.remove('hidden');
    // Reset form
    const form = document.getElementById('manual-meal-form');
    if (form) form.reset();
}

function closeManualMealModal() {
    document.getElementById('manual-meal-modal').classList.add('hidden');
}

// Handle manual meal form submission
const mealForm = document.getElementById('manual-meal-form');
if (mealForm) {
    mealForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const mealData = {
            name: document.getElementById('meal-name').value,
            meal_type: document.getElementById('meal-type').value,
            cals: parseInt(document.getElementById('meal-calories').value),
            protein: parseInt(document.getElementById('meal-protein').value),
            carbs: parseInt(document.getElementById('meal-carbs').value),
            fat: parseInt(document.getElementById('meal-fat').value)
        };

        try {
            const response = await fetch('/api/client/diet/log', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify(mealData)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to log meal');
            }

            showToast(`${mealData.name} registrato con successo!`, 'success');
            closeManualMealModal();

            // Reload the page to show updated data
            setTimeout(() => window.location.reload(), 500);
        } catch (error) {
            console.error('Error logging meal:', error);
            showToast(error.message, 'error');
        }
    });
}

// (Quick action redirects removed â€” FAB actions are now self-contained in base.html)
</script>

{% elif mode == "body_progress" %}
<!-- Body Progress Page: Weight/Strength Charts + Physique Photos -->
<div id="body-progress-top-bar" class="fixed top-0 left-0 right-0 px-4 pb-3 flex justify-between items-center z-30 transition-all duration-200" style="padding-top: max(env(safe-area-inset-top, 0px), 2.5rem);">
    <div class="flex items-center gap-3">
        <a href="{{ 'client.html' if static_build else '/?gym_id=' + gym_id + '&role=client' }}"
            class="w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center tap-effect">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        </a>
        <h1 class="text-lg font-bold text-white">Progressi</h1>
    </div>
    <div class="flex items-center space-x-2">
        <button onclick="openWeightModal()" class="w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center tap-effect" title="Aggiorna Peso">
            <i data-lucide="scale" class="w-5 h-5"></i>
        </button>
        <button onclick="openPhysiqueModal()" class="w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center tap-effect" title="Aggiungi Foto">
            <i data-lucide="camera" class="w-5 h-5"></i>
        </button>
    </div>
</div>

<div class="space-y-4 pb-8 px-4" style="padding-top: max(calc(env(safe-area-inset-top, 0px) + 5rem), 7rem);">

    <!-- Weight/Strength Trend Section -->
    <div>
        <div class="flex justify-between items-center mb-3">
            <h3 id="trend-section-title" class="text-sm font-bold text-gray-400 uppercase tracking-wider">Andamento Peso</h3>
            <div class="flex bg-white/5 rounded-lg p-0.5">
                <button onclick="switchTrendView('weight')" id="trend-toggle-weight" class="text-[10px] px-3 py-1 rounded-md bg-blue-500/20 text-blue-400 font-bold transition">Peso</button>
                <button onclick="switchTrendView('strength')" id="trend-toggle-strength" class="text-[10px] px-3 py-1 rounded-md text-gray-400 hover:text-white transition">Forza</button>
            </div>
        </div>
        <div id="weight-chart-container" class="bg-white/5 rounded-xl p-4">
            <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2">
                    <button onclick="openWeightModal()" id="weight-update-btn" class="flex items-center gap-1.5 bg-gradient-to-r from-blue-500/20 to-cyan-500/20 border border-blue-500/30 px-3 py-1 rounded-full hover:from-blue-500/30 hover:to-cyan-500/30 transition tap-effect">
                        <span id="metric-icon" class="text-xs"><i data-lucide="scale" class="w-3.5 h-3.5 inline-block align-middle stroke-current"></i></span>
                        <span id="client-weight" class="text-sm font-bold text-blue-400">--</span>
                        <span id="metric-unit" class="text-xs text-blue-400/70">kg</span>
                    </button>
                    <span id="weight-trend-badge" class="text-[10px] px-2 py-0.5 rounded-full bg-green-500/20 text-green-400 font-bold">--</span>
                </div>
                <div id="chart-period-selector" class="flex bg-white/5 rounded-lg p-0.5">
                    <button onclick="loadTrendChart('week')" id="weight-period-week" class="text-[10px] px-2.5 py-1 rounded-md text-gray-500 hover:text-gray-300 transition">Sett.</button>
                    <button onclick="loadTrendChart('month')" id="weight-period-month" class="text-[10px] px-2.5 py-1 rounded-md bg-white/10 text-white font-semibold transition">Mese</button>
                    <button onclick="loadTrendChart('year')" id="weight-period-year" class="text-[10px] px-2.5 py-1 rounded-md text-gray-500 hover:text-gray-300 transition">Anno</button>
                </div>
            </div>
            <div id="body-metric-tabs" class="flex justify-center mb-3">
                <div class="flex bg-white/5 rounded-lg p-0.5">
                    <button onclick="switchBodyMetric('weight')" id="body-metric-weight" class="text-[10px] px-3 py-1 rounded-md bg-white/10 text-blue-400 font-semibold transition">Peso</button>
                    <button onclick="switchBodyMetric('body_fat_pct')" id="body-metric-body_fat_pct" class="text-[10px] px-3 py-1 rounded-md text-gray-500 hover:text-gray-300 transition">Grasso</button>
                    <button onclick="switchBodyMetric('lean_mass')" id="body-metric-lean_mass" class="text-[10px] px-3 py-1 rounded-md text-gray-500 hover:text-gray-300 transition">Massa Magra</button>
                </div>
            </div>
            <div class="relative w-full" style="aspect-ratio: 16/9; min-height: 180px; max-height: 280px;">
                <canvas id="weight-chart" class="absolute inset-0 w-full h-full"></canvas>
                <div id="weight-chart-loading" class="absolute inset-0 flex items-center justify-center">
                    <span class="text-gray-500 text-xs">Caricamento grafico...</span>
                </div>
            </div>
            <div id="weight-stats-row" class="flex justify-between mt-3 text-center">
                <div>
                    <p class="text-[10px] text-gray-500">Inizio</p>
                    <p id="weight-stat-start" class="text-sm font-bold text-gray-400">--</p>
                </div>
                <div>
                    <p class="text-[10px] text-gray-500">Min</p>
                    <p id="weight-stat-min" class="text-sm font-bold text-green-400">--</p>
                </div>
                <div>
                    <p class="text-[10px] text-gray-500">Max</p>
                    <p id="weight-stat-max" class="text-sm font-bold text-red-400">--</p>
                </div>
                <div>
                    <p class="text-[10px] text-gray-500">Variazione</p>
                    <p id="weight-stat-change" class="text-sm font-bold text-blue-400">--</p>
                </div>
            </div>
            <div id="strength-stats-row" class="hidden mt-3 pt-3 border-t border-white/5">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-1.5">
                            <div class="w-2 h-2 rounded-full bg-orange-500"></div>
                            <span class="text-[10px] text-gray-500">Sup.</span>
                            <span id="strength-stat-upper" class="text-xs font-bold text-orange-400">--%</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <div class="w-2 h-2 rounded-full bg-purple-500"></div>
                            <span class="text-[10px] text-gray-500">Inf.</span>
                            <span id="strength-stat-lower" class="text-xs font-bold text-purple-400">--%</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <div class="w-2 h-2 rounded-full bg-green-500"></div>
                            <span class="text-[10px] text-gray-500">Cardio</span>
                            <span id="strength-stat-cardio" class="text-xs font-bold text-green-400">--%</span>
                        </div>
                    </div>
                    <button onclick="openStrengthDetailsModal()" class="flex items-center gap-1 text-[10px] text-gray-400 hover:text-white transition">
                        <span id="strength-stat-trend" class="font-semibold">Dettagli</span>
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Physique Photos -->
    <div>
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Aggiornamento Fisico</h3>
            <div class="flex gap-2">
                <button onclick="openCompareModal()" class="text-xs bg-white/5 border border-white/10 backdrop-blur-sm px-3 py-1.5 rounded-xl text-white/80 hover:bg-white/10 hover:text-white transition tap-effect flex items-center gap-1">
                    <i data-lucide="scale" class="w-3 h-3 inline-block align-middle stroke-current"></i> Confronta
                </button>
                <button onclick="openPhysiqueModal()" class="text-xs bg-primary/20 border border-primary/30 backdrop-blur-sm px-3 py-1.5 rounded-xl text-white hover:bg-primary/30 transition tap-effect flex items-center gap-1">
                    <i data-lucide="plus" class="w-3 h-3 inline-block align-middle stroke-current"></i> Aggiungi
                </button>
            </div>
        </div>
        <div class="flex space-x-3 overflow-x-auto pb-2" id="photo-gallery">
            <p class="text-gray-500 text-xs py-4">Caricamento foto...</p>
        </div>
    </div>
</div>

{% elif mode == "calendar" %}
<div class="p-6 pt-10 flex justify-between items-center bg-gradient-to-b from-black/80 to-transparent z-10">
    <div class="flex items-center space-x-3">
        <a href="{{ 'client.html' if static_build else '/?gym_id=' + gym_id + '&role=client' }}"
            class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center tap-effect">â†</a>
        <h2 class="font-bold text-xl">Calendario</h2>
    </div>
    <div class="flex space-x-2">
        <div onclick="openBookingChoiceForMyTrainer()" class="relative w-10 h-10 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center tap-effect cursor-pointer" title="Prenota Sessione">
            <i data-lucide="calendar" class="w-5 h-5"></i>
        </div>
        <div onclick="openClientChatModal()" class="relative w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center tap-effect cursor-pointer">
            <i data-lucide="message-circle" class="w-5 h-5"></i>
        </div>
        <div data-action="showModal" data-target="notification-modal"
            class="notification-bell w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center tap-effect relative">
            <i data-lucide="bell" class="w-5 h-5"></i>
            <span class="notification-badge hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">0</span>
        </div>
    </div>
</div>
<div class="flex-1 p-4 space-y-4">
    <!-- Calendar Header -->
    <div class="flex justify-between items-center mb-4">
        <button id="prev-month" class="p-2 bg-white/10 rounded-full tap-effect">â†</button>
        <h2 id="current-month-year" class="text-xl font-bold text-white">Dicembre 2025</h2>
        <button id="next-month" class="p-2 bg-white/10 rounded-full tap-effect">â†’</button>
    </div>

    <!-- Calendar Grid -->
    {% call card(classes="p-4") %}
    <div class="grid grid-cols-7 gap-2 text-center mb-2">
        <div class="text-xs text-gray-500 font-bold">Dom</div>
        <div class="text-xs text-gray-500 font-bold">Lun</div>
        <div class="text-xs text-gray-500 font-bold">Mar</div>
        <div class="text-xs text-gray-500 font-bold">Mer</div>
        <div class="text-xs text-gray-500 font-bold">Gio</div>
        <div class="text-xs text-gray-500 font-bold">Ven</div>
        <div class="text-xs text-gray-500 font-bold">Sab</div>
    </div>
    <div id="calendar-grid" class="grid grid-cols-7 gap-y-2 gap-x-0">
        <!-- Days injected by JS -->
    </div>
    {% endcall %}

    <!-- Selected Day Details -->
    <div id="selected-day-details" class="space-y-3">
        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider ml-1" id="selected-date-title">Oggi</h3>
        <div id="day-events-list" class="space-y-2">
            <!-- Events injected by JS -->
        </div>
    </div>
</div>

{% elif mode == "account_settings" %}
<div class="p-6 pt-10 flex items-center space-x-4 bg-black/50 z-10">
    <a href="{{ 'client.html' if static_build else '/?gym_id=' + gym_id + '&role=client&mode=client_dashboard' }}"
        class="text-2xl tap-effect">â†</a>
    <h2 class="font-bold text-xl">Gestione Account</h2>
</div>
<div class="flex-1 p-4 space-y-6">
    <!-- Gym & Trainer Section -->
    {% call card(classes="p-6 space-y-4") %}
    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Palestra & Trainer</h3>

    <!-- Current Gym -->
    <div id="gym-status-container">
        <label class="text-xs text-gray-500 uppercase font-bold block mb-2">Palestra Attuale</label>
        <div id="current-gym-display" class="text-white mb-3">Caricamento...</div>
    </div>

    <!-- Leave Gym Button (shown if has gym) -->
    <div id="leave-gym-section" class="hidden mb-4">
        <button onclick="leaveGym()"
            class="px-4 py-2 bg-red-500/20 text-red-400 border border-red-500/30 font-bold rounded-xl tap-effect hover:bg-red-500/30 transition">
            LASCIA PALESTRA
        </button>
    </div>

    <!-- Join Gym (shown if no gym) -->
    <div id="join-gym-section" class="hidden">
        <label class="text-xs text-gray-500 uppercase font-bold block mb-2">Inserisci Codice Palestra</label>
        <div class="flex gap-2">
            <input type="text" id="gym-code-input" placeholder="Inserisci il codice della tua palestra"
                class="flex-1 bg-white/5 border border-white/10 rounded-xl p-3 text-white focus:border-primary outline-none transition">
            <button onclick="joinGym()"
                class="px-6 py-3 bg-primary text-black font-bold rounded-xl tap-effect hover:bg-primary/90 transition">
                UNISCITI
            </button>
        </div>
    </div>

    <!-- Current Trainer -->
    <div id="trainer-status-container" class="mt-4">
        <label class="text-xs text-gray-500 uppercase font-bold block mb-2">Il Tuo Trainer</label>
        <div id="current-trainer-display" class="text-white mb-3">Caricamento...</div>
    </div>

    <!-- Select Trainer (shown if no trainer) -->
    <div id="select-trainer-section" class="hidden">
        <label class="text-xs text-gray-500 uppercase font-bold block mb-2">Scegli il Tuo Trainer</label>
        <div id="trainer-list" class="space-y-2 mb-3">
            <!-- Trainers will be loaded here -->
        </div>
    </div>
    {% endcall %}

    <!-- Profile Section -->
    {% call card(classes="p-6 space-y-4") %}
    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Profilo</h3>
    <div>
        <label class="text-xs text-gray-500 uppercase font-bold block mb-2">Nome Completo</label>
        <input type="text" id="profile-name"
            class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white focus:border-primary outline-none transition">
    </div>
    <div>
        <label class="text-xs text-gray-500 uppercase font-bold block mb-2">Indirizzo Email</label>
        <input type="email" id="profile-email"
            class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white focus:border-primary outline-none transition">
    </div>
    <div>
        <label class="text-xs text-gray-500 uppercase font-bold block mb-2">Password</label>
        <input type="password" id="profile-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
            class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white focus:border-primary outline-none transition">
    </div>
    <button onclick="saveProfile()"
        class="w-full py-4 bg-primary text-black font-bold rounded-xl tap-effect hover:bg-primary/90 transition mt-4">
        SALVA MODIFICHE
    </button>
    {% endcall %}

    <!-- Privacy Section -->
    {% call card(classes="p-6 space-y-4") %}
    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Privacy</h3>
    <p class="text-sm text-gray-400 mb-4">Controlla chi puÃ² inviarti messaggi nella palestra</p>

    <!-- Privacy Mode Selector -->
    <div class="space-y-3">
        <!-- Public Option -->
        <button onclick="setPrivacyMode('public')" id="privacy-opt-public"
            class="w-full p-4 rounded-xl border-2 transition-all duration-200 text-left privacy-option">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center">
                    <i data-lucide="globe" class="w-5 h-5"></i>
                </div>
                <div class="flex-1">
                    <p class="font-bold text-white">Pubblico</p>
                    <p class="text-xs text-gray-400">Chiunque nella tua palestra puÃ² scriverti</p>
                </div>
                <div id="privacy-check-public" class="w-6 h-6 rounded-full bg-green-500 hidden items-center justify-center">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
            </div>
        </button>

        <!-- Private Option -->
        <button onclick="setPrivacyMode('private')" id="privacy-opt-private"
            class="w-full p-4 rounded-xl border-2 transition-all duration-200 text-left privacy-option">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-yellow-500/20 flex items-center justify-center">
                    <i data-lucide="lock" class="w-5 h-5"></i>
                </div>
                <div class="flex-1">
                    <p class="font-bold text-white">Privato</p>
                    <p class="text-xs text-gray-400">Richiede approvazione prima che altri possano scriverti</p>
                </div>
                <div id="privacy-check-private" class="w-6 h-6 rounded-full bg-yellow-500 hidden items-center justify-center">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
            </div>
        </button>

        <!-- Staff Only Option -->
        <button onclick="setPrivacyMode('staff_only')" id="privacy-opt-staff_only"
            class="w-full p-4 rounded-xl border-2 transition-all duration-200 text-left privacy-option">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center">
                    <i data-lucide="shield" class="w-5 h-5"></i>
                </div>
                <div class="flex-1">
                    <p class="font-bold text-white">Solo Staff</p>
                    <p class="text-xs text-gray-400">Solo trainer e staff della palestra possono scriverti</p>
                </div>
                <div id="privacy-check-staff_only" class="w-6 h-6 rounded-full bg-red-500 hidden items-center justify-center">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
            </div>
        </button>
    </div>

    <!-- Pending Chat Requests -->
    <div id="chat-requests-section" class="mt-6 hidden">
        <h4 class="text-xs font-bold text-gray-500 uppercase mb-3">Richieste Chat in Attesa</h4>
        <div id="pending-requests-list" class="space-y-2">
            <!-- Requests will be loaded here -->
        </div>
    </div>
    {% endcall %}

    <!-- Medical Certificate Section -->
    {% call card(classes="p-6 space-y-4") %}
    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Certificato Medico</h3>

    <!-- Certificate Status -->
    <div id="cert-status-container">
        <div id="cert-loading" class="text-gray-400 text-sm">Caricamento...</div>

        <!-- No certificate uploaded -->
        <div id="cert-empty" class="hidden">
            <div class="flex items-center gap-3 p-4 rounded-xl bg-white/5 border border-white/10">
                <div class="w-10 h-10 rounded-full bg-gray-500/20 flex items-center justify-center"><i data-lucide="clipboard" class="w-5 h-5"></i></div>
                <div class="flex-1">
                    <p class="text-white font-semibold text-sm">Nessun certificato caricato</p>
                    <p class="text-xs text-gray-400">Carica il tuo certificato medico sportivo</p>
                </div>
            </div>
        </div>

        <!-- Certificate uploaded -->
        <div id="cert-uploaded" class="hidden">
            <div id="cert-card" class="flex items-center gap-3 p-4 rounded-xl border">
                <div id="cert-icon" class="w-10 h-10 rounded-full flex items-center justify-center text-xl"></div>
                <div class="flex-1 min-w-0">
                    <p id="cert-filename" class="text-white font-semibold text-sm truncate"></p>
                    <p id="cert-expiry-text" class="text-xs"></p>
                </div>
                <div class="flex gap-2">
                    <button onclick="viewCertificate()" class="w-8 h-8 rounded-lg bg-white/10 hover:bg-white/20 transition flex items-center justify-center" title="View">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    </button>
                    <button onclick="deleteCertificate()" class="w-8 h-8 rounded-lg bg-red-500/20 hover:bg-red-500/30 transition flex items-center justify-center" title="Delete">
                        <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Form -->
    <div class="space-y-3 mt-4">
        <div>
            <label class="text-xs text-gray-500 uppercase font-bold block mb-2">Data di Scadenza</label>
            <input type="date" id="cert-expiration-date"
                class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white focus:border-primary outline-none transition">
        </div>
        <input type="file" id="cert-file-input" accept=".pdf,.png,.jpg,.jpeg" class="hidden"
            onchange="uploadCertificate()">
        <button onclick="document.getElementById('cert-file-input').click()"
            class="w-full py-4 bg-primary text-black font-bold rounded-xl tap-effect hover:bg-primary/90 transition flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
            CARICA CERTIFICATO
        </button>
        <p class="text-xs text-gray-500 text-center">PDF, PNG, or JPG â€” max 10MB</p>
    </div>
    {% endcall %}

    <!-- Data & Privacy Section (GDPR) -->
    {% call card(classes="p-6 space-y-4") %}
    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Dati & Privacy</h3>
    <p class="text-sm text-gray-400 mb-2">Gestisci i tuoi dati personali in conformitÃ  con il GDPR.</p>

    <div class="space-y-3">
        <!-- Export Data -->
        <button onclick="exportMyData()"
            class="w-full py-3 bg-blue-500/20 text-blue-400 border border-blue-500/30 font-bold rounded-xl tap-effect hover:bg-blue-500/30 transition flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            ESPORTA I MIEI DATI
        </button>
        <p class="text-xs text-gray-500 text-center">Scarica tutti i tuoi dati come file JSON</p>

        <!-- Delete Account -->
        <button onclick="showDeleteAccountModal()"
            class="w-full py-3 bg-red-500/20 text-red-400 border border-red-500/30 font-bold rounded-xl tap-effect hover:bg-red-500/30 transition flex items-center justify-center gap-2 mt-4">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            ELIMINA ACCOUNT
        </button>
        <p class="text-xs text-gray-500 text-center">Elimina permanentemente il tuo account e tutti i dati. Questa azione non puÃ² essere annullata.</p>
    </div>

    <!-- Legal Links -->
    <div class="flex gap-4 justify-center pt-4 border-t border-white/10 mt-4">
        <a href="/terms" target="_blank" class="text-xs text-gray-500 hover:text-orange-400 transition">Termini di Servizio</a>
        <a href="/privacy" target="_blank" class="text-xs text-gray-500 hover:text-orange-400 transition">Informativa Privacy</a>
        <a href="/cookies" target="_blank" class="text-xs text-gray-500 hover:text-orange-400 transition">Informativa Cookie</a>
    </div>
    {% endcall %}
</div>

<!-- Delete Account Confirmation Modal -->
<div id="delete-account-modal" class="fixed inset-0 z-[70] hidden">
    <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeDeleteAccountModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-2xl border border-white/10 w-full max-w-sm p-6 relative">
            <h3 class="text-xl font-bold text-white mb-2">Elimina Account</h3>
            <p class="text-sm text-gray-400 mb-4">Questo eliminerÃ  permanentemente il tuo account e tutti i dati associati. Questa azione <strong class="text-red-400">non puÃ² essere annullata</strong>.</p>
            <div class="mb-4">
                <label class="text-xs text-gray-500 uppercase font-bold block mb-2">Conferma la tua password</label>
                <input type="password" id="delete-account-password" placeholder="Inserisci la tua password"
                    class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white focus:border-red-500 outline-none transition">
            </div>
            <div class="flex gap-3">
                <button onclick="closeDeleteAccountModal()"
                    class="flex-1 py-3 bg-white/10 text-white font-bold rounded-xl tap-effect hover:bg-white/20 transition">
                    Annulla
                </button>
                <button onclick="confirmDeleteAccount()"
                    class="flex-1 py-3 bg-red-600 text-white font-bold rounded-xl tap-effect hover:bg-red-700 transition">
                    Elimina Definitivamente
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// --- GDPR DATA MANAGEMENT ---
async function exportMyData() {
    try {
        if (typeof showToast === 'function') showToast('Preparazione esportazione dati...');
        const response = await fetch('/api/gdpr/export-data', { credentials: 'include' });
        if (!response.ok) throw new Error('Export failed');

        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'fitos_data_export.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        if (typeof showToast === 'function') showToast('Dati esportati con successo!', 'success');
    } catch (error) {
        console.error('Export error:', error);
        if (typeof showToast === 'function') showToast('Impossibile esportare i dati', 'error');
    }
}

function showDeleteAccountModal() {
    document.getElementById('delete-account-modal').classList.remove('hidden');
    document.getElementById('delete-account-password').value = '';
}

function closeDeleteAccountModal() {
    document.getElementById('delete-account-modal').classList.add('hidden');
}

async function confirmDeleteAccount() {
    const password = document.getElementById('delete-account-password').value;
    if (!password) {
        if (typeof showToast === 'function') showToast('Inserisci la tua password', 'error');
        return;
    }

    try {
        const response = await fetch('/api/gdpr/delete-account', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password })
        });

        if (response.status === 403) {
            if (typeof showToast === 'function') showToast('Password non corretta', 'error');
            return;
        }

        if (!response.ok) throw new Error('Deletion failed');

        localStorage.clear();
        window.location.href = '/auth/login';
    } catch (error) {
        console.error('Delete account error:', error);
        if (typeof showToast === 'function') showToast('Impossibile eliminare l\'account', 'error');
    }
}
</script>

<script>
// --- MEDICAL CERTIFICATE ---

let currentCertificate = null;

async function loadMedicalCertificate() {
    try {
        const response = await fetch('/api/medical/certificate', { credentials: 'include' });
        if (response.ok) {
            const data = await response.json();
            currentCertificate = data.certificate;
            displayCertificateStatus();
        }
    } catch (error) {
        console.error('Error loading certificate:', error);
    }
}

function displayCertificateStatus() {
    document.getElementById('cert-loading').classList.add('hidden');

    if (!currentCertificate) {
        document.getElementById('cert-empty').classList.remove('hidden');
        document.getElementById('cert-uploaded').classList.add('hidden');
        return;
    }

    document.getElementById('cert-empty').classList.add('hidden');
    document.getElementById('cert-uploaded').classList.remove('hidden');

    const card = document.getElementById('cert-card');
    const icon = document.getElementById('cert-icon');
    const filename = document.getElementById('cert-filename');
    const expiryText = document.getElementById('cert-expiry-text');

    filename.textContent = currentCertificate.filename;

    const status = currentCertificate.status;
    if (status === 'valid') {
        card.className = 'flex items-center gap-3 p-4 rounded-xl border border-green-500/30 bg-green-500/10';
        icon.className = 'w-10 h-10 rounded-full flex items-center justify-center text-xl bg-green-500/20';
        icon.textContent = 'âœ“';
        const exp = currentCertificate.expiration_date;
        expiryText.textContent = exp ? `Valido fino al ${new Date(exp).toLocaleDateString()}` : 'Caricato';
        expiryText.className = 'text-xs text-green-400';
    } else if (status === 'expiring') {
        card.className = 'flex items-center gap-3 p-4 rounded-xl border border-yellow-500/30 bg-yellow-500/10';
        icon.className = 'w-10 h-10 rounded-full flex items-center justify-center text-xl bg-yellow-500/20';
        icon.innerHTML = '<i data-lucide="alert-triangle" class="w-5 h-5"></i>';
        const exp = currentCertificate.expiration_date;
        const daysLeft = Math.ceil((new Date(exp) - new Date()) / (1000 * 60 * 60 * 24));
        expiryText.textContent = `Scade tra ${daysLeft} giorni (${new Date(exp).toLocaleDateString()})`;
        expiryText.className = 'text-xs text-yellow-400';
    } else if (status === 'expired') {
        card.className = 'flex items-center gap-3 p-4 rounded-xl border border-red-500/30 bg-red-500/10';
        icon.className = 'w-10 h-10 rounded-full flex items-center justify-center text-xl bg-red-500/20';
        icon.textContent = 'âœ—';
        expiryText.textContent = `Scaduto il ${new Date(currentCertificate.expiration_date).toLocaleDateString()}`;
        expiryText.className = 'text-xs text-red-400';
    }
}

async function uploadCertificate() {
    const fileInput = document.getElementById('cert-file-input');
    const file = fileInput.files[0];
    if (!file) return;

    const expirationDate = document.getElementById('cert-expiration-date').value;

    const formData = new FormData();
    formData.append('file', file);
    if (expirationDate) {
        formData.append('expiration_date', expirationDate);
    }

    try {
        const response = await fetch('/api/medical/certificate', {
            method: 'POST',
            credentials: 'include',
            body: formData
        });

        if (response.ok) {
            const data = await response.json();
            currentCertificate = data.certificate;
            displayCertificateStatus();
            showToast('Certificato caricato con successo', 'success');
        } else {
            const err = await response.json();
            showToast(err.detail || 'Caricamento fallito', 'error');
        }
    } catch (error) {
        console.error('Error uploading certificate:', error);
        showToast('Caricamento fallito', 'error');
    }

    fileInput.value = '';
}

function viewCertificate() {
    if (currentCertificate && currentCertificate.file_url) {
        window.open(currentCertificate.file_url, '_blank');
    }
}

async function deleteCertificate() {
    if (!currentCertificate) return;
    if (!confirm('Eliminare il certificato medico?')) return;

    try {
        const response = await fetch(`/api/medical/certificate/${currentCertificate.id}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        if (response.ok) {
            currentCertificate = null;
            displayCertificateStatus();
            showToast('Certificato eliminato', 'success');
        }
    } catch (error) {
        console.error('Error deleting certificate:', error);
        showToast('Eliminazione fallita', 'error');
    }
}
</script>

<script>
// --- PRIVACY SETTINGS ---

let currentPrivacyMode = 'public';

async function loadPrivacySettings() {
    try {
        const response = await fetch('/api/client/privacy', { credentials: 'include' });
        if (response.ok) {
            const data = await response.json();
            currentPrivacyMode = data.privacy_mode || 'public';
            updatePrivacyUI();
            loadPendingChatRequests();
        }
    } catch (error) {
        console.error('Error loading privacy settings:', error);
    }
}

function updatePrivacyUI() {
    const requestsSection = document.getElementById('chat-requests-section');
    const modes = ['public', 'private', 'staff_only'];

    // Update all option buttons
    modes.forEach(mode => {
        const opt = document.getElementById(`privacy-opt-${mode}`);
        const check = document.getElementById(`privacy-check-${mode}`);

        if (mode === currentPrivacyMode) {
            // Selected state
            opt.classList.add('border-white/30', 'bg-white/10');
            opt.classList.remove('border-white/10', 'bg-white/5');
            check.classList.remove('hidden');
            check.classList.add('flex');
        } else {
            // Unselected state
            opt.classList.remove('border-white/30', 'bg-white/10');
            opt.classList.add('border-white/10', 'bg-white/5');
            check.classList.add('hidden');
            check.classList.remove('flex');
        }
    });

    // Show pending requests section only for private mode
    if (currentPrivacyMode === 'private') {
        requestsSection.classList.remove('hidden');
    } else {
        requestsSection.classList.add('hidden');
    }
}

async function setPrivacyMode(newMode) {
    if (newMode === currentPrivacyMode) return;

    try {
        const response = await fetch('/api/client/privacy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ mode: newMode })
        });

        if (response.ok) {
            currentPrivacyMode = newMode;
            updatePrivacyUI();
            const modeLabels = {
                'public': 'PUBLIC',
                'private': 'PRIVATE',
                'staff_only': 'STAFF ONLY'
            };
            showToast(`Profilo impostato su ${modeLabels[newMode]}`, 'success');

            // Load pending requests if switching to private mode
            if (newMode === 'private') {
                loadPendingChatRequests();
            }
        } else {
            showToast('Impossibile aggiornare la privacy', 'error');
        }
    } catch (error) {
        console.error('Error updating privacy:', error);
        showToast('Impossibile aggiornare la privacy', 'error');
    }
}

async function loadPendingChatRequests() {
    if (currentPrivacyMode !== 'private') return;

    try {
        const response = await fetch('/api/client/chat-requests/pending', { credentials: 'include' });
        if (response.ok) {
            const requests = await response.json();
            renderPendingRequests(requests);
        }
    } catch (error) {
        console.error('Error loading chat requests:', error);
    }
}

function renderPendingRequests(requests) {
    const container = document.getElementById('pending-requests-list');

    if (requests.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Nessuna richiesta in attesa</p>';
        return;
    }

    container.innerHTML = requests.map(req => `
        <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center overflow-hidden">
                    ${req.from_profile_picture
                        ? `<img src="${req.from_profile_picture}" class="w-full h-full object-cover">`
                        : '<i data-lucide="user" class="w-5 h-5"></i>'}
                </div>
                <div>
                    <p class="font-bold text-white text-sm">${req.from_username}</p>
                    ${req.message ? `<p class="text-xs text-gray-400 truncate max-w-[150px]">"${req.message}"</p>` : ''}
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="respondToRequest(${req.id}, true)"
                    class="px-3 py-1.5 bg-green-500/20 text-green-400 text-xs font-bold rounded-lg hover:bg-green-500/30 transition">
                    Accetta
                </button>
                <button onclick="respondToRequest(${req.id}, false)"
                    class="px-3 py-1.5 bg-red-500/20 text-red-400 text-xs font-bold rounded-lg hover:bg-red-500/30 transition">
                    Rifiuta
                </button>
            </div>
        </div>
    `).join('');
}

async function respondToRequest(requestId, accept) {
    try {
        const response = await fetch('/api/client/chat-requests/respond', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ request_id: requestId, accept: accept })
        });

        if (response.ok) {
            showToast(accept ? 'Richiesta accettata!' : 'Richiesta rifiutata', 'success');
            loadPendingChatRequests();
        } else {
            showToast('Impossibile rispondere alla richiesta', 'error');
        }
    } catch (error) {
        console.error('Error responding to request:', error);
        showToast('Impossibile rispondere alla richiesta', 'error');
    }
}

// Load privacy settings and medical certificate on page load
loadPrivacySettings();
loadMedicalCertificate();

// --- GYM & TRAINER ASSIGNMENT (Account Settings Page) ---

async function loadGymAndTrainerInfo() {
    console.log('[GYM INFO] Loading gym and trainer info...');

    try {
        const response = await fetch('/api/client/gym-info', {
            credentials: 'include'
        });

        console.log('[GYM INFO] Response status:', response.status);

        if (!response.ok) {
            console.error('[GYM INFO] Failed to load:', response.status, await response.text());
            document.getElementById('current-gym-display').textContent = 'Errore caricamento info palestra';
            document.getElementById('current-trainer-display').textContent = 'Errore caricamento info trainer';
            return;
        }

        const info = await response.json();
        console.log('[GYM INFO] Data received:', info);

        // Update gym display
        const gymDisplay = document.getElementById('current-gym-display');
        const joinGymSection = document.getElementById('join-gym-section');
        const leaveGymSection = document.getElementById('leave-gym-section');

        if (info.has_gym) {
            gymDisplay.textContent = info.gym_name || 'Palestra sconosciuta';
            gymDisplay.classList.add('font-bold');
            joinGymSection.classList.add('hidden');
            if (leaveGymSection) leaveGymSection.classList.remove('hidden');
        } else {
            gymDisplay.textContent = 'Nessuna palestra assegnata';
            gymDisplay.classList.remove('font-bold');
            gymDisplay.classList.add('text-gray-400');
            joinGymSection.classList.remove('hidden');
            if (leaveGymSection) leaveGymSection.classList.add('hidden');
        }

        // Update trainer display
        const trainerDisplay = document.getElementById('current-trainer-display');
        const selectTrainerSection = document.getElementById('select-trainer-section');

        if (info.has_trainer) {
            trainerDisplay.textContent = info.trainer_name || 'Trainer sconosciuto';
            trainerDisplay.classList.add('font-bold');
            selectTrainerSection.classList.add('hidden');
        } else {
            trainerDisplay.textContent = 'Nessun trainer selezionato';
            trainerDisplay.classList.remove('font-bold');
            trainerDisplay.classList.add('text-gray-400');

            if (info.has_gym) {
                selectTrainerSection.classList.remove('hidden');
                await loadTrainersForSelection(info.gym_id);
            }
        }
    } catch (error) {
        console.error('[GYM INFO] Error:', error);
    }
}

async function joinGym() {
    const gymCode = document.getElementById('gym-code-input').value.trim();

    if (!gymCode) {
        alert('Inserisci un codice palestra');
        return;
    }

    try {
        const response = await fetch('/api/client/join-gym', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ gym_code: gymCode })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to join gym');
        }

        const result = await response.json();
        alert(`Iscritto a ${result.gym_name} con successo!`);

        setTimeout(() => loadGymAndTrainerInfo(), 500);
    } catch (error) {
        console.error('Error joining gym:', error);
        alert(error.message);
    }
}

async function leaveGym() {
    if (!confirm('Sei sicuro di voler lasciare la tua palestra attuale? Questo rimuoverÃ  anche il tuo trainer.')) {
        return;
    }

    try {
        const response = await fetch('/api/client/leave-gym', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to leave gym');
        }

        const result = await response.json();
        alert('Hai lasciato la palestra con successo');

        setTimeout(() => loadGymAndTrainerInfo(), 500);
    } catch (error) {
        console.error('Error leaving gym:', error);
        alert(error.message);
    }
}

async function loadTrainersForSelection(gymId) {
    try {
        const response = await fetch(`/api/gym/${gymId}/trainers`, {
            credentials: 'include'
        });

        if (!response.ok) return;

        const trainers = await response.json();
        const trainerList = document.getElementById('trainer-list');

        if (trainers.length === 0) {
            trainerList.innerHTML = '<p class="text-gray-400 text-sm">Nessun trainer disponibile</p>';
            return;
        }

        trainerList.innerHTML = trainers.map(trainer => `
            <button onclick="selectTrainer('${trainer.id}')"
                class="w-full bg-white/10 hover:bg-primary/30 border border-white/10 hover:border-primary px-4 py-3 rounded-lg text-left transition tap-effect">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-bold text-white">${trainer.name || trainer.username}</p>
                        <p class="text-xs text-gray-400">${trainer.client_count} clienti</p>
                    </div>
                    <span class="text-primary text-xl">â†’</span>
                </div>
            </button>
        `).join('');
    } catch (error) {
        console.error('Errore caricamento trainer:', error);
    }
}

async function selectTrainer(trainerId) {
    try {
        const response = await fetch('/api/client/select-trainer', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ trainer_id: trainerId })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to select trainer');
        }

        const result = await response.json();
        alert(`Assegnato a ${result.trainer_name} con successo!`);

        setTimeout(() => loadGymAndTrainerInfo(), 500);
    } catch (error) {
        console.error('Error selecting trainer:', error);
        alert(error.message);
    }
}

// Load gym/trainer info when page loads
console.log('[INIT] Account settings page - loading gym/trainer info');
setTimeout(() => loadGymAndTrainerInfo(), 100);
</script>

{% elif mode == "client_dashboard" %}
<div class="p-6 pt-10 flex justify-between items-center bg-black/50 z-10">
    <div class="flex items-center space-x-3">
        <a href="{{ 'client.html' if static_build else '/?gym_id=' + gym_id + '&role=client' }}"
            class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center tap-effect">â†</a>
        <h2 class="font-bold text-xl">Dashboard Cliente</h2>
    </div>
    <div class="flex space-x-2">
        <div onclick="openBookingChoiceForMyTrainer()" class="relative w-10 h-10 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center tap-effect cursor-pointer" title="Prenota Sessione">
            <i data-lucide="calendar" class="w-5 h-5"></i>
        </div>
        <div onclick="openClientChatModal()" class="relative w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center tap-effect cursor-pointer">
            <i data-lucide="message-circle" class="w-5 h-5"></i>
        </div>
        <div data-action="showModal" data-target="notification-modal"
            class="notification-bell w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center tap-effect relative">
            <i data-lucide="bell" class="w-5 h-5"></i>
            <span class="notification-badge hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">0</span>
        </div>
    </div>
</div>
<div class="flex-1 p-4 space-y-6">
    <!-- User Profile Card -->
    {% call card(classes="p-6 flex flex-col items-center relative overflow-hidden") %}
    <div class="absolute top-0 right-0 w-32 h-32 bg-primary/20 blur-3xl rounded-full -mr-10 -mt-10"></div>

    <!-- Profile Picture with Upload -->
    <div class="relative z-10 mb-4 group">
        <div id="profile-avatar-container"
            class="w-24 h-24 rounded-full bg-gradient-to-tr from-gray-700 to-gray-600 border-2 border-primary overflow-hidden cursor-pointer"
            onclick="document.getElementById('profile-picture-input').click()">
            <img id="profile-avatar-img" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Alex" class="w-full h-full object-cover">
        </div>
        <!-- Edit overlay -->
        <div class="absolute inset-0 rounded-full bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center cursor-pointer"
            onclick="document.getElementById('profile-picture-input').click()">
            <i data-lucide="camera" class="w-6 h-6 text-white"></i>
        </div>
        <!-- Hidden file input -->
        <input type="file" id="profile-picture-input" accept="image/*" class="hidden" onchange="uploadProfilePicture(this)">
    </div>

    <h2 class="text-2xl font-black text-white mb-1" id="client-display-name">Caricamento...</h2>
    <p class="text-gray-400 text-sm mb-4" id="client-display-email">Caricamento...</p>
    <div class="flex space-x-4 text-xs text-gray-500 uppercase tracking-wider font-bold">
        <span id="member-since">Membro da Gen 2025</span>
    </div>
    {% endcall %}

    <!-- Fitness Goal Selector -->
    <div class="space-y-3">
        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider ml-1">Obiettivo Fitness</h3>
        <p class="text-xs text-gray-500 ml-1 -mt-1" id="goal-subtitle">Regola il tuo obiettivo calorico giornaliero</p>

        <!-- Trainer managed notice (hidden by default) -->
        <div id="trainer-managed-notice" class="hidden bg-gradient-to-r from-purple-500/20 to-blue-500/20 border border-purple-500/30 rounded-xl p-3 flex items-center gap-3">
            <div class="w-8 h-8 rounded-full bg-purple-500/30 flex items-center justify-center">
                <svg class="w-4 h-4 text-purple-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
            </div>
            <p class="text-sm text-purple-300">Il tuo trainer gestisce il tuo piano nutrizionale</p>
        </div>

        <div class="grid grid-cols-3 gap-3" id="goal-selector">
            <!-- Cut -->
            <button onclick="selectFitnessGoal('cut')" id="goal-cut"
                class="goal-card p-4 rounded-2xl border-2 border-transparent bg-white/5 hover:bg-white/10 transition-all duration-300 flex flex-col items-center space-y-2 tap-effect">
                <div class="goal-icon w-12 h-12 rounded-full bg-blue-500/20 flex items-center justify-center text-2xl transition-all duration-300">
                    <svg class="w-6 h-6 text-blue-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 19V5M5 12l7-7 7 7"/>
                    </svg>
                </div>
                <span class="font-bold text-white text-sm">Definizione</span>
                <span class="text-[10px] text-gray-500">-500 kcal</span>
            </button>

            <!-- Maintain -->
            <button onclick="selectFitnessGoal('maintain')" id="goal-maintain"
                class="goal-card p-4 rounded-2xl border-2 border-transparent bg-white/5 hover:bg-white/10 transition-all duration-300 flex flex-col items-center space-y-2 tap-effect">
                <div class="goal-icon w-12 h-12 rounded-full bg-green-500/20 flex items-center justify-center text-2xl transition-all duration-300">
                    <svg class="w-6 h-6 text-green-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14"/>
                    </svg>
                </div>
                <span class="font-bold text-white text-sm">Mantenimento</span>
                <span class="text-[10px] text-gray-500">Base</span>
            </button>

            <!-- Bulk -->
            <button onclick="selectFitnessGoal('bulk')" id="goal-bulk"
                class="goal-card p-4 rounded-2xl border-2 border-transparent bg-white/5 hover:bg-white/10 transition-all duration-300 flex flex-col items-center space-y-2 tap-effect">
                <div class="goal-icon w-12 h-12 rounded-full bg-orange-500/20 flex items-center justify-center text-2xl transition-all duration-300">
                    <svg class="w-6 h-6 text-orange-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12l7 7 7-7"/>
                    </svg>
                </div>
                <span class="font-bold text-white text-sm">Massa</span>
                <span class="text-[10px] text-gray-500">+400 kcal</span>
            </button>
        </div>

        <!-- Current target display -->
        <div class="bg-white/5 rounded-xl p-3 flex items-center justify-between">
            <span class="text-sm text-gray-400">Obiettivo Giornaliero</span>
            <span class="font-bold text-white" id="current-calorie-target">2000 kcal</span>
        </div>
    </div>

    <!-- Account Actions -->
    <div class="space-y-3">
        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider ml-1">Impostazioni</h3>

        <button onclick="openSubscriptionPlans()"
            class="w-full bg-white/5 p-4 rounded-2xl flex items-center justify-between tap-effect group hover:bg-white/10 transition">
            <div class="flex items-center space-x-4">
                <div class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center text-primary">
                    <i data-lucide="star" class="w-4 h-4 inline-block align-middle"></i>
                </div>
                <div class="text-left">
                    <p class="font-bold text-white group-hover:text-primary transition">Piani di Abbonamento</p>
                    <p id="membership-status-text" class="text-xs text-gray-400">Visualizza e gestisci abbonamento</p>
                </div>
            </div>
            <span class="text-gray-500">â†’</span>
        </button>

        <a href="{{ 'client_account.html' if static_build else '/?gym_id=' + gym_id + '&role=client&mode=account_settings' }}"
            class="w-full bg-white/5 p-4 rounded-2xl flex items-center justify-between tap-effect group hover:bg-white/10 transition">
            <div class="flex items-center space-x-4">
                <div class="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-400">
                    <i data-lucide="settings" class="w-4 h-4 inline-block align-middle"></i>
                </div>
                <div class="text-left">
                    <p class="font-bold text-white group-hover:text-purple-400 transition">Gestione Account</p>
                    <p class="text-xs text-gray-400">Dettagli profilo e preferenze</p>
                </div>
            </div>
            <span class="text-gray-500">â†’</span>
        </a>

        <button onclick="logout()"
            class="w-full bg-red-500/10 p-4 rounded-2xl flex items-center justify-between tap-effect group hover:bg-red-500/20 transition mt-6">
            <div class="flex items-center space-x-4">
                <div class="w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center text-red-500">
                    <i data-lucide="log-out" class="w-4 h-4 inline-block align-middle"></i>
                </div>
                <div class="text-left">
                    <p class="font-bold text-red-500 transition">Esci</p>
                    <p class="text-xs text-red-500/60">Disconnettiti dal tuo account</p>
                </div>
            </div>
        </button>
    </div>
</div>

<script>
// --- PROFILE PICTURE FUNCTIONS (Client Dashboard) ---
async function loadProfilePicture() {
    try {
        const res = await fetch('/api/profile/picture');
        if (res.ok) {
            const data = await res.json();
            if (data.profile_picture) {
                updateAllAvatars(data.profile_picture);
            } else {
                // Use dicebear with username as seed
                const username = data.username || 'User';
                const defaultAvatar = `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(username)}`;
                updateAllAvatars(defaultAvatar);
            }
        }
    } catch (e) {
        console.error('Error loading profile picture:', e);
    }
}

function updateAllAvatars(url) {
    const avatarIds = ['profile-avatar-img'];
    avatarIds.forEach(id => {
        const img = document.getElementById(id);
        if (img) {
            img.src = url;
        }
    });
}

async function uploadProfilePicture(input) {
    const file = input.files?.[0];
    if (!file) return;

    // Validate file type
    const validTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
    if (!validTypes.includes(file.type)) {
        showToast('Seleziona un file immagine valido (JPG, PNG, WEBP, GIF)', 'error');
        return;
    }

    // Validate file size (5MB max)
    if (file.size > 5 * 1024 * 1024) {
        showToast('Immagine troppo grande. Dimensione massima 5MB', 'error');
        return;
    }

    // Show loading state
    const container = document.getElementById('profile-avatar-container');
    if (container) {
        container.style.opacity = '0.5';
    }

    try {
        const formData = new FormData();
        formData.append('file', file);

        const res = await fetch('/api/profile/picture', {
            method: 'POST',
            body: formData
        });

        const data = await res.json();

        if (res.ok) {
            updateAllAvatars(data.profile_picture);
            showToast('Foto profilo aggiornata!', 'success');
        } else {
            showToast(data.detail || 'Impossibile caricare l\'immagine', 'error');
        }
    } catch (e) {
        console.error('Error uploading profile picture:', e);
        showToast('Impossibile caricare l\'immagine', 'error');
    } finally {
        if (container) {
            container.style.opacity = '1';
        }
        input.value = '';
    }
}

// Load profile picture on page load
document.addEventListener('DOMContentLoaded', () => {
    loadProfilePicture();
    loadFitnessGoal();
});

// --- FITNESS GOAL FUNCTIONS ---
let currentFitnessGoal = 'maintain';
let baseCalories = 2000;
let hasTrainer = false;

async function loadFitnessGoal() {
    try {
        const res = await fetch('/api/client/fitness-goal', { credentials: 'include' });
        if (res.ok) {
            const data = await res.json();
            currentFitnessGoal = data.fitness_goal || 'maintain';
            baseCalories = data.base_calories || 2000;
            hasTrainer = data.has_trainer || false;
            updateGoalUI(currentFitnessGoal, data.calories_target, hasTrainer);
        }
    } catch (e) {
        console.error('Error loading fitness goal:', e);
    }
}

function updateGoalUI(goal, targetCalories, trainerManaged = false) {
    const goalColors = {
        cut: { border: '#3b82f6', bg: 'rgba(59, 130, 246, 0.25)', glow: '0 0 20px rgba(59, 130, 246, 0.5)' },
        maintain: { border: '#22c55e', bg: 'rgba(34, 197, 94, 0.25)', glow: '0 0 20px rgba(34, 197, 94, 0.5)' },
        bulk: { border: '#f97316', bg: 'rgba(249, 115, 22, 0.25)', glow: '0 0 20px rgba(249, 115, 22, 0.5)' }
    };

    // Show/hide trainer managed notice
    const trainerNotice = document.getElementById('trainer-managed-notice');
    const goalSubtitle = document.getElementById('goal-subtitle');
    if (trainerNotice) {
        trainerNotice.classList.toggle('hidden', !trainerManaged);
    }
    if (goalSubtitle) {
        goalSubtitle.textContent = trainerManaged ? 'Impostato dal tuo trainer' : 'Regola il tuo obiettivo calorico giornaliero';
    }

    // Remove active state and checkmarks from all cards
    document.querySelectorAll('.goal-card').forEach(card => {
        card.style.border = '2px solid transparent';
        card.style.background = 'rgba(255,255,255,0.05)';
        card.style.boxShadow = 'none';
        card.style.transform = 'scale(1)';
        card.style.opacity = '1';
        card.style.pointerEvents = 'auto';
        // Remove any existing checkmark
        const existingCheck = card.querySelector('.goal-checkmark');
        if (existingCheck) existingCheck.remove();
    });

    // Add active state to selected card with prominent inline styling
    const activeCard = document.getElementById(`goal-${goal}`);
    const colors = goalColors[goal] || goalColors.maintain;
    if (activeCard) {
        activeCard.style.border = `3px solid ${colors.border}`;
        activeCard.style.background = colors.bg;
        activeCard.style.boxShadow = colors.glow;
        activeCard.style.transform = 'scale(1.05)';

        // Add a checkmark badge
        const checkmark = document.createElement('div');
        checkmark.className = 'goal-checkmark';
        checkmark.innerHTML = `<svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>`;
        checkmark.style.cssText = `position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; background: ${colors.border}; border-radius: 50%; display: flex; align-items: center; justify-content: center;`;
        activeCard.style.position = 'relative';
        activeCard.appendChild(checkmark);
    }

    // If trainer managed, disable other buttons (make them faded and unclickable)
    if (trainerManaged) {
        document.querySelectorAll('.goal-card').forEach(card => {
            if (card.id !== `goal-${goal}`) {
                card.style.opacity = '0.4';
                card.style.pointerEvents = 'none';
            }
        });
    }

    // Update calorie display
    const calorieDisplay = document.getElementById('current-calorie-target');
    if (calorieDisplay && targetCalories) {
        calorieDisplay.textContent = `${targetCalories} kcal`;
    }
}

async function selectFitnessGoal(goal) {
    if (goal === currentFitnessGoal) return;
    if (hasTrainer) {
        showToast('Il tuo trainer gestisce il tuo piano nutrizionale', 'error');
        return;
    }

    try {
        const res = await fetch('/api/client/fitness-goal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ fitness_goal: goal })
        });

        if (res.ok) {
            const data = await res.json();
            currentFitnessGoal = goal;
            updateGoalUI(goal, data.new_calories_target, hasTrainer);
            showToast(`Obiettivo impostato: ${goal.charAt(0).toUpperCase() + goal.slice(1)}! Target: ${data.new_calories_target} kcal`, 'success');
        } else {
            const err = await res.json();
            showToast(err.detail || 'Impossibile aggiornare l\'obiettivo', 'error');
        }
    } catch (e) {
        console.error('Error updating fitness goal:', e);
        showToast('Impossibile aggiornare l\'obiettivo', 'error');
    }
}
</script>

{% else %}
<div id="top-bar" class="fixed top-0 left-0 right-0 px-4 pb-3 flex justify-between items-center z-30 transition-all duration-200" style="padding-top: max(env(safe-area-inset-top, 0px), 2.5rem);">
    <div class="flex items-center">
        <img src="/static/fitos-logo.svg" class="h-7 object-contain">
    </div>
    <div class="flex items-center space-x-2">
        <!-- Access QR Button -->
        <div onclick="openAccessQrModal()" class="relative w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center tap-effect cursor-pointer" title="Accesso Palestra">
            <i data-lucide="qr-code" class="w-5 h-5"></i>
        </div>
        <!-- Booking Icon -->
        <div onclick="openBookingChoiceForMyTrainer()" class="relative w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center tap-effect cursor-pointer" title="Prenota Sessione">
            <i data-lucide="calendar" class="w-5 h-5"></i>
        </div>
        <!-- Notifications Icon with Badge -->
        <div data-action="showModal" data-target="notification-modal"
            class="notification-bell w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center tap-effect relative">
            <i data-lucide="bell" class="w-5 h-5"></i>
            <span class="notification-badge hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">0</span>
        </div>
        <!-- Messages Icon with Badge -->
        <div onclick="openClientChatModal()" class="relative w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center tap-effect cursor-pointer">
            <i data-lucide="send" class="w-5 h-5"></i>
            <span id="unread-messages-badge" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center hidden">0</span>
        </div>
    </div>
</div>
<script>
(function(){
    const bar = document.getElementById('top-bar');
    let scrolled = false;
    window.addEventListener('scroll', function(){
        if(window.scrollY > 10 && !scrolled){
            scrolled = true;
            bar.style.backgroundColor = 'rgba(17,24,39,0.85)';
            bar.style.backdropFilter = 'blur(12px)';
            bar.style.webkitBackdropFilter = 'blur(12px)';
            bar.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
        } else if(window.scrollY <= 10 && scrolled){
            scrolled = false;
            bar.style.backgroundColor = '';
            bar.style.backdropFilter = '';
            bar.style.webkitBackdropFilter = '';
            bar.style.borderBottom = '';
        }
    });
})();
</script>
<div class="flex-1 p-4 space-y-4" style="padding-top: calc(max(env(safe-area-inset-top, 0px), 2.5rem) + 3.5rem);">
    <!-- Today's Workout Card -->
    <div class="slide-up">
        <div class="rounded-2xl p-6 relative overflow-hidden tap-effect" style="background: linear-gradient(135deg, #e8461e 0%, #f15a24 50%, #f97316 100%);">
            <div class="flex justify-between items-start mb-4">
                <span class="text-[11px] font-bold uppercase tracking-wider text-white/70">Allenamento di Oggi</span>
                <a href="{{ 'workout.html' if static_build else '/?gym_id=' + gym_id + '&role=client&mode=workout' }}" class="w-9 h-9 rounded-xl bg-white/15 flex items-center justify-center tap-effect">
                    <i data-lucide="pencil" class="w-4 h-4 text-white/80"></i>
                </a>
            </div>
            <h3 class="text-3xl font-black uppercase mb-3 text-white leading-tight" id="workout-title">...</h3>
            <p class="text-sm text-white/70 mb-6">
                &bull; <span id="workout-duration"></span> &bull; <span id="workout-difficulty"></span>
            </p>
            <div class="border-t border-white/20 pt-5" id="workout-button-container">
                <div class="flex gap-3">
                    <a href="{{ 'workout.html' if static_build else '/?gym_id=' + gym_id + '&role=client&mode=workout' }}" id="workout-main-btn"
                        class="flex-1 py-3.5 bg-white/20 hover:bg-white/30 text-white text-center font-bold uppercase rounded-xl transition-all text-sm tracking-wide backdrop-blur-sm">
                        AVVIA ALLENAMENTO
                    </a>
                    <button onclick="event.preventDefault(); event.stopPropagation(); openCoopModal()" id="coop-badge-btn"
                        class="px-5 py-3.5 bg-white/10 border border-white/20 rounded-xl flex items-center justify-center gap-2 tap-effect hover:bg-white/20 transition-all"
                        title="Inizia un allenamento CO-OP con un amico">
                        <i data-lucide="users" class="w-5 h-5 text-white"></i>
                        <span class="text-sm font-bold uppercase tracking-wide text-white">CO-OP</span>
                    </button>
                </div>
                <!-- CO-OP completed indicator (hidden by default, shown if was CO-OP workout) -->
                <div id="coop-completed-badge" class="hidden absolute -top-2 -right-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-lg">
                    CO-OP
                </div>
            </div>
        </div>
    </div>

    <!-- Streak Card with Gems -->
    <a href="{{ 'client_calendar.html' if static_build else '/?gym_id=' + gym_id + '&role=client&mode=calendar' }}"
        class="block slide-up" style="animation-delay: 0.1s;">
        {% call card(classes="p-5 flex justify-between items-center relative overflow-hidden tap-effect") %}
        <div class="absolute top-0 right-0 w-32 h-32 bg-orange-500/30 blur-3xl rounded-full -mr-10 -mt-10 animate-pulse"></div>
        <div class="absolute bottom-0 left-0 w-24 h-24 bg-red-500/20 blur-2xl rounded-full -ml-8 -mb-8"></div>
        <div class="flex items-center gap-6 relative z-10">
            <div class="flex items-center gap-3">
                <div class="flame-animate"><i data-lucide="flame" class="w-8 h-8"></i></div>
                <div>
                    <h1 class="text-4xl font-black bg-gradient-to-r from-orange-400 via-red-400 to-orange-500 bg-clip-text text-transparent" id="client-streak">0</h1>
                    <p class="text-orange-400 font-bold uppercase tracking-wider text-[10px]">Settimane di Serie</p>
                </div>
            </div>
            <div class="h-10 w-px bg-white/10"></div>
            <div>
                <p class="text-gray-400 text-[10px] mb-0.5">Prossimo Obiettivo</p>
                <p class="font-bold text-lg uppercase" id="client-next-goal">4 Settimane</p>
            </div>
        </div>
        <!-- Gems Badge -->
        <div data-action="showModal" data-target="shop-modal"
            class="flex items-center gap-2 bg-gradient-to-r from-yellow-500/20 to-amber-500/20 border border-yellow-500/30 px-4 py-2 rounded-full tap-effect hover:from-yellow-500/30 hover:to-amber-500/30 transition shadow-lg shadow-yellow-500/10 relative z-10"
            onclick="event.preventDefault(); event.stopPropagation();">
            <span class="text-lg">ðŸ”¶</span>
            <span class="text-sm font-bold bg-gradient-to-r from-yellow-300 to-amber-400 bg-clip-text text-transparent" id="gem-count">0</span>
        </div>
        {% endcall %}
    </a>

    <!-- Photo + Meals Section -->
    <div class="slide-up grid grid-cols-2 gap-3" style="animation-delay: 0.15s;">
        <!-- Left: Latest Physique Photo + Progressi -->
        <a href="{{ '/?gym_id=' + gym_id + '&role=client&mode=body_progress' }}" class="block">
            <div id="home-physique-card" class="rounded-2xl overflow-hidden relative tap-effect" style="aspect-ratio: 3/4;">
                <!-- Photo gets injected by JS, or placeholder shows -->
                <div id="home-physique-photo" class="w-full h-full bg-white/5 flex items-center justify-center">
                    <i data-lucide="camera" class="w-8 h-8 text-white/20"></i>
                </div>
                <div id="home-physique-date" class="absolute top-3 left-0 right-0 text-center hidden">
                    <span class="bg-black/50 backdrop-blur-sm text-white text-xs font-bold px-3 py-1.5 rounded-full"></span>
                </div>
                <!-- PROGRESSI button inside card at bottom -->
                <div class="absolute bottom-3 left-3 right-3">
                    <div class="py-2.5 rounded-xl border border-orange-500/50 text-orange-400 text-xs font-bold uppercase tracking-wider text-center backdrop-blur-sm bg-black/30">
                        Progressi
                    </div>
                </div>
            </div>
        </a>
        <!-- Right: Today's Meals + Dieta -->
        <a href="{{ '/?gym_id=' + gym_id + '&role=client&mode=progress' }}" class="block">
            <div class="glass-card rounded-2xl p-3 flex flex-col relative overflow-hidden" style="aspect-ratio: 3/4;">
                <p class="text-[10px] font-bold uppercase tracking-wider text-gray-400 mb-3">Pasti del Giorno</p>
                <div id="home-meals-list" class="flex-1 space-y-3 overflow-hidden">
                    <div class="flex items-start gap-2">
                        <div class="w-0.5 rounded-full bg-white/10 flex-shrink-0 mt-1" style="min-height:28px;"></div>
                        <div>
                            <p class="text-xs text-white/30">Nessun pasto registrato</p>
                        </div>
                    </div>
                </div>
                <!-- DIETA button inside card at bottom -->
                <div class="mt-auto pt-2">
                    <div class="py-2.5 rounded-xl bg-white/5 border border-white/10 text-orange-400 text-xs font-bold uppercase tracking-wider text-center">
                        Dieta
                    </div>
                </div>
            </div>
        </a>
    </div>

    <!-- Trainer & Appointments Section -->
    <div class="slide-up" style="animation-delay: 0.15s;">
        <div id="trainer-section">
            <!-- Trainer Card (Expandable) -->
            <div class="glass-card overflow-hidden">
                <!-- Header row (clickable) -->
                <div onclick="toggleTrainerCard()" class="p-4 cursor-pointer hover:bg-white/5 transition tap-effect">
                    <div class="flex items-start justify-between">
                        <!-- Left: Avatar + info -->
                        <div class="flex items-start gap-3 flex-1 min-w-0">
                            <!-- Avatar column: icon + availability underneath -->
                            <div class="flex flex-col items-center flex-shrink-0">
                                <div id="trainer-avatar" class="trainer-avatar-box w-10 h-10 rounded-full bg-white/10 flex items-center justify-center overflow-hidden">
                                    <i data-lucide="user" class="w-5 h-5 text-white/50"></i>
                                </div>
                                <div id="trainer-inline-availability" class="hidden mt-1.5 flex items-center gap-1 text-[10px] text-gray-400 whitespace-nowrap">
                                    <i data-lucide="clock" class="w-3 h-3 text-orange-400"></i>
                                    <span id="trainer-availability-text"></span>
                                </div>
                            </div>
                            <!-- Name + specialties column -->
                            <div class="flex-1 min-w-0">
                                <p class="text-[10px] text-gray-400 uppercase tracking-wider font-semibold">Il Mio Trainer</p>
                                <p class="font-bold text-white" id="trainer-name">{{ server_trainer_name or '' }}</p>
                            </div>
                        </div>
                        <!-- Right: buttons + chevron -->
                        <div class="flex items-center gap-2 flex-shrink-0 ml-2">
                            <div class="flex gap-2" onclick="event.stopPropagation()">
                                <button onclick="openTrainerDirectChat()" class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center hover:bg-white/20 transition tap-effect" title="Messaggio">
                                    <i data-lucide="message-circle" class="w-5 h-5"></i>
                                </button>
                                <button onclick="openBookingModal()" class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center hover:bg-white/20 transition tap-effect" title="Prenota Sessione 1-a-1">
                                    <i data-lucide="calendar" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <i data-lucide="chevron-down" id="trainer-chevron" class="w-5 h-5 text-gray-400 ml-1"></i>
                        </div>
                    </div>
                </div>

                <!-- Expandable content (appointments + profile link) -->
                <div id="trainer-expand-content">
                    <div class="px-4 pb-4 space-y-3">
                        <!-- Upcoming Appointments -->
                        <div>
                            <p class="text-[10px] text-gray-400 uppercase tracking-wider font-semibold mb-2">Prossimi Appuntamenti</p>
                            <div id="appointments-list" class="space-y-2">
                                <!-- Appointments will be loaded here -->
                            </div>
                        </div>

                        <!-- Full profile link -->
                        <button onclick="openTrainerProfileModal()" class="w-full py-2 text-xs text-orange-400 hover:text-orange-300 font-medium transition tap-effect">
                            Vedi Profilo Completo â†’
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nutritionist Card (Expandable, hidden by default) -->
        <div id="nutritionist-card" class="hidden mt-3">
            <div class="glass-card overflow-hidden">
                <!-- Header row (clickable) -->
                <div onclick="toggleNutritionistCard()" class="p-4 cursor-pointer hover:bg-white/5 transition tap-effect">
                    <div class="flex items-start justify-between">
                        <!-- Left: Avatar + info -->
                        <div class="flex items-start gap-3 flex-1 min-w-0">
                            <div class="flex flex-col items-center flex-shrink-0">
                                <div id="nutritionist-avatar" class="trainer-avatar-box w-10 h-10 rounded-full bg-white/10 flex items-center justify-center overflow-hidden">
                                    <i data-lucide="apple" class="w-5 h-5 text-white/50"></i>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-[10px] text-gray-400 uppercase tracking-wider font-semibold">Il Mio Nutrizionista</p>
                                <p class="font-bold text-white" id="nutritionist-name"></p>
                            </div>
                        </div>
                        <!-- Right: buttons + chevron -->
                        <div class="flex items-center gap-2 flex-shrink-0 ml-2">
                            <div class="flex gap-2" onclick="event.stopPropagation()">
                                <button onclick="openNutritionistDirectChat()" class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center hover:bg-white/20 transition tap-effect" title="Messaggio">
                                    <i data-lucide="message-circle" class="w-5 h-5"></i>
                                </button>
                                <button onclick="openBookingModal('nutritionist')" class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center hover:bg-white/20 transition tap-effect" title="Prenota Consulenza">
                                    <i data-lucide="calendar" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <i data-lucide="chevron-down" id="nutritionist-chevron" class="w-5 h-5 text-gray-400 ml-1"></i>
                        </div>
                    </div>
                </div>

                <!-- Expandable content (appointments only) -->
                <div id="nutritionist-expand-content">
                    <div class="px-4 pb-4 space-y-3">
                        <div>
                            <p class="text-[10px] text-gray-400 uppercase tracking-wider font-semibold mb-2">Prossime Consulenze</p>
                            <div id="nutrition-appointments-list" class="space-y-2">
                                <!-- Nutrition appointments will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gym Members Section -->
    <div class="slide-up" style="animation-delay: 0.18s;">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider ml-1">Membri Palestra</h3>
            <button onclick="openGymMembersModal()" class="text-xs text-orange-400 hover:text-orange-300 transition tap-effect">
                Vedi tutti â†’
            </button>
        </div>
        <div class="glass-card p-4">
            <div id="gym-members-preview" class="flex items-center space-x-2">
                <div class="flex -space-x-2" id="members-avatars">
                    <!-- Member avatars will be loaded here -->
                </div>
                <span id="members-count" class="text-sm text-gray-400 ml-2">Caricamento...</span>
            </div>
        </div>
    </div>

    <!-- Friends Section -->
    <div class="slide-up" style="animation-delay: 0.19s;">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider ml-1">Amici</h3>
            <button onclick="openFriendsModal()" class="text-xs text-orange-400 hover:text-orange-300 transition tap-effect">
                Gestisci â†’
            </button>
        </div>
        <div class="glass-card p-4">
            <div id="friends-preview" class="flex items-center space-x-2">
                <div class="flex -space-x-2" id="friends-avatars">
                    <!-- Friend avatars will be loaded here -->
                </div>
                <span id="friends-count" class="text-sm text-gray-400 ml-2">Caricamento...</span>
            </div>
            <div id="friend-requests-badge" class="hidden mt-2 text-xs text-orange-400">
                <span id="pending-requests-count">0</span> richiesta/e in attesa
            </div>
        </div>
    </div>

    <div class="slide-up" style="animation-delay: 0.2s;">
        <a href="{{ '/?gym_id=' + gym_id + '&role=client&mode=leaderboard' }}"
            class="glass-card p-4 flex items-center justify-between tap-effect group block">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-lime-500/20 flex items-center justify-center">
                    <i data-lucide="trophy" class="w-5 h-5 text-lime-400"></i>
                </div>
                <div>
                    <p class="text-sm font-bold text-white">Sfide Giornaliere & Classifiche</p>
                    <p class="text-[10px] text-gray-400">Completa sfide per guadagnare gemme</p>
                </div>
            </div>
            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-500 group-hover:text-white transition"></i>
        </a>
    </div>
</div>

<!-- Trainer Selection Modal -->
<div id="trainer-selection-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Seleziona il Tuo Trainer</h3>
            <button onclick="closeTrainerSelectionModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>
        <p class="text-gray-400 text-sm mb-4">Scegli un trainer dalla tua palestra per guidarti nel tuo percorso fitness</p>
        <div id="home-trainer-list" class="space-y-3">
            <!-- Trainers will be loaded here -->
        </div>
    </div>
</div>

<!-- Trainer Profile Modal -->
<div id="trainer-profile-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeTrainerProfileModal()">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full max-h-[85vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Profilo Trainer</h3>
            <button onclick="closeTrainerProfileModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>

        <!-- Profile Header -->
        <div class="text-center mb-6">
            <div id="profile-trainer-avatar" class="w-24 h-24 rounded-full bg-gradient-to-tr from-red-500 to-orange-500 flex items-center justify-center mx-auto mb-4 overflow-hidden">
                <i data-lucide="user" class="w-10 h-10"></i>
            </div>
            <h2 id="profile-trainer-name" class="text-2xl font-bold text-white">Nome Trainer</h2>
            <p class="text-orange-400 text-sm font-medium">Personal Trainer</p>
            <div id="profile-trainer-badge" class="mt-2 hidden">
                <span class="bg-green-500/20 text-green-400 text-xs px-3 py-1 rounded-full border border-green-500/30">
                    âœ“ Il Tuo Trainer
                </span>
            </div>
        </div>

        <!-- Bio Section -->
        <div id="profile-trainer-bio-section" class="mb-4 hidden">
            <p id="profile-trainer-bio" class="text-sm text-gray-300 text-center italic"></p>
        </div>

        <!-- Specialties Section -->
        <div id="profile-trainer-specialties" class="flex flex-wrap justify-center gap-2 mb-6 hidden">
            <!-- Specialty tags will be populated by JS -->
        </div>

        <!-- Trainer Stats -->
        <div class="grid grid-cols-2 gap-3 mb-6">
            <div class="glass-card p-3 rounded-xl text-center">
                <p id="profile-trainer-clients" class="text-2xl font-bold text-white">-</p>
                <p class="text-xs text-gray-400">Clienti Attivi</p>
            </div>
            <div class="glass-card p-3 rounded-xl text-center">
                <p id="profile-trainer-availability" class="text-lg font-bold text-white">-</p>
                <p class="text-xs text-gray-400">DisponibilitÃ </p>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="space-y-3">
            <button id="profile-message-btn" onclick="messageTrainerFromProfile()" class="w-full bg-white/10 py-3 rounded-xl text-sm font-bold hover:bg-white/20 transition tap-effect flex items-center justify-center gap-2">
                <i data-lucide="message-circle" class="w-4 h-4 inline-block align-middle"></i> Invia Messaggio
            </button>
            <button id="profile-book-btn" onclick="bookWithTrainerFromProfile()" class="w-full bg-orange-500 py-3 rounded-xl text-sm font-bold hover:bg-orange-400 transition tap-effect flex items-center justify-center gap-2">
                <i data-lucide="calendar" class="w-4 h-4 inline-block align-middle"></i> Prenota Sessione
            </button>
            <button id="profile-select-btn" onclick="selectTrainerFromProfile()" class="w-full bg-white/5 border border-white/20 py-3 rounded-xl text-sm font-bold hover:bg-white/10 transition tap-effect hidden">
                âœ“ Seleziona come Mio Trainer
            </button>
        </div>
    </div>
</div>

<!-- Booking Choice Modal (1-on-1 vs Course vs Facility) -->
<div id="booking-choice-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeBookingChoiceModal()">
    <div class="glass-card p-6 rounded-2xl max-w-sm w-full">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Prenota</h3>
            <button onclick="closeBookingChoiceModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>
        <p class="text-gray-400 text-sm mb-6">Che tipo di sessione vuoi prenotare?</p>

        <div class="space-y-3">
            <!-- 1-on-1 Session Option -->
            <button id="booking-choice-personal-btn" onclick="selectBookingType('personal')" class="w-full bg-gradient-to-r from-orange-500 to-red-500 p-4 rounded-xl text-left hover:scale-[1.02] transition tap-effect">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                        <i data-lucide="user" class="w-6 h-6 stroke-current"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-white">Sessione 1-a-1</h4>
                        <p class="text-sm text-white/70">Allenamento personale su misura per te</p>
                    </div>
                </div>
            </button>

            <!-- Group Course Option -->
            <button onclick="selectBookingType('course')" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 p-4 rounded-xl text-left hover:scale-[1.02] transition tap-effect">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                        <i data-lucide="users" class="w-6 h-6 stroke-current"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-white">Corso di Gruppo</h4>
                        <p class="text-sm text-white/70">Partecipa a un corso fitness programmato</p>
                    </div>
                </div>
            </button>

            <!-- Nutritionist Consultation Option -->
            <button id="booking-choice-nutritionist-btn" onclick="selectBookingType('nutritionist')" class="w-full bg-gradient-to-r from-cyan-500 to-blue-500 p-4 rounded-xl text-left hover:scale-[1.02] transition tap-effect">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                        <i data-lucide="apple" class="w-6 h-6 stroke-current"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-white">Nutritionist Consultation</h4>
                        <p class="text-sm text-white/70">Diet & nutrition guidance</p>
                    </div>
                </div>
            </button>

            <!-- Book Facility Option -->
            <button onclick="selectBookingType('facility')" class="w-full bg-gradient-to-r from-green-500 to-teal-500 p-4 rounded-xl text-left hover:scale-[1.02] transition tap-effect">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                        <i data-lucide="map-pin" class="w-6 h-6 stroke-current"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-white">Prenota Struttura</h4>
                        <p class="text-sm text-white/70">Campi, sale, spazi e altro</p>
                    </div>
                </div>
            </button>

            <!-- Nutritionist Consultation Option -->
            <button id="booking-choice-nutrition-btn" onclick="selectBookingType('nutrition')" class="hidden w-full bg-gradient-to-r from-cyan-500 to-blue-500 p-4 rounded-xl text-left hover:scale-[1.02] transition tap-effect">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                        <i data-lucide="apple" class="w-6 h-6 stroke-current"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-white">Consulenza Nutrizionale</h4>
                        <p class="text-sm text-white/70">Prenota un appuntamento con il nutrizionista</p>
                    </div>
                </div>
            </button>
        </div>
    </div>
</div>

<!-- My QR Code Modal -->
<div id="my-qr-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeMyQrModal()">
    <div class="bg-[#1a1a1a] p-6 rounded-2xl max-w-sm w-full border border-white/10 text-center">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Il Mio QR Code</h3>
            <button onclick="closeMyQrModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>
        <div id="my-qr-code" class="bg-white rounded-2xl p-4 inline-block mx-auto mb-4"></div>
        <p id="my-qr-name" class="text-white font-semibold text-lg"></p>
        <p class="text-gray-400 text-sm mt-1">Mostra questo all'ingresso della palestra</p>
    </div>
</div>

<!-- Access QR Modal (30-second temporary code) -->
<div id="access-qr-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeAccessQrModal()">
    <div class="bg-[#1a1a1a] p-6 rounded-2xl max-w-sm w-full border border-white/10 text-center">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Accesso Palestra</h3>
            <button onclick="closeAccessQrModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>
        <div id="access-qr-code" class="bg-white rounded-2xl p-4 inline-block mx-auto mb-4"></div>
        <p id="access-qr-name" class="text-white font-semibold text-lg mb-1"></p>
        <div class="flex items-center justify-center gap-2 mb-2">
            <div class="w-full bg-white/10 rounded-full h-2 overflow-hidden">
                <div id="access-qr-timer-bar" class="bg-green-500 h-full rounded-full transition-all duration-1000 ease-linear" style="width: 100%"></div>
            </div>
        </div>
        <p id="access-qr-timer-text" class="text-green-400 text-sm font-mono font-bold">30s</p>
        <p class="text-gray-500 text-xs mt-1">Scansiona al tornello per entrare</p>
    </div>
</div>

<!-- Gym Courses Modal -->
<div id="gym-courses-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeGymCoursesModal()">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full max-h-[85vh] flex flex-col overflow-hidden">
        <div class="flex justify-between items-center mb-2 flex-shrink-0">
            <h3 class="text-xl font-bold">Corsi di Gruppo</h3>
            <button onclick="closeGymCoursesModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>
        <p class="text-gray-400 text-sm mb-3 flex-shrink-0">Sfoglia tutti i corsi disponibili nella tua palestra</p>

        <!-- Filter pills -->
        <div id="gym-courses-filters" class="flex gap-2 overflow-x-auto pb-3 mb-3 flex-shrink-0 scrollbar-hide" style="-webkit-overflow-scrolling: touch;">
            <!-- Populated by JS -->
        </div>

        <div id="gym-courses-list" class="space-y-2 overflow-y-auto flex-1">
            <!-- Loading state -->
            <div class="text-center py-8 text-gray-400">
                <div class="animate-pulse">Caricamento corsi...</div>
            </div>
        </div>
    </div>
</div>

<!-- Course Detail Modal (for clients) -->
<div id="client-course-detail-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeClientCourseDetail()">
    <div class="bg-[#1a1a1a] w-full max-w-lg max-h-[90vh] rounded-2xl border border-white/10 overflow-hidden flex flex-col">
        <!-- Trailer Video -->
        <div class="relative w-full aspect-video bg-black flex-shrink-0">
            <iframe id="client-course-trailer" class="w-full h-full hidden" frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen></iframe>
            <!-- Thumbnail with play button (shown before video plays) -->
            <div id="client-course-thumbnail" class="absolute inset-0 cursor-pointer hidden" onclick="playClientCourseVideo()">
                <img id="client-course-thumb-img" class="w-full h-full object-cover" src="" alt="Video thumbnail">
                <div class="absolute inset-0 flex items-center justify-center bg-black/30">
                    <div class="w-12 h-12 rounded-full bg-white/90 flex items-center justify-center shadow-lg hover:scale-110 transition">
                        <i data-lucide="play" class="w-5 h-5 ml-0.5 stroke-current fill-current"></i>
                    </div>
                </div>
            </div>
            <div id="client-course-no-trailer" class="absolute inset-0 bg-gradient-to-br from-purple-900/50 to-pink-900/30 flex items-center justify-center hidden">
                <i data-lucide="clapperboard" class="w-12 h-12 opacity-30"></i>
            </div>
            <!-- Close button -->
            <button onclick="closeClientCourseDetail()"
                class="absolute top-3 right-3 w-10 h-10 bg-black/70 hover:bg-black rounded-full text-white text-xl flex items-center justify-center transition z-10">&times;</button>
            <!-- Trainer overlay -->
            <div id="client-course-trainer-overlay" class="absolute top-3 left-3 flex items-center gap-2 bg-black/70 backdrop-blur-sm rounded-xl pr-3 pl-1.5 py-1.5">
                <div id="client-course-trainer-avatar" class="w-9 h-9 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center border-2 border-white/30">
                    <span id="client-course-trainer-initial" class="text-white font-bold text-sm">T</span>
                </div>
                <div class="flex flex-col">
                    <span id="client-course-trainer-name" class="text-white font-medium text-xs leading-tight">Trainer</span>
                    <span class="text-purple-300/80 text-[10px] leading-tight">Istruttore</span>
                </div>
            </div>
        </div>

        <!-- Course Info -->
        <div class="flex-1 overflow-y-auto p-5">
            <div class="flex items-center gap-2 mb-2">
                <span id="client-course-type-badge" class="text-xs font-bold uppercase px-2 py-1 rounded-lg bg-purple-500/20 text-purple-300"><i data-lucide="heart" class="w-3 h-3 inline-block align-middle"></i> Yoga</span>
            </div>
            <h2 id="client-course-title" class="text-2xl font-bold text-white mb-2">Course Title</h2>
            <div class="flex flex-wrap gap-3 text-sm text-gray-400 mb-4">
                <span id="client-course-schedule"><i data-lucide="calendar" class="w-3.5 h-3.5 inline-block align-middle stroke-current"></i> Mon, Wed @ 9:00 AM</span>
                <span id="client-course-duration"><i data-lucide="clock" class="w-3.5 h-3.5 inline-block align-middle stroke-current"></i> 60 min</span>
            </div>
            <p id="client-course-description" class="text-gray-300 text-sm mb-4"></p>

            <!-- Upcoming Sessions -->
            <div class="mb-4">
                <h4 class="text-sm font-bold text-white mb-3">Prossime Sessioni</h4>
                <div id="client-course-lessons-list" class="space-y-2">
                    <p class="text-sm text-gray-400">Caricamento sessioni...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- All Trainers Modal -->
<div id="all-trainers-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeAllTrainersModal()">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full max-h-[85vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Trainer della Palestra</h3>
            <button onclick="closeAllTrainersModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>
        <p class="text-gray-400 text-sm mb-4">Sfoglia tutti i trainer disponibili nella tua palestra</p>

        <div id="all-trainers-list" class="space-y-3">
            <!-- Loading state -->
            <div class="text-center py-8 text-gray-400">
                <div class="animate-pulse">Caricamento trainer...</div>
            </div>
        </div>
    </div>
</div>

<!-- Gym Members Modal -->
<div id="gym-members-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeGymMembersModal()">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full max-h-[85vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Membri Palestra</h3>
            <button onclick="closeGymMembersModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>
        <p class="text-gray-400 text-sm mb-4">Connettiti con gli altri membri della tua palestra</p>

        <div id="gym-members-list" class="space-y-3">
            <!-- Loading state -->
            <div class="text-center py-8 text-gray-400">
                <div class="animate-pulse">Caricamento membri...</div>
            </div>
        </div>
    </div>
</div>

<!-- Member Profile Modal -->
<div id="member-profile-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeMemberProfileModal()">
    <div class="glass-card p-5 rounded-2xl max-w-sm w-full">
        <!-- Header -->
        <div class="flex justify-between items-start mb-4">
            <div class="flex items-center gap-3">
                <div id="member-profile-avatar" class="w-14 h-14 rounded-full bg-orange-500/20 flex items-center justify-center overflow-hidden border-2 border-orange-500/30">
                    <i data-lucide="user" class="w-6 h-6"></i>
                </div>
                <div>
                    <h3 id="member-profile-name" class="text-lg font-bold text-white">Username</h3>
                    <p id="member-profile-bio" class="text-gray-400 text-xs max-w-[180px] truncate"></p>
                </div>
            </div>
            <button onclick="closeMemberProfileModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>

        <!-- Stats Row -->
        <div class="grid grid-cols-3 gap-2 mb-4">
            <div class="bg-white/5 rounded-xl p-3 text-center border border-white/5">
                <div class="flex items-center justify-center gap-1">
                    <i data-lucide="flame" class="w-4 h-4"></i>
                    <p id="member-profile-streak" class="text-xl font-bold text-orange-400">0</p>
                </div>
                <p class="text-[10px] text-gray-500 uppercase font-medium mt-1">Serie</p>
            </div>
            <div class="bg-white/5 rounded-xl p-3 text-center border border-white/5">
                <div class="flex items-center justify-center gap-1">
                    <span class="text-sm">ðŸ”¶</span>
                    <p id="member-profile-gems" class="text-xl font-bold text-orange-400">0</p>
                </div>
                <p class="text-[10px] text-gray-500 uppercase font-medium mt-1">Gemme</p>
            </div>
            <div class="bg-white/5 rounded-xl p-3 text-center border border-white/5">
                <div class="flex items-center justify-center gap-0.5">
                    <p id="member-profile-health" class="text-xl font-bold text-green-400">0</p>
                    <span class="text-xs text-green-400 font-bold">%</span>
                </div>
                <p class="text-[10px] text-gray-500 uppercase font-medium mt-1">Dieta</p>
            </div>
        </div>

        <!-- Weekly Activity -->
        <div class="bg-white/5 rounded-xl p-4 mb-4 border border-white/5">
            <div class="flex justify-between items-center mb-3">
                <span class="text-xs text-gray-400 uppercase tracking-wider font-medium">AttivitÃ  Settimanale</span>
                <span class="text-[10px] text-orange-400">Ultimi 7 giorni</span>
            </div>
            <!-- Activity Dots -->
            <div id="member-progress-chart" class="flex items-center justify-between">
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">L</span>
                    </div>
                </div>
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">M</span>
                    </div>
                </div>
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">M</span>
                    </div>
                </div>
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">G</span>
                    </div>
                </div>
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">V</span>
                    </div>
                </div>
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">S</span>
                    </div>
                </div>
                <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-orange-500/20 border border-orange-500/30 flex items-center justify-center member-day-dot" data-active="false">
                        <span class="text-xs text-gray-500">D</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Friend-only Progress Section (hidden by default) -->
        <div id="friend-progress-section" class="hidden mb-4">
            <div class="bg-gradient-to-br from-purple-500/10 to-pink-500/10 rounded-xl p-4 border border-purple-500/20">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <i data-lucide="bar-chart-3" class="w-4 h-4 text-purple-400"></i>
                        <span class="text-xs text-purple-300 uppercase tracking-wider font-medium">Progressi Amici</span>
                    </div>
                    <!-- View Tabs -->
                    <div class="flex gap-1 bg-white/5 rounded-lg p-0.5">
                        <button onclick="switchFriendProgressTab('strength')" id="friend-tab-strength" class="px-2 py-1 text-[10px] font-semibold rounded-md bg-purple-500 text-white transition">Forza</button>
                        <button onclick="switchFriendProgressTab('weight')" id="friend-tab-weight" class="px-2 py-1 text-[10px] font-semibold rounded-md text-gray-400 hover:text-white transition">Peso</button>
                        <button onclick="switchFriendProgressTab('health')" id="friend-tab-health" class="px-2 py-1 text-[10px] font-semibold rounded-md text-gray-400 hover:text-white transition">Salute</button>
                    </div>
                </div>

                <!-- Strength Progress View -->
                <div id="friend-strength-view" class="space-y-3">
                    <!-- Strength Chart -->
                    <div class="relative w-full" style="aspect-ratio: 16/9; min-height: 100px; max-height: 160px;">
                        <canvas id="friend-strength-chart" class="absolute inset-0 w-full h-full"></canvas>
                    </div>
                    <!-- Strength Stats with Goals -->
                    <div id="friend-strength-stats" class="grid grid-cols-3 gap-2">
                        <div class="bg-white/5 rounded-lg p-2 text-center">
                            <p class="text-[9px] text-gray-400 uppercase">Parte Sup.</p>
                            <p id="friend-strength-upper" class="text-sm font-bold text-orange-400">--%</p>
                            <p id="friend-goal-upper" class="text-[9px] text-gray-500">Obiettivo: --</p>
                        </div>
                        <div class="bg-white/5 rounded-lg p-2 text-center">
                            <p class="text-[9px] text-gray-400 uppercase">Parte Inf.</p>
                            <p id="friend-strength-lower" class="text-sm font-bold text-purple-400">--%</p>
                            <p id="friend-goal-lower" class="text-[9px] text-gray-500">Obiettivo: --</p>
                        </div>
                        <div class="bg-white/5 rounded-lg p-2 text-center">
                            <p class="text-[9px] text-gray-400 uppercase">Cardio</p>
                            <p id="friend-strength-cardio" class="text-sm font-bold text-green-400">--%</p>
                            <p id="friend-goal-cardio" class="text-[9px] text-gray-500">Obiettivo: --</p>
                        </div>
                    </div>
                </div>

                <!-- Weight Trend View -->
                <div id="friend-weight-view" class="hidden">
                    <p class="text-[10px] text-gray-400 mb-1">Andamento Peso (30 giorni)</p>
                    <div id="friend-weight-chart" class="h-20 flex items-end gap-1">
                        <!-- Bars will be rendered here -->
                    </div>
                    <div class="flex justify-between mt-2 text-[10px] text-gray-500">
                        <span id="friend-weight-start">--</span>
                        <span id="friend-weight-current" class="font-bold text-white">Current: --</span>
                    </div>
                </div>

                <!-- Health Score View -->
                <div id="friend-health-view" class="hidden">
                    <p class="text-[10px] text-gray-400 mb-1">Punteggio Salute (7 giorni)</p>
                    <div id="friend-health-bars" class="flex items-end justify-between h-16 gap-1">
                        <!-- Bars will be rendered here -->
                    </div>
                    <p id="friend-health-avg" class="text-[10px] text-gray-500 mt-2 text-center">Avg: --</p>
                </div>
            </div>
        </div>

        <!-- Friend Action Button -->
        <div id="friend-action-container" class="mb-3">
            <button id="friend-action-btn" onclick="handleFriendAction()"
                class="w-full py-2.5 bg-purple-500/20 text-purple-300 font-bold rounded-xl border border-purple-500/30 hover:bg-purple-500/30 transition tap-effect">
                <span id="friend-action-text">Aggiungi Amico</span>
            </button>
        </div>

        <!-- Message Button -->
        <button id="member-profile-message-btn" onclick="messageFromProfile()"
            class="w-full py-3 bg-orange-500 text-white font-bold rounded-xl hover:bg-orange-400 transition tap-effect">
            Messaggio
        </button>
    </div>
</div>

<!-- Chat Request Modal -->
<div id="chat-request-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeChatRequestModal()">
    <div class="glass-card p-6 rounded-2xl max-w-sm w-full">
        <div class="text-center mb-4">
            <div id="chat-request-avatar" class="w-20 h-20 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center mx-auto mb-3 overflow-hidden">
                <i data-lucide="user" class="w-8 h-8"></i>
            </div>
            <h3 id="chat-request-name" class="text-xl font-bold">Username</h3>
            <p class="text-gray-400 text-sm mt-1">Questo utente ha un profilo privato</p>
        </div>

        <div class="space-y-3">
            <textarea id="chat-request-message" rows="3"
                class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white placeholder-gray-500 resize-none outline-none focus:border-blue-500"
                placeholder="Scrivi un breve messaggio di presentazione (opzionale)..."></textarea>

            <button onclick="sendChatRequest()" class="w-full py-3 bg-blue-500 text-white font-bold rounded-xl hover:bg-blue-400 transition tap-effect">
                Invia Richiesta di Chat
            </button>
            <button onclick="closeChatRequestModal()" class="w-full py-3 bg-white/10 text-gray-300 font-bold rounded-xl hover:bg-white/20 transition tap-effect">
                Annulla
            </button>
        </div>
    </div>
</div>

<!-- Friends Modal -->
<div id="friends-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeFriendsModal()">
    <div class="glass-card p-5 rounded-2xl max-w-md w-full max-h-[85vh] overflow-hidden flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Amici</h3>
            <button onclick="closeFriendsModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>

        <!-- Tabs -->
        <div class="flex mb-4 bg-white/5 rounded-lg p-1">
            <button onclick="showFriendsTab('friends')" id="tab-friends"
                class="flex-1 py-2 px-4 rounded-lg text-sm font-medium bg-purple-500 text-white transition">
                Amici
            </button>
            <button onclick="showFriendsTab('requests')" id="tab-requests"
                class="flex-1 py-2 px-4 rounded-lg text-sm font-medium text-gray-400 transition">
                Richieste <span id="requests-badge" class="hidden bg-red-500 text-white text-xs rounded-full px-1.5 ml-1">0</span>
            </button>
        </div>

        <!-- Friends List Tab -->
        <div id="friends-list-container" class="flex-1 overflow-y-auto">
            <div id="friends-list" class="space-y-3">
                <!-- Friend cards loaded here -->
            </div>
            <div id="no-friends-message" class="hidden text-center py-8 text-gray-500">
                <p class="mb-2"><i data-lucide="users" class="w-10 h-10"></i></p>
                <p>Ancora nessun amico</p>
                <p class="text-sm">Aggiungi i membri della palestra come amici per vedere i loro progressi!</p>
            </div>
        </div>

        <!-- Requests Tab (hidden by default) -->
        <div id="requests-container" class="hidden flex-1 overflow-y-auto">
            <div class="mb-4">
                <h4 class="text-sm text-gray-400 mb-2 flex items-center gap-2">
                    <i data-lucide="inbox" class="w-4 h-4 inline-block stroke-current"></i> In Arrivo
                </h4>
                <div id="incoming-requests" class="space-y-3">
                    <!-- Incoming request cards -->
                </div>
                <div id="no-incoming-requests" class="hidden text-center py-4 text-gray-500 text-sm">
                    Nessuna richiesta in sospeso
                </div>
            </div>

            <div>
                <h4 class="text-sm text-gray-400 mb-2 flex items-center gap-2">
                    <i data-lucide="send" class="w-4 h-4 inline-block stroke-current"></i> Inviate
                </h4>
                <div id="outgoing-requests" class="space-y-3">
                    <!-- Outgoing request cards -->
                </div>
                <div id="no-outgoing-requests" class="hidden text-center py-4 text-gray-500 text-sm">
                    Nessuna richiesta inviata
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Friend Request Modal -->
<div id="friend-request-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeFriendRequestModal()">
    <div class="glass-card p-6 rounded-2xl max-w-sm w-full">
        <div class="text-center mb-4">
            <div id="friend-request-avatar" class="w-20 h-20 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center mx-auto mb-3 overflow-hidden">
                <i data-lucide="user" class="w-8 h-8"></i>
            </div>
            <h3 id="friend-request-name" class="text-xl font-bold">Username</h3>
            <p class="text-gray-400 text-sm mt-1">Invia una richiesta di amicizia</p>
        </div>

        <div class="space-y-3">
            <textarea id="friend-request-message" rows="2"
                class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white placeholder-gray-500 resize-none outline-none focus:border-purple-500"
                placeholder="Aggiungi un messaggio (opzionale)..."></textarea>

            <button onclick="submitFriendRequest()" class="w-full py-3 bg-purple-500 text-white font-bold rounded-xl hover:bg-purple-400 transition tap-effect">
                Invia Richiesta di Amicizia
            </button>
            <button onclick="closeFriendRequestModal()" class="w-full py-2 bg-white/10 text-gray-300 font-medium rounded-xl hover:bg-white/20 transition tap-effect">
                Annulla
            </button>
        </div>
    </div>
</div>

<!-- CO-OP Workout Modal -->
<div id="coop-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeCoopModal()">
    <div class="glass-card p-5 rounded-2xl max-w-md w-full max-h-[85vh] overflow-hidden flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-purple-500/20 flex items-center justify-center">
                    <i data-lucide="users" class="w-5 h-5"></i>
                </div>
                <div>
                    <h3 class="text-xl font-bold">Allenamento CO-OP</h3>
                    <p class="text-xs text-gray-400">Scegli un amico con cui allenarti</p>
                </div>
            </div>
            <button onclick="closeCoopModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>

        <!-- Info Banner -->
        <div class="bg-purple-500/10 border border-purple-500/20 rounded-xl p-3 mb-4">
            <p class="text-sm text-purple-300">
                <span class="font-bold">Come funziona:</span> Completa l'allenamento insieme - verrÃ  registrato nei calendari di entrambi!
            </p>
        </div>

        <!-- Friends List for CO-OP -->
        <div id="coop-friends-list" class="flex-1 overflow-y-auto space-y-2">
            <!-- Friend cards loaded here -->
        </div>

        <div id="coop-no-friends" class="hidden text-center py-8 text-gray-500">
            <p class="mb-2"><i data-lucide="users" class="w-10 h-10"></i></p>
            <p>Ancora nessun amico</p>
            <p class="text-sm">Aggiungi i membri della palestra come amici per fare allenamenti CO-OP!</p>
        </div>

        <div id="coop-loading" class="text-center py-8 text-gray-400">
            <p>Caricamento amici...</p>
        </div>

        <!-- Waiting for acceptance state -->
        <div id="coop-waiting" class="hidden text-center py-8">
            <div class="animate-pulse">
                <div id="coop-waiting-avatar" class="w-20 h-20 rounded-full bg-purple-500/30 mx-auto mb-4 flex items-center justify-center overflow-hidden">
                    <i data-lucide="user" class="w-8 h-8"></i>
                </div>
                <p class="text-white font-bold mb-2">In attesa di <span id="coop-waiting-name">Amico</span>...</p>
                <p class="text-sm text-gray-400">Deve accettare l'invito</p>
            </div>
            <button onclick="cancelCoopInvite()" class="mt-4 px-4 py-2 bg-white/10 rounded-lg text-gray-300 hover:bg-white/20 transition">
                Annulla
            </button>
        </div>
    </div>
</div>

<!-- CO-OP Invitation Received Modal -->
<div id="coop-invite-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 rounded-2xl max-w-sm w-full text-center">
        <div class="w-20 h-20 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500 mx-auto mb-4 flex items-center justify-center overflow-hidden animate-pulse">
            <span id="coop-invite-avatar"><i data-lucide="user" class="w-8 h-8 stroke-current"></i></span>
        </div>
        <h3 class="text-xl font-bold text-white mb-2">Invito Allenamento CO-OP!</h3>
        <p class="text-gray-300 mb-1"><span id="coop-invite-name" class="font-bold text-purple-400">Amico</span> vuole allenarsi con te</p>
        <p class="text-sm text-gray-500 mb-6">L'allenamento verrÃ  registrato nei calendari di entrambi</p>

        <div class="flex gap-3">
            <button onclick="declineCoopInvite()" class="flex-1 py-3 bg-white/10 rounded-xl font-bold text-gray-300 hover:bg-white/20 transition">
                Rifiuta
            </button>
            <button onclick="acceptCoopInvite()" class="flex-1 py-3 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl font-bold text-white hover:opacity-90 transition">
                Accetta
            </button>
        </div>
    </div>
</div>

<script>
var selectedTrainerId = null;
window.selectedNutritionistId = null;
window.currentNutritionistData = null;
let selectedDate = null;
let selectedTime = null;

// Load trainer info and appointments on page load
async function loadTrainerAndAppointments() {
    try {
        // Get gym/trainer info from the dedicated endpoint
        const response = await fetch('/api/client/gym-info', {
            credentials: 'include'
        });

        if (!response.ok) {
            loadTrainerSelectionForHome();
            return;
        }

        const info = await response.json();

        if (info.has_trainer && info.trainer_id) {
            selectedTrainerId = info.trainer_id;
            const trainerName = info.trainer_name || 'Il Tuo Trainer';
            document.getElementById('trainer-name').textContent = trainerName;

            // Update trainer avatar with profile picture
            updateTrainerAvatar(info.trainer_profile_picture, trainerName);

            // Store trainer data for profile modal + expandable card
            currentTrainerData = {
                id: info.trainer_id,
                name: trainerName,
                profile_picture: info.trainer_profile_picture,
                has_availability: true,
                bio: info.trainer_bio,
                specialties: info.trainer_specialties || [],
                availability_text: null
            };

            // Load availability for inline display
            loadTrainerAvailabilityInline(info.trainer_id);

            // Load upcoming appointments
            loadAppointments();
        } else {
            // No trainer - show selection option if they have a gym
            loadTrainerSelectionForHome();
        }

        // Load nutritionist data if assigned
        if (info.has_nutritionist && info.nutritionist_id) {
            window.selectedNutritionistId = info.nutritionist_id;
            window.currentNutritionistData = {
                id: info.nutritionist_id,
                name: info.nutritionist_name || 'Nutrizionista',
                profile_picture: info.nutritionist_profile_picture,
                bio: info.nutritionist_bio,
                specialties: info.nutritionist_specialties || []
            };
            // Show nutritionist card
            const nutriCard = document.getElementById('nutritionist-card');
            if (nutriCard) {
                nutriCard.classList.remove('hidden');
                const nutriName = document.getElementById('nutritionist-name');
                if (nutriName) nutriName.textContent = window.currentNutritionistData.name;
                updateNutritionistAvatar(info.nutritionist_profile_picture, window.currentNutritionistData.name);
            }
            // Load nutritionist appointments
            loadNutritionistAppointments();
        }
    } catch (error) {
        console.error('Error loading trainer info:', error);
        loadTrainerSelectionForHome();
    }
}

async function loadAppointments() {
    try {
        const response = await fetch('/api/client/appointments', {
            credentials: 'include'
        });

        if (!response.ok) return;

        const allAppointments = await response.json();

        // Filter out canceled appointments
        const appointments = allAppointments.filter(appt =>
            appt.status !== 'canceled' && appt.status !== 'cancelled'
        );

        if (appointments.length === 0) {
            document.getElementById('appointments-list').innerHTML = `
                <div class="glass-card p-3 text-center text-sm text-gray-400">
                    Nessun appuntamento in programma
                </div>
            `;
            return;
        }

        document.getElementById('appointments-list').innerHTML = appointments.slice(0, 3).map(appt => `
            <div class="glass-card p-3">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-bold text-sm text-white">${new Date(appt.date).toLocaleDateString('it-IT', { month: 'short', day: 'numeric' })}</p>
                        <p class="text-xs text-gray-400">${appt.start_time} â€¢ ${appt.duration} min</p>
                        ${appt.notes ? `<p class="text-xs text-gray-500 mt-1">${appt.notes}</p>` : ''}
                    </div>
                    <div class="flex items-center gap-2">
                        ${appt.status === 'scheduled' ? `
                            <button onclick="cancelAppointment('${appt.id}')" class="text-xs text-orange-400 hover:text-orange-300 font-medium">Annulla</button>
                        ` : `
                            <span class="text-xs px-2 py-1 rounded bg-green-500/20 text-green-400">${appt.status}</span>
                        `}
                    </div>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading appointments:', error);
    }
}

let bookingTrainerRate = null;
let bookingPaymentMethod = null;
window.bookingTargetType = 'trainer'; // 'trainer' or 'nutritionist'

window.openBookingModal = async function(targetType) {
    window.bookingTargetType = targetType || 'trainer';
    const isNutri = window.bookingTargetType === 'nutritionist';
    const targetId = isNutri ? window.selectedNutritionistId : selectedTrainerId;

    if (!targetId) {
        showToast(isNutri ? 'Nessun nutrizionista assegnato' : 'Nessun trainer assegnato', 'error');
        return;
    }

    // Reset state
    selectedDate = null;
    selectedTime = null;
    bookingPaymentMethod = null;
    bookingTrainerRate = null;
    bookingStripePaymentIntentId = null;

    // Hide sections until date selected
    document.getElementById('booking-time-section').classList.add('hidden');
    document.getElementById('booking-duration-section').classList.add('hidden');
    document.getElementById('booking-notes-section').classList.add('hidden');
    document.getElementById('booking-payment-section').classList.add('hidden');
    document.getElementById('booking-free-section').classList.add('hidden');
    document.getElementById('confirm-booking-btn').classList.add('hidden');
    document.getElementById('time-slots-list').innerHTML = '';
    document.getElementById('no-slots-message').classList.add('hidden');

    // Fetch session rate (trainer or nutritionist)
    const rateUrl = isNutri
        ? `/api/client/nutritionists/${targetId}/session-rate`
        : `/api/client/trainers/${targetId}/session-rate`;
    try {
        const rateRes = await fetch(rateUrl, { credentials: 'include' });
        if (rateRes.ok) {
            const rateData = await rateRes.json();
            bookingTrainerRate = rateData.session_rate;
        }
    } catch (e) { console.log('Could not fetch session rate:', e); }

    // Update modal title
    const modalTitle = document.querySelector('#booking-modal h3');
    if (modalTitle) {
        modalTitle.textContent = isNutri ? 'Prenota Consulenza Nutrizionale' : 'Prenota Appuntamento';
    }

    document.getElementById('booking-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    // Build date buttons grid
    buildBookingDateGrid();
}

window.buildBookingDateGrid = function() {
    const grid = document.getElementById('booking-date-grid');
    const dateInput = document.getElementById('appointment-date');
    // Handle both hidden input and old cached date input
    if (dateInput) dateInput.value = '';

    // If the grid doesn't exist (old cached HTML), create it
    if (!grid) {
        // Old cached HTML with <input type="date"> - convert it dynamically
        const oldInput = document.getElementById('appointment-date');
        if (oldInput && oldInput.parentElement) {
            oldInput.style.display = 'none';
            const newGrid = document.createElement('div');
            newGrid.id = 'booking-date-grid';
            newGrid.className = 'grid grid-cols-4 gap-2';
            oldInput.parentElement.appendChild(newGrid);
            _populateDateGrid(newGrid);
        }
        return;
    }
    _populateDateGrid(grid);
}

function _populateDateGrid(grid) {
    const dayNames = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
    const monthNames = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
    const today = new Date();
    let html = '';

    for (let i = 0; i < 8; i++) {
        const d = new Date(today);
        d.setDate(today.getDate() + i);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        const dateStr = `${yyyy}-${mm}-${dd}`;
        const dayName = i === 0 ? 'Oggi' : (i === 1 ? 'Domani' : dayNames[d.getDay()]);
        const label = `${monthNames[d.getMonth()]} ${d.getDate()}`;

        html += `<button onclick="selectBookingDate('${dateStr}', this)" data-date="${dateStr}"
            class="booking-date-btn p-2 rounded-xl border border-white/10 bg-white/5 hover:bg-orange-500/20 hover:border-orange-500/50 transition text-center tap-effect">
            <span class="block text-[10px] text-gray-400 font-medium">${dayName}</span>
            <span class="block text-sm font-bold text-white">${label}</span>
        </button>`;
    }
    grid.innerHTML = html;
}

window.selectBookingDate = function(dateStr, btn) {
    // Update hidden input
    const dateInput = document.getElementById('appointment-date');
    if (dateInput) dateInput.value = dateStr;

    // Highlight selected quick-pick button
    document.querySelectorAll('.booking-date-btn').forEach(b => {
        b.classList.remove('bg-orange-500', 'border-orange-500');
        b.classList.add('bg-white/5', 'border-white/10');
    });
    if (btn) {
        btn.classList.remove('bg-white/5', 'border-white/10');
        btn.classList.add('bg-orange-500', 'border-orange-500');
    }

    // Also highlight in calendar if open
    document.querySelectorAll('.cal-day-btn').forEach(b => {
        b.classList.remove('bg-orange-500', 'border-orange-500', 'text-white');
        if (b.dataset.date === dateStr) {
            b.classList.add('bg-orange-500', 'border-orange-500', 'text-white');
        }
    });

    // Trigger slot loading
    onBookingDateSelected();
}

// --- Inline Calendar ---
window._bookingCalMonth = null;
window._bookingCalYear = null;

window.toggleBookingCalendar = function() {
    const cal = document.getElementById('booking-calendar');
    const btn = document.getElementById('booking-more-dates-btn');
    if (!cal) return;
    if (cal.classList.contains('hidden')) {
        cal.classList.remove('hidden');
        btn.textContent = 'Nascondi calendario';
        const now = new Date();
        window._bookingCalMonth = now.getMonth();
        window._bookingCalYear = now.getFullYear();
        renderBookingCalendar();
    } else {
        cal.classList.add('hidden');
        btn.textContent = 'Altre date...';
    }
}

window.changeBookingCalMonth = function(delta) {
    window._bookingCalMonth += delta;
    if (window._bookingCalMonth > 11) { window._bookingCalMonth = 0; window._bookingCalYear++; }
    if (window._bookingCalMonth < 0) { window._bookingCalMonth = 11; window._bookingCalYear--; }
    renderBookingCalendar();
}

window.renderBookingCalendar = function() {
    const cal = document.getElementById('booking-calendar');
    if (!cal) return;

    const year = window._bookingCalYear;
    const month = window._bookingCalMonth;
    const monthNames = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
    const today = new Date();
    today.setHours(0,0,0,0);
    const todayStr = today.toISOString().split('T')[0];
    const selectedVal = document.getElementById('appointment-date')?.value || '';

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // Don't allow navigating before current month
    const canGoPrev = year > today.getFullYear() || (year === today.getFullYear() && month > today.getMonth());

    let html = `<div class="flex items-center justify-between mb-3">
        <button onclick="changeBookingCalMonth(-1)" class="w-8 h-8 rounded-lg ${canGoPrev ? 'hover:bg-white/10 text-white' : 'text-gray-600 cursor-not-allowed'} flex items-center justify-center transition" ${canGoPrev ? '' : 'disabled'}>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
        </button>
        <span class="text-sm font-bold text-white">${monthNames[month]} ${year}</span>
        <button onclick="changeBookingCalMonth(1)" class="w-8 h-8 rounded-lg hover:bg-white/10 text-white flex items-center justify-center transition">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        </button>
    </div>`;

    // Weekday headers
    html += '<div class="grid grid-cols-7 gap-1 mb-1">';
    ['Do','Lu','Ma','Me','Gi','Ve','Sa'].forEach(d => {
        html += `<div class="text-center text-[10px] text-gray-500 font-medium py-1">${d}</div>`;
    });
    html += '</div>';

    // Day cells
    html += '<div class="grid grid-cols-7 gap-1">';
    for (let i = 0; i < firstDay; i++) {
        html += '<div></div>';
    }
    for (let d = 1; d <= daysInMonth; d++) {
        const date = new Date(year, month, d);
        const mm = String(month + 1).padStart(2, '0');
        const dd = String(d).padStart(2, '0');
        const dateStr = `${year}-${mm}-${dd}`;
        const isPast = date < today;
        const isToday = dateStr === todayStr;
        const isSelected = dateStr === selectedVal;

        let cls = 'w-full aspect-square rounded-lg text-xs font-medium flex items-center justify-center transition';
        if (isPast) {
            cls += ' text-gray-600 cursor-not-allowed';
        } else if (isSelected) {
            cls += ' bg-orange-500 border-orange-500 text-white cursor-pointer cal-day-btn';
        } else if (isToday) {
            cls += ' border border-orange-500/50 text-orange-400 hover:bg-orange-500/20 cursor-pointer cal-day-btn';
        } else {
            cls += ' text-gray-300 hover:bg-white/10 cursor-pointer cal-day-btn';
        }

        if (isPast) {
            html += `<div class="${cls}">${d}</div>`;
        } else {
            html += `<button data-date="${dateStr}" onclick="selectBookingDate('${dateStr}', null)" class="${cls}">${d}</button>`;
        }
    }
    html += '</div>';

    cal.innerHTML = html;
}

// Category labels with emojis (lowercase keys)
const categoryLabels = {
    'bodybuilding': 'Bodybuilding',
    'crossfit': 'Crossfit',
    'calisthenics': 'Calisthenics',
    'cardio': 'Cardio',
    'hiit': 'HIIT',
    'yoga': 'Yoga',
    'boxing': 'Boxing',
    'rehabilitation': 'Rehabilitation'
};

async function loadTrainerSessionTypes() {
    const sessionTypeSelect = document.getElementById('appointment-session-type');
    if (!sessionTypeSelect) return;

    // Clear all options
    sessionTypeSelect.innerHTML = '<option value="" disabled selected>Loading...</option>';

    try {
        const response = await fetch(`/api/client/trainer/${selectedTrainerId}/session-types`, {
            credentials: 'include'
        });

        if (response.ok) {
            const specialties = await response.json();

            // Clear and add placeholder
            sessionTypeSelect.innerHTML = '<option value="" disabled selected>Scegli tipo di sessione...</option>';

            if (specialties && specialties.length > 0) {
                // Add trainer's specialties as options
                specialties.forEach(specialty => {
                    const option = document.createElement('option');
                    const key = specialty.toLowerCase();
                    option.value = key;
                    option.textContent = categoryLabels[key] || specialty;
                    sessionTypeSelect.appendChild(option);
                });
            } else {
                // Trainer hasn't set specialties - show message
                sessionTypeSelect.innerHTML = '<option value="" disabled selected>Nessuna categoria disponibile</option>';
            }
        } else {
            sessionTypeSelect.innerHTML = '<option value="" disabled selected>Scegli tipo di sessione...</option>';
        }
    } catch (error) {
        console.error('Error loading trainer specialties:', error);
        sessionTypeSelect.innerHTML = '<option value="" disabled selected>Errore caricamento categorie</option>';
    }
}

window.closeBookingModal = function() {
    document.getElementById('booking-modal').classList.add('hidden');
    document.body.style.overflow = '';
    selectedDate = null;
    selectedTime = null;
    bookingPaymentMethod = null;
    bookingStripePaymentIntentId = null;
};

// Auto-load available slots when date is selected
window.onBookingDateSelected = async function() {
    const dateInput = document.getElementById('appointment-date');
    selectedDate = dateInput.value;
    selectedTime = null;

    if (!selectedDate) return;

    const timeSection = document.getElementById('booking-time-section');
    const slotsList = document.getElementById('time-slots-list');
    const noSlotsMsg = document.getElementById('no-slots-message');
    const loadingEl = document.getElementById('booking-slots-loading');

    // Show time section with loading
    timeSection.classList.remove('hidden');
    loadingEl.classList.remove('hidden');
    noSlotsMsg.classList.add('hidden');
    slotsList.innerHTML = '';

    // Hide downstream sections until time is picked
    document.getElementById('booking-duration-section').classList.add('hidden');
    document.getElementById('booking-notes-section').classList.add('hidden');
    document.getElementById('booking-payment-section').classList.add('hidden');
    document.getElementById('booking-free-section').classList.add('hidden');
    document.getElementById('confirm-booking-btn').classList.add('hidden');

    try {
        const isNutri = window.bookingTargetType === 'nutritionist';
        const targetId = isNutri ? window.selectedNutritionistId : selectedTrainerId;
        const slotsUrl = isNutri
            ? `/api/client/nutritionists/${targetId}/available-slots?date=${selectedDate}`
            : `/api/client/trainers/${targetId}/available-slots?date=${selectedDate}`;
        const response = await fetch(slotsUrl, {
            credentials: 'include'
        });

        loadingEl.classList.add('hidden');

        if (!response.ok) throw new Error('Failed to load available slots');

        const slots = await response.json();

        if (slots.length === 0) {
            noSlotsMsg.classList.remove('hidden');
            return;
        }

        slotsList.innerHTML = slots.map(slot => `
            <button onclick="selectTimeSlot('${slot.start_time}', this)"
                class="time-slot-btn bg-white/10 hover:bg-primary/30 border border-white/10 hover:border-primary px-3 py-2 rounded-lg text-sm font-bold transition tap-effect"
                data-time="${slot.start_time}">
                ${slot.start_time}
            </button>
        `).join('');
    } catch (error) {
        loadingEl.classList.add('hidden');
        console.error('Error loading slots:', error);
        showToast(error.message, 'error');
    }
};

window.selectTimeSlot = function(time, clickedBtn) {
    selectedTime = time;
    // Reset all slots to default state
    document.querySelectorAll('.time-slot-btn').forEach(btn => {
        btn.classList.remove('bg-orange-500', 'border-orange-500', 'text-white');
        btn.classList.add('bg-white/10', 'border-white/10');
    });
    // Highlight selected slot with orange color
    if (clickedBtn) {
        clickedBtn.classList.remove('bg-white/10', 'border-white/10');
        clickedBtn.classList.add('bg-orange-500', 'border-orange-500', 'text-white');
    }

    // Show remaining sections
    document.getElementById('booking-duration-section').classList.remove('hidden');
    document.getElementById('booking-notes-section').classList.remove('hidden');
    document.getElementById('confirm-booking-btn').classList.remove('hidden');
    updateBookingPriceDisplay();
};

window.updateBookingPriceDisplay = function() {
    const paymentSection = document.getElementById('booking-payment-section');
    const freeSection = document.getElementById('booking-free-section');
    const priceDisplay = document.getElementById('booking-price-display');
    const cardForm = document.getElementById('booking-card-form');
    const cashInfo = document.getElementById('booking-cash-info');

    // Reset payment method visuals
    bookingPaymentMethod = null;
    if (cardForm) cardForm.classList.add('hidden');
    if (cashInfo) cashInfo.classList.add('hidden');
    const cardBtn = document.getElementById('booking-pay-card-btn');
    const cashBtn = document.getElementById('booking-pay-cash-btn');
    if (cardBtn) { cardBtn.classList.remove('border-blue-500', 'bg-blue-500/20'); cardBtn.classList.add('border-white/20'); }
    if (cashBtn) { cashBtn.classList.remove('border-green-500', 'bg-green-500/20'); cashBtn.classList.add('border-white/20'); }

    if (bookingTrainerRate && bookingTrainerRate > 0) {
        const duration = parseInt(document.getElementById('booking-duration').value) || 60;
        const price = (bookingTrainerRate * (duration / 60)).toFixed(2);
        if (paymentSection) paymentSection.classList.remove('hidden');
        if (freeSection) freeSection.classList.add('hidden');
        if (priceDisplay) priceDisplay.textContent = `$${price}`;
    } else {
        if (paymentSection) paymentSection.classList.add('hidden');
        if (freeSection) freeSection.classList.remove('hidden');
    }
};

window.onBookingDurationChanged = function() {
    updateBookingPriceDisplay();
};

window.selectBookingPayment = function(method) {
    bookingPaymentMethod = method;
    const cardBtn = document.getElementById('booking-pay-card-btn');
    const cashBtn = document.getElementById('booking-pay-cash-btn');
    const cashInfo = document.getElementById('booking-cash-info');

    cardBtn.classList.remove('border-blue-500', 'bg-blue-500/20');
    cardBtn.classList.add('border-white/20');
    cashBtn.classList.remove('border-green-500', 'bg-green-500/20');
    cashBtn.classList.add('border-white/20');
    cashInfo.classList.add('hidden');

    if (method === 'card') {
        cardBtn.classList.remove('border-white/20');
        cardBtn.classList.add('border-blue-500', 'bg-blue-500/20');
    } else if (method === 'cash') {
        cashBtn.classList.remove('border-white/20');
        cashBtn.classList.add('border-green-500', 'bg-green-500/20');
        cashInfo.classList.remove('hidden');
    }
};

window.confirmBooking = async function() {
    if (!selectedTime) {
        showToast('Seleziona un orario', 'error');
        return;
    }

    const duration = parseInt(document.getElementById('booking-duration').value) || 60;
    const notes = document.getElementById('appointment-notes').value;
    const hasPaidSession = bookingTrainerRate && bookingTrainerRate > 0;

    if (hasPaidSession && !bookingPaymentMethod) {
        showToast('Seleziona un metodo di pagamento', 'error');
        return;
    }

    const confirmBtn = document.getElementById('confirm-booking-btn');
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Elaborazione...';

    try {
        const isNutri = window.bookingTargetType === 'nutritionist';
        const targetId = isNutri ? window.selectedNutritionistId : selectedTrainerId;
        const idField = isNutri ? 'nutritionist_id' : 'trainer_id';
        const checkoutUrl = isNutri ? '/api/client/nutrition-checkout-session' : '/api/client/appointment-checkout-session';
        const bookUrl = isNutri ? '/api/client/nutrition-appointments' : '/api/client/appointments';

        if (hasPaidSession && bookingPaymentMethod === 'card') {
            // Redirect to Stripe Checkout
            const res = await fetch(checkoutUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    [idField]: targetId,
                    date: selectedDate,
                    start_time: selectedTime,
                    duration: duration,
                    notes: notes,
                })
            });

            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.detail || 'Failed to create checkout session');
            }

            const { checkout_url } = await res.json();
            window.location.href = checkout_url;
            return;
        }

        // Cash or free booking
        const response = await fetch(bookUrl, {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                [idField]: targetId,
                date: selectedDate,
                start_time: selectedTime,
                duration: duration,
                notes: notes,
                payment_method: hasPaidSession ? bookingPaymentMethod : null,
                stripe_payment_intent_id: null
            })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to book appointment');
        }

        showToast('Appuntamento prenotato con successo!', 'success');
        closeBookingModal();
        if (typeof loadAppointments === 'function') loadAppointments();
        if (typeof loadNutritionistAppointments === 'function') loadNutritionistAppointments();
    } catch (error) {
        console.error('Error booking appointment:', error);
        showToast(error.message, 'error');
    } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Prenota Appuntamento';
    }
};

async function cancelAppointment(appointmentId) {
    if (!confirm('Sei sicuro di voler annullare questo appuntamento?')) {
        return;
    }

    try {
        const response = await fetch(`/api/appointments/${appointmentId}/cancel`, {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                cancellation_reason: 'Canceled by client'
            })
        });

        if (!response.ok) {
            throw new Error('Failed to cancel appointment');
        }

        showToast('Appuntamento annullato', 'success');
        loadAppointments();
    } catch (error) {
        console.error('Error canceling appointment:', error);
        showToast(error.message, 'error');
    }
}

// --- GYM & TRAINER ASSIGNMENT ---

async function loadGymAndTrainerInfo() {
    console.log('[GYM INFO] Loading gym and trainer info...');

    try {
        const response = await fetch('/api/client/gym-info', {
            credentials: 'include'
        });

        console.log('[GYM INFO] Response status:', response.status);

        if (!response.ok) {
            console.error('[GYM INFO] Failed to load:', response.status, await response.text());
            // Show error state
            document.getElementById('current-gym-display').textContent = 'Errore caricamento info palestra';
            document.getElementById('current-trainer-display').textContent = 'Errore caricamento info trainer';
            return;
        }

        const info = await response.json();
        console.log('[GYM INFO] Data received:', info);

        // Update gym display
        const gymDisplay = document.getElementById('current-gym-display');
        const joinGymSection = document.getElementById('join-gym-section');
        const leaveGymSection = document.getElementById('leave-gym-section');

        if (info.has_gym) {
            gymDisplay.textContent = info.gym_name || 'Palestra sconosciuta';
            gymDisplay.classList.add('font-bold');
            joinGymSection.classList.add('hidden');
            if (leaveGymSection) leaveGymSection.classList.remove('hidden');
        } else {
            gymDisplay.textContent = 'Nessuna palestra assegnata';
            gymDisplay.classList.remove('font-bold');
            gymDisplay.classList.add('text-gray-400');
            joinGymSection.classList.remove('hidden');
            if (leaveGymSection) leaveGymSection.classList.add('hidden');
        }

        // Update trainer display
        const trainerDisplay = document.getElementById('current-trainer-display');
        const selectTrainerSection = document.getElementById('select-trainer-section');

        if (info.has_trainer) {
            trainerDisplay.textContent = info.trainer_name || 'Trainer sconosciuto';
            trainerDisplay.classList.add('font-bold');
            selectTrainerSection.classList.add('hidden');
        } else {
            trainerDisplay.textContent = 'Nessun trainer selezionato';
            trainerDisplay.classList.remove('font-bold');
            trainerDisplay.classList.add('text-gray-400');

            if (info.has_gym) {
                selectTrainerSection.classList.remove('hidden');
                await loadTrainersForSelection(info.gym_id);
            }
        }
    } catch (error) {
        console.error('Error loading gym/trainer info:', error);
    }
}

async function joinGym() {
    const gymCode = document.getElementById('gym-code-input').value.trim();

    if (!gymCode) {
        showToast('Inserisci un codice palestra', 'error');
        return;
    }

    try {
        const response = await fetch('/api/client/join-gym', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({ gym_code: gymCode })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to join gym');
        }

        const result = await response.json();
        showToast(`Iscritto a ${result.gym_name} con successo!`, 'success');

        // Reload gym info to show trainers
        setTimeout(() => loadGymAndTrainerInfo(), 500);
    } catch (error) {
        console.error('Error joining gym:', error);
        showToast(error.message, 'error');
    }
}

async function leaveGym() {
    if (!confirm('Sei sicuro di voler lasciare la tua palestra attuale? Questo rimuoverÃ  anche il tuo trainer.')) {
        return;
    }

    try {
        const response = await fetch('/api/client/leave-gym', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to leave gym');
        }

        const result = await response.json();
        showToast('Hai lasciato la palestra', 'success');

        setTimeout(() => loadGymAndTrainerInfo(), 500);
    } catch (error) {
        console.error('Error leaving gym:', error);
        showToast(error.message, 'error');
    }
}

async function loadTrainersForSelection(gymId) {
    try {
        const response = await fetch(`/api/gym/${gymId}/trainers`, {
            credentials: 'include'
        });

        if (!response.ok) return;

        const trainers = await response.json();
        const trainerList = document.getElementById('trainer-list');

        if (trainers.length === 0) {
            trainerList.innerHTML = '<p class="text-gray-400 text-sm">Nessun trainer disponibile</p>';
            return;
        }

        trainerList.innerHTML = trainers.map(trainer => `
            <button onclick="selectTrainer('${trainer.id}')"
                class="w-full bg-white/10 hover:bg-primary/30 border border-white/10 hover:border-primary px-4 py-3 rounded-lg text-left transition tap-effect">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-bold text-white">${trainer.name || trainer.username}</p>
                        <p class="text-xs text-gray-400">${trainer.client_count} clienti</p>
                    </div>
                    <span class="text-primary text-xl">â†’</span>
                </div>
            </button>
        `).join('');
    } catch (error) {
        console.error('Errore caricamento trainer:', error);
    }
}

async function selectTrainer(trainerId) {
    try {
        const response = await fetch('/api/client/select-trainer', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ trainer_id: trainerId })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to select trainer');
        }

        const result = await response.json();
        showToast(`Assegnato a ${result.trainer_name} con successo!`, 'success');

        // Reload gym info to update display
        setTimeout(() => loadGymAndTrainerInfo(), 500);
    } catch (error) {
        console.error('Error selecting trainer:', error);
        showToast(error.message, 'error');
    }
}

// --- TRAINER SELECTION FROM HOME PAGE ---

async function loadTrainerSelectionForHome() {
    try {
        // First get gym info
        const response = await fetch('/api/client/gym-info', {
            credentials: 'include'
        });

        if (!response.ok) {
            document.getElementById('trainer-section').innerHTML = `
                <div class="glass-card p-4 text-center text-gray-400">
                    <p>Nessun trainer assegnato</p>
                </div>
            `;
            return;
        }

        const info = await response.json();

        if (!info.has_gym) {
            // No gym - prompt to join one
            document.getElementById('trainer-section').innerHTML = `
                <div class="glass-card p-4 text-center">
                    <p class="text-gray-400 mb-3">Iscriviti a una palestra per iniziare</p>
                    <a href="/?gym_id={{ gym_id }}&role=client&mode=account_settings"
                       class="inline-block bg-primary px-4 py-2 rounded-lg text-sm font-bold hover:bg-primary/80 transition tap-effect">
                        Iscriviti
                    </a>
                </div>
            `;
        } else {
            // Has gym but no trainer - show selection button
            window.clientGymId = info.gym_id;
            document.getElementById('trainer-section').innerHTML = `
                <div class="glass-card p-4 text-center">
                    <p class="text-gray-400 mb-3">No trainer assigned yet</p>
                    <button onclick="openTrainerSelectionModal()"
                            class="bg-primary px-6 py-3 rounded-xl font-bold hover:bg-primary/80 transition tap-effect">
                        Seleziona il Tuo Trainer
                    </button>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading gym info for home:', error);
        document.getElementById('trainer-section').innerHTML = `
            <div class="glass-card p-4 text-center text-gray-400">
                <p>No trainer assigned yet</p>
            </div>
        `;
    }
}

async function openTrainerSelectionModal() {
    const modal = document.getElementById('trainer-selection-modal');
    const list = document.getElementById('home-trainer-list');

    if (!modal || !list) return;

    modal.classList.remove('hidden');
    list.innerHTML = '<p class="text-center text-gray-400">Caricamento trainer in corso...</p>';

    try {
        const response = await fetch(`/api/gym/${window.clientGymId}/trainers`, {
            credentials: 'include'
        });

        if (!response.ok) {
            list.innerHTML = '<p class="text-center text-red-400">Impossibile caricare i trainer</p>';
            return;
        }

        const trainers = await response.json();

        if (trainers.length === 0) {
            list.innerHTML = '<p class="text-center text-gray-400">Nessun trainer disponibile in questa palestra</p>';
            return;
        }

        list.innerHTML = trainers.map(trainer => `
            <button onclick="selectTrainerFromHome('${trainer.id}', '${trainer.name || trainer.username}')"
                class="w-full bg-white/10 hover:bg-primary/30 border border-white/10 hover:border-primary p-4 rounded-xl text-left transition tap-effect">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-tr from-red-500 to-orange-500 flex items-center justify-center">
                            <i data-lucide="user" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <p class="font-bold text-white">${trainer.name || trainer.username}</p>
                            <p class="text-xs text-gray-400">${trainer.client_count} clienti</p>
                        </div>
                    </div>
                    <span class="text-primary text-xl">â†’</span>
                </div>
            </button>
        `).join('');
    } catch (error) {
        console.error('Errore caricamento trainer:', error);
        list.innerHTML = '<p class="text-center text-red-400">Errore caricamento trainer</p>';
    }
}

function closeTrainerSelectionModal() {
    document.getElementById('trainer-selection-modal').classList.add('hidden');
}

async function selectTrainerFromHome(trainerId, trainerName) {
    try {
        const response = await fetch('/api/client/select-trainer', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ trainer_id: trainerId })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to select trainer');
        }

        showToast(`Assegnato a ${trainerName} con successo!`, 'success');
        closeTrainerSelectionModal();

        // Reload the page to show trainer info
        setTimeout(() => window.location.reload(), 500);
    } catch (error) {
        console.error('Error selecting trainer:', error);
        showToast(error.message, 'error');
    }
}

// --- CLIENT CHAT FUNCTIONS ---
function openClientChatModal() {
    if (typeof window.openConversationsModal === 'function') {
        window.openConversationsModal();
    } else {
        showToast('Chat non disponibile', 'error');
    }
}

// Load on page load
if (window.location.search.includes('role=client') && !window.location.search.includes('mode=')) {
    loadTrainerAndAppointments();
}

// Load gym/trainer info on settings page
if (window.location.search.includes('mode=account_settings')) {
    console.log('[INIT] Account settings page detected, loading gym/trainer info');
    // Use setTimeout to ensure DOM is ready
    setTimeout(() => loadGymAndTrainerInfo(), 100);
} else {
    console.log('[INIT] Not on account settings page, search:', window.location.search);
}

// --- PROFILE PICTURE FUNCTIONS ---
async function loadProfilePicture() {
    try {
        const res = await fetch('/api/profile/picture');
        if (res.ok) {
            const data = await res.json();
            if (data.profile_picture) {
                updateAllAvatars(data.profile_picture);
            } else {
                // Use dicebear with username as seed
                const username = data.username || 'User';
                const defaultAvatar = `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(username)}`;
                updateAllAvatars(defaultAvatar);
            }
        }
    } catch (e) {
        console.error('Error loading profile picture:', e);
    }
}

function updateAllAvatars(url) {
    // Update all avatar images on the page
    const avatarIds = ['profile-avatar-img'];
    avatarIds.forEach(id => {
        const img = document.getElementById(id);
        if (img) {
            img.src = url;
        }
    });
}

async function uploadProfilePicture(input) {
    const file = input.files?.[0];
    if (!file) return;

    // Validate file type
    const validTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
    if (!validTypes.includes(file.type)) {
        showToast('Seleziona un file immagine valido (JPG, PNG, WEBP, GIF)', 'error');
        return;
    }

    // Validate file size (5MB max)
    if (file.size > 5 * 1024 * 1024) {
        showToast('Immagine troppo grande. Dimensione massima 5MB', 'error');
        return;
    }

    // Show loading state
    const container = document.getElementById('profile-avatar-container');
    if (container) {
        container.style.opacity = '0.5';
    }

    try {
        const formData = new FormData();
        formData.append('file', file);

        const res = await fetch('/api/profile/picture', {
            method: 'POST',
            body: formData
        });

        const data = await res.json();

        if (res.ok) {
            updateAllAvatars(data.profile_picture);
            showToast('Foto profilo aggiornata!', 'success');
        } else {
            showToast(data.detail || 'Impossibile caricare l\'immagine', 'error');
        }
    } catch (e) {
        console.error('Error uploading profile picture:', e);
        showToast('Impossibile caricare l\'immagine', 'error');
    } finally {
        if (container) {
            container.style.opacity = '1';
        }
        // Clear input
        input.value = '';
    }
}

// Check for booking redirect results (from Stripe Checkout)
document.addEventListener('DOMContentLoaded', function() {
    const params = new URLSearchParams(window.location.search);
    if (params.get('booking_success') === 'true') {
        showToast('Appuntamento prenotato con successo!', 'success');
        const url = new URL(window.location);
        url.searchParams.delete('booking_success');
        window.history.replaceState({}, '', url);
        if (typeof loadAppointments === 'function') loadAppointments();
        if (typeof loadNutritionistAppointments === 'function') loadNutritionistAppointments();
    }
    if (params.get('booking_error')) {
        showToast('Prenotazione fallita: ' + params.get('booking_error'), 'error');
        const url = new URL(window.location);
        url.searchParams.delete('booking_error');
        window.history.replaceState({}, '', url);
    }
    if (params.get('booking_canceled') === 'true') {
        showToast('Pagamento annullato', 'error');
        const url = new URL(window.location);
        url.searchParams.delete('booking_canceled');
        window.history.replaceState({}, '', url);
    }
});

// Load profile picture on page load
document.addEventListener('DOMContentLoaded', () => {
    loadProfilePicture();
    loadNotificationCount();
    setInterval(loadNotificationCount, 30000); // Poll every 30 seconds
});

// --- NOTIFICATION BADGE FUNCTIONS ---
async function loadNotificationCount() {
    try {
        const res = await fetch('/api/notifications/unread-count');
        const data = await res.json();
        const badges = document.querySelectorAll('.notification-badge');
        badges.forEach(badge => {
            if (data.unread_count > 0) {
                badge.textContent = data.unread_count > 9 ? '9+' : data.unread_count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        });
    } catch (e) {
        console.error('Error loading notification count:', e);
    }
}

// --- TRAINER PROFILE & BROWSE FUNCTIONS ---
let currentViewingTrainerId = null;
let currentViewingTrainerName = null;
let allGymTrainers = [];

// Store trainer data for profile modal (var so app.js can access via window.currentTrainerData)
var currentTrainerData = {
    id: null,
    name: null,
    profile_picture: null,
    has_availability: false,
    bio: null,
    specialties: []
};

async function openTrainerProfileModal(trainerId = null, trainerName = null, trainerPicture = null, trainerBio = null, trainerSpecialties = null) {
    // If no trainerId passed, use the selected trainer (my trainer) and stored data
    if (!trainerId) {
        trainerId = selectedTrainerId;
        trainerName = currentTrainerData.name || document.getElementById('trainer-name')?.textContent || 'Il tuo Trainer';
        trainerPicture = currentTrainerData.profile_picture;
        trainerBio = currentTrainerData.bio;
        trainerSpecialties = currentTrainerData.specialties || [];
    }

    // Parse specialties if it's a JSON string
    if (typeof trainerSpecialties === 'string') {
        try {
            trainerSpecialties = JSON.parse(trainerSpecialties);
        } catch (e) {
            trainerSpecialties = [];
        }
    }
    trainerSpecialties = trainerSpecialties || [];

    if (!trainerId) {
        showToast('Nessun trainer da mostrare', 'error');
        return;
    }

    // Close the all trainers modal if it's open
    document.getElementById('all-trainers-modal').classList.add('hidden');

    currentViewingTrainerId = trainerId;
    currentViewingTrainerName = trainerName;

    // Update modal content
    document.getElementById('profile-trainer-name').textContent = trainerName;

    // Update avatar
    const avatarContainer = document.getElementById('profile-trainer-avatar');
    if (trainerPicture) {
        avatarContainer.innerHTML = `<img src="${trainerPicture}" alt="${trainerName}" class="w-full h-full object-cover">`;
    } else {
        avatarContainer.innerHTML = `<i data-lucide="user" class="w-10 h-10"></i>`;
    }

    // Update bio
    const bioSection = document.getElementById('profile-trainer-bio-section');
    const bioText = document.getElementById('profile-trainer-bio');
    if (trainerBio && trainerBio.trim()) {
        bioText.textContent = `"${trainerBio}"`;
        bioSection.classList.remove('hidden');
    } else {
        bioSection.classList.add('hidden');
    }

    // Update specialties
    const specialtiesContainer = document.getElementById('profile-trainer-specialties');
    if (specialtiesContainer) {
        if (trainerSpecialties.length > 0) {
            specialtiesContainer.innerHTML = trainerSpecialties.map(s =>
                `<span class="bg-white/10 text-white/80 px-3 py-1 rounded-full text-xs border border-white/10">${s}</span>`
            ).join('');
            specialtiesContainer.classList.remove('hidden');
        } else {
            specialtiesContainer.classList.add('hidden');
        }
    }

    // Show "Your Trainer" badge if this is the user's trainer
    const badge = document.getElementById('profile-trainer-badge');
    const selectBtn = document.getElementById('profile-select-btn');

    if (trainerId === selectedTrainerId) {
        badge.classList.remove('hidden');
        selectBtn.classList.add('hidden');
    } else {
        badge.classList.add('hidden');
        selectBtn.classList.remove('hidden');
    }

    // Load trainer stats
    await loadTrainerStats(trainerId);

    // Show modal
    document.getElementById('trainer-profile-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeTrainerProfileModal() {
    document.getElementById('trainer-profile-modal').classList.add('hidden');
    document.body.style.overflow = '';
    currentViewingTrainerId = null;
    currentViewingTrainerName = null;
}

async function loadTrainerStats(trainerId) {
    try {
        // Check availability
        const availResponse = await fetch(`/api/client/trainers/${trainerId}/availability`, {
            credentials: 'include'
        });

        let availabilityText = 'Non impostata';
        if (availResponse.ok) {
            const availability = await availResponse.json();
            if (availability && availability.length > 0) {
                const daysWithAvailability = [...new Set(availability.map(a => a.day_of_week))];
                availabilityText = `${daysWithAvailability.length} giorni/settimana`;
            }
        }

        document.getElementById('profile-trainer-availability').textContent = availabilityText;
        document.getElementById('profile-trainer-clients').textContent = '-'; // We don't have this info from client side

    } catch (error) {
        console.error('Error loading trainer stats:', error);
        document.getElementById('profile-trainer-availability').textContent = '-';
        document.getElementById('profile-trainer-clients').textContent = '-';
    }
}

function messageTrainerFromProfile() {
    if (!currentViewingTrainerId) return;

    const trainerId = currentViewingTrainerId;
    const trainerName = currentViewingTrainerName;

    closeTrainerProfileModal();

    // Open chat with the trainer
    if (typeof openChatModal === 'function') {
        openChatModal(trainerId, trainerName);
    } else if (typeof openConversationsModal === 'function') {
        openConversationsModal();
    } else {
        showToast('Messaggistica non disponibile', 'error');
    }
}

function bookWithTrainerFromProfile() {
    if (!currentViewingTrainerId) return;

    const trainerId = currentViewingTrainerId;
    closeTrainerProfileModal();

    // Go directly to 1-on-1 booking (skip choice modal)
    selectedTrainerId = trainerId;
    if (typeof openBookingModal === 'function') {
        openBookingModal();
    }
}

// Booking Choice Modal Functions
var bookingChoiceTrainerId = null;
var bookingChoiceTrainerName = null;

async function bookDirectWithMyTrainer() {
    // Go straight to 1-on-1 booking with the assigned trainer
    let trainerId = selectedTrainerId;
    if (!trainerId) {
        try {
            const response = await fetch('/api/client/gym-info', { credentials: 'include' });
            if (response.ok) {
                const info = await response.json();
                if (info.has_trainer && info.trainer_id) {
                    trainerId = info.trainer_id;
                    selectedTrainerId = trainerId;
                }
                if (info.has_nutritionist && info.nutritionist_id) {
                    window.selectedNutritionistId = info.nutritionist_id;
                    window.currentNutritionistData = {
                        id: info.nutritionist_id,
                        name: info.nutritionist_name,
                        profile_picture: info.nutritionist_profile_picture,
                        bio: info.nutritionist_bio,
                        specialties: info.nutritionist_specialties
                    };
                }
            }
        } catch (e) {}
    }
    if (trainerId) {
        selectedTrainerId = trainerId;
        if (typeof openBookingModal === 'function') openBookingModal();
    } else {
        showToast('Nessun trainer assegnato', 'error');
    }
}

function openBookingChoiceModal(trainerId, trainerName, nutritionistId, nutritionistName) {
    bookingChoiceTrainerId = trainerId;
    bookingChoiceTrainerName = trainerName;
    window._bookingNutritionistId = nutritionistId || window._bookingNutritionistId;
    window._bookingNutritionistName = nutritionistName || window._bookingNutritionistName;

    document.getElementById('booking-choice-trainer-name').textContent = trainerName || 'your trainer';
    // Hide 1-on-1 option if no trainer assigned
    const personalBtn = document.getElementById('booking-choice-personal-btn');
    if (personalBtn) personalBtn.style.display = trainerId ? '' : 'none';
    // Hide nutritionist option if no nutritionist assigned
    const nutriBtn = document.getElementById('booking-choice-nutritionist-btn');
    if (nutriBtn) nutriBtn.style.display = window._bookingNutritionistId ? '' : 'none';

    document.getElementById('booking-choice-modal').classList.remove('hidden');
}

async function openBookingChoiceForMyTrainer() {
    // Fetch gym info to get trainer and nutritionist
    let trainerName = document.getElementById('trainer-name')?.textContent || 'Trainer';
    let trainerId = selectedTrainerId;
    let nutritionistId = window._bookingNutritionistId || null;
    let nutritionistName = window._bookingNutritionistName || null;

    try {
        const response = await fetch('/api/client/gym-info', { credentials: 'include' });
        if (response.ok) {
            const info = await response.json();
            if (info.has_trainer && info.trainer_id) {
                trainerId = info.trainer_id;
                selectedTrainerId = trainerId;
                if (info.trainer_name) trainerName = info.trainer_name;
            }
            if (info.has_nutritionist && info.nutritionist_id) {
                nutritionistId = info.nutritionist_id;
                nutritionistName = info.nutritionist_name || 'Nutritionist';
                window._bookingNutritionistId = nutritionistId;
                window._bookingNutritionistName = nutritionistName;
            }
        }
    } catch (e) {
        console.log('Could not fetch gym info for booking');
    }

    if (trainerId) selectedTrainerId = trainerId;
    openBookingChoiceModal(trainerId, trainerName, nutritionistId, nutritionistName);
}

function closeBookingChoiceModal() {
    document.getElementById('booking-choice-modal').classList.add('hidden');
    bookingChoiceTrainerId = null;
    bookingChoiceTrainerName = null;
}

function selectBookingType(type) {
    // Save IDs BEFORE closing modal (closeBookingChoiceModal nullifies them)
    const savedTrainerId = bookingChoiceTrainerId;
    const savedTrainerName = bookingChoiceTrainerName;
    const savedNutritionistId = window._bookingNutritionistId;
    closeBookingChoiceModal();

    if (type === 'personal') {
        // Book 1-on-1 session with trainer
        selectedTrainerId = savedTrainerId;
        if (typeof openBookingModal === 'function') {
            openBookingModal();
        }
    } else if (type === 'nutritionist') {
        // Book consultation with nutritionist - reuse same booking flow
        if (savedNutritionistId) {
            selectedTrainerId = savedNutritionistId;
            if (typeof openBookingModal === 'function') {
                openBookingModal();
            }
        } else {
            showToast('No nutritionist assigned yet', 'error');
        }
    } else if (type === 'course') {
        // Show all gym courses
        openGymCoursesModal();
    } else if (type === 'facility') {
        // Book a facility
        openFacilityBookingModal();
    } else if (type === 'nutrition') {
        // Book nutritionist consultation
        openBookingModal('nutritionist');
    }
}

// Gym Courses Modal Functions
async function openGymCoursesModal() {
    document.getElementById('gym-courses-modal').classList.remove('hidden');

    const listEl = document.getElementById('gym-courses-list');
    const filtersEl = document.getElementById('gym-courses-filters');
    listEl.innerHTML = '<div class="text-center py-8 text-gray-400"><div class="animate-pulse">Loading courses...</div></div>';
    if (filtersEl) filtersEl.innerHTML = '';

    try {
        const response = await fetch('/api/client/gym/courses', {
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error('Impossibile caricare i corsi');
        }

        const courses = await response.json();
        allGymCourses = courses;
        activeGymFilter = 'all';

        if (courses.length === 0) {
            if (filtersEl) filtersEl.style.display = 'none';
            listEl.innerHTML = `
                <div class="text-center py-8">
                    <div class="mb-3"><i data-lucide="book-open" class="w-10 h-10"></i></div>
                    <p class="text-gray-400">Nessun corso disponibile</p>
                    <p class="text-sm text-gray-500 mt-2">La tua palestra non ha ancora programmato corsi di gruppo</p>
                </div>
            `;
            return;
        }

        buildGymCoursesFilters(courses);
        listEl.innerHTML = courses.map(course => renderClientCourseCard(course)).join('');
    } catch (error) {
        console.error('Error loading courses:', error);
        listEl.innerHTML = `
            <div class="text-center py-8 text-red-400">
                <p>Impossibile caricare i corsi</p>
                <button onclick="openGymCoursesModal()" class="mt-2 text-sm text-orange-400 hover:text-orange-300">Riprova</button>
            </div>
        `;
    }
}

function closeGymCoursesModal() {
    document.getElementById('gym-courses-modal').classList.add('hidden');
}

// --- MY QR CODE ---
let myQrGenerated = false;

function openMyQrModal() {
    const modal = document.getElementById('my-qr-modal');
    if (!modal) return;

    // Get user ID from JWT
    let userId = window.currentUserId;
    if (!userId) {
        try {
            const token = localStorage.getItem('jwt_token');
            if (token) {
                const payload = JSON.parse(atob(token.split('.')[1]));
                userId = payload.user_id;
            }
        } catch (e) {}
    }

    if (!userId) {
        showToast('Impossibile generare il codice QR', 'error');
        return;
    }

    // Set name
    const name = localStorage.getItem('username') || 'Member';
    document.getElementById('my-qr-name').textContent = name;

    // Generate QR only once
    if (!myQrGenerated) {
        const container = document.getElementById('my-qr-code');
        container.innerHTML = '';
        new QRCode(container, {
            text: 'GYMCHECKIN' + userId.replaceAll('-', ''),
            width: 220,
            height: 220,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.M
        });
        myQrGenerated = true;
    }

    modal.classList.remove('hidden');
}

function closeMyQrModal() {
    document.getElementById('my-qr-modal').classList.add('hidden');
}

// --- ACCESS QR (30-second temporary code for turnstile) ---
let accessQrTimer = null;

async function openAccessQrModal() {
    const modal = document.getElementById('access-qr-modal');
    if (!modal) return;

    // Set name
    const name = localStorage.getItem('username') || 'Member';
    document.getElementById('access-qr-name').textContent = name;

    // Get temporary token from backend
    try {
        const res = await fetch('/api/client/access-token', {
            method: 'POST',
            credentials: 'include'
        });
        if (!res.ok) throw new Error('Failed to generate access code');
        const data = await res.json();

        // Generate QR with token data
        const container = document.getElementById('access-qr-code');
        container.innerHTML = '';
        const qrData = 'GYMACCESS' + data.user_id.replaceAll('-', '') + data.token;
        new QRCode(container, {
            text: qrData,
            width: 220,
            height: 220,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.M
        });

        modal.classList.remove('hidden');
        startAccessTimer(30);
    } catch (e) {
        showToast('Impossibile generare il codice di accesso', 'error');
    }
}

function startAccessTimer(seconds) {
    if (accessQrTimer) clearInterval(accessQrTimer);
    let remaining = seconds;
    const bar = document.getElementById('access-qr-timer-bar');
    const text = document.getElementById('access-qr-timer-text');

    bar.style.width = '100%';
    bar.classList.remove('bg-red-500', 'bg-yellow-500');
    bar.classList.add('bg-green-500');
    text.classList.remove('text-red-400', 'text-yellow-400');
    text.classList.add('text-green-400');

    accessQrTimer = setInterval(() => {
        remaining--;
        const pct = (remaining / seconds) * 100;
        bar.style.width = pct + '%';
        text.textContent = remaining + 's';

        if (remaining <= 10) {
            bar.classList.remove('bg-green-500', 'bg-yellow-500');
            bar.classList.add('bg-red-500');
            text.classList.remove('text-green-400', 'text-yellow-400');
            text.classList.add('text-red-400');
        } else if (remaining <= 20) {
            bar.classList.remove('bg-green-500', 'bg-red-500');
            bar.classList.add('bg-yellow-500');
            text.classList.remove('text-green-400', 'text-red-400');
            text.classList.add('text-yellow-400');
        }

        if (remaining <= 0) {
            clearInterval(accessQrTimer);
            accessQrTimer = null;
            text.textContent = 'Scaduto';
            bar.style.width = '0%';
            // Auto-regenerate
            setTimeout(() => {
                if (!document.getElementById('access-qr-modal').classList.contains('hidden')) {
                    openAccessQrModal();
                }
            }, 500);
        }
    }, 1000);
}

function closeAccessQrModal() {
    if (accessQrTimer) {
        clearInterval(accessQrTimer);
        accessQrTimer = null;
    }
    document.getElementById('access-qr-modal').classList.add('hidden');
}

// Course type config shared across functions
const courseTypeConfig = {
    yoga:     { icon: 'heart', label: 'Yoga',     color: 'purple' },
    pilates:  { icon: 'person-standing', label: 'Pilates',  color: 'pink' },
    hiit:     { icon: 'flame', label: 'HIIT',     color: 'orange' },
    dance:    { icon: 'music', label: 'Dance',     color: 'cyan' },
    spin:     { icon: 'bike', label: 'Spin',      color: 'green' },
    strength: { icon: 'dumbbell', label: 'Strength',  color: 'red' },
    stretch:  { icon: 'move', label: 'Stretch',   color: 'teal' },
    cardio:   { icon: 'footprints', label: 'Cardio',    color: 'yellow' }
};

// Cached courses for filtering
let allGymCourses = [];
let activeGymFilter = 'all';

function renderClientCourseCard(course) {
    const cfg = courseTypeConfig[course.course_type] || { icon: 'book-open', label: course.course_type || 'Class', color: 'purple' };
    const dayNames = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'];
    const days = course.days_of_week ? course.days_of_week.map(d => dayNames[d]).join(', ') : 'Non programmato';
    const hasVideo = !!course.trailer_url;

    return `
        <div class="flex items-center gap-3 bg-black/30 rounded-xl p-3 border border-white/10 cursor-pointer hover:bg-white/5 hover:border-${cfg.color}-500/40 transition" onclick="viewCourseDetails('${course.id}')">
            <!-- Type Icon -->
            <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-${cfg.color}-500/30 to-${cfg.color}-900/30 border border-${cfg.color}-500/20 flex items-center justify-center flex-shrink-0">
                <span class="text-2xl">${icon(cfg.icon, 16)}</span>
            </div>
            <!-- Info -->
            <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-0.5">
                    <span class="text-[10px] font-bold uppercase px-1.5 py-0.5 rounded bg-${cfg.color}-500/20 text-${cfg.color}-300">${cfg.label}</span>
                    ${hasVideo ? '<span class="text-[10px] text-gray-500 ml-auto flex items-center gap-0.5"><i data-lucide="play" class="w-3 h-3 inline-block stroke-current"></i> trailer</span>' : ''}
                </div>
                <h3 class="text-sm font-bold text-white truncate">${course.name}</h3>
                <p class="text-xs text-gray-400 truncate">${days}${course.time_slot ? ' @ ' + course.time_slot : ''} Â· ${course.duration || 60} min</p>
                <p class="text-[10px] text-gray-500 mt-0.5">by ${course.trainer_name || 'Trainer'}</p>
            </div>
            <!-- Chevron -->
            <svg class="w-4 h-4 text-gray-600 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"/></svg>
        </div>
    `;
}

function buildGymCoursesFilters(courses) {
    const filtersEl = document.getElementById('gym-courses-filters');
    if (!filtersEl) return;

    // Get unique types from courses
    const types = [...new Set(courses.map(c => c.course_type).filter(Boolean))];

    if (types.length <= 1) {
        filtersEl.style.display = 'none';
        return;
    }

    filtersEl.style.display = '';
    let html = `<button onclick="filterGymCourses('all')" class="gym-filter-pill flex-shrink-0 px-3 py-1.5 rounded-full text-xs font-bold transition bg-white/20 text-white" data-filter="all">All</button>`;

    types.forEach(type => {
        const cfg = courseTypeConfig[type] || { icon: 'book-open', label: type, color: 'purple' };
        html += `<button onclick="filterGymCourses('${type}')" class="gym-filter-pill flex-shrink-0 px-3 py-1.5 rounded-full text-xs font-bold transition bg-white/5 text-gray-400 hover:bg-white/10" data-filter="${type}">${icon(cfg.icon, 16)} ${cfg.label}</button>`;
    });

    filtersEl.innerHTML = html;
}

function filterGymCourses(type) {
    activeGymFilter = type;
    const listEl = document.getElementById('gym-courses-list');

    // Update pill styles
    document.querySelectorAll('.gym-filter-pill').forEach(pill => {
        const isActive = pill.dataset.filter === type;
        if (isActive) {
            if (type === 'all') {
                pill.className = 'gym-filter-pill flex-shrink-0 px-3 py-1.5 rounded-full text-xs font-bold transition bg-white/20 text-white';
            } else {
                const cfg = courseTypeConfig[type] || { color: 'purple' };
                pill.className = `gym-filter-pill flex-shrink-0 px-3 py-1.5 rounded-full text-xs font-bold transition bg-${cfg.color}-500/20 text-${cfg.color}-300 border border-${cfg.color}-500/30`;
            }
        } else {
            pill.className = 'gym-filter-pill flex-shrink-0 px-3 py-1.5 rounded-full text-xs font-bold transition bg-white/5 text-gray-400 hover:bg-white/10';
        }
    });

    // Filter and render
    const filtered = type === 'all' ? allGymCourses : allGymCourses.filter(c => c.course_type === type);

    if (filtered.length === 0) {
        listEl.innerHTML = `
            <div class="text-center py-8">
                <p class="text-gray-500 text-sm">No ${type} classes available</p>
            </div>
        `;
    } else {
        listEl.innerHTML = filtered.map(course => renderClientCourseCard(course)).join('');
    }
}

// Store current course data for booking
let currentCourseData = null;

async function viewCourseDetails(courseId) {
    // Use cached data first, fallback to fetch
    let course = allGymCourses.find(c => c.id === courseId);

    if (!course) {
        try {
            const response = await fetch('/api/client/gym/courses', { credentials: 'include' });
            const courses = await response.json();
            allGymCourses = courses;
            course = courses.find(c => c.id === courseId);
        } catch (error) {
            console.error('Error loading course:', error);
            showToast('Impossibile caricare i dettagli del corso', 'error');
            return;
        }
    }

    if (!course) {
        showToast('Corso non trovato', 'error');
        return;
    }

    currentCourseData = course;
    openClientCourseDetail(course);
}

// Store pending video embed URL for lazy loading
let pendingVideoEmbedUrl = null;

function openClientCourseDetail(course) {
    const modal = document.getElementById('client-course-detail-modal');
    const trailerIframe = document.getElementById('client-course-trailer');
    const thumbnail = document.getElementById('client-course-thumbnail');
    const thumbImg = document.getElementById('client-course-thumb-img');
    const noTrailer = document.getElementById('client-course-no-trailer');

    // Set trainer info
    const trainerInitial = (course.trainer_name || 'T').charAt(0).toUpperCase();
    document.getElementById('client-course-trainer-initial').textContent = trainerInitial;
    document.getElementById('client-course-trainer-name').textContent = course.trainer_name || 'Trainer';

    // Reset video state
    pendingVideoEmbedUrl = null;
    trailerIframe.src = '';
    trailerIframe.classList.add('hidden');
    thumbnail.classList.add('hidden');
    noTrailer.classList.add('hidden');

    // Check for trailer URL
    if (course.trailer_url) {
        const ytMatch = course.trailer_url.match(/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
        if (ytMatch) {
            // Show thumbnail with play button
            thumbImg.src = `https://i.ytimg.com/vi/${ytMatch[1]}/hq720.jpg`;
            pendingVideoEmbedUrl = `https://www.youtube.com/embed/${ytMatch[1]}?rel=0&modestbranding=1&autoplay=1&controls=1&fs=1`;
            thumbnail.classList.remove('hidden');
        }
        const vimeoMatch = course.trailer_url.match(/(?:vimeo\.com\/)(\d+)/);
        if (vimeoMatch) {
            // Vimeo doesn't have easy thumbnails, load directly
            trailerIframe.src = `https://player.vimeo.com/video/${vimeoMatch[1]}?autoplay=1&controls=1`;
            trailerIframe.classList.remove('hidden');
        }
    }

    // Show no trailer placeholder if no valid URL
    if (!pendingVideoEmbedUrl && trailerIframe.classList.contains('hidden')) {
        noTrailer.classList.remove('hidden');
    }

    // Set course type badge
    const cfg = courseTypeConfig[course.course_type] || { icon: 'book-open', label: course.course_type || 'Class', color: 'purple' };
    const typeBadge = document.getElementById('client-course-type-badge');
    if (typeBadge) {
        typeBadge.textContent = `${icon(cfg.icon, 16)} ${cfg.label}`;
        typeBadge.className = `text-xs font-bold uppercase px-2 py-1 rounded-lg bg-${cfg.color}-500/20 text-${cfg.color}-300`;
    }

    // Set course info
    document.getElementById('client-course-title').textContent = course.name;

    const dayNames = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'];
    const days = course.days_of_week ? course.days_of_week.map(d => dayNames[d]).join(', ') : 'Non programmato';
    document.getElementById('client-course-schedule').textContent = `${days} ${course.time_slot ? '@ ' + course.time_slot : ''}`;
    document.getElementById('client-course-duration').textContent = `${course.duration || 60} min`;

    document.getElementById('client-course-description').textContent = course.description || 'Nessuna descrizione disponibile.';

    // Load upcoming lessons
    loadCourseLessons(course.id);

    modal.classList.remove('hidden');
}

function closeClientCourseDetail() {
    const modal = document.getElementById('client-course-detail-modal');
    const trailerIframe = document.getElementById('client-course-trailer');
    trailerIframe.src = ''; // Stop video
    modal.classList.add('hidden');
    currentCourseData = null;
    pendingVideoEmbedUrl = null;
}

function playClientCourseVideo() {
    if (!pendingVideoEmbedUrl) return;

    const trailerIframe = document.getElementById('client-course-trailer');
    const thumbnail = document.getElementById('client-course-thumbnail');

    thumbnail.classList.add('hidden');
    trailerIframe.src = pendingVideoEmbedUrl;
    trailerIframe.classList.remove('hidden');
}

async function loadCourseLessons(courseId) {
    const container = document.getElementById('client-course-lessons-list');
    container.innerHTML = '<p class="text-sm text-gray-400 animate-pulse">Caricamento sessioni...</p>';

    try {
        const res = await fetch(`/api/client/courses/${courseId}/lessons`, { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load lessons');
        const lessons = await res.json();

        if (lessons.length === 0) {
            container.innerHTML = '<p class="text-sm text-gray-500">Nessuna sessione in programma.</p>';
            return;
        }

        container.innerHTML = lessons.map(lesson => {
            const d = new Date(lesson.date + 'T00:00:00');
            const dayStr = d.toLocaleDateString('it-IT', { weekday: 'short', month: 'short', day: 'numeric' });
            const time = lesson.time || 'TBD';

            let spotsHtml = '';
            if (lesson.max_capacity) {
                const pct = lesson.spots_available / lesson.max_capacity;
                const color = pct <= 0 ? 'text-red-400' : pct <= 0.3 ? 'text-yellow-400' : 'text-green-400';
                spotsHtml = `<span class="${color} text-xs">${lesson.spots_available}/${lesson.max_capacity} posti</span>`;
            }

            let btnHtml = '';
            if (lesson.user_status === 'enrolled') {
                btnHtml = `<button onclick="cancelLessonEnrollment(${lesson.id}, '${courseId}')" class="px-3 py-1.5 bg-red-500/20 text-red-400 text-xs font-bold rounded-lg hover:bg-red-500/30 transition">Annulla</button>`;
            } else if (lesson.user_status === 'waitlisted') {
                btnHtml = `<span class="px-3 py-1.5 bg-yellow-500/20 text-yellow-400 text-xs font-bold rounded-lg">In Lista d'Attesa</span>`;
            } else if (lesson.spots_available !== null && lesson.spots_available <= 0) {
                btnHtml = `<button onclick="enrollInLesson(${lesson.id}, '${courseId}')" class="px-3 py-1.5 bg-yellow-500/20 text-yellow-300 text-xs font-bold rounded-lg hover:bg-yellow-500/30 transition">Lista d'Attesa</button>`;
            } else {
                btnHtml = `<button onclick="enrollInLesson(${lesson.id}, '${courseId}')" class="px-3 py-1.5 bg-purple-500/20 text-purple-300 text-xs font-bold rounded-lg hover:bg-purple-500/30 transition">Prenota</button>`;
            }

            return `
                <div class="flex items-center justify-between bg-white/5 rounded-xl px-4 py-3">
                    <div>
                        <p class="text-white text-sm font-medium">${dayStr}</p>
                        <p class="text-gray-400 text-xs">${time} Â· ${lesson.duration} min</p>
                    </div>
                    <div class="flex items-center gap-3">
                        ${spotsHtml}
                        ${btnHtml}
                    </div>
                </div>
            `;
        }).join('');
    } catch (e) {
        console.error('Error loading lessons:', e);
        container.innerHTML = '<p class="text-sm text-red-400">Impossibile caricare le sessioni.</p>';
    }
}

async function enrollInLesson(lessonId, courseId) {
    try {
        const res = await fetch(`/api/lessons/${lessonId}/enroll`, {
            method: 'POST',
            credentials: 'include'
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Failed to enroll');

        if (data.status === 'waitlisted') {
            showToast(data.message, 'info');
        } else {
            showToast('Prenotato con successo!', 'success');
        }
        // Reload the lesson list to reflect updated status
        loadCourseLessons(courseId);
    } catch (e) {
        showToast(e.message, 'error');
    }
}

async function cancelLessonEnrollment(lessonId, courseId) {
    try {
        const res = await fetch(`/api/lessons/${lessonId}/cancel`, {
            method: 'POST',
            credentials: 'include'
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Failed to cancel');

        showToast('Prenotazione annullata', 'success');
        loadCourseLessons(courseId);
    } catch (e) {
        showToast(e.message, 'error');
    }
}

async function selectTrainerFromProfile() {
    if (!currentViewingTrainerId) return;

    try {
        const response = await fetch('/api/client/select-trainer', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ trainer_id: currentViewingTrainerId })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to select trainer');
        }

        showToast(`${currentViewingTrainerName} Ã¨ ora il tuo trainer!`, 'success');
        closeTrainerProfileModal();
        closeAllTrainersModal();

        // Reload the page to update trainer info
        setTimeout(() => window.location.reload(), 500);
    } catch (error) {
        console.error('Error selecting trainer:', error);
        showToast(error.message, 'error');
    }
}

// --- ALL TRAINERS MODAL ---
async function openAllTrainersModal() {
    document.getElementById('all-trainers-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    // Load trainers
    await loadAllGymTrainers();
}

function closeAllTrainersModal() {
    document.getElementById('all-trainers-modal').classList.add('hidden');
    document.body.style.overflow = '';
}

async function loadAllGymTrainers() {
    const list = document.getElementById('all-trainers-list');
    list.innerHTML = `
        <div class="text-center py-8 text-gray-400">
            <div class="animate-pulse">Caricamento trainer...</div>
        </div>
    `;

    try {
        const response = await fetch('/api/client/gym-trainers', {
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error('Impossibile caricare i trainer');
        }

        allGymTrainers = await response.json();

        if (allGymTrainers.length === 0) {
            list.innerHTML = `
                <div class="text-center py-8 text-gray-400">
                    <p class="mb-2"><i data-lucide="user" class="w-10 h-10"></i></p>
                    <p>Nessun trainer disponibile nella tua palestra</p>
                </div>
            `;
            return;
        }

        list.innerHTML = allGymTrainers.map(trainer => {
            const isMyTrainer = trainer.id === selectedTrainerId;
            const avatarHtml = trainer.profile_picture
                ? `<img src="${trainer.profile_picture}" alt="${trainer.name}" class="w-full h-full object-cover">`
                : `<i data-lucide="user" class="w-6 h-6"></i>`;
            const bioEscaped = trainer.bio ? trainer.bio.replace(/'/g, "\\'").replace(/"/g, "&quot;") : '';
            const specialtiesJson = trainer.specialties ? JSON.stringify(trainer.specialties).replace(/'/g, "\\'") : '[]';

            // Render specialty tags
            const specialtyTags = (trainer.specialties || []).map(s =>
                `<span class="bg-white/10 text-white/70 px-2.5 py-1 rounded-full text-[10px] border border-white/10">${s}</span>`
            ).join('');

            return `
                <div onclick="openTrainerProfileModal('${trainer.id}', '${trainer.name}', ${trainer.profile_picture ? `'${trainer.profile_picture}'` : 'null'}, ${trainer.bio ? `'${bioEscaped}'` : 'null'}, '${specialtiesJson}')"
                    class="glass-card p-4 cursor-pointer hover:bg-white/5 transition tap-effect ${isMyTrainer ? 'border border-orange-500/30' : ''}">
                    <div class="flex space-x-4">
                        <!-- Left column: Avatar -->
                        <div class="flex flex-col items-center flex-shrink-0">
                            <div class="w-16 h-16 rounded-full bg-gradient-to-tr from-red-500 to-orange-500 flex items-center justify-center overflow-hidden">
                                ${avatarHtml}
                            </div>
                        </div>
                        <!-- Right column: Name + Bio + Tags -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 flex-wrap">
                                <p class="font-bold text-white text-lg flex items-center gap-1.5">${trainer.name}${trainer.has_availability ? '<svg class="w-4 h-4 text-green-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>' : ''}</p>
                                ${isMyTrainer ? '<span class="text-[10px] bg-orange-500/20 text-orange-400 px-2 py-0.5 rounded-full">Il Tuo Trainer</span>' : ''}
                            </div>
                            ${trainer.bio ? `<p class="text-sm text-gray-400 mt-1 line-clamp-2">${trainer.bio}</p>` : '<p class="text-sm text-gray-500 italic mt-1">Nessuna bio</p>'}
                            ${specialtyTags ? `<div class="flex flex-wrap gap-1.5 mt-2">${specialtyTags}</div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('Error loading gym trainers:', error);
        list.innerHTML = `
            <div class="text-center py-8 text-red-400">
                <p>Impossibile caricare i trainer</p>
                <button onclick="loadAllGymTrainers()" class="mt-2 text-sm text-orange-400 hover:text-orange-300">Riprova</button>
            </div>
        `;
    }
}

// Update trainer avatar when loading trainer info
function updateTrainerAvatar(profilePicture, trainerName) {
    const avatarContainer = document.getElementById('trainer-avatar');
    if (avatarContainer) {
        if (profilePicture) {
            avatarContainer.innerHTML = `<img src="${profilePicture}" alt="${trainerName}" class="w-full h-full object-cover">`;
        } else {
            avatarContainer.innerHTML = `<i data-lucide="user" class="w-5 h-5"></i>`;
        }
    }

    // Store for profile modal
    currentTrainerData.profile_picture = profilePicture;
}

async function loadTrainerAvailabilityInline(trainerId) {
    try {
        const res = await fetch(`/api/client/trainers/${trainerId}/availability`, { credentials: 'include' });
        if (res.ok) {
            const availability = await res.json();
            if (availability && availability.length > 0) {
                const days = [...new Set(availability.map(a => a.day_of_week))];
                currentTrainerData.availability_text = `${days.length} giorni/settimana`;
            } else {
                currentTrainerData.availability_text = 'Non impostata';
            }
        }
    } catch (e) { /* ignore */ }
}

// --- TRAINER CARD EXPAND/COLLAPSE ---
let trainerCardExpanded = false;

function toggleTrainerCard() {
    const content = document.getElementById('trainer-expand-content');
    const chevron = document.getElementById('trainer-chevron');
    const avatar = document.getElementById('trainer-avatar');
    if (!content) return;

    trainerCardExpanded = !trainerCardExpanded;

    if (trainerCardExpanded) {
        populateTrainerExpandedContent();
        content.classList.add('expanded');
        chevron?.classList.add('rotate-180');
        avatar?.classList.add('avatar-expanded');
    } else {
        content.classList.remove('expanded');
        chevron?.classList.remove('rotate-180');
        avatar?.classList.remove('avatar-expanded');
        // Hide inline details when collapsed
        document.getElementById('trainer-inline-specialties')?.classList.add('hidden');
        document.getElementById('trainer-inline-availability')?.classList.add('hidden');
    }
}

function populateTrainerExpandedContent() {
    const data = currentTrainerData;
    if (!data) return;

    const specs = data.specialties || [];

    // Specialties (next to the name)
    const specEl = document.getElementById('trainer-inline-specialties');
    if (specEl && specs.length > 0) {
        specEl.innerHTML = specs.map(s =>
            `<span class="bg-white/5 text-gray-300 px-2.5 py-1 rounded-full text-[10px] border border-white/10">${s}</span>`
        ).join('');
        specEl.classList.remove('hidden');
    }

    // Availability (under the avatar)
    const availEl = document.getElementById('trainer-inline-availability');
    const availText = document.getElementById('trainer-availability-text');
    if (availEl && availText && data.availability_text) {
        availText.textContent = data.availability_text;
        availEl.classList.remove('hidden');
    }

    // Re-init lucide icons for new elements
    if (typeof lucide !== 'undefined') lucide.createIcons();
}

// --- NUTRITIONIST CARD ---
function updateNutritionistAvatar(profilePicture, name) {
    const avatarContainer = document.getElementById('nutritionist-avatar');
    if (avatarContainer) {
        if (profilePicture) {
            avatarContainer.innerHTML = `<img src="${profilePicture}" alt="${name}" class="w-full h-full object-cover">`;
        } else {
            avatarContainer.innerHTML = `<i data-lucide="apple" class="w-5 h-5"></i>`;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
    }
}

let nutritionistCardExpanded = false;

function toggleNutritionistCard() {
    const content = document.getElementById('nutritionist-expand-content');
    const chevron = document.getElementById('nutritionist-chevron');
    const avatar = document.getElementById('nutritionist-avatar');
    if (!content) return;

    nutritionistCardExpanded = !nutritionistCardExpanded;

    if (nutritionistCardExpanded) {
        populateNutritionistExpandedContent();
        content.classList.add('expanded');
        chevron?.classList.add('rotate-180');
        avatar?.classList.add('avatar-expanded');
    } else {
        content.classList.remove('expanded');
        chevron?.classList.remove('rotate-180');
        avatar?.classList.remove('avatar-expanded');
        document.getElementById('nutritionist-inline-specialties')?.classList.add('hidden');
    }
}

function populateNutritionistExpandedContent() {
    const data = window.currentNutritionistData;
    if (!data) return;

    const specs = data.specialties || [];
    const specEl = document.getElementById('nutritionist-inline-specialties');
    if (specEl && specs.length > 0) {
        specEl.innerHTML = specs.map(s =>
            `<span class="bg-white/5 text-gray-300 px-2.5 py-1 rounded-full text-[10px] border border-white/10">${s}</span>`
        ).join('');
        specEl.classList.remove('hidden');
    }

    if (typeof lucide !== 'undefined') lucide.createIcons();
}

window.openNutritionistDirectChat = function() {
    const nutriId = window.selectedNutritionistId;
    const nutriName = window.currentNutritionistData?.name;
    const nutriPic = window.currentNutritionistData?.profile_picture || null;
    if (nutriId && nutriName && window.openChatModal) {
        window.openChatModal(nutriId, nutriName, nutriPic);
    } else {
        window.openConversationsModal();
    }
};

async function loadNutritionistAppointments() {
    try {
        const response = await fetch('/api/client/nutrition-appointments', { credentials: 'include' });
        if (!response.ok) return;

        const allAppts = await response.json();
        const appointments = allAppts.filter(a => a.status !== 'canceled' && a.status !== 'cancelled');

        const listEl = document.getElementById('nutrition-appointments-list');
        if (!listEl) return;

        if (appointments.length === 0) {
            listEl.innerHTML = `
                <div class="glass-card p-3 text-center text-sm text-gray-400">
                    Nessuna consulenza in programma
                </div>
            `;
            return;
        }

        listEl.innerHTML = appointments.slice(0, 3).map(appt => `
            <div class="glass-card p-3">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-bold text-sm text-white">${new Date(appt.date).toLocaleDateString('it-IT', { month: 'short', day: 'numeric' })}</p>
                        <p class="text-xs text-gray-400">${appt.start_time} â€¢ ${appt.duration} min</p>
                        ${appt.notes ? `<p class="text-xs text-gray-500 mt-1">${appt.notes}</p>` : ''}
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] px-2 py-0.5 rounded-full bg-cyan-500/20 text-cyan-400">${appt.status === 'scheduled' ? 'Programmata' : appt.status}</span>
                        <button onclick="cancelNutritionAppointment('${appt.id}')" class="text-xs text-red-400 hover:text-red-300 transition" title="Annulla">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');

        if (typeof lucide !== 'undefined') lucide.createIcons();
    } catch (error) {
        console.error('Error loading nutritionist appointments:', error);
    }
}

async function cancelNutritionAppointment(appointmentId) {
    if (!confirm('Vuoi annullare questa consulenza?')) return;
    try {
        const res = await fetch(`/api/client/nutrition-appointments/${appointmentId}/cancel`, {
            method: 'POST', credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });
        if (res.ok) {
            showToast('Consulenza annullata', 'success');
            loadNutritionistAppointments();
        } else {
            const err = await res.json();
            showToast(err.detail || 'Errore', 'error');
        }
    } catch (e) { showToast('Errore di rete', 'error'); }
}

// --- GYM MEMBERS ---
let gymMembers = [];
let chatRequestTarget = null;

async function loadGymMembersPreview() {
    try {
        const response = await fetch('/api/client/gym-members', { credentials: 'include' });
        if (response.ok) {
            gymMembers = await response.json();
            renderMembersPreview();
        }
    } catch (error) {
        console.error('Error loading gym members:', error);
    }
}

function renderMembersPreview() {
    const avatarsContainer = document.getElementById('members-avatars');
    const countSpan = document.getElementById('members-count');

    if (!avatarsContainer || !countSpan) return;

    if (gymMembers.length === 0) {
        avatarsContainer.innerHTML = '';
        countSpan.textContent = 'Ancora nessun altro membro';
        return;
    }

    // Show up to 5 avatars
    const displayMembers = gymMembers.slice(0, 5);
    avatarsContainer.innerHTML = displayMembers.map(member => `
        <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center overflow-hidden border-2 border-black">
            ${member.profile_picture
                ? `<img src="${member.profile_picture}" class="w-full h-full object-cover">`
                : '<i data-lucide="user" class="w-3 h-3"></i>'}
        </div>
    `).join('');

    const remaining = gymMembers.length - 5;
    if (gymMembers.length === 1) {
        countSpan.textContent = '1 membro';
    } else if (remaining > 0) {
        countSpan.textContent = `+${remaining} more`;
    } else {
        countSpan.textContent = `${gymMembers.length} membri`;
    }
}

function openGymMembersModal() {
    document.getElementById('gym-members-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    loadGymMembersList();
}

function closeGymMembersModal() {
    document.getElementById('gym-members-modal').classList.add('hidden');
    document.body.style.overflow = '';
}

async function loadGymMembersList() {
    const list = document.getElementById('gym-members-list');
    list.innerHTML = `
        <div class="text-center py-8 text-gray-400">
            <div class="animate-pulse">Caricamento membri...</div>
        </div>
    `;

    try {
        const response = await fetch('/api/client/gym-members', { credentials: 'include' });
        if (!response.ok) throw new Error('Impossibile caricare i membri');

        gymMembers = await response.json();

        if (gymMembers.length === 0) {
            list.innerHTML = `
                <div class="text-center py-8 text-gray-400">
                    <p class="mb-2"><i data-lucide="users" class="w-10 h-10"></i></p>
                    <p>Ancora nessun altro membro nella tua palestra</p>
                </div>
            `;
            return;
        }

        list.innerHTML = gymMembers.map(member => {
            const avatarHtml = member.profile_picture
                ? `<img src="${member.profile_picture}" class="w-full h-full object-cover">`
                : '<i data-lucide="user" class="w-5 h-5"></i>';

            return `
                <div class="glass-card p-4 flex items-center justify-between cursor-pointer hover:bg-white/10 transition"
                    onclick="openMemberProfile('${member.id}')">
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center overflow-hidden">
                            ${avatarHtml}
                        </div>
                        <div>
                            <p class="font-bold text-white">${member.name || member.username}</p>
                        </div>
                    </div>
                    <span class="text-gray-400 text-sm">Vedi &rarr;</span>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('Error loading gym members:', error);
        list.innerHTML = `
            <div class="text-center py-8 text-red-400">
                <p>Impossibile caricare i membri</p>
                <button onclick="loadGymMembersList()" class="mt-2 text-sm text-blue-400 hover:text-blue-300">Riprova</button>
            </div>
        `;
    }
}

async function initiateChat(userId, username, profilePicture) {
    try {
        // Check if we can message this user
        const response = await fetch(`/api/client/can-message/${userId}`, { credentials: 'include' });
        if (!response.ok) throw new Error('Failed to check messaging status');

        const result = await response.json();

        if (result.can_message) {
            // Can message directly - open chat
            closeGymMembersModal();
            if (typeof openChatModal === 'function') {
                openChatModal(userId, username);
            } else if (typeof openConversationsModal === 'function') {
                openConversationsModal();
            } else {
                showToast('Messaggistica non disponibile', 'error');
            }
        } else if (result.reason === 'request_pending') {
            showToast('La tua richiesta di chat Ã¨ ancora in sospeso', 'info');
        } else if (result.needs_request) {
            // Need to send chat request - show modal
            openChatRequestModal(userId, username, profilePicture);
        } else {
            showToast('Impossibile inviare un messaggio a questo utente', 'error');
        }
    } catch (error) {
        console.error('Error initiating chat:', error);
        showToast('Impossibile avviare la chat', 'error');
    }
}

function openChatRequestModal(userId, username, profilePicture) {
    chatRequestTarget = { userId, username, profilePicture };

    // Update modal content
    document.getElementById('chat-request-name').textContent = username;
    const avatarEl = document.getElementById('chat-request-avatar');
    if (profilePicture) {
        avatarEl.innerHTML = `<img src="${profilePicture}" class="w-full h-full object-cover">`;
    } else {
        avatarEl.innerHTML = '<i data-lucide="user" class="w-8 h-8"></i>';
    }
    document.getElementById('chat-request-message').value = '';

    document.getElementById('chat-request-modal').classList.remove('hidden');
}

function closeChatRequestModal() {
    document.getElementById('chat-request-modal').classList.add('hidden');
    chatRequestTarget = null;
}

async function sendChatRequest() {
    if (!chatRequestTarget) return;

    const message = document.getElementById('chat-request-message').value.trim();

    try {
        const response = await fetch('/api/client/chat-requests', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                to_user_id: chatRequestTarget.userId,
                message: message || null
            })
        });

        if (response.ok) {
            const result = await response.json();
            if (result.status === 'public' || result.status === 'already_accepted') {
                showToast('Puoi scrivergli direttamente!', 'success');
                closeChatRequestModal();
                closeGymMembersModal();
                if (typeof openChatModal === 'function') {
                    openChatModal(chatRequestTarget.userId, chatRequestTarget.username);
                }
            } else {
                showToast('Richiesta di chat inviata!', 'success');
                closeChatRequestModal();
            }
        } else {
            const error = await response.json();
            showToast(error.detail || 'Impossibile inviare la richiesta', 'error');
        }
    } catch (error) {
        console.error('Error sending chat request:', error);
        showToast('Impossibile inviare la richiesta', 'error');
    }
}

// --- FRIENDS SYSTEM ---
let friendsList = [];
let pendingFriendRequests = { incoming: [], outgoing: [] };
let friendRequestTarget = null;

async function loadFriendsPreview() {
    console.log('loadFriendsPreview called');
    try {
        const response = await fetch('/api/friends', { credentials: 'include' });
        console.log('/api/friends response:', response.status);
        if (response.ok) {
            friendsList = await response.json();
            console.log('Friends list:', friendsList);
            renderFriendsPreview();
        }
    } catch (error) {
        console.error('Error loading friends:', error);
    }

    // Also load pending requests count
    console.log('Calling loadFriendRequestsCount...');
    loadFriendRequestsCount();
}

function renderFriendsPreview() {
    const avatarsContainer = document.getElementById('friends-avatars');
    const countSpan = document.getElementById('friends-count');

    if (!avatarsContainer || !countSpan) return;

    if (friendsList.length === 0) {
        avatarsContainer.innerHTML = '';
        countSpan.textContent = 'Ancora nessun amico';
        return;
    }

    // Show up to 5 avatars
    const displayFriends = friendsList.slice(0, 5);
    avatarsContainer.innerHTML = displayFriends.map(friend => `
        <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center overflow-hidden border-2 border-black">
            ${friend.profile_picture
                ? `<img src="${friend.profile_picture}" class="w-full h-full object-cover">`
                : '<i data-lucide="user" class="w-3 h-3"></i>'}
        </div>
    `).join('');

    const remaining = friendsList.length - 5;
    if (friendsList.length === 1) {
        countSpan.textContent = '1 amico';
    } else if (remaining > 0) {
        countSpan.textContent = `+${remaining} more`;
    } else {
        countSpan.textContent = `${friendsList.length} amici`;
    }
}

async function loadFriendRequestsCount() {
    console.log('loadFriendRequestsCount called');
    try {
        console.log('Fetching /api/friends/requests/incoming...');
        const response = await fetch('/api/friends/requests/incoming', { credentials: 'include' });
        console.log('/api/friends/requests/incoming response:', response.status);
        if (response.ok) {
            const incoming = await response.json();
            console.log('Incoming requests:', incoming);
            const badge = document.getElementById('friend-requests-badge');
            const count = document.getElementById('pending-requests-count');
            console.log('Badge element:', badge, 'Count element:', count);
            if (incoming.length > 0) {
                console.log('Showing badge for', incoming.length, 'requests');
                badge?.classList.remove('hidden');
                if (count) count.textContent = incoming.length;
            } else {
                badge?.classList.add('hidden');
            }
        }
    } catch (error) {
        console.error('Error loading friend requests count:', error);
    }
}

function openFriendsModal() {
    document.getElementById('friends-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    showFriendsTab('friends');
    loadFriendsModalData();
}

function closeFriendsModal() {
    document.getElementById('friends-modal').classList.add('hidden');
    document.body.style.overflow = '';
}

function showFriendsTab(tab) {
    const friendsTab = document.getElementById('tab-friends');
    const requestsTab = document.getElementById('tab-requests');
    const friendsContainer = document.getElementById('friends-list-container');
    const requestsContainer = document.getElementById('requests-container');

    if (tab === 'friends') {
        friendsTab.classList.add('bg-purple-500', 'text-white');
        friendsTab.classList.remove('text-gray-400');
        requestsTab.classList.remove('bg-purple-500', 'text-white');
        requestsTab.classList.add('text-gray-400');
        friendsContainer.classList.remove('hidden');
        requestsContainer.classList.add('hidden');
    } else {
        requestsTab.classList.add('bg-purple-500', 'text-white');
        requestsTab.classList.remove('text-gray-400');
        friendsTab.classList.remove('bg-purple-500', 'text-white');
        friendsTab.classList.add('text-gray-400');
        requestsContainer.classList.remove('hidden');
        friendsContainer.classList.add('hidden');
        loadFriendRequests();
    }
}

async function loadFriendsModalData() {
    const list = document.getElementById('friends-list');
    const noFriendsMsg = document.getElementById('no-friends-message');

    try {
        const response = await fetch('/api/friends', { credentials: 'include' });
        if (!response.ok) throw new Error('Impossibile caricare gli amici');

        friendsList = await response.json();

        if (friendsList.length === 0) {
            list.innerHTML = '';
            noFriendsMsg?.classList.remove('hidden');
            return;
        }

        noFriendsMsg?.classList.add('hidden');
        list.innerHTML = friendsList.map(friend => `
            <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl hover:bg-white/10 transition">
                <div class="flex items-center gap-3 cursor-pointer" onclick="closeFriendsModal(); openMemberProfile('${friend.id}')">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center overflow-hidden">
                        ${friend.profile_picture
                            ? `<img src="${friend.profile_picture}" class="w-full h-full object-cover">`
                            : '<i data-lucide="user" class="w-5 h-5"></i>'}
                    </div>
                    <div>
                        <p class="font-medium text-white">${friend.name || friend.username}</p>
                        <div class="flex items-center gap-2 text-xs text-gray-400">
                            <span>${icon('flame', 12)} ${friend.streak || 0}</span>
                            <span>ðŸ”¶ ${friend.gems || 0}</span>
                        </div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="messageFromFriendsList('${friend.id}', '${friend.name || friend.username}')"
                        class="p-2 bg-orange-500/20 text-orange-400 rounded-lg hover:bg-orange-500/30 transition">
                        <i data-lucide="message-circle" class="w-5 h-5"></i>
                    </button>
                    <button onclick="confirmUnfriend('${friend.id}', '${friend.name || friend.username}')"
                        class="p-2 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30 transition">
                        âœ•
                    </button>
                </div>
            </div>
        `).join('');

    } catch (error) {
        console.error('Error loading friends:', error);
        list.innerHTML = '<p class="text-center text-red-400 py-4">Impossibile caricare gli amici</p>';
    }
}

async function loadFriendRequests() {
    try {
        const [incomingRes, outgoingRes] = await Promise.all([
            fetch('/api/friends/requests/incoming', { credentials: 'include' }),
            fetch('/api/friends/requests/outgoing', { credentials: 'include' })
        ]);

        const incoming = incomingRes.ok ? await incomingRes.json() : [];
        const outgoing = outgoingRes.ok ? await outgoingRes.json() : [];

        pendingFriendRequests = { incoming, outgoing };
        renderFriendRequests();

        // Update badge
        const badge = document.getElementById('requests-badge');
        if (incoming.length > 0) {
            badge.classList.remove('hidden');
            badge.textContent = incoming.length;
        } else {
            badge.classList.add('hidden');
        }

    } catch (error) {
        console.error('Error loading friend requests:', error);
    }
}

function renderFriendRequests() {
    const incomingContainer = document.getElementById('incoming-requests');
    const outgoingContainer = document.getElementById('outgoing-requests');
    const noIncoming = document.getElementById('no-incoming-requests');
    const noOutgoing = document.getElementById('no-outgoing-requests');

    // Render incoming requests
    if (pendingFriendRequests.incoming.length === 0) {
        incomingContainer.innerHTML = '';
        noIncoming?.classList.remove('hidden');
    } else {
        noIncoming?.classList.add('hidden');
        incomingContainer.innerHTML = pendingFriendRequests.incoming.map(req => `
            <div class="flex items-center justify-between p-3 bg-purple-500/10 rounded-xl border border-purple-500/20">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center overflow-hidden">
                        ${req.profile_picture
                            ? `<img src="${req.profile_picture}" class="w-full h-full object-cover">`
                            : '<i data-lucide="user" class="w-4 h-4"></i>'}
                    </div>
                    <div>
                        <p class="font-medium text-white text-sm">${req.name || req.username}</p>
                        ${req.message ? `<p class="text-xs text-gray-400 truncate max-w-[150px]">"${req.message}"</p>` : ''}
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="respondToFriendRequest(${req.id}, true)"
                        class="px-3 py-1.5 bg-green-500 text-white text-xs font-bold rounded-lg hover:bg-green-400 transition">
                        Accetta
                    </button>
                    <button onclick="respondToFriendRequest(${req.id}, false)"
                        class="px-3 py-1.5 bg-white/10 text-gray-300 text-xs font-bold rounded-lg hover:bg-white/20 transition">
                        Rifiuta
                    </button>
                </div>
            </div>
        `).join('');
    }

    // Render outgoing requests
    if (pendingFriendRequests.outgoing.length === 0) {
        outgoingContainer.innerHTML = '';
        noOutgoing?.classList.remove('hidden');
    } else {
        noOutgoing?.classList.add('hidden');
        outgoingContainer.innerHTML = pendingFriendRequests.outgoing.map(req => `
            <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-gray-500 to-gray-600 flex items-center justify-center overflow-hidden">
                        ${req.profile_picture
                            ? `<img src="${req.profile_picture}" class="w-full h-full object-cover">`
                            : '<i data-lucide="user" class="w-4 h-4"></i>'}
                    </div>
                    <div>
                        <p class="font-medium text-white text-sm">${req.name || req.username}</p>
                        <p class="text-xs text-gray-500">In attesa...</p>
                    </div>
                </div>
                <button onclick="cancelFriendRequest(${req.id})"
                    class="px-3 py-1.5 bg-white/10 text-gray-300 text-xs font-bold rounded-lg hover:bg-white/20 transition">
                    Annulla
                </button>
            </div>
        `).join('');
    }
}

async function respondToFriendRequest(requestId, accept) {
    try {
        const response = await fetch('/api/friends/request/respond', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ request_id: requestId, accept })
        });

        if (response.ok) {
            showToast(accept ? 'Amico aggiunto!' : 'Richiesta rifiutata', accept ? 'success' : 'info');
            loadFriendRequests();
            if (accept) {
                loadFriendsModalData();
                loadFriendsPreview();
            }
        } else {
            const error = await response.json();
            showToast(error.detail || 'Impossibile rispondere', 'error');
        }
    } catch (error) {
        console.error('Error responding to friend request:', error);
        showToast('Impossibile rispondere', 'error');
    }
}

async function cancelFriendRequest(requestId) {
    try {
        const response = await fetch(`/api/friends/request/${requestId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        if (response.ok) {
            showToast('Richiesta annullata', 'info');
            loadFriendRequests();
        } else {
            showToast('Impossibile annullare la richiesta', 'error');
        }
    } catch (error) {
        console.error('Error cancelling friend request:', error);
        showToast('Impossibile annullare la richiesta', 'error');
    }
}

function confirmUnfriend(friendId, friendName) {
    if (confirm(`Rimuovere ${friendName} dai tuoi amici?`)) {
        removeFriend(friendId);
    }
}

async function removeFriend(friendId) {
    try {
        const response = await fetch(`/api/friends/${friendId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        if (response.ok) {
            showToast('Amico rimosso', 'info');
            loadFriendsModalData();
            loadFriendsPreview();
        } else {
            showToast('Impossibile rimuovere l\'amico', 'error');
        }
    } catch (error) {
        console.error('Error removing friend:', error);
        showToast('Impossibile rimuovere l\'amico', 'error');
    }
}

// --- CO-OP WORKOUT FUNCTIONS ---

function openCoopModal() {
    document.getElementById('coop-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    loadCoopFriends();
}

function closeCoopModal() {
    document.getElementById('coop-modal').classList.add('hidden');
    document.body.style.overflow = '';
    // Reset waiting state
    document.getElementById('coop-waiting')?.classList.add('hidden');
    document.getElementById('coop-friends-list')?.classList.remove('hidden');
    pendingCoopPartner = null;
}

async function loadCoopFriends() {
    const list = document.getElementById('coop-friends-list');
    const noFriendsMsg = document.getElementById('coop-no-friends');
    const loadingMsg = document.getElementById('coop-loading');

    loadingMsg?.classList.remove('hidden');
    list.innerHTML = '';
    noFriendsMsg?.classList.add('hidden');

    try {
        const response = await fetch('/api/friends', { credentials: 'include' });
        if (!response.ok) throw new Error('Impossibile caricare gli amici');

        const friends = await response.json();
        loadingMsg?.classList.add('hidden');

        if (friends.length === 0) {
            noFriendsMsg?.classList.remove('hidden');
            return;
        }

        list.innerHTML = friends.map(friend => `
            <div onclick="startCoopWorkout('${friend.id}', '${friend.name || friend.username}', '${friend.profile_picture || ''}')"
                class="flex items-center gap-3 p-4 bg-white/5 rounded-xl hover:bg-purple-500/20 border border-transparent hover:border-purple-500/30 transition cursor-pointer tap-effect">
                <div class="w-14 h-14 rounded-full bg-gradient-to-tr from-purple-500 to-pink-500 flex items-center justify-center overflow-hidden flex-shrink-0">
                    ${friend.profile_picture
                        ? `<img src="${friend.profile_picture}" class="w-full h-full object-cover">`
                        : '<i data-lucide="user" class="w-5 h-5"></i>'}
                </div>
                <div class="flex-1">
                    <p class="font-bold text-white">${friend.name || friend.username}</p>
                    <div class="flex items-center gap-3 text-sm text-gray-400">
                        <span>${icon('flame', 12)} ${friend.streak || 0} streak</span>
                        <span>${icon('heart', 12)} ${friend.health_score || 0}%</span>
                    </div>
                </div>
                <div class="text-purple-400 text-xl">â†’</div>
            </div>
        `).join('');

    } catch (error) {
        console.error('Error loading friends for CO-OP:', error);
        loadingMsg?.classList.add('hidden');
        list.innerHTML = '<p class="text-center text-red-400 py-4">Impossibile caricare gli amici</p>';
    }
}

// CO-OP state
let pendingCoopInvite = null; // { inviterId, inviterName, inviterPicture }
let pendingCoopPartner = null; // { id, name, profile_picture }

function startCoopWorkout(partnerId, partnerName, partnerPicture) {
    // Store pending partner info
    pendingCoopPartner = { id: partnerId, name: partnerName, profile_picture: partnerPicture };

    // Send WebSocket invite
    if (window.sendWebSocketMessage) {
        const sent = window.sendWebSocketMessage({
            type: 'coop_invite',
            partner_id: partnerId
        });

        if (sent) {
            // Show waiting state
            showCoopWaitingState(partnerName, partnerPicture);
        } else {
            showToast('Errore di connessione. Riprova.', 'error');
        }
    } else {
        showToast('Non connesso al server', 'error');
    }
}

function showCoopWaitingState(partnerName, partnerPicture) {
    // Hide friends list, show waiting state
    document.getElementById('coop-friends-list')?.classList.add('hidden');
    document.getElementById('coop-no-friends')?.classList.add('hidden');
    document.getElementById('coop-loading')?.classList.add('hidden');

    const waiting = document.getElementById('coop-waiting');
    const nameEl = document.getElementById('coop-waiting-name');
    const avatarEl = document.getElementById('coop-waiting-avatar');

    if (nameEl) nameEl.textContent = partnerName;
    if (avatarEl && partnerPicture) {
        avatarEl.innerHTML = `<img src="${partnerPicture}" class="w-full h-full object-cover">`;
    }
    waiting?.classList.remove('hidden');
}

function cancelCoopInvite() {
    pendingCoopPartner = null;
    closeCoopModal();
    showToast('Invito CO-OP annullato', 'info');
}

// Called when friend is offline
window.handleCoopInviteFailed = function(reason) {
    pendingCoopPartner = null;
    document.getElementById('coop-waiting')?.classList.add('hidden');
    document.getElementById('coop-friends-list')?.classList.remove('hidden');
    showToast(reason || 'Friend is offline', 'error');
};

// Called when friend accepts
window.handleCoopAccepted = function(partnerId, partnerName, partnerPicture) {
    console.log('handleCoopAccepted called!', { partnerId, partnerName, partnerPicture });

    // Store co-op partner info
    localStorage.setItem('coopPartner', JSON.stringify({
        id: partnerId,
        name: partnerName,
        profile_picture: partnerPicture
    }));

    closeCoopModal();
    showToast(`${partnerName} accepted! Starting CO-OP workout...`, 'success');

    // Navigate to workout - build URL without Jinja escaping issues
    {% if static_build %}
    const finalUrl = 'workout.html?coop=true';
    {% else %}
    const finalUrl = '/?gym_id={{ gym_id }}&role=client&mode=workout&coop=true';
    {% endif %}
    console.log('Navigating to:', finalUrl);

    setTimeout(() => {
        window.location.href = finalUrl;
    }, 500);
};

// Called when friend declines
window.handleCoopDeclined = function(partnerName) {
    pendingCoopPartner = null;
    document.getElementById('coop-waiting')?.classList.add('hidden');
    document.getElementById('coop-friends-list')?.classList.remove('hidden');
    showToast(`${partnerName} declined the invite`, 'info');
};

// Show CO-OP invitation modal (called when receiving an invite)
window.showCoopInviteModal = function(inviterId, inviterName, inviterPicture) {
    pendingCoopInvite = { inviterId, inviterName, inviterPicture };

    const modal = document.getElementById('coop-invite-modal');
    const nameEl = document.getElementById('coop-invite-name');
    const avatarEl = document.getElementById('coop-invite-avatar');

    if (nameEl) nameEl.textContent = inviterName;
    if (avatarEl) {
        if (inviterPicture) {
            avatarEl.outerHTML = `<img id="coop-invite-avatar" src="${inviterPicture}" class="w-full h-full object-cover rounded-full">`;
        } else {
            avatarEl.innerHTML = '<i data-lucide="user" class="w-5 h-5"></i>';
        }
    }
    modal?.classList.remove('hidden');
};

function acceptCoopInvite() {
    if (!pendingCoopInvite) return;

    // Send acceptance via WebSocket
    if (window.sendWebSocketMessage) {
        window.sendWebSocketMessage({
            type: 'coop_accept',
            inviter_id: pendingCoopInvite.inviterId
        });
    }

    // Close modal and show message
    document.getElementById('coop-invite-modal')?.classList.add('hidden');
    showToast(`Joined CO-OP workout with ${pendingCoopInvite.inviterName}!`, 'success');

    // The inviter will control the workout - we just wait or show a message
    pendingCoopInvite = null;
}

function declineCoopInvite() {
    if (!pendingCoopInvite) return;

    // Send decline via WebSocket
    if (window.sendWebSocketMessage) {
        window.sendWebSocketMessage({
            type: 'coop_decline',
            inviter_id: pendingCoopInvite.inviterId
        });
    }

    document.getElementById('coop-invite-modal')?.classList.add('hidden');
    pendingCoopInvite = null;
}

function openFriendRequestModal(userId, username, profilePicture) {
    console.log('openFriendRequestModal called:', userId, username);
    friendRequestTarget = { userId, username, profilePicture };

    const nameEl = document.getElementById('friend-request-name');
    const avatarEl = document.getElementById('friend-request-avatar');
    const messageEl = document.getElementById('friend-request-message');
    const modal = document.getElementById('friend-request-modal');

    console.log('Modal elements:', { nameEl: !!nameEl, avatarEl: !!avatarEl, messageEl: !!messageEl, modal: !!modal });

    if (nameEl) nameEl.textContent = username;
    if (avatarEl) {
        if (profilePicture) {
            avatarEl.innerHTML = `<img src="${profilePicture}" class="w-full h-full object-cover">`;
        } else {
            avatarEl.innerHTML = '<i data-lucide="user" class="w-8 h-8"></i>';
        }
    }
    if (messageEl) messageEl.value = '';

    if (modal) {
        modal.classList.remove('hidden');
        console.log('Friend request modal opened');
    } else {
        console.error('Friend request modal not found!');
    }
}

function closeFriendRequestModal() {
    document.getElementById('friend-request-modal').classList.add('hidden');
    friendRequestTarget = null;
}

async function submitFriendRequest() {
    if (!friendRequestTarget) return;

    const message = document.getElementById('friend-request-message').value.trim();

    try {
        const response = await fetch('/api/friends/request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                to_user_id: friendRequestTarget.userId,
                message: message || null
            })
        });

        if (response.ok) {
            const result = await response.json();
            if (result.status === 'accepted') {
                showToast('Ora siete amici!', 'success');
                loadFriendsPreview();
            } else {
                showToast('Richiesta di amicizia inviata!', 'success');
            }
            closeFriendRequestModal();
            closeMemberProfileModal();
            // Refresh member profile if still viewing
            if (currentProfileMember) {
                updateFriendActionButton(result.status === 'accepted' ? 'friends' : 'pending_outgoing');
            }
        } else {
            const error = await response.json();
            showToast(error.detail || 'Impossibile inviare la richiesta', 'error');
        }
    } catch (error) {
        console.error('Error sending friend request:', error);
        showToast('Impossibile inviare la richiesta', 'error');
    }
}

function handleFriendAction() {
    console.log('handleFriendAction called, currentProfileMember:', currentProfileMember);
    if (!currentProfileMember) {
        console.error('No currentProfileMember');
        return;
    }

    const status = currentProfileMember.friendship_status || 'none';
    console.log('Friendship status:', status);

    switch (status) {
        case 'none':
            console.log('Opening friend request modal');
            openFriendRequestModal(
                currentProfileMember.id,
                currentProfileMember.name || currentProfileMember.username,
                currentProfileMember.profile_picture
            );
            break;
        case 'pending_outgoing':
            if (currentProfileMember.friendship_request_id) {
                if (confirm('Annullare la richiesta di amicizia?')) {
                    cancelFriendRequestAndUpdate(currentProfileMember.friendship_request_id);
                }
            }
            break;
        case 'pending_incoming':
            if (currentProfileMember.friendship_request_id) {
                respondToFriendRequestAndUpdate(currentProfileMember.friendship_request_id, true);
            }
            break;
        case 'friends':
            if (confirm(`Remove ${currentProfileMember.name || currentProfileMember.username} from friends?`)) {
                removeFriendAndUpdate(currentProfileMember.id);
            }
            break;
        default:
            console.log('Unknown friendship status:', status);
    }
}

async function cancelFriendRequestAndUpdate(requestId) {
    await cancelFriendRequest(requestId);
    updateFriendActionButton('none');
    currentProfileMember.friendship_status = 'none';
}

async function respondToFriendRequestAndUpdate(requestId, accept) {
    await respondToFriendRequest(requestId, accept);
    if (accept) {
        updateFriendActionButton('friends');
        currentProfileMember.friendship_status = 'friends';
        currentProfileMember.is_friend = true;
        loadFriendProgress(currentProfileMember.id);
    } else {
        updateFriendActionButton('none');
        currentProfileMember.friendship_status = 'none';
    }
}

async function removeFriendAndUpdate(friendId) {
    await removeFriend(friendId);
    updateFriendActionButton('none');
    currentProfileMember.friendship_status = 'none';
    currentProfileMember.is_friend = false;
    document.getElementById('friend-progress-section')?.classList.add('hidden');
}

function updateFriendActionButton(status) {
    const btn = document.getElementById('friend-action-btn');
    const text = document.getElementById('friend-action-text');
    if (!btn || !text) return;

    switch (status) {
        case 'none':
            text.textContent = 'Aggiungi Amico';
            btn.className = 'w-full py-2.5 bg-purple-500/20 text-purple-300 font-bold rounded-xl border border-purple-500/30 hover:bg-purple-500/30 transition tap-effect';
            break;
        case 'pending_outgoing':
            text.textContent = 'Richiesta Inviata (tocca per annullare)';
            btn.className = 'w-full py-2.5 bg-gray-500/20 text-gray-400 font-bold rounded-xl border border-gray-500/30 hover:bg-gray-500/30 transition tap-effect';
            break;
        case 'pending_incoming':
            text.textContent = 'Accetta Richiesta di Amicizia';
            btn.className = 'w-full py-2.5 bg-green-500/20 text-green-300 font-bold rounded-xl border border-green-500/30 hover:bg-green-500/30 transition tap-effect';
            break;
        case 'friends':
            text.textContent = 'Amici âœ“';
            btn.className = 'w-full py-2.5 bg-purple-500 text-white font-bold rounded-xl hover:bg-purple-400 transition tap-effect';
            break;
    }
}

async function loadFriendProgress(friendId) {
    console.log('[FriendProgress] Loading progress for friend:', friendId);
    try {
        const response = await fetch(`/api/friends/${friendId}/progress`, { credentials: 'include' });
        console.log('[FriendProgress] Response status:', response.status);
        if (!response.ok) {
            const errorText = await response.text();
            console.error('[FriendProgress] API error:', errorText);
            return;
        }

        const data = await response.json();
        console.log('[FriendProgress] Data received:', data);

        // Show section FIRST so canvas has dimensions
        const section = document.getElementById('friend-progress-section');
        console.log('[FriendProgress] Section element:', section);
        if (section) {
            section.classList.remove('hidden');
            console.log('[FriendProgress] Section should now be visible');
        }

        // Then render charts
        renderFriendProgress(data);
    } catch (error) {
        console.error('[FriendProgress] Error:', error);
    }
}

let currentFriendProgressData = null;

function renderFriendProgress(data) {
    currentFriendProgressData = data;

    // Wait for DOM to compute dimensions before rendering charts
    requestAnimationFrame(() => {
        setTimeout(() => {
            // Render strength chart
            renderFriendStrengthChart(data);

            // Render strength stats with goals
            renderFriendStrengthStats(data);

            // Render weight chart
            renderFriendWeightChart(data);

            // Render health score bars
            renderFriendHealthBars(data);
        }, 50);
    });
}

function switchFriendProgressTab(tab) {
    const tabs = ['strength', 'weight', 'health'];
    tabs.forEach(t => {
        const tabBtn = document.getElementById(`friend-tab-${t}`);
        const view = document.getElementById(`friend-${t}-view`);
        if (tabBtn && view) {
            if (t === tab) {
                tabBtn.className = 'px-2 py-1 text-[10px] font-semibold rounded-md bg-purple-500 text-white transition';
                view.classList.remove('hidden');
            } else {
                tabBtn.className = 'px-2 py-1 text-[10px] font-semibold rounded-md text-gray-400 hover:text-white transition';
                view.classList.add('hidden');
            }
        }
    });
}

function renderFriendStrengthChart(data) {
    const canvas = document.getElementById('friend-strength-chart');
    if (!canvas) return;

    const strengthData = data.strength_by_category;
    if (!strengthData || !strengthData.categories) {
        const ctx = canvas.getContext('2d');
        const rect = canvas.getBoundingClientRect();
        ctx.fillStyle = '#6b7280';
        ctx.font = '11px system-ui';
        ctx.textAlign = 'center';
        ctx.fillText('Nessun dato sulla forza disponibile', rect.width / 2, rect.height / 2);
        return;
    }

    const ctx = canvas.getContext('2d');
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 2;
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.scale(dpr, dpr);

    const width = rect.width;
    const height = rect.height;
    const padding = { top: 15, right: 10, bottom: 20, left: 30 };
    const chartWidth = width - padding.left - padding.right;
    const chartHeight = height - padding.top - padding.bottom;

    // Clear canvas
    ctx.clearRect(0, 0, width, height);

    // Get all data points
    const categories = ['upper_body', 'lower_body', 'cardio'];
    const colors = {
        upper_body: '#F97316',
        lower_body: '#8B5CF6',
        cardio: '#22C55E'
    };

    let allValues = [];
    let referenceData = null;

    categories.forEach(cat => {
        const catData = strengthData.categories[cat]?.data || [];
        catData.forEach(d => {
            if (d.strength !== null) allValues.push(d.strength);
        });
        if (!referenceData && catData.length > 0) referenceData = catData;
    });

    if (!referenceData || allValues.length === 0) {
        ctx.fillStyle = '#6b7280';
        ctx.font = '11px system-ui';
        ctx.textAlign = 'center';
        ctx.fillText('Nessun dato sulla forza', width / 2, height / 2);
        return;
    }

    // Include goals in scaling
    const goals = data.strength_goals || {};
    if (goals.upper) allValues.push(goals.upper);
    if (goals.lower) allValues.push(goals.lower);
    if (goals.cardio) allValues.push(goals.cardio);

    const minStrength = Math.min(...allValues) - 5;
    const maxStrength = Math.max(...allValues) + 5;
    const strengthRange = maxStrength - minStrength || 1;

    // Draw grid
    ctx.strokeStyle = 'rgba(255,255,255,0.05)';
    ctx.lineWidth = 1;
    for (let i = 0; i <= 4; i++) {
        const y = padding.top + (chartHeight * i / 4);
        ctx.beginPath();
        ctx.moveTo(padding.left, y);
        ctx.lineTo(width - padding.right, y);
        ctx.stroke();
    }

    // Draw goal lines
    const goalConfig = {
        upper_body: { goal: goals.upper, color: colors.upper_body },
        lower_body: { goal: goals.lower, color: colors.lower_body },
        cardio: { goal: goals.cardio, color: colors.cardio }
    };

    Object.entries(goalConfig).forEach(([key, config]) => {
        if (config.goal !== null && config.goal !== undefined) {
            const goalY = padding.top + chartHeight - ((config.goal - minStrength) / strengthRange * chartHeight);
            if (goalY >= padding.top && goalY <= padding.top + chartHeight) {
                ctx.save();
                ctx.strokeStyle = config.color;
                ctx.lineWidth = 1.5;
                ctx.setLineDash([4, 3]);
                ctx.globalAlpha = 0.6;
                ctx.beginPath();
                ctx.moveTo(padding.left, goalY);
                ctx.lineTo(width - padding.right, goalY);
                ctx.stroke();
                ctx.restore();
            }
        }
    });

    // Draw data lines
    categories.forEach(cat => {
        const catData = strengthData.categories[cat]?.data || [];
        if (catData.length === 0) return;

        const color = colors[cat];
        const points = catData.map((d, i) => ({
            x: padding.left + (chartWidth * i / (catData.length - 1 || 1)),
            y: d.strength !== null ? padding.top + chartHeight - ((d.strength - minStrength) / strengthRange * chartHeight) : null
        })).filter(p => p.y !== null);

        if (points.length < 2) return;

        // Draw line
        ctx.beginPath();
        ctx.moveTo(points[0].x, points[0].y);
        points.forEach(p => ctx.lineTo(p.x, p.y));
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.setLineDash([]);
        ctx.stroke();

        // Draw last point
        const lastPoint = points[points.length - 1];
        ctx.beginPath();
        ctx.arc(lastPoint.x, lastPoint.y, 3, 0, Math.PI * 2);
        ctx.fillStyle = color;
        ctx.fill();
    });

    // Draw Y-axis labels
    ctx.fillStyle = '#9ca3af';
    ctx.font = '9px system-ui';
    ctx.textAlign = 'right';
    for (let i = 0; i <= 4; i++) {
        const val = Math.round(maxStrength - (strengthRange * i / 4));
        const y = padding.top + (chartHeight * i / 4);
        ctx.fillText(`${val}%`, padding.left - 4, y + 3);
    }
}

function renderFriendStrengthStats(data) {
    const strengthData = data.strength_by_category;
    const goals = data.strength_goals || {};

    // Update stats
    const categories = {
        upper: { el: 'friend-strength-upper', goalEl: 'friend-goal-upper', catKey: 'upper_body' },
        lower: { el: 'friend-strength-lower', goalEl: 'friend-goal-lower', catKey: 'lower_body' },
        cardio: { el: 'friend-strength-cardio', goalEl: 'friend-goal-cardio', catKey: 'cardio' }
    };

    Object.entries(categories).forEach(([key, config]) => {
        const statEl = document.getElementById(config.el);
        const goalEl = document.getElementById(config.goalEl);

        // Get current strength value
        let currentVal = null;
        if (strengthData?.categories?.[config.catKey]?.data) {
            const catData = strengthData.categories[config.catKey].data;
            const lastPoint = catData.filter(d => d.strength !== null).pop();
            if (lastPoint) currentVal = lastPoint.strength;
        }

        if (statEl) {
            if (currentVal !== null) {
                const prefix = currentVal >= 0 ? '+' : '';
                statEl.textContent = `${prefix}${Math.round(currentVal)}%`;
            } else {
                statEl.textContent = '--%';
            }
        }

        if (goalEl) {
            const goalVal = goals[key];
            if (goalVal !== null && goalVal !== undefined) {
                goalEl.textContent = `Obiettivo: +${goalVal}%`;
                goalEl.className = 'text-[9px] text-purple-400';
            } else {
                goalEl.textContent = 'Nessun obiettivo';
                goalEl.className = 'text-[9px] text-gray-500';
            }
        }
    });
}

function renderFriendWeightChart(data) {
    const weightChart = document.getElementById('friend-weight-chart');
    if (!weightChart) return;

    if (data.weight_history && data.weight_history.length > 0) {
        const weights = data.weight_history.map(w => w.weight);
        const maxW = Math.max(...weights);
        const minW = Math.min(...weights);
        const range = maxW - minW || 1;

        const recent = data.weight_history.slice(-10);
        weightChart.innerHTML = recent.map(entry => {
            const height = ((entry.weight - minW) / range) * 100;
            return `<div class="flex-1 bg-purple-500/50 rounded-t transition-all duration-300" style="height: ${Math.max(20, height)}%" title="${entry.weight}kg"></div>`;
        }).join('');

        // Update weight labels
        const startEl = document.getElementById('friend-weight-start');
        const currentEl = document.getElementById('friend-weight-current');
        if (startEl) startEl.textContent = `${recent[0].weight}kg`;
        if (currentEl) currentEl.textContent = `Attuale: ${data.current_weight || recent[recent.length - 1].weight}kg`;
    } else {
        weightChart.innerHTML = '<p class="text-xs text-gray-500 w-full text-center">Nessun dato sul peso</p>';
    }
}

function renderFriendHealthBars(data) {
    const healthBars = document.getElementById('friend-health-bars');
    if (!healthBars) return;

    if (data.weekly_health_scores && data.weekly_health_scores.length > 0) {
        let totalScore = 0;
        healthBars.innerHTML = data.weekly_health_scores.map(entry => {
            const score = entry.score || 0;
            totalScore += score;
            const color = score >= 80 ? 'bg-green-500' : score >= 60 ? 'bg-yellow-500' : 'bg-red-500';
            return `<div class="flex-1 ${color}/70 rounded-t transition-all duration-300" style="height: ${score}%" title="${score}%"></div>`;
        }).join('');

        const avgEl = document.getElementById('friend-health-avg');
        if (avgEl) {
            const avg = Math.round(totalScore / data.weekly_health_scores.length);
            avgEl.textContent = `Media: ${avg}%`;
        }
    } else {
        healthBars.innerHTML = '<p class="text-xs text-gray-500 w-full text-center">Nessun dato sulla salute</p>';
    }
}

async function messageFromFriendsList(userId, username) {
    closeFriendsModal();
    if (typeof openChatModal === 'function') {
        openChatModal(userId, username);
    } else if (typeof openConversationsModal === 'function') {
        openConversationsModal();
    } else {
        showToast('Messaggistica non disponibile', 'error');
    }
}

// --- MEMBER PROFILE FUNCTIONS ---

let currentProfileMember = null;

async function openMemberProfile(memberId) {
    try {
        const response = await fetch(`/api/client/member/${memberId}`, { credentials: 'include' });
        if (!response.ok) throw new Error('Failed to load profile');

        const member = await response.json();
        currentProfileMember = member;

        // Update modal content
        document.getElementById('member-profile-name').textContent = member.name || member.username;
        document.getElementById('member-profile-bio').textContent = member.bio || '';
        document.getElementById('member-profile-streak').textContent = member.streak || 0;
        document.getElementById('member-profile-gems').textContent = member.gems || 0;
        document.getElementById('member-profile-health').textContent = member.health_score || 0;

        // Update avatar
        const avatarEl = document.getElementById('member-profile-avatar');
        if (member.profile_picture) {
            avatarEl.innerHTML = `<img src="${member.profile_picture}" class="w-full h-full object-cover">`;
        } else {
            avatarEl.innerHTML = '<i data-lucide="user" class="w-6 h-6"></i>';
        }

        // Update progress chart based on member's health score
        updateMemberProgressChart(member.health_score || 0, member.streak || 0);

        // Update friend action button based on friendship status
        const friendshipStatus = member.friendship_status || 'none';
        updateFriendActionButton(friendshipStatus);

        // Show/hide friend progress section
        console.log('[MemberProfile] is_friend:', member.is_friend, 'friendship_status:', member.friendship_status);
        const progressSection = document.getElementById('friend-progress-section');
        if (member.is_friend) {
            console.log('[MemberProfile] Loading friend progress...');
            loadFriendProgress(memberId);
        } else {
            console.log('[MemberProfile] Not friends, hiding progress section');
            progressSection?.classList.add('hidden');
        }

        // Show modal
        document.getElementById('member-profile-modal').classList.remove('hidden');

    } catch (error) {
        console.error('Error loading member profile:', error);
        showToast('Impossibile caricare il profilo', 'error');
    }
}

function closeMemberProfileModal() {
    document.getElementById('member-profile-modal').classList.add('hidden');
    document.getElementById('friend-progress-section')?.classList.add('hidden');
    currentProfileMember = null;
}

function updateMemberProgressChart(healthScore, streak) {
    const chartEl = document.getElementById('member-progress-chart');
    if (!chartEl) return;

    const days = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
    const today = new Date().getDay(); // 0=Sunday, 1=Monday, etc
    const todayIndex = today === 0 ? 6 : today - 1; // Convert to 0=Monday

    // Determine active days based on streak
    const activeDays = Math.min(streak, 7);

    let html = '';
    days.forEach((day, index) => {
        const isPast = index <= todayIndex;
        const isToday = index === todayIndex;

        // Active if within streak and not future
        const isActive = isPast && (todayIndex - index) < activeDays;

        const bgClass = isActive ? 'bg-orange-500' : 'bg-orange-500/20';
        const borderClass = isActive ? 'border-orange-400' : 'border-orange-500/30';
        const textClass = isActive ? 'text-white font-bold' : (isToday ? 'text-orange-400' : 'text-gray-500');

        html += `
            <div class="flex-1 flex flex-col items-center gap-1">
                <div class="w-8 h-8 rounded-full ${bgClass} border ${borderClass} flex items-center justify-center transition-all">
                    <span class="text-xs ${textClass}">${day}</span>
                </div>
            </div>
        `;
    });

    chartEl.innerHTML = html;
}

async function messageFromProfile() {
    if (!currentProfileMember) return;

    const userId = currentProfileMember.id;
    const username = currentProfileMember.name || currentProfileMember.username;
    const profilePicture = currentProfileMember.profile_picture;

    try {
        // Check if we can message this user
        const response = await fetch(`/api/client/can-message/${userId}`, { credentials: 'include' });
        if (!response.ok) throw new Error('Failed to check messaging status');

        const result = await response.json();

        if (result.can_message) {
            // Can message directly - open chat
            closeMemberProfileModal();
            closeGymMembersModal();
            if (typeof openChatModal === 'function') {
                openChatModal(userId, username);
            } else if (typeof window.openChatWithUser === 'function') {
                window.openChatWithUser(userId, username, profilePicture);
            } else {
                showToast('Messaggistica non disponibile', 'error');
            }
        } else if (result.reason === 'staff_only') {
            showToast('This user only accepts messages from gym staff', 'info');
        } else if (result.reason === 'request_pending') {
            showToast('La tua richiesta di chat Ã¨ ancora in sospeso', 'info');
        } else if (result.needs_request) {
            // Need to send chat request - show modal
            closeMemberProfileModal();
            openChatRequestModal(userId, username, profilePicture);
        } else {
            showToast('Impossibile inviare un messaggio a questo utente', 'error');
        }
    } catch (error) {
        console.error('Error initiating chat:', error);
        showToast('Impossibile avviare la chat', 'error');
    }
}

// Load gym members preview on page load
loadGymMembersPreview();

// Load friends preview on page load
loadFriendsPreview();
</script>

{% endif %}

<!-- Physique Photo Upload Modal (shared across modes) -->
<div id="physique-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Aggiungi Foto Progressi</h3>
            <button onclick="closePhysiqueModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>

        <form id="physique-form" class="space-y-4">
            <!-- Photo Preview -->
            <div id="physique-preview-container" class="hidden">
                <img id="physique-preview" class="w-full h-48 object-cover rounded-xl border border-white/10 mb-2">
                <button type="button" onclick="clearPhysiquePhoto()" class="text-xs text-red-400 hover:text-red-300">Rimuovi foto</button>
            </div>

            <!-- Upload Button -->
            <div id="physique-upload-area" class="border-2 border-dashed border-white/20 rounded-xl p-8 text-center cursor-pointer hover:border-primary/50 transition"
                onclick="document.getElementById('physique-file-input').click()">
                <i data-lucide="camera" class="w-10 h-10 mb-2 block"></i>
                <p class="text-sm text-gray-400">Tocca per selezionare una foto</p>
                <p class="text-xs text-gray-500 mt-1">JPG, PNG, WEBP (max 10MB)</p>
            </div>
            <input type="file" id="physique-file-input" accept="image/*" class="hidden" onchange="previewPhysiquePhoto(this)">

            <!-- Pose Tags -->
            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Tag Posa</label>
                <div class="flex flex-wrap gap-2" id="physique-tags">
                    <button type="button" onclick="selectPhysiqueTag(this, 'Front')" class="physique-tag px-3 py-1.5 rounded-full text-xs font-medium bg-white/10 border border-white/20 hover:bg-white/20 transition">Frontale</button>
                    <button type="button" onclick="selectPhysiqueTag(this, 'Back')" class="physique-tag px-3 py-1.5 rounded-full text-xs font-medium bg-white/10 border border-white/20 hover:bg-white/20 transition">Posteriore</button>
                    <button type="button" onclick="selectPhysiqueTag(this, 'Side L')" class="physique-tag px-3 py-1.5 rounded-full text-xs font-medium bg-white/10 border border-white/20 hover:bg-white/20 transition">Lato S</button>
                    <button type="button" onclick="selectPhysiqueTag(this, 'Side R')" class="physique-tag px-3 py-1.5 rounded-full text-xs font-medium bg-white/10 border border-white/20 hover:bg-white/20 transition">Lato D</button>
                    <button type="button" onclick="selectPhysiqueTag(this, 'Flexed')" class="physique-tag px-3 py-1.5 rounded-full text-xs font-medium bg-white/10 border border-white/20 hover:bg-white/20 transition">In Posa</button>
                    <button type="button" onclick="selectPhysiqueTag(this, 'Relaxed')" class="physique-tag px-3 py-1.5 rounded-full text-xs font-medium bg-white/10 border border-white/20 hover:bg-white/20 transition">Rilassato</button>
                </div>
            </div>

            <!-- Title -->
            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Titolo (opzionale)</label>
                <input type="text" id="physique-title" placeholder="es. Progressi Settimana 4"
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-3 text-sm text-white outline-none focus:border-primary/50 transition">
            </div>

            <!-- Date -->
            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Data Foto</label>
                <input type="date" id="physique-date"
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-3 text-sm text-white outline-none focus:border-primary/50 transition">
            </div>

            <!-- Notes -->
            <div>
                <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">Note (opzionale)</label>
                <textarea id="physique-notes" rows="2" placeholder="Note su questa foto..."
                    class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-3 text-sm text-white outline-none focus:border-primary/50 transition resize-none"></textarea>
            </div>

            <!-- Submit -->
            <button type="submit" id="physique-submit-btn"
                class="w-full bg-primary text-white py-3 rounded-xl font-bold hover:bg-primary/80 transition disabled:opacity-50 disabled:cursor-not-allowed">
                Carica Foto
            </button>
        </form>
    </div>
</div>

<!-- Physique Comparison Modal (Carousel, shared across modes) -->
<div id="compare-modal" class="fixed inset-0 bg-black/70 backdrop-blur-xl z-50 hidden flex flex-col">
    <div class="p-4 flex justify-between items-center border-b border-white/10 bg-white/5">
        <h3 class="text-lg font-bold">Confronta Progressi</h3>
        <div class="flex items-center gap-2">
            <button id="animation-toggle-btn" onclick="toggleCarouselAnimations()" title="Animations On"
                class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/20 transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </button>
            <button onclick="closeCompareModal()" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/20 transition">&times;</button>
        </div>
    </div>
    <div class="flex-1 flex flex-col p-4 overflow-hidden min-h-0">
        <div class="flex-1 relative flex items-center justify-center min-h-[200px]">
            <button id="carousel-prev" onclick="carouselPrev()"
                class="absolute left-2 z-10 w-10 h-10 rounded-full bg-white/10 backdrop-blur-sm border border-white/20 flex items-center justify-center text-white hover:bg-white/20 transition tap-effect disabled:opacity-30 disabled:cursor-not-allowed">
                â†
            </button>
            <div id="carousel-photo-container" class="flex-1 h-full mx-14 bg-white/10 backdrop-blur-sm rounded-2xl border border-white/20 flex items-center justify-center overflow-hidden relative transition-all duration-300">
                <p class="text-gray-400 text-sm" id="carousel-placeholder">Seleziona le foto qui sotto per confrontare</p>
                <img id="carousel-img" class="hidden w-full h-full object-contain">
            </div>
            <button id="carousel-next" onclick="carouselNext()"
                class="absolute right-2 z-10 w-10 h-10 rounded-full bg-white/10 backdrop-blur-sm border border-white/20 flex items-center justify-center text-white hover:bg-white/20 transition tap-effect disabled:opacity-30 disabled:cursor-not-allowed">
                â†’
            </button>
        </div>
        <p id="carousel-label" class="text-center text-sm text-white mt-3 h-6 font-medium"></p>
        <p id="carousel-date" class="text-center text-xs text-gray-400 h-5"></p>
        <div id="carousel-dots" class="flex justify-center gap-2 mt-3 flex-wrap max-w-full px-4"></div>
    </div>
    <div id="photo-selector-panel" class="border-t border-white/10 bg-white/5 flex-shrink-0 overflow-hidden transition-all duration-300 ease-in-out" style="max-height: 260px;">
        <div onclick="togglePhotoSelector()" class="cursor-pointer py-3 flex justify-center hover:bg-white/5 transition">
            <div id="selector-toggle-icon" class="w-10 h-1 bg-white/30 rounded-full transition-all duration-300 hover:bg-white/50"></div>
        </div>
        <div class="px-4 pb-4 pt-3">
            <div class="flex gap-2 mb-3 flex-wrap">
                <input type="text" id="compare-search" placeholder="Cerca per titolo..."
                    oninput="filterComparePhotos()"
                    class="flex-1 min-w-[120px] bg-white/10 border border-white/20 rounded-xl px-3 py-2 text-xs text-white placeholder-gray-500 outline-none focus:border-primary/50 transition">
                <select id="compare-date-filter" onchange="filterComparePhotos()"
                    class="bg-white/10 border border-white/20 rounded-xl px-3 py-2 text-xs text-white outline-none focus:border-primary/50 transition">
                    <option value="all">Tutte le date</option>
                    <option value="week">Questa settimana</option>
                    <option value="month">Questo mese</option>
                    <option value="3months">Ultimi 3 mesi</option>
                    <option value="year">Quest'anno</option>
                </select>
                <select id="compare-pose-filter" onchange="filterComparePhotos()"
                    class="bg-white/10 border border-white/20 rounded-xl px-3 py-2 text-xs text-white outline-none focus:border-primary/50 transition">
                    <option value="all">Tutte le pose</option>
                    <option value="Front">Frontale</option>
                    <option value="Back">Posteriore</option>
                    <option value="Side">Laterale</option>
                    <option value="Flexed">In Posa</option>
                    <option value="Relaxed">Rilassato</option>
                </select>
            </div>
            <p class="text-xs text-gray-400 mb-2">Tocca le foto per aggiungere/rimuovere: <span id="compare-photo-count" class="text-white/60"></span></p>
            <div id="compare-photo-list" class="flex gap-2 overflow-x-auto pb-2"></div>
        </div>
    </div>
</div>

<!-- Shared Booking Choice Modal (available for all modes) -->
<div id="booking-choice-modal-shared" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeBookingChoiceModal()">
    <div class="glass-card p-6 rounded-2xl max-w-sm w-full">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Book a Session</h3>
            <button onclick="closeBookingChoiceModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>
        <p class="text-gray-400 text-sm mb-6">Che tipo di sessione vuoi prenotare?</p>

        <div class="space-y-3">
            <!-- 1-on-1 Session Option -->
            <button id="booking-choice-personal-btn-shared" onclick="selectBookingType('personal')" class="w-full bg-gradient-to-r from-orange-500 to-red-500 p-4 rounded-xl text-left hover:scale-[1.02] transition tap-effect">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                        <i data-lucide="user" class="w-6 h-6 stroke-current"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-white">Sessione 1-a-1</h4>
                        <p class="text-sm text-white/70">Allenamento personale su misura per te</p>
                    </div>
                </div>
            </button>

            <!-- Nutritionist Consultation Option -->
            <button id="booking-choice-nutritionist-btn-shared" onclick="selectBookingType('nutritionist')" class="w-full bg-gradient-to-r from-cyan-500 to-blue-500 p-4 rounded-xl text-left hover:scale-[1.02] transition tap-effect">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                        <i data-lucide="apple" class="w-6 h-6 stroke-current"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-white">Nutritionist Consultation</h4>
                        <p class="text-sm text-white/70">Diet & nutrition guidance</p>
                    </div>
                </div>
            </button>

            <!-- Group Course Option -->
            <button onclick="selectBookingType('course')" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 p-4 rounded-xl text-left hover:scale-[1.02] transition tap-effect">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                        <i data-lucide="users" class="w-6 h-6 stroke-current"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-white">Corso di Gruppo</h4>
                        <p class="text-sm text-white/70">Partecipa a un corso fitness programmato</p>
                    </div>
                </div>
            </button>

            <!-- Book Facility Option -->
            <button onclick="selectBookingType('facility')" class="w-full bg-gradient-to-r from-green-500 to-teal-500 p-4 rounded-xl text-left hover:scale-[1.02] transition tap-effect">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                        <i data-lucide="map-pin" class="w-6 h-6 stroke-current"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-white">Prenota Struttura</h4>
                        <p class="text-sm text-white/70">Campi, sale, spazi e altro</p>
                    </div>
                </div>
            </button>
        </div>
    </div>
</div>

<!-- Shared Gym Courses Modal -->
<div id="gym-courses-modal-shared" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4"
    onclick="if(event.target === this) closeGymCoursesModal()">
    <div class="glass-card p-6 rounded-2xl max-w-md w-full max-h-[85vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Corsi di Gruppo</h3>
            <button onclick="closeGymCoursesModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
        </div>
        <p class="text-gray-400 text-sm mb-4">Browse all available courses at your gym</p>

        <div id="gym-courses-list-shared" class="space-y-3">
            <div class="text-center py-8 text-gray-400">
                <div class="animate-pulse">Caricamento corsi...</div>
            </div>
        </div>
    </div>
</div>

<script>
// Shared Booking Choice Functions (available for all modes)
// Only declare if not already defined by mode-specific scripts
if (typeof bookingChoiceTrainerId === 'undefined') {
    var bookingChoiceTrainerId = null;
}
if (typeof bookingChoiceTrainerName === 'undefined') {
    var bookingChoiceTrainerName = null;
}

// Ensure selectedTrainerId is defined globally
if (typeof selectedTrainerId === 'undefined') {
    var selectedTrainerId = null;

    // Fetch trainer ID if not already loaded
    (async function() {
        try {
            const response = await fetch('/api/client/data', {
                credentials: 'include'
            });
            if (response.ok) {
                const data = await response.json();
                if (data.has_trainer && data.trainer_id) {
                    selectedTrainerId = data.trainer_id;
                }
            }
        } catch (e) {
            console.log('Could not fetch trainer info for booking');
        }
    })();
}

// Only define functions if not already defined by mode-specific scripts
if (typeof openBookingChoiceModal !== 'function') {
    window.openBookingChoiceModal = function(trainerId, trainerName, nutritionistId, nutritionistName) {
        bookingChoiceTrainerId = trainerId;
        bookingChoiceTrainerName = trainerName;
        window._bookingNutritionistId = nutritionistId || window._bookingNutritionistId;
        window._bookingNutritionistName = nutritionistName || window._bookingNutritionistName;

        // Try both modal IDs (mode-specific and shared)
        const modal = document.getElementById('booking-choice-modal') || document.getElementById('booking-choice-modal-shared');
        const nameEl = document.getElementById('booking-choice-trainer-name') || document.getElementById('booking-choice-trainer-name-shared');

        if (nameEl) nameEl.textContent = trainerName || 'your trainer';
        // Hide 1-on-1 option if no trainer assigned
        const personalBtn = document.getElementById('booking-choice-personal-btn') || document.getElementById('booking-choice-personal-btn-shared');
        if (personalBtn) personalBtn.style.display = trainerId ? '' : 'none';
        // Hide nutritionist option if no nutritionist assigned
        const nutriBtn = document.getElementById('booking-choice-nutritionist-btn') || document.getElementById('booking-choice-nutritionist-btn-shared');
        if (nutriBtn) nutriBtn.style.display = window._bookingNutritionistId ? '' : 'none';
        if (modal) modal.classList.remove('hidden');
    };
}

if (typeof openBookingChoiceForMyTrainer !== 'function') {
    window.openBookingChoiceForMyTrainer = async function() {
        // Try to get trainer info if not already loaded
        let trainerName = document.getElementById('trainer-name')?.textContent || 'Trainer';
        let trainerId = selectedTrainerId;

        // If no trainer ID, try to fetch it
        if (!trainerId) {
            try {
                const response = await fetch('/api/client/data', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    if (data.has_trainer && data.trainer_id) {
                        trainerId = data.trainer_id;
                        selectedTrainerId = trainerId;
                        if (data.trainer_name) trainerName = data.trainer_name;
                    }
                }
            } catch (e) {
                console.log('Could not fetch trainer info');
            }
        }

        // Always show the choice modal (even without trainer, user can still book courses)
        openBookingChoiceModal(trainerId, trainerName);
    };
}

if (typeof closeBookingChoiceModal !== 'function') {
    window.closeBookingChoiceModal = function() {
        const modal = document.getElementById('booking-choice-modal') || document.getElementById('booking-choice-modal-shared');
        if (modal) modal.classList.add('hidden');
        bookingChoiceTrainerId = null;
        bookingChoiceTrainerName = null;
    };
}

if (typeof selectBookingType !== 'function') {
    window.selectBookingType = function(type) {
        // Save IDs BEFORE closing modal (closeBookingChoiceModal nullifies them)
        const savedTrainerId = bookingChoiceTrainerId;
        const savedNutritionistId = window._bookingNutritionistId;
        closeBookingChoiceModal();

        if (type === 'personal') {
            if (typeof selectedTrainerId !== 'undefined') {
                selectedTrainerId = savedTrainerId;
            }
            if (typeof openBookingModal === 'function') {
                openBookingModal();
            }
        } else if (type === 'nutritionist') {
            if (savedNutritionistId) {
                if (typeof selectedTrainerId !== 'undefined') {
                    selectedTrainerId = savedNutritionistId;
                }
                if (typeof openBookingModal === 'function') {
                    openBookingModal();
                }
            } else {
                if (typeof showToast === 'function') showToast('No nutritionist assigned yet', 'error');
            }
        } else if (type === 'course') {
            if (typeof openGymCoursesModal === 'function') {
                openGymCoursesModal();
            } else if (typeof openGymCoursesModalShared === 'function') {
                openGymCoursesModalShared();
            }
        } else if (type === 'facility') {
            if (typeof openFacilityBookingModal === 'function') {
                openFacilityBookingModal();
            }
        }
    };
}

if (typeof openGymCoursesModalShared !== 'function') {
    window.openGymCoursesModalShared = async function() {
    const modal = document.getElementById('gym-courses-modal') || document.getElementById('gym-courses-modal-shared');
    if (modal) modal.classList.remove('hidden');

    const listEl = document.getElementById('gym-courses-list') || document.getElementById('gym-courses-list-shared');
    if (listEl) {
        listEl.innerHTML = '<div class="text-center py-8 text-gray-400"><div class="animate-pulse">Loading courses...</div></div>';
    }

    try {
        const response = await fetch('/api/client/gym/courses', {
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error('Impossibile caricare i corsi');
        }

        const courses = await response.json();

        if (courses.length === 0) {
            listEl.innerHTML = `
                <div class="text-center py-8 text-gray-400">
                    <p class="mb-2">${icon('mail', 40)}</p>
                    <p>No courses available at your gym yet</p>
                </div>
            `;
            return;
        }

        listEl.innerHTML = courses.map(course => `
            <div class="bg-white/5 border border-white/10 rounded-xl p-4 hover:bg-white/10 transition cursor-pointer tap-effect"
                onclick="viewCourseDetail('${course.id}')">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center text-xl">
                        ${icon(getCategoryIconName(course.course_type || 'strength'), 20)}
                    </div>
                    <div class="flex-1">
                        <h4 class="font-bold text-white">${course.name}</h4>
                        <p class="text-xs text-gray-400">${course.schedule || 'Schedule TBD'}</p>
                    </div>
                    <span class="text-orange-400 text-sm font-bold">${course.spots_left || '?'} spots</span>
                </div>
            </div>
        `).join('');

    } catch (error) {
        console.error('Error loading courses:', error);
        listEl.innerHTML = `
            <div class="text-center py-8 text-red-400">
                <p>Impossibile caricare i corsi</p>
            </div>
        `;
    }
    };
}

if (typeof closeGymCoursesModal !== 'function') {
    window.closeGymCoursesModal = function() {
        const modal = document.getElementById('gym-courses-modal') || document.getElementById('gym-courses-modal-shared');
        if (modal) modal.classList.add('hidden');
    };
}
// ==================== FACILITY BOOKING ====================

let facilityBookingState = { activityTypeId: null, facilityId: null, facilityName: '', date: null };

window.openFacilityBookingModal = async function() {
    const modal = document.getElementById('facility-booking-modal');
    if (!modal) return;

    // Reset state
    facilityBookingState = { activityTypeId: null, facilityId: null, facilityName: '', date: null };

    // Show step 1, hide others
    document.getElementById('fb-step-activities').classList.remove('hidden');
    document.getElementById('fb-step-facilities').classList.add('hidden');
    document.getElementById('fb-step-slots').classList.add('hidden');
    document.getElementById('fb-modal-title').innerText = 'Book Facility';

    modal.classList.remove('hidden');

    // Load activity types
    const container = document.getElementById('fb-activity-types');
    container.innerHTML = '<div class="text-center text-gray-500 py-4 text-sm">Loading...</div>';

    try {
        const res = await fetch('/api/client/facility/activity-types', { credentials: 'include' });
        const types = await res.json();
        if (!types.length) {
            container.innerHTML = '<div class="text-center text-gray-500 py-4 text-sm">No activities available at your gym</div>';
            return;
        }
        container.innerHTML = types.map(t => `
            <button onclick="fbSelectActivity('${t.id}', '${t.name.replace(/'/g, "\\'")}')"
                class="glass-card p-4 rounded-xl text-center hover:bg-white/10 transition tap-effect">
                <div class="text-2xl mb-1">${t.emoji || 'ðŸŸï¸'}</div>
                <p class="font-bold text-white text-sm">${t.name}</p>
                <p class="text-xs text-gray-400">${t.facility_count || 0} available</p>
            </button>
        `).join('');
    } catch (e) {
        container.innerHTML = '<div class="text-center text-red-400 py-4 text-sm">Failed to load</div>';
    }

    if (typeof lucide !== 'undefined') lucide.createIcons();
};

window.fbSelectActivity = async function(typeId, typeName) {
    facilityBookingState.activityTypeId = typeId;
    document.getElementById('fb-step-activities').classList.add('hidden');
    document.getElementById('fb-step-facilities').classList.remove('hidden');
    document.getElementById('fb-modal-title').innerText = typeName;

    const container = document.getElementById('fb-facilities-list');
    container.innerHTML = '<div class="text-center text-gray-500 py-4 text-sm">Loading...</div>';

    try {
        const res = await fetch(`/api/client/facility/facilities/${typeId}`, { credentials: 'include' });
        const facilities = await res.json();
        if (!facilities.length) {
            container.innerHTML = '<div class="text-center text-gray-500 py-4 text-sm">No facilities available</div>';
            return;
        }
        container.innerHTML = facilities.map(f => `
            <button onclick="fbSelectFacility('${f.id}', '${f.name.replace(/'/g, "\\'")}')"
                class="glass-card p-4 rounded-xl text-left hover:bg-white/10 transition tap-effect w-full">
                <p class="font-bold text-white">${f.name}</p>
                <p class="text-xs text-gray-400">${f.slot_duration}min slots${f.price_per_slot ? ' Â· â‚¬' + f.price_per_slot : ' Â· Free'}</p>
            </button>
        `).join('');
    } catch (e) {
        container.innerHTML = '<div class="text-center text-red-400 py-4 text-sm">Failed to load</div>';
    }
};

window.fbSelectFacility = async function(facilityId, facilityName) {
    facilityBookingState.facilityId = facilityId;
    facilityBookingState.facilityName = facilityName;
    facilityBookingState.availableDays = []; // days of week with availability (0=Mon..6=Sun)
    facilityBookingState.selectedDate = null;

    document.getElementById('fb-step-facilities').classList.add('hidden');
    document.getElementById('fb-step-slots').classList.remove('hidden');
    document.getElementById('fb-modal-title').innerText = facilityName;
    document.getElementById('fb-slots-container').innerHTML = '<div class="text-center text-gray-500 py-4 text-sm">Select a date to see available slots</div>';

    // Fetch availability days (which days of week have availability)
    try {
        const res = await fetch(`/api/client/facility/${facilityId}/availability`, { credentials: 'include' });
        const avail = await res.json();
        // Convert to JS day-of-week (0=Sun, 1=Mon..6=Sat) from Python (0=Mon..6=Sun)
        facilityBookingState.availableDays = avail.map(a => (a.day_of_week + 1) % 7);
    } catch (e) { console.error('Failed to load availability days:', e); }

    // Init calendar to current month
    const now = new Date();
    facilityBookingState.calYear = now.getFullYear();
    facilityBookingState.calMonth = now.getMonth();
    fbRenderCalendar();
};

window.fbRenderCalendar = function() {
    const cal = document.getElementById('fb-calendar');
    if (!cal) return;

    const year = facilityBookingState.calYear;
    const month = facilityBookingState.calMonth;
    const availDays = facilityBookingState.availableDays || [];
    const selectedDate = facilityBookingState.selectedDate || '';
    const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];

    const today = new Date();
    today.setHours(0,0,0,0);
    const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const canGoPrev = year > today.getFullYear() || (year === today.getFullYear() && month > today.getMonth());

    let html = `<div class="flex items-center justify-between mb-3">
        <button onclick="fbChangeMonth(-1)" class="w-8 h-8 rounded-lg ${canGoPrev ? 'hover:bg-white/10 text-white' : 'text-gray-600 cursor-not-allowed'} flex items-center justify-center transition" ${canGoPrev ? '' : 'disabled'}>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
        </button>
        <span class="text-sm font-bold text-white">${monthNames[month]} ${year}</span>
        <button onclick="fbChangeMonth(1)" class="w-8 h-8 rounded-lg hover:bg-white/10 text-white flex items-center justify-center transition">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        </button>
    </div>`;

    // Weekday headers
    html += '<div class="grid grid-cols-7 gap-1 mb-1">';
    ['Su','Mo','Tu','We','Th','Fr','Sa'].forEach(d => {
        html += `<div class="text-center text-[10px] text-gray-500 font-medium py-1">${d}</div>`;
    });
    html += '</div>';

    // Day cells
    html += '<div class="grid grid-cols-7 gap-1">';
    for (let i = 0; i < firstDay; i++) {
        html += '<div></div>';
    }
    for (let d = 1; d <= daysInMonth; d++) {
        const date = new Date(year, month, d);
        const jsDow = date.getDay(); // 0=Sun..6=Sat
        const mm = String(month + 1).padStart(2, '0');
        const dd = String(d).padStart(2, '0');
        const dateStr = `${year}-${mm}-${dd}`;
        const isPast = date < today;
        const isToday = dateStr === todayStr;
        const isSelected = dateStr === selectedDate;
        const hasAvailability = availDays.includes(jsDow) && !isPast;

        let cls = 'w-full aspect-square rounded-lg text-xs font-medium flex flex-col items-center justify-center transition relative';
        if (isPast) {
            cls += ' text-gray-600 cursor-not-allowed';
        } else if (isSelected) {
            cls += ' bg-primary text-white cursor-pointer';
        } else if (isToday) {
            cls += ' border border-primary/50 text-primary hover:bg-primary/20 cursor-pointer';
        } else if (hasAvailability) {
            cls += ' text-white hover:bg-white/10 cursor-pointer';
        } else {
            cls += ' text-gray-500 cursor-pointer hover:bg-white/5';
        }

        if (isPast) {
            html += `<div class="${cls}"><span>${d}</span></div>`;
        } else {
            html += `<button onclick="fbSelectDate('${dateStr}')" class="${cls}">
                <span>${d}</span>
                ${hasAvailability ? '<span class="w-1.5 h-1.5 rounded-full bg-green-400 mt-0.5"></span>' : ''}
            </button>`;
        }
    }
    html += '</div>';

    cal.innerHTML = html;
};

window.fbChangeMonth = function(dir) {
    facilityBookingState.calMonth += dir;
    if (facilityBookingState.calMonth > 11) {
        facilityBookingState.calMonth = 0;
        facilityBookingState.calYear++;
    } else if (facilityBookingState.calMonth < 0) {
        facilityBookingState.calMonth = 11;
        facilityBookingState.calYear--;
    }
    fbRenderCalendar();
};

window.fbSelectDate = async function(dateStr) {
    facilityBookingState.selectedDate = dateStr;
    facilityBookingState.date = dateStr;
    fbRenderCalendar(); // re-render to highlight selected

    const container = document.getElementById('fb-slots-container');
    container.innerHTML = '<div class="text-center py-4"><div class="inline-block w-5 h-5 border-2 border-primary border-t-transparent rounded-full animate-spin"></div><p class="text-gray-500 text-sm mt-2">Loading slots...</p></div>';

    try {
        const res = await fetch(`/api/client/facility/${facilityBookingState.facilityId}/available-slots?date=${dateStr}`, { credentials: 'include' });
        const slots = await res.json();
        if (!slots.length) {
            container.innerHTML = '<div class="text-center text-gray-500 py-4 text-sm">No available slots on this date</div>';
            return;
        }
        const dateObj = new Date(dateStr + 'T00:00:00');
        const dayLabel = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
        container.innerHTML = `
            <p class="text-xs text-gray-400 mb-2 font-semibold uppercase tracking-wider">${dayLabel} â€” ${slots.length} slot${slots.length > 1 ? 's' : ''}</p>
            <div class="grid grid-cols-3 gap-2">${slots.map(s => `
                <button onclick="fbBookSlot('${s.start_time}')"
                    class="bg-white/10 hover:bg-primary/30 text-white text-sm font-medium py-3 rounded-xl transition tap-effect">
                    ${s.start_time}
                </button>
            `).join('')}</div>`;
    } catch (e) {
        container.innerHTML = '<div class="text-center text-red-400 py-4 text-sm">Failed to load slots</div>';
    }
};

window.fbBookSlot = async function(startTime) {
    if (!confirm(`Book ${facilityBookingState.facilityName} on ${facilityBookingState.date} at ${startTime}?`)) return;

    try {
        const res = await fetch('/api/client/facility/bookings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                facility_id: facilityBookingState.facilityId,
                date: facilityBookingState.date,
                start_time: startTime
            })
        });
        const result = await res.json();
        if (res.ok) {
            document.getElementById('facility-booking-modal').classList.add('hidden');
            showToast('Prenotazione confermata!', 'success');
        } else {
            showToast(result.detail || 'Impossibile prenotare', 'error');
        }
    } catch (e) {
        showToast('Errore nella prenotazione della struttura', 'error');
    }
};

window.fbGoBack = function() {
    const slotsStep = document.getElementById('fb-step-slots');
    const facilitiesStep = document.getElementById('fb-step-facilities');
    const activitiesStep = document.getElementById('fb-step-activities');

    if (!slotsStep.classList.contains('hidden')) {
        slotsStep.classList.add('hidden');
        facilitiesStep.classList.remove('hidden');
        document.getElementById('fb-modal-title').innerText = 'Select Facility';
    } else if (!facilitiesStep.classList.contains('hidden')) {
        facilitiesStep.classList.add('hidden');
        activitiesStep.classList.remove('hidden');
        document.getElementById('fb-modal-title').innerText = 'Book Facility';
    }
};
</script>

<!-- Facility Booking Modal -->
<div id="facility-booking-modal" class="fixed inset-0 bg-black/90 z-[60] hidden flex items-center justify-center p-0 backdrop-blur-sm">
    <div class="bg-[#1a1a1a] w-full h-full relative overflow-y-auto">
        <!-- Header -->
        <div class="sticky top-0 z-10 bg-[#1a1a1a]/95 backdrop-blur-xl border-b border-white/10 px-4 py-3 flex items-center justify-between">
            <button onclick="fbGoBack()" class="flex items-center gap-2 text-white/70 hover:text-white transition">
                <i data-lucide="chevron-left" class="w-5 h-5"></i>
                <span class="text-sm font-medium">Back</span>
            </button>
            <h2 id="fb-modal-title" class="text-base font-bold text-white">Book Facility</h2>
            <button onclick="document.getElementById('facility-booking-modal').classList.add('hidden')" class="text-white/70 hover:text-white">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <div class="max-w-lg mx-auto px-4 py-6 pb-24">
            <!-- Step 1: Activity Types -->
            <div id="fb-step-activities">
                <p class="text-gray-400 text-sm mb-4">Select an activity</p>
                <div id="fb-activity-types" class="grid grid-cols-2 gap-3"></div>
            </div>

            <!-- Step 2: Facilities -->
            <div id="fb-step-facilities" class="hidden">
                <p class="text-gray-400 text-sm mb-4">Select a facility</p>
                <div id="fb-facilities-list" class="space-y-3"></div>
            </div>

            <!-- Step 3: Date & Time Slots -->
            <div id="fb-step-slots" class="hidden">
                <p class="text-gray-400 text-sm mb-3">Pick a date</p>
                <!-- Calendar -->
                <div class="glass-card p-4 mb-4">
                    <div id="fb-calendar"></div>
                    <div class="flex items-center gap-4 mt-3 pt-3 border-t border-white/5">
                        <div class="flex items-center gap-1.5">
                            <span class="w-1.5 h-1.5 rounded-full bg-green-400"></span>
                            <span class="text-[10px] text-gray-500">Available</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <span class="w-1.5 h-1.5 rounded-full bg-gray-600"></span>
                            <span class="text-[10px] text-gray-500">No availability</span>
                        </div>
                    </div>
                </div>
                <!-- Time Slots -->
                <div id="fb-slots-container">
                    <div class="text-center text-gray-500 py-4 text-sm">Select a date to see available slots</div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}