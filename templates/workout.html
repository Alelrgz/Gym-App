{% extends "base.html" %}
{% from 'macros.html' import card %}

{% block content %}
<div class="absolute inset-0 bg-[#0f0f0f] z-20 flex flex-col overflow-hidden" id="workout-screen">
    <!-- Top Section: Fixed Video (35vh) -->
    <div class="h-[35vh] w-full relative bg-black flex-shrink-0">
        <video id="exercise-video" autoplay loop muted playsinline preload="auto"
            class="absolute inset-0 w-full h-full object-cover opacity-80">
            <source src="/static/videos/InclineDBPress.mp4?v=3" type="video/mp4">
        </video>
        <div class="absolute inset-0 bg-gradient-to-t from-[#0f0f0f] via-black/40 to-black/60"></div>

        <!-- Header Controls -->
        <div class="absolute top-0 left-0 w-full p-4 pt-12 flex justify-between items-center z-10">
            <a href="{{ '/trainer/personal' if role == 'trainer' else ('client.html' if static_build else '/?gym_id=' + gym_id + '&role=client') }}"
                class="w-10 h-10 rounded-xl bg-white/10 backdrop-blur-md flex items-center justify-center text-white tap-effect border border-white/10 hover:bg-white/20 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </a>
            <div class="flex items-center space-x-2 bg-white/10 backdrop-blur-md px-3 py-1.5 rounded-xl border border-white/10">
                <div class="w-2 h-2 rounded-full bg-orange-500 animate-pulse"></div>
                <span class="text-[10px] font-bold text-white/80 tracking-wider uppercase">Live</span>
            </div>
        </div>
    </div>

    <!-- Bottom Section: Scrollable Content -->
    <div id="workout-panel" class="flex-1 overflow-y-auto relative z-10 -mt-8 rounded-t-3xl flex flex-col transition-all duration-300" style="background: linear-gradient(180deg, rgba(15,15,15,0.98) 0%, #0f0f0f 100%);">
        <!-- Drag Handle - Clickable to toggle panel -->
        <div class="w-full flex justify-center pt-3 pb-2 cursor-pointer tap-effect" onclick="toggleWorkoutPanel()">
            <div id="drag-handle" class="w-10 h-1 bg-white/20 rounded-full transition-all"></div>
        </div>

        <!-- CO-OP Partner Tabs (hidden by default) -->
        <div id="coop-indicator" class="hidden px-5 pb-3">
            <!-- Tab Selector -->
            <div class="flex gap-2 mb-3">
                <button id="coop-tab-me" onclick="switchCoopTab('me')" class="flex-1 py-2 px-3 rounded-xl flex items-center justify-center gap-2 transition-all bg-gradient-to-r from-orange-500 to-orange-600 border-2 border-orange-500">
                    <div id="coop-tab-me-avatar" class="w-6 h-6 rounded-full bg-white/20 flex items-center justify-center overflow-hidden">
                        <i data-lucide="user" class="w-3 h-3"></i>
                    </div>
                    <span class="text-sm font-bold text-white">You</span>
                </button>
                <button id="coop-tab-partner" onclick="switchCoopTab('partner')" class="flex-1 py-2 px-3 rounded-xl flex items-center justify-center gap-2 transition-all bg-white/5 border-2 border-white/10">
                    <div id="coop-partner-avatar" class="w-6 h-6 rounded-full bg-purple-500/30 flex items-center justify-center overflow-hidden">
                        <i data-lucide="users" class="w-3 h-3"></i>
                    </div>
                    <span id="coop-partner-name" class="text-sm font-bold text-white/70">Partner</span>
                </button>
            </div>
            <!-- Active indicator -->
            <p id="coop-active-label" class="text-xs text-center text-purple-300 font-medium">
                Controlling: <span id="coop-controlling-name" class="text-white">Your workout</span>
            </p>
        </div>

        <!-- Active Exercise Card -->
        <div id="exercise-card" class="px-5 pb-4 transition-all duration-300" style="max-height: 500px; opacity: 1;">
            <div class="glass-card p-5 rounded-2xl border border-white/5">
                <!-- Exercise Info -->
                <div class="text-center mb-5">
                    <h2 class="text-2xl font-bold text-white mb-1" id="exercise-name">Incline DB Press</h2>
                    <p class="text-orange-500 text-sm font-medium" id="exercise-target">Set 1/4 &bull; Target: 8-10 Reps</p>
                </div>

                <!-- Rep Counter -->
                <div class="flex items-center justify-center gap-5 mb-5">
                    <button data-action="adjustReps" data-delta="-1"
                        class="w-14 h-14 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center text-2xl text-white/70 tap-effect hover:bg-white/10 hover:text-white transition active:scale-95">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
                        </svg>
                    </button>

                    <div class="relative">
                        <!-- Outer glow -->
                        <div class="absolute inset-0 rounded-full bg-orange-500/20 blur-xl"></div>
                        <!-- Counter circle -->
                        <div class="w-28 h-28 rounded-full bg-white/5 border-4 border-orange-500 flex flex-col items-center justify-center relative backdrop-blur-sm">
                            <span class="text-4xl font-bold text-white" id="rep-counter">10</span>
                            <span class="text-[10px] text-white/50 uppercase tracking-widest font-medium">Reps</span>
                        </div>
                    </div>

                    <button data-action="adjustReps" data-delta="1"
                        class="w-14 h-14 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center text-2xl text-white/70 tap-effect hover:bg-white/10 hover:text-white transition active:scale-95">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                    </button>
                </div>

                <!-- Complete Button -->
                <button data-action="completeSet"
                    class="w-full py-4 bg-gradient-to-r from-orange-500 to-orange-600 rounded-xl font-bold text-white tap-effect shadow-lg shadow-orange-500/30 hover:shadow-orange-500/50 transition-all active:scale-[0.98]"
                    id="complete-btn">
                    Complete Set
                </button>
            </div>
        </div>

        <!-- Routine List -->
        <div class="flex-1 px-5 pb-8">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-xs font-bold text-white/40 uppercase tracking-wider">Workout Routine</h3>
                <span class="text-xs text-orange-500 font-medium" id="routine-progress">0% Complete</span>
            </div>
            <div id="workout-routine-list" class="space-y-2 pb-8">
                <!-- List items injected by JS -->
            </div>
        </div>
    </div>
</div>

<!-- Celebration Overlay (Hidden by default) -->
<div id="celebration-overlay"
    class="absolute inset-0 bg-black/95 backdrop-blur-sm z-50 flex flex-col items-center justify-center hidden overflow-hidden">
    <div id="confetti-container" class="absolute inset-0 pointer-events-none"></div>
    <div class="text-center slide-up relative z-10 px-8">
        <div class="w-24 h-24 rounded-full bg-orange-500/20 flex items-center justify-center mx-auto mb-6">
            <i data-lucide="party-popper" class="w-10 h-10"></i>
        </div>
        <h1 class="text-3xl font-bold text-white mb-2">Workout Complete!</h1>
        <p class="text-white/60 mb-6">Great job! You crushed it today.</p>
        <div class="glass-card p-4 rounded-2xl mb-6 inline-block" id="celebration-gems-card">
            <p class="text-sm text-white/60">You earned</p>
            <p class="text-2xl font-bold text-orange-500" id="celebration-gems-amount">+50 <span class="text-lg">gems</span></p>
        </div>
        <br>
        <a href="{{ '/trainer/personal' if role == 'trainer' else ('client.html' if static_build else '/?gym_id=' + gym_id + '&role=client') }}"
            class="inline-block px-8 py-4 bg-gradient-to-r from-orange-500 to-orange-600 rounded-xl font-bold text-white tap-effect shadow-lg shadow-orange-500/30">
            Continue
        </a>
    </div>
</div>

<script>
// CO-OP State
window.coopState = {
    isCoopMode: false,
    partner: null,
    activeTab: 'me', // 'me' or 'partner'
    partnerExercises: null, // Will store partner's workout state
    partnerCurrentIdx: 0,
    partnerCurrentSet: 1,
    partnerCurrentReps: 10
};

// Switch between controlling yourself or partner
window.switchCoopTab = function(tab) {
    if (!window.coopState.isCoopMode) return;

    window.coopState.activeTab = tab;

    const meTab = document.getElementById('coop-tab-me');
    const partnerTab = document.getElementById('coop-tab-partner');
    const controllingEl = document.getElementById('coop-controlling-name');

    if (tab === 'me') {
        meTab.className = 'flex-1 py-2 px-3 rounded-xl flex items-center justify-center gap-2 transition-all bg-gradient-to-r from-orange-500 to-orange-600 border-2 border-orange-500';
        partnerTab.className = 'flex-1 py-2 px-3 rounded-xl flex items-center justify-center gap-2 transition-all bg-white/5 border-2 border-white/10';
        meTab.querySelector('span:last-child').className = 'text-sm font-bold text-white';
        partnerTab.querySelector('span:last-child').className = 'text-sm font-bold text-white/70';
        if (controllingEl) controllingEl.textContent = 'Your workout';

        // Restore your state to UI
        if (typeof updateWorkoutUI === 'function') {
            updateWorkoutUI();
        }
    } else {
        partnerTab.className = 'flex-1 py-2 px-3 rounded-xl flex items-center justify-center gap-2 transition-all bg-gradient-to-r from-purple-500 to-pink-500 border-2 border-purple-500';
        meTab.className = 'flex-1 py-2 px-3 rounded-xl flex items-center justify-center gap-2 transition-all bg-white/5 border-2 border-white/10';
        partnerTab.querySelector('span:last-child').className = 'text-sm font-bold text-white';
        meTab.querySelector('span:last-child').className = 'text-sm font-bold text-white/70';
        if (controllingEl) controllingEl.textContent = window.coopState.partner?.name || 'Partner';

        // Show partner's state in UI (updateWorkoutUI handles partner mode now)
        if (typeof updateWorkoutUI === 'function') {
            updateWorkoutUI();
        }
    }
};

// Check for CO-OP mode on page load
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const isCoopMode = urlParams.get('coop') === 'true';
    const coopPartnerStr = localStorage.getItem('coopPartner');

    if (isCoopMode && coopPartnerStr) {
        try {
            const partner = JSON.parse(coopPartnerStr);
            window.coopState.isCoopMode = true;
            window.coopState.partner = partner;

            const indicator = document.getElementById('coop-indicator');
            const nameEl = document.getElementById('coop-partner-name');
            const avatarEl = document.getElementById('coop-partner-avatar');

            if (indicator) {
                indicator.classList.remove('hidden');
                if (nameEl) nameEl.textContent = partner.name;
                if (avatarEl && partner.profile_picture) {
                    avatarEl.innerHTML = `<img src="${partner.profile_picture}" class="w-full h-full object-cover rounded-full">`;
                }
            }

            // Initialize partner's workout state (same exercises as user for now)
            // This will be properly synced when workoutState is initialized
            setTimeout(() => {
                if (typeof workoutState !== 'undefined' && workoutState.exercises) {
                    window.coopState.partnerExercises = JSON.parse(JSON.stringify(workoutState.exercises));
                    window.coopState.partnerCurrentReps = workoutState.currentReps;
                }
            }, 1000);
        } catch (e) {
            console.error('Error parsing co-op partner:', e);
        }
    }
});
</script>
{% endblock %}
